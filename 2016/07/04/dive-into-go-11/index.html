<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>深入Go语言 - 11 | 鸟窝</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="本章重点介绍Go程序的调试和性能监控。">
<meta property="og:type" content="article">
<meta property="og:title" content="深入Go语言 - 11">
<meta property="og:url" content="http://colobu.com/2016/07/04/dive-into-go-11/">
<meta property="og:site_name" content="鸟窝">
<meta property="og:description" content="本章重点介绍Go程序的调试和性能监控。">
<meta property="og:image" content="https://raw.githubusercontent.com/derekparker/delve/master/assets/delve_horizontal.png">
<meta property="og:image" content="http://colobu.com/2016/04/21/use-vscode-to-develop-go-programs/vscode.png">
<meta property="og:image" content="profiling-go-programs_havlak1a-75.png">
<meta property="og:image" content="profiling-go-programs_havlak1-hash_lookup-75.png">
<meta property="og:image" content="profiling-go-programs_havlak4a-mallocgc.png">
<meta property="og:image" content="gcvis.png">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="深入Go语言 - 11">
<meta name="twitter:description" content="本章重点介绍Go程序的调试和性能监控。">

  
    <link rel="alternative" href="/atom.xml" title="鸟窝" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">

  <link href="//cdn.staticfile.org/font-awesome/4.2.0/css/font-awesome.css" rel="stylesheet">
  
  <link rel="stylesheet" href="//libs.cncdn.cn/fancybox/2.1.5/jquery.fancybox.css" media="screen" type="text/css">
  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//cdn.staticfile.org/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->

  <script type="text/javascript">
	//visit my previous blog: http://old.colobu.com just like this http://colobu.com/?=123456
    var blog_url = location.href.toString();
	if (blog_url.indexOf("http://colobu.com/?p=") >= 0) {
		blog_url = blog_url.replace("colobu.com", "old.colobu.com");
		window.location.assign(blog_url);
	} else if (blog_url.indexOf("http://smallnest.gitcafe.com") >= 0) {
		blog_url = blog_url.replace("smallnest.gitcafe.com", "colobu.com");
		window.location.assign(blog_url);
	}  else if (blog_url.indexOf("http://smallnest.gitcafe.io") >= 0) {
		blog_url = blog_url.replace("smallnest.gitcafe.io", "colobu.com");
		window.location.assign(blog_url);
	}
</script>
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap" class="animated bounceInLeft">
        <a href="/" id="logo">鸟窝</a>
      </h1>
      
        <h2 id="subtitle-wrap" class="animated bounceInLeft">
          <a href="/" id="subtitle">大道至简 Simplicity is the ultimate form of sophistication</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/"><i class="fa fa-home">&nbsp;</i>首页</a>
        
          <a class="main-nav-link" href="/archives"><i class="fa fa-folder-o">&nbsp;</i>归档</a>
        
          <a class="main-nav-link" href="https://github.com/smallnest"><i class="fa fa-github">&nbsp;</i>github</a>
        
          <a class="main-nav-link" href="http://tr.colobu.com"><i class="fa fa-spinner fa-pulse">&nbsp;</i>技术流</a>
        
          <a class="main-nav-link" href="/ScalaCollectionsCookbook"><i class="fa fa-book">&nbsp;</i>Scala集合技术手册</a>
        
          <a class="main-nav-link" href="/techreview"><i class="fa fa-newspaper-o">&nbsp;</i>技术快报</a>
        
          <a class="main-nav-link" href="/about"><i class="fa fa-lemon-o">&nbsp;</i>关于</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="http://www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
          <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="Search">
          <input type="submit" value="" class="search-form-submit">
          <input name=tn type=hidden value="bds">
          <input name=cl type=hidden value="3">
          <input name=ct type=hidden value="2097152">
          <input type="hidden" name="si" value="colobu.com">
        </form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-dive-into-go-11" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/07/04/dive-into-go-11/" class="article-date">
  <time datetime="2016-07-03T22:12:42.000Z" itemprop="datePublished">2016年07月04日</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Go/">Go</a>
  </div>

	
  <div class="article-author"> by smallnest</div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      深入Go语言 - 11
	  
	  <p class="article-subtitle">程序调试和监控</p>
	  
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
	  
	    <h1 id="expanderHead" style="cursor:pointer;">
		目录 <span id="expanderSign">[−]</span>
		</h1>
	    <div id="article-entry-toc" data-role="collapsible" class="article-entry-toc">
		  <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#GDB"><span class="toc-text">GDB</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#delve及IDE集成调试"><span class="toc-text">delve及IDE集成调试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pprof"><span class="toc-text">pprof</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#benchmark测试"><span class="toc-text">benchmark测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Go调试参数"><span class="toc-text">Go调试参数</span></a></li></ol>
	    </div>
	  
	  
      
        <p>本章重点介绍Go程序的调试和性能监控。</p>
<a id="more"></a>
<h3 id="GDB">GDB</h3>
<p>当你在Linux、macOS、FreeBSD、NetBSD环境中使用gc工具链编译和链接你的程序的时候，生成的二进制文件中包含 DWARFv3调试信息, 最新的GDB(&gt;7.1)可以用它们来调试程序。</p>
<p>gc工具链的名字来自Go前端编译器(compiler frontend), <code>cmd/gc</code>,以区分<code>gccgo</code>工具链。当人们谈论Go编译器的时候，通常所指就是gc工具链。</p>
<p>gc工具链包含一个Go编译器、一个C编译器、一个汇编工具和一个链接工具，所有这些工具都可以在<code>src\cmd</code>文件夹下找到，比如<code>5g</code>、<code>6g</code>、｀8g｀、<code>5c</code>、<code>6c</code>、<code>8c</code>、<code>5a</code>、<code>6a</code>、<code>8a</code>、<code>5l</code>、<code>6l</code>、<code>8l</code>等。</p>
<p>自Go 1.5 gc工具链改变了，从C的实现改变成Go的实现，所以你在Go1.5以上的版本中找不到这些工具，而是由统一的compile、link工具所取代。 你编译的时候可以看到工具链是如何工作的：</p>
<pre class="highlight">
smallnestMBP:ch10 smallnest$ go build  -x -gcflags "-N -l" pi.go
WORK=/var/folders/lv/5kl1rvvj2jsfqxyw_1_pvw380000gn/T/go-build974068189
mkdir -p $WORK/command-line-arguments/_obj/
mkdir -p $WORK/command-line-arguments/_obj/exe/
cd /Users/smallnest/go/src/github.com/smallnest/dive-into-go/ch10
/usr/local/go/pkg/tool/darwin_amd64/compile -o $WORK/command-line-arguments.a -trimpath $WORK -N -l -p main -complete -buildid ab0109c737108c5646adfbf53bff79b7a49b96d4 -D _/Users/smallnest/go/src/github.com/smallnest/dive-into-go/ch10 -I $WORK -pack ./pi.go
cd .
/usr/local/go/pkg/tool/darwin_amd64/link -o $WORK/command-line-arguments/_obj/exe/a.out -L $WORK -extld=clang -buildmode=exe -buildid=ab0109c737108c5646adfbf53bff79b7a49b96d4 $WORK/command-line-arguments.a
mv $WORK/command-line-arguments/_obj/exe/a.out pi
</pre>

<blockquote>
<p>The suites of programs that were the compilers (6g, 8g, etc.), the assemblers (6a, 8a, etc.), and the linkers (6l, 8l, etc.) have each been consolidated into a single tool that is configured by the environment variables GOOS and GOARCH. The old names are gone; the new tools are available through the go tool mechanism as go tool compile, go tool asm, and go tool link. Also, the file suffixes .6, .8, etc. for the intermediate object files are also gone; now they are just plain .o files.</p>
<p>For example, to build and link a program on amd64 for Darwin using the tools directly, rather than through go build, one would run:</p>
<pre class="highlight">
$ export GOOS=darwin GOARCH=amd64
$ go tool compile program.go
$ go tool link program.o
</pre>

<p>摘自 <a href="https://golang.org/doc/go1.5#rename" target="_blank" rel="external">https://golang.org/doc/go1.5#rename</a></p>
</blockquote>
<p><code>-w</code>参数会告诉连接器忽略这些调试信息(<code>go build -ldflags &quot;-w&quot; example.go</code>)。</p>
<p>gc编译器可能会做优化，比如inline函数，这会让gdb调试更加困难。如果不想让编译器做这些优化可以指定参数<code>-gcflags &quot;-N -l&quot;</code>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">go</span> build  -gcflags <span class="string">"-N -l"</span> pi.<span class="keyword">go</span></div></pre></td></tr></table></figure>

<p>GDB具体的执行命令你可以搜索相关的文档，网络上有居多的文章介绍。</p>
<p>以<a href="https://golang.org/doc/play/pi.go" target="_blank" rel="external">计算圆周率 Pi 的代码为例</a>，在<code>macOS</code>中你需要执行 <code>sudo gdb pi</code>,然后进入GDB的控制台。</p>
<p><code>list</code>可以显示源代码。</p>
<p><code>break</code>加断点，比如<code>break 16</code>。</p>
<p><code>bt</code> 、<code>frame n</code>可以显示调用栈信息。</p>
<p><code>info</code>显示变量的信息：</p>
<pre class="highlight">
(gdb) next
17            go term(ch, float64(k))
(gdb) info args
n = 5000
~r1 = 0
(gdb) info locals
k = 0
k = 16
f = 4.3922040662770145e-318
ch = 0xc820066000
(gdb) p ch
$1 = (chan float64) 0xc820066000
</pre>

<p>基本上，如果你熟悉gdb工具，可以轻松地进行调试，还可以使用<a href="https://golang.org/src/runtime/runtime-gdb.py" target="_blank" rel="external">扩展脚本</a>对复杂类型进行检查。</p>
<p>参考</p>
<ul>
<li><a href="https://golang.org/doc/gdb" target="_blank" rel="external">https://golang.org/doc/gdb</a></li>
<li><a href="https://astaxie.gitbooks.io/build-web-application-with-golang/content/en/11.2.html" target="_blank" rel="external">https://astaxie.gitbooks.io/build-web-application-with-golang/content/en/11.2.html</a></li>
<li><a href="https://lincolnloop.com/blog/introduction-go-debugging-gdb/" target="_blank" rel="external">https://lincolnloop.com/blog/introduction-go-debugging-gdb/</a></li>
<li><a href="https://blog.codeship.com/using-gdb-debugger-with-go/" target="_blank" rel="external">https://blog.codeship.com/using-gdb-debugger-with-go/</a></li>
<li><a href="http://dave.cheney.net/2013/10/15/how-does-the-go-build-command-work" target="_blank" rel="external">http://dave.cheney.net/2013/10/15/how-does-the-go-build-command-work</a></li>
<li><a href="https://github.com/golang/go/wiki/GcToolchainTricks" target="_blank" rel="external">https://github.com/golang/go/wiki/GcToolchainTricks</a></li>
<li><a href="https://github.com/golang/go/wiki/GcToolchainTricks" target="_blank" rel="external">https://github.com/golang/go/wiki/GcToolchainTricks</a></li>
</ul>
<h3 id="delve及IDE集成调试">delve及IDE集成调试</h3>
<p>虽然gdb工具很强大，但是这种基于命令行的调试方式确实不方便，而且它也不是专门为Go语言提供的调试工具，尤其对于并发程序的调试。</p>
<p>但是G官方一直没有提供一个Go调试器。</p>
<p>幸运地是，有人提供了专门针对 Go语言的调试器：<br><img src="https://raw.githubusercontent.com/derekparker/delve/master/assets/delve_horizontal.png" alt=""></p>
<p>网址： <a href="https://github.com/derekparker/delve" target="_blank" rel="external">https://github.com/derekparker/delve</a></p>
<p>虽然当前delve的版本还是pre 1.0，但是已经提供了很好的Go调试的功能，并且可以很好的Intellj、Atom、Vscode等Go IDE工具集成。</p>
<p>当然你可以用命令行的方式调试,它有多种方式启动<code>dlv</code>： <code>dlv attach</code>、<code>dlv debug</code>、<code>dlv exec</code>、<code>dlv test</code>、<code>dlv trace</code>等，用来调试一个进程或者程序等。我们用<code>dlv exec ./pi</code>调试刚才编译好的程序。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">(dlv) b pi.go:<span class="number">16</span> <span class="comment">#在 pi.go 的第 16 行设置断点。</span></div><div class="line">(dlv) bp   <span class="comment">#查看当前所有断点</span></div><div class="line">(dlv) c    <span class="comment">#运行到下一个断点或者程序结尾</span></div><div class="line">(dlv) n    <span class="comment">#单步执行代码</span></div><div class="line">(dlv) p ch  <span class="comment">#打印变量 ch 的值</span></div><div class="line">(dlv) goroutines  <span class="comment">#打印所有的goroutine</span></div><div class="line">(dlv) goroutine  <span class="comment">#打印当前的或者指定的goroutine信息</span></div></pre></td></tr></table></figure>

<p>它的信息要比gdb的详细，更适合Go程序的调试。</p>
<p>以下IDE工具可以集成delve。</p>
<ul>
<li><a href="https://github.com/go-lang-plugin-org/go-lang-idea-plugin" target="_blank" rel="external">Golang Plugin for IntelliJ IDEA</a></li>
<li><a href="https://github.com/Microsoft/vscode-go" target="_blank" rel="external">Go for Visual Studio Code</a></li>
<li><a href="https://github.com/benma/go-dlv.el/" target="_blank" rel="external">Emacs plugin</a></li>
<li><a href="https://github.com/visualfc/liteide" target="_blank" rel="external">LiteIDE</a></li>
<li><a href="https://github.com/lloiser/go-debug" target="_blank" rel="external">Go Debugger for Atom</a></li>
</ul>
<p>关于vscode IDE,你可以参考: <a href="http://colobu.com/2016/04/21/use-vscode-to-develop-go-programs/" target="_blank" rel="external">使用visual studio code开发Go程序
</a>。</p>
<p><img src="http://colobu.com/2016/04/21/use-vscode-to-develop-go-programs/vscode.png" alt=""></p>
<p>参考</p>
<ul>
<li><a href="https://github.com/derekparker/delve" target="_blank" rel="external">https://github.com/derekparker/delve</a></li>
<li><a href="https://github.com/derekparker/delve/tree/master/Documentation" target="_blank" rel="external">https://github.com/derekparker/delve/tree/master/Documentation</a></li>
<li><a href="https://blog.gopheracademy.com/advent-2015/debugging-with-delve/" target="_blank" rel="external">https://blog.gopheracademy.com/advent-2015/debugging-with-delve/</a></li>
<li><a href="http://blog.ralch.com/tutorial/golang-debug-with-delve/" target="_blank" rel="external">http://blog.ralch.com/tutorial/golang-debug-with-delve/</a></li>
<li><a href="https://github.com/joefitzgerald/go-plus" target="_blank" rel="external">https://github.com/joefitzgerald/go-plus</a></li>
<li><a href="https://atom.io/packages/go-debug" target="_blank" rel="external">https://atom.io/packages/go-debug</a></li>
<li><a href="https://code.visualstudio.com/" target="_blank" rel="external">https://code.visualstudio.com/</a></li>
<li><a href="https://www.reddit.com/r/golang/comments/3jyfvd/go_plugin_for_intellij_ides_now_has_delve/" target="_blank" rel="external">https://www.reddit.com/r/golang/comments/3jyfvd/go_plugin_for_intellij_ides_now_has_delve/</a></li>
<li><a href="https://github.com/go-lang-plugin-org/go-lang-idea-plugin" target="_blank" rel="external">https://github.com/go-lang-plugin-org/go-lang-idea-plugin</a></li>
<li><a href="https://github.com/DisposaBoy/GoSublime" target="_blank" rel="external">https://github.com/DisposaBoy/GoSublime</a></li>
<li><a href="https://github.com/fatih/vim-go" target="_blank" rel="external">https://github.com/fatih/vim-go</a></li>
<li><a href="https://github.com/golang/go/wiki/IDEsAndTextEditorPlugins" target="_blank" rel="external">https://github.com/golang/go/wiki/IDEsAndTextEditorPlugins</a></li>
</ul>
<h3 id="pprof">pprof</h3>
<p>Go官方库提供了两个类似的包pprof,分别为HTTP应用和通用应用提供了性能监控的功能。我们先看看 &quot;runtime/pprof&quot;包的使用，正好Go项目组有一个使用的例子，而且他们专门写了一篇文章介绍： <a href="https://blog.golang.org/profiling-go-programs" target="_blank" rel="external">profiling go programs</a>:</p>
<p>2011年的Scala Days会议上，Robert Hundt介绍了论文: <a href="http://research.google.com/pubs/pub37122.html" target="_blank" rel="external">Loop Recognition in C++/Java/Go/Scala</a>,这个文章中的Go程序运行的非常慢。</p>
<p>Go项目组正好利用Go profiling tool查找程序的瓶颈。他们选择了一个开发环境，测试C++和Go程序，发现C++程序用了17.8秒，内存使用700M,而Go称许用了25.2秒，内存占用1302M,所以他们尝试使用<code>go tool pprof</code>查找原因。</p>
<p>首先输入<code>runtime/pprof</code>,并使用两个参数<code>-cpuprofile</code>和<code>-memprofile</code>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> cpuprofile = flag.String(<span class="string">"cpuprofile"</span>, <span class="string">""</span>, <span class="string">"write cpu profile to file"</span>)</div><div class="line"></div><div class="line"><span class="keyword">func</span> main() {</div><div class="line">    flag.Parse()</div><div class="line">    <span class="keyword">if</span> *cpuprofile != <span class="string">""</span> {</div><div class="line">        f, err := os.Create(*cpuprofile)</div><div class="line">        <span class="keyword">if</span> err != <span class="constant">nil</span> {</div><div class="line">            log.Fatal(err)</div><div class="line">        }</div><div class="line">        pprof.StartCPUProfile(f)</div><div class="line">        <span class="keyword">defer</span> pprof.StopCPUProfile()</div><div class="line">    }</div><div class="line">    ...</div></pre></td></tr></table></figure>

<p>程序启动的时候启动<a href="https://golang.org/pkg/runtime/pprof/#StartCPUProfile），程序结束的时候记得一定要调用[StopCPUProfile](" target="_blank" rel="external">CPU性能监控</a><a href="http://golang.org/pkg/runtime/pprof/#StopCPUProfile，这样才能将缓存的监控数据写入都文件中。" target="_blank" rel="external">http://golang.org/pkg/runtime/pprof/#StopCPUProfile，这样才能将缓存的监控数据写入都文件中。</a></p>
<p>执行程序，执行完后用<code>go tool pprof</code>工具分析性能数据。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ make havlak1.prof</div><div class="line">./havlak1 -cpuprofile=havlak1.prof</div><div class="line"><span class="comment"># of loops: 76000 (including 1 artificial root node)</span></div><div class="line">$ go tool pprof havlak1 havlak1.prof</div><div class="line">Welcome to pprof!  For <span class="built_in">help</span>, <span class="built_in">type</span> <span class="string">'help'</span>.</div><div class="line">(pprof)</div></pre></td></tr></table></figure>

<p><code>go tool pprof</code>是 <a href="https://code.google.com/p/gperftools/wiki/GooglePerformanceTools" target="_blank" rel="external">Google&#39;s pprof C++ profiler</a> 的变种。最重要的命令就是<code>topN</code>,它显示top N的采样结果:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">(pprof) top10</div><div class="line">Total: <span class="number">2525</span> samples</div><div class="line">     <span class="number">298</span>  <span class="number">11.8</span>%  <span class="number">11.8</span>%      <span class="number">345</span>  <span class="number">13.7</span>% runtime.mapaccess1_fast64</div><div class="line">     <span class="number">268</span>  <span class="number">10.6</span>%  <span class="number">22.4</span>%     <span class="number">2124</span>  <span class="number">84.1</span>% main.FindLoops</div><div class="line">     <span class="number">251</span>   <span class="number">9.9</span>%  <span class="number">32.4</span>%      <span class="number">451</span>  <span class="number">17.9</span>% scanblock</div><div class="line">     <span class="number">178</span>   <span class="number">7.0</span>%  <span class="number">39.4</span>%      <span class="number">351</span>  <span class="number">13.9</span>% <span class="built_in">hash</span>_insert</div><div class="line">     <span class="number">131</span>   <span class="number">5.2</span>%  <span class="number">44.6</span>%      <span class="number">158</span>   <span class="number">6.3</span>% sweepspan</div><div class="line">     <span class="number">119</span>   <span class="number">4.7</span>%  <span class="number">49.3</span>%      <span class="number">350</span>  <span class="number">13.9</span>% main.DFS</div><div class="line">      <span class="number">96</span>   <span class="number">3.8</span>%  <span class="number">53.1</span>%       <span class="number">98</span>   <span class="number">3.9</span>% flushptrbuf</div><div class="line">      <span class="number">95</span>   <span class="number">3.8</span>%  <span class="number">56.9</span>%       <span class="number">95</span>   <span class="number">3.8</span>% runtime.aeshash64</div><div class="line">      <span class="number">95</span>   <span class="number">3.8</span>%  <span class="number">60.6</span>%      <span class="number">101</span>   <span class="number">4.0</span>% runtime.settype_flush</div><div class="line">      <span class="number">88</span>   <span class="number">3.5</span>%  <span class="number">64.1</span>%      <span class="number">988</span>  <span class="number">39.1</span>% runtime.mallocgc</div></pre></td></tr></table></figure>

<p>当监控的时候(profiling),Go程序每0.01秒采样一次，每次采样会记录当前执行的goroutine的程序计数器。上例中共2525次采样，所以它运行了大约25秒。 （注意go tool pprof执行的时候需要程序和采样数据，无果没有指定程序，则不会出现上面的结果）。如果程序执行太快，还没来得及采样，则无法分析其数据。</p>
<p>我们也可以分析一下上一节的Pi程序<code>go tool pprof pi pi.prof</code>:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">smallnestMBP:ch10 smallnest$ go tool pprof pi pi.prof</div><div class="line">Entering interactive mode (<span class="built_in">type</span> <span class="string">"help"</span> <span class="keyword">for</span> commands)</div><div class="line">(pprof) top10</div><div class="line"><span class="number">64.75</span>s of <span class="number">73.30</span>s total (<span class="number">88.34</span>%)</div><div class="line">Dropped <span class="number">73</span> nodes (cum &lt;= <span class="number">0.37</span>s)</div><div class="line">Showing top <span class="number">10</span> nodes out of <span class="number">65</span> (cum &gt;= <span class="number">1.56</span>s)</div><div class="line">      flat  flat%   sum%        cum   cum%</div><div class="line">    <span class="number">21.66</span>s <span class="number">29.55</span>% <span class="number">29.55</span>%     <span class="number">21.66</span>s <span class="number">29.55</span>%  fmt.(*fmt).padString</div><div class="line">    <span class="number">10.45</span>s <span class="number">14.26</span>% <span class="number">43.81</span>%     <span class="number">10.45</span>s <span class="number">14.26</span>%  fmt.(*fmt).integer</div><div class="line">    <span class="number">10.26</span>s <span class="number">14.00</span>% <span class="number">57.80</span>%     <span class="number">10.28</span>s <span class="number">14.02</span>%  runtime.send</div><div class="line">     <span class="number">6.60</span>s  <span class="number">9.00</span>% <span class="number">66.81</span>%      <span class="number">6.60</span>s  <span class="number">9.00</span>%  fmt.(*fmt).pad</div><div class="line">     <span class="number">4.52</span>s  <span class="number">6.17</span>% <span class="number">72.97</span>%      <span class="number">4.77</span>s  <span class="number">6.51</span>%  runtime.stackfree</div><div class="line">     <span class="number">3.26</span>s  <span class="number">4.45</span>% <span class="number">77.42</span>%      <span class="number">3.26</span>s  <span class="number">4.45</span>%  fmt.(*fmt).fmt_boolean</div><div class="line">     <span class="number">2.86</span>s  <span class="number">3.90</span>% <span class="number">81.32</span>%     <span class="number">11.13</span>s <span class="number">15.18</span>%  type..hash.[<span class="number">1</span>]interface {}</div><div class="line">     <span class="number">2.06</span>s  <span class="number">2.81</span>% <span class="number">84.13</span>%      <span class="number">2.06</span>s  <span class="number">2.81</span>%  reflect.Kind.String</div><div class="line">     <span class="number">1.91</span>s  <span class="number">2.61</span>% <span class="number">86.74</span>%      <span class="number">2.18</span>s  <span class="number">2.97</span>%  runtime.SetFinalizer</div><div class="line">     <span class="number">1.17</span>s  <span class="number">1.60</span>% <span class="number">88.34</span>%      <span class="number">1.56</span>s  <span class="number">2.13</span>%  reflect.chanrecv</div><div class="line">(pprof)</div></pre></td></tr></table></figure>

<p>前两列显示采样中函数正在执行的次数和百分比（不包含等待函数调用返回的值），数值越大函数执行的频率越大。第三列显示的是前面的数值在整个列表中总数的百分比，Go team的例子中前三行的占比已经达到了32.4%。第4列、第5列显示正在运行和等待的函数出现的数量和占比，虽然函数<code>main.FindLoops</code>运行的次数才占10.6%,但是它确出现在84.1％采样的调用堆栈上(call stack)。</p>
<p>如果要按照第4列第5列排序，可以<code>(pprof) top5 -cum</code> :</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">(pprof) top5 -cum</div><div class="line">Total:<span class="number"> 2525</span> samples</div><div class="line">      <span class="number"> 0</span>  <span class="number"> 0.0</span>%  <span class="number"> 0.0</span>%    <span class="number"> 2144</span> <span class="number"> 84.9</span>% gosched0</div><div class="line">      <span class="number"> 0</span>  <span class="number"> 0.0</span>%  <span class="number"> 0.0</span>%    <span class="number"> 2144</span> <span class="number"> 84.9</span>% main.main</div><div class="line">      <span class="number"> 0</span>  <span class="number"> 0.0</span>%  <span class="number"> 0.0</span>%    <span class="number"> 2144</span> <span class="number"> 84.9</span>% runtime.main</div><div class="line">      <span class="number"> 0</span>  <span class="number"> 0.0</span>%  <span class="number"> 0.0</span>%    <span class="number"> 2124</span> <span class="number"> 84.1</span>% main.FindHavlakLoops</div><div class="line">    <span class="number"> 268</span> <span class="number"> 10.6</span>% <span class="number"> 10.6</span>%    <span class="number"> 2124</span> <span class="number"> 84.1</span>% main.FindLoops</div><div class="line">(pprof) top5 -cum</div></pre></td></tr></table></figure>

<p>事实上<code>main.FindLoops</code>和<code>main.main</code>的占比应该是100%，但是由于每次采样只分析最底部的100个栈帧(stack frame)，大于四分之一的采样中，<code>main.DFS</code>递归调用的太深，超过了100帧，所有有些没有计数。</p>
<p>起始，性能数据中还包含更有趣的函数调用关系。<br>使用命令 web 可以产生SVG图形，用一个浏览器就能打开它，不过需要你的机器安装graphviz: <code>(pprof) web</code></p>
<p><img src="profiling-go-programs_havlak1a-75.png" alt=""></p>
<p>图形中的每个方框代表一个函数，方框的大小代表函数运行的采样数据大小。箭头x指向Y表示X调用Y,箭头指向自身表示递归调用。箭头上的数量代表一次采样中的调用次数。</p>
<p>从图中可以看出，程序花费了很多的时间在hash值的计算上，使用go map对象。我们可以让web只显示特定函数的采样，比如<code>runtime.mapaccess1_fast64</code>: <code>(pprof) web mapaccess1</code>。</p>
<p><img src="profiling-go-programs_havlak1-hash_lookup-75.png" alt=""></p>
<p>好了，我们知道了性能的大概情况以及哪个函数占的时间太多，现在通过<code>list</code>命令查看函数：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">(pprof) list DFS</div><div class="line">Total:<span class="number"> 2525</span> samples</div><div class="line">ROUTINE ====================== main.DFS in /home/rsc/g/benchgraffiti/havlak/havlak1.<span class="keyword">go</span></div><div class="line">  <span class="number"> 119</span>   <span class="number"> 697</span> Total samples (flat / cumulative)</div><div class="line">    <span class="number"> 3</span>     <span class="number"> 3</span> <span class="number"> 240</span>: <span class="keyword">func</span> DFS(currentNode *BasicBlock, nodes []*UnionFindNode, number <span class="keyword">map</span>[*BasicBlock]<span class="typename">int</span>, last []<span class="typename">int</span>, current <span class="typename">int</span>) <span class="typename">int</span> {</div><div class="line">    <span class="number"> 1</span>     <span class="number"> 1</span> <span class="number"> 241</span>:     nodes[current].Init(currentNode, current)</div><div class="line">    <span class="number"> 1</span>    <span class="number"> 37</span> <span class="number"> 242</span>:     number[currentNode] = current</div><div class="line">     .      . <span class="number"> 243</span>:</div><div class="line">    <span class="number"> 1</span>     <span class="number"> 1</span> <span class="number"> 244</span>:     lastid := current</div><div class="line">   <span class="number"> 89</span>    <span class="number"> 89</span> <span class="number"> 245</span>:     <span class="keyword">for</span> _, target := <span class="keyword">range</span> currentNode.OutEdges {</div><div class="line">    <span class="number"> 9</span>   <span class="number"> 152</span> <span class="number"> 246</span>:             <span class="keyword">if</span> number[target] == unvisited {</div><div class="line">    <span class="number"> 7</span>   <span class="number"> 354</span> <span class="number"> 247</span>:                     lastid = DFS(target, nodes, number, last, lastid<span class="number">+1</span>)</div><div class="line">     .      . <span class="number"> 248</span>:             }</div><div class="line">     .      . <span class="number"> 249</span>:     }</div><div class="line">    <span class="number"> 7</span>    <span class="number"> 59</span> <span class="number"> 250</span>:     last[number[currentNode]] = lastid</div><div class="line">    <span class="number"> 1</span>     <span class="number"> 1</span> <span class="number"> 251</span>:     <span class="keyword">return</span> lastid</div><div class="line">(pprof)</div></pre></td></tr></table></figure>

<p>前三列分别代表程序运行都此的采样数、运行到此或者在此调用的采样数、代码行数。</p>
<p>前面已经知道性能出现在map查找的实现上，我们重点分析第二列。时间很多花费在第247行。除了这个递归调用，其它时间花费较高的是 242、246和250行。分析得知map对于一些特殊的查找并不总是有效，所以我们可以用<code>[]int</code>代替<code>map [*BasicBlock]int</code>，根据索引查找更有效。</p>
<p>Go team根据分析修改了代码实现，再一次运行测试，果然有效。</p>
<p>整个源代码在 <a href="https://code.google.com/archive/p/benchgraffiti/source/default/source" target="_blank" rel="external">google code</a> 上可以下载，你可以测试演练一把。</p>
<p>测试修改后的结果：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">make</span> havlak2.prof</div><div class="line">./havlak2 -cpuprofile=havlak2.prof</div><div class="line"># of loops:<span class="number"> 76000</span> (including<span class="number"> 1</span> artificial root node)</div><div class="line">$ <span class="keyword">go</span> tool pprof havlak2 havlak2.prof</div><div class="line">Welcome to pprof!  For help, <span class="keyword">type</span> <span class="string">'help'</span>.</div><div class="line">(pprof)</div><div class="line">(pprof) top5</div><div class="line">Total:<span class="number"> 1652</span> samples</div><div class="line">    <span class="number"> 197</span> <span class="number"> 11.9</span>% <span class="number"> 11.9</span>%     <span class="number"> 382</span> <span class="number"> 23.1</span>% scanblock</div><div class="line">    <span class="number"> 189</span> <span class="number"> 11.4</span>% <span class="number"> 23.4</span>%    <span class="number"> 1549</span> <span class="number"> 93.8</span>% main.FindLoops</div><div class="line">    <span class="number"> 130</span>  <span class="number"> 7.9</span>% <span class="number"> 31.2</span>%     <span class="number"> 152</span>  <span class="number"> 9.2</span>% sweepspan</div><div class="line">    <span class="number"> 104</span>  <span class="number"> 6.3</span>% <span class="number"> 37.5</span>%     <span class="number"> 896</span> <span class="number"> 54.2</span>% runtime.mallocgc</div><div class="line">     <span class="number"> 98</span>  <span class="number"> 5.9</span>% <span class="number"> 43.5</span>%     <span class="number"> 100</span>  <span class="number"> 6.1</span>% flushptrbuf</div><div class="line">(pprof)</div></pre></td></tr></table></figure>

<p><code>main.DFS</code>不再出现在前几个占用时间较多的函数列表中，但是内存分配和垃圾回收占用确很多。使用<code>-memprofile</code>参数监控内存：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> memprofile = flag.String(<span class="string">"memprofile"</span>, <span class="string">""</span>, <span class="string">"write memory profile to this file"</span>)</div><div class="line">...</div><div class="line"></div><div class="line">    FindHavlakLoops(cfgraph, lsgraph)</div><div class="line">    <span class="keyword">if</span> *memprofile != <span class="string">""</span> {</div><div class="line">        f, err := os.Create(*memprofile)</div><div class="line">        <span class="keyword">if</span> err != <span class="constant">nil</span> {</div><div class="line">            log.Fatal(err)</div><div class="line">        }</div><div class="line">        pprof.WriteHeapProfile(f)</div><div class="line">        f.Close()</div><div class="line">        <span class="keyword">return</span></div><div class="line">    }</div></pre></td></tr></table></figure>

<p>执行程序，得到内存采样数据：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ make havlak3.mprof</div><div class="line">go build havlak3.go</div><div class="line">./havlak3 -memprofile=havlak3.mprof</div><div class="line">$</div></pre></td></tr></table></figure>

<p>使用<code>go tool pprof</code>分析采样数据：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$ go tool pprof havlak3 havlak3.mprof</div><div class="line">Adjusting heap profiles <span class="keyword">for</span> <span class="number">1</span>-in-<span class="number">524288</span> sampling rate</div><div class="line">Welcome to pprof!  For <span class="built_in">help</span>, <span class="built_in">type</span> <span class="string">'help'</span>.</div><div class="line">(pprof) top5</div><div class="line">Total: <span class="number">82.4</span> MB</div><div class="line">    <span class="number">56.3</span>  <span class="number">68.4</span>%  <span class="number">68.4</span>%     <span class="number">56.3</span>  <span class="number">68.4</span>% main.FindLoops</div><div class="line">    <span class="number">17.6</span>  <span class="number">21.3</span>%  <span class="number">89.7</span>%     <span class="number">17.6</span>  <span class="number">21.3</span>% main.(*CFG).CreateNode</div><div class="line">     <span class="number">8.0</span>   <span class="number">9.7</span>%  <span class="number">99.4</span>%     <span class="number">25.6</span>  <span class="number">31.0</span>% main.NewBasicBlockEdge</div><div class="line">     <span class="number">0.5</span>   <span class="number">0.6</span>% <span class="number">100.0</span>%      <span class="number">0.5</span>   <span class="number">0.6</span>% itab</div><div class="line">     <span class="number">0.0</span>   <span class="number">0.0</span>% <span class="number">100.0</span>%      <span class="number">0.5</span>   <span class="number">0.6</span>% fmt.init</div><div class="line">(pprof)</div></pre></td></tr></table></figure>

<p><code>FindLoops</code>函数分配了大约56.3M内存，占总分配内存82.4M的68.4%。<br><code>CreateNode</code>分配了17.6M的内存。</p>
<p><code>list FindLoop</code>可以显示函数的详细的内存分配：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">(pprof) list FindLoops</div><div class="line">Total: <span class="number">82.4</span> MB</div><div class="line">ROUTINE ====================== main.FindLoops <span class="keyword">in</span> /home/rsc/g/benchgraffiti/havlak/havlak3.go</div><div class="line">  <span class="number">56.3</span>   <span class="number">56.3</span> Total MB (flat / cumulative)</div><div class="line">...</div><div class="line">   <span class="number">1.9</span>    <span class="number">1.9</span>  <span class="number">268</span>:     nonBackPreds := make([]map[int]bool, size)</div><div class="line">   <span class="number">5.8</span>    <span class="number">5.8</span>  <span class="number">269</span>:     backPreds := make([][]int, size)</div><div class="line">     .      .  <span class="number">270</span>:</div><div class="line">   <span class="number">1.9</span>    <span class="number">1.9</span>  <span class="number">271</span>:     number := make([]int, size)</div><div class="line">   <span class="number">1.9</span>    <span class="number">1.9</span>  <span class="number">272</span>:     header := make([]int, size, size)</div><div class="line">   <span class="number">1.9</span>    <span class="number">1.9</span>  <span class="number">273</span>:     types := make([]int, size, size)</div><div class="line">   <span class="number">1.9</span>    <span class="number">1.9</span>  <span class="number">274</span>:     last := make([]int, size, size)</div><div class="line">   <span class="number">1.9</span>    <span class="number">1.9</span>  <span class="number">275</span>:     nodes := make([]*UnionFindNode, size, size)</div><div class="line">     .      .  <span class="number">276</span>:</div><div class="line">     .      .  <span class="number">277</span>:     <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; size; i++ {</div><div class="line">   <span class="number">9.5</span>    <span class="number">9.5</span>  <span class="number">278</span>:             nodes[i] = new(UnionFindNode)</div><div class="line">     .      .  <span class="number">279</span>:     }</div><div class="line">...</div><div class="line">     .      .  <span class="number">286</span>:     <span class="keyword">for</span> i, bb := range cfgraph.Blocks {</div><div class="line">     .      .  <span class="number">287</span>:             number[bb.Name] = unvisited</div><div class="line">  <span class="number">29.5</span>   <span class="number">29.5</span>  <span class="number">288</span>:             nonBackPreds[i] = make(map[int]bool)</div><div class="line">     .      .  <span class="number">289</span>:     }</div><div class="line">...</div></pre></td></tr></table></figure>

<p>问题出在第28行，还是map对象。<br>如果我们使用<code>--inuse_objects</code>参数,它将显示分配的对象数量而不是大小：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">$ go tool pprof --inuse_objects havlak3 havlak3.mprof</div><div class="line">Adjusting heap profiles <span class="keyword">for</span> <span class="number">1</span>-in-<span class="number">524288</span> sampling rate</div><div class="line">Welcome to pprof!  For <span class="built_in">help</span>, <span class="built_in">type</span> <span class="string">'help'</span>.</div><div class="line">(pprof) list FindLoops</div><div class="line">Total: <span class="number">1763108</span> objects</div><div class="line">ROUTINE ====================== main.FindLoops <span class="keyword">in</span> /home/rsc/g/benchgraffiti/havlak/havlak3.go</div><div class="line"><span class="number">720903</span> <span class="number">720903</span> Total objects (flat / cumulative)</div><div class="line">...</div><div class="line">     .      .  <span class="number">277</span>:     <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; size; i++ {</div><div class="line"><span class="number">311296</span> <span class="number">311296</span>  <span class="number">278</span>:             nodes[i] = new(UnionFindNode)</div><div class="line">     .      .  <span class="number">279</span>:     }</div><div class="line">     .      .  <span class="number">280</span>:</div><div class="line">     .      .  <span class="number">281</span>:     // Step a:</div><div class="line">     .      .  <span class="number">282</span>:     //   - initialize all nodes as unvisited.</div><div class="line">     .      .  <span class="number">283</span>:     //   - depth-first traversal and numbering.</div><div class="line">     .      .  <span class="number">284</span>:     //   - unreached BB<span class="string">'s are marked as dead.</span></div><div class="line">     .      .  285:     //</div><div class="line">     .      .  286:     for i, bb := range cfgraph.Blocks {</div><div class="line">     .      .  287:             number[bb.Name] = unvisited</div><div class="line">409600 409600  288:             nonBackPreds[i] = make(map[int]bool)</div><div class="line">     .      .  289:     }</div><div class="line">...</div><div class="line">(pprof)</div></pre></td></tr></table></figure>

<p>原因map会保存一个键值对，太浪费空间，可以用一个slice代替，当然程序逻辑要求要保存一个不重复的对象，所以我们可以提供一个辅助方法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> appendUnique(a []<span class="typename">int</span>, x <span class="typename">int</span>) []<span class="typename">int</span> {</div><div class="line">    <span class="keyword">for</span> _, y := <span class="keyword">range</span> a {</div><div class="line">        <span class="keyword">if</span> x == y {</div><div class="line">            <span class="keyword">return</span> a</div><div class="line">        }</div><div class="line">    }</div><div class="line">    <span class="keyword">return</span> <span class="built_in">append</span>(a, x)</div><div class="line">}</div></pre></td></tr></table></figure>

<p>测试内存和CPU都比最开始的程序要好很多。</p>
<p>web 命令也可以显示内存分配和垃圾回收的占比图<code>(pprof) web mallocgc</code>：</p>
<p><img src="profiling-go-programs_havlak4a-mallocgc.png" alt=""></p>
<p>如果你觉得图中太多节点不好分析，可以忽略占比小于 10%的节点：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ go tool pprof --nodefraction=<span class="number">0.1</span> havlak4 havlak4.prof</div><div class="line">Welcome to pprof!  For <span class="built_in">help</span>, <span class="built_in">type</span> <span class="string">'help'</span>.</div><div class="line">(pprof) web mallocgc</div></pre></td></tr></table></figure>

<p>这节上面的分析翻译自Go的官方文档。我觉得官方的这篇文档很详细，很好的演示了如何对一个性能有问题的命令行程序进行代码分析。</p>
<p>除了上面的两个profile,Go还提供了heap profile、block profile、trace信息。</p>
<p>如果你正在开发HTTP程序，你可以使用<code>net/http/pprof</code>包来得到这些监控数据。</p>
<p>在包引入时增加：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> _ <span class="string">"net/http/pprof"</span></div></pre></td></tr></table></figure>

<p>它会增加一些handler在/debug/pprof/下。你可以直接运行<code>go tool pprof</code>访问这些链接:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">go tool pprof http://localhost:<span class="number">6060</span>/debug/pprof/profile   <span class="comment"># 30-second CPU profile</span></div><div class="line">go tool pprof http://localhost:<span class="number">6060</span>/debug/pprof/heap      <span class="comment"># heap profile</span></div><div class="line">go tool pprof http://localhost:<span class="number">6060</span>/debug/pprof/block     <span class="comment"># goroutine blocking profile</span></div></pre></td></tr></table></figure>

<p>你可以访问<code>http://localhost:6060/debug/pprof</code>查看这些profile。</p>
<p>可以看一下这些profile handler如何配置的：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> init() {</div><div class="line">    		http.Handle(<span class="string">"/debug/pprof/"</span>, http.HandlerFunc(Index))</div><div class="line">    		http.Handle(<span class="string">"/debug/pprof/cmdline"</span>, http.HandlerFunc(Cmdline))</div><div class="line">    		http.Handle(<span class="string">"/debug/pprof/profile"</span>, http.HandlerFunc(Profile))</div><div class="line">    		http.Handle(<span class="string">"/debug/pprof/symbol"</span>, http.HandlerFunc(Symbol))</div><div class="line">    		http.Handle(<span class="string">"/debug/pprof/trace"</span>, http.HandlerFunc(Trace))</div><div class="line">    	}</div></pre></td></tr></table></figure>

<p>可以看到它们设置在缺省的Mux上。所以如果你使用自己的Mux，或者使用第三方的框架，你可以模仿这个实现自己添建，甚至加上访问权限的控制。</p>
<p>具体可以看一个<code>Profile</code>方法的实现:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> Profile(w http.ResponseWriter, r *http.Request) {</div><div class="line">    		sec, _ := strconv.ParseInt(r.FormValue(<span class="string">"seconds"</span>),<span class="number"> 10</span>,<span class="number"> 64</span>)</div><div class="line">    		<span class="keyword">if</span> sec ==<span class="number"> 0</span> {</div><div class="line">    			sec =<span class="number"> 30</span></div><div class="line">   		}</div><div class="line"></div><div class="line">   		<span class="comment">// Set Content Type assuming StartCPUProfile will work,</span></div><div class="line">   		<span class="comment">// because if it does it starts writing.</span></div><div class="line">   		w.Header().Set(<span class="string">"Content-Type"</span>, <span class="string">"application/octet-stream"</span>)</div><div class="line">   		<span class="keyword">if</span> err := pprof.StartCPUProfile(w); err != <span class="constant">nil</span> {</div><div class="line">   			<span class="comment">// StartCPUProfile failed, so no writes yet.</span></div><div class="line">   			<span class="comment">// Can change header back to text content</span></div><div class="line">   			<span class="comment">// and send error code.</span></div><div class="line">   			w.Header().Set(<span class="string">"Content-Type"</span>, <span class="string">"text/plain; charset=utf-8"</span>)</div><div class="line">   			w.WriteHeader(http.StatusInternalServerError)</div><div class="line">   			fmt.Fprintf(w, <span class="string">"Could not enable CPU profiling: %s\n"</span>, err)</div><div class="line">   			<span class="keyword">return</span></div><div class="line">   		}</div><div class="line">   		sleep(w, time.Duration(sec)*time.Second)</div><div class="line">   		pprof.StopCPUProfile()</div><div class="line">   	}</div></pre></td></tr></table></figure>

<p>可见它会暂停n秒取得采样数据后才完全返回给客户端。</p>
<p>参考</p>
<ul>
<li><a href="https://golang.org/pkg/net/http/pprof/" target="_blank" rel="external">https://golang.org/pkg/net/http/pprof/</a></li>
<li><a href="https://golang.org/pkg/runtime/pprof/" target="_blank" rel="external">https://golang.org/pkg/runtime/pprof/</a></li>
<li><a href="https://blog.golang.org/profiling-go-programs" target="_blank" rel="external">https://blog.golang.org/profiling-go-programs</a></li>
<li><a href="https://github.com/gperftools/gperftools" target="_blank" rel="external">https://github.com/gperftools/gperftools</a></li>
<li><a href="http://saml.rilspace.org/profiling-and-creating-call-graphs-for-go-programs-with-go-tool-pprof" target="_blank" rel="external">http://saml.rilspace.org/profiling-and-creating-call-graphs-for-go-programs-with-go-tool-pprof</a></li>
<li><a href="http://stackoverflow.com/questions/30871691/cant-get-golang-pprof-working" target="_blank" rel="external">http://stackoverflow.com/questions/30871691/cant-get-golang-pprof-working</a></li>
<li><a href="https://signalfx.com/blog/a-pattern-for-optimizing-go-2/" target="_blank" rel="external">https://signalfx.com/blog/a-pattern-for-optimizing-go-2/</a></li>
<li><a href="http://blog.ralch.com/tutorial/golang-performance-and-memory-analysis/" target="_blank" rel="external">http://blog.ralch.com/tutorial/golang-performance-and-memory-analysis/</a></li>
</ul>
<h3 id="benchmark测试">benchmark测试</h3>
<p>Go提供了benchmark的通用解决方案，但我不准备在本文中介绍了，而是和Go测试技术放在一起介绍。</p>
<p>Go 测试技术一文会介绍官方的测试方法、benchmark的测试方法，示例代码的编写，文档的生成等。</p>
<p>在这里需要提到的是<code>go test</code>提供了生成这些profile数据的参数<code>cpuprofile</code>、``memprofile等，所以很容易的分析测试时的性能的问题。</p>
<h3 id="Go调试参数">Go调试参数</h3>
<p>go的运行时<code>runtime</code>提供了一堆的参数。</p>
<p><code>GOGC</code>环境变量可以设置触发GC时的内存占用。<code>runtime/debug</code>的<code>SetFGCPercent</code>可以在运行时修改这个参数。</p>
<p>另一个重要的环境变量就是<code>GODEBUG</code>。它包含多个参数可以逗号分隔<code>name=val</code>设置多个变量：</p>
<pre class="highlight">
allocfreetrace: 设置 allocfreetrace=1 会监控每次分配，但因每次分配和释放的栈信息（stack trace）

cgocheck: 设置 cgocheck=0 禁用所有cgo检查将Go指针传递给非Go代码是否正确。
cgocheck=1 (缺省值) 轻量级检查。cgocheck=2 重量级检查。

efence: 设置 efence=1 导致分配器 allocator将每个对象分配在一个唯一的页page上，地址不重用。

gccheckmark: 设置 gccheckmark=1 允许垃圾回收器执行并发mark阶段的校验。会导致Stop The World。

gcpacertrace: 设置 gcpacertrace=1 会让来几回收器打印出concurrent pacer的内部状态。

gcshrinkstackoff: 设置 gcshrinkstackoff=1 则禁止将 goroutines 的栈缩小为更小栈。

gcstackbarrieroff: 设置 gcstackbarrieroff=1 禁用stack barriers，会影响垃圾回收器的重复搜索栈的功能。

gcstackbarrierall: 设置 gcstackbarrierall=1 会为每个栈帧安装一 stack barriers。

gcstoptheworld: 设置 gcstoptheworld=1 则禁用并发垃圾回收,每次回收都会触发STW。设置gcstoptheworld=2则禁用垃圾回收后的concurrent sweeping。

gctrace: 设置 gctrace=1导致每次垃圾回收器触发一行日志，包含内存回收的概要信息和暂停的时间。设置gctrace=2起同样的效果，but also repeats each collection。格式如下：

    gc # @#s #%: #+#+# ms clock, #+#/#/#+# ms cpu, #->#-># MB, # MB goal, # P
where the fields are as follows:
    gc #        GC id,每次GC加一
    @#s         程序启动后的时间，单位秒
    #%          程序启动后GC所用的时间比
    #+...+#     此次GC所用的wall-clock/CPU时间
    #->#-># MB  GC开始时的堆大小, GC结束时的堆大小, 活着的(live)堆大小
    # MB goal   总的堆大小
    # P         CPU使用数
垃圾回收分为下面的几个阶段：stop-the-world (STW) sweep termination, concurrent
mark and scan, and STW mark termination。 mark/scan的CPU时间又分为 assist time (GC performed in
line with allocation), background GC time, and idle GC time。
如果日志后以"(forced)"结尾,则GC通过runtime.GC()调用执行，此时所有的阶段都是STW.

memprofilerate: 设置 memprofilerate=X 会更新runtime.MemProfileRate的值。0则禁用这个profie。

invalidptr: 默认设为invalidptr=1, 如果指针被赋予一个无效值,会引起程序的崩溃，设置该值为0，会停止该检查，
0只能临时用于查找bug，真正的解决方法是不要把整数类型的值存在指针变量里面。

sbrk: 设置 sbrk=1 会使用实验性的实现替换memory allocator 和 garbage collector。

scavenge: scavenge=1 允许heap scavenger的debug模式。

scheddetail: 设置 schedtrace=X 和 scheddetail=1 会导致goroutine调度器每个X毫秒输出多行调度信息。

schedtrace: 设置 schedtrace=X导致调度器每个X秒输出一行调度器的概要信息。
</pre>

<p>包<code>runtime/debug</code>提供了程序设置/查看运行时的一些方法。</p>
<p>垃圾回收信息相当有用，有一个工具提供了可视化显示垃圾回收的信息，拿就是<a href="https://github.com/davecheney/gcvis" target="_blank" rel="external">gcvis</a>,你可以通过<br><code>env GOMAXPROCS=4 gcvis godoc -index -http=:6060</code><br>或者<br><code>GODEBUG=gctrace=1 godoc -index -http=:6060 2&gt;&amp;1 | gcvis</code><br>或者</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">GODEBUG=gctrace=<span class="number">1</span> godoc -index -<span class="keyword">http</span>=:<span class="number">6060</span> <span class="number">2</span>&gt; <span class="keyword">stderr</span>.<span class="built_in">log</span></div><div class="line">cat <span class="keyword">stderr</span>.<span class="built_in">log</span> | gcvis</div></pre></td></tr></table></figure>

<p>来执行。</p>
<p>下面是一个图例：<br><img src="gcvis.png" alt=""></p>
<p>参考</p>
<ul>
<li><a href="https://golang.org/pkg/runtime/" target="_blank" rel="external">https://golang.org/pkg/runtime/</a></li>
<li><a href="http://golanghome.com/post/158" target="_blank" rel="external">http://golanghome.com/post/158</a></li>
<li><a href="http://dave.cheney.net/2014/07/11/visualising-the-go-garbage-collector" target="_blank" rel="external">http://dave.cheney.net/2014/07/11/visualising-the-go-garbage-collector</a></li>
<li><a href="https://holys.im/2016/07/01/monitor-golang-gc/" target="_blank" rel="external">https://holys.im/2016/07/01/monitor-golang-gc/</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
	
<div class="bdsharebuttonbox"><a title="分享到新浪微博" class="bds_tsina" href="#" data-cmd="tsina"></a><a title="分享到微信" class="bds_weixin" href="#" data-cmd="weixin"></a><a title="分享到QQ空间" class="bds_qzone" href="#" data-cmd="qzone"></a><a title="分享到印象笔记" class="bds_evernotecn" href="#" data-cmd="evernotecn"></a><a title="分享到有道云笔记" class="bds_youdao" href="#" data-cmd="youdao"></a><a title="分享到百度云收藏" class="bds_bdysc" href="#" data-cmd="bdysc"></a><a class="bds_more" href="#" data-cmd="more"></a></div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>
      

	  
        <a href="http://colobu.com/2016/07/04/dive-into-go-11/#comments" class="article-comment-link">评论</a>
      

      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/07/06/dive-into-go-12/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          深入Go语言 - 12
        
      </div>
    </a>
  
  
    <a href="/2016/07/02/bloom-filter-for-scala/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">[译]JVM上最快的Bloom filter实现</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div class="ds-thread" data-thread-key="2016/07/04/dive-into-go-11/" data-title="深入Go语言 - 11" data-url="http://colobu.com/2016/07/04/dive-into-go-11/"></div>

</section>

</section>
        
          <aside id="sidebar">
  
      <div class="widget-wrap">
    <h3 class="widget-title">原创图书</h3>
    <div class="widget">
      <a href="/ScalaCollectionsCookbook/">
        <img width="100%" src="/ScalaCollectionsCookbook/scala_collections_cookbook.jpg">
        <img width="100%" src="/ScalaCollectionsCookbook/scala_collections_cookbook_tw.png">
      </a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/DOTNET/">DOTNET</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Go/">Go</a><span class="category-list-count">52</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">58</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Scala/">Scala</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端开发/">前端开发</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/大数据/">大数据</a><span class="category-list-count">54</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工具/">工具</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/架构/">架构</a><span class="category-list-count">21</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/管理/">管理</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络编程/">网络编程</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/读书笔记/">读书笔记</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/运维/">运维</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/高并发编程/">高并发编程</a><span class="category-list-count">20</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/Android/" style="font-size: 15.71px;">Android</a><a href="/tags/ApacheBench/" style="font-size: 11.43px;">ApacheBench</a><a href="/tags/Bower/" style="font-size: 10.00px;">Bower</a><a href="/tags/C/" style="font-size: 10.00px;">C#</a><a href="/tags/CDN/" style="font-size: 10.00px;">CDN</a><a href="/tags/CQRS/" style="font-size: 10.00px;">CQRS</a><a href="/tags/CRC/" style="font-size: 10.00px;">CRC</a><a href="/tags/CSS/" style="font-size: 11.43px;">CSS</a><a href="/tags/CompletableFuture/" style="font-size: 10.00px;">CompletableFuture</a><a href="/tags/Comsat/" style="font-size: 10.00px;">Comsat</a><a href="/tags/Curator/" style="font-size: 20.00px;">Curator</a><a href="/tags/DSL/" style="font-size: 10.00px;">DSL</a><a href="/tags/Disruptor/" style="font-size: 10.00px;">Disruptor</a><a href="/tags/Docker/" style="font-size: 11.43px;">Docker</a><a href="/tags/Ember/" style="font-size: 11.43px;">Ember</a><a href="/tags/FastJson/" style="font-size: 10.00px;">FastJson</a><a href="/tags/Fiber/" style="font-size: 10.00px;">Fiber</a><a href="/tags/GAE/" style="font-size: 10.00px;">GAE</a><a href="/tags/GC/" style="font-size: 12.86px;">GC</a><a href="/tags/Gnuplot/" style="font-size: 10.00px;">Gnuplot</a><a href="/tags/Go/" style="font-size: 11.43px;">Go</a><a href="/tags/Gradle/" style="font-size: 10.00px;">Gradle</a><a href="/tags/Grunt/" style="font-size: 10.00px;">Grunt</a><a href="/tags/Gulp/" style="font-size: 10.00px;">Gulp</a><a href="/tags/Hadoop/" style="font-size: 10.00px;">Hadoop</a><a href="/tags/Hazelcast/" style="font-size: 10.00px;">Hazelcast</a><a href="/tags/Ignite/" style="font-size: 10.00px;">Ignite</a><a href="/tags/JVM/" style="font-size: 10.00px;">JVM</a><a href="/tags/Java/" style="font-size: 17.14px;">Java</a><a href="/tags/Kafka/" style="font-size: 18.57px;">Kafka</a><a href="/tags/Lambda/" style="font-size: 14.29px;">Lambda</a><a href="/tags/Linux/" style="font-size: 12.86px;">Linux</a><a href="/tags/LongAdder/" style="font-size: 10.00px;">LongAdder</a><a href="/tags/MathJax/" style="font-size: 10.00px;">MathJax</a><a href="/tags/Maven/" style="font-size: 11.43px;">Maven</a><a href="/tags/Memcached/" style="font-size: 10.00px;">Memcached</a><a href="/tags/Metrics/" style="font-size: 10.00px;">Metrics</a><a href="/tags/Mongo/" style="font-size: 12.86px;">Mongo</a><a href="/tags/Netty/" style="font-size: 15.71px;">Netty</a><a href="/tags/Node/" style="font-size: 10.00px;">Node</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">July 2015</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">June 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">May 2015</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">April 2015</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">March 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/02/">February 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">January 2015</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">December 2014</a><span class="archive-list-count">28</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/11/">November 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/10/">October 2014</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">September 2014</a><span class="archive-list-count">28</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">August 2014</a><span class="archive-list-count">19</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/07/">July 2014</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">近期文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/12/24/a-featured-fsm/">一个有特色的有限状态机</a>
          </li>
        
          <li>
            <a href="/2016/12/21/how-to-dump-goroutine-stack-traces/">调试利器：dump goroutine 的 stacktrace</a>
          </li>
        
          <li>
            <a href="/2016/12/20/detect-and-link-references-in-github/">Github和gitlab的自动连接</a>
          </li>
        
          <li>
            <a href="/2016/12/10/Food-Chain-of-Premier-League/">使用算法检测英超中的食物链</a>
          </li>
        
          <li>
            <a href="/2016/12/04/smooth-weighted-round-robin-algorithm/">平滑的基于权重的轮询算法</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">友情链接</h3>
    <div class="widget">
      <ul>
        
          <li>
			 
            <a href="http://old.colobu.com" target="_blank">旧的博客</a>
			
          </li>
        
          <li>
			 
			&nbsp;
			
          </li>
        
          <li>
			 
            <a href="http://stackshare.io" target="_blank">技术栈</a>
			
          </li>
        
          <li>
			 
			&nbsp;
			
          </li>
        
          <li>
			 
            <a href="http://weekly.manong.io/issues/" target="_blank">码农周刊</a>
			
          </li>
        
          <li>
			 
            <a href="http://www.tuicool.com/mags" target="_blank">编程狂人周刊</a>
			
          </li>
        
          <li>
			 
            <a href="http://www.importnew.com/" target="_blank">importnew</a>
			
          </li>
        
          <li>
			 
            <a href="http://ifeve.com/" target="_blank">并发编程网</a>
			
          </li>
        
          <li>
			 
			&nbsp;
			
          </li>
        
          <li>
			 
            <a href="http://github.com" target="_blank">github</a>
			
          </li>
        
          <li>
			 
            <a href="http://stackoverflow.com/" target="_blank">stackoverflow</a>
			
          </li>
        
          <li>
			 
            <a href="http://www.javacodegeeks.com/" target="_blank">javacodegeeks</a>
			
          </li>
        
          <li>
			 
            <a href="http://www.infoq.com/" target="_blank">infoq</a>
			
          </li>
        
          <li>
			 
            <a href="http://www.dzone.com/links/index.html" target="_blank">dzone</a>
			
          </li>
        
          <li>
			 
            <a href="https://oj.leetcode.com/problems/" target="_blank">leetcode</a>
			
          </li>
        
          <li>
			 
			&nbsp;
			
          </li>
        
          <li>
			 
            <a href="http://www.503error.com/" target="_blank">503error</a>
			
          </li>
        
      </ul>
    </div>
  </div>

  
      <div class="widget-wrap">
    <h3 class="widget-title">热评文章</h3>
    <div class="widget">
		<div class="ds-top-threads" data-range="monthly" data-num-items="5"></div>
    </div>
  </div>

  
      <div class="widget-wrap">
    <h3 class="widget-title">最新评论</h3>
    <div class="widget">
		<ul class="ds-recent-comments" data-num-items="10" data-show-avatars="1" data-show-time="1" data-show-admin="1" data-excerpt-length="70"></ul>
		<script type="text/javascript">
		var duoshuoQuery = {short_name:"colobu"};
		(function() {
			var ds = document.createElement('script');
			ds.type = 'text/javascript';ds.async = true;
			ds.src = 'http://static.duoshuo.com/embed.js';
			ds.charset = 'UTF-8';
			(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
		})();
		</script>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 smallnest<br>
	  Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
    <a href="https://github.com/smallnest" class="mobile-nav-link">github</a>
  
    <a href="http://tr.colobu.com" class="mobile-nav-link">技术流</a>
  
    <a href="/ScalaCollectionsCookbook" class="mobile-nav-link">Scala集合技术手册</a>
  
    <a href="/techreview" class="mobile-nav-link">技术快报</a>
  
    <a href="/about" class="mobile-nav-link">关于</a>
  
</nav>
    
<script src="//cdn.staticfile.org/jquery/1.11.1/jquery.min.js"></script>
<script src="//cdn.bootcss.com/jquery.lazyload/1.9.1/jquery.lazyload.min.js"></script>

<script src="//libs.cncdn.cn/fancybox/2.1.5/jquery.fancybox.pack.js"></script>


<script src="/js/script.js" type="text/javascript"></script>

<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
  });
  MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>
<script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.6.0-beta.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

<div id="totop" style="position:fixed;bottom:150px;right:10px;cursor: pointer;z-index: 2000;">
	<a title="返回顶部"><img src="/images/scrollup.png"/></a>
</div>
<script src="/js/totop.js" type="text/javascript"></script>



<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-142561-4']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>


<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e085d87993250aab11f3e0c15f1c2785";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


  </div>
</body>
</html>