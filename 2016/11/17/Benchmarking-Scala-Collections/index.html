<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>[译]Scala Collection的性能 | 鸟窝</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="这是翻译自 Li Haoyi 的 Benchmarking Scala Collections。
Li Haoyi 的背景了解Scala的人都知道，虽然Scala的官方文档对集合框架的性能提供了定性的分析，但是Li Haoyi的这篇文章定量的比较了各个框架类的性能，非常有参考意义，也便于你更好的正确的选择 Scala 集合中的类。
这篇文章从经验的角度深入研究了Scala集合库的运行特性。你也许已">
<meta property="og:type" content="article">
<meta property="og:title" content="[译]Scala Collection的性能">
<meta property="og:url" content="http://colobu.com/2016/11/17/Benchmarking-Scala-Collections/">
<meta property="og:site_name" content="鸟窝">
<meta property="og:description" content="这是翻译自 Li Haoyi 的 Benchmarking Scala Collections。
Li Haoyi 的背景了解Scala的人都知道，虽然Scala的官方文档对集合框架的性能提供了定性的分析，但是Li Haoyi的这篇文章定量的比较了各个框架类的性能，非常有参考意义，也便于你更好的正确的选择 Scala 集合中的类。
这篇文章从经验的角度深入研究了Scala集合库的运行特性。你也许已">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="[译]Scala Collection的性能">
<meta name="twitter:description" content="这是翻译自 Li Haoyi 的 Benchmarking Scala Collections。
Li Haoyi 的背景了解Scala的人都知道，虽然Scala的官方文档对集合框架的性能提供了定性的分析，但是Li Haoyi的这篇文章定量的比较了各个框架类的性能，非常有参考意义，也便于你更好的正确的选择 Scala 集合中的类。
这篇文章从经验的角度深入研究了Scala集合库的运行特性。你也许已">

  
    <link rel="alternative" href="/atom.xml" title="鸟窝" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">

  <link href="//cdn.staticfile.org/font-awesome/4.2.0/css/font-awesome.css" rel="stylesheet">
  
  <link rel="stylesheet" href="//libs.cncdn.cn/fancybox/2.1.5/jquery.fancybox.css" media="screen" type="text/css">
  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//cdn.staticfile.org/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->

  <script type="text/javascript">
	//visit my previous blog: http://old.colobu.com just like this http://colobu.com/?=123456
    var blog_url = location.href.toString();
	if (blog_url.indexOf("http://colobu.com/?p=") >= 0) {
		blog_url = blog_url.replace("colobu.com", "old.colobu.com");
		window.location.assign(blog_url);
	} else if (blog_url.indexOf("http://smallnest.gitcafe.com") >= 0) {
		blog_url = blog_url.replace("smallnest.gitcafe.com", "colobu.com");
		window.location.assign(blog_url);
	}  else if (blog_url.indexOf("http://smallnest.gitcafe.io") >= 0) {
		blog_url = blog_url.replace("smallnest.gitcafe.io", "colobu.com");
		window.location.assign(blog_url);
	}
</script>
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap" class="animated bounceInLeft">
        <a href="/" id="logo">鸟窝</a>
      </h1>
      
        <h2 id="subtitle-wrap" class="animated bounceInLeft">
          <a href="/" id="subtitle">大道至简 Simplicity is the ultimate form of sophistication</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/"><i class="fa fa-home">&nbsp;</i>首页</a>
        
          <a class="main-nav-link" href="/archives"><i class="fa fa-folder-o">&nbsp;</i>归档</a>
        
          <a class="main-nav-link" href="https://github.com/smallnest"><i class="fa fa-github">&nbsp;</i>github</a>
        
          <a class="main-nav-link" href="http://tr.colobu.com"><i class="fa fa-spinner fa-pulse">&nbsp;</i>技术流</a>
        
          <a class="main-nav-link" href="/ScalaCollectionsCookbook"><i class="fa fa-book">&nbsp;</i>Scala集合技术手册</a>
        
          <a class="main-nav-link" href="/techreview"><i class="fa fa-newspaper-o">&nbsp;</i>技术快报</a>
        
          <a class="main-nav-link" href="/about"><i class="fa fa-lemon-o">&nbsp;</i>关于</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="http://www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
          <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="Search">
          <input type="submit" value="" class="search-form-submit">
          <input name=tn type=hidden value="bds">
          <input name=cl type=hidden value="3">
          <input name=ct type=hidden value="2097152">
          <input type="hidden" name="si" value="colobu.com">
        </form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Benchmarking-Scala-Collections" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/11/17/Benchmarking-Scala-Collections/" class="article-date">
  <time datetime="2016-11-17T02:20:11.000Z" itemprop="datePublished">2016年11月17日</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Scala/">Scala</a>
  </div>

	
  <div class="article-author"> by smallnest</div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      [译]Scala Collection的性能
	  
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
	  
	    <h1 id="expanderHead" style="cursor:pointer;">
		目录 <span id="expanderSign">[−]</span>
		</h1>
	    <div id="article-entry-toc" data-role="collapsible" class="article-entry-toc">
		  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#内存占用"><span class="toc-text">内存占用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#不可变集合的内存占用"><span class="toc-text">不可变集合的内存占用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#不同数组的内存占用比较"><span class="toc-text">不同数组的内存占用比较</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#性能"><span class="toc-text">性能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Construction_Performance"><span class="toc-text">Construction Performance</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Deconstruction_Performance"><span class="toc-text">Deconstruction Performance</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Concatenation_Performance"><span class="toc-text">Concatenation Performance</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Foreach_Performance"><span class="toc-text">Foreach Performance</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Lookup_Performance"><span class="toc-text">Lookup Performance</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#测试结论"><span class="toc-text">测试结论</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#数组超级好"><span class="toc-text">数组超级好</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Set_和_Map_都很慢"><span class="toc-text">Set 和 Map 都很慢</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Lists_vs_Vectors"><span class="toc-text">Lists vs Vectors</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Lists_vs_mutable-Buffer"><span class="toc-text">Lists vs mutable.Buffer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Vector还算好吧"><span class="toc-text">Vector还算好吧</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-text">参考</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#带标准差的性能数据"><span class="toc-text">带标准差的性能数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Raw_Benchmark_Data"><span class="toc-text">Raw Benchmark Data</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Benchmark_Code"><span class="toc-text">Benchmark Code</span></a></li></ol></li></ol>
	    </div>
	  
	  
      
        <p>这是翻译自 <a href="http://www.lihaoyi.com" target="_blank" rel="external">Li Haoyi</a> 的 <a href="http://www.lihaoyi.com/post/BenchmarkingScalaCollections.html" target="_blank" rel="external">Benchmarking Scala Collections</a>。</p>
<p>Li Haoyi 的背景了解Scala的人都知道，虽然Scala的官方文档对集合框架的性能提供了<a href="http://docs.scala-lang.org/overviews/collections/performance-characteristics.html" target="_blank" rel="external">定性的分析</a>，但是Li Haoyi的这篇文章定量的比较了各个框架类的性能，非常有参考意义，也便于你更好的正确的选择 Scala 集合中的类。</p>
<p>这篇文章从经验的角度深入研究了Scala集合库的运行特性。你也许已经看到了很多的从实现的角度介绍Scala集合库的文章(<a href="http://docs.scala-lang.org/tutorials/FAQ/collections" target="_blank" rel="external">inheritance hierarchies</a>, <a href="http://docs.scala-lang.org/tutorials/FAQ/breakout.html" target="_blank" rel="external">CanBuildFrom</a>, <a href="http://docs.scala-lang.org/overviews/core/architecture-of-scala-collections.html" target="_blank" rel="external">等等</a>),但是很少有人写这些集合运行时的行为特性。</p>
<p><code>List</code>比<code>Vector</code>快，还是<code>Vector</code>比<code>List</code>快？使用未装箱的数组存储基本类型可以节省多少内存？什么时候你会执行一些性能的技巧，比如预分配大小的数组、使用<code>while-loop</code>取代<code>foreach</code>调用等，这些技巧真的有效么？声明<code>var l: List</code>还是<code>val b: mutable.Buffer</code>？这篇文章会给你答案。</p>
<a id="more"></a>
<blockquote>
<p>插播一条广告，对Scala集合感兴趣的读者可以阅读拙著 《Scala集合技术手册》，详细介绍了Scala集合的各个类的功能，各大网上书店均有销售，繁体中文版刚刚在台湾出版。</p>
</blockquote>
<p>Scala编程语言内建了丰富的集合类型： <code>List</code>、 <code>Vector</code>、 <code>Array</code>、 <code>Set</code>、 <code>Map</code>等等。当然还有一些众所周知的基础知识：<code>List</code>可以快速地在头部增加元素，但是索引起来很慢， <code>Vector</code>是一个很好的通用目的的集合，但是实践中这些集合处理的数据确很少。</p>
<p>例如，<code>Vector</code>集合要比数组多占用多少内存？<code>List</code>呢？使用<code>while-loop</code>比<code>foreach</code>调用要快多少？使用<code>Map</code>和<code>Set</code>的性能呢？</p>
<p>目前最好的描述这些运行时特性的文章是下面的表格，这个表格来自 <a href="http://docs.scala-lang.org/overviews/collections/performance-characteristics.html" target="_blank" rel="external">docs.scala-lang.org</a>:</p>
<table class="table table-bordered"><thead><tr><th>operation</th><th>head</th><th>tail</th><th>apply</th><th>update</th><th>prepend</th><th>append</th><th>insert</th></tr></thead><tbody><tr><td>List</td><td>C</td><td>C</td><td>L</td><td>L</td><td>C</td><td>L</td><td></td></tr><tr><td>Stream</td><td>C</td><td>C</td><td>L</td><td>L</td><td>C</td><td>L</td><td></td></tr><tr><td>Vector</td><td>eC</td><td>eC</td><td>eC</td><td>eC</td><td>eC</td><td>eC</td><td></td></tr><tr><td>Stack</td><td>C</td><td>C</td><td>L</td><td>L</td><td>C</td><td>C</td><td>L</td></tr><tr><td>Queue</td><td>aC</td><td>aC</td><td>L</td><td>L</td><td>L</td><td>C</td><td></td></tr><tr><td>Range</td><td>C</td><td>C</td><td>C</td><td></td><td></td><td></td><td></td></tr><tr><td>String</td><td>C</td><td>L</td><td>C</td><td>L</td><td>L</td><td>L</td><td></td></tr></tbody></table>

<p>其中表格中的数据代表时间复杂度，意义如下</p>
<table class="table table-bordered"><thead><tr><th>Key</th><th>Meaning</th></tr></thead><tbody><tr><td>C</td><td>常数时间The operation takes (fast) constant time.</td></tr><tr><td>eC</td><td>等价常数时间The operation takes effectively constant time, but this might depend on some assumptions such as maximum length of a vector or distribution of hash keys.</td></tr><tr><td>aC</td><td>平均常数时间The operation takes amortized constant time. Some invocations of the operation might take longer, but if many operations are performed on average only constant time per operation is taken.</td></tr><tr><td>Log</td><td>对数时间The operation takes time proportional to the logarithm of the collection size.</td></tr><tr><td>L</td><td>线性时间The operation is linear, that is it takes time proportional to the collection size.</td></tr><tr><td></td><td>The operation is not supported.</td></tr></tbody></table>

<p>This lacks concrete numbers and is a purely theoretical analysis. Worst, it uses weird terminology like &quot;Effectively Constant time, assuming maximum length&quot;, which is confusing and doesn&#39;t match what the rest of the world thinks when they discuss performance characteristics or asymptotic complexity (If you&#39;re wondering why you&#39;ve never heard the term &quot;Effectively Constant Time&quot; before, it&#39;s because everyone else calls it &quot;Logarithmic time&quot;, and it&#39;s the same as the &quot;Log&quot; category above).</p>
<p>This post will thus go into detail with benchmarking both the memory and performance characteristics of various Scala collections, from an empirical point of view. By using runtime benchmarks rather than theoretical analysis, we will gain an understanding of the behavior and nuances of the various Scala collections, far more than what you&#39;d gain from theoretical analysis or blind-leading-the-blind in-person discussions.</p>
<p>这个表格的问题在于它的指标是基于纯粹的理论分析。更糟糕的是，它使用奇怪的术语，如“等价常数时间，平均常数时间”等，这让人很迷惑，而且不符合其他人在讨论性能特征或渐近复杂性时的通常理解。</p>
<p>因此，这篇文章将从经验的角度详细介绍各种Scala集合的内存占用和性能特性。通过使用运行时benchmark数据而不是理论分析，我们将了解各种Scala集合的行为和细微差别，远远超过了从理论分析或盲人指路的讨论中获得的知识。</p>
<h2 id="内存占用">内存占用</h2>
<p>本文第一个要介绍的是各种集合的内存占用。它比性能更容易分析，因为它的结果是确定的：你不需要多次进行benchmark测试来求平均值来减少误差。虽然不太常用，但是你还是可以通过直接使用反射和Java的Instrumentation API写个程序来分析一个对象的内存占用。</p>
<p>有很多的文章介绍这个，比如：</p>
<ul>
<li><a href="http://www.javaworld.com/article/2077408/core-java/sizeof-for-java.html" target="_blank" rel="external">JavaWorld: Sizeof for Java</a></li>
<li><a href="http://www.aligelenler.com/2015/01/actual-memory-consumption-of-java.html" target="_blank" rel="external">Actual Memory Consumption of Java Objects</a></li>
</ul>
<p>它相对来说比较简单，我使用Scala写了一个，它使用反射来抓取对象引用图，然后使用Java Instrumentation agent提供的<code>getObjectSize</code>得到对象的大小：</p>
<figure class="highlight Scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> bench</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.lang.reflect.Modifier</div><div class="line"><span class="keyword">import</span> java.util</div><div class="line"></div><div class="line"><span class="keyword">import</span> scala.collection.mutable</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">object</span> <span class="title">DeepSize</span> </span>{</div><div class="line">  <span class="keyword">private</span> <span class="keyword">val</span> SKIP_POOLED_OBJECTS: Boolean = <span class="keyword">false</span></div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">def</span> isPooled(paramObject: AnyRef): Boolean = {</div><div class="line">    paramObject <span class="keyword">match</span>{</div><div class="line">      <span class="keyword">case</span> e: java.lang.Enum[_]   =&gt; <span class="keyword">true</span></div><div class="line">      <span class="keyword">case</span> s: java.lang.String    =&gt; s eq s.intern()</div><div class="line">      <span class="keyword">case</span> b: java.lang.Boolean   =&gt; (b eq java.lang.Boolean.TRUE) || (b eq java.lang.Boolean.FALSE)</div><div class="line">      <span class="keyword">case</span> i: java.lang.Integer   =&gt; i eq java.lang.Integer.valueOf(i)</div><div class="line">      <span class="keyword">case</span> s: java.lang.Short     =&gt; s eq java.lang.Short.valueOf(s)</div><div class="line">      <span class="keyword">case</span> b: java.lang.Byte      =&gt; b eq java.lang.Byte.valueOf(b)</div><div class="line">      <span class="keyword">case</span> l: java.lang.Long      =&gt; l eq java.lang.Long.valueOf(l)</div><div class="line">      <span class="keyword">case</span> c: java.lang.Character =&gt; c eq java.lang.Character.valueOf(c)</div><div class="line">      <span class="keyword">case</span> _ =&gt; <span class="keyword">false</span></div><div class="line">    }</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="javadoc">/**</span></div><div class="line">    * Calculates deep size</div><div class="line">    *</div><div class="line">    * <span class="javadoctag">@param</span> obj</div><div class="line">    * object to calculate size of</div><div class="line">    * <span class="javadoctag">@return</span> object deep size</div><div class="line">    */</div><div class="line">  <span class="keyword">def</span> apply(obj: AnyRef): Long = {</div><div class="line">    deepSizeOf(obj)</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">def</span> skipObject(obj: AnyRef, previouslyVisited: util.Map[AnyRef, AnyRef]): Boolean = {</div><div class="line">    <span class="keyword">if</span> (SKIP_POOLED_OBJECTS && isPooled(obj)) <span class="keyword">return</span> <span class="keyword">true</span></div><div class="line">    (obj == <span class="keyword">null</span>) || previouslyVisited.containsKey(obj)</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">def</span> deepSizeOf(obj0: AnyRef): Long = {</div><div class="line">    <span class="keyword">val</span> previouslyVisited = <span class="keyword">new</span> util.IdentityHashMap[AnyRef, AnyRef]</div><div class="line">    <span class="keyword">val</span> objectQueue = mutable.Queue(obj0)</div><div class="line">    <span class="keyword">var</span> current = <span class="number">0</span>L</div><div class="line">    <span class="keyword">while</span>(objectQueue.nonEmpty){</div><div class="line">      <span class="keyword">val</span> obj = objectQueue.dequeue()</div><div class="line">      <span class="keyword">if</span> (!skipObject(obj, previouslyVisited)){</div><div class="line">        previouslyVisited.put(obj, <span class="keyword">null</span>)</div><div class="line">        <span class="keyword">val</span> thisSize = agent.Agent.getObjectSize(obj)</div><div class="line"></div><div class="line">        <span class="comment">// get size of object + primitive variables + member pointers</span></div><div class="line">        <span class="comment">// for array header + len + if primitive total value for primitives</span></div><div class="line">        obj.getClass <span class="keyword">match</span>{</div><div class="line">          <span class="keyword">case</span> a <span class="keyword">if</span> a.isArray =&gt;</div><div class="line">            current += thisSize</div><div class="line">            <span class="comment">// primitive type arrays has length two, skip them (they included in the shallow size)</span></div><div class="line">            <span class="keyword">if</span> (a.getName.length != <span class="number">2</span>) {</div><div class="line">              <span class="keyword">val</span> lengthOfArray = java.lang.reflect.Array.getLength(obj)</div><div class="line">              <span class="keyword">for</span> (i &lt;- <span class="number">0</span> until lengthOfArray) {</div><div class="line">                objectQueue.enqueue(java.lang.reflect.Array.get(obj, i))</div><div class="line">              }</div><div class="line">            }</div><div class="line">          <span class="keyword">case</span> c =&gt;</div><div class="line">            current += thisSize</div><div class="line">            <span class="keyword">var</span> currentClass: Class[_] = c</div><div class="line">            do {</div><div class="line">              <span class="keyword">val</span> objFields = currentClass.getDeclaredFields</div><div class="line">              <span class="keyword">for</span>(field &lt;- objFields) {</div><div class="line">                <span class="keyword">if</span> (</div><div class="line">                  !Modifier.isStatic(field.getModifiers) &&</div><div class="line">                    !field.getType.isPrimitive</div><div class="line">                ) {</div><div class="line">                  field.setAccessible(<span class="keyword">true</span>)</div><div class="line">                  <span class="keyword">var</span> tempObject: AnyRef = <span class="keyword">null</span></div><div class="line">                  tempObject = field.get(obj)</div><div class="line">                  <span class="keyword">if</span> (tempObject != <span class="keyword">null</span>) objectQueue.enqueue(tempObject)</div><div class="line">                }</div><div class="line">              }</div><div class="line">              currentClass = currentClass.getSuperclass</div><div class="line">            } <span class="keyword">while</span> (currentClass != <span class="keyword">null</span>)</div><div class="line"></div><div class="line">        }</div><div class="line"></div><div class="line">      }</div><div class="line">    }</div><div class="line">    current</div><div class="line">  }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>随着这段代码没有考虑一些特殊的情况(32/64位的JVM／压缩指针的启用等等)，可能还有些bug,但是实际中哦我使用它计算一堆对象的大小的时候，它的结果和其它的工具比如<code>JProfiler</code>是一致的，所以我倾向于它的结果还是很准确的。如果你想尝试运行这段代码，或者想修改一下测量方法，可以运行下面的代码：</p>
<p><a href="http://colobu.com/2016/11/17/Benchmarking-Scala-Collections/#Benchmark_Code" target="_blank" rel="external">Benchmark Code</a></p>
<p>这样，我们运行不同大小的不同集合的时候计算内存占用就很简单了。每个集合填充新的对象都是一样的，除了<code>SortedSet</code>。<code>SortedSet</code>使用<code>java.lang.Integer(...)</code>填充了一段整数，这样它们可以被排序。</p>
<p>下表中就是测试的结果，单位是字节(byte),测试分别填充零个元素、一个元素、四个元素以及4的指数，一直到1,048,576个元素：</p>
<table class="table table-bordered"><tbody><tr><td align="left"><strong>Size</strong></td><td align="right"><strong>0</strong></td><td align="right"><strong>1</strong></td><td align="right"><strong>4</strong></td><td align="right"><strong>16</strong></td><td align="right"><strong>64</strong></td><td align="right"><strong>256</strong></td><td align="right"><strong>1,024</strong></td><td align="right"><strong>4,069</strong></td><td align="right"><strong>16,192</strong></td><td align="right"><strong>65,536</strong></td><td align="right"><strong>262,144</strong></td><td align="right"><strong>1,048,576</strong></td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left">Vector</td><td align="right">56</td><td align="right">216</td><td align="right">264</td><td align="right">456</td><td align="right">1,512</td><td align="right">5,448</td><td align="right">21,192</td><td align="right">84,312</td><td align="right">334,440</td><td align="right">1,353,192</td><td align="right">5,412,168</td><td align="right">21,648,072</td></tr><tr><td align="left">Array[Object]</td><td align="right">16</td><td align="right">40</td><td align="right">96</td><td align="right">336</td><td align="right">1,296</td><td align="right">5,136</td><td align="right">20,496</td><td align="right">81,400</td><td align="right">323,856</td><td align="right">1,310,736</td><td align="right">5,242,896</td><td align="right">20,971,536</td></tr><tr><td align="left">List</td><td align="right">16</td><td align="right">56</td><td align="right">176</td><td align="right">656</td><td align="right">2,576</td><td align="right">10,256</td><td align="right">40,976</td><td align="right">162,776</td><td align="right">647,696</td><td align="right">2,621,456</td><td align="right">10,485,776</td><td align="right">41,943,056</td></tr><tr><td align="left">Stream (unforced)</td><td align="right">16</td><td align="right">160</td><td align="right">160</td><td align="right">160</td><td align="right">160</td><td align="right">160</td><td align="right">160</td><td align="right">160</td><td align="right">160</td><td align="right">160</td><td align="right">160</td><td align="right">160</td></tr><tr><td align="left">Stream (forced)</td><td align="right">16</td><td align="right">56</td><td align="right">176</td><td align="right">656</td><td align="right">2,576</td><td align="right">10,256</td><td align="right">40,976</td><td align="right">162,776</td><td align="right">647,696</td><td align="right">2,621,456</td><td align="right">10,485,776</td><td align="right">41,943,056</td></tr><tr><td align="left">Set</td><td align="right">16</td><td align="right">32</td><td align="right">96</td><td align="right">880</td><td align="right">3,720</td><td align="right">14,248</td><td align="right">59,288</td><td align="right">234,648</td><td align="right">895,000</td><td align="right">3,904,144</td><td align="right">14,361,000</td><td align="right">60,858,616</td></tr><tr><td align="left">Map</td><td align="right">16</td><td align="right">56</td><td align="right">176</td><td align="right">1,648</td><td align="right">6,800</td><td align="right">26,208</td><td align="right">109,112</td><td align="right">428,592</td><td align="right">1,674,568</td><td align="right">7,055,272</td><td align="right">26,947,840</td><td align="right">111,209,368</td></tr><tr><td align="left">SortedSet</td><td align="right">40</td><td align="right">104</td><td align="right">248</td><td align="right">824</td><td align="right">3,128</td><td align="right">12,344</td><td align="right">49,208</td><td align="right">195,368</td><td align="right">777,272</td><td align="right">3,145,784</td><td align="right">12,582,968</td><td align="right">50,331,704</td></tr><tr><td align="left">Queue</td><td align="right">40</td><td align="right">80</td><td align="right">200</td><td align="right">680</td><td align="right">2,600</td><td align="right">10,280</td><td align="right">41,000</td><td align="right">162,800</td><td align="right">647,720</td><td align="right">2,621,480</td><td align="right">10,485,800</td><td align="right">41,943,080</td></tr><tr><td align="left">String</td><td align="right">40</td><td align="right">48</td><td align="right">48</td><td align="right">72</td><td align="right">168</td><td align="right">552</td><td align="right">2,088</td><td align="right">8,184</td><td align="right">32,424</td><td align="right">131,112</td><td align="right">524,328</td><td align="right">2,097,192</td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left"><strong>Size</strong></td><td align="right"><strong>0</strong></td><td align="right"><strong>1</strong></td><td align="right"><strong>4</strong></td><td align="right"><strong>16</strong></td><td align="right"><strong>64</strong></td><td align="right"><strong>256</strong></td><td align="right"><strong>1,024</strong></td><td align="right"><strong>4,069</strong></td><td align="right"><strong>16,192</strong></td><td align="right"><strong>65,536</strong></td><td align="right"><strong>262,144</strong></td><td align="right"><strong>1,048,576</strong></td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left">m.Buffer</td><td align="right">104</td><td align="right">120</td><td align="right">168</td><td align="right">360</td><td align="right">1,320</td><td align="right">5,160</td><td align="right">20,520</td><td align="right">81,528</td><td align="right">324,648</td><td align="right">1,310,760</td><td align="right">5,242,920</td><td align="right">20,971,560</td></tr><tr><td align="left">m.Map</td><td align="right">120</td><td align="right">176</td><td align="right">344</td><td align="right">1,080</td><td align="right">4,152</td><td align="right">16,440</td><td align="right">65,592</td><td align="right">260,688</td><td align="right">1,037,880</td><td align="right">4,194,360</td><td align="right">16,777,272</td><td align="right">67,108,920</td></tr><tr><td align="left">m.Set</td><td align="right">184</td><td align="right">200</td><td align="right">248</td><td align="right">568</td><td align="right">2,104</td><td align="right">8,248</td><td align="right">32,824</td><td align="right">130,696</td><td align="right">521,272</td><td align="right">2,097,208</td><td align="right">8,388,664</td><td align="right">33,554,488</td></tr><tr><td align="left">m.Queue</td><td align="right">48</td><td align="right">88</td><td align="right">208</td><td align="right">688</td><td align="right">2,608</td><td align="right">10,288</td><td align="right">41,008</td><td align="right">162,808</td><td align="right">647,728</td><td align="right">2,621,488</td><td align="right">10,485,808</td><td align="right">41,943,088</td></tr><tr><td align="left">m.PriQueue</td><td align="right">144</td><td align="right">160</td><td align="right">208</td><td align="right">464</td><td align="right">1,616</td><td align="right">6,224</td><td align="right">24,656</td><td align="right">81,568</td><td align="right">324,688</td><td align="right">1,572,944</td><td align="right">6,291,536</td><td align="right">25,165,904</td></tr><tr><td align="left">m.Stack</td><td align="right">32</td><td align="right">72</td><td align="right">192</td><td align="right">672</td><td align="right">2,592</td><td align="right">10,272</td><td align="right">40,992</td><td align="right">162,792</td><td align="right">647,712</td><td align="right">2,621,472</td><td align="right">10,485,792</td><td align="right">41,943,072</td></tr><tr><td align="left">m.SortedSet</td><td align="right">80</td><td align="right">128</td><td align="right">272</td><td align="right">848</td><td align="right">3,152</td><td align="right">12,368</td><td align="right">49,232</td><td align="right">195,392</td><td align="right">777,296</td><td align="right">3,145,808</td><td align="right">12,582,992</td><td align="right">50,331,728</td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left"><strong>Size</strong></td><td align="right"><strong>0</strong></td><td align="right"><strong>1</strong></td><td align="right"><strong>4</strong></td><td align="right"><strong>16</strong></td><td align="right"><strong>64</strong></td><td align="right"><strong>256</strong></td><td align="right"><strong>1,024</strong></td><td align="right"><strong>4,069</strong></td><td align="right"><strong>16,192</strong></td><td align="right"><strong>65,536</strong></td><td align="right"><strong>262,144</strong></td><td align="right"><strong>1,048,576</strong></td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left">Array[Boolean]</td><td align="right">16</td><td align="right">24</td><td align="right">24</td><td align="right">32</td><td align="right">80</td><td align="right">272</td><td align="right">1,040</td><td align="right">4,088</td><td align="right">16,208</td><td align="right">65,552</td><td align="right">262,160</td><td align="right">1,048,592</td></tr><tr><td align="left">Array[Byte]</td><td align="right">16</td><td align="right">24</td><td align="right">24</td><td align="right">32</td><td align="right">80</td><td align="right">272</td><td align="right">1,040</td><td align="right">4,088</td><td align="right">16,208</td><td align="right">65,552</td><td align="right">262,160</td><td align="right">1,048,592</td></tr><tr><td align="left">Array[Short]</td><td align="right">16</td><td align="right">24</td><td align="right">24</td><td align="right">48</td><td align="right">144</td><td align="right">528</td><td align="right">2,064</td><td align="right">8,160</td><td align="right">32,400</td><td align="right">131,088</td><td align="right">524,304</td><td align="right">2,097,168</td></tr><tr><td align="left">Array[Int]</td><td align="right">16</td><td align="right">24</td><td align="right">32</td><td align="right">80</td><td align="right">272</td><td align="right">1,040</td><td align="right">4,112</td><td align="right">16,296</td><td align="right">64,784</td><td align="right">262,160</td><td align="right">1,048,592</td><td align="right">4,194,320</td></tr><tr><td align="left">Array[Long]</td><td align="right">16</td><td align="right">24</td><td align="right">48</td><td align="right">144</td><td align="right">528</td><td align="right">2,064</td><td align="right">8,208</td><td align="right">32,568</td><td align="right">129,552</td><td align="right">524,304</td><td align="right">2,097,168</td><td align="right">8,388,624</td></tr><tr><td align="left">Boxed Array[Boolean]</td><td align="right">16</td><td align="right">40</td><td align="right">64</td><td align="right">112</td><td align="right">304</td><td align="right">1,072</td><td align="right">4,144</td><td align="right">16,328</td><td align="right">64,816</td><td align="right">262,192</td><td align="right">1,048,624</td><td align="right">4,194,352</td></tr><tr><td align="left">Boxed Array[Byte]</td><td align="right">16</td><td align="right">40</td><td align="right">96</td><td align="right">336</td><td align="right">1,296</td><td align="right">5,136</td><td align="right">8,208</td><td align="right">20,392</td><td align="right">68,880</td><td align="right">266,256</td><td align="right">1,052,688</td><td align="right">4,198,416</td></tr><tr><td align="left">Boxed Array[Short]</td><td align="right">16</td><td align="right">40</td><td align="right">96</td><td align="right">336</td><td align="right">1,296</td><td align="right">5,136</td><td align="right">20,496</td><td align="right">81,400</td><td align="right">323,856</td><td align="right">1,310,736</td><td align="right">5,230,608</td><td align="right">20,910,096</td></tr><tr><td align="left">Boxed Array[Int]</td><td align="right">16</td><td align="right">40</td><td align="right">96</td><td align="right">336</td><td align="right">1,296</td><td align="right">5,136</td><td align="right">20,496</td><td align="right">81,400</td><td align="right">323,856</td><td align="right">1,310,736</td><td align="right">5,242,896</td><td align="right">20,971,536</td></tr><tr><td align="left">Boxed Array[Long]</td><td align="right">16</td><td align="right">48</td><td align="right">128</td><td align="right">464</td><td align="right">1,808</td><td align="right">7,184</td><td align="right">28,688</td><td align="right">113,952</td><td align="right">453,392</td><td align="right">1,835,024</td><td align="right">7,340,048</td><td align="right">29,360,144</td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left"><strong>Size</strong></td><td align="right"><strong>0</strong></td><td align="right"><strong>1</strong></td><td align="right"><strong>4</strong></td><td align="right"><strong>16</strong></td><td align="right"><strong>64</strong></td><td align="right"><strong>256</strong></td><td align="right"><strong>1,024</strong></td><td align="right"><strong>4,069</strong></td><td align="right"><strong>16,192</strong></td><td align="right"><strong>65,536</strong></td><td align="right"><strong>262,144</strong></td><td align="right"><strong>1,048,576</strong></td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left">j.List</td><td align="right">216</td><td align="right">240</td><td align="right">312</td><td align="right">600</td><td align="right">1,944</td><td align="right">7,320</td><td align="right">28,824</td><td align="right">114,192</td><td align="right">454,296</td><td align="right">1,835,160</td><td align="right">7,340,184</td><td align="right">29,360,280</td></tr><tr><td align="left">j.Map</td><td align="right">240</td><td align="right">296</td><td align="right">464</td><td align="right">1,200</td><td align="right">4,272</td><td align="right">16,560</td><td align="right">65,712</td><td align="right">260,808</td><td align="right">1,038,000</td><td align="right">4,194,480</td><td align="right">16,777,392</td><td align="right">67,109,040</td></tr><tr><td align="left">j.Set</td><td align="right">296</td><td align="right">312</td><td align="right">360</td><td align="right">680</td><td align="right">2,216</td><td align="right">8,360</td><td align="right">32,936</td><td align="right">130,808</td><td align="right">521,384</td><td align="right">2,097,320</td><td align="right">8,388,776</td><td align="right">33,554,600</td></tr></tbody></table>

<p>你可以花点时间好好看看这些数据，但是我单独挑出来下面的数据进行比较和讨论：</p>
<h3 id="不可变集合的内存占用">不可变集合的内存占用</h3>
<table class="table table-bordered"><tbody><tr><td align="left"><strong>Size</strong></td><td align="right"><strong>0</strong></td><td align="right"><strong>1</strong></td><td align="right"><strong>4</strong></td><td align="right"><strong>16</strong></td><td align="right"><strong>64</strong></td><td align="right"><strong>256</strong></td><td align="right"><strong>1,024</strong></td><td align="right"><strong>4,069</strong></td><td align="right"><strong>16,192</strong></td><td align="right"><strong>65,536</strong></td><td align="right"><strong>262,144</strong></td><td align="right"><strong>1,048,576</strong></td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left">Vector</td><td align="right">56</td><td align="right">216</td><td align="right">264</td><td align="right">456</td><td align="right">1,512</td><td align="right">5,448</td><td align="right">21,192</td><td align="right">84,312</td><td align="right">334,440</td><td align="right">1,353,192</td><td align="right">5,412,168</td><td align="right">21,648,072</td></tr><tr><td align="left">Array[Object]</td><td align="right">16</td><td align="right">40</td><td align="right">96</td><td align="right">336</td><td align="right">1,296</td><td align="right">5,136</td><td align="right">20,496</td><td align="right">81,400</td><td align="right">323,856</td><td align="right">1,310,736</td><td align="right">5,242,896</td><td align="right">20,971,536</td></tr><tr><td align="left">List</td><td align="right">16</td><td align="right">56</td><td align="right">176</td><td align="right">656</td><td align="right">2,576</td><td align="right">10,256</td><td align="right">40,976</td><td align="right">162,776</td><td align="right">647,696</td><td align="right">2,621,456</td><td align="right">10,485,776</td><td align="right">41,943,056</td></tr><tr><td align="left">Stream (unforced)</td><td align="right">16</td><td align="right">160</td><td align="right">160</td><td align="right">160</td><td align="right">160</td><td align="right">160</td><td align="right">160</td><td align="right">160</td><td align="right">160</td><td align="right">160</td><td align="right">160</td><td align="right">160</td></tr><tr><td align="left">Stream (forced)</td><td align="right">16</td><td align="right">56</td><td align="right">176</td><td align="right">656</td><td align="right">2,576</td><td align="right">10,256</td><td align="right">40,976</td><td align="right">162,776</td><td align="right">647,696</td><td align="right">2,621,456</td><td align="right">10,485,776</td><td align="right">41,943,056</td></tr><tr><td align="left">Set</td><td align="right">16</td><td align="right">32</td><td align="right">96</td><td align="right">880</td><td align="right">3,720</td><td align="right">14,248</td><td align="right">59,288</td><td align="right">234,648</td><td align="right">895,000</td><td align="right">3,904,144</td><td align="right">14,361,000</td><td align="right">60,858,616</td></tr><tr><td align="left">Map</td><td align="right">16</td><td align="right">56</td><td align="right">176</td><td align="right">1,648</td><td align="right">6,800</td><td align="right">26,208</td><td align="right">109,112</td><td align="right">428,592</td><td align="right">1,674,568</td><td align="right">7,055,272</td><td align="right">26,947,840</td><td align="right">111,209,368</td></tr><tr><td align="left">SortedSet</td><td align="right">40</td><td align="right">104</td><td align="right">248</td><td align="right">824</td><td align="right">3,128</td><td align="right">12,344</td><td align="right">49,208</td><td align="right">195,368</td><td align="right">777,272</td><td align="right">3,145,784</td><td align="right">12,582,968</td><td align="right">50,331,704</td></tr><tr><td align="left">Queue</td><td align="right">40</td><td align="right">80</td><td align="right">200</td><td align="right">680</td><td align="right">2,600</td><td align="right">10,280</td><td align="right">41,000</td><td align="right">162,800</td><td align="right">647,720</td><td align="right">2,621,480</td><td align="right">10,485,800</td><td align="right">41,943,080</td></tr><tr><td align="left">String</td><td align="right">40</td><td align="right">48</td><td align="right">48</td><td align="right">72</td><td align="right">168</td><td align="right">552</td><td align="right">2,088</td><td align="right">8,184</td><td align="right">32,424</td><td align="right">131,112</td><td align="right">524,328</td><td align="right">2,097,192</td></tr></tbody></table>

<p>它们都是很常用的Scala集合，大部分都是不可变的，java.lang.String, 还有scala.Stream 和Array[Object]。</p>
<p>　看下面的比较:</p>
<table class="table table-bordered"><tbody><tr><td align="left"><strong>Size</strong></td><td align="right"><strong>0</strong></td><td align="right"><strong>1</strong></td><td align="right"><strong>4</strong></td><td align="right"><strong>16</strong></td><td align="right"><strong>64</strong></td><td align="right"><strong>256</strong></td><td align="right"><strong>1,024</strong></td><td align="right"><strong>4,069</strong></td><td align="right"><strong>16,192</strong></td><td align="right"><strong>65,536</strong></td><td align="right"><strong>262,144</strong></td><td align="right"><strong>1,048,576</strong></td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left">Vector</td><td align="right">56</td><td align="right">216</td><td align="right">264</td><td align="right">456</td><td align="right">1,512</td><td align="right">5,448</td><td align="right">21,192</td><td align="right">84,312</td><td align="right">334,440</td><td align="right">1,353,192</td><td align="right">5,412,168</td><td align="right">21,648,072</td></tr><tr><td align="left">Array[Object]</td><td align="right">16</td><td align="right">40</td><td align="right">96</td><td align="right">336</td><td align="right">1,296</td><td align="right">5,136</td><td align="right">20,496</td><td align="right">81,400</td><td align="right">323,856</td><td align="right">1,310,736</td><td align="right">5,242,896</td><td align="right">20,971,536</td></tr></tbody></table>

<p>小的<code>vector</code>会比小的数组多占用3 ~ 5倍的内存。只有一个元素的vector就会占用1K内存的五分之一。<br>16个元素的vector会有所好转，只多占了30%左右的内存，而1,048,576个元素的vector只多占了5%左右的内存。</p>
<p>内部实现上，小的vector有些浪费，而大的vector的浪费就可以忽略不计了。</p>
<p>再看下表：</p>
<table class="table table-bordered"><tbody><tr><td align="left"><strong>Size</strong></td><td align="right"><strong>0</strong></td><td align="right"><strong>1</strong></td><td align="right"><strong>4</strong></td><td align="right"><strong>16</strong></td><td align="right"><strong>64</strong></td><td align="right"><strong>256</strong></td><td align="right"><strong>1,024</strong></td><td align="right"><strong>4,069</strong></td><td align="right"><strong>16,192</strong></td><td align="right"><strong>65,536</strong></td><td align="right"><strong>262,144</strong></td><td align="right"><strong>1,048,576</strong></td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left">Array[Object]</td><td align="right">16</td><td align="right">40</td><td align="right">96</td><td align="right">336</td><td align="right">1,296</td><td align="right">5,136</td><td align="right">20,496</td><td align="right">81,400</td><td align="right">323,856</td><td align="right">1,310,736</td><td align="right">5,242,896</td><td align="right">20,971,536</td></tr><tr><td align="left">List</td><td align="right">16</td><td align="right">56</td><td align="right">176</td><td align="right">656</td><td align="right">2,576</td><td align="right">10,256</td><td align="right">40,976</td><td align="right">162,776</td><td align="right">647,696</td><td align="right">2,621,456</td><td align="right">10,485,776</td><td align="right">41,943,056</td></tr></tbody></table>

<p>从四个元素开始，<code>List</code>内存占用是<code>Array[Object]</code>的两倍。这并不奇怪，因为List的每个节点是一个包装节点，这个节点对每个元素进行了包装。</p>
<p>再看下表：</p>
<table class="table table-bordered"><tbody><tr><td align="left"><strong>Size</strong></td><td align="right"><strong>0</strong></td><td align="right"><strong>1</strong></td><td align="right"><strong>4</strong></td><td align="right"><strong>16</strong></td><td align="right"><strong>64</strong></td><td align="right"><strong>256</strong></td><td align="right"><strong>1,024</strong></td><td align="right"><strong>4,069</strong></td><td align="right"><strong>16,192</strong></td><td align="right"><strong>65,536</strong></td><td align="right"><strong>262,144</strong></td><td align="right"><strong>1,048,576</strong></td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left">List</td><td align="right">16</td><td align="right">56</td><td align="right">176</td><td align="right">656</td><td align="right">2,576</td><td align="right">10,256</td><td align="right">40,976</td><td align="right">162,776</td><td align="right">647,696</td><td align="right">2,621,456</td><td align="right">10,485,776</td><td align="right">41,943,056</td></tr><tr><td align="left">Stream (unforced)</td><td align="right">16</td><td align="right">160</td><td align="right">160</td><td align="right">160</td><td align="right">160</td><td align="right">160</td><td align="right">160</td><td align="right">160</td><td align="right">160</td><td align="right">160</td><td align="right">160</td><td align="right">160</td></tr><tr><td align="left">Stream (forced)</td><td align="right">16</td><td align="right">56</td><td align="right">176</td><td align="right">656</td><td align="right">2,576</td><td align="right">10,256</td><td align="right">40,976</td><td align="right">162,776</td><td align="right">647,696</td><td align="right">2,621,456</td><td align="right">10,485,776</td><td align="right">41,943,056</td></tr></tbody></table>

<p><code>Stream (forced)</code>和<code>List</code>占用的内存一样多，<code>Stream (unforced)</code>几乎不占内存，因为它还没有被填充。</p>
<p>继续看下个表格的比较：</p>
<table class="table table-bordered"><tbody><tr><td align="left"><strong>Size</strong></td><td align="right"><strong>0</strong></td><td align="right"><strong>1</strong></td><td align="right"><strong>4</strong></td><td align="right"><strong>16</strong></td><td align="right"><strong>64</strong></td><td align="right"><strong>256</strong></td><td align="right"><strong>1,024</strong></td><td align="right"><strong>4,069</strong></td><td align="right"><strong>16,192</strong></td><td align="right"><strong>65,536</strong></td><td align="right"><strong>262,144</strong></td><td align="right"><strong>1,048,576</strong></td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left">Array[Object]</td><td align="right">16</td><td align="right">40</td><td align="right">96</td><td align="right">336</td><td align="right">1,296</td><td align="right">5,136</td><td align="right">20,496</td><td align="right">81,400</td><td align="right">323,856</td><td align="right">1,310,736</td><td align="right">5,242,896</td><td align="right">20,971,536</td></tr><tr><td align="left">Set</td><td align="right">16</td><td align="right">32</td><td align="right">96</td><td align="right">880</td><td align="right">3,720</td><td align="right">14,248</td><td align="right">59,288</td><td align="right">234,648</td><td align="right">895,000</td><td align="right">3,904,144</td><td align="right">14,361,000</td><td align="right">60,858,616</td></tr><tr><td align="left">Map</td><td align="right">16</td><td align="right">56</td><td align="right">176</td><td align="right">1,648</td><td align="right">6,800</td><td align="right">26,208</td><td align="right">109,112</td><td align="right">428,592</td><td align="right">1,674,568</td><td align="right">7,055,272</td><td align="right">26,947,840</td><td align="right">111,209,368</td></tr></tbody></table>

<p>小的<code>Set</code>的内存占用和数组一样多，但是大的<code>Set</code>的内存占用是数组的三倍。这是合理的，小Set专用用来存储单一的对象，而大的Set用树做存储。让我有些惊奇的是占用会那么多，我本来期望多占用50% ~ 100%也就够了，没想到会多占用200%。</p>
<p>同样的情况也适用小Map和大Map。一开始小Map会比数组占用两倍的内存，最后占用6倍的内存。</p>
<p>再看一个内存比较：</p>
<table class="table table-bordered"><tbody><tr><td align="left"><strong>Size</strong></td><td align="right"><strong>0</strong></td><td align="right"><strong>1</strong></td><td align="right"><strong>4</strong></td><td align="right"><strong>16</strong></td><td align="right"><strong>64</strong></td><td align="right"><strong>256</strong></td><td align="right"><strong>1,024</strong></td><td align="right"><strong>4,069</strong></td><td align="right"><strong>16,192</strong></td><td align="right"><strong>65,536</strong></td><td align="right"><strong>262,144</strong></td><td align="right"><strong>1,048,576</strong></td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left">Array[Object]</td><td align="right">16</td><td align="right">40</td><td align="right">96</td><td align="right">336</td><td align="right">1,296</td><td align="right">5,136</td><td align="right">20,496</td><td align="right">81,400</td><td align="right">323,856</td><td align="right">1,310,736</td><td align="right">5,242,896</td><td align="right">20,971,536</td></tr><tr><td align="left">String</td><td align="right">40</td><td align="right">48</td><td align="right">48</td><td align="right">72</td><td align="right">168</td><td align="right">552</td><td align="right">2,088</td><td align="right">8,184</td><td align="right">32,424</td><td align="right">131,112</td><td align="right">524,328</td><td align="right">2,097,192</td></tr></tbody></table>

<p><code>String</code>存储2-byte字符，而不是存储4-byte的指针，这些指针指向16-byte的对象。因此测试结果也不意味，它们使用数组十分之一的内存来存储相同大小的元素。</p>
<h3 id="不同数组的内存占用比较">不同数组的内存占用比较</h3>
<table class="table table-bordered"><tbody><tr><td align="left"><strong>Size</strong></td><td align="right"><strong>0</strong></td><td align="right"><strong>1</strong></td><td align="right"><strong>4</strong></td><td align="right"><strong>16</strong></td><td align="right"><strong>64</strong></td><td align="right"><strong>256</strong></td><td align="right"><strong>1,024</strong></td><td align="right"><strong>4,069</strong></td><td align="right"><strong>16,192</strong></td><td align="right"><strong>65,536</strong></td><td align="right"><strong>262,144</strong></td><td align="right"><strong>1,048,576</strong></td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left">Array[Object]</td><td align="right">16</td><td align="right">40</td><td align="right">96</td><td align="right">336</td><td align="right">1,296</td><td align="right">5,136</td><td align="right">20,496</td><td align="right">81,400</td><td align="right">323,856</td><td align="right">1,310,736</td><td align="right">5,242,896</td><td align="right">20,971,536</td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left"><strong>Size</strong></td><td align="right"><strong>0</strong></td><td align="right"><strong>1</strong></td><td align="right"><strong>4</strong></td><td align="right"><strong>16</strong></td><td align="right"><strong>64</strong></td><td align="right"><strong>256</strong></td><td align="right"><strong>1,024</strong></td><td align="right"><strong>4,069</strong></td><td align="right"><strong>16,192</strong></td><td align="right"><strong>65,536</strong></td><td align="right"><strong>262,144</strong></td><td align="right"><strong>1,048,576</strong></td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left">Array[Boolean]</td><td align="right">16</td><td align="right">24</td><td align="right">24</td><td align="right">32</td><td align="right">80</td><td align="right">272</td><td align="right">1,040</td><td align="right">4,088</td><td align="right">16,208</td><td align="right">65,552</td><td align="right">262,160</td><td align="right">1,048,592</td></tr><tr><td align="left">Array[Byte]</td><td align="right">16</td><td align="right">24</td><td align="right">24</td><td align="right">32</td><td align="right">80</td><td align="right">272</td><td align="right">1,040</td><td align="right">4,088</td><td align="right">16,208</td><td align="right">65,552</td><td align="right">262,160</td><td align="right">1,048,592</td></tr><tr><td align="left">Array[Short]</td><td align="right">16</td><td align="right">24</td><td align="right">24</td><td align="right">48</td><td align="right">144</td><td align="right">528</td><td align="right">2,064</td><td align="right">8,160</td><td align="right">32,400</td><td align="right">131,088</td><td align="right">524,304</td><td align="right">2,097,168</td></tr><tr><td align="left">Array[Int]</td><td align="right">16</td><td align="right">24</td><td align="right">32</td><td align="right">80</td><td align="right">272</td><td align="right">1,040</td><td align="right">4,112</td><td align="right">16,296</td><td align="right">64,784</td><td align="right">262,160</td><td align="right">1,048,592</td><td align="right">4,194,320</td></tr><tr><td align="left">Array[Long]</td><td align="right">16</td><td align="right">24</td><td align="right">48</td><td align="right">144</td><td align="right">528</td><td align="right">2,064</td><td align="right">8,208</td><td align="right">32,568</td><td align="right">129,552</td><td align="right">524,304</td><td align="right">2,097,168</td><td align="right">8,388,624</td></tr><tr><td align="left">Boxed Array[Boolean]</td><td align="right">16</td><td align="right">40</td><td align="right">64</td><td align="right">112</td><td align="right">304</td><td align="right">1,072</td><td align="right">4,144</td><td align="right">16,328</td><td align="right">64,816</td><td align="right">262,192</td><td align="right">1,048,624</td><td align="right">4,194,352</td></tr><tr><td align="left">Boxed Array[Byte]</td><td align="right">16</td><td align="right">40</td><td align="right">96</td><td align="right">336</td><td align="right">1,296</td><td align="right">5,136</td><td align="right">8,208</td><td align="right">20,392</td><td align="right">68,880</td><td align="right">266,256</td><td align="right">1,052,688</td><td align="right">4,198,416</td></tr><tr><td align="left">Boxed Array[Short]</td><td align="right">16</td><td align="right">40</td><td align="right">96</td><td align="right">336</td><td align="right">1,296</td><td align="right">5,136</td><td align="right">20,496</td><td align="right">81,400</td><td align="right">323,856</td><td align="right">1,310,736</td><td align="right">5,230,608</td><td align="right">20,910,096</td></tr><tr><td align="left">Boxed Array[Int]</td><td align="right">16</td><td align="right">40</td><td align="right">96</td><td align="right">336</td><td align="right">1,296</td><td align="right">5,136</td><td align="right">20,496</td><td align="right">81,400</td><td align="right">323,856</td><td align="right">1,310,736</td><td align="right">5,242,896</td><td align="right">20,971,536</td></tr><tr><td align="left">Boxed Array[Long]</td><td align="right">16</td><td align="right">48</td><td align="right">128</td><td align="right">464</td><td align="right">1,808</td><td align="right">7,184</td><td align="right">28,688</td><td align="right">113,952</td><td align="right">453,392</td><td align="right">1,835,024</td><td align="right">7,340,048</td><td align="right">29,360,144</td></tr></tbody></table>

<p>各种未装箱的基本类型的数据的内存占用要比装箱的数组内存占用小一个数量级。这是合理的，因为<code>Array[Object]</code>需要为每一个元素存储4-byte的指针，数组本身<br>要包含16-byte object header (8 bytes for mark word, 8 bytes for class-pointer)。相比之下，Byte、 Short、 Int 或 Long相应的要占用1、 2、 4 或 8 byte。你可以看到这些数组的内存占用的确切比例，数组的对象头有几个字节的开销。</p>
<blockquote>
<p>译者注: 你可以参考下列文章来了解数组的开销：</p>
<ul>
<li><a href="http://www.javamex.com/tutorials/memory/array_memory_usage.shtml" target="_blank" rel="external">How to calculate the memory usage of a Java array</a></li>
<li><a href="http://java-performance.info/overview-of-memory-saving-techniques-java/" target="_blank" rel="external">An overview of memory saving techniques in Java</a></li>
<li><a href="http://btoddb-java-sizing.blogspot.com" target="_blank" rel="external">How Much Heap Space Does My Object Use?</a></li>
</ul>
</blockquote>
<p>值得注意的是，<code>Array[Boolean]``占用了与</code>Array[Byte]`相同的内存。虽然理论上它们可以为布尔值进行压缩，以一个bit来存储，但实际它们不是这样存储的。如果你想要更有效地存储标志，你应该使用某种bit set来存储你的布尔值。</p>
<p>装箱数组的行为也很有趣。你可能认为一个装箱的原始数组需要占用<code>Array[Object]</code>相同的内存占用。毕竟，一个<code>Boxed Int</code>或<code>Byte</code>最终是一个<code>java.lang.Integer</code>或<code>java.lang.Byte</code>，它是<code>Object</code>的子类。然而，这些常量的较小值是内部池化的(interned)，因此在整个程序中只有公用的两个装箱的布尔值和256个装箱字节占用。因此，装箱的<code>Array[Byte]</code>最多只占用与<code>Array[Int]</code>相同的内存，因为它只填充了4个字节的指向共享对象的指针。</p>
<p>装箱的<code>Int</code>和<code>Long</code>对于小的数值是公用的，但是对绝大部分的数值不会共用。 因此，这些最终占用与<code>Array[Object]</code>相同的（或更多）内存。</p>
<blockquote>
<p>译者注： 如果你对Java Integer小值的实现还不太了解的话，你可以测试下面的代码，看看结果是不是很意外<br>     Integer i1=127;<br>     Integer i2=127;<br>     System.out.println(i1==i2); //true<br>     Integer i3=128;<br>     Integer i4=128;<br>     System.out.println(i3==i4); //false</p>
</blockquote>
<p>你可能从上面的表格数据中会发现更多的有趣的东西，但是上面基本的比较已经让你感觉到不同的数据结构有很大的不同。尽管当今的计算机拥有很多的内存，但是知道内存会占多大依然很有用：</p>
<ul>
<li><p>使用更有效的数据结构意味着可以减少内存使用，可以使用更小的Amazon EC2 主机或者其它小的云主机来减少花费。在写这篇文章的时候，AWS m3-large机器的花费只是 r3-large机器的1/3，而后者只不过多了一倍的内存而已。积水成多，大的集群的节省的费用累加起来就不是一个小数目。</p>
</li>
<li><p>为每个元素使用较小的内存意味着你可以把它们直接放入内存，而不是持久化到数据库或者磁盘上。内存中的操作至少要比读取文件或者数据库访问要快一个数量级。</p>
</li>
</ul>
<p>即使你一开始先忽略内存使用然后再回来优化它，当你回来优化的时候，你仍然想知道如何权衡不同集合的内存开销。希望这部分内容可以帮助你做出使您的代码更有效率的决定。</p>
<h2 id="性能">性能</h2>
<p>我们下一个要关注的事情就是使用各种集合执行通用的操作要花多长时间。不像内存占用那样可以静态分析，运行时的性能通常会有噪点和=和随机性：JIT编译器是否启用、垃圾回收是否发生等。</p>
<p>然而，即使我们不能得到精确的数字，我们肯定能得到一个非常接近的数值。下面的内容就是执行各种有代表性的操作得到的“粗”的benchmark：</p>
<ul>
<li>每个benchmark运行7次，一次2秒</li>
<li>每次运行都和其他的benchmark交叉运行</li>
<li>运行完毕，只取中间的五个值，最大最小值抛弃。然后计算平均值和标准差。</li>
</ul>
<p>尽管这不是非常精确，但是对benchmark来说也足够了。Benchmark代码已经要花4个半小时运行，我不想再让它变得更严谨。</p>
<p>测试的独立的benchmark包括:</p>
<ul>
<li><strong>Construct</strong>: 构建一个大小为n的数据结构,从空的数据结构（Nil,等等）开始一次增加一个元素。使用 <code>::</code> for Lists, <code>:+</code> for Vectors, <code>+</code> for Sets, <code>.append</code> for mutable.Buffer等等， 对于数组， benchmark即使用了<code>:+</code>也使用预分配大小的数组来测试。</li>
<li><strong>Concat</strong>: 构建大小为n的两个同样类型的集合，然后把它们连接成一个集合。 对于不可变集合使用<code>++</code>,对于可变集合使用 <code>.appendAll</code> 或 <code>++=</code> 执行原地操作</li>
<li><strong>Deconstruct</strong>: 开始构建一个大小为n的集合，然后一次一个的把元素移除，直到它为空为止。</li>
<li><strong>Foreach</strong>: 迭代一个集合元素的时间花费</li>
<li><strong>Lookup</strong>: 查找每一个元素的时间花费,使用<code>collection(i)</code>语法。注意它测试的查找每一个元素，通过一个while-loop实现。</li>
</ul>
<p><code>Foreach</code> 和 <code>Lookup</code>的 benchmark 要比其它的测试长10 甚至 100倍。总的时间被平均了（divided）。这是为了故意拉长运行时间,以便可以看到随机噪点和运行时的变化。</p>
<p>汇总数据如下，你可以查看原始数据。每一个benchmark（lookup,concat）占表格的一节,每一行代表一种集合的一个操作(有的集合有多个benchmark)，每一列代表执行这个benchmark所花费的平均时间。</p>
<p>注意为了简单这里并没有显示标准方差，如果你想查看它们可以跳到 <a href="">带标准差的性能数据</a>一节。</p>
<table class="table table-bordered"><tbody><tr><td align="left"><strong>construct</strong></td><td align="right"><strong>0</strong></td><td align="right"><strong>1</strong></td><td align="right"><strong>4</strong></td><td align="right"><strong>16</strong></td><td align="right"><strong>64</strong></td><td align="right"><strong>256</strong></td><td align="right"><strong>1,024</strong></td><td align="right"><strong>4,096</strong></td><td align="right"><strong>16,192</strong></td><td align="right"><strong>65,536</strong></td><td align="right"><strong>262,144</strong></td><td align="right"><strong>1,048,576</strong></td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left">Array-prealloc</td><td align="right">17</td><td align="right">10</td><td align="right">14</td><td align="right">41</td><td align="right">186</td><td align="right">710</td><td align="right">2,710</td><td align="right">11,000</td><td align="right">45,100</td><td align="right">183,000</td><td align="right">730,000</td><td align="right">3,100,000</td></tr><tr><td align="left">Array:+</td><td align="right">2</td><td align="right">12</td><td align="right">58</td><td align="right">270</td><td align="right">1,460</td><td align="right">19,800</td><td align="right">260,000</td><td align="right">3,170,000</td><td align="right">60,000,000</td><td align="right">1,020,000,000</td><td align="right"></td><td align="right"></td></tr><tr><td align="left">List::</td><td align="right">1</td><td align="right">4</td><td align="right">12</td><td align="right">69</td><td align="right">301</td><td align="right">1,220</td><td align="right">4,900</td><td align="right">19,800</td><td align="right">79,000</td><td align="right">329,000</td><td align="right">1,510,000</td><td align="right">9,100,000</td></tr><tr><td align="left">Vector:+</td><td align="right">2</td><td align="right">15</td><td align="right">99</td><td align="right">410</td><td align="right">1,730</td><td align="right">7,000</td><td align="right">28,600</td><td align="right">324,000</td><td align="right">1,498,000</td><td align="right">7,140,000</td><td align="right">31,700,000</td><td align="right">131,000,000</td></tr><tr><td align="left">Set+</td><td align="right">1</td><td align="right">12</td><td align="right">58</td><td align="right">1,860</td><td align="right">8,530</td><td align="right">37,400</td><td align="right">166,000</td><td align="right">783,000</td><td align="right">3,600,000</td><td align="right">18,100,000</td><td align="right">94,000,000</td><td align="right">473,000,000</td></tr><tr><td align="left">Map+</td><td align="right">1</td><td align="right">6</td><td align="right">95</td><td align="right">2,100</td><td align="right">9,010</td><td align="right">38,900</td><td align="right">171,000</td><td align="right">810,000</td><td align="right">3,710,000</td><td align="right">18,400,000</td><td align="right">96,000,000</td><td align="right">499,000,000</td></tr><tr><td align="left">Array.toSet</td><td align="right">73</td><td align="right">75</td><td align="right">187</td><td align="right">2,140</td><td align="right">9,220</td><td align="right">40,000</td><td align="right">174,000</td><td align="right">833,000</td><td align="right">3,800,000</td><td align="right">19,300,000</td><td align="right">101,000,000</td><td align="right">506,000,000</td></tr><tr><td align="left">Array.toMap</td><td align="right">21</td><td align="right">31</td><td align="right">104</td><td align="right">2,100</td><td align="right">9,200</td><td align="right">39,500</td><td align="right">173,000</td><td align="right">820,000</td><td align="right">3,790,000</td><td align="right">19,500,000</td><td align="right">104,000,000</td><td align="right">540,000,000</td></tr><tr><td align="left">Array.toVector</td><td align="right">95</td><td align="right">109</td><td align="right">143</td><td align="right">287</td><td align="right">903</td><td align="right">3,310</td><td align="right">12,850</td><td align="right">51,100</td><td align="right">203,800</td><td align="right">821,000</td><td align="right">3,270,000</td><td align="right">13,300,000</td></tr><tr><td align="left">m.Buffer</td><td align="right">19</td><td align="right">30</td><td align="right">58</td><td align="right">174</td><td align="right">691</td><td align="right">2,690</td><td align="right">10,840</td><td align="right">43,000</td><td align="right">169,800</td><td align="right">687,000</td><td align="right">2,770,000</td><td align="right">11,790,000</td></tr><tr><td align="left">m.Map.put</td><td align="right">6</td><td align="right">79</td><td align="right">297</td><td align="right">1,420</td><td align="right">6,200</td><td align="right">25,500</td><td align="right">103,000</td><td align="right">414,000</td><td align="right">1,820,000</td><td align="right">8,100,000</td><td align="right">57,000,000</td><td align="right">348,000,000</td></tr><tr><td align="left">m.Set.add</td><td align="right">13</td><td align="right">76</td><td align="right">276</td><td align="right">1,430</td><td align="right">6,700</td><td align="right">27,900</td><td align="right">113,000</td><td align="right">455,000</td><td align="right">1,840,000</td><td align="right">7,900,000</td><td align="right">39,000,000</td><td align="right">267,000,000</td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left"><strong>deconstruct</strong></td><td align="right"><strong>0</strong></td><td align="right"><strong>1</strong></td><td align="right"><strong>4</strong></td><td align="right"><strong>16</strong></td><td align="right"><strong>64</strong></td><td align="right"><strong>256</strong></td><td align="right"><strong>1,024</strong></td><td align="right"><strong>4,096</strong></td><td align="right"><strong>16,192</strong></td><td align="right"><strong>65,536</strong></td><td align="right"><strong>262,144</strong></td><td align="right"><strong>1,048,576</strong></td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left">Array.tail</td><td align="right">7</td><td align="right">26</td><td align="right">114</td><td align="right">582</td><td align="right">4,517</td><td align="right">55,500</td><td align="right">821,000</td><td align="right">12,140,000</td><td align="right">188,000,000</td><td align="right">3,100,000,000</td><td align="right"></td><td align="right"></td></tr><tr><td align="left">List.tail</td><td align="right">2</td><td align="right">2</td><td align="right">7</td><td align="right">21</td><td align="right">100</td><td align="right">420</td><td align="right">2,100</td><td align="right">10,000</td><td align="right">35,000</td><td align="right">120,000</td><td align="right">540,000</td><td align="right">1,500,000</td></tr><tr><td align="left">Vector.tail</td><td align="right">3</td><td align="right">6</td><td align="right">90</td><td align="right">425</td><td align="right">1,970</td><td align="right">11,800</td><td align="right">58,400</td><td align="right">500,000</td><td align="right">2,390,000</td><td align="right">11,000,000</td><td align="right">50,200,000</td><td align="right">211,000,000</td></tr><tr><td align="left">Vector.init</td><td align="right">2</td><td align="right">5</td><td align="right">103</td><td align="right">483</td><td align="right">2,490</td><td align="right">12,800</td><td align="right">64,000</td><td align="right">543,000</td><td align="right">2,470,000</td><td align="right">11,900,000</td><td align="right">52,600,000</td><td align="right">218,000,000</td></tr><tr><td align="left">Set.-</td><td align="right">8</td><td align="right">30</td><td align="right">162</td><td align="right">1,480</td><td align="right">7,700</td><td align="right">34,200</td><td align="right">164,000</td><td align="right">770,000</td><td align="right">3,660,000</td><td align="right">20,300,000</td><td align="right">94,000,000</td><td align="right">420,000,000</td></tr><tr><td align="left">Map.-</td><td align="right">12</td><td align="right">52</td><td align="right">201</td><td align="right">1,430</td><td align="right">7,660</td><td align="right">34,900</td><td align="right">169,000</td><td align="right">810,000</td><td align="right">3,990,000</td><td align="right">24,000,000</td><td align="right">103,000,000</td><td align="right">470,000,000</td></tr><tr><td align="left">m.Buffer</td><td align="right">6</td><td align="right">8</td><td align="right">14</td><td align="right">43</td><td align="right">166</td><td align="right">630</td><td align="right">2,510</td><td align="right">10,000</td><td align="right">40,600</td><td align="right">167,000</td><td align="right">660,000</td><td align="right">2,490,000</td></tr><tr><td align="left">m.Set</td><td align="right">5</td><td align="right">28</td><td align="right">130</td><td align="right">671</td><td align="right">4,900</td><td align="right">54,000</td><td align="right">770,000</td><td align="right">11,990,000</td><td align="right">189,000,000</td><td align="right">3,040,000,000</td><td align="right"></td><td align="right"></td></tr><tr><td align="left">m.Map</td><td align="right">7</td><td align="right">44</td><td align="right">172</td><td align="right">670</td><td align="right">3,650</td><td align="right">26,400</td><td align="right">282,000</td><td align="right">3,970,000</td><td align="right">62,600,000</td><td align="right">1,000,000,000</td><td align="right"></td><td align="right"></td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left"><strong>concat</strong></td><td align="right"><strong>0</strong></td><td align="right"><strong>1</strong></td><td align="right"><strong>4</strong></td><td align="right"><strong>16</strong></td><td align="right"><strong>64</strong></td><td align="right"><strong>256</strong></td><td align="right"><strong>1,024</strong></td><td align="right"><strong>4,096</strong></td><td align="right"><strong>16,192</strong></td><td align="right"><strong>65,536</strong></td><td align="right"><strong>262,144</strong></td><td align="right"><strong>1,048,576</strong></td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left">Array++</td><td align="right">89</td><td align="right">83</td><td align="right">85</td><td align="right">91</td><td align="right">144</td><td align="right">330</td><td align="right">970</td><td align="right">4,100</td><td align="right">17,000</td><td align="right">70,000</td><td align="right">380,000</td><td align="right">1,700,000</td></tr><tr><td align="left">arraycopy</td><td align="right">23</td><td align="right">18</td><td align="right">20</td><td align="right">27</td><td align="right">48</td><td align="right">280</td><td align="right">1,000</td><td align="right">4,000</td><td align="right">16,000</td><td align="right">65,000</td><td align="right">360,000</td><td align="right">1,400,000</td></tr><tr><td align="left">List</td><td align="right">7</td><td align="right">81</td><td align="right">162</td><td align="right">434</td><td align="right">1,490</td><td align="right">5,790</td><td align="right">23,200</td><td align="right">92,500</td><td align="right">370,000</td><td align="right">1,510,000</td><td align="right">6,300,000</td><td align="right">30,000,000</td></tr><tr><td align="left">Vector</td><td align="right">5</td><td align="right">48</td><td align="right">188</td><td align="right">327</td><td align="right">940</td><td align="right">3,240</td><td align="right">12,700</td><td align="right">52,000</td><td align="right">210,000</td><td align="right">810,000</td><td align="right">3,370,000</td><td align="right">14,500,000</td></tr><tr><td align="left">Set</td><td align="right">91</td><td align="right">95</td><td align="right">877</td><td align="right">1,130</td><td align="right">5,900</td><td align="right">26,900</td><td align="right">149,000</td><td align="right">680,000</td><td align="right">3,600,000</td><td align="right">23,000,000</td><td align="right">100,000,000</td><td align="right">280,000,000</td></tr><tr><td align="left">Map</td><td align="right">54</td><td align="right">53</td><td align="right">967</td><td align="right">1,480</td><td align="right">6,900</td><td align="right">31,500</td><td align="right">166,000</td><td align="right">760,000</td><td align="right">4,100,000</td><td align="right">27,000,000</td><td align="right">118,000,000</td><td align="right">450,000,000</td></tr><tr><td align="left">m.Buffer</td><td align="right">11</td><td align="right">32</td><td align="right">32</td><td align="right">38</td><td align="right">70</td><td align="right">250</td><td align="right">700</td><td align="right">3,900</td><td align="right">20,000</td><td align="right">40,000</td><td align="right">400,000</td><td align="right">1,500,000</td></tr><tr><td align="left">m.Set</td><td align="right">58</td><td align="right">81</td><td align="right">142</td><td align="right">1,080</td><td align="right">4,200</td><td align="right">16,000</td><td align="right">69,000</td><td align="right">263,000</td><td align="right">1,160,000</td><td align="right">6,300,000</td><td align="right">43,000,000</td><td align="right">310,000,000</td></tr><tr><td align="left">m.Map</td><td align="right">47</td><td align="right">69</td><td align="right">181</td><td align="right">990</td><td align="right">3,700</td><td align="right">15,000</td><td align="right">62,000</td><td align="right">290,000</td><td align="right">1,500,000</td><td align="right">16,000,000</td><td align="right">103,000,000</td><td align="right">493,000,000</td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left"><strong>foreach</strong></td><td align="right"><strong>0</strong></td><td align="right"><strong>1</strong></td><td align="right"><strong>4</strong></td><td align="right"><strong>16</strong></td><td align="right"><strong>64</strong></td><td align="right"><strong>256</strong></td><td align="right"><strong>1,024</strong></td><td align="right"><strong>4,096</strong></td><td align="right"><strong>16,192</strong></td><td align="right"><strong>65,536</strong></td><td align="right"><strong>262,144</strong></td><td align="right"><strong>1,048,576</strong></td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left">Array</td><td align="right">2</td><td align="right">5</td><td align="right">15</td><td align="right">57</td><td align="right">230</td><td align="right">900</td><td align="right">3,580</td><td align="right">14,200</td><td align="right">55,600</td><td align="right">228,000</td><td align="right">910,000</td><td align="right">3,610,000</td></tr><tr><td align="left">Array-while</td><td align="right">0</td><td align="right">1</td><td align="right">0</td><td align="right">1</td><td align="right">0</td><td align="right">0</td><td align="right">0</td><td align="right">-4</td><td align="right">10</td><td align="right">70</td><td align="right">0</td><td align="right">500</td></tr><tr><td align="left">List</td><td align="right">0</td><td align="right">3</td><td align="right">13</td><td align="right">50</td><td align="right">209</td><td align="right">800</td><td align="right">3,500</td><td align="right">14,100</td><td align="right">55,000</td><td align="right">231,000</td><td align="right">920,000</td><td align="right">3,800,000</td></tr><tr><td align="left">List-while</td><td align="right">4</td><td align="right">5</td><td align="right">13</td><td align="right">49</td><td align="right">211</td><td align="right">812</td><td align="right">3,400</td><td align="right">14,200</td><td align="right">57,000</td><td align="right">226,000</td><td align="right">930,000</td><td align="right">3,700,000</td></tr><tr><td align="left">Vector</td><td align="right">15</td><td align="right">19</td><td align="right">30</td><td align="right">74</td><td align="right">268</td><td align="right">1,000</td><td align="right">3,960</td><td align="right">16,200</td><td align="right">62,000</td><td align="right">256,000</td><td align="right">1,030,000</td><td align="right">4,300,000</td></tr><tr><td align="left">Set</td><td align="right">4</td><td align="right">5</td><td align="right">10</td><td align="right">99</td><td align="right">420</td><td align="right">1,560</td><td align="right">10,200</td><td align="right">51,000</td><td align="right">217,000</td><td align="right">2,200,000</td><td align="right">10,800,000</td><td align="right">48,600,000</td></tr><tr><td align="left">Map</td><td align="right">19</td><td align="right">7</td><td align="right">20</td><td align="right">140</td><td align="right">610</td><td align="right">2,500</td><td align="right">13,900</td><td align="right">72,800</td><td align="right">360,000</td><td align="right">3,700,000</td><td align="right">20,700,000</td><td align="right">75,000,000</td></tr><tr><td align="left">m.Buffer</td><td align="right">0</td><td align="right">1</td><td align="right">1</td><td align="right">1</td><td align="right">1</td><td align="right">0</td><td align="right">1</td><td align="right">2</td><td align="right">-1</td><td align="right">-10</td><td align="right">0</td><td align="right">-200</td></tr><tr><td align="left">m.Set</td><td align="right">19</td><td align="right">26</td><td align="right">50</td><td align="right">130</td><td align="right">508</td><td align="right">2,190</td><td align="right">11,900</td><td align="right">56,600</td><td align="right">235,000</td><td align="right">940,000</td><td align="right">3,800,000</td><td align="right">14,700,000</td></tr><tr><td align="left">m.Map</td><td align="right">8</td><td align="right">16</td><td align="right">48</td><td align="right">146</td><td align="right">528</td><td align="right">2,210</td><td align="right">10,300</td><td align="right">54,100</td><td align="right">255,000</td><td align="right">1,140,000</td><td align="right">6,800,000</td><td align="right">30,000,000</td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left"><strong>lookup</strong></td><td align="right"><strong>0</strong></td><td align="right"><strong>1</strong></td><td align="right"><strong>4</strong></td><td align="right"><strong>16</strong></td><td align="right"><strong>64</strong></td><td align="right"><strong>256</strong></td><td align="right"><strong>1,024</strong></td><td align="right"><strong>4,096</strong></td><td align="right"><strong>16,192</strong></td><td align="right"><strong>65,536</strong></td><td align="right"><strong>262,144</strong></td><td align="right"><strong>1,048,576</strong></td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left">Array</td><td align="right">0</td><td align="right">1</td><td align="right">1</td><td align="right">1</td><td align="right">0</td><td align="right">0</td><td align="right">1</td><td align="right">-1</td><td align="right">4</td><td align="right">0</td><td align="right">100</td><td align="right">-200</td></tr><tr><td align="left">List</td><td align="right">0</td><td align="right">1</td><td align="right">8</td><td align="right">103</td><td align="right">2,390</td><td align="right">47,200</td><td align="right">870,000</td><td align="right">16,900,000</td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left">Vector</td><td align="right">0</td><td align="right">1</td><td align="right">5</td><td align="right">17</td><td align="right">104</td><td align="right">440</td><td align="right">1,780</td><td align="right">8,940</td><td align="right">38,000</td><td align="right">198,000</td><td align="right">930,000</td><td align="right">4,260,000</td></tr><tr><td align="left">Set</td><td align="right">0</td><td align="right">18</td><td align="right">81</td><td align="right">507</td><td align="right">1,980</td><td align="right">7,800</td><td align="right">39,800</td><td align="right">203,000</td><td align="right">1,040,000</td><td align="right">8,300,000</td><td align="right"></td><td align="right"></td></tr><tr><td align="left">Map</td><td align="right">0</td><td align="right">12</td><td align="right">97</td><td align="right">578</td><td align="right">2,250</td><td align="right">9,400</td><td align="right">46,000</td><td align="right">233,000</td><td align="right">1,150,000</td><td align="right">11,400,000</td><td align="right"></td><td align="right"></td></tr><tr><td align="left">m.Buffer</td><td align="right">0</td><td align="right">1</td><td align="right">1</td><td align="right">1</td><td align="right">1</td><td align="right">1</td><td align="right">1</td><td align="right">0</td><td align="right">6</td><td align="right">-10</td><td align="right">0</td><td align="right">0</td></tr><tr><td align="left">m.Set</td><td align="right">0</td><td align="right">5</td><td align="right">22</td><td align="right">97</td><td align="right">410</td><td align="right">1,690</td><td align="right">7,100</td><td align="right">31,300</td><td align="right">148,000</td><td align="right">690,000</td><td align="right">4,800,000</td><td align="right"></td></tr><tr><td align="left">m.Map</td><td align="right">0</td><td align="right">6</td><td align="right">25</td><td align="right">112</td><td align="right">454</td><td align="right">1,910</td><td align="right">9,400</td><td align="right">52,500</td><td align="right">243,000</td><td align="right">1,760,000</td><td align="right">9,900,000</td><td align="right"></td></tr></tbody></table>


<p>带标准差的原始的数据和测试代码在文章的后面，你可以深入挖据一下这些数据。在本文中，我将讨论一些我看到的一些有趣的数据。</p>
<h3 id="Construction_Performance">Construction Performance</h3>
<table class="table table-bordered"><tbody><tr><td align="left"><strong>construct</strong></td><td align="right"><strong>0</strong></td><td align="right"><strong>1</strong></td><td align="right"><strong>4</strong></td><td align="right"><strong>16</strong></td><td align="right"><strong>64</strong></td><td align="right"><strong>256</strong></td><td align="right"><strong>1,024</strong></td><td align="right"><strong>4,096</strong></td><td align="right"><strong>16,192</strong></td><td align="right"><strong>65,536</strong></td><td align="right"><strong>262,144</strong></td><td align="right"><strong>1,048,576</strong></td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left">Array-prealloc</td><td align="right">17</td><td align="right">10</td><td align="right">14</td><td align="right">41</td><td align="right">186</td><td align="right">710</td><td align="right">2,710</td><td align="right">11,000</td><td align="right">45,100</td><td align="right">183,000</td><td align="right">730,000</td><td align="right">3,100,000</td></tr><tr><td align="left">Array:+</td><td align="right">2</td><td align="right">12</td><td align="right">58</td><td align="right">270</td><td align="right">1,460</td><td align="right">19,800</td><td align="right">260,000</td><td align="right">3,170,000</td><td align="right">60,000,000</td><td align="right">1,020,000,000</td><td align="right"></td><td align="right"></td></tr><tr><td align="left">List::</td><td align="right">1</td><td align="right">4</td><td align="right">12</td><td align="right">69</td><td align="right">301</td><td align="right">1,220</td><td align="right">4,900</td><td align="right">19,800</td><td align="right">79,000</td><td align="right">329,000</td><td align="right">1,510,000</td><td align="right">9,100,000</td></tr><tr><td align="left">Vector:+</td><td align="right">2</td><td align="right">15</td><td align="right">99</td><td align="right">410</td><td align="right">1,730</td><td align="right">7,000</td><td align="right">28,600</td><td align="right">324,000</td><td align="right">1,498,000</td><td align="right">7,140,000</td><td align="right">31,700,000</td><td align="right">131,000,000</td></tr><tr><td align="left">Set+</td><td align="right">1</td><td align="right">12</td><td align="right">58</td><td align="right">1,860</td><td align="right">8,530</td><td align="right">37,400</td><td align="right">166,000</td><td align="right">783,000</td><td align="right">3,600,000</td><td align="right">18,100,000</td><td align="right">94,000,000</td><td align="right">473,000,000</td></tr><tr><td align="left">Map+</td><td align="right">1</td><td align="right">6</td><td align="right">95</td><td align="right">2,100</td><td align="right">9,010</td><td align="right">38,900</td><td align="right">171,000</td><td align="right">810,000</td><td align="right">3,710,000</td><td align="right">18,400,000</td><td align="right">96,000,000</td><td align="right">499,000,000</td></tr><tr><td align="left">Array.toSet</td><td align="right">73</td><td align="right">75</td><td align="right">187</td><td align="right">2,140</td><td align="right">9,220</td><td align="right">40,000</td><td align="right">174,000</td><td align="right">833,000</td><td align="right">3,800,000</td><td align="right">19,300,000</td><td align="right">101,000,000</td><td align="right">506,000,000</td></tr><tr><td align="left">Array.toMap</td><td align="right">21</td><td align="right">31</td><td align="right">104</td><td align="right">2,100</td><td align="right">9,200</td><td align="right">39,500</td><td align="right">173,000</td><td align="right">820,000</td><td align="right">3,790,000</td><td align="right">19,500,000</td><td align="right">104,000,000</td><td align="right">540,000,000</td></tr><tr><td align="left">Array.toVector</td><td align="right">95</td><td align="right">109</td><td align="right">143</td><td align="right">287</td><td align="right">903</td><td align="right">3,310</td><td align="right">12,850</td><td align="right">51,100</td><td align="right">203,800</td><td align="right">821,000</td><td align="right">3,270,000</td><td align="right">13,300,000</td></tr><tr><td align="left">m.Buffer</td><td align="right">19</td><td align="right">30</td><td align="right">58</td><td align="right">174</td><td align="right">691</td><td align="right">2,690</td><td align="right">10,840</td><td align="right">43,000</td><td align="right">169,800</td><td align="right">687,000</td><td align="right">2,770,000</td><td align="right">11,790,000</td></tr><tr><td align="left">m.Map.put</td><td align="right">6</td><td align="right">79</td><td align="right">297</td><td align="right">1,420</td><td align="right">6,200</td><td align="right">25,500</td><td align="right">103,000</td><td align="right">414,000</td><td align="right">1,820,000</td><td align="right">8,100,000</td><td align="right">57,000,000</td><td align="right">348,000,000</td></tr><tr><td align="left">m.Set.add</td><td align="right">13</td><td align="right">76</td><td align="right">276</td><td align="right">1,430</td><td align="right">6,700</td><td align="right">27,900</td><td align="right">113,000</td><td align="right">455,000</td><td align="right">1,840,000</td><td align="right">7,900,000</td><td align="right">39,000,000</td><td align="right">267,000,000</td></tr></tbody></table>

<p>上面的表格显示的构建集合的性能,一次添加一个数据。使用 <code>::</code> for Lists, <code>:+</code> for Vectors, <code>.add</code> 或 <code>.append</code> 或 <code>.put</code> for the mutable collections. Array有两个benchmark: 一个使用 <code>:+</code>, 一个使用预先分配大小的数组，然后使用一个 while-loop 添加元素。</p>
<table class="table table-bordered"><tbody><tr><td align="left"><strong>construct</strong></td><td align="right"><strong>0</strong></td><td align="right"><strong>1</strong></td><td align="right"><strong>4</strong></td><td align="right"><strong>16</strong></td><td align="right"><strong>64</strong></td><td align="right"><strong>256</strong></td><td align="right"><strong>1,024</strong></td><td align="right"><strong>4,096</strong></td><td align="right"><strong>16,192</strong></td><td align="right"><strong>65,536</strong></td><td align="right"><strong>262,144</strong></td><td align="right"><strong>1,048,576</strong></td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left">List::</td><td align="right">1</td><td align="right">4</td><td align="right">12</td><td align="right">69</td><td align="right">301</td><td align="right">1,220</td><td align="right">4,900</td><td align="right">19,800</td><td align="right">79,000</td><td align="right">329,000</td><td align="right">1,510,000</td><td align="right">9,100,000</td></tr><tr><td align="left">Vector:+</td><td align="right">2</td><td align="right">15</td><td align="right">99</td><td align="right">410</td><td align="right">1,730</td><td align="right">7,000</td><td align="right">28,600</td><td align="right">324,000</td><td align="right">1,498,000</td><td align="right">7,140,000</td><td align="right">31,700,000</td><td align="right">131,000,000</td></tr></tbody></table>

<p>它显示构建一个Vector要比构建List慢5到15倍，具体和集合大小有关。</p>
<p>这也许不令人惊讶。增加一个元素到链表中非常简单，但是这个数量接让我震惊。如果你是一个一个的添加元素到集合中，使用List要比Vector快很多。如果你的代码中构建一个Vector变成了瓶颈，那么你应该考虑使用List或者Buffer来替换它。</p>
<table class="table table-bordered"><tbody><tr><td align="left"><strong>construct</strong></td><td align="right"><strong>0</strong></td><td align="right"><strong>1</strong></td><td align="right"><strong>4</strong></td><td align="right"><strong>16</strong></td><td align="right"><strong>64</strong></td><td align="right"><strong>256</strong></td><td align="right"><strong>1,024</strong></td><td align="right"><strong>4,096</strong></td><td align="right"><strong>16,192</strong></td><td align="right"><strong>65,536</strong></td><td align="right"><strong>262,144</strong></td><td align="right"><strong>1,048,576</strong></td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left">List::</td><td align="right">1</td><td align="right">4</td><td align="right">12</td><td align="right">69</td><td align="right">301</td><td align="right">1,220</td><td align="right">4,900</td><td align="right">19,800</td><td align="right">79,000</td><td align="right">329,000</td><td align="right">1,510,000</td><td align="right">9,100,000</td></tr><tr><td align="left">m.Buffer</td><td align="right">19</td><td align="right">30</td><td align="right">58</td><td align="right">174</td><td align="right">691</td><td align="right">2,690</td><td align="right">10,840</td><td align="right">43,000</td><td align="right">169,800</td><td align="right">687,000</td><td align="right">2,770,000</td><td align="right">11,790,000</td></tr></tbody></table>

<p>使用<code>.append</code>构建一个<code>mutable.Buffer</code>看起来要比使用<code>::</code>构建<code>List</code>要慢2 ~ 3倍，尽管对于大下降到1.5倍慢。我有点惊讶，这意味着如果你想更快，List是一个更好的选择。</p>
<table class="table table-bordered"><tbody><tr><td align="left"><strong>construct</strong></td><td align="right"><strong>0</strong></td><td align="right"><strong>1</strong></td><td align="right"><strong>4</strong></td><td align="right"><strong>16</strong></td><td align="right"><strong>64</strong></td><td align="right"><strong>256</strong></td><td align="right"><strong>1,024</strong></td><td align="right"><strong>4,096</strong></td><td align="right"><strong>16,192</strong></td><td align="right"><strong>65,536</strong></td><td align="right"><strong>262,144</strong></td><td align="right"><strong>1,048,576</strong></td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left">Array-prealloc</td><td align="right">17</td><td align="right">10</td><td align="right">14</td><td align="right">41</td><td align="right">186</td><td align="right">710</td><td align="right">2,710</td><td align="right">11,000</td><td align="right">45,100</td><td align="right">183,000</td><td align="right">730,000</td><td align="right">3,100,000</td></tr><tr><td align="left">List::</td><td align="right">1</td><td align="right">4</td><td align="right">12</td><td align="right">69</td><td align="right">301</td><td align="right">1,220</td><td align="right">4,900</td><td align="right">19,800</td><td align="right">79,000</td><td align="right">329,000</td><td align="right">1,510,000</td><td align="right">9,100,000</td></tr><tr><td align="left">m.Buffer</td><td align="right">19</td><td align="right">30</td><td align="right">58</td><td align="right">174</td><td align="right">691</td><td align="right">2,690</td><td align="right">10,840</td><td align="right">43,000</td><td align="right">169,800</td><td align="right">687,000</td><td align="right">2,770,000</td><td align="right">11,790,000</td></tr></tbody></table>

<p>最快的是预分配内存的数组，大约比构建List快4倍，比构建mutable.Buffer快5倍，比构建Vector快15倍。</p>
<table class="table table-bordered"><tbody><tr><td align="left"><strong>construct</strong></td><td align="right"><strong>0</strong></td><td align="right"><strong>1</strong></td><td align="right"><strong>4</strong></td><td align="right"><strong>16</strong></td><td align="right"><strong>64</strong></td><td align="right"><strong>256</strong></td><td align="right"><strong>1,024</strong></td><td align="right"><strong>4,096</strong></td><td align="right"><strong>16,192</strong></td><td align="right"><strong>65,536</strong></td><td align="right"><strong>262,144</strong></td><td align="right"><strong>1,048,576</strong></td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left">Array-prealloc</td><td align="right">17</td><td align="right">10</td><td align="right">14</td><td align="right">41</td><td align="right">186</td><td align="right">710</td><td align="right">2,710</td><td align="right">11,000</td><td align="right">45,100</td><td align="right">183,000</td><td align="right">730,000</td><td align="right">3,100,000</td></tr><tr><td align="left">Array:+</td><td align="right">2</td><td align="right">12</td><td align="right">58</td><td align="right">270</td><td align="right">1,460</td><td align="right">19,800</td><td align="right">260,000</td><td align="right">3,170,000</td><td align="right">60,000,000</td><td align="right">1,020,000,000</td><td align="right"></td><td align="right"></td></tr></tbody></table>

<p>使用<code>:+</code>构建数组需要花费双倍的时间，因为它每次都要复制整个数组：当数组还小的时候还好，但是数组长度变大的时候就很慢了，当元素的数量到了上万个的时候时间花费变得不可思议的长了。</p>
<table class="table table-bordered"><tbody><tr><td align="left"><strong>construct</strong></td><td align="right"><strong>0</strong></td><td align="right"><strong>1</strong></td><td align="right"><strong>4</strong></td><td align="right"><strong>16</strong></td><td align="right"><strong>64</strong></td><td align="right"><strong>256</strong></td><td align="right"><strong>1,024</strong></td><td align="right"><strong>4,096</strong></td><td align="right"><strong>16,192</strong></td><td align="right"><strong>65,536</strong></td><td align="right"><strong>262,144</strong></td><td align="right"><strong>1,048,576</strong></td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left">Array-prealloc</td><td align="right">17</td><td align="right">10</td><td align="right">14</td><td align="right">41</td><td align="right">186</td><td align="right">710</td><td align="right">2,710</td><td align="right">11,000</td><td align="right">45,100</td><td align="right">183,000</td><td align="right">730,000</td><td align="right">3,100,000</td></tr><tr><td align="left">Set+</td><td align="right">1</td><td align="right">12</td><td align="right">58</td><td align="right">1,860</td><td align="right">8,530</td><td align="right">37,400</td><td align="right">166,000</td><td align="right">783,000</td><td align="right">3,600,000</td><td align="right">18,100,000</td><td align="right">94,000,000</td><td align="right">473,000,000</td></tr><tr><td align="left">Map+</td><td align="right">1</td><td align="right">6</td><td align="right">95</td><td align="right">2,100</td><td align="right">9,010</td><td align="right">38,900</td><td align="right">171,000</td><td align="right">810,000</td><td align="right">3,710,000</td><td align="right">18,400,000</td><td align="right">96,000,000</td><td align="right">499,000,000</td></tr><tr><td align="left">Array.toSet</td><td align="right">73</td><td align="right">75</td><td align="right">187</td><td align="right">2,140</td><td align="right">9,220</td><td align="right">40,000</td><td align="right">174,000</td><td align="right">833,000</td><td align="right">3,800,000</td><td align="right">19,300,000</td><td align="right">101,000,000</td><td align="right">506,000,000</td></tr><tr><td align="left">Array.toMap</td><td align="right">21</td><td align="right">31</td><td align="right">104</td><td align="right">2,100</td><td align="right">9,200</td><td align="right">39,500</td><td align="right">173,000</td><td align="right">820,000</td><td align="right">3,790,000</td><td align="right">19,500,000</td><td align="right">104,000,000</td><td align="right">540,000,000</td></tr></tbody></table>

<p>一个个添加元素的方式构建<code>Set</code> 和 <code>Map</code>变得很慢： 比构建List慢30倍，比预分配大小的数组慢150倍。这大概是因为Set和Map需要构建Hash或者做类似检查来维持一致性。</p>
<p>Set和Map慢是在意料之中，意料之外的是居然这么慢。这意味着如果你想要代码更快，你不应该使用Set或者Map， 除非你必需它们的唯一性这个性质，否则使用List或者mutable.Buffer。</p>
<p>预分配的数组调用<code>.toSet</code> 或 <code>.toMap</code>方法并不会直接构造Set和Map更快。而调用<code>toVector</code>却可以更快。</p>
<table class="table table-bordered"><tbody><tr><td align="left"><strong>construct</strong></td><td align="right"><strong>0</strong></td><td align="right"><strong>1</strong></td><td align="right"><strong>4</strong></td><td align="right"><strong>16</strong></td><td align="right"><strong>64</strong></td><td align="right"><strong>256</strong></td><td align="right"><strong>1,024</strong></td><td align="right"><strong>4,096</strong></td><td align="right"><strong>16,192</strong></td><td align="right"><strong>65,536</strong></td><td align="right"><strong>262,144</strong></td><td align="right"><strong>1,048,576</strong></td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left">Array-prealloc</td><td align="right">17</td><td align="right">10</td><td align="right">14</td><td align="right">41</td><td align="right">186</td><td align="right">710</td><td align="right">2,710</td><td align="right">11,000</td><td align="right">45,100</td><td align="right">183,000</td><td align="right">730,000</td><td align="right">3,100,000</td></tr><tr><td align="left">List::</td><td align="right">1</td><td align="right">4</td><td align="right">12</td><td align="right">69</td><td align="right">301</td><td align="right">1,220</td><td align="right">4,900</td><td align="right">19,800</td><td align="right">79,000</td><td align="right">329,000</td><td align="right">1,510,000</td><td align="right">9,100,000</td></tr><tr><td align="left">Vector:+</td><td align="right">2</td><td align="right">15</td><td align="right">99</td><td align="right">410</td><td align="right">1,730</td><td align="right">7,000</td><td align="right">28,600</td><td align="right">324,000</td><td align="right">1,498,000</td><td align="right">7,140,000</td><td align="right">31,700,000</td><td align="right">131,000,000</td></tr><tr><td align="left">Array.toVector</td><td align="right">95</td><td align="right">109</td><td align="right">143</td><td align="right">287</td><td align="right">903</td><td align="right">3,310</td><td align="right">12,850</td><td align="right">51,100</td><td align="right">203,800</td><td align="right">821,000</td><td align="right">3,270,000</td><td align="right">13,300,000</td></tr></tbody></table>

<p>上表表明，通过预分配数组，填充元素，然后再调用<code>.toVector</code>方法可以更快的构建Vector，会比直接构建Vector快10倍。这里没有列出的benchmark表明，先构建mutable.Buffer然后调用 <code>.toVector</code> 方法也比直接构建Vector快。</p>
<h3 id="Deconstruction_Performance">Deconstruction Performance</h3>
<table class="table table-bordered"><tbody><tr><td align="left"><strong>deconstruct</strong></td><td align="right"><strong>0</strong></td><td align="right"><strong>1</strong></td><td align="right"><strong>4</strong></td><td align="right"><strong>16</strong></td><td align="right"><strong>64</strong></td><td align="right"><strong>256</strong></td><td align="right"><strong>1,024</strong></td><td align="right"><strong>4,096</strong></td><td align="right"><strong>16,192</strong></td><td align="right"><strong>65,536</strong></td><td align="right"><strong>262,144</strong></td><td align="right"><strong>1,048,576</strong></td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left">Array.tail</td><td align="right">7</td><td align="right">26</td><td align="right">114</td><td align="right">582</td><td align="right">4,517</td><td align="right">55,500</td><td align="right">821,000</td><td align="right">12,140,000</td><td align="right">188,000,000</td><td align="right">3,100,000,000</td><td align="right"></td><td align="right"></td></tr><tr><td align="left">List.tail</td><td align="right">2</td><td align="right">2</td><td align="right">7</td><td align="right">21</td><td align="right">100</td><td align="right">420</td><td align="right">2,100</td><td align="right">10,000</td><td align="right">35,000</td><td align="right">120,000</td><td align="right">540,000</td><td align="right">1,500,000</td></tr><tr><td align="left">Vector.tail</td><td align="right">3</td><td align="right">6</td><td align="right">90</td><td align="right">425</td><td align="right">1,970</td><td align="right">11,800</td><td align="right">58,400</td><td align="right">500,000</td><td align="right">2,390,000</td><td align="right">11,000,000</td><td align="right">50,200,000</td><td align="right">211,000,000</td></tr><tr><td align="left">Vector.init</td><td align="right">2</td><td align="right">5</td><td align="right">103</td><td align="right">483</td><td align="right">2,490</td><td align="right">12,800</td><td align="right">64,000</td><td align="right">543,000</td><td align="right">2,470,000</td><td align="right">11,900,000</td><td align="right">52,600,000</td><td align="right">218,000,000</td></tr><tr><td align="left">Set.-</td><td align="right">8</td><td align="right">30</td><td align="right">162</td><td align="right">1,480</td><td align="right">7,700</td><td align="right">34,200</td><td align="right">164,000</td><td align="right">770,000</td><td align="right">3,660,000</td><td align="right">20,300,000</td><td align="right">94,000,000</td><td align="right">420,000,000</td></tr><tr><td align="left">Map.-</td><td align="right">12</td><td align="right">52</td><td align="right">201</td><td align="right">1,430</td><td align="right">7,660</td><td align="right">34,900</td><td align="right">169,000</td><td align="right">810,000</td><td align="right">3,990,000</td><td align="right">24,000,000</td><td align="right">103,000,000</td><td align="right">470,000,000</td></tr><tr><td align="left">m.Buffer</td><td align="right">6</td><td align="right">8</td><td align="right">14</td><td align="right">43</td><td align="right">166</td><td align="right">630</td><td align="right">2,510</td><td align="right">10,000</td><td align="right">40,600</td><td align="right">167,000</td><td align="right">660,000</td><td align="right">2,490,000</td></tr><tr><td align="left">m.Set</td><td align="right">5</td><td align="right">28</td><td align="right">130</td><td align="right">671</td><td align="right">4,900</td><td align="right">54,000</td><td align="right">770,000</td><td align="right">11,990,000</td><td align="right">189,000,000</td><td align="right">3,040,000,000</td><td align="right"></td><td align="right"></td></tr><tr><td align="left">m.Map</td><td align="right">7</td><td align="right">44</td><td align="right">172</td><td align="right">670</td><td align="right">3,650</td><td align="right">26,400</td><td align="right">282,000</td><td align="right">3,970,000</td><td align="right">62,600,000</td><td align="right">1,000,000,000</td><td align="right"></td><td align="right"></td></tr></tbody></table>

<p><code>mutable.Buffer</code> 和 <code>List</code> 是最快的移除元素操作的集合。这很合理，因为从mutable.Buffer移除元素只是改变它的size。从List的头部移除元素只是得到它的<code>.tail</code>，不需要做数据结构的改变。</p>
<table class="table table-bordered"><tbody><tr><td align="left"><strong>construct</strong></td><td align="right"><strong>0</strong></td><td align="right"><strong>1</strong></td><td align="right"><strong>4</strong></td><td align="right"><strong>16</strong></td><td align="right"><strong>64</strong></td><td align="right"><strong>256</strong></td><td align="right"><strong>1,024</strong></td><td align="right"><strong>4,096</strong></td><td align="right"><strong>16,192</strong></td><td align="right"><strong>65,536</strong></td><td align="right"><strong>262,144</strong></td><td align="right"><strong>1,048,576</strong></td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left">Vector:+</td><td align="right">2</td><td align="right">15</td><td align="right">99</td><td align="right">410</td><td align="right">1,730</td><td align="right">7,000</td><td align="right">28,600</td><td align="right">324,000</td><td align="right">1,498,000</td><td align="right">7,140,000</td><td align="right">31,700,000</td><td align="right">131,000,000</td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left"><strong>deconstruct</strong></td><td align="right"><strong>0</strong></td><td align="right"><strong>1</strong></td><td align="right"><strong>4</strong></td><td align="right"><strong>16</strong></td><td align="right"><strong>64</strong></td><td align="right"><strong>256</strong></td><td align="right"><strong>1,024</strong></td><td align="right"><strong>4,096</strong></td><td align="right"><strong>16,192</strong></td><td align="right"><strong>65,536</strong></td><td align="right"><strong>262,144</strong></td><td align="right"><strong>1,048,576</strong></td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left">Vector.tail</td><td align="right">3</td><td align="right">6</td><td align="right">90</td><td align="right">425</td><td align="right">1,970</td><td align="right">11,800</td><td align="right">58,400</td><td align="right">500,000</td><td align="right">2,390,000</td><td align="right">11,000,000</td><td align="right">50,200,000</td><td align="right">211,000,000</td></tr><tr><td align="left">Vector.init</td><td align="right">2</td><td align="right">5</td><td align="right">103</td><td align="right">483</td><td align="right">2,490</td><td align="right">12,800</td><td align="right">64,000</td><td align="right">543,000</td><td align="right">2,470,000</td><td align="right">11,900,000</td><td align="right">52,600,000</td><td align="right">218,000,000</td></tr></tbody></table>

<p>使用<code>.tail</code>或<code>.init</code>从Vector移除元素更慢，要比<code>:+</code>增加一个元素慢50%。</p>
<table class="table table-bordered"><tbody><tr><td align="left"><strong>deconstruct</strong></td><td align="right"><strong>0</strong></td><td align="right"><strong>1</strong></td><td align="right"><strong>4</strong></td><td align="right"><strong>16</strong></td><td align="right"><strong>64</strong></td><td align="right"><strong>256</strong></td><td align="right"><strong>1,024</strong></td><td align="right"><strong>4,096</strong></td><td align="right"><strong>16,192</strong></td><td align="right"><strong>65,536</strong></td><td align="right"><strong>262,144</strong></td><td align="right"><strong>1,048,576</strong></td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left">List.tail</td><td align="right">2</td><td align="right">2</td><td align="right">7</td><td align="right">21</td><td align="right">100</td><td align="right">420</td><td align="right">2,100</td><td align="right">10,000</td><td align="right">35,000</td><td align="right">120,000</td><td align="right">540,000</td><td align="right">1,500,000</td></tr><tr><td align="left">Vector.tail</td><td align="right">3</td><td align="right">6</td><td align="right">90</td><td align="right">425</td><td align="right">1,970</td><td align="right">11,800</td><td align="right">58,400</td><td align="right">500,000</td><td align="right">2,390,000</td><td align="right">11,000,000</td><td align="right">50,200,000</td><td align="right">211,000,000</td></tr><tr><td align="left">Set.-</td><td align="right">8</td><td align="right">30</td><td align="right">162</td><td align="right">1,480</td><td align="right">7,700</td><td align="right">34,200</td><td align="right">164,000</td><td align="right">770,000</td><td align="right">3,660,000</td><td align="right">20,300,000</td><td align="right">94,000,000</td><td align="right">420,000,000</td></tr><tr><td align="left">Map.-</td><td align="right">12</td><td align="right">52</td><td align="right">201</td><td align="right">1,430</td><td align="right">7,660</td><td align="right">34,900</td><td align="right">169,000</td><td align="right">810,000</td><td align="right">3,990,000</td><td align="right">24,000,000</td><td align="right">103,000,000</td><td align="right">470,000,000</td></tr><tr><td align="left">m.Set</td><td align="right">5</td><td align="right">28</td><td align="right">130</td><td align="right">671</td><td align="right">4,900</td><td align="right">54,000</td><td align="right">770,000</td><td align="right">11,990,000</td><td align="right">189,000,000</td><td align="right">3,040,000,000</td><td align="right"></td><td align="right"></td></tr><tr><td align="left">m.Map</td><td align="right">7</td><td align="right">44</td><td align="right">172</td><td align="right">670</td><td align="right">3,650</td><td align="right">26,400</td><td align="right">282,000</td><td align="right">3,970,000</td><td align="right">62,600,000</td><td align="right">1,000,000,000</td><td align="right"></td><td align="right"></td></tr></tbody></table>

<p>因为某种原因，重复地从<code>Map</code>和<code>Set</code>移除<code>.head</code>也很慢，从<code>mutable.Map</code>和<code>mutable.Set</code>移除元素更慢。我不知道为什么出现这种现象。</p>
<h3 id="Concatenation_Performance">Concatenation Performance</h3>
<table class="table table-bordered"><tbody><tr><td align="left"><strong>concat</strong></td><td align="right"><strong>0</strong></td><td align="right"><strong>1</strong></td><td align="right"><strong>4</strong></td><td align="right"><strong>16</strong></td><td align="right"><strong>64</strong></td><td align="right"><strong>256</strong></td><td align="right"><strong>1,024</strong></td><td align="right"><strong>4,096</strong></td><td align="right"><strong>16,192</strong></td><td align="right"><strong>65,536</strong></td><td align="right"><strong>262,144</strong></td><td align="right"><strong>1,048,576</strong></td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left">Array++</td><td align="right">89</td><td align="right">83</td><td align="right">85</td><td align="right">91</td><td align="right">144</td><td align="right">330</td><td align="right">970</td><td align="right">4,100</td><td align="right">17,000</td><td align="right">70,000</td><td align="right">380,000</td><td align="right">1,700,000</td></tr><tr><td align="left">arraycopy</td><td align="right">23</td><td align="right">18</td><td align="right">20</td><td align="right">27</td><td align="right">48</td><td align="right">280</td><td align="right">1,000</td><td align="right">4,000</td><td align="right">16,000</td><td align="right">65,000</td><td align="right">360,000</td><td align="right">1,400,000</td></tr><tr><td align="left">List</td><td align="right">7</td><td align="right">81</td><td align="right">162</td><td align="right">434</td><td align="right">1,490</td><td align="right">5,790</td><td align="right">23,200</td><td align="right">92,500</td><td align="right">370,000</td><td align="right">1,510,000</td><td align="right">6,300,000</td><td align="right">30,000,000</td></tr><tr><td align="left">Vector</td><td align="right">5</td><td align="right">48</td><td align="right">188</td><td align="right">327</td><td align="right">940</td><td align="right">3,240</td><td align="right">12,700</td><td align="right">52,000</td><td align="right">210,000</td><td align="right">810,000</td><td align="right">3,370,000</td><td align="right">14,500,000</td></tr><tr><td align="left">Set</td><td align="right">91</td><td align="right">95</td><td align="right">877</td><td align="right">1,130</td><td align="right">5,900</td><td align="right">26,900</td><td align="right">149,000</td><td align="right">680,000</td><td align="right">3,600,000</td><td align="right">23,000,000</td><td align="right">100,000,000</td><td align="right">280,000,000</td></tr><tr><td align="left">Map</td><td align="right">54</td><td align="right">53</td><td align="right">967</td><td align="right">1,480</td><td align="right">6,900</td><td align="right">31,500</td><td align="right">166,000</td><td align="right">760,000</td><td align="right">4,100,000</td><td align="right">27,000,000</td><td align="right">118,000,000</td><td align="right">450,000,000</td></tr><tr><td align="left">m.Buffer</td><td align="right">11</td><td align="right">32</td><td align="right">32</td><td align="right">38</td><td align="right">70</td><td align="right">250</td><td align="right">700</td><td align="right">3,900</td><td align="right">20,000</td><td align="right">40,000</td><td align="right">400,000</td><td align="right">1,500,000</td></tr><tr><td align="left">m.Set</td><td align="right">58</td><td align="right">81</td><td align="right">142</td><td align="right">1,080</td><td align="right">4,200</td><td align="right">16,000</td><td align="right">69,000</td><td align="right">263,000</td><td align="right">1,160,000</td><td align="right">6,300,000</td><td align="right">43,000,000</td><td align="right">310,000,000</td></tr><tr><td align="left">m.Map</td><td align="right">47</td><td align="right">69</td><td align="right">181</td><td align="right">990</td><td align="right">3,700</td><td align="right">15,000</td><td align="right">62,000</td><td align="right">290,000</td><td align="right">1,500,000</td><td align="right">16,000,000</td><td align="right">103,000,000</td><td align="right">493,000,000</td></tr></tbody></table>

<p>连接集合最快的是<code>mutable.Buffers</code>和普通的数组，因为它们只是简单的复制元素到一个新的集合中。 <code>mutable.Buffer</code>内部使用一个数组，所以它需要重新分配更大的数组来复制数据，而数组则是将两个输入数组复制到一个更大的数组中。你使用 <code>Array ++ Array</code>还是<code>System.arraycopy</code>并不重要。 </p>
<p>It turns out that while the clever algorithms and structural-sharing and what not that go into Scala&#39;s immutable Vectors and Sets make it faster to build things up incrementally element-by-element (as seen in the Construction Performance benchmark), for this kind of bulk-concatenation it&#39;s still faster just to copy everything manually into a new array and skip all the fancy data-structure stuff.</p>
<p>尽管<code>Vector</code>和<code>List</code>的连接要比<code>mutable.Buffer</code>或<code>Array</code>要慢，<code>Vector</code>的连接却比List的连接要快一倍。</p>
<p><code>Set</code>和<code>Map</code>还是很慢，比<code>Vector</code>或<code>List</code>要慢10倍，比<code>Array</code>或<code>mutable.Buffer</code>慢100倍。</p>
<h3 id="Foreach_Performance">Foreach Performance</h3>
<table class="table table-bordered"><tbody><tr><td align="left"><strong>foreach</strong></td><td align="right"><strong>0</strong></td><td align="right"><strong>1</strong></td><td align="right"><strong>4</strong></td><td align="right"><strong>16</strong></td><td align="right"><strong>64</strong></td><td align="right"><strong>256</strong></td><td align="right"><strong>1,024</strong></td><td align="right"><strong>4,096</strong></td><td align="right"><strong>16,192</strong></td><td align="right"><strong>65,536</strong></td><td align="right"><strong>262,144</strong></td><td align="right"><strong>1,048,576</strong></td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left">Array</td><td align="right">2</td><td align="right">5</td><td align="right">15</td><td align="right">57</td><td align="right">230</td><td align="right">900</td><td align="right">3,580</td><td align="right">14,200</td><td align="right">55,600</td><td align="right">228,000</td><td align="right">910,000</td><td align="right">3,610,000</td></tr><tr><td align="left">Array-while</td><td align="right">0</td><td align="right">1</td><td align="right">0</td><td align="right">1</td><td align="right">0</td><td align="right">0</td><td align="right">0</td><td align="right">-4</td><td align="right">10</td><td align="right">70</td><td align="right">0</td><td align="right">500</td></tr><tr><td align="left">List</td><td align="right">0</td><td align="right">3</td><td align="right">13</td><td align="right">50</td><td align="right">209</td><td align="right">800</td><td align="right">3,500</td><td align="right">14,100</td><td align="right">55,000</td><td align="right">231,000</td><td align="right">920,000</td><td align="right">3,800,000</td></tr><tr><td align="left">List-while</td><td align="right">4</td><td align="right">5</td><td align="right">13</td><td align="right">49</td><td align="right">211</td><td align="right">812</td><td align="right">3,400</td><td align="right">14,200</td><td align="right">57,000</td><td align="right">226,000</td><td align="right">930,000</td><td align="right">3,700,000</td></tr><tr><td align="left">Vector</td><td align="right">15</td><td align="right">19</td><td align="right">30</td><td align="right">74</td><td align="right">268</td><td align="right">1,000</td><td align="right">3,960</td><td align="right">16,200</td><td align="right">62,000</td><td align="right">256,000</td><td align="right">1,030,000</td><td align="right">4,300,000</td></tr><tr><td align="left">Set</td><td align="right">4</td><td align="right">5</td><td align="right">10</td><td align="right">99</td><td align="right">420</td><td align="right">1,560</td><td align="right">10,200</td><td align="right">51,000</td><td align="right">217,000</td><td align="right">2,200,000</td><td align="right">10,800,000</td><td align="right">48,600,000</td></tr><tr><td align="left">Map</td><td align="right">19</td><td align="right">7</td><td align="right">20</td><td align="right">140</td><td align="right">610</td><td align="right">2,500</td><td align="right">13,900</td><td align="right">72,800</td><td align="right">360,000</td><td align="right">3,700,000</td><td align="right">20,700,000</td><td align="right">75,000,000</td></tr><tr><td align="left">m.Buffer</td><td align="right">0</td><td align="right">1</td><td align="right">1</td><td align="right">1</td><td align="right">1</td><td align="right">0</td><td align="right">1</td><td align="right">2</td><td align="right">-1</td><td align="right">-10</td><td align="right">0</td><td align="right">-200</td></tr><tr><td align="left">m.Set</td><td align="right">19</td><td align="right">26</td><td align="right">50</td><td align="right">130</td><td align="right">508</td><td align="right">2,190</td><td align="right">11,900</td><td align="right">56,600</td><td align="right">235,000</td><td align="right">940,000</td><td align="right">3,800,000</td><td align="right">14,700,000</td></tr><tr><td align="left">m.Map</td><td align="right">8</td><td align="right">16</td><td align="right">48</td><td align="right">146</td><td align="right">528</td><td align="right">2,210</td><td align="right">10,300</td><td align="right">54,100</td><td align="right">255,000</td><td align="right">1,140,000</td><td align="right">6,800,000</td><td align="right">30,000,000</td></tr></tbody></table>

<p>迭代大部分常用的集合都很快，无论集合是<code>List</code>、<code>Vector</code>还是<code>Array</code>。使用<code>while-loop</code>和<code>head/tail</code>的速度是一样的，所以如果你想手写迭代来提高性能，结果可能没什么区别。</p>
<p>另一方面，相比迭代数组或者<code>Vector</code>，迭代<code>Set</code>和<code>Map</code>要慢10～15倍。可变的<code>Set</code>和<code>Map</code>要好一点，值慢了3～8倍。</p>
<p>使用<code>while-loop</code>迭代数组是最快的，基本上快的连噪点都测量不出来。但是迭代<code>mutable.Buffer</code>并没有显著的提升，不清楚为什么这样。</p>
<h3 id="Lookup_Performance">Lookup Performance</h3>
<table class="table table-bordered"><tbody><tr><td align="left"><strong>lookup</strong></td><td align="right"><strong>0</strong></td><td align="right"><strong>1</strong></td><td align="right"><strong>4</strong></td><td align="right"><strong>16</strong></td><td align="right"><strong>64</strong></td><td align="right"><strong>256</strong></td><td align="right"><strong>1,024</strong></td><td align="right"><strong>4,096</strong></td><td align="right"><strong>16,192</strong></td><td align="right"><strong>65,536</strong></td><td align="right"><strong>262,144</strong></td><td align="right"><strong>1,048,576</strong></td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left">Array</td><td align="right">0</td><td align="right">1</td><td align="right">1</td><td align="right">1</td><td align="right">0</td><td align="right">0</td><td align="right">1</td><td align="right">-1</td><td align="right">4</td><td align="right">0</td><td align="right">100</td><td align="right">-200</td></tr><tr><td align="left">List</td><td align="right">0</td><td align="right">1</td><td align="right">8</td><td align="right">103</td><td align="right">2,390</td><td align="right">47,200</td><td align="right">870,000</td><td align="right">16,900,000</td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left">Vector</td><td align="right">0</td><td align="right">1</td><td align="right">5</td><td align="right">17</td><td align="right">104</td><td align="right">440</td><td align="right">1,780</td><td align="right">8,940</td><td align="right">38,000</td><td align="right">198,000</td><td align="right">930,000</td><td align="right">4,260,000</td></tr><tr><td align="left">Set</td><td align="right">0</td><td align="right">18</td><td align="right">81</td><td align="right">507</td><td align="right">1,980</td><td align="right">7,800</td><td align="right">39,800</td><td align="right">203,000</td><td align="right">1,040,000</td><td align="right">8,300,000</td><td align="right"></td><td align="right"></td></tr><tr><td align="left">Map</td><td align="right">0</td><td align="right">12</td><td align="right">97</td><td align="right">578</td><td align="right">2,250</td><td align="right">9,400</td><td align="right">46,000</td><td align="right">233,000</td><td align="right">1,150,000</td><td align="right">11,400,000</td><td align="right"></td><td align="right"></td></tr><tr><td align="left">m.Buffer</td><td align="right">0</td><td align="right">1</td><td align="right">1</td><td align="right">1</td><td align="right">1</td><td align="right">1</td><td align="right">1</td><td align="right">0</td><td align="right">6</td><td align="right">-10</td><td align="right">0</td><td align="right">0</td></tr><tr><td align="left">m.Set</td><td align="right">0</td><td align="right">5</td><td align="right">22</td><td align="right">97</td><td align="right">410</td><td align="right">1,690</td><td align="right">7,100</td><td align="right">31,300</td><td align="right">148,000</td><td align="right">690,000</td><td align="right">4,800,000</td><td align="right"></td></tr><tr><td align="left">m.Map</td><td align="right">0</td><td align="right">6</td><td align="right">25</td><td align="right">112</td><td align="right">454</td><td align="right">1,910</td><td align="right">9,400</td><td align="right">52,500</td><td align="right">243,000</td><td align="right">1,760,000</td><td align="right">9,900,000</td><td align="right"></td></tr></tbody></table>

<p>我们看到数组和<code>mutable.Buffer</code>的lookup非常快，以至于无法测到噪点。下一个快的集合是索引的<code>Vector</code>的lookup,它会使用较少的时间，例如，在一百万的元素中查找一个元素需要4毫秒：在大部分的情况下这并不明显，但是如果累加起来时间就很客观了，例如在实时的游戏中就对时间要求很高。</p>
<p>注意这个时间是在集合中查找每一个元素，而不是查找某一个元素。所以我们希望用大的集合来花费更多的时间来完成性能测试，即使时间花费是一个常量。</p>
<p>不可变的Set和Map比Vector要花费非常长的时间执行查找。不可变的Set会花费10～20倍的时间，而Map要花费10～40倍的时间。</p>
<p>而可变Set和Map查找的性能要比不可变的Set和Map要好。可变Set的查找的时间要比Vector慢4～5倍，而可变Map要比Vector的查找慢5～10倍。可以看到可变Set和Map要比不可变Set和Map快2～4倍，这可能是因为这些集合的可变版本使用hash表而这些不可变集合使用tree。</p>
<p>List lookups by index across the entire list is, as expected, quadratic in time: Each individual lookup takes time linear in the size of the collection, and there are a linear number of lookups to perform in this benchmark. While it&#39;s reasonable up to about 16 elements, it quickly blows up after that.</p>
<h2 id="测试结论">测试结论</h2>
<p>我们已经看到了很多数据，也比较了一些集合的数据。对于天天使用Scala的程序员，这些数据有什么意义呢？下面列出了一些有趣的结论。</p>
<h3 id="数组超级好">数组超级好</h3>
<p>一个未装箱的基本类型的数组只要装箱的数组的内存的1/4或者1/5，例如 <code>Array[Int]</code>vs <code>Array[java.lang.Integer]</code>。这不简单，如果你要处理大量的基本类型的数据，使用非装箱数组会帮你省好多钱。</p>
<p>除了基本类型数组，即使装箱的数组要有漂亮的性能数据。连接两个数据要比连接其它集合要快，甚至比List和Vector这些有精心设计的数据结构还要快。对于有一百万元素的集合，甚至要快10倍。<a href="https://issues.scala-lang.org/browse/SI-4442" target="_blank" rel="external">SI-4442</a>提交了一个issue用来解决这个问题，但是目前的性能还是如此。</p>
<p>我非常惊讶的是数组的连接是那么快，甚至那些&quot;花哨&quot;的数据结构如List和Vector，使用共享数据避免复制整个数据都比不上数组。它表明复制整体数据事实上要比组合那些持久化数据结构都要快。所以如果你要处理一个不可变集合，有时候需要把它分成片段或者连接起来，使用数组要更快。</p>
<h3 id="Set_和_Map_都很慢">Set 和 Map 都很慢</h3>
<p>使用不可变的Vector的查找只需要不可变的Set的1/10 ～ 1/20，不可变Map的1/10 ～ 1/40，即使是使用可变的Set和Map，Vector的速度也很快，当然使用原始的数组会更快。</p>
<p>这是合理的，因为Set和Map的查找包含很多的hash计算和hash比较，即使是对于简单的键值也是这样，这些操作会带来显著的时间花费。相反，Vector查找只是简单的整数运算，数组查找只是指针的移动。</p>
<p>Set和Map不只是查找很慢：构建它们也很慢，移除元素也很慢，连接集合也很慢。即使操作不需要执行hash计算，比如迭代(iteration),也比迭代一个Vector慢19倍。</p>
<p>所以除非你需要不能重复元素的集合才使用Set，需要键值对才选择Map，否则尽量不用它们，因为它们才是程序慢的原因。如果你的键的集合比较小并且性能有问题，你可以为每个键分配一个整数，使用Vector[Boolean]代替Set，使用Vector[T]代替Map，查找的时候使用整数查找。有时候，即使你知道集合的元素不会重复，不使用Set而是使用数组、Vector或者List会带来很好的性能。</p>
<p>可变Set和Map比不可变Set和Map会快一点，内存占用也小一点：1/2的内存占用，2～4倍快的查找，2倍快的迭代，2倍快的构建（.add/.put）,但是相比数组、Vector和List来说还是很慢。</p>
<h3 id="Lists_vs_Vectors">Lists vs Vectors</h3>
<p>是选择单链表形式的List还是选择tree形式的Vector，选择哪个集合的标准很模糊。“有效的常数时间”的定义不能理清这种模糊认识，但是通过上面的测试数据，我们可以有一个更好的判断：</p>
<ul>
<li>相同大小的List的内存占用是Vector的内存。后者和数组的开销有得一拼。</li>
<li>构建一个List的时间比构建Vector快5～15倍。</li>
<li>通过<code>.tail</code>从List中移除元素比Vector快50～60倍</li>
<li>可以通过索引在Vector查找元素，而通过List按照索引查找的时间是<code>O(n)</code>,元素数量很大的时候时间花费是很大的</li>
<li>迭代这两个集合的时间花费差不多</li>
</ul>
<p>如果你自己构建集合并且一个个的移除元素，迭代它们，最好使用List。如果你需要根据索引查找元素，则选择Vector。使用<code>:+</code>和<code>.tail</code>增加元素和移除元素虽然不会把你弄垮，但是它们却非常的慢。</p>
<h3 id="Lists_vs_mutable-Buffer">Lists vs mutable.Buffer</h3>
<p>List除了作为不可变集合外，还经常使用<code>var</code>作为可变集合，而<code>mutable.Buffer</code>也有相同的目的，那你该用哪一个集合呢？</p>
<p>数据表明使用List要比mutable.Buffer在处理一个个的元素的时候要快：对小集合来说快2～3倍，大集合要快1.5～2倍。很大的差异！</p>
<p>除了性能，它们之间也有一些其它不同：</p>
<ul>
<li>mutable.Buffer可以快速的按照索引查找，而List不可以</li>
<li>List是持久化的，所以你可以增加/移除你的列表副本而不会影响其他人对这个列表的使用，而mutable.Buffer却不是，一个人的修改会影响其他使用的人</li>
<li>List的构建是&quot;向后&quot;的(backwards)。最后加入的元素在迭代的时候位于第一个位置，这可能不是你所期望的，你可能在使用之前对它反转。mutable.Buffer则是&quot;向前&quot;构建的，第一个增加的元素在迭代的时候总是第一个。</li>
<li>mutable.Buffer只占List的花销（overhead）的一半</li>
</ul>
<p>对于遍历元素的操作，List更快，但会用更多的内存。如果你根本不关心其它影响因素，这个因素可能帮你决定你该使用哪一个集合。</p>
<h3 id="Vector还算好吧">Vector还算好吧</h3>
<p>尽管Vector经常倍认为是一个很好的通用目的的数据结构，但是数据表明它也不是想象的那么好：</p>
<ul>
<li>小的vector，比如之包含一个元素，有1/5的内存花销，而对于大的Vector，它的花销却可以忽略不计。如果你有很多的小集合，使用Vector可能会带来内存的浪费</li>
<li>Vector一个元素一个元素填充式的构建比List或者mutable.Buffer要慢5～15倍，比预分配大小的数组慢40倍</li>
<li>Vector按照索引进行查找的性能可以接受，但也比数组或者mutable.Buffer要慢5～15倍，比预分配大小的数组慢40倍</li>
<li>两个差不多大小的Vector的连接时间比List的连接的事时间快一倍，但比数组慢10倍，尽管数组需要全复制。</li>
</ul>
<p>总体来说，Vector还是一个可以接受的通用目的的集合。</p>
<ul>
<li>一方面，你看不到Vector有什么严重的性能缺陷，大部分的Vector的性能都处于中等水平，如果你使用它们，不会出现<code>O(n^2)</code>的时间</li>
<li>另一方面，常用操作要比理想的数据结构慢一个数量级。增量构建比List慢5～15，索引查找比数组慢很多，即使连接操作也比数组慢10倍</li>
</ul>
<p>Vector通常是缺省的数组结构，但是如果可能的话，直接使用List或者mutable.Buffer可能会给性能带来数量级的提升。可能有些夸张，但是的确是值得关注的事情。十倍的性能提升是巨大的。</p>
<h2 id="总结">总结</h2>
<p>本文提供了一个具体基准帮助你选择哪一种Scala集合。理论分析经常错过很多重要因素,因为很自然的你只分析那些你认为重要的因素。本文的测试从实践的角度提供了集合的有意义的行为。</p>
<p>例如，令我惊讶的是从Vector移除一个元素远比增加一个元素要慢很多，还有Set和Map比Vector和List慢很多，即使是迭代这种不受hash操作影响的操作也很慢。还有数组的连接出人意料的快，比那些使用共享数据的集合还快。</p>
<p>就像强调集合之间的差异一样，这套benchmark也强调很多无关重要的事情：</p>
<ul>
<li>List、Array和Vector的foreach的区别</li>
<li>数据巨大的Vector和Array的内存占用比较</li>
<li>通过<code>+</code>构建Set还是先构建一个数组然后调用<code>.toSet</code>?</li>
</ul>
<p>尽管代码不同，内部的数据结构也不同，实践中可能你选择哪个数据结构美太大关系，选择一个合适的。</p>
<p>下次你要选择一个特殊的集合的时候，或者你和同事讨论哪个集合合适的时候，可以随时回来查看这篇植物。</p>
<h2 id="参考">参考</h2>
<h3 id="带标准差的性能数据">带标准差的性能数据</h3>
<p>下面的性能数据，加上了标准差。注意它们是从7次测试中取了中间5次之后的标准差。</p>
<table class="table table-bordered"><tbody><tr><td align="left"><strong>construct</strong></td><td align="right"><strong>0</strong></td><td align="right"><strong>1</strong></td><td align="right"><strong>4</strong></td><td align="right"><strong>16</strong></td><td align="right"><strong>64</strong></td><td align="right"><strong>256</strong></td><td align="right"><strong>1,024</strong></td><td align="right"><strong>4,096</strong></td><td align="right"><strong>16,192</strong></td><td align="right"><strong>65,536</strong></td><td align="right"><strong>262,144</strong></td><td align="right"><strong>1,048,576</strong></td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left">Array-prealloc</td><td align="right">17 ± 0%</td><td align="right">10 ± 0%</td><td align="right">14 ± 0%</td><td align="right">41 ± 0%</td><td align="right">186 ± 0.5%</td><td align="right">710 ± 2.1%</td><td align="right">2,710 ± 2.6%</td><td align="right">11,000 ± 2.7%</td><td align="right">45,100 ± 2.1%</td><td align="right">183,000 ± 2.0%</td><td align="right">730,000 ± 2.0%</td><td align="right">3,100,000 ± 1.6%</td></tr><tr><td align="left">Array:+</td><td align="right">2 ± 0%</td><td align="right">12 ± 0%</td><td align="right">58 ± 0%</td><td align="right">270 ± 0.4%</td><td align="right">1,460 ± 2.4%</td><td align="right">19,800 ± 1.5%</td><td align="right">260,000 ± 1.7%</td><td align="right">3,170,000 ± 1.5%</td><td align="right">60,000,000 ± 1.8%</td><td align="right">1,020,000,000 ± 1.2%</td><td align="right"></td><td align="right"></td></tr><tr><td align="left">Vector</td><td align="right">2 ± 0%</td><td align="right">15 ± 6.7%</td><td align="right">99 ± 1.0%</td><td align="right">410 ± 2.7%</td><td align="right">1,730 ± 2.3%</td><td align="right">7,000 ± 2.7%</td><td align="right">28,600 ± 3.4%</td><td align="right">324,000 ± 0.5%</td><td align="right">1,498,000 ± 0.5%</td><td align="right">7,140,000 ± 0.4%</td><td align="right">31,700,000 ± 0.4%</td><td align="right">131,000,000 ± 1.0%</td></tr><tr><td align="left">List</td><td align="right">1 ± 0%</td><td align="right">4 ± 0%</td><td align="right">12 ± 0%</td><td align="right">69 ± 1.4%</td><td align="right">301 ± 2.7%</td><td align="right">1,220 ± 2.3%</td><td align="right">4,900 ± 2.2%</td><td align="right">19,800 ± 2.8%</td><td align="right">79,000 ± 2.5%</td><td align="right">329,000 ± 1.6%</td><td align="right">1,510,000 ± 1.2%</td><td align="right">9,100,000 ± 8.3%</td></tr><tr><td align="left">Set</td><td align="right">1 ± 0%</td><td align="right">12 ± 0%</td><td align="right">58 ± 0%</td><td align="right">1,860 ± 0.5%</td><td align="right">8,530 ± 0.4%</td><td align="right">37,400 ± 0.8%</td><td align="right">166,000 ± 1.2%</td><td align="right">783,000 ± 0.5%</td><td align="right">3,600,000 ± 1.6%</td><td align="right">18,100,000 ± 0.7%</td><td align="right">94,000,000 ± 1.4%</td><td align="right">473,000,000 ± 1.5%</td></tr><tr><td align="left">Map</td><td align="right">1 ± 0%</td><td align="right">6 ± 0%</td><td align="right">95 ± 0%</td><td align="right">2,100 ± 1.9%</td><td align="right">9,010 ± 0.7%</td><td align="right">38,900 ± 0.5%</td><td align="right">171,000 ± 1.0%</td><td align="right">810,000 ± 1.3%</td><td align="right">3,710,000 ± 1.3%</td><td align="right">18,400,000 ± 1.6%</td><td align="right">96,000,000 ± 1.1%</td><td align="right">499,000,000 ± 1.4%</td></tr><tr><td align="left">Array.toVector</td><td align="right">95 ± 1.1%</td><td align="right">109 ± 0%</td><td align="right">143 ± 0%</td><td align="right">287 ± 0.3%</td><td align="right">903 ± 0.9%</td><td align="right">3,310 ± 0.2%</td><td align="right">12,850 ± 0.5%</td><td align="right">51,100 ± 0.8%</td><td align="right">203,800 ± 0.5%</td><td align="right">821,000 ± 0.5%</td><td align="right">3,270,000 ± 1.3%</td><td align="right">13,300,000 ± 1.4%</td></tr><tr><td align="left">Array.toSet</td><td align="right">73 ± 0%</td><td align="right">75 ± 0%</td><td align="right">187 ± 0.5%</td><td align="right">2,140 ± 1.4%</td><td align="right">9,220 ± 0.9%</td><td align="right">40,000 ± 1.2%</td><td align="right">174,000 ± 0.9%</td><td align="right">833,000 ± 0.6%</td><td align="right">3,800,000 ± 1.2%</td><td align="right">19,300,000 ± 0.6%</td><td align="right">101,000,000 ± 1.4%</td><td align="right">506,000,000 ± 1.7%</td></tr><tr><td align="left">Array.toMap</td><td align="right">21 ± 0%</td><td align="right">31 ± 0%</td><td align="right">104 ± 1.0%</td><td align="right">2,100 ± 0.5%</td><td align="right">9,200 ± 1.5%</td><td align="right">39,500 ± 1.6%</td><td align="right">173,000 ± 1.7%</td><td align="right">820,000 ± 1.7%</td><td align="right">3,790,000 ± 2.1%</td><td align="right">19,500,000 ± 1.6%</td><td align="right">104,000,000 ± 2.5%</td><td align="right">540,000,000 ± 2.2%</td></tr><tr><td align="left">m.Buffer</td><td align="right">19 ± 0%</td><td align="right">30 ± 0%</td><td align="right">58 ± 0%</td><td align="right">174 ± 1.1%</td><td align="right">691 ± 0.7%</td><td align="right">2,690 ± 1.0%</td><td align="right">10,840 ± 0.7%</td><td align="right">43,000 ± 0.7%</td><td align="right">169,800 ± 0.4%</td><td align="right">687,000 ± 0.7%</td><td align="right">2,770,000 ± 0.6%</td><td align="right">11,790,000 ± 0.7%</td></tr><tr><td align="left">m.Set</td><td align="right">13 ± 0%</td><td align="right">76 ± 0%</td><td align="right">276 ± 0.4%</td><td align="right">1,430 ± 1.1%</td><td align="right">6,700 ± 0.9%</td><td align="right">27,900 ± 1.2%</td><td align="right">113,000 ± 1.6%</td><td align="right">455,000 ± 1.4%</td><td align="right">1,840,000 ± 1.2%</td><td align="right">7,900,000 ± 1.4%</td><td align="right">39,000,000 ± 3.0%</td><td align="right">267,000,000 ± 3.2%</td></tr><tr><td align="left">m.Map</td><td align="right">6 ± 0%</td><td align="right">79 ± 1.3%</td><td align="right">297 ± 0.3%</td><td align="right">1,420 ± 1.0%</td><td align="right">6,200 ± 0.7%</td><td align="right">25,500 ± 1.0%</td><td align="right">103,000 ± 1.9%</td><td align="right">414,000 ± 2.0%</td><td align="right">1,820,000 ± 2.0%</td><td align="right">8,100,000 ± 3.3%</td><td align="right">57,000,000 ± 4.6%</td><td align="right">348,000,000 ± 2.4%</td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left"><strong>deconstruct</strong></td><td align="right"><strong>0</strong></td><td align="right"><strong>1</strong></td><td align="right"><strong>4</strong></td><td align="right"><strong>16</strong></td><td align="right"><strong>64</strong></td><td align="right"><strong>256</strong></td><td align="right"><strong>1,024</strong></td><td align="right"><strong>4,096</strong></td><td align="right"><strong>16,192</strong></td><td align="right"><strong>65,536</strong></td><td align="right"><strong>262,144</strong></td><td align="right"><strong>1,048,576</strong></td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left">Array.tail</td><td align="right">7 ± 0%</td><td align="right">26 ± 0%</td><td align="right">114 ± 0.9%</td><td align="right">582 ± 0.5%</td><td align="right">4,517 ± 0.1%</td><td align="right">55,500 ± 0.9%</td><td align="right">821,000 ± 0.3%</td><td align="right">12,140,000 ± 0.6%</td><td align="right">188,000,000 ± 1.0%</td><td align="right">3,100,000,000 ± 0.4%</td><td align="right"></td><td align="right"></td></tr><tr><td align="left">List.tail</td><td align="right">2 ± 0%</td><td align="right">2 ± 0%</td><td align="right">7 ± 0%</td><td align="right">21 ± 4.8%</td><td align="right">100 ± 10.6%</td><td align="right">420 ± 3.7%</td><td align="right">2,100 ± 5.9%</td><td align="right">10,000 ± 10.4%</td><td align="right">35,000 ± 4.6%</td><td align="right">120,000 ± 9.4%</td><td align="right">540,000 ± 9.2%</td><td align="right">1,500,000 ± 53.5%</td></tr><tr><td align="left">Vector.tail</td><td align="right">3 ± 0%</td><td align="right">6 ± 0%</td><td align="right">90 ± 1.1%</td><td align="right">425 ± 2.1%</td><td align="right">1,970 ± 1.7%</td><td align="right">11,800 ± 2.6%</td><td align="right">58,400 ± 1.1%</td><td align="right">500,000 ± 2.2%</td><td align="right">2,390,000 ± 1.3%</td><td align="right">11,000,000 ± 1.2%</td><td align="right">50,200,000 ± 0.5%</td><td align="right">211,000,000 ± 1.3%</td></tr><tr><td align="left">Vector.init</td><td align="right">2 ± 0%</td><td align="right">5 ± 0%</td><td align="right">103 ± 1.0%</td><td align="right">483 ± 1.9%</td><td align="right">2,490 ± 1.8%</td><td align="right">12,800 ± 2.0%</td><td align="right">64,000 ± 2.8%</td><td align="right">543,000 ± 0.8%</td><td align="right">2,470,000 ± 1.7%</td><td align="right">11,900,000 ± 1.8%</td><td align="right">52,600,000 ± 1.5%</td><td align="right">218,000,000 ± 1.5%</td></tr><tr><td align="left">Set.-</td><td align="right">8 ± 12.5%</td><td align="right">30 ± 3.3%</td><td align="right">162 ± 1.2%</td><td align="right">1,480 ± 3.9%</td><td align="right">7,700 ± 3.0%</td><td align="right">34,200 ± 1.2%</td><td align="right">164,000 ± 1.5%</td><td align="right">770,000 ± 1.4%</td><td align="right">3,660,000 ± 2.6%</td><td align="right">20,300,000 ± 0.7%</td><td align="right">94,000,000 ± 1.3%</td><td align="right">420,000,000 ± 1.8%</td></tr><tr><td align="left">Map.-</td><td align="right">12 ± 8.3%</td><td align="right">52 ± 0%</td><td align="right">201 ± 0.5%</td><td align="right">1,430 ± 1.3%</td><td align="right">7,660 ± 0.5%</td><td align="right">34,900 ± 0.9%</td><td align="right">169,000 ± 0.7%</td><td align="right">810,000 ± 2.1%</td><td align="right">3,990,000 ± 0.3%</td><td align="right">24,000,000 ± 3.4%</td><td align="right">103,000,000 ± 5.1%</td><td align="right">470,000,000 ± 3.4%</td></tr><tr><td align="left">m.Buffer</td><td align="right">6 ± 0%</td><td align="right">8 ± 12.5%</td><td align="right">14 ± 7.1%</td><td align="right">43 ± 2.3%</td><td align="right">166 ± 0.6%</td><td align="right">630 ± 2.8%</td><td align="right">2,510 ± 2.9%</td><td align="right">10,000 ± 3.0%</td><td align="right">40,600 ± 1.7%</td><td align="right">167,000 ± 2.8%</td><td align="right">660,000 ± 4.2%</td><td align="right">2,490,000 ± 3.0%</td></tr><tr><td align="left">m.Set</td><td align="right">5 ± 0%</td><td align="right">28 ± 7.1%</td><td align="right">130 ± 1.5%</td><td align="right">671 ± 1.0%</td><td align="right">4,900 ± 2.9%</td><td align="right">54,000 ± 1.6%</td><td align="right">770,000 ± 1.1%</td><td align="right">11,990,000 ± 0.8%</td><td align="right">189,000,000 ± 1.1%</td><td align="right">3,040,000,000 ± 0.5%</td><td align="right"></td><td align="right"></td></tr><tr><td align="left">m.Map</td><td align="right">7 ± 14.3%</td><td align="right">44 ± 2.3%</td><td align="right">172 ± 3.5%</td><td align="right">670 ± 4.6%</td><td align="right">3,650 ± 2.6%</td><td align="right">26,400 ± 1.8%</td><td align="right">282,000 ± 1.3%</td><td align="right">3,970,000 ± 0.4%</td><td align="right">62,600,000 ± 1.0%</td><td align="right">1,000,000,000 ± 1.1%</td><td align="right"></td><td align="right"></td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left"><strong>concat</strong></td><td align="right"><strong>0</strong></td><td align="right"><strong>1</strong></td><td align="right"><strong>4</strong></td><td align="right"><strong>16</strong></td><td align="right"><strong>64</strong></td><td align="right"><strong>256</strong></td><td align="right"><strong>1,024</strong></td><td align="right"><strong>4,096</strong></td><td align="right"><strong>16,192</strong></td><td align="right"><strong>65,536</strong></td><td align="right"><strong>262,144</strong></td><td align="right"><strong>1,048,576</strong></td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left">arraycopy</td><td align="right">23 ± 0%</td><td align="right">18 ± 5.6%</td><td align="right">20 ± 5.0%</td><td align="right">27 ± 3.7%</td><td align="right">48 ± 16.7%</td><td align="right">280 ± 15.5%</td><td align="right">1,000 ± 12.0%</td><td align="right">4,000 ± 7.2%</td><td align="right">16,000 ± 11.0%</td><td align="right">65,000 ± 6.7%</td><td align="right">360,000 ± 14.4%</td><td align="right">1,400,000 ± 23.1%</td></tr><tr><td align="left">Array++</td><td align="right">89 ± 1.1%</td><td align="right">83 ± 1.2%</td><td align="right">85 ± 1.2%</td><td align="right">91 ± 1.1%</td><td align="right">144 ± 5.6%</td><td align="right">330 ± 14.7%</td><td align="right">970 ± 5.6%</td><td align="right">4,100 ± 5.5%</td><td align="right">17,000 ± 17.0%</td><td align="right">70,000 ± 14.9%</td><td align="right">380,000 ± 11.5%</td><td align="right">1,700,000 ± 7.7%</td></tr><tr><td align="left">List</td><td align="right">7 ± 0%</td><td align="right">81 ± 1.2%</td><td align="right">162 ± 1.2%</td><td align="right">434 ± 0.5%</td><td align="right">1,490 ± 2.5%</td><td align="right">5,790 ± 0.8%</td><td align="right">23,200 ± 1.3%</td><td align="right">92,500 ± 0.4%</td><td align="right">370,000 ± 1.1%</td><td align="right">1,510,000 ± 1.7%</td><td align="right">6,300,000 ± 1.8%</td><td align="right">30,000,000 ± 6.5%</td></tr><tr><td align="left">Vector</td><td align="right">5 ± 20.0%</td><td align="right">48 ± 2.1%</td><td align="right">188 ± 1.6%</td><td align="right">327 ± 0.3%</td><td align="right">940 ± 2.2%</td><td align="right">3,240 ± 2.0%</td><td align="right">12,700 ± 2.4%</td><td align="right">52,000 ± 4.1%</td><td align="right">210,000 ± 2.2%</td><td align="right">810,000 ± 1.6%</td><td align="right">3,370,000 ± 1.3%</td><td align="right">14,500,000 ± 2.8%</td></tr><tr><td align="left">Set</td><td align="right">91 ± 1.1%</td><td align="right">95 ± 3.2%</td><td align="right">877 ± 0.7%</td><td align="right">1,130 ± 3.4%</td><td align="right">5,900 ± 3.1%</td><td align="right">26,900 ± 2.5%</td><td align="right">149,000 ± 2.7%</td><td align="right">680,000 ± 2.0%</td><td align="right">3,600,000 ± 3.3%</td><td align="right">23,000,000 ± 2.0%</td><td align="right">100,000,000 ± 6.9%</td><td align="right">280,000,000 ± 12.6%</td></tr><tr><td align="left">Map</td><td align="right">54 ± 1.9%</td><td align="right">53 ± 1.9%</td><td align="right">967 ± 0.9%</td><td align="right">1,480 ± 5.4%</td><td align="right">6,900 ± 2.2%</td><td align="right">31,500 ± 1.0%</td><td align="right">166,000 ± 1.4%</td><td align="right">760,000 ± 2.9%</td><td align="right">4,100,000 ± 2.9%</td><td align="right">27,000,000 ± 3.5%</td><td align="right">118,000,000 ± 4.6%</td><td align="right">450,000,000 ± 11.7%</td></tr><tr><td align="left">m.Buffer</td><td align="right">11 ± 0%</td><td align="right">32 ± 9.4%</td><td align="right">32 ± 18.8%</td><td align="right">38 ± 2.6%</td><td align="right">70 ± 19.2%</td><td align="right">250 ± 13.7%</td><td align="right">700 ± 29.1%</td><td align="right">3,900 ± 10.0%</td><td align="right">20,000 ± 41.6%</td><td align="right">40,000 ± 34.9%</td><td align="right">400,000 ± 14.7%</td><td align="right">1,500,000 ± 19.5%</td></tr><tr><td align="left">m.Set</td><td align="right">58 ± 3.4%</td><td align="right">81 ± 6.2%</td><td align="right">142 ± 4.9%</td><td align="right">1,080 ± 3.1%</td><td align="right">4,200 ± 3.3%</td><td align="right">16,000 ± 6.7%</td><td align="right">69,000 ± 5.3%</td><td align="right">263,000 ± 2.1%</td><td align="right">1,160,000 ± 4.8%</td><td align="right">6,300,000 ± 3.7%</td><td align="right">43,000,000 ± 5.6%</td><td align="right">310,000,000 ± 8.1%</td></tr><tr><td align="left">m.Map</td><td align="right">47 ± 2.1%</td><td align="right">69 ± 2.9%</td><td align="right">181 ± 3.3%</td><td align="right">990 ± 1.1%</td><td align="right">3,700 ± 3.0%</td><td align="right">15,000 ± 2.9%</td><td align="right">62,000 ± 5.6%</td><td align="right">290,000 ± 5.2%</td><td align="right">1,500,000 ± 16.2%</td><td align="right">16,000,000 ± 6.8%</td><td align="right">103,000,000 ± 4.3%</td><td align="right">493,000,000 ± 1.2%</td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left"><strong>foreach</strong></td><td align="right"><strong>0</strong></td><td align="right"><strong>1</strong></td><td align="right"><strong>4</strong></td><td align="right"><strong>16</strong></td><td align="right"><strong>64</strong></td><td align="right"><strong>256</strong></td><td align="right"><strong>1,024</strong></td><td align="right"><strong>4,096</strong></td><td align="right"><strong>16,192</strong></td><td align="right"><strong>65,536</strong></td><td align="right"><strong>262,144</strong></td><td align="right"><strong>1,048,576</strong></td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left">Array</td><td align="right">2 ± 0%</td><td align="right">5 ± 0%</td><td align="right">15 ± 0%</td><td align="right">57 ± 1.8%</td><td align="right">230 ± 1.7%</td><td align="right">900 ± 2.0%</td><td align="right">3,580 ± 1.4%</td><td align="right">14,200 ± 1.7%</td><td align="right">55,600 ± 0.8%</td><td align="right">228,000 ± 1.6%</td><td align="right">910,000 ± 1.9%</td><td align="right">3,610,000 ± 0.7%</td></tr><tr><td align="left">Array-while</td><td align="right">0 ± 0%</td><td align="right">1 ± 0%</td><td align="right">0 ± 0%</td><td align="right">1 ± 0%</td><td align="right">0 ± 0%</td><td align="right">0 ± 0%</td><td align="right">0 ± 0%</td><td align="right">-4 ± 100.0%</td><td align="right">10 ± 166.7%</td><td align="right">70 ± 97.1%</td><td align="right">0 ± 507.0%</td><td align="right">500 ± 153.3%</td></tr><tr><td align="left">List</td><td align="right">0 ± 0%</td><td align="right">3 ± 0%</td><td align="right">13 ± 0%</td><td align="right">50 ± 2.0%</td><td align="right">209 ± 1.9%</td><td align="right">800 ± 2.1%</td><td align="right">3,500 ± 3.5%</td><td align="right">14,100 ± 3.8%</td><td align="right">55,000 ± 4.6%</td><td align="right">231,000 ± 2.8%</td><td align="right">920,000 ± 9.7%</td><td align="right">3,800,000 ± 6.4%</td></tr><tr><td align="left">List-while</td><td align="right">4 ± 0%</td><td align="right">5 ± 0%</td><td align="right">13 ± 0%</td><td align="right">49 ± 2.0%</td><td align="right">211 ± 0.9%</td><td align="right">812 ± 1.1%</td><td align="right">3,400 ± 2.9%</td><td align="right">14,200 ± 4.5%</td><td align="right">57,000 ± 6.9%</td><td align="right">226,000 ± 2.2%</td><td align="right">930,000 ± 6.5%</td><td align="right">3,700,000 ± 4.4%</td></tr><tr><td align="left">Vector</td><td align="right">15 ± 0%</td><td align="right">19 ± 0%</td><td align="right">30 ± 0%</td><td align="right">74 ± 1.4%</td><td align="right">268 ± 2.2%</td><td align="right">1,000 ± 2.5%</td><td align="right">3,960 ± 1.9%</td><td align="right">16,200 ± 4.1%</td><td align="right">62,000 ± 2.4%</td><td align="right">256,000 ± 1.5%</td><td align="right">1,030,000 ± 1.5%</td><td align="right">4,300,000 ± 3.2%</td></tr><tr><td align="left">Set</td><td align="right">4 ± 0%</td><td align="right">5 ± 0%</td><td align="right">10 ± 0%</td><td align="right">99 ± 1.0%</td><td align="right">420 ± 2.6%</td><td align="right">1,560 ± 2.4%</td><td align="right">10,200 ± 4.1%</td><td align="right">51,000 ± 1.7%</td><td align="right">217,000 ± 2.2%</td><td align="right">2,200,000 ± 5.3%</td><td align="right">10,800,000 ± 1.7%</td><td align="right">48,600,000 ± 1.8%</td></tr><tr><td align="left">Map</td><td align="right">19 ± 0%</td><td align="right">7 ± 0%</td><td align="right">20 ± 0%</td><td align="right">140 ± 2.1%</td><td align="right">610 ± 4.0%</td><td align="right">2,500 ± 3.9%</td><td align="right">13,900 ± 3.9%</td><td align="right">72,800 ± 0.9%</td><td align="right">360,000 ± 3.3%</td><td align="right">3,700,000 ± 8.2%</td><td align="right">20,700,000 ± 1.6%</td><td align="right">75,000,000 ± 3.6%</td></tr><tr><td align="left">m.Buffer</td><td align="right">0 ± 0%</td><td align="right">1 ± 0%</td><td align="right">1 ± 0%</td><td align="right">1 ± 0%</td><td align="right">1 ± 0%</td><td align="right">0 ± 0%</td><td align="right">1 ± 0%</td><td align="right">2 ± 100.0%</td><td align="right">-1 ± 800.0%</td><td align="right">-10 ± 423.5%</td><td align="right">0 ± 259.4%</td><td align="right">-200 ± 185.1%</td></tr><tr><td align="left">m.Set</td><td align="right">19 ± 0%</td><td align="right">26 ± 0%</td><td align="right">50 ± 2.0%</td><td align="right">130 ± 1.5%</td><td align="right">508 ± 1.4%</td><td align="right">2,190 ± 0.5%</td><td align="right">11,900 ± 2.1%</td><td align="right">56,600 ± 1.4%</td><td align="right">235,000 ± 2.6%</td><td align="right">940,000 ± 2.2%</td><td align="right">3,800,000 ± 5.5%</td><td align="right">14,700,000 ± 5.0%</td></tr><tr><td align="left">m.Map</td><td align="right">8 ± 0%</td><td align="right">16 ± 0%</td><td align="right">48 ± 2.1%</td><td align="right">146 ± 0.7%</td><td align="right">528 ± 1.1%</td><td align="right">2,210 ± 1.7%</td><td align="right">10,300 ± 2.8%</td><td align="right">54,100 ± 0.4%</td><td align="right">255,000 ± 2.0%</td><td align="right">1,140,000 ± 5.4%</td><td align="right">6,800,000 ± 5.4%</td><td align="right">30,000,000 ± 6.6%</td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left"><strong>lookup</strong></td><td align="right"><strong>0</strong></td><td align="right"><strong>1</strong></td><td align="right"><strong>4</strong></td><td align="right"><strong>16</strong></td><td align="right"><strong>64</strong></td><td align="right"><strong>256</strong></td><td align="right"><strong>1,024</strong></td><td align="right"><strong>4,096</strong></td><td align="right"><strong>16,192</strong></td><td align="right"><strong>65,536</strong></td><td align="right"><strong>262,144</strong></td><td align="right"><strong>1,048,576</strong></td></tr><tr><td align="left"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left">Array</td><td align="right">0 ± 0%</td><td align="right">1 ± 0%</td><td align="right">1 ± 0%</td><td align="right">1 ± 0%</td><td align="right">0 ± 0%</td><td align="right">0 ± 0%</td><td align="right">1 ± 0%</td><td align="right">-1 ± 200.0%</td><td align="right">4 ± 200.0%</td><td align="right">0 ± 675.0%</td><td align="right">100 ± 71.6%</td><td align="right">-200 ± 215.5%</td></tr><tr><td align="left">List</td><td align="right">0 ± 0%</td><td align="right">1 ± 0%</td><td align="right">8 ± 0%</td><td align="right">103 ± 1.0%</td><td align="right">2,390 ± 0.5%</td><td align="right">47,200 ± 1.0%</td><td align="right">870,000 ± 2.6%</td><td align="right">16,900,000 ± 2.8%</td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left">Vector</td><td align="right">0 ± 0%</td><td align="right">1 ± 0%</td><td align="right">5 ± 0%</td><td align="right">17 ± 0%</td><td align="right">104 ± 2.9%</td><td align="right">440 ± 2.7%</td><td align="right">1,780 ± 2.6%</td><td align="right">8,940 ± 1.1%</td><td align="right">38,000 ± 1.1%</td><td align="right">198,000 ± 1.3%</td><td align="right">930,000 ± 1.6%</td><td align="right">4,260,000 ± 1.7%</td></tr><tr><td align="left">Set</td><td align="right">0 ± 0%</td><td align="right">18 ± 0%</td><td align="right">81 ± 1.2%</td><td align="right">507 ± 0.6%</td><td align="right">1,980 ± 0.8%</td><td align="right">7,800 ± 1.8%</td><td align="right">39,800 ± 1.8%</td><td align="right">203,000 ± 1.1%</td><td align="right">1,040,000 ± 2.3%</td><td align="right">8,300,000 ± 2.8%</td><td align="right"></td><td align="right"></td></tr><tr><td align="left">Map</td><td align="right">0 ± 0%</td><td align="right">12 ± 0%</td><td align="right">97 ± 1.0%</td><td align="right">578 ± 1.6%</td><td align="right">2,250 ± 2.8%</td><td align="right">9,400 ± 1.5%</td><td align="right">46,000 ± 2.2%</td><td align="right">233,000 ± 1.7%</td><td align="right">1,150,000 ± 2.9%</td><td align="right">11,400,000 ± 2.6%</td><td align="right"></td><td align="right"></td></tr><tr><td align="left">m.Buffer</td><td align="right">0 ± 0%</td><td align="right">1 ± 0%</td><td align="right">1 ± 0%</td><td align="right">1 ± 0%</td><td align="right">1 ± 0%</td><td align="right">1 ± 0%</td><td align="right">1 ± 100.0%</td><td align="right">0 ± ∞%</td><td align="right">6 ± 133.3%</td><td align="right">-10 ± 200.0%</td><td align="right">0 ± 415.4%</td><td align="right">0 ± 970.0%</td></tr><tr><td align="left">m.Set</td><td align="right">0 ± 0%</td><td align="right">5 ± 0%</td><td align="right">22 ± 0%</td><td align="right">97 ± 1.0%</td><td align="right">410 ± 2.7%</td><td align="right">1,690 ± 1.4%</td><td align="right">7,100 ± 2.2%</td><td align="right">31,300 ± 1.8%</td><td align="right">148,000 ± 1.4%</td><td align="right">690,000 ± 2.1%</td><td align="right">4,800,000 ± 1.6%</td><td align="right"></td></tr><tr><td align="left">m.Map</td><td align="right">0 ± 0%</td><td align="right">6 ± 0%</td><td align="right">25 ± 0%</td><td align="right">112 ± 1.8%</td><td align="right">454 ± 1.3%</td><td align="right">1,910 ± 0.7%</td><td align="right">9,400 ± 0.5%</td><td align="right">52,500 ± 0.7%</td><td align="right">243,000 ± 2.7%</td><td align="right">1,760,000 ± 1.2%</td><td align="right">9,900,000 ± 5.3%</td><td align="right"></td></tr></tbody></table>

<h3 id="Raw_Benchmark_Data">Raw Benchmark Data</h3>
<p>下面的链接是原始测试数据，包括每一次独立的benchmark,而不是统计均值和标准差后的数据：</p>
<ul>
<li><a href="http://www.lihaoyi.com/post/BenchmarkingScalaCollections/results.json" target="_blank" rel="external">results.json</a></li>
</ul>
<h3 id="Benchmark_Code">Benchmark Code</h3>
<p>如果你想看测试代码，你可以浏览下面的链接：</p>
<ul>
<li><a href="https://github.com/lihaoyi/scala-bench" target="_blank" rel="external">https://github.com/lihaoyi/scala-bench</a></li>
</ul>
<p>或者下载:</p>
<ul>
<li><a href="http://www.lihaoyi.com/post/BenchmarkingScalaCollections/scala-bench.bundle" target="_blank" rel="external">scala-bench.bundle</a></li>
</ul>
<p>在下载页面点击<code>git clone scala-bench.bundle</code>得到你自己的仓库，然后</p>
<ul>
<li>sbt &quot;~bench/runMain bench.MemoryMain&quot; 进行内存benchmark</li>
<li>sbt &quot;~bench/runMain bench.PerfMain&quot; 执行性能测试然后将结果导入到 <code>bench/target/results.json</code>。注意在我的笔记本上它运行了4个小时，所以最好启动它然后第二天查看结果。</li>
<li>sbt &quot;~bench/runMain bench.AnalyzeMain&quot; 用来读取结果文件<code>results.json</code>，计算均值和标准差，将结果写入到一个markdown文件。</li>
</ul>
<p>这个benchmark代码绝对不像使用JMH那么严格，JMH已经相当慢了，而这个benchmark套件也需要四个半小时。</p>

      
    </div>
    <footer class="article-footer">
	
<div class="bdsharebuttonbox"><a title="分享到新浪微博" class="bds_tsina" href="#" data-cmd="tsina"></a><a title="分享到微信" class="bds_weixin" href="#" data-cmd="weixin"></a><a title="分享到QQ空间" class="bds_qzone" href="#" data-cmd="qzone"></a><a title="分享到印象笔记" class="bds_evernotecn" href="#" data-cmd="evernotecn"></a><a title="分享到有道云笔记" class="bds_youdao" href="#" data-cmd="youdao"></a><a title="分享到百度云收藏" class="bds_bdysc" href="#" data-cmd="bdysc"></a><a class="bds_more" href="#" data-cmd="more"></a></div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>
      

	  
        <a href="http://colobu.com/2016/11/17/Benchmarking-Scala-Collections/#comments" class="article-comment-link">评论</a>
      

      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Scala/">Scala</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/11/26/secrets-of-condoms/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          嘘，啪啪啪的秘密
        
      </div>
    </a>
  
  
    <a href="/2016/11/11/microservices-anti-patterns-and-pitfalls/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">微服务的反模式和陷阱</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div class="ds-thread" data-thread-key="2016/11/17/Benchmarking-Scala-Collections/" data-title="[译]Scala Collection的性能" data-url="http://colobu.com/2016/11/17/Benchmarking-Scala-Collections/"></div>

</section>

</section>
        
          <aside id="sidebar">
  
      <div class="widget-wrap">
    <h3 class="widget-title">原创图书</h3>
    <div class="widget">
      <a href="/ScalaCollectionsCookbook/">
        <img width="100%" src="/ScalaCollectionsCookbook/scala_collections_cookbook.jpg">
        <img width="100%" src="/ScalaCollectionsCookbook/scala_collections_cookbook_tw.png">
      </a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/DOTNET/">DOTNET</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Go/">Go</a><span class="category-list-count">52</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">58</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Scala/">Scala</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端开发/">前端开发</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/大数据/">大数据</a><span class="category-list-count">54</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工具/">工具</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/架构/">架构</a><span class="category-list-count">21</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/管理/">管理</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络编程/">网络编程</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/读书笔记/">读书笔记</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/运维/">运维</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/高并发编程/">高并发编程</a><span class="category-list-count">20</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/Android/" style="font-size: 15.71px;">Android</a><a href="/tags/ApacheBench/" style="font-size: 11.43px;">ApacheBench</a><a href="/tags/Bower/" style="font-size: 10.00px;">Bower</a><a href="/tags/C/" style="font-size: 10.00px;">C#</a><a href="/tags/CDN/" style="font-size: 10.00px;">CDN</a><a href="/tags/CQRS/" style="font-size: 10.00px;">CQRS</a><a href="/tags/CRC/" style="font-size: 10.00px;">CRC</a><a href="/tags/CSS/" style="font-size: 11.43px;">CSS</a><a href="/tags/CompletableFuture/" style="font-size: 10.00px;">CompletableFuture</a><a href="/tags/Comsat/" style="font-size: 10.00px;">Comsat</a><a href="/tags/Curator/" style="font-size: 20.00px;">Curator</a><a href="/tags/DSL/" style="font-size: 10.00px;">DSL</a><a href="/tags/Disruptor/" style="font-size: 10.00px;">Disruptor</a><a href="/tags/Docker/" style="font-size: 11.43px;">Docker</a><a href="/tags/Ember/" style="font-size: 11.43px;">Ember</a><a href="/tags/FastJson/" style="font-size: 10.00px;">FastJson</a><a href="/tags/Fiber/" style="font-size: 10.00px;">Fiber</a><a href="/tags/GAE/" style="font-size: 10.00px;">GAE</a><a href="/tags/GC/" style="font-size: 12.86px;">GC</a><a href="/tags/Gnuplot/" style="font-size: 10.00px;">Gnuplot</a><a href="/tags/Go/" style="font-size: 11.43px;">Go</a><a href="/tags/Gradle/" style="font-size: 10.00px;">Gradle</a><a href="/tags/Grunt/" style="font-size: 10.00px;">Grunt</a><a href="/tags/Gulp/" style="font-size: 10.00px;">Gulp</a><a href="/tags/Hadoop/" style="font-size: 10.00px;">Hadoop</a><a href="/tags/Hazelcast/" style="font-size: 10.00px;">Hazelcast</a><a href="/tags/Ignite/" style="font-size: 10.00px;">Ignite</a><a href="/tags/JVM/" style="font-size: 10.00px;">JVM</a><a href="/tags/Java/" style="font-size: 17.14px;">Java</a><a href="/tags/Kafka/" style="font-size: 18.57px;">Kafka</a><a href="/tags/Lambda/" style="font-size: 14.29px;">Lambda</a><a href="/tags/Linux/" style="font-size: 12.86px;">Linux</a><a href="/tags/LongAdder/" style="font-size: 10.00px;">LongAdder</a><a href="/tags/MathJax/" style="font-size: 10.00px;">MathJax</a><a href="/tags/Maven/" style="font-size: 11.43px;">Maven</a><a href="/tags/Memcached/" style="font-size: 10.00px;">Memcached</a><a href="/tags/Metrics/" style="font-size: 10.00px;">Metrics</a><a href="/tags/Mongo/" style="font-size: 12.86px;">Mongo</a><a href="/tags/Netty/" style="font-size: 15.71px;">Netty</a><a href="/tags/Node/" style="font-size: 10.00px;">Node</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">July 2015</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">June 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">May 2015</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">April 2015</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">March 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/02/">February 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">January 2015</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">December 2014</a><span class="archive-list-count">28</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/11/">November 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/10/">October 2014</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">September 2014</a><span class="archive-list-count">28</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">August 2014</a><span class="archive-list-count">19</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/07/">July 2014</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">近期文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/12/24/a-featured-fsm/">一个有特色的有限状态机</a>
          </li>
        
          <li>
            <a href="/2016/12/21/how-to-dump-goroutine-stack-traces/">调试利器：dump goroutine 的 stacktrace</a>
          </li>
        
          <li>
            <a href="/2016/12/20/detect-and-link-references-in-github/">Github和gitlab的自动连接</a>
          </li>
        
          <li>
            <a href="/2016/12/10/Food-Chain-of-Premier-League/">使用算法检测英超中的食物链</a>
          </li>
        
          <li>
            <a href="/2016/12/04/smooth-weighted-round-robin-algorithm/">平滑的基于权重的轮询算法</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">友情链接</h3>
    <div class="widget">
      <ul>
        
          <li>
			 
            <a href="http://old.colobu.com" target="_blank">旧的博客</a>
			
          </li>
        
          <li>
			 
			&nbsp;
			
          </li>
        
          <li>
			 
            <a href="http://stackshare.io" target="_blank">技术栈</a>
			
          </li>
        
          <li>
			 
			&nbsp;
			
          </li>
        
          <li>
			 
            <a href="http://weekly.manong.io/issues/" target="_blank">码农周刊</a>
			
          </li>
        
          <li>
			 
            <a href="http://www.tuicool.com/mags" target="_blank">编程狂人周刊</a>
			
          </li>
        
          <li>
			 
            <a href="http://www.importnew.com/" target="_blank">importnew</a>
			
          </li>
        
          <li>
			 
            <a href="http://ifeve.com/" target="_blank">并发编程网</a>
			
          </li>
        
          <li>
			 
			&nbsp;
			
          </li>
        
          <li>
			 
            <a href="http://github.com" target="_blank">github</a>
			
          </li>
        
          <li>
			 
            <a href="http://stackoverflow.com/" target="_blank">stackoverflow</a>
			
          </li>
        
          <li>
			 
            <a href="http://www.javacodegeeks.com/" target="_blank">javacodegeeks</a>
			
          </li>
        
          <li>
			 
            <a href="http://www.infoq.com/" target="_blank">infoq</a>
			
          </li>
        
          <li>
			 
            <a href="http://www.dzone.com/links/index.html" target="_blank">dzone</a>
			
          </li>
        
          <li>
			 
            <a href="https://oj.leetcode.com/problems/" target="_blank">leetcode</a>
			
          </li>
        
          <li>
			 
			&nbsp;
			
          </li>
        
          <li>
			 
            <a href="http://www.503error.com/" target="_blank">503error</a>
			
          </li>
        
      </ul>
    </div>
  </div>

  
      <div class="widget-wrap">
    <h3 class="widget-title">热评文章</h3>
    <div class="widget">
		<div class="ds-top-threads" data-range="monthly" data-num-items="5"></div>
    </div>
  </div>

  
      <div class="widget-wrap">
    <h3 class="widget-title">最新评论</h3>
    <div class="widget">
		<ul class="ds-recent-comments" data-num-items="10" data-show-avatars="1" data-show-time="1" data-show-admin="1" data-excerpt-length="70"></ul>
		<script type="text/javascript">
		var duoshuoQuery = {short_name:"colobu"};
		(function() {
			var ds = document.createElement('script');
			ds.type = 'text/javascript';ds.async = true;
			ds.src = 'http://static.duoshuo.com/embed.js';
			ds.charset = 'UTF-8';
			(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
		})();
		</script>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 smallnest<br>
	  Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
    <a href="https://github.com/smallnest" class="mobile-nav-link">github</a>
  
    <a href="http://tr.colobu.com" class="mobile-nav-link">技术流</a>
  
    <a href="/ScalaCollectionsCookbook" class="mobile-nav-link">Scala集合技术手册</a>
  
    <a href="/techreview" class="mobile-nav-link">技术快报</a>
  
    <a href="/about" class="mobile-nav-link">关于</a>
  
</nav>
    
<script src="//cdn.staticfile.org/jquery/1.11.1/jquery.min.js"></script>
<script src="//cdn.bootcss.com/jquery.lazyload/1.9.1/jquery.lazyload.min.js"></script>

<script src="//libs.cncdn.cn/fancybox/2.1.5/jquery.fancybox.pack.js"></script>


<script src="/js/script.js" type="text/javascript"></script>

<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
  });
  MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>
<script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.6.0-beta.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

<div id="totop" style="position:fixed;bottom:150px;right:10px;cursor: pointer;z-index: 2000;">
	<a title="返回顶部"><img src="/images/scrollup.png"/></a>
</div>
<script src="/js/totop.js" type="text/javascript"></script>



<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-142561-4']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>


<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e085d87993250aab11f3e0c15f1c2785";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


  </div>
</body>
</html>