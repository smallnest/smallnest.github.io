<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>微服务的反模式和陷阱 | 鸟窝</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="前几天我写了篇读书笔记: 《产品级微服务的八大原则》，介绍了Uber的SRE工程师 Susan J. Fowler 的免费书: Microservices in Production,文中提出了一个微服务成功与否的唯一标准就是可用性，非常有实践意义。但是这本书偏向于从 SRE （site reliability engineer）的视角看待微服务，对于开发工程师 (SWE, software en">
<meta property="og:type" content="article">
<meta property="og:title" content="微服务的反模式和陷阱">
<meta property="og:url" content="http://colobu.com/2016/11/11/microservices-anti-patterns-and-pitfalls/">
<meta property="og:site_name" content="鸟窝">
<meta property="og:description" content="前几天我写了篇读书笔记: 《产品级微服务的八大原则》，介绍了Uber的SRE工程师 Susan J. Fowler 的免费书: Microservices in Production,文中提出了一个微服务成功与否的唯一标准就是可用性，非常有实践意义。但是这本书偏向于从 SRE （site reliability engineer）的视角看待微服务，对于开发工程师 (SWE, software en">
<meta property="og:image" content="cat.gif">
<meta property="og:image" content="1.png">
<meta property="og:image" content="2.png">
<meta property="og:image" content="3.png">
<meta property="og:image" content="4.png">
<meta property="og:image" content="5.png">
<meta property="og:image" content="6.png">
<meta property="og:image" content="7.png">
<meta property="og:image" content="8.png">
<meta property="og:image" content="9.png">
<meta property="og:image" content="10.png">
<meta property="og:image" content="11.png">
<meta property="og:image" content="12.png">
<meta property="og:image" content="13.png">
<meta property="og:image" content="14.png">
<meta property="og:image" content="15.png">
<meta property="og:image" content="16.png">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="微服务的反模式和陷阱">
<meta name="twitter:description" content="前几天我写了篇读书笔记: 《产品级微服务的八大原则》，介绍了Uber的SRE工程师 Susan J. Fowler 的免费书: Microservices in Production,文中提出了一个微服务成功与否的唯一标准就是可用性，非常有实践意义。但是这本书偏向于从 SRE （site reliability engineer）的视角看待微服务，对于开发工程师 (SWE, software en">

  
    <link rel="alternative" href="/atom.xml" title="鸟窝" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">

  <link href="//cdn.staticfile.org/font-awesome/4.2.0/css/font-awesome.css" rel="stylesheet">
  
  <link rel="stylesheet" href="//libs.cncdn.cn/fancybox/2.1.5/jquery.fancybox.css" media="screen" type="text/css">
  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//cdn.staticfile.org/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->

  <script type="text/javascript">
	//visit my previous blog: http://old.colobu.com just like this http://colobu.com/?=123456
    var blog_url = location.href.toString();
	if (blog_url.indexOf("http://colobu.com/?p=") >= 0) {
		blog_url = blog_url.replace("colobu.com", "old.colobu.com");
		window.location.assign(blog_url);
	} else if (blog_url.indexOf("http://smallnest.gitcafe.com") >= 0) {
		blog_url = blog_url.replace("smallnest.gitcafe.com", "colobu.com");
		window.location.assign(blog_url);
	}  else if (blog_url.indexOf("http://smallnest.gitcafe.io") >= 0) {
		blog_url = blog_url.replace("smallnest.gitcafe.io", "colobu.com");
		window.location.assign(blog_url);
	}
</script>
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap" class="animated bounceInLeft">
        <a href="/" id="logo">鸟窝</a>
      </h1>
      
        <h2 id="subtitle-wrap" class="animated bounceInLeft">
          <a href="/" id="subtitle">大道至简 Simplicity is the ultimate form of sophistication</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/"><i class="fa fa-home">&nbsp;</i>首页</a>
        
          <a class="main-nav-link" href="/archives"><i class="fa fa-folder-o">&nbsp;</i>归档</a>
        
          <a class="main-nav-link" href="https://github.com/smallnest"><i class="fa fa-github">&nbsp;</i>github</a>
        
          <a class="main-nav-link" href="http://tr.colobu.com"><i class="fa fa-spinner fa-pulse">&nbsp;</i>技术流</a>
        
          <a class="main-nav-link" href="/ScalaCollectionsCookbook"><i class="fa fa-book">&nbsp;</i>Scala集合技术手册</a>
        
          <a class="main-nav-link" href="/techreview"><i class="fa fa-newspaper-o">&nbsp;</i>技术快报</a>
        
          <a class="main-nav-link" href="/about"><i class="fa fa-lemon-o">&nbsp;</i>关于</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="http://www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
          <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="Search">
          <input type="submit" value="" class="search-form-submit">
          <input name=tn type=hidden value="bds">
          <input name=cl type=hidden value="3">
          <input name=ct type=hidden value="2097152">
          <input type="hidden" name="si" value="colobu.com">
        </form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-microservices-anti-patterns-and-pitfalls" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/11/11/microservices-anti-patterns-and-pitfalls/" class="article-date">
  <time datetime="2016-11-11T06:28:50.000Z" itemprop="datePublished">2016年11月11日</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Go/">Go</a>
  </div>

	
  <div class="article-author"> by smallnest</div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      微服务的反模式和陷阱
	  
	  <p class="article-subtitle">Microservices AntiPatterns and Pitfalls 读书笔记</p>
	  
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
	  
	    <h1 id="expanderHead" style="cursor:pointer;">
		目录 <span id="expanderSign">[−]</span>
		</h1>
	    <div id="article-entry-toc" data-role="collapsible" class="article-entry-toc">
		  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#数据驱动的迁移反模式"><span class="toc-text">数据驱动的迁移反模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#太多的数据迁移"><span class="toc-text">太多的数据迁移</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#功能分割优先，数据迁移最后"><span class="toc-text">功能分割优先，数据迁移最后</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#超时反模式"><span class="toc-text">超时反模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用超时"><span class="toc-text">使用超时</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用熔断器设计模式"><span class="toc-text">使用熔断器设计模式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#共享反模式"><span class="toc-text">共享反模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#太多依赖"><span class="toc-text">太多依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#共享代码的技术"><span class="toc-text">共享代码的技术</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#到达报告反模式"><span class="toc-text">到达报告反模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#微服务报告的问题"><span class="toc-text">微服务报告的问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Asynchronous_Event_Pushing"><span class="toc-text">Asynchronous Event Pushing</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#沙粒陷阱"><span class="toc-text">沙粒陷阱</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#分析服务的范围和功能"><span class="toc-text">分析服务的范围和功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分析数据库事务"><span class="toc-text">分析数据库事务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分析服务编排"><span class="toc-text">分析服务编排</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#无因的开发者陷阱"><span class="toc-text">无因的开发者陷阱</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#随大流陷阱"><span class="toc-text">随大流陷阱</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#其它架构模式"><span class="toc-text">其它架构模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#静态契约陷阱"><span class="toc-text">静态契约陷阱</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#我们到了吗陷阱"><span class="toc-text">我们到了吗陷阱</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#REST陷阱"><span class="toc-text">REST陷阱</span></a></li></ol>
	    </div>
	  
	  
      
        <p>前几天我写了篇读书笔记: <a href="http://colobu.com/2016/10/16/microservices-in-production-notes/" target="_blank" rel="external">《产品级微服务的八大原则》</a>，介绍了Uber的SRE工程师 Susan J. Fowler 的免费书: <a href="http://www.oreilly.com/programming/free/microservices-in-production.csp" target="_blank" rel="external">Microservices in Production</a>,文中提出了一个微服务成功与否的唯一标准就是可用性，非常有实践意义。但是这本书偏向于从 SRE （site reliability engineer）的视角看待微服务，对于开发工程师 (SWE, software engineer)来说，更关注的是如何正确地从单体程序重构到微服务架构，或者从头设计微服务架构， 这篇读书笔记主要就是介绍这方面的实践和经验。</p>
<p>Oreilly 的 的这本免费小书 <a href="http://www.oreilly.com/programming/free/microservices-antipatterns-and-pitfalls.csp" target="_blank" rel="external">Microservices AntiPatterns and Pitfalls</a>由经验丰富的 Mark Richards 编写。书中将反模式(AntiPattern)定义为&quot;起初看起来很美好，做到最后麻烦不断的实践模式&quot;，而将陷阱(Pitfall)定义为“起初看起来就不是一个好的设计”，书中列举了微服务开发中几种常见的反模式和陷阱，这些经验非常的接地气.他还提供了<a href="http://shop.oreilly.com/product/0636920052876.do" target="_blank" rel="external">视频教程</a>。</p>
<a id="more"></a>
<p><img src="cat.gif" alt=""></p>
<p>2006年 SOA (service-oriented architecture) 狂热流行，无数的公司随着技术潮流拥抱 SOA， 不管它们是否已经完全理解了这种复杂的架构风格的长处和短处，这些公司不可避免地陷入和服务粒度、性能、数据迁移以及SOA组织改变的斗争中，很多公司不得不放弃了 SOA， 或者折衷的建立了一种混杂的架构风格。</p>
<p>历史的悲剧又将重演。微服务是行业当前的发展趋势。现在，微服务就像2000年中期的 SOA 一样是技术的热潮。很多公司都在朝着微服务架构的方式改变，以期获得微服务架构的好处，例如便于测试，快速，易于部署，细粒度的可扩展性，模块化和敏捷性。然而，像 SOA 一样，这些企业开发微服务的时候又陷入了服务粒度，数据迁移，组织形式改变和分布式处理的斗争中。</p>
<p>就像很多新技术一样， 你了解的越深，架构风格、反模式、陷阱就会出现，并且这各个过程中得到不少教训。正如上面所说，反模式就像走到一条正确的路上，走了很久才发现路错了，而陷阱则是开始没多久你就会发现路是不对的。</p>
<p>这本书介绍了几种常用反模式和陷阱，但是明显的是，不可能将微服务所有的反模式和陷阱在这么一本薄薄的书中全部介绍。这些常用的反模式和陷阱包括服务粒度 (沙粒陷阱), data migration (数据驱动的迁移反模式), remote access latency (&quot;我们到了吗&quot;陷阱), reporting (到达报告反模式), contract versioning (静态契约陷阱), service responsiveness (超时反模式)等等。</p>
<h2 id="数据驱动的迁移反模式">数据驱动的迁移反模式</h2>
<p><strong>Data-Driven Migration AntiPattern</strong></p>
<p>微服务会创建大量小的、分布式的、单一用途的服务，每个服务拥有自己的数据。这种服务和数据耦合支持一个有界的上下文和一个无共享数据的架构，其中，每个服务及其对应的数据是独立一块，完全独立于所有其他服务。服务只暴露了一个明确的接口（服务契约）。有界的上下文可以允许开发者以最小的依赖快速轻松地开发，测试和部署。</p>
<p>采用数据驱动的迁移反模式大多是当你从一个单体(monolithic)应用程序到微服务架构迁移的时候。我们将之称为反模式原因是，它似乎是在开始创建微服务的时候看起来是一个好主意，服务和相应的数据独立成一个微服务，非常的美好，但正如书中接下来介绍的，这可能会将你引向一个错误的道路上，问题是高风险，过剩成本和额外的迁移工作。</p>
<p>单体应用迁移到微服务架构有两个主要目标：第一个目标是单体应用程序的功能分割成小的，单一用途的服务。第二个目标是单体应用的数据迁移到每个服务自己独占的小数据库（或独立的服务）。</p>
<p><img src="1.png" alt="图片来源: Oreilly"></p>
<p>如上图所示，理想很丰满,但是现实很骨感。</p>
<h3 id="太多的数据迁移">太多的数据迁移</h3>
<p>这种迁移最主要的问题是你很难一次将数据库的粒度很好的分割成独立的每个微服务独占的数据。</p>
<p>当然你开始可以分割成粗粒度的数据和服务，然后再进一步的分割成更小的微服务和数据，你可能要频繁地进行服务调整：粒度太小，合并微服务；粒度太大，分割成更小的微服务。数据迁移要比源代码迁移更复杂，更容易出错，理想情况下只为微服务迁移数据一次。理解数据迁移的风险性是避免这种反模式的第一步。</p>
<h3 id="功能分割优先，数据迁移最后">功能分割优先，数据迁移最后</h3>
<p>避免这种反模式的主要技术就是首先迁移功能，然后再考虑划分这个微服务和它的数据的有界上下文。<br><img src="2.png" alt="图片来源: Oreilly"></p>
<h2 id="超时反模式">超时反模式</h2>
<p>微服务是一种分布式的架构，它所有的组件（也就是服务）会被部署为单独的应用程序，并通过某种远程访问协议进行通讯。分布式应用的挑战之一就是如何管理远程服务的可用性和它们的响应。虽然服务可用性和服务响应都涉及到服务的通信，但它们是两个完全不同的东西。服务可用性是服务消费者连接服务并能够发送请求的能力，服务响应则关注服务的响应时间。</p>
<p><img src="3.png" alt="图片来源: Oreilly"></p>
<p>如果服务不可用，服务消费者会在毫秒级的时间内得到通知，它可以返回错误信息或者尝试连接。但是如果服务接收了请求但是不响应，服务消费者该怎么办？可以无限等待或者设置一个超时时间。</p>
<p>超时看起来也挺不错，但也会导致反模式。</p>
<h3 id="使用超时">使用超时</h3>
<p>你可能很困惑，难道不应该设置一个超时时间吗？你理解的很对，但是在大部分的情况超时时间的错误设置会带来问题。比如当你买东西的时候，你提交了订单，服务一直在处理没有返回，你在超时的时候再提交订单，显然服务器需要更复杂的逻辑来处理重复提交订单的问题。</p>
<p>所以你可能不想设置超时时间太短，但是多少合适呢？一种基于数据库的超时来计算服务的超时时间，另一种更常用，计算大压力下最长的处理时间，把它乘以2作为超时时间。但是这个值可能非常的不合适，有可能用户觉得等待太久就把页面关了，所以还的寻找更好的方式。</p>
<h3 id="使用熔断器设计模式">使用熔断器设计模式</h3>
<p><strong>Circuit Breaker Pattern</strong></p>
<p>这种设计模式就像家里的电器的保险丝一样，当负载过大，或者电路发生故障或异常时，电流会不断升高，为防止升高的电流有可能损坏电路中的某些重要器件或贵重器件，烧毁电路甚至造成火灾。保险丝会在电流异常升高到一定的高度和热度的时候，自身熔断切断电流，从而起到保护电路安全运行的作用。</p>
<p>当一个软件熔断器监测到服务没有响应的时候，它就会熔断，拒绝请求。一旦服务恢复，熔断器就会接上，允许服务通过。</p>
<p><img src="4.png" alt="图片来源: Oreilly"></p>
<p>熔断器有多种方式监控服务的可用性，最简单的方式就是心跳检查，也可以用调用虚拟的服务精确监测，还可以实时地监控服务调用的状态，一旦到达一个阈值，则熔断器进入限流的状态。</p>
<h2 id="共享反模式">共享反模式</h2>
<p><strong>I Was Taught to Share&quot; AntiPattern</strong></p>
<p>微服务是一种无共享的架构，我更倾向于叫它为&quot;尽量不分享&quot;模式(share-as-little-as-possible)， 因为总有一些代码会在微服务之间共享。比如不提供一个身份验证的微服务，而是将身份验证的代码打包成一个jar文件：<code>security.jar</code>，其它服务都能使用。如果安全检查是服务级别的功能，每个服务接收到请求都会检查安全性，这种方式可以很好的提高性能。</p>
<p>但是这容易引起&quot;依赖噩梦&quot;：</p>
<p><img src="5.png" alt="图片来源: Oreilly"></p>
<h3 id="太多依赖">太多依赖</h3>
<p>如果你使用面向对象的开发语言，肯定会遇到下面的继承关系，成百的模块拆成微服务的时候都会依赖很多的共享库。</p>
<p><img src="6.png" alt="图片来源: Oreilly"></p>
<p>微服务的目标之一就是尽量少的共享，这会帮助微服务确定它的有界上下文，服务更容易的测试和部署。服务之间依赖越多，服务则更难被隔离。</p>
<h3 id="共享代码的技术">共享代码的技术</h3>
<p>说起来容易做起来难,下图介绍了代码共享带来问题的四种场景。</p>
<p><img src="7.png" alt="图片来源: Oreilly"></p>
<p>前三种的共享代码的方式好理解，第四种方式是将共享代码的逻辑分割出来，做成一个单独的服务，比如身份验证服务。</p>
<p>对于共享库来说，不要把所有共享的代码放在一个库中，比如<code>common.jar</code>,而是根据它们的逻辑划分成更小的库，比如<code>security.jar</code>, <code>persistence.jar</code>, <code>dateutils.jar</code>。</p>
<h2 id="到达报告反模式">到达报告反模式</h2>
<p><strong>Reach-in Reporting AntiPattern</strong></p>
<p>有四种方式可以处理微服务架构中的报告。</p>
<ul>
<li>database pull model</li>
<li>HTTP pull model</li>
<li>batch pull model</li>
<li>event-based push model</li>
</ul>
<p>前三个模型都是从微服务自己的数据库中拉取数据，所以这个反模式就叫&quot;rearch-in reporting&quot;。既然前三种会出现这中反模式，我们就先看看为什么它们会带来麻烦。</p>
<h3 id="微服务报告的问题">微服务报告的问题</h3>
<p>问题有两面：</p>
<ol>
<li>如何定时的获取报告的数据?</li>
<li>仍然保持着微服务和数据的的有界上下文?</li>
</ol>
<p>下图是database pull model,直接访问数据库，这会带来数据库的非独立性。<br><img src="8.png" alt="图片来源: Oreilly"></p>
<p>下图是HTTP pull model,微服务提供数据报告接口，但是会影响微服务的性能，尤其是复杂报告的查询。<br><img src="9.png" alt="图片来源: Oreilly"></p>
<p>下图是batch pull model,批处理程序成批地将微服务的数据倒入到报告的数据库中，但是问题和HTTP pull model一样，这会带来数据库的非独立性，微服务数据库格式的改变也会影响报告服务。<br><img src="10.png" alt="图片来源: Oreilly"></p>
<h3 id="Asynchronous_Event_Pushing">Asynchronous Event Pushing</h3>
<p>下图是event-based push model，也叫 data pump。虽然相对复杂，但是不会违背本节开始提出的两个问题。<br><img src="11.png" alt="图片来源: Oreilly"></p>
<h2 id="沙粒陷阱">沙粒陷阱</h2>
<p><strong>Grains of Sand Pitfall</strong></p>
<p>架构师和开发人员在采用微服务架构的时候最大的挑战之一就是服务粒度的问题。微服务的服务粒度多大合适？服务粒度至关重要，它会影响应用的性能、健壮性、可靠性、可测性、设置发布模型。</p>
<p>当服务的粒度太小的时候就会遇到沙粒陷阱。微服务的微并不意味着服务越小越好，但是多小是小？</p>
<p>如果你检视一下微服务实现的项目，会发现很多一个类实现的微服务，在这种情况下会容易遇到沙粒陷阱。</p>
<p>当然微服务的粒度并不是靠服务实现的类的数量所决定的，有些服务很简单，只需一个简单的类就可以实现，而有些确需要更多的类。既然类的数量不能用来决定微服务的粒度，那么用什么标准来衡量微服务的粒度是合适的呢？主要依赖：服务的范围(scope)和功能(functionality)、数据库事务的需求以及服务编排的等级。</p>
<h3 id="分析服务的范围和功能">分析服务的范围和功能</h3>
<p>服务要做什么？有那些操作？</p>
<p>完整性(Cohesion)扮演了很重要的角色。比如一个顾客服务(customer service)有下面的操作：</p>
<ul>
<li>add_customer</li>
<li>update_customer</li>
<li>get_customer</li>
<li>notify_customer</li>
<li>record_customer_comments</li>
<li>get_customer_comments</li>
</ul>
<p>前三个操作是相关的，它们用来管理和维护顾客信息。但是后三个并不和基本的CRUD操作相关。在分析这个服务的完整性的时候，我们就比较清晰了，这个服务可以被分成三个服务：顾客信息服务、顾客通知服务和顾客评论服务。</p>
<p><img src="12.png" alt="图片来源: Oreilly"></p>
<p>Sam Newman提供了一个很好的可操作的方法，开始不妨将服务划分成粗粒度的服务，随着对服务了解更多，再进一步划分成更小粒度的服务。</p>
<h3 id="分析数据库事务">分析数据库事务</h3>
<p>数据库事务更正式的叫做 <strong>ACID</strong> 事务 （atomicity, consistency, isolation, and durability）。ACID事务封装多个数据库更新为一个工作单元，工作单元要不整体完成，要不就出现错误而回滚。</p>
<p>因为微服务架构中服务是分布式的独立的应用，再两个或者多个服务之间维护 ACID 事务就极度困难，所以微服务架构中经常会依赖 <strong>BASE</strong> (basic availability, soft state, and eventual consistency)。尽管如此，你还是再特定的服务中要使用 ACID 事务。当你需要在 ACID vs. BASE 事务中做艰难的决定的时候，可能你的服务划分的就太细了。</p>
<p>当发现不能使用最终一致性时，你通常就会把服务从细粒度调整为粗粒度的服务，如图所示。</p>
<p><img src="13.png" alt="图片来源: Oreilly"></p>
<h3 id="分析服务编排">分析服务编排</h3>
<p>第三个衡量方式是分析服务编排。服务编排是指服务之间的通讯，通常也指内部服务通讯。<br>远程调用服务是需要花时间的，它会降低应用整体的性能。再者，它也会影响服务的健壮性和可靠性。</p>
<p>如果你发现完成一个逻辑请求需要调用太多的服务时，服务的划分可能粒度就太小了。</p>
<p><img src="14.png" alt="图片来源: Oreilly"></p>
<p>整合服务、合并到更粗粒度可以提升应用的整体性能，提高应用的健壮性和可靠性。你还可以移除服务之间的依赖，可以更好的控制、测试和发布。</p>
<p>当然你可能会说调用多个服务可以并行的执行，提到应用的响应，比如 reactive 架构的异步编程方式， 关键还是要权衡利弊，  确保对用户的及时响应以及系统整体的可靠性。</p>
<h2 id="无因的开发者陷阱">无因的开发者陷阱</h2>
<p><strong>Developer Without a Cause Pitfall</strong></p>
<p>名字来自詹姆斯·迪恩演的电影<a href="https://movie.douban.com/subject/1295416/" target="_blank" rel="external">《无因的反叛》</a>（Rebel Without a Cause），一个问题青年因为错误的原因做了错误的决定。</p>
<p>很多架构师和开发者在微服务的开发中权衡利弊， 比如服务粒度和运维工具，但是基于错误的原因，做了错误的决定。</p>
<p>下图就是一个场景。服务被认为粒度太细，影响性能和可靠性，所以要迁移到一个单一的粒度更粗的服务上。</p>
<p><img src="15.png" alt="图片来源: Oreilly"></p>
<p>看起来合情合理，但是没有考虑tradeoff。发布、改变控制、测试都深受影响。</p>
<p>下面正好相反，将粗粒度服务划分成细粒度的服务。</p>
<p><img src="16.png" alt="图片来源: Oreilly"></p>
<p>如果你不考虑这种改变带来的tradeoff，可能影响是很大的。</p>
<p>作者指出，要深刻理解选择微服务后面的商业驱动。</p>
<h2 id="随大流陷阱">随大流陷阱</h2>
<p><strong>Jump on the Bandwagon Pitfall</strong></p>
<p>因为微服务是现在的潮流，所以你选择了微服务，还没有仔细的分析你的商业需求、商业驱动、组织架构和技术环境，这就是随大流陷阱。</p>
<p>微服务并不适合所有的场景。</p>
<p>避免这个陷阱的方式充分理解微服务的好处和短处，俗话说，知己知彼，百战不殆。</p>
<p>好处：</p>
<ul>
<li>发布：易于发布</li>
<li>测试：易于测试</li>
<li>改变控制：更容易的改变一个服务的功能</li>
<li>模块-</li>
<li>规模可扩展</li>
</ul>
<p>短处</p>
<ul>
<li>Team组织改变</li>
<li>性能</li>
<li>可靠性降低</li>
<li>运维难度加大</li>
</ul>
<p>所以理解了微服务的优缺点，结合自己的实际情况，来决定是否要采用微服务。</p>
<h2 id="其它架构模式">其它架构模式</h2>
<p>微服务的架构很好，但是不是唯一的架构模式，比如下面还有一些其它的架构模式：</p>
<ul>
<li>Service-Based Architecture</li>
<li>Service-Oriented Architecture</li>
<li>Layered Architecture</li>
<li>Microkernel Architecture</li>
<li>Space-Based Architecture</li>
<li>Event-Driven Architecture</li>
<li>Pipeline Architecture</li>
</ul>
<p>当然你并不一定只使用唯一的一种架构模式，你可能在系统中混用这些架构模式。</p>
<p>下面有一些架构的参考资料：</p>
<ul>
<li><a href="http://shop.oreilly.com/product/110000195.do" target="_blank" rel="external">Software Architecture Fundamentals: Understanding the Basics</a></li>
<li><a href="http://shop.oreilly.com/product/110000195.do" target="_blank" rel="external">Software Architecture Fundamentals: Beyond the Basics</a></li>
<li><a href="http://shop.oreilly.com/product/0636920042655.do" target="_blank" rel="external">Software Architecture Fundamentals: Service-Based Architecture</a></li>
<li><a href="http://www.oreilly.com/programming/free/software-architecture-patterns.csp" target="_blank" rel="external">Software Architecture Patterns</a></li>
<li><a href="http://www.oreilly.com/programming/free/microservices-vs-service-oriented-architecture.csp" target="_blank" rel="external">Microservices vs. Service-Oriented Architecture</a></li>
</ul>
<h2 id="静态契约陷阱">静态契约陷阱</h2>
<p><strong>The Static Contract Pitfall</strong></p>
<p>这一节主要讲服务的版本控制。入股服务一开始就没有考虑版本控制，服务的schema发生变化时，或者内部实现逻辑有变化时消费者和服务器之间的通讯和业务处理就会发生问题。</p>
<p>所以你要为你的服务设计版本号。</p>
<p>有两种实现方式，在header中加入版本号，或者在服务的schema中加入版本号。</p>
<h2 id="我们到了吗陷阱">我们到了吗陷阱</h2>
<p><strong>Are We There Yet Pitfall</strong></p>
<p>这个陷阱发生在你不知道远程调用要花多长时间的情况。50秒？平均多长时间呢，长尾的延迟呢？</p>
<p>首先你应该测量服务的调用时间，至少能知道一个服务远程调用的大概时间。</p>
<p>然后你应该评估不同的服务通讯协议的性能，比如REST、JMS、AMQP等。</p>
<p>当然性能也不是唯一个衡量远程通讯协议的因素，比如下面一节中讲到的内容。</p>
<h2 id="REST陷阱">REST陷阱</h2>
<p>使用REST风格非常的流行，大部分的软件框架也选择它作为通讯的方式，比如DropWizard, Spring Boot等，有兴趣的读者可以阅读我写的<a href="http://colobu.com/2015/11/17/Jax-RS-Performance-Comparison/" target="_blank" rel="external">Java RESTful框架的性能比较</a>。</p>
<p>既然大家都在用它，还怎么是个陷阱呢？</p>
<p>如果把REST作为唯一的通讯方式，就有可能掉入这个陷阱。比如如何处理异步通讯(http 1.1是blocking的)、如何在一个事务中管理多次服务调用？如何支持广播？</p>
<p>你应该考虑两种类型的消息标准作为微服务架构中的消息传递：特定平台的标准和平台无关的标准。</p>
<p>特定平台的标准比如 JMS for java、MSMQ for .net。平台无关的比如 AMQP。</p>
<p>使用消息系统的好处可以异步请求，还可以实现广播的方式，还可以实现事务请求。</p>
<p>作者是 Java Message Service 第二版的作者之一，所以对消息系统有自己的见解。</p>

      
    </div>
    <footer class="article-footer">
	
<div class="bdsharebuttonbox"><a title="分享到新浪微博" class="bds_tsina" href="#" data-cmd="tsina"></a><a title="分享到微信" class="bds_weixin" href="#" data-cmd="weixin"></a><a title="分享到QQ空间" class="bds_qzone" href="#" data-cmd="qzone"></a><a title="分享到印象笔记" class="bds_evernotecn" href="#" data-cmd="evernotecn"></a><a title="分享到有道云笔记" class="bds_youdao" href="#" data-cmd="youdao"></a><a title="分享到百度云收藏" class="bds_bdysc" href="#" data-cmd="bdysc"></a><a class="bds_more" href="#" data-cmd="more"></a></div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>
      

	  
        <a href="http://colobu.com/2016/11/11/microservices-anti-patterns-and-pitfalls/#comments" class="article-comment-link">评论</a>
      

      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/11/17/Benchmarking-Scala-Collections/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          [译]Scala Collection的性能
        
      </div>
    </a>
  
  
    <a href="/2016/11/05/golang-18-whats-coming/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">[译]Go 1.8 新特性</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div class="ds-thread" data-thread-key="2016/11/11/microservices-anti-patterns-and-pitfalls/" data-title="微服务的反模式和陷阱" data-url="http://colobu.com/2016/11/11/microservices-anti-patterns-and-pitfalls/"></div>

</section>

</section>
        
          <aside id="sidebar">
  
      <div class="widget-wrap">
    <h3 class="widget-title">原创图书</h3>
    <div class="widget">
      <a href="/ScalaCollectionsCookbook/">
        <img width="100%" src="/ScalaCollectionsCookbook/scala_collections_cookbook.jpg">
        <img width="100%" src="/ScalaCollectionsCookbook/scala_collections_cookbook_tw.png">
      </a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/DOTNET/">DOTNET</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Go/">Go</a><span class="category-list-count">53</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">58</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Scala/">Scala</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端开发/">前端开发</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/大数据/">大数据</a><span class="category-list-count">54</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工具/">工具</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/架构/">架构</a><span class="category-list-count">21</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/管理/">管理</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络编程/">网络编程</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/读书笔记/">读书笔记</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/运维/">运维</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/高并发编程/">高并发编程</a><span class="category-list-count">20</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/Android/" style="font-size: 15.71px;">Android</a><a href="/tags/ApacheBench/" style="font-size: 11.43px;">ApacheBench</a><a href="/tags/Bower/" style="font-size: 10.00px;">Bower</a><a href="/tags/C/" style="font-size: 10.00px;">C#</a><a href="/tags/CDN/" style="font-size: 10.00px;">CDN</a><a href="/tags/CQRS/" style="font-size: 10.00px;">CQRS</a><a href="/tags/CRC/" style="font-size: 10.00px;">CRC</a><a href="/tags/CSS/" style="font-size: 11.43px;">CSS</a><a href="/tags/CompletableFuture/" style="font-size: 10.00px;">CompletableFuture</a><a href="/tags/Comsat/" style="font-size: 10.00px;">Comsat</a><a href="/tags/Curator/" style="font-size: 20.00px;">Curator</a><a href="/tags/DSL/" style="font-size: 10.00px;">DSL</a><a href="/tags/Disruptor/" style="font-size: 10.00px;">Disruptor</a><a href="/tags/Docker/" style="font-size: 11.43px;">Docker</a><a href="/tags/Ember/" style="font-size: 11.43px;">Ember</a><a href="/tags/FastJson/" style="font-size: 10.00px;">FastJson</a><a href="/tags/Fiber/" style="font-size: 10.00px;">Fiber</a><a href="/tags/GAE/" style="font-size: 10.00px;">GAE</a><a href="/tags/GC/" style="font-size: 12.86px;">GC</a><a href="/tags/Gnuplot/" style="font-size: 10.00px;">Gnuplot</a><a href="/tags/Go/" style="font-size: 11.43px;">Go</a><a href="/tags/Gradle/" style="font-size: 10.00px;">Gradle</a><a href="/tags/Grunt/" style="font-size: 10.00px;">Grunt</a><a href="/tags/Gulp/" style="font-size: 10.00px;">Gulp</a><a href="/tags/Hadoop/" style="font-size: 10.00px;">Hadoop</a><a href="/tags/Hazelcast/" style="font-size: 10.00px;">Hazelcast</a><a href="/tags/Ignite/" style="font-size: 10.00px;">Ignite</a><a href="/tags/JVM/" style="font-size: 10.00px;">JVM</a><a href="/tags/Java/" style="font-size: 17.14px;">Java</a><a href="/tags/Kafka/" style="font-size: 18.57px;">Kafka</a><a href="/tags/Lambda/" style="font-size: 14.29px;">Lambda</a><a href="/tags/Linux/" style="font-size: 12.86px;">Linux</a><a href="/tags/LongAdder/" style="font-size: 10.00px;">LongAdder</a><a href="/tags/MathJax/" style="font-size: 10.00px;">MathJax</a><a href="/tags/Maven/" style="font-size: 11.43px;">Maven</a><a href="/tags/Memcached/" style="font-size: 10.00px;">Memcached</a><a href="/tags/Metrics/" style="font-size: 10.00px;">Metrics</a><a href="/tags/Mongo/" style="font-size: 12.86px;">Mongo</a><a href="/tags/Netty/" style="font-size: 15.71px;">Netty</a><a href="/tags/Node/" style="font-size: 10.00px;">Node</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">July 2015</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">June 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">May 2015</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">April 2015</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">March 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/02/">February 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">January 2015</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">December 2014</a><span class="archive-list-count">28</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/11/">November 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/10/">October 2014</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">September 2014</a><span class="archive-list-count">28</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">August 2014</a><span class="archive-list-count">19</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/07/">July 2014</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">近期文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/01/05/-T-or-T-it-s-a-question/">[]T 还是 []*T, 这是一个问题</a>
          </li>
        
          <li>
            <a href="/2016/12/24/a-featured-fsm/">一个有特色的有限状态机</a>
          </li>
        
          <li>
            <a href="/2016/12/21/how-to-dump-goroutine-stack-traces/">调试利器：dump goroutine 的 stacktrace</a>
          </li>
        
          <li>
            <a href="/2016/12/20/detect-and-link-references-in-github/">Github和gitlab的自动连接</a>
          </li>
        
          <li>
            <a href="/2016/12/10/Food-Chain-of-Premier-League/">使用算法检测英超中的食物链</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">友情链接</h3>
    <div class="widget">
      <ul>
        
          <li>
			 
            <a href="http://old.colobu.com" target="_blank">旧的博客</a>
			
          </li>
        
          <li>
			 
			&nbsp;
			
          </li>
        
          <li>
			 
            <a href="http://stackshare.io" target="_blank">技术栈</a>
			
          </li>
        
          <li>
			 
			&nbsp;
			
          </li>
        
          <li>
			 
            <a href="http://weekly.manong.io/issues/" target="_blank">码农周刊</a>
			
          </li>
        
          <li>
			 
            <a href="http://www.tuicool.com/mags" target="_blank">编程狂人周刊</a>
			
          </li>
        
          <li>
			 
            <a href="http://www.importnew.com/" target="_blank">importnew</a>
			
          </li>
        
          <li>
			 
            <a href="http://ifeve.com/" target="_blank">并发编程网</a>
			
          </li>
        
          <li>
			 
			&nbsp;
			
          </li>
        
          <li>
			 
            <a href="http://github.com" target="_blank">github</a>
			
          </li>
        
          <li>
			 
            <a href="http://stackoverflow.com/" target="_blank">stackoverflow</a>
			
          </li>
        
          <li>
			 
            <a href="http://www.javacodegeeks.com/" target="_blank">javacodegeeks</a>
			
          </li>
        
          <li>
			 
            <a href="http://www.infoq.com/" target="_blank">infoq</a>
			
          </li>
        
          <li>
			 
            <a href="http://www.dzone.com/links/index.html" target="_blank">dzone</a>
			
          </li>
        
          <li>
			 
            <a href="https://oj.leetcode.com/problems/" target="_blank">leetcode</a>
			
          </li>
        
          <li>
			 
			&nbsp;
			
          </li>
        
          <li>
			 
            <a href="http://www.503error.com/" target="_blank">503error</a>
			
          </li>
        
      </ul>
    </div>
  </div>

  
      <div class="widget-wrap">
    <h3 class="widget-title">热评文章</h3>
    <div class="widget">
		<div class="ds-top-threads" data-range="monthly" data-num-items="5"></div>
    </div>
  </div>

  
      <div class="widget-wrap">
    <h3 class="widget-title">最新评论</h3>
    <div class="widget">
		<ul class="ds-recent-comments" data-num-items="10" data-show-avatars="1" data-show-time="1" data-show-admin="1" data-excerpt-length="70"></ul>
		<script type="text/javascript">
		var duoshuoQuery = {short_name:"colobu"};
		(function() {
			var ds = document.createElement('script');
			ds.type = 'text/javascript';ds.async = true;
			ds.src = 'http://static.duoshuo.com/embed.js';
			ds.charset = 'UTF-8';
			(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
		})();
		</script>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 smallnest<br>
	  Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
    <a href="https://github.com/smallnest" class="mobile-nav-link">github</a>
  
    <a href="http://tr.colobu.com" class="mobile-nav-link">技术流</a>
  
    <a href="/ScalaCollectionsCookbook" class="mobile-nav-link">Scala集合技术手册</a>
  
    <a href="/techreview" class="mobile-nav-link">技术快报</a>
  
    <a href="/about" class="mobile-nav-link">关于</a>
  
</nav>
    
<script src="//cdn.staticfile.org/jquery/1.11.1/jquery.min.js"></script>
<script src="//cdn.bootcss.com/jquery.lazyload/1.9.1/jquery.lazyload.min.js"></script>

<script src="//libs.cncdn.cn/fancybox/2.1.5/jquery.fancybox.pack.js"></script>


<script src="/js/script.js" type="text/javascript"></script>

<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
  });
  MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>
<script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.6.0-beta.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

<div id="totop" style="position:fixed;bottom:150px;right:10px;cursor: pointer;z-index: 2000;">
	<a title="返回顶部"><img src="/images/scrollup.png"/></a>
</div>
<script src="/js/totop.js" type="text/javascript"></script>



<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-142561-4']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>


<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e085d87993250aab11f3e0c15f1c2785";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


  </div>
</body>
</html>