<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Kafka 内幕：源代码High level分析 | 鸟窝</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="本文主要介绍了Kafka High level的代码架构和主要的类。">
<meta property="og:type" content="article">
<meta property="og:title" content="Kafka 内幕：源代码High level分析">
<meta property="og:url" content="http://colobu.com/2015/03/23/kafka-internals/">
<meta property="og:site_name" content="鸟窝">
<meta property="og:description" content="本文主要介绍了Kafka High level的代码架构和主要的类。">
<meta property="og:image" content="https://cwiki.apache.org/confluence/download/attachments/27849051/kafka%20broker%20internals.png?version=2&modificationDate=1339174967000&api=v2">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Kafka 内幕：源代码High level分析">
<meta name="twitter:description" content="本文主要介绍了Kafka High level的代码架构和主要的类。">

  
    <link rel="alternative" href="/atom.xml" title="鸟窝" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">

  <link href="//cdn.staticfile.org/font-awesome/4.2.0/css/font-awesome.css" rel="stylesheet">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.7/css/jquery.fancybox.min.css" media="screen" type="text/css">
  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//cdn.staticfile.org/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->

  <script type="text/javascript">
	//visit my previous blog: http://old.colobu.com just like this http://colobu.com/?=123456
    var blog_url = location.href.toString();
	if (blog_url.indexOf("http://colobu.com/?p=") >= 0) {
		blog_url = blog_url.replace("colobu.com", "old.colobu.com");
		window.location.assign(blog_url);
	} else if (blog_url.indexOf("http://smallnest.gitcafe.com") >= 0) {
		blog_url = blog_url.replace("smallnest.gitcafe.com", "colobu.com");
		window.location.assign(blog_url);
	}  else if (blog_url.indexOf("http://smallnest.gitcafe.io") >= 0) {
		blog_url = blog_url.replace("smallnest.gitcafe.io", "colobu.com");
		window.location.assign(blog_url);
	}
</script>
  <style type="text/css">
    .news-essay
    {
      display: inline !important;
    }
    .hot-news
    {
      text-align: left !important;
    }
  </style>
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap" class="animated bounceInLeft">
        <a href="/" id="logo">鸟窝</a>
      </h1>
      
        <h2 id="subtitle-wrap" class="animated bounceInLeft">
          <a href="/" id="subtitle">大道至简 Simplicity is the ultimate form of sophistication</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/"><i class="fa fa-home">&nbsp;</i>首页</a>
        
          <a class="main-nav-link" href="/archives"><i class="fa fa-folder-o">&nbsp;</i>归档</a>
        
          <a class="main-nav-link" href="https://github.com/smallnest"><i class="fa fa-github">&nbsp;</i>github</a>
        
          <a class="main-nav-link" href="/goasm"><i class="fa fa-language">&nbsp;</i>Go汇编示例</a>
        
          <a class="main-nav-link" href="/ScalaCollectionsCookbook"><i class="fa fa-book">&nbsp;</i>Scala集合技术手册</a>
        
          <a class="main-nav-link" href="/techreview"><i class="fa fa-newspaper-o">&nbsp;</i>技术快报</a>
        
          <a class="main-nav-link" href="/about"><i class="fa fa-lemon-o">&nbsp;</i>关于</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="http://www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
          <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="Search">
          <input type="submit" value="" class="search-form-submit">
          <input name=tn type=hidden value="bds">
          <input name=cl type=hidden value="3">
          <input name=ct type=hidden value="2097152">
          <input type="hidden" name="si" value="colobu.com">
        </form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-kafka-internals" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/03/23/kafka-internals/" class="article-date">
  <time datetime="2015-03-23T03:00:45.000Z" itemprop="datePublished">2015年03月23日</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/大数据/">大数据</a>
  </div>

	
  <div class="article-author"> by smallnest</div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Kafka 内幕：源代码High level分析
	  
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
	  
	    <h1 id="expanderHead" style="cursor:pointer;">
		目录 <span id="expanderSign">[−]</span>
		</h1>
	    <div id="article-entry-toc" data-role="collapsible" class="article-entry-toc">
		  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Boker_架构"><span class="toc-text">Boker 架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#network_layer"><span class="toc-text">network layer</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#a-_Boker在启动的时候会调用SocketServer的startup方法。"><span class="toc-text">a. Boker在启动的时候会调用SocketServer的startup方法。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#b-_它为每个Processor生成一个线程并启动，然后启动一个Acceptor线程。"><span class="toc-text">b. 它为每个Processor生成一个线程并启动，然后启动一个Acceptor线程。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#c-_它会将新的连接均匀地分配给一个Processor。通过accept方法配置网络参数，并交给processor读写数据。"><span class="toc-text">c. 它会将新的连接均匀地分配给一个Processor。通过accept方法配置网络参数，并交给processor读写数据。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#d-_Processor的accept方法将新连接加入它的新连接待处理队列中"><span class="toc-text">d. Processor的accept方法将新连接加入它的新连接待处理队列中</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#e-_Processor线程的主处理逻辑如下，_这是一个死循环，会一直处理这些连接的读写"><span class="toc-text">e. Processor线程的主处理逻辑如下， 这是一个死循环，会一直处理这些连接的读写</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#f-_我们看看read和write是怎么实现的。"><span class="toc-text">f. 我们看看read和write是怎么实现的。</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#API_layer"><span class="toc-text">API layer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Replication_subsystem"><span class="toc-text">Replication subsystem</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Log_subsystem"><span class="toc-text">Log subsystem</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#offsetManager"><span class="toc-text">offsetManager</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#topicConfigManager"><span class="toc-text">topicConfigManager</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#其它类"><span class="toc-text">其它类</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Metrics"><span class="toc-text">Metrics</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Producer"><span class="toc-text">Producer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Consumer"><span class="toc-text">Consumer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考文档"><span class="toc-text">参考文档</span></a></li></ol>
	    </div>
	  
	  
      
        <p>本文主要介绍了Kafka High level的代码架构和主要的类。<br><img src="https://cwiki.apache.org/confluence/download/attachments/27849051/kafka%20broker%20internals.png?version=2&amp;modificationDate=1339174967000&amp;api=v2" alt=""><br><a id="more"></a></p>
<h2 id="Boker_架构">Boker 架构</h2>
<h3 id="network_layer">network layer</h3>
<p>Kafka使用NIO自己实现了网络层的代码， 而不是采用netty, mina等第三方的网络框架。从性能上来讲，这一块的代码不是性能的瓶颈。<br>它采用IO多路复用和多线程下的Reactor模式,主要实现类包括<code>SocketServer</code>, <code>Acceptor</code>, <code>Processor</code>和<code>RequestChannel</code>。</p>
<p>Kafka的服务器由<code>SocketServer</code>实现,它是一个NIO的服务器，线程模型如下：</p>
<ul>
<li>1个Acceptor线程负责处理新连接</li>
<li>N个Processor线程， 每个processor都有自己的selector，负责从socket中读取请求和发送response</li>
<li>M个Handler线程处理请求，并产生response给processor线程</li>
</ul>
<p>可以从上面的图形中看到Acceptor, Processor和Handler的功能。</p>
<h4 id="a-_Boker在启动的时候会调用SocketServer的startup方法。">a. Boker在启动的时候会调用SocketServer的<code>startup</code>方法。</h4>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> startup() {</div><div class="line">    ......</div><div class="line">    <span class="keyword">for</span>(i &lt;- <span class="number">0</span> until numProcessorThreads) {</div><div class="line">      processors(i) = <span class="keyword">new</span> Processor(i, </div><div class="line">                                    time, </div><div class="line">                                    maxRequestSize, </div><div class="line">                                    aggregateIdleMeter,</div><div class="line">                                    newMeter(<span class="string">"IdlePercent"</span>, <span class="string">"percent"</span>, TimeUnit.NANOSECONDS, Map(<span class="string">"networkProcessor"</span> -&gt; i.toString)),</div><div class="line">                                    numProcessorThreads, </div><div class="line">                                    requestChannel,</div><div class="line">                                    quotas,</div><div class="line">                                    connectionsMaxIdleMs)</div><div class="line">      Utils.newThread(<span class="string">"kafka-network-thread-%d-%d"</span>.format(port, i), processors(i), <span class="keyword">false</span>).start()</div><div class="line">    }</div><div class="line"></div><div class="line">    ......</div><div class="line">    <span class="comment">// start accepting connections</span></div><div class="line">    <span class="keyword">this</span>.acceptor = <span class="keyword">new</span> Acceptor(host, port, processors, sendBufferSize, recvBufferSize, quotas)</div><div class="line">    Utils.newThread(<span class="string">"kafka-socket-acceptor"</span>, acceptor, <span class="keyword">false</span>).start()</div><div class="line">    acceptor.awaitStartup</div><div class="line">    ......</div><div class="line">  }</div></pre></td></tr></table></figure>

<h4 id="b-_它为每个Processor生成一个线程并启动，然后启动一个Acceptor线程。">b. 它为每个Processor生成一个线程并启动，然后启动一个<code>Acceptor</code>线程。</h4>
<p><code>Acceptor</code>是一个典型NIO 处理新连接的方法类：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span>[kafka] <span class="class"><span class="keyword">class</span> <span class="title">Acceptor</span><span class="params">(...)</span> <span class="keyword">extends</span> <span class="title">AbstractServerThread</span><span class="params">(connectionQuotas)</span> </span>{</div><div class="line">	<span class="keyword">val</span> serverChannel = openServerSocket(host, port)</div><div class="line">	<span class="keyword">def</span> run() {</div><div class="line">		serverChannel.register(selector, SelectionKey.OP_ACCEPT);</div><div class="line">		......</div><div class="line">		<span class="keyword">while</span>(isRunning) {</div><div class="line">		  <span class="keyword">val</span> ready = selector.select(<span class="number">500</span>)</div><div class="line">		  <span class="keyword">if</span>(ready &gt; <span class="number">0</span>) {</div><div class="line">			<span class="keyword">val</span> keys = selector.selectedKeys()</div><div class="line">			<span class="keyword">val</span> iter = keys.iterator()</div><div class="line">			<span class="keyword">while</span>(iter.hasNext && isRunning) {</div><div class="line">				......</div><div class="line">				accept(key, processors(currentProcessor))</div><div class="line">				......</div><div class="line">				currentProcessor = (currentProcessor + <span class="number">1</span>) % processors.length</div><div class="line">			}</div><div class="line">		  }</div><div class="line">		}</div><div class="line">		......</div><div class="line">	}</div><div class="line"></div><div class="line">}</div></pre></td></tr></table></figure>

<h4 id="c-_它会将新的连接均匀地分配给一个Processor。通过accept方法配置网络参数，并交给processor读写数据。">c. 它会将新的连接均匀地分配给一个Processor。通过<code>accept</code>方法配置网络参数，并交给processor读写数据。</h4>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> accept(key: SelectionKey, processor: Processor) {</div><div class="line">    <span class="keyword">val</span> serverSocketChannel = key.channel().asInstanceOf[ServerSocketChannel]</div><div class="line">    <span class="keyword">val</span> socketChannel = serverSocketChannel.accept()</div><div class="line">    <span class="keyword">try</span> {</div><div class="line">      connectionQuotas.inc(socketChannel.socket().getInetAddress)</div><div class="line">      socketChannel.configureBlocking(<span class="keyword">false</span>)</div><div class="line">      socketChannel.socket().setTcpNoDelay(<span class="keyword">true</span>)</div><div class="line">      socketChannel.socket().setSendBufferSize(sendBufferSize)</div><div class="line">	  </div><div class="line">      processor.accept(socketChannel)</div><div class="line">    } <span class="keyword">catch</span> {</div><div class="line">      <span class="keyword">case</span> e: TooManyConnectionsException =&gt;</div><div class="line">        info(<span class="string">"Rejected connection from %s, address already has the configured maximum of %d connections."</span>.format(e.ip, e.count))</div><div class="line">        close(socketChannel)</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<h4 id="d-_Processor的accept方法将新连接加入它的新连接待处理队列中">d. Processor的<code>accept</code>方法将新连接加入它的新连接待处理队列中</h4>
<p>在<code>configureNewConnections</code>方法中注册<code>OP_READ</code>。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> accept(socketChannel: SocketChannel) {</div><div class="line">	newConnections.add(socketChannel)</div><div class="line">	wakeup()</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">def</span> configureNewConnections() {</div><div class="line">	<span class="keyword">while</span>(newConnections.size() &gt; <span class="number">0</span>) {</div><div class="line">	  <span class="keyword">val</span> channel = newConnections.poll()</div><div class="line">	  debug(<span class="string">"Processor "</span> + id + <span class="string">" listening to new connection from "</span> + channel.socket.getRemoteSocketAddress)</div><div class="line">	  channel.register(selector, SelectionKey.OP_READ)</div><div class="line">	}</div><div class="line">  }</div></pre></td></tr></table></figure>

<h4 id="e-_Processor线程的主处理逻辑如下，_这是一个死循环，会一直处理这些连接的读写">e. Processor线程的主处理逻辑如下， 这是一个死循环，会一直处理这些连接的读写</h4>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">override</span> <span class="keyword">def</span> run() {</div><div class="line">    ......</div><div class="line">    <span class="keyword">while</span>(isRunning) {</div><div class="line">      <span class="comment">// 为新连接注册OP_READ</span></div><div class="line">      configureNewConnections()</div><div class="line">      <span class="comment">// 为新的response注册OP_WRITE， 它从requestChannel.receiveResponse(processor's id)读取response</span></div><div class="line">      processNewResponses()</div><div class="line">      <span class="keyword">val</span> startSelectTime = SystemTime.nanoseconds</div><div class="line">      </div><div class="line">	  <span class="keyword">val</span> ready = selector.select(<span class="number">300</span>)</div><div class="line">      <span class="keyword">if</span>(ready &gt; <span class="number">0</span>) {</div><div class="line">        <span class="keyword">val</span> keys = selector.selectedKeys()</div><div class="line">        <span class="keyword">val</span> iter = keys.iterator()</div><div class="line">        <span class="keyword">while</span>(iter.hasNext && isRunning) {</div><div class="line">          <span class="keyword">var</span> key: SelectionKey = <span class="keyword">null</span></div><div class="line">          <span class="keyword">try</span> {</div><div class="line">            key = iter.next</div><div class="line">            iter.remove()</div><div class="line">            <span class="keyword">if</span>(key.isReadable)</div><div class="line">              read(key)</div><div class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(key.isWritable)</div><div class="line">              write(key)</div><div class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(!key.isValid)</div><div class="line">              close(key)</div><div class="line">            <span class="keyword">else</span></div><div class="line">              <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unrecognized key state for processor thread."</span>)</div><div class="line">          } <span class="keyword">catch</span> {</div><div class="line">            ......</div><div class="line">          }</div><div class="line">        }</div><div class="line">      }</div><div class="line">      ......</div><div class="line">    }</div><div class="line">    ......</div><div class="line">}</div></pre></td></tr></table></figure>

<p>这也是一个标准的NIO的处理代码。</p>
<h4 id="f-_我们看看read和write是怎么实现的。">f. 我们看看<code>read</code>和<code>write</code>是怎么实现的。</h4>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> read(key: SelectionKey) {</div><div class="line">  ......</div><div class="line">  <span class="keyword">val</span> socketChannel = channelFor(key)</div><div class="line">  <span class="keyword">var</span> receive = key.attachment.asInstanceOf[Receive]</div><div class="line">  <span class="keyword">if</span>(key.attachment == <span class="keyword">null</span>) {</div><div class="line">    receive = <span class="keyword">new</span> BoundedByteBufferReceive(maxRequestSize)</div><div class="line">    key.attach(receive)</div><div class="line">  }</div><div class="line">  <span class="keyword">val</span> read = receive.readFrom(socketChannel)</div><div class="line">  <span class="keyword">val</span> address = socketChannel.socket.getRemoteSocketAddress();</div><div class="line"></div><div class="line">  <span class="keyword">if</span>(read &lt; <span class="number">0</span>) {</div><div class="line">    close(key)</div><div class="line">  } <span class="keyword">else</span> <span class="keyword">if</span>(receive.complete) {</div><div class="line">    <span class="keyword">val</span> req = RequestChannel.Request(processor = id, requestKey = key, buffer = receive.buffer, startTimeMs = time.milliseconds, remoteAddress = address)</div><div class="line">    requestChannel.sendRequest(req)</div><div class="line">    key.attach(<span class="keyword">null</span>)</div><div class="line">    <span class="comment">// explicitly reset interest ops to not READ, no need to wake up the selector just yet</span></div><div class="line">    key.interestOps(key.interestOps & (~SelectionKey.OP_READ))</div><div class="line">  } <span class="keyword">else</span> {</div><div class="line">    <span class="comment">// more reading to be done</span></div><div class="line">    key.interestOps(SelectionKey.OP_READ)</div><div class="line">    wakeup()</div><div class="line">  }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>因为Kafka的消息前四个字节代表(一个int)为后续消息的size,所以首先读取size,接着把一个完整的消息读取出来。<br>如果读取出来一个完整的Request,则将它放到<code>requestChannel</code>中。<br>具体的Kafka消息的格式可以参考<a href="https://cwiki.apache.org/confluence/display/KAFKA/A+Guide+To+The+Kafka+Protocol#AGuideToTheKafkaProtocol-Notesonreadingtherequestformatgrammars" target="_blank" rel="external">A Guide To The Kafka Protocol</a></p>
<p>我们再看看<code>write</code>方法的实现</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> write(key: SelectionKey) {</div><div class="line">  <span class="keyword">val</span> socketChannel = channelFor(key)</div><div class="line">  <span class="keyword">val</span> response = key.attachment().asInstanceOf[RequestChannel.Response]</div><div class="line">  <span class="keyword">val</span> responseSend = response.responseSend</div><div class="line">  <span class="keyword">if</span>(responseSend == <span class="keyword">null</span>)</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Registered for write interest but no response attached to key."</span>)</div><div class="line">  <span class="keyword">val</span> written = responseSend.writeTo(socketChannel)</div><div class="line">  </div><div class="line">  <span class="keyword">if</span>(responseSend.complete) {</div><div class="line">    response.request.updateRequestMetrics()</div><div class="line">    key.attach(<span class="keyword">null</span>)</div><div class="line">    </div><div class="line">    key.interestOps(SelectionKey.OP_READ)</div><div class="line">  } <span class="keyword">else</span> {</div><div class="line">    key.interestOps(SelectionKey.OP_WRITE)</div><div class="line">    wakeup()</div><div class="line">  }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>直到写完一个response,才讲Ops设为<code>OP_READ</code>,否则一直尝试写。</p>
<p>以上是网络层的主要代码逻辑，主要负责Kafka消息的读写。 </p>
<h3 id="API_layer">API layer</h3>
<p>API层的主要功能是由<code>KafkaApis</code>类实现的。<br>根据配置Kafka生成了一组KafkaRequestHandler线程，叫做<code>KafkaRequestHandlerPool</code>:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">KafkaRequestHandlerPool</span><span class="params">(......)</span> <span class="keyword">extends</span> <span class="title">Logging</span> <span class="keyword">with</span> <span class="title">KafkaMetricsGroup</span> </span>{</div><div class="line">  ......</div><div class="line">  <span class="keyword">val</span> threads = <span class="keyword">new</span> Array[Thread](numThreads)</div><div class="line">  <span class="keyword">val</span> runnables = <span class="keyword">new</span> Array[KafkaRequestHandler](numThreads)</div><div class="line">  <span class="keyword">for</span>(i &lt;- <span class="number">0</span> until numThreads) {</div><div class="line">    runnables(i) = <span class="keyword">new</span> KafkaRequestHandler(i, brokerId, aggregateIdleMeter, numThreads, requestChannel, apis)</div><div class="line">    threads(i) = Utils.daemonThread(<span class="string">"kafka-request-handler-"</span> + i, runnables(i))</div><div class="line">    threads(i).start()</div><div class="line">  }</div><div class="line">  .....</div><div class="line">}</div></pre></td></tr></table></figure>

<p>KafkaRequestHandler不断的从<code>requestChannel</code>队列里面取出request交给<code>apis</code>处理。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">KafkaRequestHandler</span><span class="params">(......)</span> <span class="keyword">extends</span> <span class="title">Runnable</span> <span class="keyword">with</span> <span class="title">Logging</span> </span>{</div><div class="line">   <span class="keyword">def</span> run() {</div><div class="line">    <span class="keyword">while</span>(<span class="keyword">true</span>) {</div><div class="line">      <span class="keyword">try</span> {</div><div class="line">        <span class="keyword">var</span> req : RequestChannel.Request = <span class="keyword">null</span></div><div class="line">        <span class="keyword">while</span> (req == <span class="keyword">null</span>) {</div><div class="line">          req = requestChannel.receiveRequest(<span class="number">300</span>)</div><div class="line">        }</div><div class="line">        <span class="keyword">if</span>(req eq RequestChannel.AllDone) {</div><div class="line">          <span class="keyword">return</span></div><div class="line">        }</div><div class="line">        ......</div><div class="line">        apis.handle(req)</div><div class="line">      } <span class="keyword">catch</span> {</div><div class="line">        ......</div><div class="line">      }</div><div class="line">    }</div><div class="line">  }</div><div class="line">  </div><div class="line">}</div></pre></td></tr></table></figure>

<p><code>apis</code>根据不同的请求类型调用不同的方法进行处理。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> handle(request: RequestChannel.Request) {</div><div class="line">    <span class="keyword">try</span>{</div><div class="line">      request.requestId <span class="keyword">match</span> {</div><div class="line">        <span class="keyword">case</span> RequestKeys.ProduceKey =&gt; handleProducerRequest(request)</div><div class="line">        <span class="keyword">case</span> RequestKeys.FetchKey =&gt; handleFetchRequest(request)</div><div class="line">        <span class="keyword">case</span> RequestKeys.OffsetsKey =&gt; handleOffsetRequest(request)</div><div class="line">        <span class="keyword">case</span> RequestKeys.MetadataKey =&gt; handleTopicMetadataRequest(request)</div><div class="line">        <span class="keyword">case</span> RequestKeys.LeaderAndIsrKey =&gt; handleLeaderAndIsrRequest(request)</div><div class="line">        <span class="keyword">case</span> RequestKeys.StopReplicaKey =&gt; handleStopReplicaRequest(request)</div><div class="line">        <span class="keyword">case</span> RequestKeys.UpdateMetadataKey =&gt; handleUpdateMetadataRequest(request)</div><div class="line">        <span class="keyword">case</span> RequestKeys.ControlledShutdownKey =&gt; handleControlledShutdownRequest(request)</div><div class="line">        <span class="keyword">case</span> RequestKeys.OffsetCommitKey =&gt; handleOffsetCommitRequest(request)</div><div class="line">        <span class="keyword">case</span> RequestKeys.OffsetFetchKey =&gt; handleOffsetFetchRequest(request)</div><div class="line">        <span class="keyword">case</span> RequestKeys.ConsumerMetadataKey =&gt; handleConsumerMetadataRequest(request)</div><div class="line">        <span class="keyword">case</span> RequestKeys.JoinGroupKey =&gt; handleJoinGroupRequest(request)</div><div class="line">        <span class="keyword">case</span> RequestKeys.HeartbeatKey =&gt; handleHeartbeatRequest(request)</div><div class="line">        <span class="keyword">case</span> requestId =&gt; <span class="keyword">throw</span> <span class="keyword">new</span> KafkaException(<span class="string">"Unknown api code "</span> + requestId)</div><div class="line">      }</div><div class="line">    } <span class="keyword">catch</span> {</div><div class="line">      </div><div class="line">    } <span class="keyword">finally</span></div><div class="line">      request.apiLocalCompleteTimeMs = SystemTime.milliseconds</div><div class="line">}</div></pre></td></tr></table></figure>

<p>显然，此处处理的速度影响Kafka整体的消息处理的速度。<br>这里我们分析一个处理方法<code>handleProducerRequest</code>。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> handleProducerRequest(request: RequestChannel.Request) {</div><div class="line">    <span class="keyword">val</span> produceRequest = request.requestObj.asInstanceOf[ProducerRequest]</div><div class="line"></div><div class="line">    <span class="comment">// the callback for sending a produce response</span></div><div class="line">    <span class="keyword">def</span> sendResponseCallback(responseStatus: Map[TopicAndPartition, ProducerResponseStatus]) {</div><div class="line">      <span class="keyword">var</span> errorInResponse = <span class="keyword">false</span></div><div class="line">      responseStatus.foreach { <span class="keyword">case</span> (topicAndPartition, status) =&gt;</div><div class="line">        <span class="keyword">if</span> (status.error != ErrorMapping.NoError && status.error != ErrorMapping.UnknownCode) {</div><div class="line">          errorInResponse = <span class="keyword">true</span></div><div class="line">        }</div><div class="line">      }</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (produceRequest.requiredAcks == <span class="number">0</span>) {</div><div class="line">        <span class="keyword">if</span> (errorInResponse) {</div><div class="line">          requestChannel.closeConnection(request.processor, request)</div><div class="line">        } <span class="keyword">else</span> {</div><div class="line">          requestChannel.noOperation(request.processor, request)</div><div class="line">        }</div><div class="line">      } <span class="keyword">else</span> {</div><div class="line">        <span class="keyword">val</span> response = ProducerResponse(produceRequest.correlationId, responseStatus)</div><div class="line">        requestChannel.sendResponse(<span class="keyword">new</span> RequestChannel.Response(request, <span class="keyword">new</span> BoundedByteBufferSend(response)))</div><div class="line">      }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">val</span> internalTopicsAllowed = produceRequest.clientId == AdminUtils.AdminClientId</div><div class="line">    replicaManager.appendMessages(</div><div class="line">      produceRequest.ackTimeoutMs.toLong,</div><div class="line">      produceRequest.requiredAcks,</div><div class="line">      internalTopicsAllowed,</div><div class="line">      produceRequest.data,</div><div class="line">      sendResponseCallback)</div><div class="line"></div><div class="line">    produceRequest.emptyData()</div><div class="line">}</div></pre></td></tr></table></figure>

<p>这里会调用<code>replicaManager.appendMessages</code>处理Kafka message的保存和备份,也就是leader和备份节点上。</p>
<h3 id="Replication_subsystem">Replication subsystem</h3>
<p>顺藤摸瓜，我们进入<code>replicaManager.appendMessages</code>的代码。<br>这个方法会将消息放到leader分区上，并复制到备份分区上。在超时或者根据required acks的值及时返回response。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> appendMessages(......) {</div><div class="line">    <span class="keyword">if</span> (isValidRequiredAcks(requiredAcks)) {</div><div class="line">	  <span class="keyword">val</span> localProduceResults = appendToLocalLog(internalTopicsAllowed, messagesPerPartition, requiredAcks)</div><div class="line"></div><div class="line">      <span class="keyword">val</span> produceStatus = localProduceResults.map { <span class="keyword">case</span> (topicAndPartition, result) =&gt;</div><div class="line">        topicAndPartition -&gt;</div><div class="line">                ProducePartitionStatus(</div><div class="line">                  result.info.lastOffset + <span class="number">1</span>, <span class="comment">// required offset</span></div><div class="line">                  ProducerResponseStatus(result.errorCode, result.info.firstOffset)) <span class="comment">// response status</span></div><div class="line">      }</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (delayedRequestRequired(requiredAcks, messagesPerPartition, localProduceResults)) {</div><div class="line">        <span class="comment">// create delayed produce operation</span></div><div class="line">        <span class="keyword">val</span> produceMetadata = ProduceMetadata(requiredAcks, produceStatus)</div><div class="line">        <span class="keyword">val</span> delayedProduce = <span class="keyword">new</span> DelayedProduce(timeout, produceMetadata, <span class="keyword">this</span>, responseCallback)</div><div class="line"></div><div class="line">        <span class="comment">// create a list of (topic, partition) pairs to use as keys for this delayed produce operation</span></div><div class="line">        <span class="keyword">val</span> producerRequestKeys = messagesPerPartition.keys.map(<span class="keyword">new</span> TopicPartitionOperationKey(_)).toSeq</div><div class="line"></div><div class="line">        <span class="comment">// try to complete the request immediately, otherwise put it into the purgatory</span></div><div class="line">        <span class="comment">// this is because while the delayed produce operation is being created, new</span></div><div class="line">        <span class="comment">// requests may arrive and hence make this operation completable.</span></div><div class="line">        delayedProducePurgatory.tryCompleteElseWatch(delayedProduce, producerRequestKeys)</div><div class="line"></div><div class="line">      } <span class="keyword">else</span> {</div><div class="line">        <span class="comment">// we can respond immediately</span></div><div class="line">        <span class="keyword">val</span> produceResponseStatus = produceStatus.mapValues(status =&gt; status.responseStatus)</div><div class="line">        responseCallback(produceResponseStatus)</div><div class="line">      }</div><div class="line">    } <span class="keyword">else</span> {</div><div class="line">      <span class="comment">// If required.acks is outside accepted range, something is wrong with the client</span></div><div class="line">      <span class="comment">// Just return an error and don't handle the request at all</span></div><div class="line">      <span class="keyword">val</span> responseStatus = messagesPerPartition.map {</div><div class="line">        <span class="keyword">case</span> (topicAndPartition, messageSet) =&gt;</div><div class="line">          (topicAndPartition -&gt;</div><div class="line">                  ProducerResponseStatus(Errors.INVALID_REQUIRED_ACKS.code,</div><div class="line">                    LogAppendInfo.UnknownLogAppendInfo.firstOffset))</div><div class="line">      }</div><div class="line">      responseCallback(responseStatus)</div><div class="line">    }</div><div class="line">  }</div></pre></td></tr></table></figure>

<p>注意复制是<code>ReplicaFetcherManager</code>通过<code>ReplicaFetcherThread</code>线程完成的。</p>
<p>更详细的资源可以参考: <a href="">kafka replication</a></p>
<blockquote>
<p>To publish a message to a partition, the client first finds the leader of the partition from Zookeeper and sends the message to the leader. The leader writes the message to its local log. Each follower constantly pulls new messages from the leader using a single socket channel. That way, the follower receives all messages in the same order as written in the leader. The follower writes each received message to its own log and sends an acknowledgment back to the leader. Once the leader receives the acknowledgment from all replicas in ISR, the message is committed. The leader advances the HW and sends an acknowledgment to the client. For better performance, each follower sends an acknowledgment after the message is written to memory. So, for each committed message, we guarantee that the message is stored in multiple replicas in memory. However, there is no guarantee that any replica has persisted the commit message to disks though. Given that correlated failures are relatively rare, this approach gives us a good balance between response time and durability. In the future, we may consider adding options that provide even stronger guarantees. The leader also periodically broadcasts the HW to all followers. The broadcasting can be piggybacked on the return value of the fetch requests from the followers. From time to time, each replica checkpoints its HW to its disk.</p>
</blockquote>
<h3 id="Log_subsystem">Log subsystem</h3>
<p>LogManager负责管理Kafka的Log(Kafka消息)， 包括log/Log文件夹的创建，获取和清理。它也会通过定时器检查内存中的log是否要缓存到磁盘中。<br>重要的类包括<code>LogManager</code>和<code>Log</code>。</p>
<h3 id="offsetManager">offsetManager</h3>
<p>负责管理offset，提供offset的读写。</p>
<h3 id="topicConfigManager">topicConfigManager</h3>
<p>它负责动态改变Topic的配置属性。<br>如果某个topic的配置属性改变了，Kafka会在ZooKeeper上创建一个类似/brokers/config_changes/config_change_13321的节点， topicConfigManager会监控这些节点， 获得属性改变的topics并处理,实际上以新的<code>LogConfig</code>替换老的：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">def</span> processConfigChanges(notifications: Seq[String]) {</div><div class="line">    <span class="keyword">if</span> (notifications.size &gt; <span class="number">0</span>) {</div><div class="line">      <span class="keyword">val</span> now = time.milliseconds</div><div class="line">      <span class="keyword">val</span> logs = logManager.logsByTopicPartition.toBuffer</div><div class="line">      <span class="keyword">val</span> logsByTopic = logs.groupBy(_._1.topic).mapValues(_.map(_._2))</div><div class="line">      <span class="keyword">for</span> (notification &lt;- notifications) {</div><div class="line">        <span class="keyword">val</span> changeId = changeNumber(notification)</div><div class="line">        <span class="keyword">if</span> (changeId &gt; lastExecutedChange) {</div><div class="line">          <span class="keyword">val</span> changeZnode = ZkUtils.TopicConfigChangesPath + <span class="string">"/"</span> + notification</div><div class="line">          <span class="keyword">val</span> (jsonOpt, stat) = ZkUtils.readDataMaybeNull(zkClient, changeZnode)</div><div class="line">          <span class="keyword">if</span>(jsonOpt.isDefined) {</div><div class="line">            <span class="keyword">val</span> json = jsonOpt.get</div><div class="line">            <span class="keyword">val</span> topic = json.substring(<span class="number">1</span>, json.length - <span class="number">1</span>) <span class="comment">// hacky way to dequote</span></div><div class="line">            <span class="keyword">if</span> (logsByTopic.contains(topic)) {</div><div class="line">              <span class="comment">/* combine the default properties with the overrides in zk to create the new LogConfig */</span></div><div class="line">              <span class="keyword">val</span> props = <span class="keyword">new</span> Properties(logManager.defaultConfig.toProps)</div><div class="line">              props.putAll(AdminUtils.fetchTopicConfig(zkClient, topic))</div><div class="line">              <span class="keyword">val</span> logConfig = LogConfig.fromProps(props)</div><div class="line">              <span class="keyword">for</span> (log &lt;- logsByTopic(topic))</div><div class="line">                log.config = logConfig</div><div class="line">              info(<span class="string">"Processed topic config change %d for topic %s, setting new config to %s."</span>.format(changeId, topic, props))</div><div class="line">              purgeObsoleteNotifications(now, notifications)</div><div class="line">            }</div><div class="line">          }</div><div class="line">          lastExecutedChange = changeId</div><div class="line">        }</div><div class="line">      }</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<h3 id="其它类">其它类</h3>
<p>还有一些其它的重要的类， 包括<code>KafkaController</code>, <code>KafkaScheduler</code>,<code>ConsumerCoordinator</code>,<code>KafkaHealthcheck</code>等。</p>
<h2 id="Metrics">Metrics</h2>
<p>Kafka使用<a href="https://github.com/dropwizard/metrics" target="_blank" rel="external">metrics</a>进行性能的度量。原先是yammer metrics,现在独立成dropwizard metrics.目前这个框架的package名字比较乱，但是性能监控的功能却是非常的强大。<br>metrics提供了几种reporter,可以将性能报告显示在哪里， 比如控制台，JMX, Slf4j,Ganglia，Graphite等。<br>Kafka实现了一个CSV文件报告类<code>KafkaCSVMetricsReporter</code>，它调用metrics的<code>CsvReporter</code>生成报告。<br>如果你想生成这些报告，需要在server.properties加入：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">kafka.metrics.<span class="variable">reporters=</span>kafka.metrics.KafkaCSVMetricsReporter</div><div class="line">kafka.csv.metrics.reporter.<span class="variable">enabled=</span><span class="constant">true</span></div></pre></td></tr></table></figure>

<p>默认它会在kafka的kafka_metrics文件夹下生成这些csv文件。</p>
<h2 id="Producer">Producer</h2>
<p><code>kafka.producer.Producer</code>定义了两种类型的Producer: sync和async。基本上都是通过 eventHandler.handle(messages)处理消息, 只不过async会通过一个线程， 以LinkedBlockingQueue为缓冲发送消息。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">  <span class="keyword">def</span> handle(events: Seq[KeyedMessage[K,V]]) {</div><div class="line">    <span class="keyword">val</span> serializedData = serialize(events)</div><div class="line">    <span class="keyword">var</span> outstandingProduceRequests = serializedData</div><div class="line">    <span class="keyword">var</span> remainingRetries = config.messageSendMaxRetries + <span class="number">1</span></div><div class="line">    <span class="keyword">val</span> correlationIdStart = correlationId.get()</div><div class="line">    </div><div class="line">    <span class="keyword">while</span> (remainingRetries &gt; <span class="number">0</span> && outstandingProduceRequests.size &gt; <span class="number">0</span>) {</div><div class="line">      topicMetadataToRefresh ++= outstandingProduceRequests.map(_.topic)</div><div class="line">      <span class="keyword">if</span> (topicMetadataRefreshInterval &gt;= <span class="number">0</span> &&</div><div class="line">          SystemTime.milliseconds - lastTopicMetadataRefreshTime &gt; topicMetadataRefreshInterval) {</div><div class="line">        Utils.swallowError(brokerPartitionInfo.updateInfo(topicMetadataToRefresh.toSet, correlationId.getAndIncrement))</div><div class="line">        sendPartitionPerTopicCache.clear()</div><div class="line">        topicMetadataToRefresh.clear</div><div class="line">        lastTopicMetadataRefreshTime = SystemTime.milliseconds</div><div class="line">      }</div><div class="line">      outstandingProduceRequests = dispatchSerializedData(outstandingProduceRequests)</div><div class="line">      <span class="keyword">if</span> (outstandingProduceRequests.size &gt; <span class="number">0</span>) {       </div><div class="line">        Thread.sleep(config.retryBackoffMs)        </div><div class="line">        Utils.swallowError(brokerPartitionInfo.updateInfo(outstandingProduceRequests.map(_.topic).toSet, correlationId.getAndIncrement))</div><div class="line">        sendPartitionPerTopicCache.clear()</div><div class="line">        remainingRetries -= <span class="number">1</span></div><div class="line">        producerStats.resendRate.mark()</div><div class="line">      }</div><div class="line">    }</div><div class="line">    <span class="keyword">if</span>(outstandingProduceRequests.size &gt; <span class="number">0</span>) {</div><div class="line">      producerStats.failedSendRate.mark()</div><div class="line">      <span class="keyword">val</span> correlationIdEnd = correlationId.get()     </div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> FailedToSendMessageException(<span class="string">"Failed to send messages after "</span> + config.messageSendMaxRetries + <span class="string">" tries."</span>, <span class="keyword">null</span>)</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>首先通过Encoder序列化成标准的<code>KeyedMessage[K,Message]</code>。然后通过<code>dispatchSerializedData(outstandingProduceRequests)</code>将消息添加到计算出的broker上(通过send方法发送ProducerRequest)，这里有尝试次数的限制。<br><code>kafka.javaapi.producer.Producer</code>则提供了java接口。</p>
<h2 id="Consumer">Consumer</h2>
<p><code>kafka.consumer.SimpleConsumer</code>提供了Simple Consumer API.它通过一个BlockingChannel发送消息，接收Response完成任务。<br><code>kafka.javaapi.consumer.SimpleConsumer</code>则提供了java接口。</p>
<p>High level consumer实际由<code>ZookeeperConsumerConnector</code>完成，它将consumer信息记录在zookeeper中，提供<code>KafkaStream</code>获取Kafka消息。</p>
<h2 id="参考文档">参考文档</h2>
<ol>
<li><a href="https://cwiki.apache.org/confluence/display/KAFKA/Kafka+Internals" target="_blank" rel="external">https://cwiki.apache.org/confluence/display/KAFKA/Kafka+Internals</a></li>
</ol>
<blockquote>
<p>本文中的例子中一些不必要的代码行已经去掉， 如log日志， metrics监控等</p>
</blockquote>

      
    </div>
    <footer class="article-footer">
	
<div class="bdsharebuttonbox"><a title="分享到新浪微博" class="bds_tsina" href="#" data-cmd="tsina"></a><a title="分享到微信" class="bds_weixin" href="#" data-cmd="weixin"></a><a title="分享到QQ空间" class="bds_qzone" href="#" data-cmd="qzone"></a><a title="分享到印象笔记" class="bds_evernotecn" href="#" data-cmd="evernotecn"></a><a title="分享到有道云笔记" class="bds_youdao" href="#" data-cmd="youdao"></a><a title="分享到百度云收藏" class="bds_bdysc" href="#" data-cmd="bdysc"></a><a class="bds_more" href="#" data-cmd="more"></a></div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>
      

	  

      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Kafka/">Kafka</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2015/03/24/Best-Practices-of-Asynchronous-Programming-With-Java/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Java 异步编程最佳实践
        
      </div>
    </a>
  
  
    <a href="/2015/03/20/spark-new-kid-big-data-block/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Spark: 大数据领域的新贵</div>
    </a>
  
</nav>

  
</article>


<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<section id="comments">
  <div id="gitalk-container"></div>  
  <script type="text/javascript">
    var gitalkOpts = {
    id: '2015/03/23/kafka-internals/',
    owner: 'smallnest',
    repo: 'gitalk',
    title: 'Kafka 内幕：源代码High level分析',
    body: 'http://colobu.com/2015/03/23/kafka-internals/',
    clientID: 'bc02724130ed5b7ee275',
    clientSecret: '68cb0bae2f93a8b88b09e0eb9b08c844b06a9047',
    admin: ['smallnest'],
    distractionFreeMode: false
  };

  const gitalk = new Gitalk(gitalkOpts)
  gitalk.render('gitalk-container')
	</script>
  <noscript> 为正常使用评论功能请激活JavaScript</noscript>
</section>  


</section>
        
          <aside id="sidebar">
  
      <div class="widget-wrap">
    <h3 class="widget-title">原创图书</h3>
    <div class="widget">
      <a href="/ScalaCollectionsCookbook/">
        <img width="100%" src="/ScalaCollectionsCookbook/scala_collections_cookbook.jpg">
        <img width="100%" src="/ScalaCollectionsCookbook/scala_collections_cookbook_tw.png">
      </a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/DOTNET/">DOTNET</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Go/">Go</a><span class="category-list-count">98</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">62</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Scala/">Scala</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端开发/">前端开发</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/区块链/">区块链</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/大数据/">大数据</a><span class="category-list-count">59</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工具/">工具</a><span class="category-list-count">24</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/">数据库</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/架构/">架构</a><span class="category-list-count">24</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/管理/">管理</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络编程/">网络编程</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/读书笔记/">读书笔记</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/运维/">运维</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/高并发编程/">高并发编程</a><span class="category-list-count">20</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/Android/" style="font-size: 16.67px;">Android</a><a href="/tags/ApacheBench/" style="font-size: 11.67px;">ApacheBench</a><a href="/tags/Bower/" style="font-size: 10.00px;">Bower</a><a href="/tags/C/" style="font-size: 10.00px;">C#</a><a href="/tags/CDN/" style="font-size: 10.00px;">CDN</a><a href="/tags/CQRS/" style="font-size: 10.00px;">CQRS</a><a href="/tags/CRC/" style="font-size: 10.00px;">CRC</a><a href="/tags/CSS/" style="font-size: 11.67px;">CSS</a><a href="/tags/CompletableFuture/" style="font-size: 10.00px;">CompletableFuture</a><a href="/tags/Comsat/" style="font-size: 10.00px;">Comsat</a><a href="/tags/Curator/" style="font-size: 20.00px;">Curator</a><a href="/tags/DSL/" style="font-size: 10.00px;">DSL</a><a href="/tags/Disruptor/" style="font-size: 10.00px;">Disruptor</a><a href="/tags/Docker/" style="font-size: 11.67px;">Docker</a><a href="/tags/Ember/" style="font-size: 11.67px;">Ember</a><a href="/tags/FastJson/" style="font-size: 10.00px;">FastJson</a><a href="/tags/Fiber/" style="font-size: 10.00px;">Fiber</a><a href="/tags/GAE/" style="font-size: 10.00px;">GAE</a><a href="/tags/GC/" style="font-size: 13.33px;">GC</a><a href="/tags/Gnuplot/" style="font-size: 10.00px;">Gnuplot</a><a href="/tags/Go/" style="font-size: 13.33px;">Go</a><a href="/tags/Gradle/" style="font-size: 10.00px;">Gradle</a><a href="/tags/Grunt/" style="font-size: 10.00px;">Grunt</a><a href="/tags/Gulp/" style="font-size: 10.00px;">Gulp</a><a href="/tags/Hadoop/" style="font-size: 10.00px;">Hadoop</a><a href="/tags/Hazelcast/" style="font-size: 10.00px;">Hazelcast</a><a href="/tags/Ignite/" style="font-size: 10.00px;">Ignite</a><a href="/tags/JVM/" style="font-size: 10.00px;">JVM</a><a href="/tags/Java/" style="font-size: 18.33px;">Java</a><a href="/tags/Kafka/" style="font-size: 20.00px;">Kafka</a><a href="/tags/Lambda/" style="font-size: 15.00px;">Lambda</a><a href="/tags/Linux/" style="font-size: 13.33px;">Linux</a><a href="/tags/LongAdder/" style="font-size: 10.00px;">LongAdder</a><a href="/tags/MathJax/" style="font-size: 10.00px;">MathJax</a><a href="/tags/Maven/" style="font-size: 11.67px;">Maven</a><a href="/tags/Memcached/" style="font-size: 10.00px;">Memcached</a><a href="/tags/Metrics/" style="font-size: 10.00px;">Metrics</a><a href="/tags/Mongo/" style="font-size: 13.33px;">Mongo</a><a href="/tags/Netty/" style="font-size: 16.67px;">Netty</a><a href="/tags/Nginx/" style="font-size: 10.00px;">Nginx</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">July 2015</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">June 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">May 2015</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">April 2015</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">March 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/02/">February 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">January 2015</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">December 2014</a><span class="archive-list-count">28</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/11/">November 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/10/">October 2014</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">September 2014</a><span class="archive-list-count">28</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">August 2014</a><span class="archive-list-count">19</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/07/">July 2014</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">近期文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/03/26/channel-patterns/">Go Channel 应用模式</a>
          </li>
        
          <li>
            <a href="/2018/03/26/distributed-hash-table/">DHT 分布式哈希表</a>
          </li>
        
          <li>
            <a href="/2018/03/12/Concurrency-Utilities-Enhancements-in-Java-8-Java-9/">Java8 和 Java 9中并发工具的改变</a>
          </li>
        
          <li>
            <a href="/2018/03/12/20-Examples-of-Using-Java’s-CompletableFuture/">[译]20个使用 Java CompletableFuture的例子</a>
          </li>
        
          <li>
            <a href="/2018/03/12/Debugging-Go-Code-with-LLDB/">[译]使用 LLDB 调试 Go 程序</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">友情链接</h3>
    <div class="widget">
      <ul>
        
          <li>
			 
            <a href="http://old.colobu.com" target="_blank">以前的博客</a>
			
          </li>
        
          <li>
			 
			&nbsp;
			
          </li>
        
          <li>
			 
            <a href="http://stackshare.io" target="_blank">技术栈</a>
			
          </li>
        
          <li>
			 
			&nbsp;
			
          </li>
        
          <li>
			 
            <a href="http://weekly.manong.io/issues/" target="_blank">码农周刊</a>
			
          </li>
        
          <li>
			 
            <a href="http://www.tuicool.com/mags" target="_blank">编程狂人周刊</a>
			
          </li>
        
          <li>
			 
            <a href="http://www.importnew.com/" target="_blank">importnew</a>
			
          </li>
        
          <li>
			 
            <a href="http://ifeve.com/" target="_blank">并发编程网</a>
			
          </li>
        
          <li>
			 
			&nbsp;
			
          </li>
        
          <li>
			 
            <a href="http://github.com" target="_blank">github</a>
			
          </li>
        
          <li>
			 
            <a href="http://stackoverflow.com/" target="_blank">stackoverflow</a>
			
          </li>
        
          <li>
			 
            <a href="http://www.javacodegeeks.com/" target="_blank">javacodegeeks</a>
			
          </li>
        
          <li>
			 
            <a href="http://www.infoq.com/" target="_blank">infoq</a>
			
          </li>
        
          <li>
			 
            <a href="http://www.dzone.com/links/index.html" target="_blank">dzone</a>
			
          </li>
        
          <li>
			 
            <a href="https://oj.leetcode.com/problems/" target="_blank">leetcode</a>
			
          </li>
        
          <li>
			 
            <a href="http://tutorials.jenkov.com" target="_blank">jenkov</a>
			
          </li>
        
      </ul>
    </div>
  </div>

  
      

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 smallnest<br>
	  Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
    <a href="https://github.com/smallnest" class="mobile-nav-link">github</a>
  
    <a href="/goasm" class="mobile-nav-link">Go汇编示例</a>
  
    <a href="/ScalaCollectionsCookbook" class="mobile-nav-link">Scala集合技术手册</a>
  
    <a href="/techreview" class="mobile-nav-link">技术快报</a>
  
    <a href="/about" class="mobile-nav-link">关于</a>
  
</nav>
    
<script src="//cdn.staticfile.org/jquery/1.11.1/jquery.min.js"></script>
<script src="//cdn.bootcss.com/jquery.lazyload/1.9.1/jquery.lazyload.min.js"></script>

<script src="//cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js"></script>


<script src="/js/script.js" type="text/javascript"></script>

<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
  });
  MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>
<script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.6.0-beta.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

<div id="totop" style="position:fixed;bottom:150px;right:10px;cursor: pointer;z-index: 2000;">
	<a title="返回顶部"><img src="/images/scrollup.png"/></a>
</div>
<script src="/js/totop.js" type="text/javascript"></script>



<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-142561-4']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>


<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e085d87993250aab11f3e0c15f1c2785";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


  </div>
</body>
</html>