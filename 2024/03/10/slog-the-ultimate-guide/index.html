<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  
  <title>slog 终极指南</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="原文: Logging in Go with Slog: The Ultimate Guide by Ayooluwa Isaiah.">
<meta property="og:type" content="article">
<meta property="og:title" content="slog 终极指南">
<meta property="og:url" content="https://colobu.com/2024/03/10/slog-the-ultimate-guide/">
<meta property="og:site_name" content="鸟窝">
<meta property="og:description" content="原文: Logging in Go with Slog: The Ultimate Guide by Ayooluwa Isaiah.">
<meta property="og:image" content="color.png">
<meta property="og:image" content="log.png">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="slog 终极指南">
<meta name="twitter:description" content="原文: Logging in Go with Slog: The Ultimate Guide by Ayooluwa Isaiah.">

  
  <link rel="alternative" href="/atom.xml" title="鸟窝" type="application/atom+xml">
  
  
  <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">

  <link href="//cdn.staticfile.org/font-awesome/4.2.0/css/font-awesome.css" rel="stylesheet">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.7/css/jquery.fancybox.min.css"
    media="screen" type="text/css">
  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" media="screen"
    type="text/css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/tonsky/FiraCode@1.207/distr/fira_code.css">
</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap" class="animated bounceInLeft">
        <a href="/" id="logo">鸟窝</a>
      </h1>
      
        <!-- <h2 id="subtitle-wrap" class="animated bounceInLeft"> -->
        <h2 id="subtitle-wrap">
          <!-- <a href="/" id="subtitle">大道至简 Simplicity is the ultimate form of sophistication</a> -->
          <a href="https://item.jd.com/14283252.html" target="_blank" style="color: #e32d40;text-decoration: none;"><b>《深入理解Go并发编程》新书发售中。一书在手，并发无忧</b></a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          
            <a class="main-nav-link" href="/"><i class="fa fa-home">&nbsp;</i>首页</a>
          
          
          
            <a class="main-nav-link" href="/archives"><i class="fa fa-folder-o">&nbsp;</i>归档</a>
          
          
          
            <a class="main-nav-link" href="https://github.com/smallnest"><i class="fa fa-github">&nbsp;</i>github</a>
          
          
          
            <div class="dropdown main-nav-link"><a class="main-nav-link" href="#"><i class="fa fa-bars">&nbsp;</i>网站群</a>
              <div class="dropdown-content">
          
            
              <a href="/goasm"><i class="fa fa-language"></i>&nbsp;Go汇编示例</a>
            
                
          
            
              <a href="https://gowebexamples.com"><i class="fa fa-external-link"></i>&nbsp;Go Web开发示例</a>
            
                
          
            
              <a href="http://go-database-sql.org"><i class="fa fa-external-link"></i>&nbsp;Go 数据库开发教程</a>
            
                
          
            
              <a href="https://colobu.com/gotips/"><i class="fa fa-external-link"></i>&nbsp;Go 语言编程技巧</a>
            
                
          
            
              <hr>
            
                
          
            
              <a href="/perf-book"><i class="fa fa-brands fa-rust"></i>&nbsp;Rust高性能编程指南</a>
            
                
          
            
              <a href="/rust100"><i class="fa fa-brands fa-rust"></i>&nbsp;100个练习题学习Rust</a>
            
                
          
            
              <hr>
            
                
          
            
              <a href="http://rpcx.io"><i class="fa undefined"></i>&nbsp;RPCX官网</a>
            
                
          
            
              <a href="http://cn.doc.rpcx.io"><i class="fa undefined"></i>&nbsp;RPC开发指南</a>
            
                
          
          </div>
        </div>
          
          
          
            <a class="main-nav-link" href="/ScalaCollectionsCookbook"><i class="fa fa-solid fa-book">&nbsp;</i>Scala集合技术手册</a>
          
          
          
            <a class="main-nav-link" href="/about"><i class="fa fa-lemon-o">&nbsp;</i>关于</a>
          
          


      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="https://www.google.com/search" method="get" accept-charset="utf-8" class="search-form">
          <input type="search" id="search-word" name="q" maxlength="20" class="search-form-input" placeholder="Search">
          <input type=hidden name=ie value="utf-8">
          <input type=hidden name=oe value="utf-8">
          <input type=hidden name=hl value="zh-CN">
          <input type="submit" id="search-submit" value="" class="search-form-submit">
        </form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-slog-the-ultimate-guide" class="article article-type-post" itemscope
  itemprop="blogPost">
  <div class="article-meta">
    <a href="/2024/03/10/slog-the-ultimate-guide/" class="article-date">
  <time datetime="2024-03-10T03:49:55.000Z" itemprop="datePublished">2024年03月10日</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Go/">Go</a>
  </div>

    
  <div class="article-author"> by smallnest</div>

  </div>
  <div class="article-inner">
    
    
    <header class="article-header">
      
  
    <h1 class="article-title" itemprop="name">
      slog 终极指南
	  
    </h1>
  

    </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      <h1 id="expanderHead" style="cursor:pointer;">
        目录 <span id="expanderSign">[−]</span>
      </h1>
      <div id="article-entry-toc" data-role="collapsible" class="article-entry-toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#开始使用_Slog"><span class="toc-text">开始使用 Slog</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#自定义默认_logger"><span class="toc-text">自定义默认 logger</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#为日志记录添加上下文属性"><span class="toc-text">为日志记录添加上下文属性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#分组上下文属性"><span class="toc-text">分组上下文属性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建和使用子_logger"><span class="toc-text">创建和使用子 logger</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#自定义_slog_日志级别"><span class="toc-text">自定义 slog 日志级别</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建自定义日志级别"><span class="toc-text">创建自定义日志级别</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#自定义_slog_处理程序"><span class="toc-text">自定义 slog 处理程序</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建自定义日志处理程序"><span class="toc-text">创建自定义日志处理程序</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用_context_包"><span class="toc-text">使用 context 包</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#slog_错误日志记录"><span class="toc-text">slog 错误日志记录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用_LogValuer_接口隐藏敏感字段"><span class="toc-text">使用 LogValuer 接口隐藏敏感字段</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用第三方日志后端与_Slog_集成"><span class="toc-text">使用第三方日志后端与 Slog 集成</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Go_日志编写和存储的最佳实践"><span class="toc-text">Go 日志编写和存储的最佳实践</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#补充信息"><span class="toc-text">补充信息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#通用处理器"><span class="toc-text">通用处理器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#格式化"><span class="toc-text">格式化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#日志增强"><span class="toc-text">日志增强</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#日志转发"><span class="toc-text">日志转发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#和其它日志框架集成"><span class="toc-text">和其它日志框架集成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#集成到web框架"><span class="toc-text">集成到web框架</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#其他"><span class="toc-text">其他</span></a></li></ol></li></ol>
      </div>
      
      
      
      <script>function show_answer(btn, x) { if (btn.value === "显示答案") { btn.value = "隐藏答案" } else { btn.value = "显示答案" } var as = document.getElementById(x); if (as.style.display === "none") { as.style.display = "block" } else { as.style.display = "none" } }</script>
      <p>原文: <a href="https://betterstack.com/community/guides/logging/logging-in-go/" target="_blank" rel="external">Logging in Go with Slog: The Ultimate Guide</a> by Ayooluwa Isaiah.</p>
<a id="more"></a>
<p>在本文中，我们将探讨 Go 中的结构化日志记录，并特别关注这最近推出的 <a href="https://pkg.go.dev/log/slog" target="_blank" rel="external">log/slog</a> 软件包, 这个软件包旨在为 Go 带来高性能、结构化和分级的日志记录标准库。</p>
<p>该软件包起源于由 Jonathan Amsterdam 发起的 <a href="https://github.com/golang/go/discussions/54763" target="_blank" rel="external">GitHub 讨论</a>, 后来专门建立了一个<a href="https://github.com/golang/go/issues/56345" target="_blank" rel="external">提案</a>细化设计。一旦定稿，它在Go v1.21版本中发布。</p>
<p>在以下各节中，我将全面呈现slog的功能， 提供相应的例子。至于它和其它日志框架的性能比较，请参阅此 <a href="https://github.com/betterstack-community/go-logging-benchmarks" target="_blank" rel="external">GitHub 日志框架 benchmark</a>.</p>
<h2 id="开始使用_Slog">开始使用 Slog</h2>
<p>让我们从探讨该包的设计和架构开始。它提供了三种您应该熟悉的主要类型:<code>log/slog</code></p>
<ul>
<li><strong>Logger</strong>：日志&quot;前端&quot;，提供了诸如 <code>Info()</code> 和 <code>Error()</code> 等级别方法来记录感兴趣的事件。</li>
<li><strong>Record</strong>：由 <code>Logger</code> 创建的每个独立日志对象的表示形式。</li>
<li><strong>Handler</strong>：一旦实现了这个接口，就可以决定每个 <code>Record</code> 的格式化和目的地。该包中包含两个内置处理程序：<code>TextHandler</code> 用于 <code>key=value</code> 输出，<code>JSONHandler</code> 用于 <code>JSON</code> 输出。</li>
</ul>
<p>与大多数 <a href="https://betterstack.com/community/guides/logging/best-golang-logging-libraries/" target="_blank" rel="external">Go 日志库</a>一样， <code>slog</code>包公开了一个可通过包级别函数访问的默认 <code>Logger</code>。该 <code>logger</code> 产生的输出与旧的 <code>log.Printf()</code> 方法几乎相同，只是多了日志级别。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"log"</span></div><div class="line">    <span class="string">"log/slog"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">func</span> main() {</div><div class="line">    log.Print(<span class="string">"Info message"</span>)</div><div class="line">    slog.Info(<span class="string">"Info message"</span>)</div><div class="line">}</div></pre></td></tr></table></figure>



<figure class="highlight log"><figcaption><span>output</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="number">2024</span><span class="regexp">/01/</span><span class="number">03</span> <span class="number">10</span>:<span class="number">24</span>:<span class="number">22</span> Info message</div><div class="line"><span class="number">2024</span><span class="regexp">/01/</span><span class="number">03</span> <span class="number">10</span>:<span class="number">24</span>:<span class="number">22</span> INFO Info message</div></pre></td></tr></table></figure>

<p>这是一个有些奇怪的默认设置,因为 <code>slog</code> 的主要目的是为标准库带来结构化日志记录。</p>
<p>不过,通过 <code>slog.New()</code> 方法创建自定义实例就很容易纠正这一点。它接受一个 <code>Handler</code> 接口的实现,用于决定日志的格式化方式和写入位置。</p>
<p>下面是一个使用内置的 <code>JSONHandler</code> 类型将 <code>JSON</code> 日志输出到 <code>stdout</code> 的示例:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> main() {</div><div class="line">    logger := slog.New(slog.NewJSONHandler(os.Stdout, <span class="constant">nil</span>))</div><div class="line">    logger.Debug(<span class="string">"Debug message"</span>)</div><div class="line">    logger.Info(<span class="string">"Info message"</span>)</div><div class="line">    logger.Warn(<span class="string">"Warning message"</span>)</div><div class="line">    logger.Error(<span class="string">"Error message"</span>)</div><div class="line">}</div></pre></td></tr></table></figure>



<figure class="highlight log"><figcaption><span>output</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">{"<span class="attribute">time</span>":<span class="value"><span class="string">"2023-03-15T12:59:22.227408691+01:00"</span></span>,"<span class="attribute">level</span>":<span class="value"><span class="string">"INFO"</span></span>,"<span class="attribute">msg</span>":<span class="value"><span class="string">"Info message"</span></span>}</div><div class="line">{"<span class="attribute">time</span>":<span class="value"><span class="string">"2023-03-15T12:59:22.227468972+01:00"</span></span>,"<span class="attribute">level</span>":<span class="value"><span class="string">"WARN"</span></span>,"<span class="attribute">msg</span>":<span class="value"><span class="string">"Warning message"</span></span>}</div><div class="line">{"<span class="attribute">time</span>":<span class="value"><span class="string">"2023-03-15T12:59:22.227472149+01:00"</span></span>,"<span class="attribute">level</span>":<span class="value"><span class="string">"ERROR"</span></span>,"<span class="attribute">msg</span>":<span class="value"><span class="string">"Error message"</span></span>}</div></pre></td></tr></table></figure>

<p>当使用 <code>TextHandler</code> 类型时,每个日志记录将根据 Logfmt 标准进行格式化:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">logger := slog.New(slog.NewTextHandler(os.Stdout, <span class="constant">nil</span>))</div></pre></td></tr></table></figure>



<figure class="highlight log"><figcaption><span>output</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="variable">time=</span><span class="number">2023</span>-<span class="number">03</span>-<span class="number">15</span>T13:<span class="number">00</span>:<span class="number">11.333</span>+<span class="number">01</span>:<span class="number">00</span> <span class="variable">level=</span>INFO <span class="variable">msg=</span><span class="string">"Info message"</span></div><div class="line"><span class="variable">time=</span><span class="number">2023</span>-<span class="number">03</span>-<span class="number">15</span>T13:<span class="number">00</span>:<span class="number">11.333</span>+<span class="number">01</span>:<span class="number">00</span> <span class="variable">level=</span>WARN <span class="variable">msg=</span><span class="string">"Warning message"</span></div><div class="line"><span class="variable">time=</span><span class="number">2023</span>-<span class="number">03</span>-<span class="number">15</span>T13:<span class="number">00</span>:<span class="number">11.333</span>+<span class="number">01</span>:<span class="number">00</span> <span class="variable">level=</span>ERROR <span class="variable">msg=</span><span class="string">"Error message"</span></div></pre></td></tr></table></figure>

<p>所有<code>Logger</code>实例默认使用 <code>INFO</code> 级别进行日志记录,这将导致 <code>DEBUG</code> 条目被一直不输出,但您可以根据需要轻松更新日志级别。</p>
<h2 id="自定义默认_logger">自定义默认 logger</h2>
<p>自定义默认 <code>logger</code> 最直接的方式是利用 <code>slog.SetDefault()</code> 方法,允许您用自定义的 <code>logger</code> 替换默认的 <code>logger</code>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> main() {</div><div class="line">    logger := slog.New(slog.NewJSONHandler(os.Stdout, <span class="constant">nil</span>))</div><div class="line"></div><div class="line">    slog.SetDefault(logger)</div><div class="line"></div><div class="line">    slog.Info(<span class="string">"Info message"</span>)</div><div class="line">}</div></pre></td></tr></table></figure>

<p>你现在会观察到,该包的顶层日志记录方法现在会生成如下所示的 JSON 输出:</p>
<figure class="highlight log"><figcaption><span>output</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">{"<span class="attribute">time</span>":<span class="value"><span class="string">"2023-03-15T13:07:39.105777557+01:00"</span></span>,"<span class="attribute">level</span>":<span class="value"><span class="string">"INFO"</span></span>,"<span class="attribute">msg</span>":<span class="value"><span class="string">"Info message"</span></span>}</div></pre></td></tr></table></figure>

<p>使用 <code>SetDefault()</code> 方法还会改变 <code>log</code> 包使用的默认 <code>log.Logger</code>。这种行为允许利用旧的 <code>log</code> 包的现有应用程序无缝过渡到结构化日志记录。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> main() {</div><div class="line">    logger := slog.New(slog.NewJSONHandler(os.Stdout, <span class="constant">nil</span>))</div><div class="line"></div><div class="line">    slog.SetDefault(logger)</div><div class="line"></div><div class="line">    <span class="comment">// elsewhere in the application</span></div><div class="line">    log.Println(<span class="string">"Hello from old logger"</span>)</div><div class="line">}</div></pre></td></tr></table></figure>



<figure class="highlight log"><figcaption><span>output</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">{"<span class="attribute">time</span>":<span class="value"><span class="string">"2023-03-16T15:20:33.783681176+01:00"</span></span>,"<span class="attribute">level</span>":<span class="value"><span class="string">"INFO"</span></span>,"<span class="attribute">msg</span>":<span class="value"><span class="string">"Hello from old logger"</span></span>}</div></pre></td></tr></table></figure>

<p>当您需要利用需要 <code>log.Logger</code> 的 API 时(如 <code>http.Server.ErrorLog</code>)，<code>slog.NewLogLogger()</code> 方法也可用于将<code>slog.Logger</code> 转换为 <code>log.Logger</code>：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> main() {</div><div class="line">    handler := slog.NewJSONHandler(os.Stdout, <span class="constant">nil</span>)</div><div class="line"></div><div class="line">    logger := slog.NewLogLogger(handler, slog.LevelError)</div><div class="line"></div><div class="line">    _ = http.Server{</div><div class="line">        <span class="comment">// this API only accepts `log.Logger`</span></div><div class="line">        ErrorLog: logger,</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<h2 id="为日志记录添加上下文属性">为日志记录添加上下文属性</h2>
<p>结构化日志记录相对于非结构化格式的一个重大优势是能够在日志记录中以键/值对的形式添加任意属性。</p>
<p>这些属性为所记录的事件提供了额外的上下文信息,对于诸如故障排除、生成指标、审计和各种其他用途等任务非常有价值。</p>
<p>下面是一个示例,说明了如何在 slog 中实现这一点:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">logger.Info(</div><div class="line">  <span class="string">"incoming request"</span>,</div><div class="line">  <span class="string">"method"</span>, <span class="string">"GET"</span>,</div><div class="line">  <span class="string">"time_taken_ms"</span>,<span class="number"> 158</span>,</div><div class="line">  <span class="string">"path"</span>, <span class="string">"/hello/world?q=search"</span>,</div><div class="line">  <span class="string">"status"</span>,<span class="number"> 200</span>,</div><div class="line">  <span class="string">"user_agent"</span>, <span class="string">"Googlebot/2.1 (+http://www.google.com/bot.html)"</span>,</div><div class="line">)</div></pre></td></tr></table></figure>



<figure class="highlight log"><figcaption><span>output</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">{</div><div class="line">  "<span class="attribute">time</span>":<span class="value"><span class="string">"2023-02-24T11:52:49.554074496+01:00"</span></span>,</div><div class="line">  "<span class="attribute">level</span>":<span class="value"><span class="string">"INFO"</span></span>,</div><div class="line">  "<span class="attribute">msg</span>":<span class="value"><span class="string">"incoming request"</span></span>,</div><div class="line">  "<span class="attribute">method</span>":<span class="value"><span class="string">"GET"</span></span>,</div><div class="line">  "<span class="attribute">time_taken_ms</span>":<span class="value"><span class="number">158</span></span>,</div><div class="line">  "<span class="attribute">path</span>":<span class="value"><span class="string">"/hello/world?q=search"</span></span>,</div><div class="line">  "<span class="attribute">status</span>":<span class="value"><span class="number">200</span></span>,</div><div class="line">  "<span class="attribute">user_agent</span>":<span class="value"><span class="string">"Googlebot/2.1 (+http://www.google.com/bot.html)"</span></span></div><div class="line">}</div></pre></td></tr></table></figure>

<p>所有的级别方法(<code>Info()</code>、<code>Debug()</code>等)都接受一个日志消息作为第一个参数,之后可以接受无限个宽松类型的键/值对。</p>
<p>这个 API 类似于 <code>Zap</code> 中的 <a href="https://betterstack.com/community/guides/logging/go/zap#examining-zap-s-logging-api" target="_blank" rel="external">SugaredLogger API</a>(具体是以w结尾的级别方法),它以额外的内存分配为代价来换取简洁性。</p>
<p>但要小心,因为这种方法可能会导致意外的问题。具体来说,不匹配的键/值对会导致输出存在问题:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">logger.Info(</div><div class="line">  <span class="string">"incoming request"</span>,</div><div class="line">  <span class="string">"method"</span>, <span class="string">"GET"</span>,</div><div class="line">  <span class="string">"time_taken_ms"</span>, <span class="comment">// the value for this key is missing</span></div><div class="line">)</div></pre></td></tr></table></figure>

<p>由于time_taken_ms键没有对应的值,它将被视为以!BADKEY作为键的值。这不太理想,因为属性对齐错误可能会创建错误的条目,而您可能要等到需要使用日志时才会发现。</p>
<figure class="highlight log"><figcaption><span>output</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">{</div><div class="line">  "<span class="attribute">time</span>": <span class="value"><span class="string">"2023-03-15T13:15:29.956566795+01:00"</span></span>,</div><div class="line">  "<span class="attribute">level</span>": <span class="value"><span class="string">"INFO"</span></span>,</div><div class="line">  "<span class="attribute">msg</span>": <span class="value"><span class="string">"incoming request"</span></span>,</div><div class="line">  "<span class="attribute">method</span>": <span class="value"><span class="string">"GET"</span></span>,</div><div class="line">  "<span class="attribute">!BADKEY</span>": <span class="value"><span class="string">"time_taken_ms"</span></span></div><div class="line">}</div></pre></td></tr></table></figure>

<p>为了防止此类问题,您可以运行vet命令或使用lint工具自动报告此类问题：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ go vet ./...</div><div class="line"><span class="comment"># github.com/smallnest/study/logging</span></div><div class="line"><span class="comment"># [github.com/smallnest/study/logging]</span></div><div class="line">./main.go:<span class="number">6</span>:<span class="number">2</span>: call to slog.Info missing a final value</div></pre></td></tr></table></figure>

<p>另一种防止此类错误的方法是使用如下所示的<a href="https://pkg.go.dev/log/slog#Attr" target="_blank" rel="external">强类型上下文属性</a>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">logger.Info(</div><div class="line">  <span class="string">"incoming request"</span>,</div><div class="line">  slog.String(<span class="string">"method"</span>, <span class="string">"GET"</span>),</div><div class="line">  slog.Int(<span class="string">"time_taken_ms"</span>,<span class="number"> 158</span>),</div><div class="line">  slog.String(<span class="string">"path"</span>, <span class="string">"/hello/world?q=search"</span>),</div><div class="line">  slog.Int(<span class="string">"status"</span>,<span class="number"> 200</span>),</div><div class="line">  slog.String(</div><div class="line">    <span class="string">"user_agent"</span>,</div><div class="line">    <span class="string">"Googlebot/2.1 (+http://www.google.com/bot.html)"</span>,</div><div class="line">  ),</div><div class="line">)</div></pre></td></tr></table></figure>

<p>虽然这是上下文日志记录的一种更好的方法,但它并不是万无一失的,因为没有什么能阻止您混合使用强类型和宽松类型的键/值对,就像这样:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">logger.Info(</div><div class="line">  <span class="string">"incoming request"</span>,</div><div class="line">  <span class="string">"method"</span>, <span class="string">"GET"</span>,</div><div class="line">  slog.Int(<span class="string">"time_taken_ms"</span>,<span class="number"> 158</span>),</div><div class="line">  slog.String(<span class="string">"path"</span>, <span class="string">"/hello/world?q=search"</span>),</div><div class="line">  <span class="string">"status"</span>,<span class="number"> 200</span>,</div><div class="line">  slog.String(</div><div class="line">    <span class="string">"user_agent"</span>,</div><div class="line">    <span class="string">"Googlebot/2.1 (+http://www.google.com/bot.html)"</span>,</div><div class="line">  ),</div><div class="line">)</div></pre></td></tr></table></figure>

<p>要在为记录添加上下文属性时保证类型安全,您必须使用 <code>LogAttrs()</code> 方法,像这样:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">logger.LogAttrs(</div><div class="line">  context.Background(),</div><div class="line">  slog.LevelInfo,</div><div class="line">  <span class="string">"incoming request"</span>,</div><div class="line">  slog.String(<span class="string">"method"</span>, <span class="string">"GET"</span>),</div><div class="line">  slog.Int(<span class="string">"time_taken_ms"</span>,<span class="number"> 158</span>),</div><div class="line">  slog.String(<span class="string">"path"</span>, <span class="string">"/hello/world?q=search"</span>),</div><div class="line">  slog.Int(<span class="string">"status"</span>,<span class="number"> 200</span>),</div><div class="line">  slog.String(</div><div class="line">    <span class="string">"user_agent"</span>,</div><div class="line">    <span class="string">"Googlebot/2.1 (+http://www.google.com/bot.html)"</span>,</div><div class="line">  ),</div><div class="line">)</div></pre></td></tr></table></figure>

<p>这个方法只接受 <code>slog.Attr</code> 类型的自定义属性,因此不可能出现不平衡的键/值对。然而,它的 API 更加复杂,因为除了日志消息和自定义属性外,您总是需要向该方法传递上下文(或 nil)和日志级别。</p>
<h2 id="分组上下文属性">分组上下文属性</h2>
<p>Slog 还允许在单个名称下对多个属性进行分组,但输出取决于所使用的 <code>Handler</code>。例如,对于 <code>JSONHandler</code>,每个组都嵌套在 <code>JSON</code> 对象中:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">logger.LogAttrs(</div><div class="line">  context.Background(),</div><div class="line">  slog.LevelInfo,</div><div class="line">  <span class="string">"image uploaded"</span>,</div><div class="line">  slog.Int(<span class="string">"id"</span>,<span class="number"> 23123</span>),</div><div class="line">  slog.Group(<span class="string">"properties"</span>,</div><div class="line">    slog.Int(<span class="string">"width"</span>,<span class="number"> 4000</span>),</div><div class="line">    slog.Int(<span class="string">"height"</span>,<span class="number"> 3000</span>),</div><div class="line">    slog.String(<span class="string">"format"</span>, <span class="string">"jpeg"</span>),</div><div class="line">  ),</div><div class="line">)</div></pre></td></tr></table></figure>



<figure class="highlight log"><figcaption><span>output</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">{</div><div class="line">  "<span class="attribute">time</span>":<span class="value"><span class="string">"2023-02-24T12:03:12.175582603+01:00"</span></span>,</div><div class="line">  "<span class="attribute">level</span>":<span class="value"><span class="string">"INFO"</span></span>,</div><div class="line">  "<span class="attribute">msg</span>":<span class="value"><span class="string">"image uploaded"</span></span>,</div><div class="line">  "<span class="attribute">id</span>":<span class="value"><span class="number">23123</span></span>,</div><div class="line">  "<span class="attribute">properties</span>":<span class="value">{</span></div><div class="line">    "<span class="attribute">width</span>":<span class="value"><span class="number">4000</span></span>,</div><div class="line">    "<span class="attribute">height</span>":<span class="value"><span class="number">3000</span></span>,</div><div class="line">    "<span class="attribute">format</span>":<span class="value"><span class="string">"jpeg"</span></span></div><div class="line">  }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>当使用 TextHandler 时,组中的每个键都将以组名作为前缀,如下所示:</p>
<figure class="highlight log"><figcaption><span>output</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="variable">time=</span><span class="number">2023</span>-<span class="number">02</span>-<span class="number">24</span>T12:<span class="number">06</span>:<span class="number">20.249</span>+<span class="number">01</span>:<span class="number">00</span> <span class="variable">level=</span>INFO <span class="variable">msg=</span><span class="string">"image uploaded"</span> <span class="variable">id=</span><span class="number">23123</span></div><div class="line">  properties.<span class="variable">width=</span><span class="number">4000</span> properties.<span class="variable">height=</span><span class="number">3000</span> properties.<span class="variable">format=</span>jpeg</div></pre></td></tr></table></figure>

<h2 id="创建和使用子_logger">创建和使用子 logger</h2>
<p>在特定范围内的所有记录中包含相同的属性,可以确保它们的存在而无需重复的日志记录语句,这是很有益的。</p>
<p>这就是子 <code>logger</code> 可以派上用场的地方,它创建了一个新的日志记录上下文,该上下文从其父级继承而来,同时允许包含额外的字段。</p>
<p>在 <code>slog</code> 中,创建子 <code>logger</code> 是使用 <code>Logger.With()</code> 方法完成的。它接受一个或多个键/值对,并返回一个包含指定属性的新 <code>Logger</code>。</p>
<p>考虑以下代码片段,它将程序的进程 <code>ID</code> 和用于编译的 <code>Go 版本</code>添加到每个日志记录中,并将它们存储在 <code>program_info</code> 属性中:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> main() {</div><div class="line">    handler := slog.NewJSONHandler(os.Stdout, <span class="constant">nil</span>)</div><div class="line">    buildInfo, _ := debug.ReadBuildInfo()</div><div class="line"></div><div class="line">    logger := slog.New(handler)</div><div class="line"></div><div class="line">    child := logger.With(</div><div class="line">        slog.Group(<span class="string">"program_info"</span>,</div><div class="line">            slog.Int(<span class="string">"pid"</span>, os.Getpid()),</div><div class="line">            slog.String(<span class="string">"go_version"</span>, buildInfo.GoVersion),</div><div class="line">        ),</div><div class="line">    )</div><div class="line"></div><div class="line">    . . .</div><div class="line">}</div></pre></td></tr></table></figure>

<p>有了这个配置，所有由子日志记录器创建的记录都会包含 program_info 属性下指定的属性，只要它在日志点没有被覆盖。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> main() {</div><div class="line">    . . .</div><div class="line"></div><div class="line">    child.Info(<span class="string">"image upload successful"</span>, slog.String(<span class="string">"image_id"</span>, <span class="string">"39ud88"</span>))</div><div class="line">    child.Warn(</div><div class="line">        <span class="string">"storage is 90% full"</span>,</div><div class="line">        slog.String(<span class="string">"available_space"</span>, <span class="string">"900.1 mb"</span>),</div><div class="line">    )</div><div class="line">}</div></pre></td></tr></table></figure>



<figure class="highlight log"><figcaption><span>output</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">{</div><div class="line">  "<span class="attribute">time</span>": <span class="value"><span class="string">"2023-02-26T19:26:46.046793623+01:00"</span></span>,</div><div class="line">  "<span class="attribute">level</span>": <span class="value"><span class="string">"INFO"</span></span>,</div><div class="line">  "<span class="attribute">msg</span>": <span class="value"><span class="string">"image upload successful"</span></span>,</div><div class="line">  "<span class="attribute">program_info</span>": <span class="value">{</span></div><div class="line">    "<span class="attribute">pid</span>": <span class="value"><span class="number">229108</span></span>,</div><div class="line">    "<span class="attribute">go_version</span>": <span class="value"><span class="string">"go1.20"</span></span></div><div class="line">  },</div><div class="line">  "<span class="attribute">image_id</span>": <span class="value"><span class="string">"39ud88"</span></span></div><div class="line">}</div><div class="line">{</div><div class="line">  "<span class="attribute">time</span>": <span class="value"><span class="string">"2023-02-26T19:26:46.046847902+01:00"</span></span>,</div><div class="line">  "<span class="attribute">level</span>": <span class="value"><span class="string">"WARN"</span></span>,</div><div class="line">  "<span class="attribute">msg</span>": <span class="value"><span class="string">"storage is 90% full"</span></span>,</div><div class="line">  "<span class="attribute">program_info</span>": <span class="value">{</span></div><div class="line">    "<span class="attribute">pid</span>": <span class="value"><span class="number">229108</span></span>,</div><div class="line">    "<span class="attribute">go_version</span>": <span class="value"><span class="string">"go1.20"</span></span></div><div class="line">  },</div><div class="line">  "<span class="attribute">available_space</span>": <span class="value"><span class="string">"900.1 MB"</span></span></div><div class="line">}</div></pre></td></tr></table></figure>

<p>您还可以使用 <code>WithGroup()</code> 方法创建一个子日志记录器，该方法会启动一个组，以便添加到日志记录器中的所有属性（包括在日志点添加的属性）都嵌套在组名下:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">handler := slog.NewJSONHandler(os.Stdout, <span class="constant">nil</span>)</div><div class="line">buildInfo, _ := debug.ReadBuildInfo()</div><div class="line">logger := slog.New(handler).WithGroup(<span class="string">"program_info"</span>)</div><div class="line"></div><div class="line">child := logger.With(</div><div class="line">  slog.Int(<span class="string">"pid"</span>, os.Getpid()),</div><div class="line">  slog.String(<span class="string">"go_version"</span>, buildInfo.GoVersion),</div><div class="line">)</div><div class="line"></div><div class="line">child.Warn(</div><div class="line">  <span class="string">"storage is 90% full"</span>,</div><div class="line">  slog.String(<span class="string">"available_space"</span>, <span class="string">"900.1 MB"</span>),</div><div class="line">)</div></pre></td></tr></table></figure>



<figure class="highlight log"><figcaption><span>output</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">{</div><div class="line">  "<span class="attribute">time</span>": <span class="value"><span class="string">"2023-05-24T19:00:18.384136084+01:00"</span></span>,</div><div class="line">  "<span class="attribute">level</span>": <span class="value"><span class="string">"WARN"</span></span>,</div><div class="line">  "<span class="attribute">msg</span>": <span class="value"><span class="string">"storage is 90% full"</span></span>,</div><div class="line">  "<span class="attribute">program_info</span>": <span class="value">{</span></div><div class="line">    "<span class="attribute">pid</span>": <span class="value"><span class="number">1971993</span></span>,</div><div class="line">    "<span class="attribute">go_version</span>": <span class="value"><span class="string">"go1.20.2"</span></span>,</div><div class="line">    "<span class="attribute">available_space</span>": <span class="value"><span class="string">"900.1 mb"</span></span></div><div class="line">  }</div><div class="line">}</div></pre></td></tr></table></figure>

<h2 id="自定义_slog_日志级别">自定义 slog 日志级别</h2>
<p>log/slog 软件包默认提供四个日志级别，每个级别都与一个整数值相关联：</p>
<ul>
<li>DEBUG (-4)</li>
<li>INFO (0)</li>
<li>WARN (4)</li>
<li>ERROR (8)</li>
</ul>
<p>每个级别之间间隔 <strong>4</strong> 是经过深思熟虑的设计决策，目的是为了适应在默认级别之间使用自定义级别的日志记录方案。例如，您可以使用 <strong>1</strong>、<strong>2</strong> 或 <strong>3</strong> 的值创建介于 <code>INFO</code> 和 <code>WARN</code> 之间的新日志级别。</p>
<p>我们之前看到过，默认情况下所有日志记录器都配置为 <code>INFO</code> 级别记录日志，这会导致低于该严重性（例如 <code>DEBUG</code>）的事件被忽略。您可以通过以下所示的 <code>HandlerOptions</code> 类型来自定义此行为：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> main() {</div><div class="line">    opts := &slog.HandlerOptions{</div><div class="line">        Level: slog.LevelDebug,</div><div class="line">    }</div><div class="line"></div><div class="line">    handler := slog.NewJSONHandler(os.Stdout, opts)</div><div class="line"></div><div class="line">    logger := slog.New(handler)</div><div class="line">    logger.Debug(<span class="string">"Debug message"</span>)</div><div class="line">    logger.Info(<span class="string">"Info message"</span>)</div><div class="line">    logger.Warn(<span class="string">"Warning message"</span>)</div><div class="line">    logger.Error(<span class="string">"Error message"</span>)</div><div class="line">}</div></pre></td></tr></table></figure>



<figure class="highlight log"><figcaption><span>output</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">{"<span class="attribute">time</span>":<span class="value"><span class="string">"2023-05-24T19:03:10.70311982+01:00"</span></span>,"<span class="attribute">level</span>":<span class="value"><span class="string">"DEBUG"</span></span>,"<span class="attribute">msg</span>":<span class="value"><span class="string">"Debug message"</span></span>}</div><div class="line">{"<span class="attribute">time</span>":<span class="value"><span class="string">"2023-05-24T19:03:10.703187713+01:00"</span></span>,"<span class="attribute">level</span>":<span class="value"><span class="string">"INFO"</span></span>,"<span class="attribute">msg</span>":<span class="value"><span class="string">"Info message"</span></span>}</div><div class="line">{"<span class="attribute">time</span>":<span class="value"><span class="string">"2023-05-24T19:03:10.703190419+01:00"</span></span>,"<span class="attribute">level</span>":<span class="value"><span class="string">"WARN"</span></span>,"<span class="attribute">msg</span>":<span class="value"><span class="string">"Warning message"</span></span>}</div><div class="line">{"<span class="attribute">time</span>":<span class="value"><span class="string">"2023-05-24T19:03:10.703192892+01:00"</span></span>,"<span class="attribute">level</span>":<span class="value"><span class="string">"ERROR"</span></span>,"<span class="attribute">msg</span>":<span class="value"><span class="string">"Error message"</span></span>}</div></pre></td></tr></table></figure>

<p>这种设置日志级别的方法会固定处理程序在整个生命周期内的日志级别。如果您需要<a href="https://betterstack.com/community/guides/logging/change-log-levels-dynamically/" target="_blank" rel="external">动态调整</a>最低日志级别，则必须使用 <code>LevelVar</code> 类型，如下所示：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> main() {</div><div class="line">    logLevel := &slog.LevelVar{} <span class="comment">// INFO</span></div><div class="line"></div><div class="line">    opts := &slog.HandlerOptions{</div><div class="line">        Level: logLevel,</div><div class="line">    }</div><div class="line"></div><div class="line">    handler := slog.NewJSONHandler(os.Stdout, opts)</div><div class="line"></div><div class="line">    ...</div><div class="line">}</div></pre></td></tr></table></figure>

<p>之后您可以随时使用以下方式更新日志级别：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">logLevel.Set(slog.LevelDebug)</div></pre></td></tr></table></figure>

<h2 id="创建自定义日志级别">创建自定义日志级别</h2>
<p>如果您需要超出 slog 默认提供的日志级别，可以通过实现 <code>Leveler</code> 接口来创建它们。该接口的签名如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Leveler <span class="keyword">interface</span> {</div><div class="line">    Level() Level</div><div class="line">}</div></pre></td></tr></table></figure>

<p>实现这个接口很简单，可以使用下面展示的 <code>Level</code> 类型（因为 <code>Level</code> 本身就实现了 <code>Leveler</code> 接口）：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> (</div><div class="line">    LevelTrace  = slog.Level<span class="number">(-8</span>)</div><div class="line">    LevelFatal  = slog.Level<span class="number">(12</span>)</div><div class="line">)</div></pre></td></tr></table></figure>

<p>一旦您像上面那样定义了自定义日志级别，您就只能通过 <code>Log()</code> 或 <code>LogAttrs()</code> 方法来使用它们：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">opts := &slog.HandlerOptions{</div><div class="line">    Level: LevelTrace,</div><div class="line">}</div><div class="line"></div><div class="line">logger := slog.New(slog.NewJSONHandler(os.Stdout, opts))</div><div class="line"></div><div class="line">ctx := context.Background()</div><div class="line">logger.Log(ctx, LevelTrace, <span class="string">"Trace message"</span>)</div><div class="line">logger.Log(ctx, LevelFatal, <span class="string">"Fatal level"</span>)</div></pre></td></tr></table></figure>



<figure class="highlight log"><figcaption><span>output</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">{"<span class="attribute">time</span>":<span class="value"><span class="string">"2023-02-24T09:26:41.666493901+01:00"</span></span>,"<span class="attribute">level</span>":<span class="value"><span class="string">"DEBUG-4"</span></span>,"<span class="attribute">msg</span>":<span class="value"><span class="string">"Trace level"</span></span>}</div><div class="line">{"<span class="attribute">time</span>":<span class="value"><span class="string">"2023-02-24T09:26:41.666602404+01:00"</span></span>,"<span class="attribute">level</span>":<span class="value"><span class="string">"ERROR+4"</span></span>,"<span class="attribute">msg</span>":<span class="value"><span class="string">"Fatal level"</span></span>}</div></pre></td></tr></table></figure>

<p>注意到自定义日志级别会使用默认级别的名称进行标注。这显然不是您想要的，因此应该通过 <code>HandlerOptions</code> 类型来自定义级别名称，如下所示：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line"></div><div class="line"><span class="keyword">var</span> LevelNames = <span class="keyword">map</span>[slog.Leveler]<span class="typename">string</span>{</div><div class="line">    LevelTrace:      <span class="string">"TRACE"</span>,</div><div class="line">    LevelFatal:      <span class="string">"FATAL"</span>,</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">func</span> main() {</div><div class="line">    opts := slog.HandlerOptions{</div><div class="line">        Level: LevelTrace,</div><div class="line">        ReplaceAttr: <span class="keyword">func</span>(groups []<span class="typename">string</span>, a slog.Attr) slog.Attr {</div><div class="line">            <span class="keyword">if</span> a.Key == slog.LevelKey {</div><div class="line">                level := a.Value.Any().(slog.Level)</div><div class="line">                levelLabel, exists := LevelNames[level]</div><div class="line">                <span class="keyword">if</span> !exists {</div><div class="line">                    levelLabel = level.String()</div><div class="line">                }</div><div class="line"></div><div class="line">                a.Value = slog.StringValue(levelLabel)</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="keyword">return</span> a</div><div class="line">        },</div><div class="line">    }</div><div class="line"></div><div class="line">    ...</div><div class="line">}</div></pre></td></tr></table></figure>

<p><code>ReplaceAttr()</code> 函数用于自定义 <code>Handler</code> 如何处理 <code>Recor</code>d 中的每个键值对。它可以用来修改键名，或者以某种方式处理值。</p>
<p>在给定的示例中，它将自定义日志级别映射到它们各自的标签，分别生成 <code>TRACE</code> 和 <code>FATAL</code>:</p>
<figure class="highlight log"><figcaption><span>output</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">{"<span class="attribute">time</span>":<span class="value"><span class="string">"2023-02-24T09:27:51.747625912+01:00"</span></span>,"<span class="attribute">level</span>":<span class="value"><span class="string">"TRACE"</span></span>,"<span class="attribute">msg</span>":<span class="value"><span class="string">"Trace level"</span></span>}</div><div class="line">{"<span class="attribute">time</span>":<span class="value"><span class="string">"2023-02-24T09:27:51.747737319+01:00"</span></span>,"<span class="attribute">level</span>":<span class="value"><span class="string">"FATAL"</span></span>,"<span class="attribute">msg</span>":<span class="value"><span class="string">"Fatal level"</span></span>}</div></pre></td></tr></table></figure>

<h2 id="自定义_slog_处理程序">自定义 slog 处理程序</h2>
<p>正如之前提到的，<code>TextHandler</code> 和 <code>JSONHandler</code> 都可以使用 <code>HandlerOptions</code> 类型进行定制。您已经看过如何调整最低日志级别以及在记录日志之前修改属性。</p>
<p>通过 <code>HandlerOptions</code> 还可实现的其他自定义功能包括（如果需要的话）：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">opts := &slog.HandlerOptions{</div><div class="line">    AddSource: <span class="constant">true</span>,</div><div class="line">    Level:     slog.LevelDebug,</div><div class="line">}</div></pre></td></tr></table></figure>



<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">{</div><div class="line">  <span class="string">"time"</span>: <span class="string">"2024-01-03T11:06:50.971029852+01:00"</span>,</div><div class="line">  <span class="string">"level"</span>: <span class="string">"DEBUG"</span>,</div><div class="line">  <span class="string">"source"</span>: {</div><div class="line">    <span class="string">"function"</span>: <span class="string">"main.main"</span>,</div><div class="line">    <span class="string">"file"</span>: <span class="string">"/home/ayo/dev/betterstack/demo/slog/main.go"</span>,</div><div class="line">    <span class="string">"line"</span>:<span class="number"> 17</span></div><div class="line">  },</div><div class="line">  <span class="string">"msg"</span>: <span class="string">"Debug message"</span></div><div class="line">}</div></pre></td></tr></table></figure>

<p>根据应用环境切换日志处理程序也非常简单。例如，您可能更喜欢在开发过程中使用 <code>TextHandler</code>，因为它更易于阅读，然后在生产环境中切换到 <code>JSONHandler</code> 以获得更大的灵活性并兼容各种日志工具。</p>
<p>这种行为可以通过环境变量轻松实现：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> appEnv = os.Getenv(<span class="string">"APP_ENV"</span>)</div><div class="line"></div><div class="line"><span class="keyword">func</span> main() {</div><div class="line">    opts := &slog.HandlerOptions{</div><div class="line">        Level: slog.LevelDebug,</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">var</span> handler slog.Handler = slog.NewTextHandler(os.Stdout, opts)</div><div class="line">    <span class="keyword">if</span> appEnv == <span class="string">"production"</span> {</div><div class="line">        handler = slog.NewJSONHandler(os.Stdout, opts)</div><div class="line">    }</div><div class="line"></div><div class="line">    logger := slog.New(handler)</div><div class="line"></div><div class="line">    logger.Info(<span class="string">"Info message"</span>)</div><div class="line">}</div></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$go</span> run main.go</div></pre></td></tr></table></figure>



<figure class="highlight log"><figcaption><span>output</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">time=</span><span class="number">2023</span>-<span class="number">02</span>-<span class="number">24</span>T10:<span class="number">36</span>:<span class="number">39.697</span>+<span class="number">01</span>:<span class="number">00</span> <span class="variable">level=</span>INFO <span class="variable">msg=</span><span class="string">"Info message"</span></div></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$APP_ENV</span>=production go run main.go</div></pre></td></tr></table></figure>



<figure class="highlight log"><figcaption><span>output</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">{"<span class="attribute">time</span>":<span class="value"><span class="string">"2023-02-24T10:35:16.964821548+01:00"</span></span>,"<span class="attribute">level</span>":<span class="value"><span class="string">"INFO"</span></span>,"<span class="attribute">msg</span>":<span class="value"><span class="string">"Info message"</span></span>}</div></pre></td></tr></table></figure>

<h3 id="创建自定义日志处理程序">创建自定义日志处理程序</h3>
<p>由于 Handler 是一个接口，因此可以创建自定义处理程序来以不同的格式格式化日志或将它们写入其他目的地。</p>
<p>该接口的签名如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Handler <span class="keyword">interface</span> {</div><div class="line">    Enabled(context.Context, Level) <span class="typename">bool</span></div><div class="line">    Handle(context.Context, r Record) error</div><div class="line">    WithAttrs(attrs []Attr) Handler</div><div class="line">    WithGroup(name <span class="typename">string</span>) Handler</div><div class="line">}</div></pre></td></tr></table></figure>

<p>以下是每个方法的解释：</p>
<ul>
<li>Enabled：判断日志记录是否应该被处理或丢弃，依据是日志记录的级别。上下文信息也可以用于决策。</li>
<li>Handle：处理发送到该处理程序的每个日志记录 (record)。仅当 Enabled 返回 true 时才会调用此方法。</li>
<li>WithAttrs：使用现有处理程序创建一个新处理程序，并向其中添加指定的属性 (attrs)。</li>
<li>WithGroup：使用现有处理程序创建一个新处理程序，并向其中添加指定的组名 (group)，该名称限定后续的属性。</li>
<li>这是一个使用 log、json 和 <a href="https://github.com/fatih/color" target="_blank" rel="external">color</a> 软件包来实现美化开发环境日志输出的示例：</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// NOTE: Not well tested, just an illustration of what's possible</span></div><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"context"</span></div><div class="line">    <span class="string">"encoding/json"</span></div><div class="line">    <span class="string">"io"</span></div><div class="line">    <span class="string">"log"</span></div><div class="line">    <span class="string">"log/slog"</span></div><div class="line"></div><div class="line">    <span class="string">"github.com/fatih/color"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">type</span> PrettyHandlerOptions <span class="keyword">struct</span> {</div><div class="line">    SlogOpts slog.HandlerOptions</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">type</span> PrettyHandler <span class="keyword">struct</span> {</div><div class="line">    slog.Handler</div><div class="line">    l *log.Logger</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">func</span> (h *PrettyHandler) Handle(ctx context.Context, r slog.Record) error {</div><div class="line">    level := r.Level.String() + <span class="string">":"</span></div><div class="line"></div><div class="line">    <span class="keyword">switch</span> r.Level {</div><div class="line">    <span class="keyword">case</span> slog.LevelDebug:</div><div class="line">        level = color.MagentaString(level)</div><div class="line">    <span class="keyword">case</span> slog.LevelInfo:</div><div class="line">        level = color.BlueString(level)</div><div class="line">    <span class="keyword">case</span> slog.LevelWarn:</div><div class="line">        level = color.YellowString(level)</div><div class="line">    <span class="keyword">case</span> slog.LevelError:</div><div class="line">        level = color.RedString(level)</div><div class="line">    }</div><div class="line"></div><div class="line">    fields := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="typename">string</span>]<span class="keyword">interface</span>{}, r.NumAttrs())</div><div class="line">    r.Attrs(<span class="keyword">func</span>(a slog.Attr) <span class="typename">bool</span> {</div><div class="line">        fields[a.Key] = a.Value.Any()</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="constant">true</span></div><div class="line">    })</div><div class="line"></div><div class="line">    b, err := json.MarshalIndent(fields, <span class="string">""</span>, <span class="string">"  "</span>)</div><div class="line">    <span class="keyword">if</span> err != <span class="constant">nil</span> {</div><div class="line">        <span class="keyword">return</span> err</div><div class="line">    }</div><div class="line"></div><div class="line">    timeStr := r.Time.Format(<span class="string">"[15:05:05.000]"</span>)</div><div class="line">    msg := color.CyanString(r.Message)</div><div class="line"></div><div class="line">    h.l.Println(timeStr, level, msg, color.WhiteString(<span class="typename">string</span>(b)))</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="constant">nil</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">func</span> NewPrettyHandler(</div><div class="line">    out io.Writer,</div><div class="line">    opts PrettyHandlerOptions,</div><div class="line">) *PrettyHandler {</div><div class="line">    h := &PrettyHandler{</div><div class="line">        Handler: slog.NewJSONHandler(out, &opts.SlogOpts),</div><div class="line">        l:       log.New(out, <span class="string">""</span>,<span class="number"> 0</span>),</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">return</span> h</div><div class="line">}</div></pre></td></tr></table></figure>

<p>你的代码使用<code>PrettyHandler</code>的方式如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> main() {</div><div class="line">    opts := PrettyHandlerOptions{</div><div class="line">        SlogOpts: slog.HandlerOptions{</div><div class="line">            Level: slog.LevelDebug,</div><div class="line">        },</div><div class="line">    }</div><div class="line">    handler := NewPrettyHandler(os.Stdout, opts)</div><div class="line">    logger := slog.New(handler)</div><div class="line">    logger.Debug(</div><div class="line">        <span class="string">"executing database query"</span>,</div><div class="line">        slog.String(<span class="string">"query"</span>, <span class="string">"SELECT * FROM users"</span>),</div><div class="line">    )</div><div class="line">    logger.Info(<span class="string">"image upload successful"</span>, slog.String(<span class="string">"image_id"</span>, <span class="string">"39ud88"</span>))</div><div class="line">    logger.Warn(</div><div class="line">        <span class="string">"storage is 90% full"</span>,</div><div class="line">        slog.String(<span class="string">"available_space"</span>, <span class="string">"900.1 MB"</span>),</div><div class="line">    )</div><div class="line">    logger.Error(</div><div class="line">        <span class="string">"An error occurred while processing the request"</span>,</div><div class="line">        slog.String(<span class="string">"url"</span>, <span class="string">"https://example.com"</span>),</div><div class="line">    )</div><div class="line">}</div></pre></td></tr></table></figure>

<p>当你执行程序时你会看到如下彩色的输出：<br><img src="color.png" alt=""></p>
<p>你可以在 <a href="https://github.com/search?q=slog-+language%3AGo&amp;type=repositories&amp;l=Go" target="_blank" rel="external">GitHub</a> 和这篇 <a href="https://tip.golang.org/wiki/Resources-for-slog" target="_blank" rel="external">Go Wiki 页面</a>上找到社区创建的几个自定义处理程序。 一些值得关注的例子包括：</p>
<ul>
<li><a href="https://github.com/lmittmann/tint" target="_blank" rel="external">tint</a> - 用于写入带颜色的日志（彩色日志）。</li>
<li><a href="https://github.com/samber/slog-sampling" target="_blank" rel="external">slog-sampling</a> - 通过丢弃重复的日志记录来提高日志处理吞吐量。</li>
<li><a href="https://github.com/samber/slog-multi" target="_blank" rel="external">slog-multi</a> - 实现中间件、扇出、路由、故障转移、负载均衡等工作流。</li>
<li><a href="https://github.com/samber/slog-formatter" target="_blank" rel="external">slog-formatter</a> - 提供更灵活的属性格式化。</li>
</ul>
<h2 id="使用_context_包">使用 context 包</h2>
<p>到目前为止，我们主要使用的是诸如 <code>Info()</code> 和 <code>Debug()</code> 等标准级别的函数，但 slog 还提供了支持 <code>context</code> 的变体，这些变体将 <code>context.Context</code> 值作为第一个参数。下面是每个函数的签名：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> (ctx context.Context, msg <span class="typename">string</span>, args ...any)</div></pre></td></tr></table></figure>

<p>使用这些方法，您可以通过将上下文属性存储在 <code>Context</code> 中来跨函数传播它们，这样当找到这些值时，它们就会被添加到任何生成的日志记录中。</p>
<p>请考虑以下程序：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"context"</span></div><div class="line">    <span class="string">"log/slog"</span></div><div class="line">    <span class="string">"os"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">func</span> main() {</div><div class="line">    logger := slog.New(slog.NewJSONHandler(os.Stdout, <span class="constant">nil</span>))</div><div class="line"></div><div class="line">    ctx := context.WithValue(context.Background(), <span class="string">"request_id"</span>, <span class="string">"req-123"</span>)</div><div class="line"></div><div class="line">    logger.InfoContext(ctx, <span class="string">"image uploaded"</span>, slog.String(<span class="string">"image_id"</span>, <span class="string">"img-998"</span>))</div><div class="line">}</div></pre></td></tr></table></figure>

<p>在代码中，我们向 <code>ctx</code> 变量添加了一个 <code>request_id</code> 并传递给了 <code>InfoContext</code> 方法。然而，运行程序后，日志中却没有出现 <code>request_id</code> 字段。</p>
<figure class="highlight log"><figcaption><span>output</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">{</div><div class="line">  "<span class="attribute">time</span>": <span class="value"><span class="string">"2024-01-02T11:04:28.590527494+01:00"</span></span>,</div><div class="line">  "<span class="attribute">level</span>": <span class="value"><span class="string">"INFO"</span></span>,</div><div class="line">  "<span class="attribute">msg</span>": <span class="value"><span class="string">"image uploaded"</span></span>,</div><div class="line">  "<span class="attribute">image_id</span>": <span class="value"><span class="string">"img-998"</span></span></div><div class="line">}</div></pre></td></tr></table></figure>

<p>为了实现这一功能，你需要创建一个自定义处理程序并重新实现 <code>Handle</code> 方法，如下所示：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> ctxKey <span class="typename">string</span></div><div class="line"></div><div class="line"><span class="keyword">const</span> (</div><div class="line">    slogFields ctxKey = <span class="string">"slog_fields"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">type</span> ContextHandler <span class="keyword">struct</span> {</div><div class="line">    slog.Handler</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// Handle adds contextual attributes to the Record before calling the underlying</span></div><div class="line"><span class="comment">// handler</span></div><div class="line"><span class="keyword">func</span> (h ContextHandler) Handle(ctx context.Context, r slog.Record) error {</div><div class="line">    <span class="keyword">if</span> attrs, ok := ctx.Value(slogFields).([]slog.Attr); ok {</div><div class="line">        <span class="keyword">for</span> _, v := <span class="keyword">range</span> attrs {</div><div class="line">            r.AddAttrs(v)</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">return</span> h.Handler.Handle(ctx, r)</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// AppendCtx adds an slog attribute to the provided context so that it will be</span></div><div class="line"><span class="comment">// included in any Record created with such context</span></div><div class="line"><span class="keyword">func</span> AppendCtx(parent context.Context, attr slog.Attr) context.Context {</div><div class="line">    <span class="keyword">if</span> parent == <span class="constant">nil</span> {</div><div class="line">        parent = context.Background()</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">if</span> v, ok := parent.Value(slogFields).([]slog.Attr); ok {</div><div class="line">        v = <span class="built_in">append</span>(v, attr)</div><div class="line">        <span class="keyword">return</span> context.WithValue(parent, slogFields, v)</div><div class="line">    }</div><div class="line"></div><div class="line">    v := []slog.Attr{}</div><div class="line">    v = <span class="built_in">append</span>(v, attr)</div><div class="line">    <span class="keyword">return</span> context.WithValue(parent, slogFields, v)</div><div class="line">}</div></pre></td></tr></table></figure>

<p><code>ContextHandler</code> 结构体嵌入了 <code>slog.Handler</code> 接口，并实现了 <code>Handle</code> 方法。该方法的作用是提取提供者上下文 (context) 中存储的 Slog 属性。如果找到这些属性，它们将被添加到日志记录 (<code>Record</code>) 中。 然后，底层的处理程序 (Handler) 会被调用，负责格式化并输出这条日志记录。</p>
<p>另一方面，<code>AppendCtx</code> 函数用于向 <code>context.Context</code> 中添加 Slog 属性。它使用 <code>slogFields</code> 这个键作为标识符，使得 <code>ContextHandler</code> 能够访问这些属性。</p>
<p>下面将介绍如何同时使用这两个部分来让 request_id 信息出现在日志中：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> main() {</div><div class="line">    h := &ContextHandler{slog.NewJSONHandler(os.Stdout, <span class="constant">nil</span>)}</div><div class="line"></div><div class="line">    logger := slog.New(h)</div><div class="line"></div><div class="line">    ctx := AppendCtx(context.Background(), slog.String(<span class="string">"request_id"</span>, <span class="string">"req-123"</span>))</div><div class="line"></div><div class="line">    logger.InfoContext(ctx, <span class="string">"image uploaded"</span>, slog.String(<span class="string">"image_id"</span>, <span class="string">"img-998"</span>))</div><div class="line">}</div></pre></td></tr></table></figure>

<p>现在您将观察到，使用 ctx 参数创建的任何日志记录中都包含了 <code>request_id</code> 信息。</p>
<figure class="highlight log"><figcaption><span>output</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">{</div><div class="line">  "<span class="attribute">time</span>": <span class="value"><span class="string">"2024-01-02T11:29:15.229984723+01:00"</span></span>,</div><div class="line">  "<span class="attribute">level</span>": <span class="value"><span class="string">"INFO"</span></span>,</div><div class="line">  "<span class="attribute">msg</span>": <span class="value"><span class="string">"image uploaded"</span></span>,</div><div class="line">  "<span class="attribute">image_id</span>": <span class="value"><span class="string">"img-998"</span></span>,</div><div class="line">  "<span class="attribute">request_id</span>": <span class="value"><span class="string">"req-123"</span></span></div><div class="line">}</div></pre></td></tr></table></figure>

<h2 id="slog_错误日志记录">slog 错误日志记录</h2>
<p>与大多数框架不同，slog 没有为 <code>error</code> 类型提供特定的日志记录助手函数。因此，您需要像这样使用 <code>slog.Any()</code> 记录错误：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">err := errors.New(<span class="string">"something happened"</span>)</div><div class="line"></div><div class="line">logger.ErrorContext(ctx, <span class="string">"upload failed"</span>, slog.Any(<span class="string">"error"</span>, err))</div></pre></td></tr></table></figure>



<figure class="highlight log"><figcaption><span>output</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">{</div><div class="line">  "<span class="attribute">time</span>": <span class="value"><span class="string">"2024-01-02T14:13:44.41886393+01:00"</span></span>,</div><div class="line">  "<span class="attribute">level</span>": <span class="value"><span class="string">"ERROR"</span></span>,</div><div class="line">  "<span class="attribute">msg</span>": <span class="value"><span class="string">"upload failed"</span></span>,</div><div class="line">  "<span class="attribute">error</span>": <span class="value"><span class="string">"something happened"</span></span></div><div class="line">}</div></pre></td></tr></table></figure>

<p>为了获取并记录错误的堆栈跟踪信息，您可以使用诸如 <a href="https://github.com/MDobak/go-xerrors" target="_blank" rel="external">xerrors</a> 之类的库来创建带有堆栈跟踪的错误对象：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">err := xerrors.New(<span class="string">"something happened"</span>)</div><div class="line"></div><div class="line">logger.ErrorContext(ctx, <span class="string">"upload failed"</span>, slog.Any(<span class="string">"error"</span>, err))</div></pre></td></tr></table></figure>

<p>为了在错误日志中看到堆栈跟踪信息，您还需要像之前提到的 <code>ReplaceAttr()</code> 函数一样，提取、格式化并将其添加到对应的 Record 中。</p>
<p>下面是一个例子：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"context"</span></div><div class="line">    <span class="string">"log/slog"</span></div><div class="line">    <span class="string">"os"</span></div><div class="line">    <span class="string">"path/filepath"</span></div><div class="line"></div><div class="line">    <span class="string">"github.com/mdobak/go-xerrors"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">type</span> stackFrame <span class="keyword">struct</span> {</div><div class="line">    Func   <span class="typename">string</span> <span class="string">`json:"func"`</span></div><div class="line">    Source <span class="typename">string</span> <span class="string">`json:"source"`</span></div><div class="line">    Line   <span class="typename">int</span>    <span class="string">`json:"line"`</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">func</span> replaceAttr(_ []<span class="typename">string</span>, a slog.Attr) slog.Attr {</div><div class="line">    <span class="keyword">switch</span> a.Value.Kind() {</div><div class="line">    <span class="keyword">case</span> slog.KindAny:</div><div class="line">        <span class="keyword">switch</span> v := a.Value.Any().(<span class="keyword">type</span>) {</div><div class="line">        <span class="keyword">case</span> error:</div><div class="line">            a.Value = fmtErr(v)</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">return</span> a</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// marshalStack extracts stack frames from the error</span></div><div class="line"><span class="keyword">func</span> marshalStack(err error) []stackFrame {</div><div class="line">    trace := xerrors.StackTrace(err)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(trace) ==<span class="number"> 0</span> {</div><div class="line">        <span class="keyword">return</span> <span class="constant">nil</span></div><div class="line">    }</div><div class="line"></div><div class="line">    frames := trace.Frames()</div><div class="line"></div><div class="line">    s := <span class="built_in">make</span>([]stackFrame, <span class="built_in">len</span>(frames))</div><div class="line"></div><div class="line">    <span class="keyword">for</span> i, v := <span class="keyword">range</span> frames {</div><div class="line">        f := stackFrame{</div><div class="line">            Source: filepath.Join(</div><div class="line">                filepath.Base(filepath.Dir(v.File)),</div><div class="line">                filepath.Base(v.File),</div><div class="line">            ),</div><div class="line">            Func: filepath.Base(v.Function),</div><div class="line">            Line: v.Line,</div><div class="line">        }</div><div class="line"></div><div class="line">        s[i] = f</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">return</span> s</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// fmtErr returns a slog.Value with keys `msg` and `trace`. If the error</span></div><div class="line"><span class="comment">// does not implement interface { StackTrace() errors.StackTrace }, the `trace`</span></div><div class="line"><span class="comment">// key is omitted.</span></div><div class="line"><span class="keyword">func</span> fmtErr(err error) slog.Value {</div><div class="line">    <span class="keyword">var</span> groupValues []slog.Attr</div><div class="line"></div><div class="line">    groupValues = <span class="built_in">append</span>(groupValues, slog.String(<span class="string">"msg"</span>, err.Error()))</div><div class="line"></div><div class="line">    frames := marshalStack(err)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> frames != <span class="constant">nil</span> {</div><div class="line">        groupValues = <span class="built_in">append</span>(groupValues,</div><div class="line">            slog.Any(<span class="string">"trace"</span>, frames),</div><div class="line">        )</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">return</span> slog.GroupValue(groupValues...)</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">func</span> main() {</div><div class="line">    h := slog.NewJSONHandler(os.Stdout, &slog.HandlerOptions{</div><div class="line">        ReplaceAttr: replaceAttr,</div><div class="line">    })</div><div class="line"></div><div class="line">    logger := slog.New(h)</div><div class="line"></div><div class="line">    ctx := context.Background()</div><div class="line"></div><div class="line">    err := xerrors.New(<span class="string">"something happened"</span>)</div><div class="line"></div><div class="line">    logger.ErrorContext(ctx, <span class="string">"image uploaded"</span>, slog.Any(<span class="string">"error"</span>, err))</div><div class="line">}</div></pre></td></tr></table></figure>

<p>结合以上步骤，任何使用 <code>xerrors.New()</code> 创建的错误都将以如下格式记录，其中包含格式良好的堆栈跟踪信息：</p>
<figure class="highlight log"><figcaption><span>output</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">{</div><div class="line">  "<span class="attribute">time</span>": <span class="value"><span class="string">"2024-01-03T07:09:31.013954119+01:00"</span></span>,</div><div class="line">  "<span class="attribute">level</span>": <span class="value"><span class="string">"ERROR"</span></span>,</div><div class="line">  "<span class="attribute">msg</span>": <span class="value"><span class="string">"image uploaded"</span></span>,</div><div class="line">  "<span class="attribute">error</span>": <span class="value">{</span></div><div class="line">    "<span class="attribute">msg</span>": <span class="value"><span class="string">"something happened"</span></span>,</div><div class="line">    "<span class="attribute">trace</span>": <span class="value">[</span></div><div class="line">      {</div><div class="line">        "<span class="attribute">func</span>": <span class="value"><span class="string">"main.main"</span></span>,</div><div class="line">        "<span class="attribute">source</span>": <span class="value"><span class="string">"slog/main.go"</span></span>,</div><div class="line">        "<span class="attribute">line</span>": <span class="value"><span class="number">82</span></span></div><div class="line">      },</div><div class="line">      {</div><div class="line">        "<span class="attribute">func</span>": <span class="value"><span class="string">"runtime.main"</span></span>,</div><div class="line">        "<span class="attribute">source</span>": <span class="value"><span class="string">"runtime/proc.go"</span></span>,</div><div class="line">        "<span class="attribute">line</span>": <span class="value"><span class="number">267</span></span></div><div class="line">      },</div><div class="line">      {</div><div class="line">        "<span class="attribute">func</span>": <span class="value"><span class="string">"runtime.goexit"</span></span>,</div><div class="line">        "<span class="attribute">source</span>": <span class="value"><span class="string">"runtime/asm_amd64.s"</span></span>,</div><div class="line">        "<span class="attribute">line</span>": <span class="value"><span class="number">1650</span></span></div><div class="line">      }</div><div class="line">    ]</div><div class="line">  }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>现在您可以轻松跟踪应用程序中任何意外错误的执行路径。</p>
<h2 id="使用_LogValuer_接口隐藏敏感字段">使用 LogValuer 接口隐藏敏感字段</h2>
<p><code>LogValuer</code> 接口允许您通过指定自定义类型的日志输出方式来标准化日志记录。以下是该接口的签名：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> LogValuer <span class="keyword">interface</span> {</div><div class="line">    LogValue() Value</div><div class="line">}</div></pre></td></tr></table></figure>

<p>实现了该接口的主要用途之一是在自定义类型中隐藏敏感字段。例如，这里有一个 <code>User</code> 类型，它没有实现 <code>LogValuer</code> 接口。请注意，当实例被记录时，敏感细节是如何暴露出来的：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// User does not implement `LogValuer` here</span></div><div class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> {</div><div class="line">    ID        <span class="typename">string</span> <span class="string">`json:"id"`</span></div><div class="line">    FirstName <span class="typename">string</span> <span class="string">`json:"first_name"`</span></div><div class="line">    LastName  <span class="typename">string</span> <span class="string">`json:"last_name"`</span></div><div class="line">    Email     <span class="typename">string</span> <span class="string">`json:"email"`</span></div><div class="line">    Password  <span class="typename">string</span> <span class="string">`json:"password"`</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">func</span> main() {</div><div class="line">    handler := slog.NewJSONHandler(os.Stdout, <span class="constant">nil</span>)</div><div class="line">    logger := slog.New(handler)</div><div class="line"></div><div class="line">    u := &User{</div><div class="line">        ID:        <span class="string">"user-12234"</span>,</div><div class="line">        FirstName: <span class="string">"Jan"</span>,</div><div class="line">        LastName:  <span class="string">"Doe"</span>,</div><div class="line">        Email:     <span class="string">"jan@example.com"</span>,</div><div class="line">        Password:  <span class="string">"pass-12334"</span>,</div><div class="line">    }</div><div class="line"></div><div class="line">    logger.Info(<span class="string">"info"</span>, <span class="string">"user"</span>, u)</div><div class="line">}</div></pre></td></tr></table></figure>



<figure class="highlight log"><figcaption><span>output</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">{</div><div class="line">  "<span class="attribute">time</span>": <span class="value"><span class="string">"2023-02-26T22:11:30.080656774+01:00"</span></span>,</div><div class="line">  "<span class="attribute">level</span>": <span class="value"><span class="string">"INFO"</span></span>,</div><div class="line">  "<span class="attribute">msg</span>": <span class="value"><span class="string">"info"</span></span>,</div><div class="line">  "<span class="attribute">user</span>": <span class="value">{</span></div><div class="line">    "<span class="attribute">id</span>": <span class="value"><span class="string">"user-12234"</span></span>,</div><div class="line">    "<span class="attribute">first_name</span>": <span class="value"><span class="string">"Jan"</span></span>,</div><div class="line">    "<span class="attribute">last_name</span>": <span class="value"><span class="string">"Doe"</span></span>,</div><div class="line">    "<span class="attribute">email</span>": <span class="value"><span class="string">"jan@example.com"</span></span>,</div><div class="line">    "<span class="attribute">password</span>": <span class="value"><span class="string">"pass-12334"</span></span></div><div class="line">  }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>由于该类型包含不应该出现在日志中的秘密字段（例如电子邮件和密码），这会带来问题，并且也可能使您的日志变得冗长。</p>
<p>您可以通过指定类型在日志中的表示方式来解决这个问题。例如，您可以仅指定记录 <code>ID</code> 字段，如下所示：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// implement the `LogValuer` interface on the User struct</span></div><div class="line"><span class="keyword">func</span> (u User) LogValue() slog.Value {</div><div class="line">    <span class="keyword">return</span> slog.StringValue(u.ID)</div><div class="line">}</div></pre></td></tr></table></figure>

<p>You will now observe the following output:</p>
<figure class="highlight log"><figcaption><span>output</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">{</div><div class="line">  "<span class="attribute">time</span>": <span class="value"><span class="string">"2023-02-26T22:43:28.184363059+01:00"</span></span>,</div><div class="line">  "<span class="attribute">level</span>": <span class="value"><span class="string">"INFO"</span></span>,</div><div class="line">  "<span class="attribute">msg</span>": <span class="value"><span class="string">"info"</span></span>,</div><div class="line">  "<span class="attribute">user</span>": <span class="value"><span class="string">"user-12234"</span></span></div><div class="line">}</div></pre></td></tr></table></figure>

<p>除了隐藏敏感字段，您还可以像这样对多个属性进行分组：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> (u User) LogValue() slog.Value {</div><div class="line">    <span class="keyword">return</span> slog.GroupValue(</div><div class="line">        slog.String(<span class="string">"id"</span>, u.ID),</div><div class="line">        slog.String(<span class="string">"name"</span>, u.FirstName+<span class="string">" "</span>+u.LastName),</div><div class="line">    )</div><div class="line">}</div></pre></td></tr></table></figure>



<figure class="highlight log"><figcaption><span>output</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">{</div><div class="line">  "<span class="attribute">time</span>": <span class="value"><span class="string">"2023-03-15T14:44:24.223381036+01:00"</span></span>,</div><div class="line">  "<span class="attribute">level</span>": <span class="value"><span class="string">"INFO"</span></span>,</div><div class="line">  "<span class="attribute">msg</span>": <span class="value"><span class="string">"info"</span></span>,</div><div class="line">  "<span class="attribute">user</span>": <span class="value">{</span></div><div class="line">    "<span class="attribute">id</span>": <span class="value"><span class="string">"user-12234"</span></span>,</div><div class="line">    "<span class="attribute">name</span>": <span class="value"><span class="string">"Jan Doe"</span></span></div><div class="line">  }</div><div class="line">}</div></pre></td></tr></table></figure>

<h2 id="使用第三方日志后端与_Slog_集成">使用第三方日志后端与 Slog 集成</h2>
<p>slog 设计的主要目标之一是在 Go 应用程序中提供统一的日志记录前端（<code>slog.Logger</code>），同时后端（<code>slog.Handler</code>）可以根据程序进行定制。</p>
<p>这样一来，即使后端不同，所有依赖项使用的日志记录 API 都是一致的。 同时，通过使切换不同的后端变得简单，避免了将日志记录实现与特定包耦合在一起。</p>
<p>以下示例展示了将 Slog 前端与 Zap 后端结合使用，可以实现两者的优势：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ <span class="keyword">go</span> get <span class="keyword">go</span>.uber.org/zap</div><div class="line">$ <span class="keyword">go</span> get <span class="keyword">go</span>.uber.org/zap/exp/zapslog</div></pre></td></tr></table></figure>



<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"log/slog"</span></div><div class="line"></div><div class="line">    <span class="string">"go.uber.org/zap"</span></div><div class="line">    <span class="string">"go.uber.org/zap/exp/zapslog"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">func</span> main() {</div><div class="line">    zapL := zap.Must(zap.NewProduction())</div><div class="line"></div><div class="line">    <span class="keyword">defer</span> zapL.Sync()</div><div class="line"></div><div class="line">    logger := slog.New(zapslog.NewHandler(zapL.Core(), <span class="constant">nil</span>))</div><div class="line"></div><div class="line">    logger.Info(</div><div class="line">        <span class="string">"incoming request"</span>,</div><div class="line">        slog.String(<span class="string">"method"</span>, <span class="string">"GET"</span>),</div><div class="line">        slog.String(<span class="string">"path"</span>, <span class="string">"/api/user"</span>),</div><div class="line">        slog.Int(<span class="string">"status"</span>,<span class="number"> 200</span>),</div><div class="line">    )</div><div class="line">}</div></pre></td></tr></table></figure>

<p>该代码片段创建了一个新的 <code>Zap</code> 生产环境日志记录器，然后通过 <code>zapslog.NewHandler()</code> 将其用作 Slog 包的处理程序。配置完成后，您只需使用 <code>slog.Logger</code> 提供的方法写入日志，生成的日志记录将根据提供的 <code>zapL</code> 配置进行处理。</p>
<figure class="highlight log"><figcaption><span>output</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">{"<span class="attribute">level</span>":<span class="value"><span class="string">"info"</span></span>,"<span class="attribute">ts</span>":<span class="value"><span class="number">1697453912.4535635</span></span>,"<span class="attribute">msg</span>":<span class="value"><span class="string">"incoming request"</span></span>,"<span class="attribute">method</span>":<span class="value"><span class="string">"GET"</span></span>,"<span class="attribute">path</span>":<span class="value"><span class="string">"/api/user"</span></span>,"<span class="attribute">status</span>":<span class="value"><span class="number">200</span></span>}</div></pre></td></tr></table></figure>

<p>由于日志记录是通过 <code>slog.Logger</code> 来完成的，因此切换到不同的日志记录器真的非常简单。例如，你可以像这样从 <code>Zap</code> 切换到 <code>Zerolog</code>：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ <span class="keyword">go</span> get github.com/rs/zerolog</div><div class="line">$ <span class="keyword">go</span> get github.com/samber/slog-zerolog</div></pre></td></tr></table></figure>



<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"log/slog"</span></div><div class="line">    <span class="string">"os"</span></div><div class="line"></div><div class="line">    <span class="string">"github.com/rs/zerolog"</span></div><div class="line">    slogzerolog <span class="string">"github.com/samber/slog-zerolog"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">func</span> main() {</div><div class="line">    zerologL := zerolog.New(os.Stdout).Level(zerolog.InfoLevel)</div><div class="line"></div><div class="line">    logger := slog.New(</div><div class="line">        slogzerolog.Option{Logger: &zerologL}.NewZerologHandler(),</div><div class="line">    )</div><div class="line"></div><div class="line">    logger.Info(</div><div class="line">        <span class="string">"incoming request"</span>,</div><div class="line">        slog.String(<span class="string">"method"</span>, <span class="string">"GET"</span>),</div><div class="line">        slog.String(<span class="string">"path"</span>, <span class="string">"/api/user"</span>),</div><div class="line">        slog.Int(<span class="string">"status"</span>,<span class="number"> 200</span>),</div><div class="line">    )</div><div class="line">}</div></pre></td></tr></table></figure>



<figure class="highlight log"><figcaption><span>output</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">{"<span class="attribute">level</span>":<span class="value"><span class="string">"info"</span></span>,"<span class="attribute">time</span>":<span class="value"><span class="string">"2023-10-16T13:22:33+02:00"</span></span>,"<span class="attribute">method</span>":<span class="value"><span class="string">"GET"</span></span>,"<span class="attribute">path</span>":<span class="value"><span class="string">"/api/user"</span></span>,"<span class="attribute">status</span>":<span class="value"><span class="number">200</span></span>,"<span class="attribute">message</span>":<span class="value"><span class="string">"incoming request"</span></span>}</div></pre></td></tr></table></figure>

<p>在上面的代码片段中，<code>Zap</code> 处理器已被自定义的 <code>Zerolog</code> 处理器替换。由于日志记录不是使用任何库的自定义 API 完成的，因此迁移过程只需几分钟，相比之下，如果你需要在整个应用程序中从一个日志记录 API 切换到另一个，那将需要更长时间。</p>
<h2 id="Go_日志编写和存储的最佳实践">Go 日志编写和存储的最佳实践</h2>
<p>一旦你配置了 Slog 或你偏好的第三方 Go 日志记录框架，为确保你能够从应用程序日志中获得最大价值，有必要采用以下最佳实践：</p>
<p><strong>1、标准化你的日志接口</strong><br>实现 <code>LogValuer</code> 接口可以确保你的应用程序中的各种类型在日志记录时的表现一致。这也是确保敏感字段不被包含在应用程序日志中的有效策略，正如我们在本文前面所探讨的。</p>
<p><strong>2、在错误日志中添加堆栈跟踪</strong><br>为了提高在生产环境中调试意外问题的能力，你应该在错误日志中添加堆栈跟踪。这样，你就能够更容易地定位错误在代码库中的起源以及导致问题的程序流程。</p>
<p>目前，Slog 并没有提供将堆栈跟踪添加到错误中的内置方式，但正如我们之前所展示的，可以使用像 <a href="https://github.com/pkg/errors" target="_blank" rel="external">pkgerrors</a> 或 <a href="https://github.com/MDobak/go-xerrors" target="_blank" rel="external">go-xerrors</a> 这样的包，配合一些辅助函数来实现这一功能。</p>
<p><strong>3、Lint Slog 语句以确保一致性</strong><br>Slog API 的一个主要缺点是它允许两种不同类型的参数，这可能导致代码库中的不一致性。除此之外，你还希望强制执行一致的键名约定（如 snake_case、camelCase 等），或者要求日志调用始终包括上下文参数。</p>
<p>像 <a href="https://github.com/go-simpler/sloglint/releases" target="_blank" rel="external">sloglint</a> 这样的 linter 可以帮助你基于你偏好的代码风格来强制执行 Slog 的各种规则。以下是通过 <a href="https://freshman.tech/linting-golang/" target="_blank" rel="external">golangci-lint</a> 使用时的一个示例配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">linters-settings:</div><div class="line">  sloglint:</div><div class="line">    # Enforce <span class="keyword">not</span> mixing key-value pairs <span class="keyword">and</span> attributes.</div><div class="line">    # <span class="keyword">Default</span>: <span class="literal">true</span></div><div class="line">    no-mixed-args: <span class="literal">false</span></div><div class="line">    # Enforce using key-value pairs only (overrides no-mixed-args, incompatible <span class="keyword">with</span> attr-only).</div><div class="line">    # <span class="keyword">Default</span>: <span class="literal">false</span></div><div class="line">    kv-only: <span class="literal">true</span></div><div class="line">    # Enforce using attributes only (overrides no-mixed-args, incompatible <span class="keyword">with</span> kv-only).</div><div class="line">    # <span class="keyword">Default</span>: <span class="literal">false</span></div><div class="line">    attr-only: <span class="literal">true</span></div><div class="line">    # Enforce using methods that accept a context.</div><div class="line">    # <span class="keyword">Default</span>: <span class="literal">false</span></div><div class="line">    context-only: <span class="literal">true</span></div><div class="line">    # Enforce using static values <span class="keyword">for</span> <span class="built_in">log</span> messages.</div><div class="line">    # <span class="keyword">Default</span>: <span class="literal">false</span></div><div class="line">    static-msg: <span class="literal">true</span></div><div class="line">    # Enforce using constants instead of raw keys.</div><div class="line">    # <span class="keyword">Default</span>: <span class="literal">false</span></div><div class="line">    no-raw-keys: <span class="literal">true</span></div><div class="line">    # Enforce a single key naming convention.</div><div class="line">    # Values: snake, kebab, camel, pascal</div><div class="line">    # <span class="keyword">Default</span>: <span class="string">""</span></div><div class="line">    key-naming-<span class="keyword">case</span>: snake</div><div class="line">    # Enforce putting arguments <span class="keyword">on</span> separate lines.</div><div class="line">    # <span class="keyword">Default</span>: <span class="literal">false</span></div><div class="line">    args-<span class="keyword">on</span>-sep-lines: <span class="literal">true</span></div></pre></td></tr></table></figure>

<p><strong>4、集中管理日志，但首先将其持久化到本地文件</strong></p>
<p>将日志记录与将它们发送到集中式日志管理系统的任务解耦通常是更好的做法。首先将日志写入本地文件可以确保在日志管理系统或网络出现问题时有一个备份，防止重要数据的潜在丢失。</p>
<p>此外，在发送日志之前先将其存储在本地，有助于缓冲日志，允许批量传输以优化网络带宽的使用，并最小化对应用程序性能的影响。</p>
<p>本地日志存储还提供了更大的灵活性，因此如果需要过渡到不同的日志管理系统，则只需修改发送方法，而无需修改整个应用程序的日志记录机制。有关使用 <a href="https://betterstack.com/community/guides/logging/vector-explained/" target="_blank" rel="external">Vector</a> 或 <a href="https://betterstack.com/community/guides/logging/fluentd-explained/" target="_blank" rel="external">Fluentd</a> 等专用日志发送程序的更多详细信息，请参阅<a href="https://betterstack.com/community/guides/logging/log-shippers-explained/" target="_blank" rel="external">我们的文章</a>。</p>
<p>将日志记录到文件并不一定要求你配置所选的框架直接写入文件，因为 <a href="https://betterstack.com/community/guides/logging/how-to-control-systemd-with-systemctl/" target="_blank" rel="external">Systemd</a> 可以轻松地将应用程序的标准输出和错误流重定向到文件。<a href="https://betterstack.com/community/guides/logging/how-to-start-logging-with-docker/" target="_blank" rel="external">Docker</a> 也默认收集发送到这两个流的所有数据，并将它们路由到主机上的本地文件。</p>
<p><strong> 5、对日志进行采样</strong></p>
<p>日志采样是一种只记录日志条目中具有代表性的子集，而不是记录每个日志事件的做法。在高流量环境中，系统会产生大量的日志数据，而处理每个条目可能成本高昂，因为集中式日志解决方案通常根据数据摄入率或存储量进行收费，因此这种技术非常有用:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"log/slog"</span></div><div class="line">    <span class="string">"os"</span></div><div class="line"></div><div class="line">    slogmulti <span class="string">"github.com/samber/slog-multi"</span></div><div class="line">    slogsampling <span class="string">"github.com/samber/slog-sampling"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">func</span> main() {</div><div class="line">    <span class="comment">// Will print 20% of entries.</span></div><div class="line">    option := slogsampling.UniformSamplingOption{</div><div class="line">        Rate:<span class="number"> 0.2</span>,</div><div class="line">    }</div><div class="line"></div><div class="line">    logger := slog.New(</div><div class="line">        slogmulti.</div><div class="line">            Pipe(option.NewMiddleware()).</div><div class="line">            Handler(slog.NewJSONHandler(os.Stdout, <span class="constant">nil</span>)),</div><div class="line">    )</div><div class="line"></div><div class="line">    <span class="keyword">for</span> i :=<span class="number"> 1</span>; i &lt;=<span class="number"> 10</span>; i++ {</div><div class="line">        logger.Info(fmt.Sprintf(<span class="string">"a message from the gods: %d"</span>, i))</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>



<figure class="highlight log"><figcaption><span>output</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">{"<span class="attribute">time</span>":<span class="value"><span class="string">"2023-10-18T19:14:09.820090798+02:00"</span></span>,"<span class="attribute">level</span>":<span class="value"><span class="string">"INFO"</span></span>,"<span class="attribute">msg</span>":<span class="value"><span class="string">"a message from the gods: 4"</span></span>}</div><div class="line">{"<span class="attribute">time</span>":<span class="value"><span class="string">"2023-10-18T19:14:09.820117844+02:00"</span></span>,"<span class="attribute">level</span>":<span class="value"><span class="string">"INFO"</span></span>,"<span class="attribute">msg</span>":<span class="value"><span class="string">"a message from the gods: 5"</span></span>}</div></pre></td></tr></table></figure>

<p>第三方框架，如 Zerolog 和 Zap，提供了内置的日志采样功能。在使用 Slog 时，你需要集成一个第三方处理器，如 <a href="https://github.com/samber/slog-sampling" target="_blank" rel="external">slog-sampling</a>，或开发一个自定义解决方案。你还可以通过专用的日志发送程序（如 Vector）来选择对日志进行采样。</p>
<p><strong>6、使用日志管理服务</strong></p>
<p>将日志集中在一个日志管理系统中，可以方便地跨多个服务器和环境搜索、分析和监控应用程序的行为。将所有日志集中在一个地方，可以显著提高你识别和诊断问题的能力，因为你不再需要在不同的服务器之间跳转来收集有关你的服务的信息。</p>
<p><img src="log.png" alt=""></p>
<p>虽然市面上有很多日志管理解决方案，但 Better Stack 提供了一种简单的方法，可以在几分钟内设置集中式日志管理，其内置了实时追踪、报警、仪表板、正常运行时间监控和事件管理功能，并通过现代化和直观的用户界面进行展示。在这里，你可以通过完全免费的计划来试用它。</p>
<h2 id="总结">总结</h2>
<p>我希望这篇文章能让你对 Go 语言中新的结构化日志包有所了解，以及如何在你的项目中使用它。如果你想进一步探索这个话题，我建议你查看<a href="https://go.googlesource.com/proposal/+/master/design/56345-structured-logging.md" target="_blank" rel="external">完整的提案</a>和<a href="https://pkg.go.dev/log/slog" target="_blank" rel="external">包文档</a>。</p>
<p>感谢阅读，祝你在日志记录方面一切顺利！</p>
<h2 id="补充信息">补充信息</h2>
<p>q其他一些和slog有关的资源。</p>
<h3 id="通用处理器">通用处理器</h3>
<ul>
<li><a href="https://github.com/samber/slog-multi" target="_blank" rel="external">slog-multi</a>：处理器链（管道、路由器、扇出等）。</li>
<li><a href="https://github.com/samber/slog-sampling" target="_blank" rel="external">slog-sampling</a>：丢弃重复的日志条目。</li>
<li><a href="https://github.com/sagikazarmark/slog-shim" target="_blank" rel="external">slog-shim</a>：为 Go &lt;1.21 提供向后兼容的 slog 支持。</li>
<li><a href="https://github.com/go-simpler/sloggen" target="_blank" rel="external">sloggen</a>：生成各种辅助工具。</li>
<li><a href="https://github.com/go-simpler/sloglint" target="_blank" rel="external">sloglint</a>：确保一致的代码风格。</li>
</ul>
<h3 id="格式化">格式化</h3>
<p>提供日志格式化的库。</p>
<ul>
<li><a href="https://github.com/phsym/console-slog" target="_blank" rel="external">console-slog</a>：处理程序，可打印彩色日志，类似于 zerolog 的console writer，且不会牺牲性能。</li>
<li><a href="https://github.com/golang-cz/devslog" target="_blank" rel="external">devslog</a>：为开发环境格式化日志。</li>
<li><a href="https://github.com/samber/slog-formatter" target="_blank" rel="external">slog-formatter</a>：slog 的通用格式化程序，以及构建自定义格式化程序的辅助工具。</li>
<li><a href="https://gitlab.com/greyxor/slogor" target="_blank" rel="external">slogor</a>：一个彩色 slog 处理程序。</li>
<li><a href="https://github.com/dpotapov/slogpfx" target="_blank" rel="external">slogpfx</a>：可以轻松使用日志记录中的属性为日志消息添加前缀。</li>
<li><a href="https://github.com/lmittmann/tint" target="_blank" rel="external">tint</a>：处理程序，可写入带有颜色的日志。</li>
<li><a href="https://github.com/jeffry-luqman/zlog" target="_blank" rel="external">zlog</a>：处理程序，可写入美观、易于阅读的日志。</li>
</ul>
<h3 id="日志增强">日志增强</h3>
<p>用于丰富日志记录的处理程序。</p>
<ul>
<li><a href="https://github.com/m-mizutani/masq" target="_blank" rel="external">masq</a>：在日志中脱敏敏感数据。</li>
<li><a href="https://github.com/go-slog/otelslog" target="_blank" rel="external">otelslog</a>：处理程序，将 OpenTelemetry 跟踪和资源详细信息附加到日志中。</li>
<li><a href="https://github.com/PumpkinSeed/slog-context" target="_blank" rel="external">slog-context</a>：通过上下文将任意键值对附加到日志记录中。</li>
</ul>
<h3 id="日志转发">日志转发</h3>
<p>一些厂家提供了将slog转发到它们平台上的功能，比如datadog、sentry等,这里就不赘述了，因为这些都是第三方的服务，在国内也不太合适使用。其他一些转发的库：</p>
<ul>
<li><a href="https://github.com/samber/slog-kafka" target="_blank" rel="external">slog-kafka</a>: Handler forwarding logs to Kafka.</li>
<li><a href="https://github.com/samber/slog-syslog" target="_blank" rel="external">slog-syslog</a>: Handler forwarding logs to Syslog.</li>
<li><a href="https://github.com/samber/slog-webhook" target="_blank" rel="external">slog-webhook</a>: Handler forwarding logs to a Webhook.</li>
<li><a href="https://github.com/samber/slog-channel" target="_blank" rel="external">slog-channel</a>: Handler for Go channels</li>
</ul>
<h3 id="和其它日志框架集成">和其它日志框架集成</h3>
<p>其他日志库的适配器。</p>
<ul>
<li><a href="https://github.com/evanphx/go-hclog-slog" target="_blank" rel="external">go-hclog-slog</a>：hclog 的处理程序适配器。</li>
<li><a href="https://github.com/samber/slog-logrus" target="_blank" rel="external">slog-logrus</a>：logrus 的处理程序适配器。</li>
<li><a href="https://github.com/samber/slog-zap" target="_blank" rel="external">slog-zap</a>：zap 的处理程序适配器。</li>
<li><a href="https://github.com/samber/slog-zerolog" target="_blank" rel="external">slog-zerolog</a>：zerolog 的处理程序适配器。</li>
<li><a href="https://github.com/chanchal1987/zaphandler" target="_blank" rel="external">zaphandler</a>：Zap 的处理程序适配器。</li>
</ul>
<h3 id="集成到web框架">集成到web框架</h3>
<ul>
<li><a href="https://github.com/FabienMht/ginslog" target="_blank" rel="external">ginslog</a>: A fully featured Gin middleware.</li>
<li><a href="https://github.com/samber/slog-chi" target="_blank" rel="external">slog-chi</a>: Chi middleware.</li>
<li><a href="https://github.com/samber/slog-echo" target="_blank" rel="external">slog-echo</a>: Echo middleware.</li>
<li><a href="https://github.com/samber/slog-fiber" target="_blank" rel="external">slog-fiber</a>: Fiber middleware.</li>
<li><a href="https://github.com/samber/slog-gin" target="_blank" rel="external">slog-gin</a>: Gin middleware.</li>
</ul>
<h3 id="其他">其他</h3>
<ul>
<li><a href="https://go-review.googlesource.com/c/go/+/548335/5/src/log/slog/example_discard_test.go" target="_blank" rel="external">discard logger</a>: 丢弃用的logger</li>
<li><a href="https://pkg.go.dev/testing/slogtest@go1.22.1" target="_blank" rel="external">slogtest</a>: 测试 handler</li>
<li></li>
</ul>

      
    </div>
    <footer class="article-footer">
      

      
      <!-- <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
      <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script> -->
      <section id="comments">
        <script src="https://utteranc.es/client.js"
                repo="smallnest/gitalk"
                issue-term="title"
                theme="github-light"
                crossorigin="anonymous"
                async>
        </script>
        <!-- <div id="gitalk-container"></div>
        <script type="text/javascript">
          var gitalkOpts = {
            id: '2024/03/10/slog-the-ultimate-guide/',
            owner: 'smallnest',
            repo: 'gitalk',
            title: 'slog 终极指南',
            body: 'https://colobu.com/2024/03/10/slog-the-ultimate-guide/',
            clientID: 'bc02724130ed5b7ee275',
            clientSecret: '68cb0bae2f93a8b88b09e0eb9b08c844b06a9047',
            admin: ['smallnest'],
            distractionFreeMode: false
          };

          const gitalk = new Gitalk(gitalkOpts)
          gitalk.render('gitalk-container')
        </script> -->
        <noscript> 为正常使用评论功能请激活JavaScript</noscript>
      </section>

      

    </footer>
  </div>
  
  
<nav id="article-nav">
  
    <a href="/2024/03/12/high-speed-packet-transmission-in-go-from-net-dial-to-af-xdp/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Go 中的高速数据包处理:从 net.Dial 到 AF_XDP
        
      </div>
    </a>
  
  
    <a href="/2024/03/07/implement-a-heap-in-go/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">实现一个友好的堆</div>
    </a>
  
</nav>

  
</article></section>
        
          <aside id="sidebar">
  
    <div class="widget-wrap">
  <h3 class="widget-title">访问者来源</h3>
  <div class="widget">
    <script type="text/javascript" id="clstr_globe" src="//clustrmaps.com/globe.js?d=Hf4EJSi2XvL6TMcuFSH51Qn6nf5nZ8qnjVBnWCQ4FGc"></script>
  </div>
</div>

<div class="widget-wrap">
  <h3 class="widget-title">微信公众号</h3>
  <div class="widget">
    <img width="100%" src="/images/widgets/gopatterns.jpg">
  </div>
</div>

<div class="widget-wrap">
  <h3 class="widget-title">极客时间专栏</h3>
  <div class="widget">
    <a href="https://time.geekbang.org/column/intro/100061801">
      <img width="100%" src="/images/widgets/geekbang.png">
    </a>
  </div>
</div>

<div class="widget-wrap">
    <h3 class="widget-title">出版图书</h3>
    <div class="widget">
      <a href="https://cpgo.colobu.com/">
        <img width="100%" src="/cpgolang/cpgo.png">
      </a>
    </div>
    <div class="widget">
      <a href="https://item.jd.com/14347716.html">
        <img width="100%" src="/100gomistakes/cover.png">
      </a>
    </div>
    <div class="widget">
      <a href="/ScalaCollectionsCookbook/">
        <img width="100%" src="/ScalaCollectionsCookbook/scala_collections_cookbook.jpg">
        <img width="100%" src="/ScalaCollectionsCookbook/scala_collections_cookbook_tw.png">
      </a>
    </div>
</div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/C/">C++</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/DOTNET/">DOTNET</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Go/">Go</a><span class="category-list-count">283</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">64</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Rust/">Rust</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Scala/">Scala</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/go/">go</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/k8s/">k8s</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/rust/">rust</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/分享/">分享</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端开发/">前端开发</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/区块链/">区块链</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/大数据/">大数据</a><span class="category-list-count">60</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工具/">工具</a><span class="category-list-count">28</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/">数据库</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/架构/">架构</a><span class="category-list-count">27</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/管理/">管理</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络编程/">网络编程</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计模式/">设计模式</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/读书笔记/">读书笔记</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/运维/">运维</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/高并发编程/">高并发编程</a><span class="category-list-count">20</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/Android/" style="font-size: 15.71px;">Android</a><a href="/tags/ApacheBench/" style="font-size: 11.43px;">ApacheBench</a><a href="/tags/Bower/" style="font-size: 10.00px;">Bower</a><a href="/tags/C/" style="font-size: 10.00px;">C#</a><a href="/tags/CDN/" style="font-size: 10.00px;">CDN</a><a href="/tags/CQRS/" style="font-size: 10.00px;">CQRS</a><a href="/tags/CRC/" style="font-size: 10.00px;">CRC</a><a href="/tags/CSS/" style="font-size: 11.43px;">CSS</a><a href="/tags/CompletableFuture/" style="font-size: 10.00px;">CompletableFuture</a><a href="/tags/Comsat/" style="font-size: 10.00px;">Comsat</a><a href="/tags/Curator/" style="font-size: 18.57px;">Curator</a><a href="/tags/DSL/" style="font-size: 10.00px;">DSL</a><a href="/tags/Disruptor/" style="font-size: 10.00px;">Disruptor</a><a href="/tags/Docker/" style="font-size: 11.43px;">Docker</a><a href="/tags/Ember/" style="font-size: 11.43px;">Ember</a><a href="/tags/FastJson/" style="font-size: 10.00px;">FastJson</a><a href="/tags/Fiber/" style="font-size: 10.00px;">Fiber</a><a href="/tags/GAE/" style="font-size: 10.00px;">GAE</a><a href="/tags/GC/" style="font-size: 12.86px;">GC</a><a href="/tags/Gnuplot/" style="font-size: 10.00px;">Gnuplot</a><a href="/tags/Go/" style="font-size: 14.29px;">Go</a><a href="/tags/Gradle/" style="font-size: 10.00px;">Gradle</a><a href="/tags/Grunt/" style="font-size: 10.00px;">Grunt</a><a href="/tags/Gulp/" style="font-size: 10.00px;">Gulp</a><a href="/tags/Hadoop/" style="font-size: 10.00px;">Hadoop</a><a href="/tags/Hazelcast/" style="font-size: 10.00px;">Hazelcast</a><a href="/tags/IPFS/" style="font-size: 10.00px;">IPFS</a><a href="/tags/Ignite/" style="font-size: 10.00px;">Ignite</a><a href="/tags/JVM/" style="font-size: 10.00px;">JVM</a><a href="/tags/Java/" style="font-size: 17.14px;">Java</a><a href="/tags/Kafka/" style="font-size: 20.00px;">Kafka</a><a href="/tags/Lambda/" style="font-size: 14.29px;">Lambda</a><a href="/tags/Linux/" style="font-size: 12.86px;">Linux</a><a href="/tags/LongAdder/" style="font-size: 10.00px;">LongAdder</a><a href="/tags/MathJax/" style="font-size: 10.00px;">MathJax</a><a href="/tags/Maven/" style="font-size: 11.43px;">Maven</a><a href="/tags/Memcached/" style="font-size: 10.00px;">Memcached</a><a href="/tags/Metrics/" style="font-size: 10.00px;">Metrics</a><a href="/tags/Mongo/" style="font-size: 12.86px;">Mongo</a><a href="/tags/Netty/" style="font-size: 15.71px;">Netty</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/06/">June 2024</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/05/">May 2024</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">April 2024</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">March 2024</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/02/">February 2024</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/01/">January 2024</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">December 2023</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">November 2023</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/10/">October 2023</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/09/">September 2023</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/08/">August 2023</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/07/">July 2023</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/06/">June 2023</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">May 2023</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/04/">April 2023</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/03/">March 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">January 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/12/">December 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/11/">November 2022</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">October 2022</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">September 2022</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">August 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">July 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">June 2022</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">May 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">April 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">March 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">February 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">November 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">August 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">July 2021</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">June 2021</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">July 2015</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">June 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">May 2015</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">April 2015</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">March 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/02/">February 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">January 2015</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">December 2014</a><span class="archive-list-count">28</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/11/">November 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/10/">October 2014</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">September 2014</a><span class="archive-list-count">28</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">August 2014</a><span class="archive-list-count">19</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/07/">July 2014</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">近期文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/06/04/redka-redis-with-sqlite/">Redka - 父亲是Redis，母亲是SQLite</a>
          </li>
        
          <li>
            <a href="/2024/06/03/command-dispacher-pattern/">命令分发模式</a>
          </li>
        
          <li>
            <a href="/2024/05/22/parse-tcp-timestamp-in-Rust/">使用Rust捕获和解析网络包</a>
          </li>
        
          <li>
            <a href="/2024/05/20/implemenmt-pping-in-go/">使用Go语言实现 pping</a>
          </li>
        
          <li>
            <a href="/2024/05/19/let-Rob-Pike-write-a-Red-Black-tree/">让 Rob Pike 或者字节跳动的同学实现一个红黑树</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">友情链接</h3>
    <div class="widget">
      <ul>
        
          <li>
			 
            <a href="http://stackshare.io" target="_blank">技术栈</a>
			
          </li>
        
          <li>
			 
			&nbsp;
			
          </li>
        
          <li>
			 
            <a href="https://toutiao.io/" target="_blank">开发者头条</a>
			
          </li>
        
          <li>
			 
            <a href="http://weekly.manong.io/issues/" target="_blank">码农周刊</a>
			
          </li>
        
          <li>
			 
            <a href="http://www.tuicool.com/mags" target="_blank">编程狂人周刊</a>
			
          </li>
        
          <li>
			 
            <a href="http://www.importnew.com/" target="_blank">importnew</a>
			
          </li>
        
          <li>
			 
            <a href="http://ifeve.com/" target="_blank">并发编程网</a>
			
          </li>
        
          <li>
			 
			&nbsp;
			
          </li>
        
          <li>
			 
            <a href="http://github.com" target="_blank">github</a>
			
          </li>
        
          <li>
			 
            <a href="http://stackoverflow.com/" target="_blank">stackoverflow</a>
			
          </li>
        
          <li>
			 
            <a href="http://www.javacodegeeks.com/" target="_blank">javacodegeeks</a>
			
          </li>
        
          <li>
			 
            <a href="http://www.infoq.com/" target="_blank">infoq</a>
			
          </li>
        
          <li>
			 
            <a href="http://www.dzone.com/links/index.html" target="_blank">dzone</a>
			
          </li>
        
          <li>
			 
            <a href="https://oj.leetcode.com/problems/" target="_blank">leetcode</a>
			
          </li>
        
          <li>
			 
            <a href="http://tutorials.jenkov.com" target="_blank">jenkov</a>
			
          </li>
        
          <li>
			 
            <a href="https://howtodoinjava.com" target="_blank">HowToDoInJava</a>
			
          </li>
        
          <li>
			 
            <a href="https://java-design-patterns.com/patterns/" target="_blank">java design patterns</a>
			
          </li>
        
          <li>
			 
			&nbsp;
			
          </li>
        
          <li>
			 
            <a href="https://medium.com/netflix-techblog" target="_blank">Netflix技术博客</a>
			
          </li>
        
          <li>
			 
            <a href="https://www.techiedelight.com" target="_blank">Techie Delight</a>
			
          </li>
        
          <li>
			 
            <a href="https://engineering.linkedin.com/blog" target="_blank">Linkedin技术博客</a>
			
          </li>
        
          <li>
			 
            <a href="https://blogs.dropbox.com/tech/" target="_blank">Dropbox技术博客</a>
			
          </li>
        
          <li>
			 
            <a href="https://code.fb.com" target="_blank">Facebook技术博客</a>
			
          </li>
        
          <li>
			 
            <a href="http://jm.taobao.org" target="_blank">淘宝中间件团队</a>
			
          </li>
        
          <li>
			 
            <a href="https://tech.meituan.com" target="_blank">美团技术博客</a>
			
          </li>
        
          <li>
			 
            <a href="http://blogs.360.cn" target="_blank">360技术博客</a>
			
          </li>
        
          <li>
			 
            <a href="https://xiaomi-info.github.io" target="_blank">小米信息部技术团队</a>
			
          </li>
        
      </ul>
    </div>
  </div>

  
      

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2024 smallnest<br>
	  Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    
      <a href="/" class="mobile-nav-link"><i class="fa fa-home">&nbsp;</i>首页</a>
    
  
    
      <a href="/archives" class="mobile-nav-link"><i class="fa fa-folder-o">&nbsp;</i>归档</a>
    
  
    
      <a href="https://github.com/smallnest" class="mobile-nav-link"><i class="fa fa-github">&nbsp;</i>github</a>
    
  
    
      <a class="mobile-nav-link" href="#"><i class="fa fa-bars">&nbsp;</i>网站群</a>
    
      
            <a class="mobile-nav-link" href="/goasm">&nbsp;&nbsp;<i class="fa fa-language">&nbsp;</i>Go汇编示例</a>
          
          
    
      
            <a class="mobile-nav-link" href="https://gowebexamples.com">&nbsp;&nbsp;<i class="fa fa-external-link">&nbsp;</i>Go Web开发示例</a>
          
          
    
      
            <a class="mobile-nav-link" href="http://go-database-sql.org">&nbsp;&nbsp;<i class="fa fa-external-link">&nbsp;</i>Go 数据库开发教程</a>
          
          
    
      
            <a class="mobile-nav-link" href="https://colobu.com/gotips/">&nbsp;&nbsp;<i class="fa fa-external-link">&nbsp;</i>Go 语言编程技巧</a>
          
          
    
      
            
          
          
    
      
            <a class="mobile-nav-link" href="/perf-book">&nbsp;&nbsp;<i class="fa fa-brands fa-rust">&nbsp;</i>Rust高性能编程指南</a>
          
          
    
      
            <a class="mobile-nav-link" href="/rust100">&nbsp;&nbsp;<i class="fa fa-brands fa-rust">&nbsp;</i>100个练习题学习Rust</a>
          
          
    
      
            
          
          
    
      
            <a class="mobile-nav-link" href="http://rpcx.io">&nbsp;&nbsp;<i class="fa undefined">&nbsp;</i>RPCX官网</a>
          
          
    
      
            <a class="mobile-nav-link" href="http://cn.doc.rpcx.io">&nbsp;&nbsp;<i class="fa undefined">&nbsp;</i>RPC开发指南</a>
          
          
    
    
  
    
      <a href="/ScalaCollectionsCookbook" class="mobile-nav-link"><i class="fa fa-solid fa-book">&nbsp;</i>Scala集合技术手册</a>
    
  
    
      <a href="/about" class="mobile-nav-link"><i class="fa fa-lemon-o">&nbsp;</i>关于</a>
    
  
</nav>
    
<script src="//cdn.staticfile.org/jquery/1.11.1/jquery.min.js"></script>
<script src="//cdn.bootcss.com/jquery.lazyload/1.9.1/jquery.lazyload.min.js"></script>

<script src="//cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js"></script>


<script src="/js/script.js" type="text/javascript"></script>

<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
  });
  MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>
<script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.6.0-beta.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

<div id="totop" style="position:fixed;bottom:150px;right:10px;cursor: pointer;z-index: 2000;">
	<a title="返回顶部"><img src="/images/scrollup.png"/></a>
</div>
<script src="/js/totop.js" type="text/javascript"></script>




<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e085d87993250aab11f3e0c15f1c2785";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


  </div>
</body>
</html>