<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  
  <title>sqlx: 扩展标准sql库</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="sqlx是一个用于扩展标准库database/sql的库，它提供了一些额外的功能，使得在Go中使用sql更加方便。sqlx的目标是保持database/sql的简单性，同时提供更多的功能。">
<meta property="og:type" content="article">
<meta property="og:title" content="sqlx: 扩展标准sql库">
<meta property="og:url" content="https://colobu.com/2024/05/10/sqlx-a-brief-introduction/">
<meta property="og:site_name" content="鸟窝">
<meta property="og:description" content="sqlx是一个用于扩展标准库database/sql的库，它提供了一些额外的功能，使得在Go中使用sql更加方便。sqlx的目标是保持database/sql的简单性，同时提供更多的功能。">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="sqlx: 扩展标准sql库">
<meta name="twitter:description" content="sqlx是一个用于扩展标准库database/sql的库，它提供了一些额外的功能，使得在Go中使用sql更加方便。sqlx的目标是保持database/sql的简单性，同时提供更多的功能。">

  
  <link rel="alternative" href="/atom.xml" title="鸟窝" type="application/atom+xml">
  
  
  <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">

  <link href="//cdn.staticfile.org/font-awesome/4.2.0/css/font-awesome.css" rel="stylesheet">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.7/css/jquery.fancybox.min.css"
    media="screen" type="text/css">
  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" media="screen"
    type="text/css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/tonsky/FiraCode@1.207/distr/fira_code.css">
</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap" class="animated bounceInLeft">
        <a href="/" id="logo">鸟窝</a>
      </h1>
      
        <!-- <h2 id="subtitle-wrap" class="animated bounceInLeft"> -->
        <h2 id="subtitle-wrap">
          <!-- <a href="/" id="subtitle">大道至简 Simplicity is the ultimate form of sophistication</a> -->
          <a href="https://item.jd.com/14283252.html" target="_blank" style="color: #e32d40;text-decoration: none;"><b>《深入理解Go并发编程》新书发售中。一书在手，并发无忧</b></a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          
            <a class="main-nav-link" href="/"><i class="fa fa-home">&nbsp;</i>首页</a>
          
          
          
            <a class="main-nav-link" href="/archives"><i class="fa fa-folder-o">&nbsp;</i>归档</a>
          
          
          
            <a class="main-nav-link" href="https://github.com/smallnest"><i class="fa fa-github">&nbsp;</i>github</a>
          
          
          
            <div class="dropdown main-nav-link"><a class="main-nav-link" href="#"><i class="fa fa-bars">&nbsp;</i>网站群</a>
              <div class="dropdown-content">
          
            
              <a href="/goasm"><i class="fa fa-language"></i>&nbsp;Go汇编示例</a>
            
                
          
            
              <a href="https://gowebexamples.com"><i class="fa fa-external-link"></i>&nbsp;Go Web开发示例</a>
            
                
          
            
              <a href="http://go-database-sql.org"><i class="fa fa-external-link"></i>&nbsp;Go 数据库开发教程</a>
            
                
          
            
              <a href="https://colobu.com/gotips/"><i class="fa fa-external-link"></i>&nbsp;Go 语言编程技巧</a>
            
                
          
            
              <hr>
            
                
          
            
              <a href="/perf-book"><i class="fa fa-rust"></i>&nbsp;Rust高性能编程指南</a>
            
                
          
            
              <a href="/rust100"><i class="fa fa-rust"></i>&nbsp;100个练习题学习Rust</a>
            
                
          
            
              <hr>
            
                
          
            
              <a href="http://rpcx.io"><i class="fa undefined"></i>&nbsp;RPCX官网</a>
            
                
          
            
              <a href="http://cn.doc.rpcx.io"><i class="fa undefined"></i>&nbsp;RPC开发指南</a>
            
                
          
          </div>
        </div>
          
          
          
            <a class="main-nav-link" href="/ScalaCollectionsCookbook"><i class="fa fa-book">&nbsp;</i>Scala集合技术手册</a>
          
          
          
            <a class="main-nav-link" href="/about"><i class="fa fa-lemon-o">&nbsp;</i>关于</a>
          
          


      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="https://www.google.com/search" method="get" accept-charset="utf-8" class="search-form">
          <input type="search" id="search-word" name="q" maxlength="20" class="search-form-input" placeholder="Search">
          <input type=hidden name=ie value="utf-8">
          <input type=hidden name=oe value="utf-8">
          <input type=hidden name=hl value="zh-CN">
          <input type="submit" id="search-submit" value="" class="search-form-submit">
        </form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-sqlx-a-brief-introduction" class="article article-type-post" itemscope
  itemprop="blogPost">
  <div class="article-meta">
    <a href="/2024/05/10/sqlx-a-brief-introduction/" class="article-date">
  <time datetime="2024-05-10T14:08:45.000Z" itemprop="datePublished">2024年05月10日</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Go/">Go</a>
  </div>

    
  <div class="article-author"> by smallnest</div>

  </div>
  <div class="article-inner">
    
    
    <header class="article-header">
      
  
    <h1 class="article-title" itemprop="name">
      sqlx: 扩展标准sql库
	  
    </h1>
  

    </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
      
      <script>function show_answer(btn, x) { if (btn.value === "显示答案") { btn.value = "隐藏答案" } else { btn.value = "显示答案" } var as = document.getElementById(x); if (as.style.display === "none") { as.style.display = "block" } else { as.style.display = "none" } }</script>
      <p><a href="https://github.com/jmoiron/sqlx" target="_blank" rel="external">sqlx</a>是一个用于扩展标准库database/sql的库，它提供了一些额外的功能，使得在Go中使用sql更加方便。sqlx的目标是保持database/sql的简单性，同时提供更多的功能。<br><a id="more"></a><br><code>sqlx</code> 为 Go 的标准 <code>database/sql</code> 库提供了一组扩展。sqlx 中的 <code>sql.Conn</code>、<code>sql.DB</code>、<code>sql.TX</code>、<code>sql.Stmt</code>、<code>sql.Rows</code>、<code>sql.Row</code> 等版本都保留了底层接口不变，因此它们的接口是标准接口的超集。这使得将使用 <code>database/sql</code> 的现有代码库与 <code>sqlx</code> 集成相对容易。</p>
<p>主要的额外概念有：</p>
<ul>
<li>将行映射到结构体（支持嵌入结构体）、Map和切片</li>
<li>支持命名参数，包括预编译语句</li>
<li>使用 <code>Get</code> 和 <code>Select</code> 快速从查询到结构体/切片</li>
</ul>
<p><code>sqlx</code> 的目的是无缝地封装 database/sql，并提供在开发数据库驱动的应用程序时有用的便捷方法。它不会改变任何底层的 <code>database/sql</code> 方法。相反，所有扩展行为都是通过在包装类型上定义的新方法来实现的。<br>比如:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Conn <span class="keyword">struct</span> {</div><div class="line">	*sql.Conn</div><div class="line">	driverName <span class="typename">string</span></div><div class="line">	unsafe     <span class="typename">bool</span></div><div class="line">	Mapper     *reflectx.Mapper</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">type</span> DB <span class="keyword">struct</span> {</div><div class="line">	*sql.DB</div><div class="line">	driverName <span class="typename">string</span></div><div class="line">	unsafe     <span class="typename">bool</span></div><div class="line">	Mapper     *reflectx.Mapper</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">type</span> Stmt <span class="keyword">struct</span> {</div><div class="line">	*sql.Stmt</div><div class="line">	unsafe <span class="typename">bool</span></div><div class="line">	Mapper *reflectx.Mapper</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">type</span> Tx <span class="keyword">struct</span> {</div><div class="line">	*sql.Tx</div><div class="line">	driverName <span class="typename">string</span></div><div class="line">	unsafe     <span class="typename">bool</span></div><div class="line">	Mapper     *reflectx.Mapper</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">type</span> Rows <span class="keyword">struct</span> {</div><div class="line">	*sql.Rows <span class="comment">// 嵌入</span></div><div class="line">	unsafe <span class="typename">bool</span></div><div class="line">	Mapper *reflectx.Mapper</div><div class="line">	<span class="comment">// these fields cache memory use for a rows during iteration w/ structScan</span></div><div class="line">	started <span class="typename">bool</span></div><div class="line">	fields  [][]<span class="typename">int</span></div><div class="line">	values  []<span class="keyword">interface</span>{}</div><div class="line">}</div></pre></td></tr></table></figure>

<p>可以看到，它的核心类型都是对标准库的封装，然后在此基础上提供了更多的功能。</p>
<p>它是2013年发布，已经有11年的历史了，也许为了保持兼容，它没有对泛型提供支持，甚至<code>interface{}</code>也没有改为<code>any</code>，还支持Go 1.10的版本。</p>
<p>本文假定你已经有了Go开发数据库程序的基础。如果你还不了解，建议你阅读下面的材料：</p>
<ul>
<li><a href="https://golang.org/pkg/database/sql/" target="_blank" rel="external">database/sql documentation</a></li>
<li><a href="http://go-database-sql.org/" target="_blank" rel="external">go-database-sql tutorial</a></li>
</ul>
<blockquote>
<p>本文是编译自作者写的<a href="https://jmoiron.github.io/sqlx/" target="_blank" rel="external">sqlx图解指南</a>。</p>
</blockquote>
<p>引入<code>sqlx</code>库以及sqlite3驱动：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ <span class="keyword">go</span> <span class="built_in">get</span> github.<span class="keyword">com</span>/jmoiron/sqlx</div><div class="line">$ <span class="keyword">go</span> <span class="built_in">get</span> github.<span class="keyword">com</span>/mattn/<span class="keyword">go</span>-sqlite3</div></pre></td></tr></table></figure>

<p><code>sqlx</code> 的设计初衷是让用户感觉与 <code>database/sql</code> 一样。它主要有 5 种 handler 类型：</p>
<ul>
<li><code>sqlx.Conn</code> - 类似于 <code>sql.Conn</code>，表示一个数据库连接</li>
<li><code>sqlx.DB</code> - 类似于 <code>sql.DB</code>，表示一个数据库连接池</li>
<li><code>sqlx.Tx</code> - 类似于 <code>sql.Tx</code>，表示一个事务</li>
<li><code>sqlx.Stmt</code> - 类似于 <code>sql.Stmt</code>，表示一个预处理语句</li>
<li><code>sqlx.NamedStmt</code> - 表示一个支持命名参数的预处理语句</li>
</ul>
<p>这些 handler 类型都嵌入了它们的 <code>database/sql</code>对应类型，这意味着当你调用 <code>sqlx.DB.Query</code> 时，你实际上调用的是与 <code>sql.DB.Query</code> 相同的代码。这使得它易于引入现有的代码库中。</p>
<p>除了这些，还有 2 种游标类型：</p>
<ul>
<li><code>sqlx.Rows</code> - 类似于 <code>sql.Rows</code>，是从 <code>Queryx</code> 返回的游标，多行结果</li>
<li><code>sqlx.Row</code> - 类似于 <code>sql.Row</code>，是从 <code>QueryRowx</code> 返回的结果,单行结果</li>
</ul>
<p>与 handler 类型一样，<code>sqlx.Rows</code> 嵌入了 <code>sql.Rows</code>。由于无法访问底层实现，<code>sqlx.Row</code> 是对 <code>sql.Row</code> 的部分重新实现，同时保留了标准接口。</p>
<h2 id="连接数据库">连接数据库</h2>
<p>一个 <code>DB</code> 实例并不是连接，而是一个表示数据库的抽象。这就是为什么创建 <code>DB</code> 时不会返回错误也不会引发恐慌（<code>panic</code>）。它在内部维护了一个连接池，并会在首次需要连接时尝试连接。你可以通过 <code>Open</code> 方法创建一个 <code>sqlx.DB</code>，或者通过 <code>NewDb</code> 方法从现有的 <code>sql.DB</code> 创建一个新的<code>sqlx.DB</code>  handler :</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> db *sqlx.DB</div><div class="line"> </div><div class="line"><span class="comment">// 完全与内置的一样</span></div><div class="line">db = sqlx.Open(<span class="string">"sqlite3"</span>, <span class="string">":memory:"</span>)</div><div class="line"> </div><div class="line"><span class="comment">// 从现有的sql.DB创建一个新的sqlx.DB</span></div><div class="line">db = sqlx.NewDb(sql.Open(<span class="string">"sqlite3"</span>, <span class="string">":memory:"</span>), <span class="string">"sqlite3"</span>)</div><div class="line"> </div><div class="line"><span class="comment">// 强制连接并测试是否成功</span></div><div class="line">err = db.Ping()</div></pre></td></tr></table></figure>

<p>在某些情况下，你可能希望同时打开数据库并建立连接，例如，在初始化阶段捕获配置问题。你可以使用 <code>Connect</code> 方法一次性完成这个操作，它会打开一个新的数据库并尝试进行 <code>Ping</code> 操作。<code>MustConnect</code> 变种在遇到错误时会触发 <code>panic</code>，适合在你的包的模块级别使用:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> err error</div><div class="line"></div><div class="line"><span class="comment">// 打开并连接数据库</span></div><div class="line">db, err = sqlx.Connect(<span class="string">"sqlite3"</span>, <span class="string">":memory:"</span>)</div><div class="line"> </div><div class="line"><span class="comment">// 打开并连接数据库，遇到错误时触发panic</span></div><div class="line">db = sqlx.MustConnect(<span class="string">"sqlite3"</span>, <span class="string">":memory:"</span>)</div></pre></td></tr></table></figure>

<h2 id="基本查询">基本查询</h2>
<p><code>sqlx</code> 中的 handler 类型实现了与 <code>database/sql</code> 相同的基本动词来查询你的数据库：</p>
<ul>
<li><code>Exec(...) (sql.Result, error)</code> - 与 <code>database/sql</code> 中的方法没有变化</li>
<li><code>Query(...) (*sql.Rows, error)</code> - 与 <code>database/sql</code> 中的方法没有变化</li>
<li><code>QueryRow(...) *sql.Row</code> - 与 <code>database/sql</code> 中的方法没有变化</li>
</ul>
<p>以下是内置方法的扩展：</p>
<ul>
<li><code>MustExec() sql.Result</code> -- 执行 <code>Exec</code>，但遇到错误时会触发 <code>panic</code></li>
<li><code>Queryx(...) (*sqlx.Rows, error)</code> - 执行 <code>Query</code>，但返回一个 <code>sqlx.Rows</code></li>
<li><code>QueryRowx(...) *sqlx.Row</code> -- 执行 <code>QueryRow</code>，但返回一个 <code>sqlx.Row</code></li>
</ul>
<p>还有以下新的语义：</p>
<ul>
<li><code>Get(dest interface{}, ...) error</code></li>
<li><code>Select(dest interface{}, ...) error</code></li>
</ul>
<p>现在，我们从未改变的接口开始，一直介绍到新的语义，并解释它们的使用方法。</p>
<h3 id="执行_Exec">执行 Exec</h3>
<p><code>Exec</code> 和 <code>MustExec</code> 从连接池中获取一个连接，并在服务器上执行提供的语句。对于不支持即席（ad-hoc）查询执行的驱动程序，可能会在幕后创建一个预处理语句来执行。在返回结果之前，连接会被返回到连接池中。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">schema := <span class="string">`CREATE TABLE place (</span></div><div class="line">    country text,</div><div class="line">    city text NULL,</div><div class="line">    telcode integer);`</div><div class="line"> </div><div class="line"><span class="comment">// 执行一个查询</span></div><div class="line">result, err := db.Exec(schema)</div><div class="line"> </div><div class="line"><span class="comment">// 或者，你可以使用MustExec，在错误时会触发panic</span></div><div class="line">cityState := <span class="string">`INSERT INTO place (country, telcode) VALUES (?, ?)`</span></div><div class="line">countryCity := <span class="string">`INSERT INTO place (country, city, telcode) VALUES (?, ?, ?)`</span></div><div class="line">db.MustExec(cityState, <span class="string">"Hong Kong"</span>,<span class="number"> 852</span>)</div><div class="line">db.MustExec(cityState, <span class="string">"Singapore"</span>,<span class="number"> 65</span>)</div><div class="line">db.MustExec(countryCity, <span class="string">"South Africa"</span>, <span class="string">"Johannesburg"</span>,<span class="number"> 27</span>)</div></pre></td></tr></table></figure>

<p><code>Result</code>有两种可能的数据：<code>LastInsertId()</code> 或 <code>RowsAffected()</code>，这些数据的可用性取决于驱动程序。例如，在 MySQL 中，如果插入的表有自增主键，则 <code>LastInsertId()</code> 将可用，但在 PostgreSQL 中，这些信息只能通过使用 <code>RETURNING</code> 子句从普通行游标中检索。</p>
<h4 id="绑定变量_bindvars">绑定变量 bindvars</h4>
<p>内部称为绑定变量的 <code>?</code> 查询占位符非常重要；您应该始终使用这些占位符向数据库发送值，因为它们可以防止 SQL 注入攻击。<code>database/sql</code> 不会对查询文本进行任何验证；它会原样发送到服务器，同时发送编码后的参数。除非驱动程序实现了特殊接口，否则查询会在执行之前先在服务器上准备。因此，绑定变量是特定于数据库的：</p>
<ul>
<li>MySQL 使用上面展示的 <code>?</code> 变体</li>
<li>PostgreSQL 使用枚举的 <code>$1</code>,<code>$2</code>等绑定变量语法</li>
<li>SQLite 接受 <code>?</code> 和 <code>$1</code> 语法</li>
<li>Oracle 使用 <code>:name</code> 语法</li>
<li>其他数据库可能有所不同。您可以使用 <code>sqlx.DB.Rebind(string) string</code>函数和 <code>?</code> 绑定变量语法来获取适合在当前数据库类型上执行的查询。<br>关于绑定变量的一个常见误解是它们用于插值。它们仅用于参数化，并且<a href="https://use-the-index-luke.com/sql/where-clause/bind-parameters" target="_blank" rel="external">不允许</a>更改 SQL 语句的结构。例如，使用绑定变量来尝试参数化列名或表名将无法工作：</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 无法工作</span></div><div class="line">db.Query(<span class="string">"SELECT * FROM ?"</span>, <span class="string">"mytable"</span>)</div><div class="line"> </div><div class="line"><span class="comment">// 也无法工作</span></div><div class="line">db.Query(<span class="string">"SELECT ?, ? FROM people"</span>, <span class="string">"name"</span>, <span class="string">"location"</span>)</div></pre></td></tr></table></figure>

<h3 id="查询_Query">查询 Query</h3>
<p><code>Query</code> 是使用 <code>database/sql</code> 执行查询并返回行结果的主要方法。<code>Query</code> 返回一个 <code>sql.Rows</code> 对象和一个错误：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 从数据库获取所有地点</span></div><div class="line">rows, err := db.Query(<span class="string">"SELECT country, city, telcode FROM place"</span>)</div><div class="line"> </div><div class="line"><span class="comment">// 遍历每一行</span></div><div class="line"><span class="keyword">for</span> rows.Next() {</div><div class="line">    <span class="keyword">var</span> country <span class="typename">string</span></div><div class="line">    <span class="comment">// 注意city可能为NULL，所以我们使用NullString类型</span></div><div class="line">    <span class="keyword">var</span> city    sql.NullString</div><div class="line">    <span class="keyword">var</span> telcode <span class="typename">int</span></div><div class="line">    err = rows.Scan(&country, &city, &telcode)</div><div class="line">}</div><div class="line"><span class="comment">// 检查错误</span></div><div class="line">err = rows.Err()</div></pre></td></tr></table></figure>

<p>你应该把 <code>Rows</code> 当作数据库游标来处理，而不是一个具体化的结果列表。尽管驱动程序缓冲行为可能有所不同，但通过 <code>Next()</code> 进行迭代是限制大型结果集内存使用量的好方法，因为你一次只扫描一行。<code>Scan()</code> 使用反射将 SQL 列返回类型映射到 Go 类型，如 <code>string</code>、<code>[]byte</code> 等。如果你没有遍历完整个结果集，请确保调用 <code>rows.Close()</code> 将连接返回给连接池！</p>
<p><code>Query</code> 返回的错误是可能在服务器准备或执行期间发生的任何错误。这可能包括从连接池中获取了有问题的连接，尽管 <code>database/sql</code> 会重试 <a href="https://golang.org/src/pkg/database/sql/sql.go?s=23888:23957#L885" target="_blank" rel="external">10 次</a>以尝试找到或创建一个工作连接。一般来说，错误会由于错误的 SQL 语法、类型不匹配或不正确的字段和表名导致。</p>
<p>在大多数情况下，<code>Rows.Scan</code> 会复制它从驱动程序获取的数据，因为它不知道驱动程序如何重用其缓冲区。可以使用特殊类型 <code>sql.RawBytes</code> 来从驱动程序实际返回的数据中获取零拷贝的字节切片。在下次调用 <code>Next()</code> 之后，这样的值将不再有效，因为驱动程序可能已经覆盖了那段内存。</p>
<p><code>Query</code> 使用的连接在通过 Next 迭代完所有行之前或调用 <code>rows.Close()</code> 之后一直保持活动状态，之后该连接将被释放。有关更多信息，请参阅关于<a href="https://jmoiron.github.io/sqlx/#connectionPool" target="_blank" rel="external">连接池</a>的部分。</p>
<p><code>sqlx</code> 扩展的 <code>Queryx</code> 行为与 <code>Query</code> 完全一样，但返回的是 <code>sqlx.Rows</code>，它具有扩展的扫描行为：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Place <span class="keyword">struct</span> {</div><div class="line">    Country       <span class="typename">string</span></div><div class="line">    City          sql.NullString</div><div class="line">    TelephoneCode <span class="typename">int</span> <span class="string">`db:"telcode"`</span></div><div class="line">}</div><div class="line"> </div><div class="line">rows, err := db.Queryx(<span class="string">"SELECT * FROM place"</span>)</div><div class="line"><span class="keyword">for</span> rows.Next() {</div><div class="line">    <span class="keyword">var</span> p Place</div><div class="line">    err = rows.StructScan(&p)</div><div class="line">}</div></pre></td></tr></table></figure>

<p><code>sqlx.Rows</code> 的主要扩展方法是 <code>StructScan()</code>，它可以自动将查询结果扫描到结构体的字段中。请注意，为了让 <code>sqlx</code> 能够写入这些字段，这些字段必须是导出的（即首字母大写），这是 Go 中所有序列化器（<code>marshaller</code>）的共同要求。你可以使用 <code>db</code> 结构标签来指定哪个列名映射到结构体的哪个字段，或者使用 <code>db.MapperFunc()</code> 设置新的默认映射规则。默认行为是使用 <code>strings.ToLower</code> 对字段名进行小写转换以匹配列名。有关 <code>StructScan</code>、<code>SliceScan</code> 和 <code>MapScan</code> 的更多信息，请参阅高级扫描部分。</p>
<h2 id="查询单行_QueryRow">查询单行 QueryRow</h2>
<p><code>QueryRow</code> 从服务器获取一行数据。它从连接池中获取一个连接，并使用 <code>Query</code> 执行查询，返回一个 <code>Row</code> 对象，该对象具有自己的内部 <code>Rows</code> 对象：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">row := db.QueryRow(<span class="string">"SELECT * FROM place WHERE telcode=?"</span>,<span class="number"> 852</span>)</div><div class="line"><span class="keyword">var</span> telcode <span class="typename">int</span></div><div class="line">err = row.Scan(&telcode)</div></pre></td></tr></table></figure>

<p>与 <code>Query</code> 不同，<code>QueryRow</code> 返回一个 <code>Row</code> 类型的结果而不返回错误，这使得可以安全地从返回结果中链式调用 <code>Scan</code> 方法。如果执行查询时发生错误，该错误将由 <code>Scan</code> 返回。如果没有行，<code>Scan</code> 会返回 <code>sql.ErrNoRows</code>。如果扫描本身失败（例如，由于类型不匹配），也会返回该错误。</p>
<p><code>Row</code> 结果内部的 <code>Rows</code> 结构在 <code>Scan</code> 时会被关闭，这意味着 <code>QueryRow</code> 使用的连接会在结果被扫描之前一直保持打开状态。这也意味着 <code>sql.RawBytes</code> 在这里不可用，因为引用的内存属于驱动程序，在控制权返回给调用者时可能已经无效。</p>
<p><code>sqlx</code> 扩展的 <code>QueryRowx</code> 将返回一个<code>sqlx.Row</code> 而不是 <code>sql.Row</code>，它实现了与 <code>Rows</code> 相同的扫描扩展，上面已经说过，并在高级扫描部分有详细解释：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> p Place</div><div class="line">err := db.QueryRowx(<span class="string">"SELECT city, telcode FROM place LIMIT 1"</span>).StructScan(&p)</div></pre></td></tr></table></figure>

<h2 id="Get_和_Select">Get 和 Select</h2>
<p><code>Get</code> 和 <code>Select</code> 是针对 handler 类型的省时的扩展，它们将查询执行与灵活的扫描语义结合起来。为了清楚地解释它们，我们需要谈谈什么是可扫描的：</p>
<ul>
<li>如果一个值不是结构体，比如字符串（<code>string</code>）、整数（<code>int</code>），那么它就是可扫描的。</li>
<li>如果一个值实现了 <code>sql.Scanner</code> 接口，那么它就是可扫描的。</li>
<li>如果一个值是结构体，但没有导出的字段（例如 <code>time.Time</code>），那么它也是可扫描的。</li>
</ul>
<p><code>Get</code> 和 <code>Select</code> 在可扫描类型上使用 <code>rows.Scan</code>，在非可扫描类型上使用 <code>rows.StructScan</code>。它们大致分别对应于 <code>QueryRow</code> 和 <code>Query</code>，其中 <code>Get</code> 用于获取单个结果并进行扫描，而 <code>Select</code> 用于获取结果的切片：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">p := Place{}</div><div class="line">pp := []Place{}</div><div class="line"> </div><div class="line"><span class="comment">//这将直接将第一个地点拉取到p中</span></div><div class="line">err = db.Get(&p, <span class="string">"SELECT * FROM place LIMIT 1"</span>)</div><div class="line"> </div><div class="line"><span class="comment">// 这将把telcode大于50的地点拉取到切片pp中</span></div><div class="line">err = db.Select(&pp, <span class="string">"SELECT * FROM place WHERE telcode &gt; ?"</span>,<span class="number"> 50</span>)</div><div class="line"> </div><div class="line"><span class="comment">// 也可以使用普通类型</span></div><div class="line"><span class="keyword">var</span> id <span class="typename">int</span></div><div class="line">err = db.Get(&id, <span class="string">"SELECT count(*) FROM place"</span>)</div><div class="line"> </div><div class="line"><span class="comment">// 获取最多10个地点名称</span></div><div class="line"><span class="keyword">var</span> names []<span class="typename">string</span></div><div class="line">err = db.Select(&names, <span class="string">"SELECT name FROM place LIMIT 10"</span>)</div></pre></td></tr></table></figure>

<blockquote>
<p>这两个方法基本可以把我前一篇封装的helper函数替代掉了。</p>
</blockquote>
<p><code>Get</code> 和 <code>Select</code> 都会在查询执行过程中关闭它们创建的 <code>Rows</code>，并返回在此过程中任何步骤遇到的错误。由于它们内部使用 <code>StructScan</code>，因此高级扫描部分中的细节也适用于 <code>Get</code> 和 <code>Select</code>。</p>
<p><code>Select</code> 可以为您节省大量输入，但要小心！它在语义上与 <code>Queryx</code> 不同，因为<strong>它会一次性将整个结果集加载到内存中</strong>。如果查询没有将结果集限制在合理的大小，那么最好使用经典的 <code>Queryx/StructScan</code> 迭代方式。</p>
<blockquote>
<p>试想你要处理几千万行的数据，一条一条的拉取和处理，比一次性读入到内存中处理，资源使用更友好。</p>
</blockquote>
<h2 id="事务_Transaction">事务 Transaction</h2>
<p>要使用事务，您必须使用 <code>DB.Begin()</code> 创建一个事务 handler 。像这样的代码将不会工作：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 这将不会工作，如果连接池&gt;1</span></div><div class="line">db.MustExec(<span class="string">"BEGIN;"</span>)</div><div class="line">db.MustExec(...)</div><div class="line">db.MustExec(<span class="string">"COMMIT;"</span>)</div></pre></td></tr></table></figure>

<p>请记住，<code>Exec</code> 和其他所有查询动词每次都会向数据库请求一个连接，并在使用后将其返回给连接池。因此，无法保证您会收到执行 <code>BEGIN</code> 语句时使用的同一个连接。要使用事务，您必须使用<code>DB.Begin()</code>。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">tx, err := db.Begin()</div><div class="line">err = tx.Exec(...)</div><div class="line">err = tx.Commit()</div></pre></td></tr></table></figure>

<p><code>DB</code>  handler 还有 <code>Beginx()</code> 和 <code>MustBegin()</code> 扩展方法，它们返回一个 <code>sqlx.Tx</code> 而不是 <code>sql.Tx</code>：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">tx := db.MustBegin()</div><div class="line">tx.MustExec(...)</div><div class="line">err = tx.Commit()</div></pre></td></tr></table></figure>

<p><code>sqlx.Tx</code> 拥有 <code>sqlx.DB</code> 的所有 handler 扩展。</p>
<p>由于事务是连接状态，<code>Tx</code> 对象必须从连接池中绑定并控制一个单一的连接。在整个生命周期中，<code>Tx</code> 将维持这个单一的连接，只有在调用 <code>Commit()</code> 或 <code>Rollback()</code> 时才会释放它。你应该至少调用这两个函数之一，否则连接将一直被占用，直到垃圾收集器回收。</p>
<p>因为在一个事务中你只能使用一个连接，所以你一次只能执行一个语句；在执行另一个查询之前，必须分别扫描或关闭 <code>Row</code> 和 <code>Rows</code> 类型的游标。如果你尝试在服务器向你发送结果时向服务器发送数据，它可能会破坏连接。</p>
<p>最后，<code>Tx</code> 对象并不实际上在服务器上执行任何行为；它们只是执行一个 <code>BEGIN</code> 语句并绑定一个单一的连接。事务的实际行为，包括锁定和隔离等，完全是未指定的，并且依赖于数据库。</p>
<h2 id="预编译语句_Prepared_Statement">预编译语句 Prepared Statement</h2>
<p>在大多数数据库中，当执行查询时，实际上会在幕后准备语句。但是，您也可以使用 <code>sqlx.DB.Prepare()</code> 明确地准备语句以便在其他地方重用。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">stmt, err := db.Prepare(<span class="string">`SELECT * FROM place WHERE telcode=?`</span>)</div><div class="line">row = stmt.QueryRow<span class="number">(65</span>)</div><div class="line"> </div><div class="line">tx, err := db.Begin()</div><div class="line">txStmt, err := tx.Prepare(<span class="string">`SELECT * FROM place WHERE telcode=?`</span>)</div><div class="line">row = txStmt.QueryRow<span class="number">(852</span>)</div></pre></td></tr></table></figure>

<p><code>Prepare</code> 实际上是在数据库上执行准备操作的，因此它需要一个连接和连接状态。<code>database/sql</code> 为你抽象了这些，允许你通过在新连接上自动创建语句，从单个 <code>Stmt</code> 对象在多个连接上并发执行。<code>Preparex()</code> 返回一个 <code>sqlx.Stmt</code>，它拥有 <code>sqlx.DB</code> 和 <code>sqlx.Tx</code>的所有 handler 扩展功能：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">stmt, err := db.Preparex(<span class="string">`SELECT * FROM place WHERE telcode=?`</span>)</div><div class="line"><span class="keyword">var</span> p Place</div><div class="line">err = stmt.Get(&p,<span class="number"> 852</span>)</div></pre></td></tr></table></figure>

<p>标准的 <code>sql.Tx</code> 对象还有一个 <code>Stmt()</code> 方法，该方法可以从预先存在的语句中返回一个特定于事务的语句。<code>sqlx.Tx</code> 有一个 <code>Stmtx</code> 版本，可以从现有的 <code>sql.Stmt</code> 或 <code>sqlx.Stmt</code> 创建一个新的特定于事务的 <code>sqlx.Stmt</code>。</p>
<h2 id="查询辅助方法_Query_Helper">查询辅助方法 Query Helper</h2>
<p><code>database/sql</code> 包不会对您的实际查询文本进行任何处理。这使得在您的代码中使用特定于后端的特性变得轻而易举；您可以像在数据库提示符中一样编写查询。虽然这非常灵活，但它使得编写某些类型的查询变得困难。</p>
<h3 id="&quot;In&quot;_子句">&quot;In&quot; 子句</h3>
<p>由于 <code>database/sql</code> 不会检查您的查询，而是直接将参数传递给驱动程序，因此处理带有 <code>IN</code> 子句的查询会变得困难：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">SELECT * FROM users WHERE level IN (?);</div></pre></td></tr></table></figure>

<p>当在后端将其准备为语句时，绑定变量 ? 只会对应一个参数，但通常我们希望它根据某个切片的长度来对应可变数量的参数，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> levels = []<span class="typename">int</span><span class="number">{4</span>,<span class="number"> 6</span>,<span class="number"> 7</span>}</div><div class="line">rows, err := db.Query(<span class="string">"SELECT * FROM users WHERE level IN (?);"</span>, levels)</div></pre></td></tr></table></figure>

<p>通过使用 sqlx.In 预先处理查询语句，可以实现这种模式：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> levels = []<span class="typename">int</span><span class="number">{4</span>,<span class="number"> 6</span>,<span class="number"> 7</span>}</div><div class="line">query, args, err := sqlx.In(<span class="string">"SELECT * FROM users WHERE level IN (?);"</span>, levels)</div><div class="line"> </div><div class="line"><span class="comment">// sqlx.In返回带有`?`绑定变量的查询，我们可以重新绑定它以适应我们的后端</span></div><div class="line">query = db.Rebind(query)</div><div class="line">rows, err := db.Query(query, args...)</div></pre></td></tr></table></figure>

<p>使用 <code>sqlx.In</code> 预先处理查询语句可以实现这种模式：<code>sqlx.In</code> 会扩展传递给它的查询中的任何绑定变量（<code>bindvars</code>），这些绑定变量对应于参数中的切片，并扩展到与切片长度相同数量的占位符，然后将这些切片元素追加到一个新的参数列表中。它仅对 <code>?</code> 绑定变量执行此操作；您可以使用 <code>db.Rebind</code> 来获取适合您后端的查询语句。</p>
<h3 id="命名查询_Named_Query">命名查询 Named Query</h3>
<p>命名查询在许多其他数据库包中都很常见。它们允许您使用绑定变量语法，该语法通过结构体字段的名称或映射键来绑定查询中的变量，而不是按位置引用所有内容。结构体字段的命名约定遵循 <code>StructScan</code> 的规则，使用 <code>NameMapper</code> 和 <code>db</code> 结构体标签。与命名查询相关的有两个额外的查询动词：</p>
<ul>
<li><code>NamedQuery(...) (*sqlx.Rows, error)</code> - 类似于 Queryx，但使用命名绑定变量</li>
<li><code>NamedExec(...) (sql.Result, error)</code> - 类似于 Exec，但使用命名绑定变量</li>
</ul>
<p>还有一个额外的 handler 类型：</p>
<ul>
<li><code>NamedStmt</code> - 一个 <code>sqlx.Stmt</code>，可以使用命名绑定变量进行准备</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 使用结构体的命名查询</span></div><div class="line">p := Place{Country: <span class="string">"South Africa"</span>}</div><div class="line">rows, err := db.NamedQuery(<span class="string">`SELECT * FROM place WHERE country=:country`</span>, p)</div><div class="line"> </div><div class="line"><span class="comment">// 使用map的命名查询</span></div><div class="line">m := <span class="keyword">map</span>[<span class="typename">string</span>]<span class="keyword">interface</span>{}{<span class="string">"city"</span>: <span class="string">"Johannesburg"</span>}</div><div class="line">result, err := db.NamedExec(<span class="string">`SELECT * FROM place WHERE city=:city`</span>, m)</div></pre></td></tr></table></figure>

<p>命名查询的执行和准备适用于结构体和Map。如果你想要完整的查询操作集，可以准备一个命名语句并使用它：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">p := Place{TelephoneCode:<span class="number"> 50</span>}</div><div class="line">pp := []Place{}</div><div class="line"> </div><div class="line"><span class="comment">// 查询所有telcode大于50的地点</span></div><div class="line">nstmt, err := db.PrepareNamed(<span class="string">`SELECT * FROM place WHERE telcode &gt; :telcode`</span>)</div><div class="line">err = nstmt.Select(&pp, p)</div></pre></td></tr></table></figure>

<p>命名查询支持是通过解析查询中的 <code>:param</code> 语法，并将其替换为底层数据库支持的绑定变量来实现的，然后在执行时执行映射，因此它可以在 <code>sqlx</code> 支持的任何数据库上使用。你还可以使用 <code>sqlx.Named</code>，它使用 <code>?</code> 绑定变量，并且可以与 <code>sqlx.In</code> 组合使用：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">arg := <span class="keyword">map</span>[<span class="typename">string</span>]<span class="keyword">interface</span>{}{</div><div class="line">    <span class="string">"published"</span>: <span class="constant">true</span>,</div><div class="line">    <span class="string">"authors"</span>: []<span class="number">{8</span>,<span class="number"> 19</span>,<span class="number"> 32</span>,<span class="number"> 44</span>},</div><div class="line">}</div><div class="line">query, args, err := sqlx.Named(<span class="string">"SELECT * FROM articles WHERE published=:published AND author_id IN (:authors)"</span>, arg)</div><div class="line">query, args, err := sqlx.In(query, args...)</div><div class="line">query = db.Rebind(query)</div><div class="line">db.Query(query, args...)</div></pre></td></tr></table></figure>

<h2 id="高级扫描_Advanced_Scanning">高级扫描 Advanced Scanning</h2>
<p><code>StructScan</code> 相当复杂但具有欺骗性。它支持嵌入的结构体，并使用与 Go 用于嵌入属性和方法访问相同的优先级规则为字段赋值。这种用法的一个常见例子是在多个表之间共享表模型的公共部分，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> AutoIncr <span class="keyword">struct</span> {</div><div class="line">    ID       <span class="typename">uint64</span></div><div class="line">    Created  time.Time</div><div class="line">}</div><div class="line"> </div><div class="line"><span class="keyword">type</span> Place <span class="keyword">struct</span> {</div><div class="line">    Address <span class="typename">string</span></div><div class="line">    AutoIncr</div><div class="line">}</div><div class="line"> </div><div class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> {</div><div class="line">    Name <span class="typename">string</span></div><div class="line">    AutoIncr</div><div class="line">}</div></pre></td></tr></table></figure>

<p>使用上述结构体，<code>Person</code> 和 <code>Place</code> 都能够从 <code>StructScan</code> 中接收 <code>id</code> 和 <code>created</code> 列，因为它们都嵌入了定义了这些列的 <code>AutoIncr</code> 结构体。这个功能可以让你快速地为连接操作创建一个临时的表。它还可以递归地工作；以下结构体可以通过 Go 的点运算符和 <code>StructScan</code> 访问 <code>Person</code> 的 <code>Name</code> <code>字段、AutoIncr</code> 的 <code>ID</code> 和 <code>Created</code> 字段：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Employee <span class="keyword">struct</span> {</div><div class="line">    BossID <span class="typename">uint64</span></div><div class="line">    EmployeeID <span class="typename">uint64</span></div><div class="line">    Person</div><div class="line">}</div></pre></td></tr></table></figure>

<p>请注意，<code>sqlx</code> 历史上一度支持此功能用于非嵌入结构体，但这最终变得令人困惑，因为用户使用此功能来定义关系，并两次嵌入相同的结构体：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Child <span class="keyword">struct</span> {</div><div class="line">    Father Person</div><div class="line">    Mother Person</div><div class="line">}</div></pre></td></tr></table></figure>

<p>这会引起一些问题。在 Go 语言中，隐藏后代字段是合法的；如果嵌入示例中的 <code>Employee</code> 定义了一个 <code>Name</code> 字段，那么它会优先于 <code>Person</code> 的 <code>Name</code> 字段。但是，模糊的选择器是非法的，并且会导致运行时错误。如果我们想为 <code>Person</code> 和 <code>Place</code> 创建一个快速的 <code>JOIN</code> 类型，那么我们应该在哪里放置 <code>id</code> 列，这两个类型都通过嵌入的 <code>AutoIncr</code> 定义了 <code>id</code> 列？是否会出现错误？</p>
<p>由于 <code>sqlx</code> 构建字段名到字段地址映射的方式，在将结果扫描到结构体时，它不再知道在遍历结构体树时是否遇到过两次相同的字段名。因此，与 Go <code>语言不同，StructScan</code> 会选择遇到的<strong>第一个具有该名称的字段</strong>。由于 Go 语言的结构体字段是从上到下排序的，而 <code>sqlx</code> 为了保持优先级规则，采用广度优先遍历，因此会选择<strong>最浅、最顶部</strong>的定义。例如，在以下类型中：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> PersonPlace <span class="keyword">struct</span> {</div><div class="line">    Person</div><div class="line">    Place</div><div class="line">}</div></pre></td></tr></table></figure>

<p><code>StructScan</code> 会将 <code>id</code> 列的结果设置在 <code>Person.AutoIncr.ID</code> 中，也可以通过 <code>Person.ID</code> 访问。为了避免混淆，建议你在 <code>SQL</code> 中使用 <code>AS</code> 来创建列别名。</p>
<h3 id="安全扫描目的字段">安全扫描目的字段</h3>
<p>默认情况下，如果某一列无法映射到目标结构体中的字段，<code>StructScan</code> 将返回一个错误。这模仿了 Go 中对未使用变量的处理方式，但与标准库中的序列化器（如 <code>encoding/json</code>）的行为不符。由于 SQL 通常以比解析 JSON 更受控的方式执行，并且这些错误通常是编码错误，因此决定默认返回错误。</p>
<p>与未使用的变量类似，忽略的列会浪费网络和数据库资源，而且在没有映射器通知未找到某些内容的情况下，很难在早期检测到不兼容的映射或结构标签中的拼写错误。</p>
<p>尽管如此，在某些情况下，可能希望忽略没有目标字段的列。为此，每种 Handle 类型都有一个 Unsafe 方法，它返回该 handler 的新副本，并关闭此安全检查：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> p Person</div><div class="line"><span class="comment">// 由于place列没有字段目标，所以这里的err不是nil</span></div><div class="line">err = db.Get(&p, <span class="string">"SELECT * FROM person, place LIMIT 1;"</span>)</div><div class="line"> </div><div class="line"><span class="comment">// 这不会返回错误，即使place列没有目标</span></div><div class="line">udb := db.Unsafe()</div><div class="line">err = udb.Get(&p, <span class="string">"SELECT * FROM person, place LIMIT 1;"</span>)</div></pre></td></tr></table></figure>

<h3 id="控制命名映射">控制命名映射</h3>
<p>用作 <code>StructScan</code> 目标的结构体字段必须大写以便 <code>sqlx</code> 能够访问。因此，<code>sqlx</code> 使用了一个 <code>NameMapper</code>，该映射器将字段名应用 <code>strings.ToLower</code> 函数以将它们映射到行结果中的列。但是，这并不总是符合需求的，这取决于你的数据库模式，因此 <code>sqlx</code> 允许以多种方式自定义映射。</p>
<p>最简单的方式是通过使用 <code>sqlx.DB.MapperFunc</code> 为数据库 handler 设置映射器，该方法接收一个类型为 <code>func(string) string</code> 的参数。如果你的库需要特定的映射器，并且你不想污染你接收到的 <code>sqlx.DB</code>，你可以为库创建一个副本以确保使用特定的默认映射：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 如果我们的数据库模式使用大写列，我们可以使用普通字段</span></div><div class="line">db.MapperFunc(strings.ToUpper)</div><div class="line"> </div><div class="line"><span class="comment">// 假定一个库使用小写列，我们可以创建一个副本</span></div><div class="line"><span class="built_in">copy</span> := sqlx.NewDb(db.DB, db.DriverName())</div><div class="line"><span class="built_in">copy</span>.MapperFunc(strings.ToLower)</div></pre></td></tr></table></figure>

<p>每个 <code>sqlx.DB</code> 使用 <code>sqlx/reflectx</code> 包的 <code>Mapper</code> 来实现这种映射，并将活动的映射器公开为 <code>sqlx.DB.Mapper</code>。你可以通过直接设置来进一步自定义 DB 上的映射：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> <span class="string">"github.com/jmoiron/sqlx/reflectx"</span></div><div class="line"> </div><div class="line"><span class="comment">// 创建一个新的映射器，它将使用结构字段标签“json”而不是“db”</span></div><div class="line">db.Mapper = reflectx.NewMapperFunc(<span class="string">"json"</span>, strings.ToLower)</div></pre></td></tr></table></figure>

<h3 id="替代扫描类型">替代扫描类型</h3>
<p>除了使用 <code>Scan</code> 和 <code>StructScan`</code>，sqlx<code>的</code>Row<code>或</code>Rows` 还可以用于自动返回结果切片或Map：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">rows, err := db.Queryx(<span class="string">"SELECT * FROM place"</span>)</div><div class="line"><span class="keyword">for</span> rows.Next() {</div><div class="line">    <span class="comment">// cols 代表所有列结果的[]interface{}</span></div><div class="line">    cols, err := rows.SliceScan()</div><div class="line">}</div><div class="line"> </div><div class="line">rows, err := db.Queryx(<span class="string">"SELECT * FROM place"</span>)</div><div class="line"><span class="keyword">for</span> rows.Next() {</div><div class="line">    results := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="typename">string</span>]<span class="keyword">interface</span>{})</div><div class="line">    err = rows.MapScan(results)</div><div class="line">}</div></pre></td></tr></table></figure>

<p><code>SliceScan</code> 返回一个 <code>[]interface{}</code>，其中包含所有列的数据，这在你代表第三方执行查询且无法知道可能会返回哪些列的情况下非常有用。<code>MapScan</code> 的行为类似，但它将列名映射到 <code>interface{}</code> 类型的值上。这里有一个重要的注意事项：<code>rows.Columns()</code>返回的结果不包括完全限定的名称，因此执行如 <code>SELECT a.id, b.id FROM a NATURAL JOIN b</code> <code>的查询时，Columns</code> 的结果将是 <code>[]string{&quot;id&quot;, &quot;id&quot;}</code>，这会导致你的Map中其中一个结果会被覆盖。</p>
<h2 id="自定义类型">自定义类型</h2>
<p>上面的例子都使用了内置类型来进行扫描和查询，但 <code>database/sql</code> 提供了接口，允许你使用任何自定义类型：</p>
<ul>
<li><code>sql.Scanner</code> 允许你在 <code>Scan()</code> 中使用自定义类型</li>
<li><code>driver.Valuer</code> 允许你在 <code>Query/QueryRow/Exec</code> 中使用自定义类型</li>
</ul>
<p>这些是标准接口，使用它们可以确保与任何可能在 <code>database/sql</code> 之上提供服务的库的兼容性。要详细了解如何使用它们，请阅读<a href="http://jmoiron.net/blog/built-in-interfaces" target="_blank" rel="external">这篇博客文章</a>或查看 <a href="https://github.com/jmoiron/sqlx/blob/master/types/types.go" target="_blank" rel="external">sqlx/types</a> 包，该包实现了一些标准的有用类型。</p>
<h2 id="连接池">连接池</h2>
<p>语句准备和查询执行需要一个连接，DB 对象将管理一个连接池，以便它可以安全地用于并发查询。在 Go 1.2 及更高版本中，有两种方式控制连接池的大小：</p>
<ul>
<li>DB.SetMaxIdleConns(n int)</li>
<li>DB.SetMaxOpenConns(n int)</li>
</ul>
<p>默认情况下，连接池会无限制地增长，并且当池中没有空闲连接可用时，就会创建新的连接。你可以使用 <code>DB.SetMaxOpenConns</code> 来设置池的最大大小。未被使用的连接会被标记为空闲状态，如果不再需要，它们就会被关闭。为了避免频繁地创建和关闭连接，请使用 <code>DB.SetMaxIdleConns</code> 将最大空闲大小设置为适合你的查询负载的大小。</p>
<p>如果不小心持有连接，很容易遇到麻烦。为了避免这种情况：</p>
<ul>
<li>确保你使用 <code>Scan()</code> 扫描每个 <code>Row</code> 对象</li>
<li>确保你通过 <code>Close()</code> 或完全迭代 <code>Next()</code> 来处理每个 <code>Rows</code> 对象</li>
<li>确保每个事务都通过 <code>Commit()</code> 或 <code>Rollback()</code> 返回其连接</li>
</ul>
<p>如果你忽略了这些操作中的任何一个，它们所使用的连接可能会被保持到垃圾回收，而你的数据库将最终创建大量连接以补偿正在使用的连接。请注意，<code>Rows.Close()</code> 可以安全地多次调用，因此不必担心在可能不必要的地方调用它。</p>

      
    </div>
    <footer class="article-footer">
      

      
      <!-- <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
      <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script> -->
      <section id="comments">
        <script src="https://utteranc.es/client.js"
                repo="smallnest/gitalk"
                issue-term="title"
                theme="github-light"
                crossorigin="anonymous"
                async>
        </script>
        <!-- <div id="gitalk-container"></div>
        <script type="text/javascript">
          var gitalkOpts = {
            id: '2024/05/10/sqlx-a-brief-introduction/',
            owner: 'smallnest',
            repo: 'gitalk',
            title: 'sqlx: 扩展标准sql库',
            body: 'https://colobu.com/2024/05/10/sqlx-a-brief-introduction/',
            clientID: 'bc02724130ed5b7ee275',
            clientSecret: '68cb0bae2f93a8b88b09e0eb9b08c844b06a9047',
            admin: ['smallnest'],
            distractionFreeMode: false
          };

          const gitalk = new Gitalk(gitalkOpts)
          gitalk.render('gitalk-container')
        </script> -->
        <noscript> 为正常使用评论功能请激活JavaScript</noscript>
      </section>

      

    </footer>
  </div>
  
  
<nav id="article-nav">
  
    <a href="/2024/05/12/sqlx-an-async-pure-Rust-SQL-crate/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          sqlx: 一个优秀的rust异步SQL库
        
      </div>
    </a>
  
  
    <a href="/2024/05/10/Linux-File-IO-using-Rust/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">“测试 Rust 的 I/O 性能”</div>
    </a>
  
</nav>

  
</article></section>
        
          <aside id="sidebar">
  
    <div class="widget-wrap">
  <h3 class="widget-title">访问者来源</h3>
  <div class="widget">
    <script type="text/javascript" id="clstr_globe" src="//clustrmaps.com/globe.js?d=Hf4EJSi2XvL6TMcuFSH51Qn6nf5nZ8qnjVBnWCQ4FGc"></script>
  </div>
</div>

<div class="widget-wrap">
  <h3 class="widget-title">微信公众号</h3>
  <div class="widget">
    <img width="100%" src="/images/widgets/gopatterns.jpg">
  </div>
</div>

<div class="widget-wrap">
  <h3 class="widget-title">极客时间专栏</h3>
  <div class="widget">
    <a href="https://time.geekbang.org/column/intro/100061801">
      <img width="100%" src="/images/widgets/geekbang.png">
    </a>
  </div>
</div>

<div class="widget-wrap">
    <h3 class="widget-title">出版图书</h3>
    <div class="widget">
      <a href="https://cpgo.colobu.com/">
        <img width="100%" src="/cpgolang/cpgo.png">
      </a>
    </div>
    <div class="widget">
      <a href="https://item.jd.com/14347716.html">
        <img width="100%" src="/100gomistakes/cover.png">
      </a>
    </div>
    <div class="widget">
      <a href="/ScalaCollectionsCookbook/">
        <img width="100%" src="/ScalaCollectionsCookbook/scala_collections_cookbook.jpg">
        <img width="100%" src="/ScalaCollectionsCookbook/scala_collections_cookbook_tw.png">
      </a>
    </div>
</div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/C/">C++</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/DOTNET/">DOTNET</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Go/">Go</a><span class="category-list-count">283</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">64</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Rust/">Rust</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Scala/">Scala</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/go/">go</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/k8s/">k8s</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/rust/">rust</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/分享/">分享</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端开发/">前端开发</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/区块链/">区块链</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/大数据/">大数据</a><span class="category-list-count">60</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工具/">工具</a><span class="category-list-count">28</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/">数据库</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/架构/">架构</a><span class="category-list-count">27</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/管理/">管理</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络编程/">网络编程</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计模式/">设计模式</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/读书笔记/">读书笔记</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/运维/">运维</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/高并发编程/">高并发编程</a><span class="category-list-count">20</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/Android/" style="font-size: 15.71px;">Android</a><a href="/tags/ApacheBench/" style="font-size: 11.43px;">ApacheBench</a><a href="/tags/Bower/" style="font-size: 10.00px;">Bower</a><a href="/tags/C/" style="font-size: 10.00px;">C#</a><a href="/tags/CDN/" style="font-size: 10.00px;">CDN</a><a href="/tags/CQRS/" style="font-size: 10.00px;">CQRS</a><a href="/tags/CRC/" style="font-size: 10.00px;">CRC</a><a href="/tags/CSS/" style="font-size: 11.43px;">CSS</a><a href="/tags/CompletableFuture/" style="font-size: 10.00px;">CompletableFuture</a><a href="/tags/Comsat/" style="font-size: 10.00px;">Comsat</a><a href="/tags/Curator/" style="font-size: 18.57px;">Curator</a><a href="/tags/DSL/" style="font-size: 10.00px;">DSL</a><a href="/tags/Disruptor/" style="font-size: 10.00px;">Disruptor</a><a href="/tags/Docker/" style="font-size: 11.43px;">Docker</a><a href="/tags/Ember/" style="font-size: 11.43px;">Ember</a><a href="/tags/FastJson/" style="font-size: 10.00px;">FastJson</a><a href="/tags/Fiber/" style="font-size: 10.00px;">Fiber</a><a href="/tags/GAE/" style="font-size: 10.00px;">GAE</a><a href="/tags/GC/" style="font-size: 12.86px;">GC</a><a href="/tags/Gnuplot/" style="font-size: 10.00px;">Gnuplot</a><a href="/tags/Go/" style="font-size: 14.29px;">Go</a><a href="/tags/Gradle/" style="font-size: 10.00px;">Gradle</a><a href="/tags/Grunt/" style="font-size: 10.00px;">Grunt</a><a href="/tags/Gulp/" style="font-size: 10.00px;">Gulp</a><a href="/tags/Hadoop/" style="font-size: 10.00px;">Hadoop</a><a href="/tags/Hazelcast/" style="font-size: 10.00px;">Hazelcast</a><a href="/tags/IPFS/" style="font-size: 10.00px;">IPFS</a><a href="/tags/Ignite/" style="font-size: 10.00px;">Ignite</a><a href="/tags/JVM/" style="font-size: 10.00px;">JVM</a><a href="/tags/Java/" style="font-size: 17.14px;">Java</a><a href="/tags/Kafka/" style="font-size: 20.00px;">Kafka</a><a href="/tags/Lambda/" style="font-size: 14.29px;">Lambda</a><a href="/tags/Linux/" style="font-size: 12.86px;">Linux</a><a href="/tags/LongAdder/" style="font-size: 10.00px;">LongAdder</a><a href="/tags/MathJax/" style="font-size: 10.00px;">MathJax</a><a href="/tags/Maven/" style="font-size: 11.43px;">Maven</a><a href="/tags/Memcached/" style="font-size: 10.00px;">Memcached</a><a href="/tags/Metrics/" style="font-size: 10.00px;">Metrics</a><a href="/tags/Mongo/" style="font-size: 12.86px;">Mongo</a><a href="/tags/Netty/" style="font-size: 15.71px;">Netty</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/06/">June 2024</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/05/">May 2024</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">April 2024</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">March 2024</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/02/">February 2024</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/01/">January 2024</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">December 2023</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">November 2023</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/10/">October 2023</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/09/">September 2023</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/08/">August 2023</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/07/">July 2023</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/06/">June 2023</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">May 2023</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/04/">April 2023</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/03/">March 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">January 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/12/">December 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/11/">November 2022</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">October 2022</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">September 2022</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">August 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">July 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">June 2022</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">May 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">April 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">March 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">February 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">November 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">August 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">July 2021</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">June 2021</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">July 2015</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">June 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">May 2015</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">April 2015</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">March 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/02/">February 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">January 2015</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">December 2014</a><span class="archive-list-count">28</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/11/">November 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/10/">October 2014</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">September 2014</a><span class="archive-list-count">28</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">August 2014</a><span class="archive-list-count">19</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/07/">July 2014</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">近期文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/06/04/redka-redis-with-sqlite/">Redka - 父亲是Redis，母亲是SQLite</a>
          </li>
        
          <li>
            <a href="/2024/06/03/command-dispacher-pattern/">命令分发模式</a>
          </li>
        
          <li>
            <a href="/2024/05/22/parse-tcp-timestamp-in-Rust/">使用Rust捕获和解析网络包</a>
          </li>
        
          <li>
            <a href="/2024/05/20/implemenmt-pping-in-go/">使用Go语言实现 pping</a>
          </li>
        
          <li>
            <a href="/2024/05/19/let-Rob-Pike-write-a-Red-Black-tree/">让 Rob Pike 或者字节跳动的同学实现一个红黑树</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">友情链接</h3>
    <div class="widget">
      <ul>
        
          <li>
			 
            <a href="http://stackshare.io" target="_blank">技术栈</a>
			
          </li>
        
          <li>
			 
			&nbsp;
			
          </li>
        
          <li>
			 
            <a href="https://toutiao.io/" target="_blank">开发者头条</a>
			
          </li>
        
          <li>
			 
            <a href="http://weekly.manong.io/issues/" target="_blank">码农周刊</a>
			
          </li>
        
          <li>
			 
            <a href="http://www.tuicool.com/mags" target="_blank">编程狂人周刊</a>
			
          </li>
        
          <li>
			 
            <a href="http://www.importnew.com/" target="_blank">importnew</a>
			
          </li>
        
          <li>
			 
            <a href="http://ifeve.com/" target="_blank">并发编程网</a>
			
          </li>
        
          <li>
			 
			&nbsp;
			
          </li>
        
          <li>
			 
            <a href="http://github.com" target="_blank">github</a>
			
          </li>
        
          <li>
			 
            <a href="http://stackoverflow.com/" target="_blank">stackoverflow</a>
			
          </li>
        
          <li>
			 
            <a href="http://www.javacodegeeks.com/" target="_blank">javacodegeeks</a>
			
          </li>
        
          <li>
			 
            <a href="http://www.infoq.com/" target="_blank">infoq</a>
			
          </li>
        
          <li>
			 
            <a href="http://www.dzone.com/links/index.html" target="_blank">dzone</a>
			
          </li>
        
          <li>
			 
            <a href="https://oj.leetcode.com/problems/" target="_blank">leetcode</a>
			
          </li>
        
          <li>
			 
            <a href="http://tutorials.jenkov.com" target="_blank">jenkov</a>
			
          </li>
        
          <li>
			 
            <a href="https://howtodoinjava.com" target="_blank">HowToDoInJava</a>
			
          </li>
        
          <li>
			 
            <a href="https://java-design-patterns.com/patterns/" target="_blank">java design patterns</a>
			
          </li>
        
          <li>
			 
			&nbsp;
			
          </li>
        
          <li>
			 
            <a href="https://medium.com/netflix-techblog" target="_blank">Netflix技术博客</a>
			
          </li>
        
          <li>
			 
            <a href="https://www.techiedelight.com" target="_blank">Techie Delight</a>
			
          </li>
        
          <li>
			 
            <a href="https://engineering.linkedin.com/blog" target="_blank">Linkedin技术博客</a>
			
          </li>
        
          <li>
			 
            <a href="https://blogs.dropbox.com/tech/" target="_blank">Dropbox技术博客</a>
			
          </li>
        
          <li>
			 
            <a href="https://code.fb.com" target="_blank">Facebook技术博客</a>
			
          </li>
        
          <li>
			 
            <a href="http://jm.taobao.org" target="_blank">淘宝中间件团队</a>
			
          </li>
        
          <li>
			 
            <a href="https://tech.meituan.com" target="_blank">美团技术博客</a>
			
          </li>
        
          <li>
			 
            <a href="http://blogs.360.cn" target="_blank">360技术博客</a>
			
          </li>
        
          <li>
			 
            <a href="https://xiaomi-info.github.io" target="_blank">小米信息部技术团队</a>
			
          </li>
        
      </ul>
    </div>
  </div>

  
      

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2024 smallnest<br>
	  Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    
      <a href="/" class="mobile-nav-link"><i class="fa fa-home">&nbsp;</i>首页</a>
    
  
    
      <a href="/archives" class="mobile-nav-link"><i class="fa fa-folder-o">&nbsp;</i>归档</a>
    
  
    
      <a href="https://github.com/smallnest" class="mobile-nav-link"><i class="fa fa-github">&nbsp;</i>github</a>
    
  
    
      <a class="mobile-nav-link" href="#"><i class="fa fa-bars">&nbsp;</i>网站群</a>
    
      
            <a class="mobile-nav-link" href="/goasm">&nbsp;&nbsp;<i class="fa fa-language">&nbsp;</i>Go汇编示例</a>
          
          
    
      
            <a class="mobile-nav-link" href="https://gowebexamples.com">&nbsp;&nbsp;<i class="fa fa-external-link">&nbsp;</i>Go Web开发示例</a>
          
          
    
      
            <a class="mobile-nav-link" href="http://go-database-sql.org">&nbsp;&nbsp;<i class="fa fa-external-link">&nbsp;</i>Go 数据库开发教程</a>
          
          
    
      
            <a class="mobile-nav-link" href="https://colobu.com/gotips/">&nbsp;&nbsp;<i class="fa fa-external-link">&nbsp;</i>Go 语言编程技巧</a>
          
          
    
      
            
          
          
    
      
            <a class="mobile-nav-link" href="/perf-book">&nbsp;&nbsp;<i class="fa fa-rust">&nbsp;</i>Rust高性能编程指南</a>
          
          
    
      
            <a class="mobile-nav-link" href="/rust100">&nbsp;&nbsp;<i class="fa fa-rust">&nbsp;</i>100个练习题学习Rust</a>
          
          
    
      
            
          
          
    
      
            <a class="mobile-nav-link" href="http://rpcx.io">&nbsp;&nbsp;<i class="fa undefined">&nbsp;</i>RPCX官网</a>
          
          
    
      
            <a class="mobile-nav-link" href="http://cn.doc.rpcx.io">&nbsp;&nbsp;<i class="fa undefined">&nbsp;</i>RPC开发指南</a>
          
          
    
    
  
    
      <a href="/ScalaCollectionsCookbook" class="mobile-nav-link"><i class="fa fa-book">&nbsp;</i>Scala集合技术手册</a>
    
  
    
      <a href="/about" class="mobile-nav-link"><i class="fa fa-lemon-o">&nbsp;</i>关于</a>
    
  
</nav>
    
<script src="//cdn.staticfile.org/jquery/1.11.1/jquery.min.js"></script>
<script src="//cdn.bootcss.com/jquery.lazyload/1.9.1/jquery.lazyload.min.js"></script>

<script src="//cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js"></script>


<script src="/js/script.js" type="text/javascript"></script>

<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
  });
  MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>
<script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.6.0-beta.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

<div id="totop" style="position:fixed;bottom:150px;right:10px;cursor: pointer;z-index: 2000;">
	<a title="返回顶部"><img src="/images/scrollup.png"/></a>
</div>
<script src="/js/totop.js" type="text/javascript"></script>




<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e085d87993250aab11f3e0c15f1c2785";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


  </div>
</body>
</html>