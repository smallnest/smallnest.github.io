<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title><![CDATA[é¸Ÿçª]]></title>
  <subtitle><![CDATA[å¤§é“è‡³ç®€ Simplicity is the ultimate form of sophistication]]></subtitle>
  <link href="/atom.xml" rel="self"/>
  <link href="https://colobu.com/"/>
  <updated>2022-06-03T09:36:14.853Z</updated>
  <id>https://colobu.com/</id>
  
  <author>
    <name><![CDATA[smallnest]]></name>
    
  </author>
  
  <generator uri="http://zespia.tw/hexo/">Hexo</generator>
  
  <entry>
    <title><![CDATA[æƒ³å­¦ä¹ k8sä½†æ²¡æœ‰ç¯å¢ƒï¼Ÿä½¿ç”¨minikubeè½»æ¾æ­å»ºä¸€ä¸ª]]></title>
    <link href="https://colobu.com/2022/06/02/setup-a-k8s-cluster-with-minikube/"/>
    <id>https://colobu.com/2022/06/02/setup-a-k8s-cluster-with-minikube/</id>
    <published>2022-06-02T07:37:14.000Z</published>
    <updated>2022-06-03T09:35:15.901Z</updated>
    <content type="html"><![CDATA[<p><a href="https://kubernetes.io/" target="_blank" rel="external">Kubernetes</a>ï¼ˆå¸¸ç®€ç§°ä¸ºK8sï¼‰æ˜¯ç”¨äºè‡ªåŠ¨éƒ¨ç½²ã€æ‰©å±•å’Œç®¡ç†â€œå®¹å™¨åŒ–ï¼ˆcontainerizedï¼‰åº”ç”¨ç¨‹åºâ€çš„å¼€æºç³»ç»Ÿã€‚è¯¥ç³»ç»Ÿç”±Googleè®¾è®¡å¹¶æèµ ç»™Cloud Native Computing Foundationï¼ˆä»Šå±LinuxåŸºé‡‘ä¼šï¼‰æ¥ä½¿ç”¨ã€‚</p>
<p>å®ƒæ—¨åœ¨æä¾›â€œè·¨ä¸»æœºé›†ç¾¤çš„è‡ªåŠ¨éƒ¨ç½²ã€æ‰©å±•ä»¥åŠè¿è¡Œåº”ç”¨ç¨‹åºå®¹å™¨çš„å¹³å°â€ã€‚ å®ƒæ”¯æŒä¸€ç³»åˆ—å®¹å™¨å·¥å…·ï¼ŒåŒ…æ‹¬Dockerç­‰ã€‚</p>
<p>Kubernetesï¼ˆåœ¨å¸Œè…Šè¯­æ„ä¸ºâ€œèˆµæ‰‹â€æˆ–â€œé©¾é©¶å‘˜â€ï¼‰ç”±Joe Bedaã€Brendan Burnså’ŒCraig McLuckieåˆ›ç«‹ï¼Œå¹¶ç”±å…¶ä»–è°·æ­Œå·¥ç¨‹å¸ˆï¼ŒåŒ…æ‹¬Brian Grantå’ŒTim Hockinç­‰è¿›è¡ŒåŠ ç›Ÿåˆ›ä½œï¼Œå¹¶ç”±è°·æ­Œåœ¨2014å¹´é¦–æ¬¡å¯¹å¤–å®£å¸ƒ ã€‚ è¯¥ç³»ç»Ÿçš„å¼€å‘å’Œè®¾è®¡éƒ½æ·±å—è°·æ­Œçš„Borgç³»ç»Ÿçš„å½±å“ï¼Œå…¶è®¸å¤šé¡¶çº§è´¡çŒ®è€…ä¹‹å‰ä¹Ÿæ˜¯Borgç³»ç»Ÿçš„å¼€å‘è€…ã€‚åœ¨è°·æ­Œå†…éƒ¨ï¼ŒKubernetesçš„åŸå§‹ä»£å·æ›¾ç»æ˜¯Sevenï¼Œå³æ˜Ÿé™…è¿·èˆªä¸­çš„Borgï¼ˆåšæ ¼äººï¼‰ã€‚Kubernetesæ ‡è¯†ä¸­èˆµè½®æœ‰ä¸ƒä¸ªè½®è¾å°±æ˜¯å¯¹è¯¥é¡¹ç›®ä»£å·çš„è‡´æ„ã€‚</p>
<p>Kuberbetesä¸€ç›´æ˜¯ITè¡Œä¸šç‚½æ‰‹å¯çƒ­çš„æŠ€æœ¯ï¼Œå¾ˆå¤šåŒå­¦éƒ½æƒ³å­¦ä¹ å®ƒï¼Œä½†æ˜¯åˆšæƒ³ä¸Šæ‰‹é‡åˆ°äº†ä¸€ä¸ªéº»çƒ¦ï¼Œéœ€è¦æ­å»ºä¸€ä¸ªk8sçš„é›†ç¾¤ã€‚è™½ç„¶äº‘æœåŠ¡æä¾›å•†æ¯”å¦‚é˜¿é‡Œäº‘ã€ç™¾åº¦äº‘éƒ½æä¾›äº†k8sé›†ç¾¤çš„æœåŠ¡ï¼Œä½†æ˜¯è¿˜éœ€è¦èŠ±ä¸€ç¬”é’±å»è´­ä¹°æœåŠ¡å’ŒèŠ‚ç‚¹ã€‚å¦‚ä½•åœ¨è‡ªå·±çš„æœºå™¨ä¸Šæ­å»ºä¸€ä¸ªk8sé›†ç¾¤å­¦ä¹ å‘¢ï¼Ÿæœ¬æ–‡ç»™ä½ ä»‹ç»ä¸€ç§ä½¿ç”¨minikubeæ­å»ºä¸€ä¸ªk8sæµ‹è¯•é›†ç¾¤çš„æ–¹æ³•ã€‚</p>
<a id="more"></a>
<h2 id="å®‰è£…">å®‰è£…</h2>
<p><a href="https://minikube.sigs.k8s.io/docs/start/" target="_blank" rel="external">minikube</a> ä¸»è¦åŸºäºè¿è¡Œä¸€ä¸ªå•èŠ‚ç‚¹ Kubernetes é›†ç¾¤ï¼Œä»¥ä¾¿æ”¯æŒåœ¨æœ¬åœ°æœºå™¨ä¸Šçš„ VM å†…è¿›è¡Œå¼€å‘ã€‚å®ƒæ”¯æŒè™šæ‹Ÿæœºé©±åŠ¨ç¨‹åºï¼Œå¦‚ VirtualBoxã€HyperVã€KVM2ã€‚ç”±äº Minikube æ˜¯ Kubernetes ä½“ç³»ä¸­ç›¸å¯¹æˆç†Ÿçš„è§£å†³æ–¹æ¡ˆï¼Œæ”¯æŒçš„åŠŸèƒ½åˆ—è¡¨éå¸¸ä»¤äººå°è±¡æ·±åˆ»ã€‚è¿™äº›åŠŸèƒ½æ˜¯è´Ÿè½½å‡è¡¡å™¨ã€å¤šé›†ç¾¤ã€èŠ‚ç‚¹ç«¯å£ã€æŒä¹…å·ã€å…¥å£ã€ä»ªè¡¨æ¿æˆ–å®¹å™¨è¿è¡Œæ—¶ã€‚</p>
<p>åŸºäº Minikube å¼€æºå·¥å…·ï¼Œä½¿å¾—å¼€å‘ã€è¿ç»´äººå‘˜åŠ DevOps å·¥ç¨‹å¸ˆèƒ½å¤Ÿå¿«é€Ÿåœ¨æœ¬åœ°æ­å»º Kubernetes å•èŠ‚ç‚¹é›†ç¾¤ç¯å¢ƒï¼Œæ¯•ç«Ÿï¼ŒMinikube å¯¹è½¯ç¡¬ä»¶èµ„æºæ²¡æœ‰å¤ªé«˜çš„è¦æ±‚ï¼Œæ–¹ä¾¿æŠ€æœ¯äººå‘˜å­¦ä¹ ä¸å®è·µï¼Œä»¥åŠè¿›è¡Œæ—¥å¸¸çš„é¡¹ç›®å¼€å‘ã€‚</p>
<p>è¿è¡Œminikube,ä½ è‡³å°‘éœ€è¦:</p>
<ul>
<li>2 CPUæˆ–è€…æ›´å¤š</li>
<li>2GB å†…å­˜</li>
<li>20GB ç£ç›˜ç©ºé—´</li>
<li>äº’è”ç½‘</li>
<li>å®¹å™¨æˆ–è€…è™šæœºç®¡ç†å™¨å¦‚: Docker, Hyperkit, Hyper-V, KVM, Parallels, Podman, VirtualBox, or VMware Fusion/Workstation</li>
</ul>
<p>æˆ‘ä½¿ç”¨çš„MacBook Pro M1çš„è‹¹æœæœ¬ï¼Œå¹¶ä¸”æœºå™¨ä¸Šå·²ç»å®‰è£…Docker,æ‰€ä»¥è¿™äº›éœ€æ±‚éƒ½æ»¡è¶³ã€‚å¦‚æœä½ æ˜¯Linuxæˆ–è€…Windowsï¼Œä¹Ÿå¯ä»¥å®‰è£…ï¼Œåªä¸è¿‡ä½ éœ€è¦ä¸‹è½½ç›¸åº”çš„å®‰è£…ç¨‹åºã€‚<br>æœ¬æ–‡ä»¥æˆ‘çš„ç¯å¢ƒä¸ºä¾‹è¿›è¡Œä»‹ç»ã€‚</p>
<p>å¯¹äºMacOS,ä½ å¯ä»¥æœ‰ä¸¤ç§æ–¹å¼è¿›è¡Œå®‰è£…ã€‚<br>ä¸€ç§æ˜¯æ‰‹å·¥å®‰è£…æ–¹å¼ï¼š</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-darwin-amd64</div><div class="line">sudo <span class="operator"><span class="keyword">install</span> minikube-darwin-amd64 /usr/<span class="keyword">local</span>/<span class="keyword">bin</span>/minikube</span></div></pre></td></tr></table></figure>

<p>å¦‚æœä½ å› ä¸ºä¸€äº›åŸå› æ²¡æœ‰åŠæ³•ä¸‹è½½è¿™ä¸ªæ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥åˆ°githubç½‘ç«™ä¸Šä¸‹è½½<a href="https://github.com/kubernetes/minikube/releases/tag/v1.25.2" target="_blank" rel="external">äºŒè¿›åˆ¶æ–‡ä»¶</a>ï¼Œæ”¾åˆ°/usr/local/bin/minikubeä¸­ã€‚</p>
<p>ç¬¬äºŒç§æ–¹å¼å°±æ˜¯ä½¿ç”¨brewå‘½ä»¤å®‰è£…:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">brew <span class="operator"><span class="keyword">install</span> minikube</span></div><div class="line"></div><div class="line">// æŸ¥çœ‹minikubeå®‰è£…åœ¨å“ªé‡Œ</div><div class="line">âœ  ~ which minikube</div><div class="line">/usr/<span class="keyword">local</span>/<span class="keyword">bin</span>/minikube</div></pre></td></tr></table></figure>

<h2 id="å¯åŠ¨">å¯åŠ¨</h2>
<p>æ¥ä¸‹æ¥å°±æ˜¯å¯åŠ¨minikubeã€‚</p>
<p>æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤å°±å¯ä»¥å¯åŠ¨:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">minikube start</div></pre></td></tr></table></figure>

<p>ç¬¬ä¸€æ¬¡å¯åŠ¨éœ€è¦ä¸‹è½½k8sä¾èµ–çš„å„ç§é•œåƒï¼Œå¯èƒ½å› ä¸ºå¢™çš„åŸå› ï¼Œä¸€äº›é•œåƒä¼šæ‹‰ä¸ä¸‹æ¥å®‰è£…å¤±è´¥ã€‚</p>
<p>æˆ‘é‡‡ç”¨çš„æ–¹æ³•æ˜¯ä»é˜¿é‡Œäº‘æ‹‰å–é•œåƒï¼Œå†é‡æ–°æ‰“tagåˆ°å¯¹åº”çš„k8sä¾èµ–çš„é•œåƒï¼Œæ¯”å¦‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">docker pull <span class="filename">registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy</span>:<span class="filename">v1.22.3</span></div><div class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:<span class="filename">v1.22.3 k8s.gcr.io/kube-proxy</span>:<span class="filename">v1.22.3</span></div><div class="line"></div><div class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:<span class="filename">v1.8.4</span></div><div class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:<span class="filename">v1.8.4 k8s.gcr.io/coredns/coredns</span>:<span class="filename">v1.8.4</span></div><div class="line"></div><div class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:<span class="filename">v1.22.3</span></div><div class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:<span class="filename">v1.22.3 k8s.gcr.io/kube-scheduler</span>:<span class="filename">v1.22.3</span></div><div class="line"></div><div class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/storage-provisioner:v5</div><div class="line">docker tag <span class="filename">registry.cn-hangzhou.aliyuncs.com/google_containers/storage-provisioner</span>:v5 <span class="filename">gcr.io/k8s-minikube/storage-provisioner</span>:v5</div><div class="line"></div><div class="line">docker pull <span class="filename">registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver</span>:<span class="filename">v1.22.3</span></div><div class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:<span class="filename">v1.22.3 k8s.gcr.io/kube-apiserver</span>:<span class="filename">v1.22.3</span></div><div class="line"></div><div class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:<span class="number">3.5</span><span class="number">.0</span>-<span class="number">0</span></div><div class="line">docker tag <span class="filename">registry.cn-hangzhou.aliyuncs.com/google_containers/etcd</span>:<span class="number">3.5</span><span class="number">.0</span>-<span class="number">0</span>  <span class="filename">k8s.gcr.io/etcd</span>:<span class="number">3.5</span><span class="number">.0</span>-<span class="number">0</span></div><div class="line"></div><div class="line">docker pull <span class="filename">registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager</span>:<span class="filename">v1.22.3</span></div><div class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:<span class="filename">v1.22.3 k8s.gcr.io/kube-controller-manager</span>:<span class="filename">v1.22.3</span></div><div class="line"></div><div class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:<span class="number">3.5</span></div><div class="line">docker tag <span class="filename">registry.cn-hangzhou.aliyuncs.com/google_containers/pause</span>:<span class="number">3.5</span>  <span class="filename">k8s.gcr.io/pause</span>:<span class="number">3.5</span></div></pre></td></tr></table></figure>

<p>æ‰‹å·¥æŠŠè¿™äº›é•œåƒæ‹‰åˆ°æœ¬åœ°åï¼Œå†æ‰§è¡Œ<code>minikube start</code>å°±é¡ºåˆ©å¯åŠ¨æˆåŠŸäº†ã€‚</p>
<p>æˆ‘è¿˜åœ¨ç½‘ä¸Šçœ‹åˆ°å¦å¤–ä¸€ç§å¯åŠ¨æ–¹å¼:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">minikube <span class="operator"><span class="keyword">start</span> <span class="comment">--image-mirror-country='cn'</span></span></div></pre></td></tr></table></figure>

<p>æˆ‘è§‰å¾—è¿™æ˜¯ä¸€ç§æ›´ç®€æ·çš„æ–¹å¼ï¼Œä¸è¿‡æˆ‘å·²ç»å®‰è£…å¥½äº†ï¼Œæ‰€ä»¥è¿™ç§æ–¹å¼æˆ‘æ²¡æœ‰è¯•è¿‡ï¼Œä½ å¯ä»¥è¯•è¯•ã€‚</p>
<p>minikubeå‘½ä»¤æä¾›äº†éå¸¸å¤šçš„é…ç½®å‚æ•°ï¼Œæ¯”å¦‚ï¼š</p>
<p>--driver=<strong><em> ä»1.5.0ç‰ˆæœ¬å¼€å§‹ï¼ŒMinikubeç¼ºçœä½¿ç”¨ç³»ç»Ÿä¼˜é€‰çš„é©±åŠ¨æ¥åˆ›å»ºKubernetesæœ¬åœ°ç¯å¢ƒï¼Œæ¯”å¦‚æ‚¨å·²ç»å®‰è£…è¿‡Dockerç¯å¢ƒï¼Œminikube å°†ä½¿ç”¨ docker é©±åŠ¨<br>--cpus=2: ä¸ºminikubeè™šæ‹Ÿæœºåˆ†é…CPUæ ¸æ•°<br>--memory=4096mb: ä¸ºminikubeè™šæ‹Ÿæœºåˆ†é…å†…å­˜æ•°<br>--registry-mirror=</em></strong> ä¸º Docker daemon é…ç½®é•œåƒåŠ é€Ÿï¼Œæ¯”å¦‚<a href="https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors" target="_blank" rel="external">é˜¿é‡Œäº‘é•œåƒæœåŠ¡</a><br>--kubernetes-version=***: minikube è™šæ‹Ÿæœºå°†ä½¿ç”¨çš„ kubernetes ç‰ˆæœ¬</p>
<p>ç°åœ¨ï¼Œä½ å°±å¯ä»¥æ‰“å¼€Kubernetesæ§åˆ¶å°äº†: <code>minikube dashboard</code></p>
<p><img src="dashboard.png" alt=""></p>
<p>ç°åœ¨ï¼Œä¸€ä¸ªæœ¬åœ°æµ‹è¯•ç”¨çš„k8sé›†ç¾¤å°±æ­å»ºå¥½äº†ã€‚</p>
<p>å¦‚æœä½ æš‚æ—¶ä¸ç”¨ï¼Œå¯ä»¥è°ƒç”¨<code>minikube stop</code>æš‚åœï¼Œç­‰éœ€è¦çš„æ—¶å€™å†å¯åŠ¨ã€‚</p>
<h2 id="æ’ä»¶">æ’ä»¶</h2>
<p>ä½ ç°åœ¨å¯ä»¥ç›´æ¥ä½¿ç”¨<code>kubectl</code>å‘½ä»¤å¿«é€Ÿåˆ›å»ºã€æ›´æ–°å’Œåˆ é™¤Kubernetes å¯¹è±¡ã€‚ä½ å¯ä»¥è‡ªç”±è‡ªåœ¨çš„åœ¨è‡ªå·±çš„é›†ç¾¤ä¸­å­¦ä¹ ã€æµ‹è¯•k8sçš„æŠ€æœ¯äº†ã€‚</p>
<p>minikubeä¹Ÿæä¾›äº†å¾ˆå¤šæ’ä»¶,æ¯”å¦‚istioã€ingressã€helm-tillerç­‰ç­‰ã€‚éšç€ä½ å¯¹k8sçš„æŒæ¡ç¨‹åº¦ï¼Œå¯ä»¥é€æ­¥çš„å®‰è£…æµ‹è¯•è¿™äº›æ‰©å±•çš„åŠŸèƒ½ã€‚<br>æ’ä»¶åˆ—è¡¨å¦‚ä¸‹:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">âœ  ~ minikube addons list</div><div class="line"><span class="string">|-----------------------------|----------|--------------|-----------------------|</span></div><div class="line"><span class="string">|         ADDON NAME          | PROFILE  |    STATUS    |      MAINTAINER       |</span></div><div class="line"><span class="string">|-----------------------------|----------|--------------|-----------------------|</span></div><div class="line"><span class="string">| ambassador                  | minikube | disabled     | unknown (third-party) |</span></div><div class="line"><span class="string">| auto-pause                  | minikube | disabled     | google                |</span></div><div class="line"><span class="string">| csi-hostpath-driver         | minikube | disabled     | kubernetes            |</span></div><div class="line"><span class="string">| dashboard                   | minikube | enabled âœ…   | kubernetes            |</span></div><div class="line"><span class="string">| default-storageclass        | minikube | enabled âœ…   | kubernetes            |</span></div><div class="line"><span class="string">| efk                         | minikube | disabled     | unknown (third-party) |</span></div><div class="line"><span class="string">| freshpod                    | minikube | disabled     | google                |</span></div><div class="line"><span class="string">| gcp-auth                    | minikube | disabled     | google                |</span></div><div class="line"><span class="string">| gvisor                      | minikube | disabled     | google                |</span></div><div class="line"><span class="string">| helm-tiller                 | minikube | disabled     | unknown (third-party) |</span></div><div class="line"><span class="string">| ingress                     | minikube | disabled     | unknown (third-party) |</span></div><div class="line"><span class="string">| ingress-dns                 | minikube | disabled     | unknown (third-party) |</span></div><div class="line"><span class="string">| istio                       | minikube | disabled     | unknown (third-party) |</span></div><div class="line"><span class="string">| istio-provisioner           | minikube | disabled     | unknown (third-party) |</span></div><div class="line"><span class="string">| kubevirt                    | minikube | disabled     | unknown (third-party) |</span></div><div class="line"><span class="string">| logviewer                   | minikube | disabled     | google                |</span></div><div class="line"><span class="string">| metallb                     | minikube | disabled     | unknown (third-party) |</span></div><div class="line"><span class="string">| metrics-server              | minikube | disabled     | kubernetes            |</span></div><div class="line"><span class="string">| nvidia-driver-installer     | minikube | disabled     | google                |</span></div><div class="line"><span class="string">| nvidia-gpu-device-plugin    | minikube | disabled     | unknown (third-party) |</span></div><div class="line"><span class="string">| olm                         | minikube | disabled     | unknown (third-party) |</span></div><div class="line"><span class="string">| pod-security-policy         | minikube | disabled     | unknown (third-party) |</span></div><div class="line"><span class="string">| portainer                   | minikube | disabled     | portainer.io          |</span></div><div class="line"><span class="string">| registry                    | minikube | disabled     | google                |</span></div><div class="line"><span class="string">| registry-aliases            | minikube | disabled     | unknown (third-party) |</span></div><div class="line"><span class="string">| registry-creds              | minikube | disabled     | unknown (third-party) |</span></div><div class="line"><span class="string">| storage-provisioner         | minikube | enabled âœ…   | kubernetes            |</span></div><div class="line"><span class="string">| storage-provisioner-gluster | minikube | disabled     | unknown (third-party) |</span></div><div class="line"><span class="string">| volumesnapshots             | minikube | disabled     | kubernetes            |</span></div><div class="line"><span class="string">|-----------------------------|----------|--------------|-----------------------|</span></div></pre></td></tr></table></figure>

<p>å¯ç”¨æŸä¸ªæ’ä»¶å¯ä»¥ç”¨ä¸‹é¢çš„å‘½ä»¤:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">âœ  ~ minikube addons enable ingress</div><div class="line">ğŸ’¡  After the addon <span class="keyword">is</span> enabled, please run <span class="string">"minikube tunnel"</span> <span class="keyword">and</span> your ingress resources would be available at <span class="string">"127.0.0.1"</span></div><div class="line">    â–ª <span class="keyword">Using</span> image k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1<span class="number">.1</span><span class="number">.1</span></div><div class="line">    â–ª <span class="keyword">Using</span> image k8s.gcr.io/ingress-nginx/controller:v1<span class="number">.0</span><span class="number">.4</span></div><div class="line">    â–ª <span class="keyword">Using</span> image k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1<span class="number">.1</span><span class="number">.1</span></div><div class="line">ğŸ”  Verifying ingress addon...</div></pre></td></tr></table></figure>

<h2 id="k8sé›†ç¾¤åˆæ­¥">k8sé›†ç¾¤åˆæ­¥</h2>
<p>æ—¢ç„¶æˆ‘ä»¬æ­å»ºå¥½äº†ä¸€ä¸ªk8sé›†ç¾¤,æˆ‘ä»¬ä¸å¦¨ä½¿ç”¨å®ƒéƒ¨ç½²ä¸€ä¸‹åº”ç”¨å’ŒæœåŠ¡ã€‚</p>
<p>æˆ‘ä»¬ä»¥rpcxå¾®æœåŠ¡æ¡†æ¶çš„ä¸€ä¸ªhello worldç¨‹åºä¸ºä¾‹ã€‚</p>
<h3 id="éƒ¨ç½²ä¸€ä¸ªrpcxæœåŠ¡ç«¯çš„åº”ç”¨">éƒ¨ç½²ä¸€ä¸ªrpcxæœåŠ¡ç«¯çš„åº”ç”¨</h3>
<p>rpcxæœåŠ¡ç«¯çš„ç¨‹åºå¾ˆç®€å•:</p>
<figure class="highlight go"><figcaption><span>server.go</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"context"</span></div><div class="line">	<span class="string">"flag"</span></div><div class="line">	<span class="string">"fmt"</span></div><div class="line"></div><div class="line">	example <span class="string">"github.com/rpcxio/rpcx-examples"</span></div><div class="line">	<span class="string">"github.com/smallnest/rpcx/server"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">var</span> addr = flag.String(<span class="string">"addr"</span>, <span class="string">":8972"</span>, <span class="string">"server address"</span>)</div><div class="line"></div><div class="line"><span class="keyword">type</span> Arith <span class="keyword">struct</span>{}</div><div class="line"></div><div class="line"><span class="comment">// the second parameter is not a pointer</span></div><div class="line"><span class="keyword">func</span> (t *Arith) Mul(ctx context.Context, args example.Args, reply *example.Reply) error {</div><div class="line">	reply.C = args.A * args.B</div><div class="line">	fmt.Println(<span class="string">"C="</span>, reply.C)</div><div class="line">	<span class="keyword">return</span> <span class="constant">nil</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">func</span> main() {</div><div class="line">	flag.Parse()</div><div class="line"></div><div class="line">	s := server.NewServer()</div><div class="line">	<span class="comment">// s.Register(new(Arith), "")</span></div><div class="line">	s.RegisterName(<span class="string">"Arith"</span>, <span class="built_in">new</span>(Arith), <span class="string">""</span>)</div><div class="line">	err := s.Serve(<span class="string">"tcp"</span>, *addr)</div><div class="line">	<span class="keyword">if</span> err != <span class="constant">nil</span> {</div><div class="line">		<span class="built_in">panic</span>(err)</div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure>

<p>å†™ä¸€ä¸ªDockeræ–‡ä»¶ï¼Œç¼–è¯‘å¹¶ç”Ÿæˆé•œåƒ:</p>
<figure class="highlight Dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">FROM golan<span class="variable">g:1</span>.<span class="number">18</span>-alpine <span class="keyword">as</span> builder</div><div class="line">WORKDIR /usr/src/app</div><div class="line">ENV GOPROXY=http<span class="variable">s:</span>//goproxy.<span class="keyword">cn</span></div><div class="line">RUN sed -<span class="keyword">i</span> <span class="string">'s/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g'</span> /etc/apk/repositories && \</div><div class="line">  apk <span class="built_in">add</span> --<span class="keyword">no</span>-cache <span class="keyword">ca</span>-certificates tzdata</div><div class="line">COPY ./<span class="keyword">go</span>.<span class="keyword">mod</span> ./</div><div class="line">COPY ./<span class="keyword">go</span>.sum ./</div><div class="line">RUN <span class="keyword">go</span> <span class="keyword">mod</span> download</div><div class="line">COPY . .</div><div class="line">RUN CGO_ENABLED=<span class="number">0</span> <span class="keyword">go</span> build -ldflags <span class="string">"-s -w"</span> -<span class="keyword">o</span> rpcx_server </div><div class="line"></div><div class="line">FROM scratch <span class="keyword">as</span> runner</div><div class="line">COPY --from=builder /usr/share/zoneinfo/Asia/Shanghai /etc/<span class="built_in">localtime</span></div><div class="line">COPY --from=builder /etc/ssl/certs/<span class="keyword">ca</span>-certificates.crt /etc/ssl/certs/</div><div class="line">COPY --from=builder /usr/src/app/rpcx_server /<span class="keyword">opt</span>/app/</div><div class="line"></div><div class="line">EXPOSE <span class="number">8972</span></div><div class="line"></div><div class="line">CMD [<span class="string">"/opt/app/rpcx_server"</span>]</div></pre></td></tr></table></figure>

<p>ç”Ÿæˆé•œåƒï¼ˆæˆ‘è¿˜æŠŠå®ƒæ¨åˆ°äº†dockerå¹³å°ï¼‰:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">docker build . -t smallnest/rpcx-server-demo:<span class="number">0.1</span>.<span class="number">0</span></div><div class="line">docker push smallnest/rpcx-server-demo:<span class="number">0.1</span>.<span class="number">0</span></div></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥å°±æ˜¯å†™éƒ¨ç½²æ–‡ä»¶äº†,ä½¿ç”¨æˆ‘ä»¬çš„é•œåƒï¼Œå‰¯æœ¬æ•°ä¸º3:</p>
<figure class="highlight yaml"><figcaption><span>rpcx-server-demo.yaml</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">apiVersion: apps/v1</div><div class="line">kind: <span class="type">Deployment</span></div><div class="line">metadata:</div><div class="line">  name: rpcx-server-demo-deployment</div><div class="line">spec:</div><div class="line">  selector:</div><div class="line">    matchLabels:</div><div class="line">      app: rpcx-server-demo</div><div class="line">  replicas: <span class="number">3</span></div><div class="line">  <span class="keyword">template</span>:</div><div class="line">    metadata:</div><div class="line">      labels:</div><div class="line">        app: rpcx-server-demo</div><div class="line">    spec:</div><div class="line">      containers:</div><div class="line">      - name: rpcx-server-demo</div><div class="line">        image: smallnest/rpcx-server-demo:<span class="number">0</span>.<span class="number">1</span>.<span class="number">0</span></div><div class="line">        ports:</div><div class="line">        - containerPort: <span class="number">8972</span></div></pre></td></tr></table></figure>

<p>æ¥ä¸‹äº†å†å®šä¹‰æœåŠ¡,æŠŠæˆ‘ä»¬çš„è¿™ä¸ªå¾®æœåŠ¡æš´éœ²æˆk8sçš„ä¸€ä¸ªæœåŠ¡:</p>
<figure class="highlight yaml"><figcaption><span>rpcx-server-demo-service.yaml</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">apiVersion: v1</div><div class="line">kind: Service</div><div class="line">metadata:</div><div class="line">  name: rpcx-<span class="keyword">server</span>-demo-service	<span class="preprocessor">#Service çš„åç§°</span></div><div class="line">  labels:     	<span class="preprocessor">#Service è‡ªå·±çš„æ ‡ç­¾</span></div><div class="line">    app: rpcx-<span class="keyword">server</span>-demo	<span class="preprocessor">#ä¸ºè¯¥ Service è®¾ç½® key ä¸º appï¼Œvalue ä¸º rpcx-server-demo çš„æ ‡ç­¾</span></div><div class="line">spec:	    <span class="preprocessor">#è¿™æ˜¯å…³äºè¯¥ Service çš„å®šä¹‰ï¼Œæè¿°äº† Service å¦‚ä½•é€‰æ‹© Podï¼Œå¦‚ä½•è¢«è®¿é—®</span></div><div class="line">  selector:	    <span class="preprocessor">#æ ‡ç­¾é€‰æ‹©å™¨</span></div><div class="line">    app: rpcx-<span class="keyword">server</span>-demo	<span class="preprocessor">#é€‰æ‹©åŒ…å«æ ‡ç­¾ app:rpcx-server-demo çš„ Pod</span></div><div class="line">  ports:</div><div class="line">  - name: rpcx-<span class="keyword">server</span>-demo-port	<span class="preprocessor">#ç«¯å£çš„åå­—</span></div><div class="line">    protocol: TCP	    <span class="preprocessor">#åè®®ç±»å‹ TCP/UDP</span></div><div class="line">    port: <span class="number">9981</span>	        <span class="preprocessor">#é›†ç¾¤å†…çš„å…¶ä»–å®¹å™¨ç»„å¯é€šè¿‡ 9981 ç«¯å£è®¿é—® Service</span></div><div class="line">    targetPort: <span class="number">8972</span>	<span class="preprocessor">#å°†è¯·æ±‚è½¬å‘åˆ°åŒ¹é… Pod çš„ 8972 ç«¯å£</span></div></pre></td></tr></table></figure>

<p>æœ€åæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤å‘å¸ƒåº”ç”¨å’ŒæœåŠ¡:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">kubectl apply <span class="operator">-f</span> rpcx-server-demo.yaml</div><div class="line">kubectl apply <span class="operator">-f</span> rpcx-server-demo-service.yaml</div></pre></td></tr></table></figure>

<p>å¯ä»¥æŸ¥çœ‹å‘å¸ƒçš„åº”ç”¨å’ŒæœåŠ¡:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">âœ  ~ kubectl get pods</div><div class="line">NAME                                           READY   STATUS    RESTARTS       AGE</div><div class="line">rpcx-server-demo-deployment-<span class="number">7</span>f9d85c5dc-<span class="number">42</span>wbm   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">1</span> (<span class="number">102</span>d ago)   <span class="number">103</span>d</div><div class="line">rpcx-server-demo-deployment-<span class="number">7</span>f9d85c5dc-<span class="number">499</span>gm   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">1</span> (<span class="number">102</span>d ago)   <span class="number">103</span>d</div><div class="line">rpcx-server-demo-deployment-<span class="number">7</span>f9d85c5dc<span class="operator">-s</span>6gh9   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">1</span> (<span class="number">25</span>h ago)    <span class="number">103</span>d</div></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">âœ  ~ kubectl get svc</div><div class="line">NAME                       TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)    AGE</div><div class="line">kubernetes                 ClusterIP   <span class="number">10.96</span>.<span class="number">0.1</span>     &lt;none&gt;        <span class="number">443</span>/TCP    <span class="number">114</span>d</div><div class="line">rpcx-server-demo-service   ClusterIP   <span class="number">10.98</span>.<span class="number">134.3</span>   &lt;none&gt;        <span class="number">9981</span>/TCP   <span class="number">103</span>d</div></pre></td></tr></table></figure>

<h3 id="éƒ¨ç½²rpcxå®¢æˆ·ç«¯çš„åº”ç”¨">éƒ¨ç½²rpcxå®¢æˆ·ç«¯çš„åº”ç”¨</h3>
<p>ç±»ä¼¼çš„ï¼Œæˆ‘ä»¬ä¹Ÿéƒ¨ç½²rpcxå®¢æˆ·ç«¯çš„ç¨‹åºï¼Œå®ƒä¼šè°ƒç”¨æˆ‘ä»¬åˆšæ‰éƒ¨ç½²rpcxæœåŠ¡ã€‚</p>
<figure class="highlight go"><figcaption><span>client.go</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"context"</span></div><div class="line">	<span class="string">"flag"</span></div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"log"</span></div><div class="line">	<span class="string">"os"</span></div><div class="line">	<span class="string">"strings"</span></div><div class="line">	<span class="string">"time"</span></div><div class="line"></div><div class="line">	<span class="string">"github.com/smallnest/rpcx/protocol"</span></div><div class="line"></div><div class="line">	example <span class="string">"github.com/rpcxio/rpcx-examples"</span></div><div class="line">	<span class="string">"github.com/smallnest/rpcx/client"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">func</span> main() {</div><div class="line">	flag.Parse()</div><div class="line"></div><div class="line">	port := os.Getenv(<span class="string">"RPCX_SERVER_DEMO_SERVICE_PORT"</span>)</div><div class="line">	addr := strings.TrimPrefix(port, <span class="string">"tcp://"</span>)</div><div class="line"></div><div class="line">	fmt.Println(<span class="string">"dial "</span>, addr)</div><div class="line"></div><div class="line">	d, _ := client.NewPeer2PeerDiscovery(<span class="string">"tcp@"</span>+addr, <span class="string">""</span>)</div><div class="line">	opt := client.DefaultOption</div><div class="line">	opt.SerializeType = protocol.JSON</div><div class="line"></div><div class="line">	xclient := client.NewXClient(<span class="string">"Arith"</span>, client.Failtry, client.RandomSelect, d, opt)</div><div class="line">	<span class="keyword">defer</span> xclient.Close()</div><div class="line"></div><div class="line">	args := example.Args{</div><div class="line">		A:<span class="number"> 10</span>,</div><div class="line">		B:<span class="number"> 20</span>,</div><div class="line">	}</div><div class="line"></div><div class="line">	<span class="keyword">for</span> {</div><div class="line">		reply := &example.Reply{}</div><div class="line">		err := xclient.Call(context.Background(), <span class="string">"Mul"</span>, args, reply)</div><div class="line">		<span class="keyword">if</span> err != <span class="constant">nil</span> {</div><div class="line">			log.Fatalf(<span class="string">"failed to call: %v"</span>, err)</div><div class="line">		}</div><div class="line"></div><div class="line">		log.Printf(<span class="string">"%d * %d = %d"</span>, args.A, args.B, reply.C)</div><div class="line"></div><div class="line">		time.Sleep(time.Second)</div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure>

<p>ç¼–å†™ä¸€ä¸ªDockerfileæ–‡ä»¶ï¼Œä»¥ä¾¿ç”Ÿæˆé•œåƒ:</p>
<figure class="highlight Dockerfile"><figcaption><span>Dockerfile</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">FROM golan<span class="variable">g:1</span>.<span class="number">18</span>-alpine <span class="keyword">as</span> builder</div><div class="line">WORKDIR /usr/src/app</div><div class="line">ENV GOPROXY=http<span class="variable">s:</span>//goproxy.<span class="keyword">cn</span></div><div class="line">RUN sed -<span class="keyword">i</span> <span class="string">'s/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g'</span> /etc/apk/repositories && \</div><div class="line">  apk <span class="built_in">add</span> --<span class="keyword">no</span>-cache <span class="keyword">ca</span>-certificates tzdata</div><div class="line">COPY ./<span class="keyword">go</span>.<span class="keyword">mod</span> ./</div><div class="line">COPY ./<span class="keyword">go</span>.sum ./</div><div class="line">RUN <span class="keyword">go</span> <span class="keyword">mod</span> download</div><div class="line">COPY . .</div><div class="line">RUN CGO_ENABLED=<span class="number">0</span> <span class="keyword">go</span> build -ldflags <span class="string">"-s -w"</span> -<span class="keyword">o</span> rpcx_client </div><div class="line"></div><div class="line">FROM busybox <span class="keyword">as</span> runner</div><div class="line">COPY --from=builder /usr/share/zoneinfo/Asia/Shanghai /etc/<span class="built_in">localtime</span></div><div class="line">COPY --from=builder /etc/ssl/certs/<span class="keyword">ca</span>-certificates.crt /etc/ssl/certs/</div><div class="line">COPY --from=builder /usr/src/app/rpcx_client /<span class="keyword">opt</span>/app/</div><div class="line"></div><div class="line">CMD [<span class="string">"/opt/app/rpcx_client"</span>]</div></pre></td></tr></table></figure>

<p>ç¼–è¯‘ç”Ÿæˆé•œåƒï¼š</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">docker build . -t smallnest/rpcx-<span class="keyword">client</span>-demo:<span class="number">0.1</span><span class="number">.0</span></div><div class="line">docker push smallnest/rpcx-<span class="keyword">client</span>-demo:<span class="number">0.1</span><span class="number">.0</span></div></pre></td></tr></table></figure>

<p>ç¼–å†™yamlæ–‡ä»¶:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">apiVersion: apps/v1</div><div class="line">kind: <span class="type">Deployment</span></div><div class="line">metadata:</div><div class="line">  name: rpcx-client-demo-deployment</div><div class="line">spec:</div><div class="line">  selector:</div><div class="line">    matchLabels:</div><div class="line">      app: rpcx-client-demo</div><div class="line">  replicas: <span class="number">1</span></div><div class="line">  <span class="keyword">template</span>:</div><div class="line">    metadata:</div><div class="line">      labels:</div><div class="line">        app: rpcx-client-demo</div><div class="line">    spec:</div><div class="line">      containers:</div><div class="line">      - name: rpcx-client-demo</div><div class="line">        image: smallnest/rpcx-client-demo:<span class="number">0</span>.<span class="number">1</span>.<span class="number">0</span></div></pre></td></tr></table></figure>

<p>æœ€åå‘å¸ƒ:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kubectl apply <span class="operator">-f</span> rpcx-client-demo.yaml</div></pre></td></tr></table></figure>

<p>æ£€æŸ¥clientæ˜¯å¦å‘å¸ƒæˆåŠŸäº†:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">âœ  ~ kubectl get pods</div><div class="line">NAME                                           READY   STATUS    RESTARTS       AGE</div><div class="line">rpcx-client-demo-deployment-<span class="number">699</span>bfb8799-wdsww   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">1</span> (<span class="number">25</span>h ago)    <span class="number">103</span>d</div><div class="line">rpcx-server-demo-deployment-<span class="number">7</span>f9d85c5dc-<span class="number">42</span>wbm   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">1</span> (<span class="number">102</span>d ago)   <span class="number">103</span>d</div><div class="line">rpcx-server-demo-deployment-<span class="number">7</span>f9d85c5dc-<span class="number">499</span>gm   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">1</span> (<span class="number">102</span>d ago)   <span class="number">103</span>d</div><div class="line">rpcx-server-demo-deployment-<span class="number">7</span>f9d85c5dc<span class="operator">-s</span>6gh9   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">1</span> (<span class="number">25</span>h ago)    <span class="number">103</span>d</div></pre></td></tr></table></figure>

<p>å› ä¸ºæˆ‘ä»¬çš„å‰¯æœ¬æ•°æ˜¯1,æ‰€ä»¥è¿™é‡Œåªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ã€‚</p>
<p>æŸ¥çœ‹å®¢æˆ·ç«¯çš„è¾“å‡ºï¼Œå¯ä»¥çœ‹åˆ°å®ƒè°ƒç”¨æœåŠ¡æˆåŠŸäº†:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">âœ  ~ kubectl logs rpcx-client-demo-deployment-<span class="number">699</span>bfb8799-wdsww |more</div><div class="line">dial  <span class="number">10.98</span>.<span class="number">134.3</span>:<span class="number">9981</span></div><div class="line"><span class="number">2022</span><span class="regexp">/06/</span><span class="number">02</span> <span class="number">15</span>:<span class="number">45</span>:<span class="number">17</span> <span class="number">10</span> * <span class="number">20</span> = <span class="number">200</span></div><div class="line"><span class="number">2022</span><span class="regexp">/06/</span><span class="number">02</span> <span class="number">15</span>:<span class="number">45</span>:<span class="number">18</span> <span class="number">10</span> * <span class="number">20</span> = <span class="number">200</span></div><div class="line"><span class="number">2022</span><span class="regexp">/06/</span><span class="number">02</span> <span class="number">15</span>:<span class="number">45</span>:<span class="number">19</span> <span class="number">10</span> * <span class="number">20</span> = <span class="number">200</span></div><div class="line"><span class="number">2022</span><span class="regexp">/06/</span><span class="number">02</span> <span class="number">15</span>:<span class="number">45</span>:<span class="number">20</span> <span class="number">10</span> * <span class="number">20</span> = <span class="number">200</span></div><div class="line"><span class="number">2022</span><span class="regexp">/06/</span><span class="number">02</span> <span class="number">15</span>:<span class="number">45</span>:<span class="number">21</span> <span class="number">10</span> * <span class="number">20</span> = <span class="number">200</span></div><div class="line"><span class="number">2022</span><span class="regexp">/06/</span><span class="number">02</span> <span class="number">15</span>:<span class="number">45</span>:<span class="number">22</span> <span class="number">10</span> * <span class="number">20</span> = <span class="number">200</span></div><div class="line"><span class="number">2022</span><span class="regexp">/06/</span><span class="number">02</span> <span class="number">15</span>:<span class="number">45</span>:<span class="number">23</span> <span class="number">10</span> * <span class="number">20</span> = <span class="number">200</span></div><div class="line"><span class="number">2022</span><span class="regexp">/06/</span><span class="number">02</span> <span class="number">15</span>:<span class="number">45</span>:<span class="number">24</span> <span class="number">10</span> * <span class="number">20</span> = <span class="number">200</span></div></pre></td></tr></table></figure>

]]></content>
    <summary type="html">
    <![CDATA[<p><a href="https://kubernetes.io/" target="_blank" rel="external">Kubernetes</a>ï¼ˆå¸¸ç®€ç§°ä¸ºK8sï¼‰æ˜¯ç”¨äºè‡ªåŠ¨éƒ¨ç½²ã€æ‰©å±•å’Œç®¡ç†â€œå®¹å™¨åŒ–ï¼ˆcontainerizedï¼‰åº”ç”¨ç¨‹åºâ€çš„å¼€æºç³»ç»Ÿã€‚è¯¥ç³»ç»Ÿç”±Googleè®¾è®¡å¹¶æèµ ç»™Cloud Native Computing Foundationï¼ˆä»Šå±LinuxåŸºé‡‘ä¼šï¼‰æ¥ä½¿ç”¨ã€‚</p>
<p>å®ƒæ—¨åœ¨æä¾›â€œè·¨ä¸»æœºé›†ç¾¤çš„è‡ªåŠ¨éƒ¨ç½²ã€æ‰©å±•ä»¥åŠè¿è¡Œåº”ç”¨ç¨‹åºå®¹å™¨çš„å¹³å°â€ã€‚ å®ƒæ”¯æŒä¸€ç³»åˆ—å®¹å™¨å·¥å…·ï¼ŒåŒ…æ‹¬Dockerç­‰ã€‚</p>
<p>Kubernetesï¼ˆåœ¨å¸Œè…Šè¯­æ„ä¸ºâ€œèˆµæ‰‹â€æˆ–â€œé©¾é©¶å‘˜â€ï¼‰ç”±Joe Bedaã€Brendan Burnså’ŒCraig McLuckieåˆ›ç«‹ï¼Œå¹¶ç”±å…¶ä»–è°·æ­Œå·¥ç¨‹å¸ˆï¼ŒåŒ…æ‹¬Brian Grantå’ŒTim Hockinç­‰è¿›è¡ŒåŠ ç›Ÿåˆ›ä½œï¼Œå¹¶ç”±è°·æ­Œåœ¨2014å¹´é¦–æ¬¡å¯¹å¤–å®£å¸ƒ ã€‚ è¯¥ç³»ç»Ÿçš„å¼€å‘å’Œè®¾è®¡éƒ½æ·±å—è°·æ­Œçš„Borgç³»ç»Ÿçš„å½±å“ï¼Œå…¶è®¸å¤šé¡¶çº§è´¡çŒ®è€…ä¹‹å‰ä¹Ÿæ˜¯Borgç³»ç»Ÿçš„å¼€å‘è€…ã€‚åœ¨è°·æ­Œå†…éƒ¨ï¼ŒKubernetesçš„åŸå§‹ä»£å·æ›¾ç»æ˜¯Sevenï¼Œå³æ˜Ÿé™…è¿·èˆªä¸­çš„Borgï¼ˆåšæ ¼äººï¼‰ã€‚Kubernetesæ ‡è¯†ä¸­èˆµè½®æœ‰ä¸ƒä¸ªè½®è¾å°±æ˜¯å¯¹è¯¥é¡¹ç›®ä»£å·çš„è‡´æ„ã€‚</p>
<p>Kuberbetesä¸€ç›´æ˜¯ITè¡Œä¸šç‚½æ‰‹å¯çƒ­çš„æŠ€æœ¯ï¼Œå¾ˆå¤šåŒå­¦éƒ½æƒ³å­¦ä¹ å®ƒï¼Œä½†æ˜¯åˆšæƒ³ä¸Šæ‰‹é‡åˆ°äº†ä¸€ä¸ªéº»çƒ¦ï¼Œéœ€è¦æ­å»ºä¸€ä¸ªk8sçš„é›†ç¾¤ã€‚è™½ç„¶äº‘æœåŠ¡æä¾›å•†æ¯”å¦‚é˜¿é‡Œäº‘ã€ç™¾åº¦äº‘éƒ½æä¾›äº†k8sé›†ç¾¤çš„æœåŠ¡ï¼Œä½†æ˜¯è¿˜éœ€è¦èŠ±ä¸€ç¬”é’±å»è´­ä¹°æœåŠ¡å’ŒèŠ‚ç‚¹ã€‚å¦‚ä½•åœ¨è‡ªå·±çš„æœºå™¨ä¸Šæ­å»ºä¸€ä¸ªk8sé›†ç¾¤å­¦ä¹ å‘¢ï¼Ÿæœ¬æ–‡ç»™ä½ ä»‹ç»ä¸€ç§ä½¿ç”¨minikubeæ­å»ºä¸€ä¸ªk8sæµ‹è¯•é›†ç¾¤çš„æ–¹æ³•ã€‚</p>
]]>
    
    </summary>
    
      <category term="k8s" scheme="https://colobu.com/categories/k8s/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[ä½¿ç”¨ebpfè·Ÿè¸ªrpcxå¾®æœåŠ¡]]></title>
    <link href="https://colobu.com/2022/05/22/use-ebpf-to-trace-rpcx-microservices/"/>
    <id>https://colobu.com/2022/05/22/use-ebpf-to-trace-rpcx-microservices/</id>
    <published>2022-05-22T08:34:29.000Z</published>
    <updated>2022-05-22T13:17:44.617Z</updated>
    <content type="html"><![CDATA[<p><a href="https://ebpf.io/zh-cn/" target="_blank" rel="external">ebpf</a>æ˜¯ä¸€ç§åˆ›æ–°çš„é©å‘½æ€§æŠ€æœ¯ï¼Œå®ƒèƒ½åœ¨å†…æ ¸ä¸­è¿è¡Œæ²™ç®±ç¨‹åºï¼Œ è€Œæ— éœ€ä¿®æ”¹å†…æ ¸æºç æˆ–è€…åŠ è½½å†…æ ¸æ¨¡å—ã€‚å°† Linux å†…æ ¸å˜æˆå¯ç¼–ç¨‹ä¹‹åï¼Œå°±èƒ½åŸºäºç°æœ‰çš„ï¼ˆè€Œéå¢åŠ æ–°çš„ï¼‰æŠ½è±¡å±‚æ¥æ‰“é€ æ›´åŠ æ™ºèƒ½ã€ åŠŸèƒ½æ›´åŠ ä¸°å¯Œçš„åŸºç¡€è®¾æ–½è½¯ä»¶ï¼Œè€Œä¸ä¼šå¢åŠ ç³»ç»Ÿçš„å¤æ‚åº¦ï¼Œä¹Ÿä¸ä¼šç‰ºç‰²æ‰§è¡Œæ•ˆç‡å’Œå®‰å…¨æ€§ã€‚</p>
<p>BPFçš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬åœ¨1994å¹´é—®ä¸–ã€‚æˆ‘ä»¬åœ¨ä½¿ç”¨tcpdumpå·¥å…·ç¼–å†™è§„åˆ™çš„æ—¶å€™å…¶å®å°±ä½¿ç”¨åˆ°å®ƒäº†ï¼Œè¯¥å·¥å…·ç”¨äºæŸ¥çœ‹æˆ–â€å—…æ¢â€ç½‘ç»œæ•°æ®åŒ…ã€‚</p>
<a id="more"></a>
<p><img src="ebpf.png" alt=""></p>
<p>ä½¿ç”¨ebpfæŠ€æœ¯ï¼Œä½ å¯ä»¥ä»å®‰å…¨ã€è·Ÿè¸ª&amp;æ€§èƒ½åˆ†æã€ç½‘ç»œã€è§‚æµ‹&amp;ç›‘æ§ç­‰æ–¹å‘æä¾›æ–°çš„æ€è·¯å’ŒæŠ€æœ¯ï¼š</p>
<ul>
<li>å®‰å…¨ï¼šå¯ä»¥ä»ç³»ç»Ÿè°ƒç”¨çº§ã€packetå±‚ã€socketå±‚è¿›è¡Œå®‰å…¨æ£€æŸ¥ï¼Œæ¯”å¦‚å¼€å‘DDOSé˜²æŠ¤ç³»ç»Ÿï¼Œç¼–å†™é˜²ç«å¢™ç¨‹åºã€‚</li>
<li>ç½‘ç»œï¼šå¯ä»¥å¼€å‘å†…æ ¸å±‚é«˜æ€§èƒ½åŒ…å¤„ç†ç¨‹åºï¼Œæ¯”å¦‚Ciliumæä¾›å†…æ ¸å±‚çš„è´Ÿè½½å‡è¡¡ï¼ŒæŠŠservice meshå¾€æ›´æ·±å±‚æ¨è¿›ï¼Œè§£å†³sidecarçš„æ€§èƒ½é—®é¢˜ã€‚</li>
<li>è·Ÿè¸ª&amp;æ€§èƒ½åˆ†æ: Linuxæä¾›å¤šç§ç±»å‹çš„æ¢é’ˆç‚¹(probe point),æ¯”å¦‚Kernel probesã€perf eventsã€Tracepointsã€User-space probesã€User statically defined tracepointsã€XDPç­‰ç­‰ï¼Œæˆ‘ä»¬å¯ä»¥ç¼–å†™probeç¨‹åºæ”¶é›†è¿™äº›æ¢é’ˆç‚¹çš„ä¿¡æ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼è·Ÿè¸ªç¨‹åºï¼Œåˆ†ææ€§èƒ½ã€‚</li>
<li>è§‚æµ‹&amp;ç›‘æ§: å¯¹è¿™äº›æ¢é’ˆç‚¹çš„æŒç»­è§‚æµ‹å’Œç›‘æ§ï¼Œæˆ‘ä»¬å¯ä»¥ä¸°å¯Œæˆ‘ä»¬çš„traceç¨‹åºã€‚å…³é”®æ˜¯ï¼Œæˆ‘ä»¬ä¸éœ€è¦æ›´æ”¹æ—¢æœ‰çš„ç¨‹åºï¼Œè€Œæ˜¯é€šè¿‡ebpfæ–¹æ³•ä»å…¶å®ƒç¨‹åºè¿›è¡Œè§‚æµ‹ã€‚2014å¹´ï¼Œè‘—åçš„å†…æ ¸é»‘å®¢Alexei Starovoitovå¯¹BPFçš„åŠŸèƒ½è¿›è¡Œäº†æ‰©å±•ã€‚ä»–å¢åŠ äº†å¯„å­˜å™¨çš„æ•°é‡å’Œç¨‹åºå…è®¸çš„å¤§å°ï¼Œå¢åŠ äº†JITç¼–è¯‘ï¼Œå¹¶åˆ›å»ºäº†ä¸€ä¸ªç”¨äºæ£€æŸ¥ç¨‹åºæ˜¯å¦å®‰å…¨çš„ç¨‹åºã€‚ç„¶è€Œï¼Œæœ€ä»¤äººå°è±¡æ·±åˆ»çš„æ˜¯ï¼Œæ–°çš„BPFç¨‹åºä¸ä»…èƒ½å¤Ÿåœ¨å¤„ç†æ•°æ®åŒ…æ—¶è¿è¡Œï¼Œè€Œä¸”èƒ½å¤Ÿå“åº”å…¶ä»–å†…æ ¸äº‹ä»¶ï¼Œå¹¶åœ¨å†…æ ¸å’Œç”¨æˆ·ç©ºé—´ä¹‹é—´æ¥å›ä¼ é€’ä¿¡æ¯ã€‚Alexei Starovoitovçš„æ–°ç‰ˆæœ¬çš„BPFè¢«ç§°ä¸ºeBPFï¼ˆeä»£è¡¨æ‰©å±•ï¼šextendedï¼‰ã€‚ä½†ç°åœ¨ï¼Œå®ƒå·²ç»å–ä»£äº†æ‰€æœ‰æ—§ç‰ˆçš„BPFç”¨æ³•ï¼Œå¹¶ä¸”å·²ç»å˜å¾—éå¸¸æµè¡Œï¼Œä¸ºäº†ç®€å•èµ·è§ï¼Œå®ƒä»ç„¶è¢«ç§°ä¸ºBPFã€‚</li>
</ul>
<p><img src="functions.png" alt=""></p>
<p>ä½ å¯ä»¥è‡ªå·±ç¼–å†™bpfç¨‹åºï¼Œè¿›è¡Œå®šåˆ¶åŒ–çš„é€»è¾‘å¤„ç†å’Œåˆ†æï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å¤§ç¥ä»¬å†™å¥½çš„å·¥å…·ï¼Œåˆ©ç”¨è¿™äº›å·¥å…·å¯¹ç¨‹åºè¿›è¡Œé€šç”¨çš„æ€§èƒ½åˆ†æå’Œè·Ÿè¸ªã€‚æœ¬æ–‡ä¸»è¦ä»‹ç»ä½¿ç”¨ä¸€äº›å·¥å…·å¯¹rpcxå¾®æœåŠ¡ç¨‹åºè¿›è¡Œé€šç”¨çš„åˆ†æï¼Œæ—¢ç„¶æ˜¯é€šç”¨çš„ï¼Œä½ å¯ä»¥å¯ä»¥å¯¹å…¶å®ƒçš„Goç¨‹åºè¿›è¡Œåˆ†æï¼Œè€Œä¸”ä¸ä»…é™äºGoç¨‹åºï¼Œå…¶å®ƒåº”ç”¨ç¨‹åºç”šè‡³å†…æ ¸ä½ å¯ä»¥è¿›è¡Œåˆ†æå’Œè·Ÿè¸ªã€‚</p>
<p>è‡ªå·±ç¼–å†™bpfç¨‹åºæˆ‘å‡†å¤‡å†æ–°å¼€ä¸€ç¯‡æ–‡ç« ä»‹ç»ã€‚</p>
<p>è¿™ä¸€æ¬¡ä¸»è¦ä»‹ç»<a href="https://github.com/iovisor/bcc" target="_blank" rel="external">bccæä¾›çš„ç›¸å…³å·¥å…·</a>å’Œ<a href="https://github.com/iovisor/bpftrace" target="_blank" rel="external">bpftrace</a>ã€‚</p>
<p>bccæ˜¯ç”¨äºåˆ›å»ºåŸºäºeBPFçš„é«˜æ•ˆå†…æ ¸è·Ÿè¸ªå’Œæ“ä½œç¨‹åºçš„å·¥å…·åŒ…ï¼Œå…¶ä¸­åŒ…æ‹¬ä¸€äº›æœ‰ç”¨çš„å‘½ä»¤è¡Œå·¥å…·å’Œç¤ºä¾‹ã€‚ BCCç®€åŒ–äº†ç”¨Cè¿›è¡Œå†…æ ¸æ£€æµ‹çš„eBPFç¨‹åºçš„ç¼–å†™ï¼ŒåŒ…æ‹¬LLVMçš„åŒ…è£…å™¨ä»¥åŠPythonå’ŒLuaçš„å‰ç«¯ã€‚å®ƒè¿˜æä¾›äº†ç”¨äºç›´æ¥é›†æˆåˆ°åº”ç”¨ç¨‹åºä¸­çš„é«˜çº§åº“ã€‚</p>
<p>bpftraceæ˜¯Linux eBPFçš„é«˜çº§è·Ÿè¸ªè¯­è¨€ã€‚å®ƒçš„è¯­è¨€å—awkå’ŒCä»¥åŠDTraceå’ŒSystemTapç­‰ä»¥å‰çš„è·Ÿè¸ªç¨‹åºçš„å¯å‘ã€‚ bpftraceä½¿ç”¨LLVMä½œä¸ºåç«¯å°†è„šæœ¬ç¼–è¯‘ä¸ºeBPFå­—èŠ‚ç ï¼Œå¹¶åˆ©ç”¨BCCä½œä¸ºä¸Linux eBPFå­ç³»ç»Ÿä»¥åŠç°æœ‰Linuxè·Ÿè¸ªåŠŸèƒ½å’Œè¿æ¥ç‚¹è¿›è¡Œäº¤äº’çš„åº“ã€‚</p>
<h2 id="ç®€å•çš„_rpcx_å¾®æœåŠ¡ç¨‹åº">ç®€å•çš„ rpcx å¾®æœåŠ¡ç¨‹åº</h2>
<p>æ—¢ç„¶è¦ä½¿ç”¨ebpfåˆ†æç¨‹åºï¼Œé¦–å…ˆæˆ‘ä»¬è¦æœ‰ä¸€ä¸ªç¨‹åºã€‚è¿™é‡Œæˆ‘é€‰å–äº†<a href="https://github.com/smallnest/rpcx" target="_blank" rel="external">rpcx</a>ä¸€ä¸ªæœ€ç®€å•çš„ä¾‹å­ï¼Œå®ç°ä¸€ä¸ªä¹˜æ³•çš„æœ€å°çš„å¾®æœåŠ¡ã€‚</p>
<p>è¿™ä¸ªç¨‹åºçš„ä»£ç å¯ä»¥åœ¨<a href="https://github.com/rpcxio/rpcx-examples/tree/master/102basic" target="_blank" rel="external">rpcx-examples-102basic</a>ä¸‹è½½åˆ°ã€‚</p>
<p>æœåŠ¡ç«¯çš„ç¨‹åºå¦‚ä¸‹:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"context"</span></div><div class="line">	<span class="string">"flag"</span></div><div class="line">	<span class="string">"fmt"</span></div><div class="line"></div><div class="line">	example <span class="string">"github.com/rpcxio/rpcx-examples"</span></div><div class="line">	<span class="string">"github.com/smallnest/rpcx/server"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">var</span> (</div><div class="line">	addr = flag.String(<span class="string">"addr"</span>, <span class="string">"localhost:8972"</span>, <span class="string">"server address"</span>)</div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">type</span> Arith <span class="keyword">struct</span>{}</div><div class="line"></div><div class="line"><span class="comment">// ä½¿ç”¨ebpfè·Ÿè¸ªè¿™ä¸ªæœåŠ¡è°ƒç”¨</span></div><div class="line"><span class="keyword">func</span> (t *Arith) Mul(ctx context.Context, args example.Args, reply *example.Reply) error {</div><div class="line">	reply.C = args.A * args.B</div><div class="line">	fmt.Println(<span class="string">"C="</span>, reply.C)</div><div class="line">	<span class="keyword">return</span> <span class="constant">nil</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">func</span> main() {</div><div class="line">	flag.Parse()</div><div class="line"></div><div class="line">	s := server.NewServer()</div><div class="line">	s.RegisterName(<span class="string">"Arith"</span>, <span class="built_in">new</span>(Arith), <span class="string">""</span>)</div><div class="line">	err := s.Serve(<span class="string">"tcp"</span>, *addr)</div><div class="line">	<span class="keyword">if</span> err != <span class="constant">nil</span> {</div><div class="line">		<span class="built_in">panic</span>(err)</div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure>

<p>ä½¿ç”¨<code>go build server.go</code>ç¼–è¯‘å‡º<code>server</code>ç¨‹åºå¹¶è¿è¡Œ(<code>./server</code>)ã€‚</p>
<p>å®¢æˆ·ç«¯ç¨‹åºå¦‚ä¸‹:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"context"</span></div><div class="line">	<span class="string">"flag"</span></div><div class="line">	<span class="string">"log"</span></div><div class="line">	<span class="string">"time"</span></div><div class="line"></div><div class="line">	<span class="string">"github.com/smallnest/rpcx/protocol"</span></div><div class="line"></div><div class="line">	example <span class="string">"github.com/rpcxio/rpcx-examples"</span></div><div class="line">	<span class="string">"github.com/smallnest/rpcx/client"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">var</span> (</div><div class="line">	addr = flag.String(<span class="string">"addr"</span>, <span class="string">"localhost:8972"</span>, <span class="string">"server address"</span>)</div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">func</span> main() {</div><div class="line">	flag.Parse()</div><div class="line"></div><div class="line">	d, _ := client.NewPeer2PeerDiscovery(<span class="string">"tcp@"</span>+*addr, <span class="string">""</span>)</div><div class="line">	opt := client.DefaultOption</div><div class="line">	opt.SerializeType = protocol.JSON</div><div class="line"></div><div class="line">	xclient := client.NewXClient(<span class="string">"Arith"</span>, client.Failtry, client.RandomSelect, d, opt)</div><div class="line">	<span class="keyword">defer</span> xclient.Close()</div><div class="line"></div><div class="line">	args := example.Args{</div><div class="line">		A:<span class="number"> 10</span>,</div><div class="line">		B:<span class="number"> 20</span>,</div><div class="line">	}</div><div class="line"></div><div class="line">	<span class="keyword">for</span> {</div><div class="line">		reply := &example.Reply{}</div><div class="line">		err := xclient.Call(context.Background(), <span class="string">"Mul"</span>, args, reply)</div><div class="line">		<span class="keyword">if</span> err != <span class="constant">nil</span> {</div><div class="line">			log.Fatalf(<span class="string">"failed to call: %v"</span>, err)</div><div class="line">		}</div><div class="line"></div><div class="line">		log.Printf(<span class="string">"%d * %d = %d"</span>, args.A, args.B, reply.C)</div><div class="line">		time.Sleep(time.Second)</div><div class="line">	}</div><div class="line"></div><div class="line">}</div></pre></td></tr></table></figure>

<p>å®¢æˆ·ç«¯æ¯ä¸€ç§’ä¼šè°ƒç”¨<code>Arith.Mul</code>å¾®æœåŠ¡ä¸€æ¬¡ï¼Œå¾®æœåŠ¡çš„é€»è¾‘ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯æ‰§è¡Œä¹˜æ³•ï¼Œå¹¶æŠŠç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p>
<h2 id="è·Ÿè¸ªå’Œåˆ†æå¾®æœåŠ¡">è·Ÿè¸ªå’Œåˆ†æå¾®æœåŠ¡</h2>
<p>ä½œä¸ºæ¼”ç¤ºï¼Œæœ¬æ–‡åªè·Ÿè¸ªæœåŠ¡ç«¯<code>Arith.Mul</code>è°ƒç”¨æƒ…å†µã€‚</p>
<p>bccæä¾›äº†å¾ˆå¤šçš„åŸºäºbpfçš„åˆ†æç¨‹åºï¼Œå¦‚ä¸‹å›¾(å¤§ç¥Brendan Greggæ•´ç†çš„ç»å…¸å›¾)</p>
<p><img src="bcc_tracing_tools_early2019.png" alt=""><br><img src="bpftrace_tools_early2019.png" alt=""></p>
<p>è¿™é‡Œæˆ‘ä»¬ä¼šé€‰å–å‡ ä¸ªç›¸å…³çš„å·¥å…·æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨è¿™äº›å·¥å…·åˆ†æè¿è¡Œä¸­çš„ç¨‹åºã€‚ æ³¨æ„æ˜¯è¿è¡Œä¸­çš„ç¨‹åºï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰ç»™ç¨‹åºæ·»åŠ é¢å¤–çš„ä¸€äº›åŸ‹ç‚¹ã€‚</p>
<h3 id="bccå¥—ä»¶">bccå¥—ä»¶</h3>
<p>é¦–å…ˆä½ å¾—å®‰è£…bccå¥—ä»¶ï¼Œè€Œä¸”ä½ çš„Linuxå†…æ ¸è¿˜è¦è¶³å¤Ÿæ–°ï¼Œåœ¨ä¸€äº›å¤§å‚çš„æœºæˆ¿å†…ï¼Œè¿˜æœ‰ä¸€äº›å†…æ ¸ç‰ˆæœ¬çš„2.6.xæœåŠ¡å™¨ï¼Œè¿™äº›è€çš„å†…æ ¸æœåŠ¡å™¨ä¸èƒ½æ”¯æŒebpfæˆ–è€…ebpfçš„æ–°ç‰¹æ€§ã€‚</p>
<p>æˆ‘æ˜¯åœ¨æˆ‘çš„é˜¿é‡Œäº‘çš„ä¸€å°è™šæœºä¸Šæµ‹è¯•çš„ï¼Œå®ƒçš„ç‰ˆæœ¬æ˜¯:</p>
<ul>
<li>Linux lab 4.18.0-348.2.1.el8_5.x86_64</li>
<li>CentOS Stream release 8</li>
</ul>
<p>ç›´æ¥<code>yum install bcc-tools</code>å°±å¯ä»¥å®‰è£…è¿™äº›å·¥å…·ã€‚ </p>
<p>å¦‚æœä½ æ˜¯å…¶å®ƒçš„ç‰ˆæœ¬çš„æ“ä½œç³»ç»Ÿï¼Œä½ å¯ä»¥å‚è€ƒbccçš„å®‰è£…æ–‡æ¡£è¿›è¡Œå®‰è£…: <a href="https://github.com/iovisor/bcc/blob/master/INSTALL.md" target="_blank" rel="external">bcc/INSTALL</a>ã€‚</p>
<p>åœ¨ä½¿ç”¨å·¥å…·åˆ†æä¹‹å‰ï¼Œä½ é¦–å…ˆè¦çŸ¥é“ä½ çš„å¾®æœåŠ¡<code>Arith.Mul</code>åœ¨ç¬¦å·è¡¨ä¸­çš„åç§°ï¼Œä½ å¯ä»¥ä½¿ç”¨objdumpæŸ¥è¯¢åˆ°:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@lab server]<span class="comment"># objdump -t server|grep Mul|grep main</span></div><div class="line"><span class="number">000000000075</span>a5e0 g     F .text	<span class="number">00000000000000</span>d0              main.(*Arith).Mul</div></pre></td></tr></table></figure>

<p>å®ƒçš„åç§°æ˜¯<code>main.(*Arith).Mul</code>,ä¸‹é¢æˆ‘ä»¬ä¼šä½¿ç”¨è¿™ä¸ªåç§°åˆ†æè¿™ä¸ªå¾®æœåŠ¡ã€‚</p>
<p>ç¡®ä¿åˆšæ‰çš„æœåŠ¡å™¨ä¸€ç›´åœ¨è¿è¡Œä¸­ã€‚</p>
<h4 id="funccount">funccount</h4>
<p>funccount ç”¨æ¥ç»Ÿè®¡ä¸€æ®µæ—¶é—´å†…æŸä¸ªå‡½æ•°çš„è°ƒç”¨æ¬¡æ•°ã€‚</p>
<p>åœ¨serveræ‰€åœ¨çš„ç›®å½•ä¸‹æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤(å¦‚æœåœ¨ä¸åŒçš„è·¯å¾„ï¼Œä½ éœ€è¦æ›´æ”¹å‘½ä»¤å‚æ•°ä¸­ç¨‹åºçš„è·¯å¾„):</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@lab server]<span class="comment"># funccount -d 10  './server:main.*.Mul'</span></div><div class="line">Tracing <span class="number">1</span> functions <span class="keyword">for</span> <span class="string">"b'./server:main.*.Mul'"</span><span class="keyword">...</span> Hit Ctrl-C to end.</div><div class="line"></div><div class="line">FUNC                                    COUNT</div><div class="line">b<span class="string">'main.(*Arith).Mul'</span>                       <span class="number">10</span></div><div class="line">Detaching...</div><div class="line">[root@lab server]<span class="comment">#</span></div></pre></td></tr></table></figure>

<p>è¿™é‡Œæˆ‘ä»¬è®¾ç½®è§‚å¯Ÿæ—¶é—´æ˜¯10ç§’ï¼Œå¯ä»¥çœ‹åˆ°åœ¨è¿™10ç§’å†…ï¼Œè¿™ä¸ªå‡½æ•°è¢«è°ƒç”¨äº†10æ¬¡ã€‚</p>
<p>å®ƒåŒ…å«å‡ ä¸ªå‚æ•°ï¼Œæ¯”å¦‚ä½ å¯ä»¥æŒç»­è§‚å¯Ÿï¼Œæ¯5ç§’è¾“å‡ºä¸€æ¬¡ç»“æœ:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@lab server]<span class="comment"># funccount -Ti 5  './server:main.*.Mul'</span></div><div class="line">Tracing <span class="number">1</span> functions <span class="keyword">for</span> <span class="string">"b'./server:main.*.Mul'"</span>... Hit Ctrl-C to end.</div><div class="line"></div><div class="line"><span class="number">18</span>:<span class="number">08</span>:<span class="number">29</span></div><div class="line">FUNC                                    COUNT</div><div class="line">b<span class="string">'main.(*Arith).Mul'</span>                        <span class="number">5</span></div></pre></td></tr></table></figure>

<p>æˆ‘ä»¬ç”šè‡³å¯ä»¥ç”¨å®ƒè¿›è¡ŒGo GCç›¸å…³å‡½æ•°çš„è·Ÿè¸ª:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@lab server]<span class="comment"># funccount -d 10  './server:runtime.*.gc*'</span></div><div class="line">Tracing <span class="number">21</span> functions <span class="keyword">for</span> <span class="string">"b'./server:runtime.*.gc*'"</span>... Hit Ctrl-C to end.</div><div class="line"></div><div class="line">FUNC                                    COUNT</div><div class="line">b<span class="string">'runtime.(*gcControllerState).update'</span>        <span class="number">2</span></div><div class="line">b<span class="string">'runtime.mallocgc'</span>                       <span class="number">250</span></div></pre></td></tr></table></figure>

<p>æŠ‘æˆ–æ˜¯è·Ÿè¸ªGoè¿è¡Œæ—¶çš„è°ƒåº¦:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@lab server]<span class="comment"># funccount -d 10  './server:runtime.schedule'</span></div><div class="line">Tracing <span class="number">1</span> functions <span class="keyword">for</span> <span class="string">"b'./server:runtime.schedule'"</span>... Hit Ctrl-C to end.</div><div class="line"></div><div class="line">FUNC                                    COUNT</div><div class="line">b<span class="string">'runtime.schedule'</span>                        <span class="number">20</span></div><div class="line">Detaching...</div></pre></td></tr></table></figure>

<h4 id="funclatency">funclatency</h4>
<p>funclatencyç»Ÿè®¡å‡½æ•°çš„æ‰§è¡Œçš„è€—æ—¶æƒ…å†µã€‚<br>å¦‚æœæˆ‘ä»¬æƒ³åˆ†æ<code>Arith.Mul</code>æ–¹æ³•æ‰§è¡Œçš„æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ï¼Œå®ƒä¼šç”¨ç›´æ–¹å›¾çš„å½¢å¼å±•ç¤ºè¿™ä¸ªå‡½æ•°è°ƒç”¨çš„è€—æ—¶åˆ†å¸ƒ:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">[root<span class="variable">@lab</span> server]<span class="comment"># funclatency -d 10  './server:main.*.Mul'</span></div><div class="line"><span class="constant">Tracing </span><span class="number">1</span> functions <span class="keyword">for</span> <span class="string">"./server:main.*.Mul"</span>... <span class="constant">Hit Ctrl-C </span>to <span class="keyword">end</span>.</div><div class="line"></div><div class="line"></div><div class="line"><span class="constant">Function </span>= b<span class="string">'main.(*Arith).Mul'</span> [<span class="number">359284</span>]</div><div class="line">     nsecs               <span class="symbol">:</span> count     distribution</div><div class="line">         <span class="number">0</span> -&gt; <span class="number">1</span>          <span class="symbol">:</span> <span class="number">0</span>        |                                        |</div><div class="line">         <span class="number">2</span> -&gt; <span class="number">3</span>          <span class="symbol">:</span> <span class="number">0</span>        |                                        |</div><div class="line">         <span class="number">4</span> -&gt; <span class="number">7</span>          <span class="symbol">:</span> <span class="number">0</span>        |                                        |</div><div class="line">         <span class="number">8</span> -&gt; <span class="number">15</span>         <span class="symbol">:</span> <span class="number">0</span>        |                                        |</div><div class="line">        <span class="number">16</span> -&gt; <span class="number">31</span>         <span class="symbol">:</span> <span class="number">0</span>        |                                        |</div><div class="line">        <span class="number">32</span> -&gt; <span class="number">63</span>         <span class="symbol">:</span> <span class="number">0</span>        |                                        |</div><div class="line">        <span class="number">64</span> -&gt; <span class="number">127</span>        <span class="symbol">:</span> <span class="number">0</span>        |                                        |</div><div class="line">       <span class="number">128</span> -&gt; <span class="number">255</span>        <span class="symbol">:</span> <span class="number">0</span>        |                                        |</div><div class="line">       <span class="number">256</span> -&gt; <span class="number">511</span>        <span class="symbol">:</span> <span class="number">0</span>        |                                        |</div><div class="line">       <span class="number">512</span> -&gt; <span class="number">1023</span>       <span class="symbol">:</span> <span class="number">0</span>        |                                        |</div><div class="line">      <span class="number">1024</span> -&gt; <span class="number">2047</span>       <span class="symbol">:</span> <span class="number">0</span>        |                                        |</div><div class="line">      <span class="number">2048</span> -&gt; <span class="number">4095</span>       <span class="symbol">:</span> <span class="number">0</span>        |                                        |</div><div class="line">      <span class="number">4096</span> -&gt; <span class="number">8191</span>       <span class="symbol">:</span> <span class="number">0</span>        |                                        |</div><div class="line">      <span class="number">8192</span> -&gt; <span class="number">16383</span>      <span class="symbol">:</span> <span class="number">0</span>        |                                        |</div><div class="line">     <span class="number">16384</span> -&gt; <span class="number">32767</span>      <span class="symbol">:</span> <span class="number">7</span>        |****************************************|</div><div class="line">     <span class="number">32768</span> -&gt; <span class="number">65535</span>      <span class="symbol">:</span> <span class="number">3</span>        |*****************                       |</div><div class="line"></div><div class="line">avg = <span class="number">31978</span> nsecs, <span class="symbol">total:</span> <span class="number">319783</span> nsecs, <span class="symbol">count:</span> <span class="number">10</span></div></pre></td></tr></table></figure>

<p>æˆ‘ä»¬ç»Ÿè®¡äº†10ç§’çš„æ•°æ®ã€‚å¯ä»¥çœ‹åˆ°æœŸé—´è¿™ä¸ªå‡½æ•°è¢«è°ƒç”¨äº†10æ¬¡ã€‚å¹³å‡è€—æ—¶31å¾®ç§’ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬æƒ³æ£€æŸ¥çº¿ä¸Šçš„ç¨‹åºæœ‰æ²¡æœ‰é•¿å°¾çš„ç°è±¡ï¼Œä½¿ç”¨è¿™ä¸ªå·¥å…·å¾ˆå®¹æ˜“åˆ†æç»Ÿè®¡ã€‚</p>
<h4 id="funcslower">funcslower</h4>
<p>funcslower è¿™ä¸ªå·¥å…·å¯ä»¥è·Ÿè¸ªå†…æ ¸å’Œç¨‹åºçš„æ‰§è¡Œæ…¢çš„å‡½æ•°ï¼Œæ¯”å¦‚ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@lab server]<span class="comment"># funcslower -u 10  './server:main.(*Arith).Mul'</span></div><div class="line">Tracing function calls slower than <span class="number">10</span> us... Ctrl+C to quit.</div><div class="line">COMM           PID    LAT(us)             RVAL FUNC</div><div class="line">server         <span class="number">359284</span>   <span class="number">44.75</span>                <span class="number">0</span> ./server:main.(*Arith).Mul</div><div class="line">server         <span class="number">359284</span>   <span class="number">30.97</span>                <span class="number">0</span> ./server:main.(*Arith).Mul</div><div class="line">server         <span class="number">359284</span>   <span class="number">33.38</span>                <span class="number">0</span> ./server:main.(*Arith).Mul</div><div class="line">server         <span class="number">359284</span>   <span class="number">31.28</span>                <span class="number">0</span> ./server:main.(*Arith).Mul</div></pre></td></tr></table></figure>

<p>ä½ ç”šè‡³å¯ä»¥æ‰“å°å‡ºå †æ ˆä¿¡æ¯:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">[root@lab server]funcslower -UK -u <span class="number">10</span>  <span class="string">'./server:main.(*Arith).Mul'</span></div><div class="line">Tracing function calls slower than <span class="number">10</span> us... Ctrl+C to quit.</div><div class="line">COMM           PID    LAT(us)             RVAL FUNC</div><div class="line">server         <span class="number">359284</span>   <span class="number">31.20</span>                <span class="number">0</span> ./server:main.(*Arith).Mul</div><div class="line">    b<span class="string">'runtime.call64.abi0'</span></div><div class="line">    b<span class="string">'runtime.reflectcall'</span></div><div class="line">    b<span class="string">'reflect.Value.call'</span></div><div class="line">    b<span class="string">'reflect.Value.Call'</span></div><div class="line">    b<span class="string">'github.com/smallnest/rpcx/server.(*service).call'</span></div><div class="line">    b<span class="string">'github.com/smallnest/rpcx/server.(*Server).handleRequest'</span></div><div class="line">    b<span class="string">'github.com/smallnest/rpcx/server.(*Server).serveConn.func2'</span></div><div class="line">    b<span class="string">'runtime.goexit.abi0'</span></div><div class="line">server         <span class="number">359284</span>   <span class="number">32.23</span>                <span class="number">0</span> ./server:main.(*Arith).Mul</div><div class="line">    b<span class="string">'runtime.call64.abi0'</span></div><div class="line">    b<span class="string">'runtime.reflectcall'</span></div><div class="line">    b<span class="string">'reflect.Value.call'</span></div><div class="line">    b<span class="string">'reflect.Value.Call'</span></div><div class="line">    b<span class="string">'github.com/smallnest/rpcx/server.(*service).call'</span></div></pre></td></tr></table></figure>

<h4 id="tcp_ç³»åˆ—å·¥å…·">tcp ç³»åˆ—å·¥å…·</h4>
<p>bccæä¾›äº†ä¸€å †çš„å¯¹tcpçš„è·Ÿè¸ªæƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥é’ˆå¯¹ä¸åŒçš„åœºæ™¯é€‰æ‹©ä½¿ç”¨ç›¸åº”çš„å·¥å…·ã€‚</p>
<ul>
<li>tools/tcpaccept: è·Ÿè¸ªTCPè¢«åŠ¨è¿æ¥ (accept()). </li>
<li>tools/tcpconnect: è·Ÿè¸ªTCPä¸»åŠ¨çš„è¿æ¥ (connect()).</li>
<li>tools/tcpconnlat: è·Ÿè¸ªTCPä¸»åŠ¨è¿æ¥çš„å»¶è¿Ÿ(connect()). </li>
<li>tools/tcpdrop: è·Ÿè¸ªå†…æ ¸çš„TCPåŒ…çš„ä¸¢åŒ…ç»†èŠ‚.</li>
<li>tools/tcplife: è·Ÿè¸ªTCP session(ç”Ÿå‘½å‘¨æœŸæŒ‡æ ‡æ±‡æ€»).</li>
<li>tools/tcpretrans: è·Ÿè¸ªTCPé‡ä¼ .</li>
<li>tools/tcprtt: è·Ÿè¸ªTCPæ¥å›çš„è€—æ—¶.</li>
<li>tools/tcpstates: è·Ÿè¸ªTCP sessionçŠ¶æ€çš„æ”¹å˜.</li>
<li>tools/tcpsubnet: æŒ‰å­ç½‘æ±‡æ€»å’ŒèšåˆTCPå‘é€æƒ…å†µ.</li>
<li>tools/tcpsynbl: æ˜¾ç¤ºTCP SYN backlogçš„æƒ…å†µ.</li>
<li>tools/tcptop: æŒ‰ä¸»æœºæ±‡æ€»TCP send/recvååæƒ…å†µ.</li>
<li>tools/tcptracer: è·Ÿè¸ªTCP å»ºç«‹/å…³é—­è¿æ¥çš„æƒ…å†µ (connect(), accept(), close()).</li>
<li>tools/tcpcong: è·Ÿè¸ªTCPå¥—æ¥å­—æ‹¥å¡æ§åˆ¶çŠ¶æ€æŒç»­æ—¶é—´.</li>
</ul>
<p>æ¯”å¦‚æˆ‘ä»¬å¦‚æœå…³æ³¨è¿æ¥çš„å»ºç«‹æƒ…å†µï¼Œå¯ä»¥ä½¿ç”¨<code>tcptracer</code>:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@lab lib]<span class="comment"># tcptracer</span></div><div class="line">Tracing TCP established connections. Ctrl-C to end.</div><div class="line">T  PID    COMM             IP SADDR            DADDR            SPORT  DPORT</div><div class="line">C  <span class="number">360005</span> client           <span class="number">4</span>  <span class="number">127.0</span>.<span class="number">0.1</span>        <span class="number">127.0</span>.<span class="number">0.1</span>        <span class="number">43126</span>  <span class="number">8972</span></div><div class="line">X  <span class="number">360005</span> client           <span class="number">6</span>  [::<span class="number">1</span>]            [::<span class="number">1</span>]            <span class="number">43010</span>  <span class="number">8972</span></div><div class="line">A  <span class="number">359284</span> server           <span class="number">4</span>  <span class="number">127.0</span>.<span class="number">0.1</span>        <span class="number">127.0</span>.<span class="number">0.1</span>        <span class="number">8972</span>   <span class="number">43126</span></div><div class="line">X  <span class="number">360005</span> client           <span class="number">4</span>  <span class="number">127.0</span>.<span class="number">0.1</span>        <span class="number">127.0</span>.<span class="number">0.1</span>        <span class="number">43126</span>  <span class="number">8972</span></div><div class="line">X  <span class="number">359284</span> server           <span class="number">4</span>  <span class="number">127.0</span>.<span class="number">0.1</span>        <span class="number">127.0</span>.<span class="number">0.1</span>        <span class="number">8972</span>   <span class="number">43126</span></div><div class="line">C  <span class="number">360009</span> client           <span class="number">4</span>  <span class="number">127.0</span>.<span class="number">0.1</span>        <span class="number">127.0</span>.<span class="number">0.1</span>        <span class="number">43130</span>  <span class="number">8972</span></div><div class="line">X  <span class="number">360009</span> client           <span class="number">6</span>  [::<span class="number">1</span>]            [::<span class="number">1</span>]            <span class="number">43014</span>  <span class="number">8972</span></div><div class="line">A  <span class="number">359284</span> server           <span class="number">4</span>  <span class="number">127.0</span>.<span class="number">0.1</span>        <span class="number">127.0</span>.<span class="number">0.1</span>        <span class="number">8972</span>   <span class="number">43130</span></div></pre></td></tr></table></figure>

<p>å¦å¤–è¿˜æœ‰ä¸€å †çš„<code>xxxxsnoop</code>ç¨‹åºï¼Œå¯ä»¥å¯¹ç‰¹å®šçš„ç³»ç»Ÿè°ƒç”¨è¿›è¡Œè·Ÿè¸ªã€‚</p>
<h3 id="bpftrace">bpftrace</h3>
<p>æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬æƒ³ä½¿ç”¨è„šæœ¬å®ç°ä¸€äº›å®šåˆ¶åŒ–çš„è·Ÿè¸ªï¼Œæ¯”å¦‚ç±»ä¼¼awkè¿™æ ·çš„å·¥å…·ï¼Œå¯ä»¥æä¾›ç®€å•çš„è„šæœ¬ç¼–å†™ã€‚</p>
<p>bpftraceå°±æ˜¯è¿™æ ·çš„å·¥å…·, å®ƒä½¿ç”¨LLVMä½œä¸ºåç«¯å°†è„šæœ¬ç¼–è¯‘ä¸ºeBPFå­—èŠ‚ç ï¼Œå¹¶åˆ©ç”¨BCCä½œä¸ºä¸Linux eBPFå­ç³»ç»Ÿä»¥åŠç°æœ‰Linuxè·Ÿè¸ªåŠŸèƒ½å’Œè¿æ¥ç‚¹è¿›è¡Œäº¤äº’çš„åº“ã€‚</p>
<p>bpftraceå‚è€ƒæ‰‹å†Œå¯ä»¥åœ¨<a href="https://github.com/iovisor/bpftrace/blob/master/docs/reference_guide.md#20-override-override-return-value" target="_blank" rel="external">bpftrace reference_guide</a>æ‰¾åˆ°ã€‚</p>
<p>ä»¥æˆ‘ä»¬çš„<code>Arith.Mul</code>ä¸ºä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ï¼Œåœ¨å‡½æ•°è°ƒç”¨æ—¶åŠ å…¥æ¢é’ˆï¼ŒæŠŠè¾“å…¥çš„å‚æ•°æ‰“å°å‡ºæ¥:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@lab server]# bpftrace -e <span class="string">'uprobe:./server:main.*.Mul {printf("%s - %s: arg1: %d, arg2: %d\n", comm, func, arg0, arg1)}'</span></div><div class="line">Attaching<span class="number"> 1</span> probe...</div><div class="line">server - main.(*Arith).Mul: arg1:<span class="number"> 10</span>, arg2:<span class="number"> 20</span></div><div class="line">server - main.(*Arith).Mul: arg1:<span class="number"> 10</span>, arg2:<span class="number"> 20</span></div><div class="line">server - main.(*Arith).Mul: arg1:<span class="number"> 10</span>, arg2:<span class="number"> 20</span></div></pre></td></tr></table></figure>

<p>ä¸ºä»€ä¹ˆarg0,arg1å°±èƒ½æŠŠå‚æ•°æ‰“å°å‡ºæ¥å‘¢ï¼Ÿç®€å•è¯´ï¼Œæˆ‘ä»¬çš„å¾®æœåŠ¡å‚æ•°æ­£å¥½æ˜¯ä¸¤ä¸ªint64çš„æ•´æ•°ï¼Œæ­£å¥½å¯¹åº”arg0,arg1ã€‚</p>
<p>rpcxçš„æœåŠ¡è¿”å›å€¼ä¹Ÿæ˜¯å½“åšå‚æ•°ä¼ å…¥çš„ï¼Œå‡½æ•°è°ƒç”¨çš„æ—¶å€™è¿˜æ²¡æœ‰è®¾ç½®ï¼Œæ‰€ä»¥ä½ å¦‚æœæ‰“å°arg3å¹¶ä¸æ˜¯replyè¿”å›å€¼ã€‚</p>
<p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬éœ€è¦ç§»åŠ¨æ¢é’ˆï¼ŒåŠ ä¸€ä¸ªåç§»é‡ï¼ŒåŠ å¤šå°‘çš„åç§»é‡å‘¢ï¼Ÿé€šè¿‡åæ±‡ç¼–æˆ‘ä»¬çœ‹åˆ°åŠ 92æ—¶è¿”å›å€¼å·²ç»èµ‹å€¼äº†ï¼Œæ‰€ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å°±å¯ä»¥æ‰“å°è¿”å›å€¼äº†(è¿™ä¸ªæ—¶å€™ç¬¬ä¸€ä¸ªå‚æ•°å°±è¢«è¦†ç›–æ‰äº†):</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@lab <span class="keyword">server</span>]<span class="preprocessor"># bpftrace -e 'uprobe:./server:main.*.Mul+92 {printf("%s - %s: reply: %d\n", comm, func, arg0)}'</span></div><div class="line">Attaching <span class="number">1</span> probe...</div><div class="line"><span class="keyword">server</span> - main.(*Arith).Mul: reply: <span class="number">200</span></div><div class="line"><span class="keyword">server</span> - main.(*Arith).Mul: reply: <span class="number">200</span></div><div class="line"><span class="keyword">server</span> - main.(*Arith).Mul: reply: <span class="number">200</span></div></pre></td></tr></table></figure>

<blockquote>
<p>Goè‡ª1.17å¼€å§‹å·²ç»æ”¹æˆäº†åŸºäºå¯„å­˜å™¨çš„è°ƒç”¨æƒ¯ä¾‹ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨äº†å†…å»ºçš„arg0ã€arg1ã€..., å¦‚æœä½ ä½¿ç”¨æ›´æ—©çš„Goç‰ˆæœ¬ï¼Œè¿™é‡Œä½ å¯ä»¥æ¢æˆsarg0,sarg1,...è¯•è¯•(stack arguments)ã€‚</p>
</blockquote>
<h2 id="å‚è€ƒæ–‡æ¡£">å‚è€ƒæ–‡æ¡£</h2>
<ol>
<li><a href="https://www.brendangregg.com/blog/2017-01-31/golang-bcc-bpf-function-tracing.html" target="_blank" rel="external">https://www.brendangregg.com/blog/2017-01-31/golang-bcc-bpf-function-tracing.html</a></li>
<li><a href="https://golangexample.com/library-to-work-with-ebpf-programs-from-golang/" target="_blank" rel="external">https://golangexample.com/library-to-work-with-ebpf-programs-from-golang/</a></li>
<li><a href="https://tonybai.com/2020/12/25/bpf-and-go-modern-forms-of-introspection-in-linux/" target="_blank" rel="external">https://tonybai.com/2020/12/25/bpf-and-go-modern-forms-of-introspection-in-linux/</a></li>
<li><a href="https://networkop.co.uk/post/2021-03-ebpf-intro/" target="_blank" rel="external">https://networkop.co.uk/post/2021-03-ebpf-intro/</a></li>
<li><a href="https://medium.com/bumble-tech/bpf-and-go-modern-forms-of-introspection-in-linux-6b9802682223#db17" target="_blank" rel="external">https://medium.com/bumble-tech/bpf-and-go-modern-forms-of-introspection-in-linux-6b9802682223#db17</a></li>
<li><a href="https://blog.px.dev/ebpf-http-tracing/" target="_blank" rel="external">https://blog.px.dev/ebpf-http-tracing/</a></li>
<li><a href="https://www.ebpf.top/post/ebpf_and_go/" target="_blank" rel="external">https://www.ebpf.top/post/ebpf_and_go/</a></li>
<li><a href="https://www.ebpf.top/" target="_blank" rel="external">https://www.ebpf.top/</a></li>
</ol>
]]></content>
    <summary type="html">
    <![CDATA[<p><a href="https://ebpf.io/zh-cn/" target="_blank" rel="external">ebpf</a>æ˜¯ä¸€ç§åˆ›æ–°çš„é©å‘½æ€§æŠ€æœ¯ï¼Œå®ƒèƒ½åœ¨å†…æ ¸ä¸­è¿è¡Œæ²™ç®±ç¨‹åºï¼Œ è€Œæ— éœ€ä¿®æ”¹å†…æ ¸æºç æˆ–è€…åŠ è½½å†…æ ¸æ¨¡å—ã€‚å°† Linux å†…æ ¸å˜æˆå¯ç¼–ç¨‹ä¹‹åï¼Œå°±èƒ½åŸºäºç°æœ‰çš„ï¼ˆè€Œéå¢åŠ æ–°çš„ï¼‰æŠ½è±¡å±‚æ¥æ‰“é€ æ›´åŠ æ™ºèƒ½ã€ åŠŸèƒ½æ›´åŠ ä¸°å¯Œçš„åŸºç¡€è®¾æ–½è½¯ä»¶ï¼Œè€Œä¸ä¼šå¢åŠ ç³»ç»Ÿçš„å¤æ‚åº¦ï¼Œä¹Ÿä¸ä¼šç‰ºç‰²æ‰§è¡Œæ•ˆç‡å’Œå®‰å…¨æ€§ã€‚</p>
<p>BPFçš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬åœ¨1994å¹´é—®ä¸–ã€‚æˆ‘ä»¬åœ¨ä½¿ç”¨tcpdumpå·¥å…·ç¼–å†™è§„åˆ™çš„æ—¶å€™å…¶å®å°±ä½¿ç”¨åˆ°å®ƒäº†ï¼Œè¯¥å·¥å…·ç”¨äºæŸ¥çœ‹æˆ–â€å—…æ¢â€ç½‘ç»œæ•°æ®åŒ…ã€‚</p>
]]>
    
    </summary>
    
      <category term="go" scheme="https://colobu.com/tags/go/"/>
    
      <category term="ebpf" scheme="https://colobu.com/tags/ebpf/"/>
    
      <category term="Go" scheme="https://colobu.com/categories/Go/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[atomicåŒ…çš„æ–°å˜åŒ–]]></title>
    <link href="https://colobu.com/2022/05/06/changes-in-atomic-package/"/>
    <id>https://colobu.com/2022/05/06/changes-in-atomic-package/</id>
    <published>2022-05-06T00:59:12.000Z</published>
    <updated>2022-05-22T08:37:06.156Z</updated>
    <content type="html"><![CDATA[<p>Russ Coxåœ¨å»å¹´çš„ç³»åˆ—<a href="https://colobu.com/2021/07/13/Updating-the-Go-Memory-Model/" target="_blank" rel="external">æ–‡ç« </a>ä¸­ï¼Œæåˆ°å¯¹atomicåŒ…çš„æ”¹å˜ï¼Œå¹¶ä¸”å¼€äº†ä¸€ä¸ªissueä¾›å¤§å®¶<a href="https://github.com/golang/go/discussions/47141" target="_blank" rel="external">è®¨è®º</a>,ç°åœ¨ä»–æäº¤çš„æ”¹å˜å·²ç»mergeåˆ°masteråˆ†æ”¯ï¼ŒGo 1.19å°±ä¼šåŒ…å«è¿™äº›æ”¹å˜ã€‚</p>
<a id="more"></a>
<p>ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨<a href="https://pkg.go.dev/golang.org/dl/gotip" target="_blank" rel="external">gotip</a>æå‰äº†è§£è¿™äº›æ”¹å˜ã€‚</p>
<p>Russ Coxè¿™æ¬¡çš„æäº¤åªæ˜¯å¯¹atomicè¡¥å……äº†ä¸€äº›æ–°çš„ç±»å‹ï¼Œè¿™äº›ç±»å‹æ˜¯å¯¹åŸºæœ¬ç±»å‹(primitive type, å¦‚boolã€int32ã€int64ã€uint32ã€uint64ã€uintptrç­‰)çš„ä¸€ä¸ªåŒ…è£…ï¼Œä»¥ä¾¿æä¾›åŸå­æ“ä½œã€‚</p>
<p>äº‹å®ä¸Šï¼Œuberå¾ˆæ—©ä»¥å‰å°±æä¾›ç±»ä¼¼çš„åŠŸèƒ½ï¼Œä¹Ÿè®¸ä½ å¾ˆæ—©ä¹‹å‰å°±ä½¿ç”¨è¿‡<a href="https://github.com/uber-go/atomic" target="_blank" rel="external">uber-go/atomic</a>è¿™ä¸ªåº“ã€‚</p>
<p>Russ Coxå®ç°çš„æ–¹å¼ä¹Ÿç±»ä¼¼ï¼Œæ¯•ç«Ÿï¼Œè¿™ä¸ªä¸ºåŸºæœ¬ç±»å‹å®ç°åŒ…è£…å™¨çš„å¥—è·¯è¿˜æ˜¯æ¯”è¾ƒå›ºå®šçš„ï¼Œä½†æ˜¯å®ç°ä¸Šç•¥å¾®æœ‰äº›ä¸åŒã€‚</p>
<ul>
<li>Russ Coxåœ¨æ ‡å‡†åº“ä¸­çš„å®ç°<ul>
<li>åµŒå…¥<code>_ noCopy</code>,æ–¹ä¾¿go vetç­‰å·¥å…·åšdata raceæ£€æŸ¥</li>
<li>ä»£ç å¯ä»¥è¿›è¡Œinline,æé«˜æ€§èƒ½</li>
</ul>
</li>
<li>Uberçš„å®ç°<ul>
<li>åµŒå…¥<code>_ nocmp</code>,é¿å…éåŸå­æ¯”è¾ƒ</li>
<li>æä¾›JSON Marshal/UnMarshalçš„åŠŸèƒ½ï¼Œæ–¹ä¾¿åºåˆ—åŒ–</li>
<li>æä¾›æ›´å¤šç±»å‹çš„åŒ…è£…å™¨: <code>Duration</code>ã€<code>String</code>ã€<code>Time</code>ã€<code>Float64</code>ã€<code>Error</code></li>
</ul>
</li>
</ul>
<p>æˆ‘ä»¬åœ¨è¿™ç¯‡æ–‡ç« ä¸­ä¸»è¦ä»‹ç»Russ Coxçš„å®ç°ï¼Œæ¯•ç«Ÿè¿™æ˜¯Goæ ‡å‡†åº“ä¸­çš„æ”¹åŠ¨ï¼Œæˆ‘å¤šå°‘è¦å¯¹è¿™äº›æ”¹åŠ¨æœ‰äº›å°è±¡ï¼Œåœ¨æˆ‘ä»¬å°†æ¥çš„ä»£ç å¼€å‘ï¼Œæˆ–è€…çœ‹åˆ«äººçš„ä»£ç æ—¶åšåˆ°å¿ƒä¸­æœ‰æ•°ã€‚</p>
<p>è¿™æ¬¡æ”¹åŠ¨å¢åŠ äº†boolã€int32ã€int64ã€uint32ã€uint64ã€uintptrã€Valueã€unsafe.Pointerç±»å‹çš„åŒ…è£…å™¨ï¼š<code>Bool</code>ã€<code>Int32</code>ã€<code>Int64</code>ã€<code>Uint32</code>ã€<code>Uint64</code>ã€<code>Uintptr</code>ã€<code>Value</code>ã€<code>Pointer</code>ã€‚</p>
<p>æ‰€æœ‰è¿™äº›ç±»å‹éƒ½åŒ…å«ä¸‹é¢å››ä¸ª<strong>æ–¹æ³•</strong>:</p>
<ul>
<li>CompareAndSwap(old, new *T) (swapped bool) : æ‰§è¡ŒCASæ“ä½œ</li>
<li>Load() *T : åŸå­loadå¯¹åº”çš„å€¼</li>
<li>Store(val *T) : å°†å€¼valåŸå­å­˜å‚¨</li>
<li>Swap(new <em>T) (old </em>T)ï¼š åŸå­ä¿å­˜æ–°å€¼ï¼Œå¹¶è¿”å›è€çš„å€¼</li>
</ul>
<p>é’ˆå¯¹ä¸åŒçš„ç±»å‹ï¼Œå¯èƒ½è¿˜ä¼šæœ‰ä¸€äº›é¢å¤–çš„æ–¹æ³•ï¼Œæ¯”å¦‚:</p>
<ul>
<li>Int32: <code>func (x *Int32) Add(delta int32) (new int32)</code></li>
<li>Int64: <code>func (x *Int64) Add(delta int64) (new int64)</code></li>
<li>Uint32: <code>func (x *Int64) Add(delta int64) (new int64)</code></li>
<li>Uint64: <code>func (x *Uint64) Add(delta uint64) (new uint64)</code></li>
<li>Uintptr: <code>func (x *Uintptr) Add(delta uintptr) (new uintptr)</code></li>
</ul>
<p>åŒæ ·ï¼Œé’ˆå¯¹<code>Uint32</code>ã€<code>Uint64</code>ç±»å‹ï¼Œåªæœ‰Addæ–¹æ³•ï¼Œå¦‚æœæƒ³å‡å»ä¸€ä¸ªæ­£å€¼cï¼Œå°±å¾—åˆ©ç”¨AddåŠ ä¸Šä¸€ä¸ªè´Ÿå€¼ï¼ˆ-cï¼‰ï¼Œå¯æ˜¯deltaçš„ç±»å‹éƒ½æ˜¯uxxxç±»å‹ï¼Œæ€ä¹ˆåŠå‘¢ï¼Ÿä½¿ç”¨<code>^uint64(c-1)</code>æˆ–è€…<code>^uint32(c-1)</code>ã€‚</p>
<p>è¿™äº›åŒ…è£…å™¨å’Œæ–¹æ³•å…¶å®å¯¹åº”çš„æ˜¯atomicçš„ç›¸åº”çš„å‡½æ•°ï¼Œæ‰€ä»¥ä½¿ç”¨èµ·æ¥æ²¡ä»€ä¹ˆéš¾åº¦:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> i Int64</div><div class="line">i.Add<span class="number">(100</span>)</div><div class="line">i.Load()</div><div class="line">i.Store<span class="number">(200</span>)</div><div class="line">i.Swap<span class="number">(300</span>)</div><div class="line">I.CompareAndSwap<span class="number">(300</span><span class="number">,400</span>)</div></pre></td></tr></table></figure>

<p>ä½ å¯ä»¥æŸ¥çœ‹go docäº†è§£æ›´è¯¦ç»†çš„ä¿¡æ¯: <a href="https://pkg.go.dev/sync/atomic@master" target="_blank" rel="external">sync/atomic</a></p>
]]></content>
    <summary type="html">
    <![CDATA[<p>Russ Coxåœ¨å»å¹´çš„ç³»åˆ—<a href="https://colobu.com/2021/07/13/Updating-the-Go-Memory-Model/" target="_blank" rel="external">æ–‡ç« </a>ä¸­ï¼Œæåˆ°å¯¹atomicåŒ…çš„æ”¹å˜ï¼Œå¹¶ä¸”å¼€äº†ä¸€ä¸ªissueä¾›å¤§å®¶<a href="https://github.com/golang/go/discussions/47141" target="_blank" rel="external">è®¨è®º</a>,ç°åœ¨ä»–æäº¤çš„æ”¹å˜å·²ç»mergeåˆ°masteråˆ†æ”¯ï¼ŒGo 1.19å°±ä¼šåŒ…å«è¿™äº›æ”¹å˜ã€‚</p>
]]>
    
    </summary>
    
      <category term="Go" scheme="https://colobu.com/categories/Go/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Goæ³›å‹çš„åä¾‹å­]]></title>
    <link href="https://colobu.com/2022/04/26/Crimes-with-Go-Generics/"/>
    <id>https://colobu.com/2022/04/26/Crimes-with-Go-Generics/</id>
    <published>2022-04-26T00:09:46.000Z</published>
    <updated>2022-05-22T08:37:06.156Z</updated>
    <content type="html"><![CDATA[<p>Go 1.18å‘å¸ƒäº†ç¬¬ä¸€ç‰ˆçš„Goæ³›å‹ä¹‹åï¼Œå¤§å®¶å¼€å§‹å¯¹Goæ³›å‹è¿›è¡Œäº†æ·±å…¥çš„ç ”ç©¶ï¼Œä»Šå¤©ç¿»è¯‘çš„è¿™ä¸€ç¯‡ï¼Œæ˜¯åŠ æ‹¿å¤§çš„Xe Iasoåˆšå‡ºç‚‰çš„ä¸€ç¯‡æœ‰è¶£çš„<a href="https://christine.website/blog/gonads-2022-04-24" target="_blank" rel="external">æ–‡ç« </a>ï¼Œå¯¹Goæ³›å‹çš„åº”ç”¨åšäº†ä¸€äº›æ¢ç´¢ã€‚</p>
<a id="more"></a>
<p>Go 1.18åœ¨è¯­è¨€ä¸­æ·»åŠ äº†æ³›å‹ç‰¹æ€§ã€‚å…è®¸æ‚¨æŠŠä½ çš„ç±»å‹ä½œä¸ºå‚æ•°ï¼Œè¿™æ ·ä½ å¯ä»¥åˆ›å»ºå¤åˆç±»å‹ï¼ˆç±»å‹ä¹‹å¤–çš„ç±»å‹ï¼‰ã€‚è¿™è®©ä½ åœ¨ä½¿ç”¨Goçš„è¿‡ç¨‹ä¸­å¯ä»¥æœ‰æ›´å¤šçš„è¡¨ç°åŠ›å’Œæ¸…æ™°åº¦ã€‚</p>
<p>ç„¶è€Œï¼Œå¦‚æœä½ æ­£åœ¨å¯»æ‰¾å…³äºå¦‚ä½•ä½¿ç”¨Goæ³›å‹çš„å¥½ä¸»æ„ï¼Œè¿™ç¯‡æ–‡ç« ä¸é€‚åˆä½ ã€‚è¿™é‡Œé¢æ»¡æ˜¯åä¸»æ„ã€‚è¿™ç¯‡æ–‡ç« å…¨æ˜¯ä¸åº”è¯¥åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨Goæ³›å‹çš„æ–¹æ³•ã€‚ä¸è¦å°†æœ¬æ–‡ä¸­çš„ç¤ºä¾‹å¤åˆ¶åˆ°ç”Ÿäº§ä¸­ã€‚é€šè¿‡é˜…è¯»æœ¬æ–‡ï¼Œæ‚¨åŒæ„ä¸å°†æœ¬æ–‡ä¸­çš„ç¤ºä¾‹å¤åˆ¶åˆ°ç”Ÿäº§ä¸­ã€‚</p>
<p>æˆ‘å·²å°†æœ¬æ–‡çš„ä»£ç æ”¾åœ¨<a href="https://tulpa.dev/internal/gonads" target="_blank" rel="external">æˆ‘çš„gitæœåŠ¡å™¨</a>ä¸Šã€‚æˆ‘æ•…æ„é‡‡å–ä»¥ä¸‹æ­¥éª¤ä»¥ä¾¿ä»£ç éš¾ä»¥åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ï¼š</p>
<ol>
<li>æˆ‘åœ¨ä¸€ä¸ªåä¸º<code>internal</code>çš„giteaç»„ç»‡ä¸‹åˆ›å»ºäº†å®ƒã€‚è¿™å°†ä½¿æ‚¨æ— æ³•å¯¼å…¥åŒ…ï¼Œé™¤éæ‚¨æ˜¯ä»æˆ‘çš„giteaæœåŠ¡å™¨ä¸Šçš„repoä½¿ç”¨å®ƒã€‚è¯¥giteaæœåŠ¡å™¨ä¸Šçš„æ³¨å†Œè¢«ç¦ç”¨ã€‚æœ‰å…³å†…éƒ¨åŒ…è§„åˆ™çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§<a href="https://go.dev/doc/go1.4#internalpackages" target="_blank" rel="external">æ­¤å¤„</a>ã€‚</li>
<li>è½¯ä»¶åŒ…æ–‡æ¡£åŒ…å«ä¸€æ¡ç¥å¥‡çš„æ³¨é‡Šï¼Œå®ƒä¼šè®©staticcheckå’Œå…¶ä»–linter è­¦å‘Šæ‚¨æ­£åœ¨ä½¿ç”¨çš„è½¯ä»¶åŒ…å·²è¢«å¼ƒç”¨ã€‚</li>
</ol>
<h2 id="Queue[T]"><code>Queue[T]</code></h2>
<p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬å±•ç¤ºä¸€ä¸‹è®¡ç®—æœºç§‘å­¦ä¸­ä¸€ä¸ªéš¾é¢˜ã€‚è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªMPMSï¼ˆmultiple producer, multiple subscriber,å¤šç”Ÿäº§è€…ã€å¤šæ¶ˆè´¹è€…ï¼‰é˜Ÿåˆ—,è¿™æ˜¯æˆ‘ä»¬å¹¶å‘ç¼–ç¨‹å¸¸è§çš„ä¸€ç§æ•°æ®ç»“æ„ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªstructæ¥åŒ…è£…ä¸€åˆ‡ã€‚å®ƒçœ‹èµ·æ¥æ˜¯è¿™æ ·çš„ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Queue[T any] <span class="keyword">struct</span> {</div><div class="line">  data <span class="keyword">chan</span> T</div><div class="line">}</div></pre></td></tr></table></figure>

<p>ä¸Šé¢ä»£ç åˆ›å»ºäº†ä¸€ä¸ªåä¸º<code>Queue</code>çš„ç±»å‹ï¼Œå®ƒæ¥å—ä¸€ä¸ªç±»å‹å‚æ•°<code>T</code>ã€‚è¿™ä¸ª<code>T</code>å¯ä»¥æ˜¯ä»»ä½•ç±»å‹ï¼Œä½†å”¯ä¸€è¦æ±‚æ˜¯è¿™ä¸ªæ•°æ®æ˜¯ä¸€ä¸ªGoç±»å‹ã€‚</p>
<p>æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‡½æ•°ä¸º<code>Queue[T]</code>å®ä¾‹åˆ›å»ºä¸€ä¸ªå°å°çš„æ„é€ å‡½æ•°ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> NewQueue[T any](size <span class="typename">int</span>) Queue[T] {</div><div class="line">  <span class="keyword">return</span> Queue[T]{</div><div class="line">    data: <span class="built_in">make</span>(<span class="keyword">chan</span> T, size),</div><div class="line">  }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬åœ¨<code>Queue</code> structä¸Šåˆ›å»ºä¸€äº›æ–¹æ³•ï¼Œå½“ç„¶ä¹Ÿå°±æ˜¯å‹å…¥å’Œå¼¹å‡ºæ“ä½œäº†ã€‚å®ƒä»¬å¯èƒ½æ˜¯è¿™æ ·çš„ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> (q Queue[T]) Push(val T) {</div><div class="line">  q.data &lt;- val</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">func</span> (q Queue[T]) Pop() T {</div><div class="line">  <span class="keyword">return</span> &lt;-q.data</div><div class="line">}</div></pre></td></tr></table></figure>

<p>è¿™äº›æ–¹æ³•å°†å…è®¸æ‚¨å°†æ•°æ®æ”¾åœ¨é˜Ÿåˆ—çš„æœ«å°¾ï¼Œç„¶åä»å¤´éƒ¨å–å‡ºæ•°æ®ã€‚ä½ å¯ä»¥è¿™æ ·ä½¿ç”¨å®ƒä»¬ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">q := NewQueue[<span class="typename">string</span>]<span class="number">(5</span>)</div><div class="line">q.Push(<span class="string">"hi there"</span>)</div><div class="line">str := q.Pop()</div><div class="line"><span class="keyword">if</span> str != <span class="string">"hi there"</span> {</div><div class="line">  <span class="built_in">panic</span>(<span class="string">"string is wrong"</span>)</div><div class="line">}</div></pre></td></tr></table></figure>

<p>ç›®å‰æ¥è¯´ä¸€åˆ‡éƒ½å¥½ï¼Œä½†æ˜¯æœ‰ä¸ªå°é—®é¢˜ï¼Œå½“é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œè°ƒç”¨<code>Pop</code>æ—¶è°ƒç”¨è€…ä¼šè¢«é˜»å¡åœ¨é‚£é‡Œï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>select - default</code>è¯­å¥æ¥å®ç°éé˜»å¡ç‰ˆæœ¬çš„<code>TrpPop</code>æ–¹æ³•:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">func</span> (q Queue[T]) TryPop() (T, <span class="typename">bool</span>) {</div><div class="line">  <span class="keyword">select</span> {</div><div class="line">  <span class="keyword">case</span> val := &lt;-q.data:</div><div class="line">    <span class="keyword">return</span> val, <span class="constant">true</span></div><div class="line">  <span class="keyword">default</span>:</div><div class="line">    <span class="keyword">return</span> <span class="constant">nil</span>, <span class="constant">false</span></div><div class="line">  }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>ä½†æ˜¯ï¼Œä¸å¹¸çš„äº‹æƒ…å‘ç”Ÿäº†ï¼Œä¸Šé¢çš„ä»£ç æ— æ³•ç¼–è¯‘,å‡ºé”™ä¿¡æ¯å¦‚ä¸‹:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cannot use <span class="constant">nil</span> as T value in <span class="keyword">return</span> statement</div></pre></td></tr></table></figure>

<p>åœ¨è¯¥ä»£ç ä¸­ï¼Œ<code>T</code>å¯ä»¥æ˜¯ä»»ä½•å€¼ï¼ŒåŒ…æ‹¬å¯èƒ½ä¸ä¸ºnilçš„å€¼ã€‚æˆ‘ä»¬å¯ä»¥åˆ©ç”¨varè¯­å¥æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå®ƒç”Ÿæˆä¸€ä¸ªæ–°å˜é‡ï¼Œå¹¶å°†å…¶åˆå§‹åŒ–ä¸ºè¯¥ç±»å‹çš„é›¶å€¼ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> Zero[T any]() T {</div><div class="line">  <span class="keyword">var</span> zero T</div><div class="line">  <span class="keyword">return</span> zero</div><div class="line">}</div></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥åƒä¸‹é¢ä¸€æ ·ä½¿ç”¨è¿™ä¸ªè¿”å›é›¶å€¼çš„å‡½æ•°:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">log.Printf(<span class="string">"%q"</span>, Zero[<span class="typename">string</span>]())</div><div class="line">log.Printf(<span class="string">"%v"</span>, Zero[<span class="typename">int</span>]())</div></pre></td></tr></table></figure>

<p>è¾“å‡ºçš„ç»“æœå¯èƒ½å¦‚ä¸‹:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="number">2009</span><span class="regexp">/11/</span><span class="number">10</span> <span class="number">23</span>:<span class="number">00</span>:<span class="number">00</span> <span class="string">""</span></div><div class="line"><span class="number">2009</span><span class="regexp">/11/</span><span class="number">10</span> <span class="number">23</span>:<span class="number">00</span>:<span class="number">00</span> <span class="number">0</span></div></pre></td></tr></table></figure>

<p>ç°åœ¨æˆ‘ä»¬å°±å¯ä»¥æ”¹é€ <code>TryPop</code>çš„<code>default</code>åˆ†æ”¯äº†:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> (q Queue[T]) TryPop() (T, <span class="typename">bool</span>) {</div><div class="line">  <span class="keyword">select</span> {</div><div class="line">  <span class="keyword">case</span> val := &lt;-q.data:</div><div class="line">    <span class="keyword">return</span> val, <span class="constant">true</span></div><div class="line">  <span class="keyword">default</span>:</div><div class="line">    <span class="keyword">var</span> zero T</div><div class="line">    <span class="keyword">return</span> zero, <span class="constant">false</span></div><div class="line">  }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>æœ€åæˆ‘ä»¬å†™ä¸€ä¸ªå•å…ƒæµ‹è¯•æ¥æµ‹è¯•å®ƒ:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> TestQueue(t *testing.T) {</div><div class="line">  q := NewQueue[<span class="typename">int</span>]<span class="number">(5</span>)</div><div class="line">  <span class="keyword">for</span> i := <span class="keyword">range</span> <span class="built_in">make</span>([]<span class="keyword">struct</span>{},<span class="number"> 5</span>) {</div><div class="line">    q.Push(i)</div><div class="line">  }</div><div class="line">	</div><div class="line">  <span class="keyword">for</span> <span class="keyword">range</span> <span class="built_in">make</span>([]<span class="keyword">struct</span>{},<span class="number"> 5</span>) {</div><div class="line">    t.Log(q.Pop())</div><div class="line">  }</div><div class="line">}</div></pre></td></tr></table></figure>

<h2 id="Option[T]"><code>Option[T]</code></h2>
<p>ä½¿ç”¨Goæ—¶ï¼Œäººä»¬ä¼šæœ‰å¾ˆå¤šåŸå› ä½¿ç”¨æŒ‡é’ˆå€¼ï¼š</p>
<ul>
<li>æŒ‡é’ˆå€¼å¯èƒ½ä¸ºé›¶ï¼Œå› æ­¤å¯ä»¥è¡¨ç¤ºè¯¥å€¼å¯èƒ½ä¸å­˜åœ¨ã€‚</li>
<li>æŒ‡é’ˆå€¼åªåœ¨å†…å­˜ä¸­å­˜å‚¨åç§»é‡ï¼Œå› æ­¤ä¼ é€’è¯¥å€¼ä¼šå¯¼è‡´åªå¤åˆ¶æŒ‡é’ˆï¼Œè€Œä¸ç”¨å¤åˆ¶ä¼ é€’çš„å€¼ã€‚</li>
<li>ä¼ é€’ç»™å‡½æ•°çš„æŒ‡é’ˆå€¼å…è®¸æ‚¨åœ¨ä¼ é€’ä¸­æ”¹å˜å€¼ã€‚å¦åˆ™Goå°†å¤åˆ¶è¯¥å€¼ï¼Œæ‚¨å°±å¯ä»¥éšå¿ƒæ‰€æ¬²åœ°å¯¹å…¶è¿›è¡Œæ›´æ”¹ï¼Œä½†æ‰€åšçš„æ›´æ”¹ä¸ä¼šæŒç»­åˆ°å‡½æ•°è°ƒç”¨ä¹‹åã€‚ä½ å¯ä»¥è®¤ä¸ºè¿™æ˜¯â€œä¸å¯å˜çš„â€ï¼Œä½†å®ƒä¸åƒåœ¨Rustä¸­å‡½æ•°ä¼ é€’é‚£æ ·ä¸¥æ ¼ã€‚</li>
</ul>
<p><code>Optiion[T]</code>ç±»å‹å¯ä»¥å¸®åŠ©æˆ‘ä»¬å¯¹ç¬¬ä¸€æ¡çº¦æŸåˆ›å»ºä¸€ä¸ªå®¹å™¨ï¼šä¸€ä¸ªå€¼å¯èƒ½ä¸å­˜åœ¨ã€‚æˆ‘ä»¬å¯ä»¥è¿™æ ·å®šä¹‰ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Option[T any] <span class="keyword">struct</span> {</div><div class="line">  val *T</div><div class="line">}</div></pre></td></tr></table></figure>

<p>ä½ éœ€è¦ä¸ºè¿™ä¸ªå®¹å™¨å®ç°ä¸€ç»„æ–¹æ³•:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> ErrOptionIsNone = errors.New(<span class="string">"gonads: Option[T] has no value"</span>)</div><div class="line"></div><div class="line"><span class="keyword">func</span> (o Option[T]) Take() (T, error) {</div><div class="line">  <span class="keyword">if</span> o.IsNone() {</div><div class="line">    <span class="keyword">var</span> zero T</div><div class="line">    <span class="keyword">return</span> zero, ErrOptionIsNone</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keyword">return</span> *o.val, <span class="constant">nil</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">func</span> (o *Option[T]) Set(val T) {</div><div class="line">  o.val = &val</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">func</span> (o *Option[T]) Clear() {</div><div class="line">  o.val = <span class="constant">nil</span></div><div class="line">}</div></pre></td></tr></table></figure>

<p>Some other functions that will be useful will be an IsSome function to tell if the Option contains a value. We can use this to also implement an IsNone function that will let you tell if that Option does not contain a value. They will look like this:</p>
<p>å…¶ä»–ä¸€äº›æœ‰ç”¨çš„å‡½æ•°åŒ…æ‹¬<code>IsSome</code>å‡½æ•°ï¼Œç”¨äºåˆ¤æ–­<code>Option</code>æ˜¯å¦åŒ…å«å€¼ã€‚æˆ‘ä»¬è¿˜å¯ä»¥ä¸ºå®ƒå®ç°ä¸€ä¸ª<code>IsNone</code>å‡½æ•°ï¼Œè¯¥å‡½æ•°å°†è®©æ‚¨åˆ¤æ–­è¯¥<code>Option</code>æ˜¯å¦ä¸åŒ…å«å€¼ã€‚å®ƒä»¬çœ‹èµ·æ¥æ˜¯è¿™æ ·çš„ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> (o Option[T]) IsSome() <span class="typename">bool</span> {</div><div class="line">  <span class="keyword">return</span> o.val != <span class="constant">nil</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">func</span> (o Option[T]) IsNone() <span class="typename">bool</span> {</div><div class="line">  <span class="keyword">return</span> !o.IsSome()</div><div class="line">}</div></pre></td></tr></table></figure>

<p>å½“<code>Option</code>æ²¡æœ‰ä¿å­˜æŸä¸ªå€¼æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥è¯´<code>Option</code>ä¸ºç©ºï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>IsSome</code>æ¥å®ç°<code>IsNone</code>ã€‚</p>
<p>æœ€åæˆ‘ä»¬æŠŠè¿™äº›éƒ½æ”¾åœ¨<code>Yank</code>å‡½æ•°ä¸­ï¼Œå®ƒç±»ä¼¼Rustè¯­è¨€ä¸­çš„<code>Option::unwrap()</code>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> (o Option[T]) Yank() T {</div><div class="line">  <span class="keyword">if</span> o.IsNone() {</div><div class="line">    <span class="built_in">panic</span>(<span class="string">"gonads: Yank on None Option"</span>)</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keyword">return</span> *o.val</div><div class="line">}</div></pre></td></tr></table></figure>

<p>å†™ä¸ªGoå•å…ƒæµ‹è¯•æ ¡éªŒå®ƒ:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> TestOption(t *testing.T) {</div><div class="line">  o := NewOption[<span class="typename">string</span>]()</div><div class="line">  val, err := o.Take()</div><div class="line">  <span class="keyword">if</span> err == <span class="constant">nil</span> {</div><div class="line">    t.Fatalf(<span class="string">"[unexpected] wanted no value out of Option[T], got: %v"</span>, val)</div><div class="line">  }</div><div class="line">    </div><div class="line">  o.Set(<span class="string">"hello friendos"</span>)</div><div class="line">  _, err = o.Take()</div><div class="line">  <span class="keyword">if</span> err != <span class="constant">nil</span> {</div><div class="line">    t.Fatalf(<span class="string">"[unexpected] wanted no value out of Option[T], got: %v"</span>, err)</div><div class="line">  }</div><div class="line">    </div><div class="line">  o.Clear()</div><div class="line">  <span class="keyword">if</span> o.IsSome() {</div><div class="line">    t.Fatal(<span class="string">"Option should have none, but has some"</span>)</div><div class="line">  }</div><div class="line">}</div></pre></td></tr></table></figure>

<blockquote>
<p>è„±ç¦»æœ¬ç¯‡æ–‡ç« ï¼Œæˆ‘è®¤ä¸º<code>Option[T]</code>, ä½†æ˜¯å®ƒéœ€è¦æ›´è¿›ä¸€æ­¥çš„å·¥ä½œå’Œæ³›åŒ–ï¼ˆæ‰èƒ½æ›´å¥½çš„åº”ç”¨åœ¨ç”Ÿäº§ç¯å¢ƒï¼‰ï¼Œè¿™åº”å½“æ˜¯Goæ ¸å¿ƒå›¢é˜Ÿå»åšçš„äº‹æƒ…ï¼Œè€Œä¸æ˜¯ç¬¬ä¸‰æ–¹è‡ªå·±å»å®ç°ã€‚</p>
</blockquote>
<h2 id="Thunk[T]"><code>Thunk[T]</code></h2>
<p>åœ¨è®¡ç®—æœºç§‘å­¦ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ç¨‹åºåˆ†æˆæ•°å€¼(value)å’Œè®¡ç®—(computation)ã€‚é€šå¸¸æˆ‘ä»¬ä¼šå¤„ç†å…¶ä¸­ä¸€ä¸ª,æˆ–è€…å¦ä¸€ä¸ªã€‚ä½†æ˜¯æœ‰æ—¶å€™è®¡ç®—ä¹Ÿå¯ä»¥è¢«è§†ä¸ºå€¼ï¼Œä½†è¿™æ˜¯éå¸¸ç½•è§çš„ã€‚æ›´ä¸ºç½•è§çš„æ˜¯ï¼Œå°†éƒ¨åˆ†å®Œæˆçš„è®¡ç®—ç”¨ä½œä¸€ä¸ªå€¼ã€‚</p>
<p><code>thunk</code>æ˜¯ä¸€ç§å­˜å‚¨ä¸ºå€¼çš„éƒ¨åˆ†è®¡ç®—ã€‚ä¸ºäº†äº†è§£æˆ‘æ‰€è¯´çš„å†…å®¹ï¼Œè®©æˆ‘ä»¬è€ƒè™‘ä¸€ä¸‹è¿™ä¸ªJavaScriptå‡½æ•°ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> add = (x, y) =&gt; x + y;</div><div class="line"><span class="built_in">console</span>.log(add(<span class="number">2</span>, <span class="number">2</span>)); <span class="comment">// 4</span></div></pre></td></tr></table></figure>

<p>ä¸Šé¢çš„ä»£ç å®ç°äº†ä¸€ä¸ª<code>add</code>å‡½æ•°å¯¹è±¡ï¼Œéœ€è¦ä¸¤ä¸ªå‚æ•°ï¼Œè¿”å›ä¸€ä¸ªå‚æ•°ã€‚å¾ˆå¤šåœºæ™¯ä¸‹éƒ½ä¼šè¿™ä¹ˆä½¿ç”¨ã€‚ä½†æ˜¯å¦‚æœæˆ‘ä»¬åªç»‘å®šä¸€ä¸ªå‚æ•°ï¼Œè®©å¦ä¸€ä¸ªå‚æ•°åšå˜é‡ï¼Œè¿™ä¼šå˜å¾—å¾ˆå›°éš¾ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥è¿™æ ·å®ç°<code>add</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> add = (x) =&gt; (y) =&gt; x + y;</div><div class="line"><span class="built_in">console</span>.log(add(<span class="number">2</span>)(<span class="number">2</span>)); <span class="comment">// 4</span></div></pre></td></tr></table></figure>

<p>å®ƒéœ€è¦æˆ‘ä»¬éƒ¨åˆ†çš„å®ç°<code>add</code>å‡½æ•°ï¼Œæ¯”å¦‚<code>addTwo</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> addTwo = add(<span class="number">2</span>);</div><div class="line"><span class="built_in">console</span>.log(addTwo(<span class="number">3</span>)); <span class="comment">// 5</span></div></pre></td></tr></table></figure>

<p>ä¹Ÿå¯ä»¥ç”¨åœ¨ä¸éœ€è¦å‚æ•°çš„å‡½æ•°ä¸­ï¼Œè¿™æ ·å®ç°äº†å»¶è¿Ÿè®¡ç®—:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> hypotenuse = (x, y) =&gt; <span class="built_in">Math</span>.sqrt(x * x + y * y);</div><div class="line"><span class="keyword">const</span> thunk = () =&gt; hypot(<span class="number">3</span>, <span class="number">4</span>);</div></pre></td></tr></table></figure>

<p>ä½ å¯ä»¥ä¼ é€’<code>trunk</code>å¯¹è±¡ï¼Œè€Œä¸å¿…ç«‹å³è®¡ç®—å®ƒï¼Œåªæœ‰åœ¨éœ€è¦çš„æ—¶å€™æ‰å»è®¡ç®—ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">dominateWorld(thunk); <span class="comment">// thunk is passed as an unevaluated function</span></div></pre></td></tr></table></figure>

<p>ç°åœ¨æˆ‘ä»¬ä½¿ç”¨Goæ¥å®ç°è¿™ä¸ªç±»å‹:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Thunk[T any] <span class="keyword">struct</span> {</div><div class="line">  doer <span class="keyword">func</span>() T</div><div class="line">}</div></pre></td></tr></table></figure>

<p>ç„¶åä½¿ç”¨<code>Force</code>å‡½æ•°å¼ºåˆ¶<code>Trunk</code>è¿›è¡Œè®¡ç®—:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> (t Thunk[T]) Force() T {</div><div class="line">  <span class="keyword">return</span> t.doer()</div><div class="line">}</div></pre></td></tr></table></figure>

<p>è¿™æ˜¯å¯è¡Œçš„ï¼Œä½†æ˜¯æˆ‘ä»¬ä¹Ÿå¯ä»¥æ¯”JavaScriptç¤ºä¾‹æ›´è¿›ä¸€æ­¥ã€‚æˆ‘ä»¬å¯ä»¥åˆ©ç”¨<code>Thunk[T]</code>å®¹å™¨æ¥ç¼“å­˜<code>doer</code>å‡½æ•°çš„ç»“æœï¼Œè¿™æ ·å¤šæ¬¡è°ƒç”¨å®ƒå®é™…ä¸Šåªä¼šè¿”å›ä¸€æ¬¡ç›¸åŒçš„ç»“æœã€‚</p>
<blockquote>
<p>è¯·è®°ä½ï¼Œè¿™åªé€‚ç”¨äºçº¯å‡½æ•°ï¼Œæˆ–ä¸ä¿®æ”¹å¤–éƒ¨ä¸–ç•Œçš„å‡½æ•°ã€‚è¿™ä¹Ÿä¸ä»…ä»…æ˜¯å…¨å±€å˜é‡ï¼Œè€Œæ˜¯ä»»ä½•å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹ä¿®æ”¹ä»»ä½•çŠ¶æ€çš„å‡½æ•°ï¼ŒåŒ…æ‹¬ç½‘ç»œå’Œæ–‡ä»¶ç³»ç»ŸIOã€‚(å¦‚æœä½ ä¸ç†è§£çº¯å‡½æ•°ï¼Œå¯ä»¥æœç´¢pure functionäº†è§£æ›´å¤š)</p>
</blockquote>
<p>æ‰€ä»¥<code>Trunk[T]</code>å¯ä»¥å®ç°å¦‚ä¸‹:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Thunk[T any] <span class="keyword">struct</span> {</div><div class="line">  doer <span class="keyword">func</span>() T <span class="comment">// action being thunked</span></div><div class="line">  o    *Option[T] <span class="comment">// cache for complete thunk data</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">func</span> (t *Thunk[T]) Force() T {</div><div class="line">  <span class="keyword">if</span> t.o.IsSome() {</div><div class="line">    <span class="keyword">return</span> t.o.Yank()</div><div class="line">  }</div><div class="line">    </div><div class="line">  t.o.Set(t.doer())</div><div class="line">  <span class="keyword">return</span> t.o.Yank()</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">func</span> NewThunk[T any](doer <span class="keyword">func</span>() T) *Thunk[T] {</div><div class="line">  <span class="keyword">return</span> &Thunk[T]{</div><div class="line">    doer: doer,</div><div class="line">    o:    NewOption[T](),</div><div class="line">  }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>ç°åœ¨æ¥ä¸€ä¸ªå¤æ‚ç‚¹çš„ä¾‹å­ï¼Œæˆ‘ä»¬ç”¨å®ƒå®ç°æ–æ³¢é‚£å¥‘å‡½æ•°ã€‚æ–æ³¢é‚£å¥‘å‡½æ•°æ­£è§„çš„ä¾‹å­å¦‚ä¸‹:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> Fib(n <span class="typename">int</span>) <span class="typename">int</span> {</div><div class="line">  <span class="keyword">if</span> n &lt;=<span class="number"> 1</span> {</div><div class="line">    <span class="keyword">return</span> n</div><div class="line">  }</div><div class="line">    </div><div class="line">  <span class="keyword">return</span> Fib(n<span class="number">-1</span>) + Fib(n<span class="number">-2</span>)</div><div class="line">}</div></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å†™ä¸€ä¸ªå•å…ƒæµ‹è¯•çœ‹çœ‹å®ƒçš„æ—¶é—´èŠ±è´¹:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> TestRecurFib(t *testing.T) {</div><div class="line">  t.Log(Fib<span class="number">(40</span>))</div><div class="line">}</div></pre></td></tr></table></figure>

<p>è¿è¡Œgo test,ç»“æœå¦‚ä¸‹:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ go test -run RecurFib</div><div class="line"><span class="header">=== RUN   TestRecurFib</span></div><div class="line"><span class="code">    thunk_test.go:15: 102334155</span></div><div class="line"><span class="bullet">--- </span>PASS: TestRecurFib (0.36s)</div></pre></td></tr></table></figure>

<p>ç„¶è€Œï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨åˆšæ‰å®ç°çš„<code>Trunk[T]</code>å®ç°å®ƒï¼Œä¸è¿‡æ›´å¤æ‚äº†:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> TestThunkFib(t *testing.T) {</div><div class="line">  cache := <span class="built_in">make</span>([]*Thunk[<span class="typename">int</span>],<span class="number"> 41</span>)</div><div class="line">  </div><div class="line">  <span class="keyword">var</span> fib <span class="keyword">func</span>(<span class="typename">int</span>) <span class="typename">int</span></div><div class="line">  fib = <span class="keyword">func</span>(n <span class="typename">int</span>) <span class="typename">int</span> {</div><div class="line">    <span class="keyword">if</span> cache[n].o.IsSome() {</div><div class="line">      <span class="keyword">return</span> *cache[n].o.val</div><div class="line">    }</div><div class="line">    <span class="keyword">return</span> fib(n<span class="number">-1</span>) + fib(n<span class="number">-2</span>)</div><div class="line">  }</div><div class="line">  </div><div class="line">  <span class="keyword">for</span> i := <span class="keyword">range</span> cache {</div><div class="line">    i := i</div><div class="line">    cache[i] = NewThunk(<span class="keyword">func</span>() <span class="typename">int</span> { <span class="keyword">return</span> fib(i) })</div><div class="line">  }</div><div class="line">  cache<span class="number">[0</span>].o.Set<span class="number">(0</span>)</div><div class="line">  cache<span class="number">[1</span>].o.Set<span class="number">(1</span>)</div><div class="line">  </div><div class="line">  t.Log(cache<span class="number">[40</span>].Force())</div><div class="line">}</div></pre></td></tr></table></figure>

<p>æ‰§è¡Œgo test,.è¾“å‡ºç»“æœ:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="header">=== RUN   TestThunkFib</span></div><div class="line"><span class="code">    thunk_test.go:36: 102334155</span></div><div class="line"><span class="bullet">--- </span>PASS: TestThunkFib (0.60s)</div></pre></td></tr></table></figure>

<p>å¥‡æ€ªä¸ï¼Ÿä¸ºä»€ä¹ˆæ›´æ…¢äº†?æˆ‘ä»¬ä¸æ˜¯ç¼“å­˜äº†ä¸­é—´è®¡ç®—çš„ç»“æœäº†ä¹ˆï¼Ÿä¸‹é¢çš„ä»£ç æ˜¯æˆ‘ä»¬å¸¸è§çš„ä¼˜åŒ–ï¼Œæˆ‘ä»¬çš„ç‰ˆæœ¬å’Œä¸‹é¢ä¸æ˜¯ä¸€æ ·çš„ä¹ˆï¼Ÿ</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> TestMemoizedFib(t *testing.T) {</div><div class="line">  mem := <span class="keyword">map</span>[<span class="typename">int</span>]<span class="typename">int</span>{</div><div class="line">   <span class="number"> 0</span>:<span class="number"> 0</span>,</div><div class="line">   <span class="number"> 1</span>:<span class="number"> 1</span>,</div><div class="line">  }</div><div class="line">    </div><div class="line">  <span class="keyword">var</span> fib <span class="keyword">func</span>(<span class="typename">int</span>) <span class="typename">int</span></div><div class="line">  fib = <span class="keyword">func</span>(n <span class="typename">int</span>) <span class="typename">int</span> {</div><div class="line">    <span class="keyword">if</span> result, ok := mem[n]; ok {</div><div class="line">      <span class="keyword">return</span> result</div><div class="line">    }</div><div class="line">        </div><div class="line">    result := fib(n<span class="number">-1</span>) + fib(n<span class="number">-2</span>)</div><div class="line">    mem[n] = result</div><div class="line">    <span class="keyword">return</span> result</div><div class="line">  }</div><div class="line">    </div><div class="line">  t.Log(fib<span class="number">(40</span>))</div><div class="line">}</div></pre></td></tr></table></figure>



<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ go test -run Memoized</div><div class="line"><span class="header">=== RUN   TestMemoizedFib</span></div><div class="line"><span class="code">    thunk_test.go:35: 102334155</span></div><div class="line"><span class="bullet">--- </span>PASS: TestMemoizedFib (0.00s)</div></pre></td></tr></table></figure>

<p>å¦‚æœä½ æŠŠæˆ‘ä»¬ä½¿ç”¨<code>Trunk[T]</code>çš„æ–æ³¢é‚£å¥‘å‡½æ•°æ”¹åŠ¨å¦‚ä¸‹ï¼Œä¹Ÿæ˜¯èƒ½å¿«é€Ÿè·‘å®Œçš„ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">fib = <span class="keyword">func</span>(n <span class="typename">int</span>) <span class="typename">int</span> {</div><div class="line">  <span class="keyword">if</span> cache[n].o.IsSome() {</div><div class="line">    <span class="keyword">return</span> *cache[n].o.val</div><div class="line">  }</div><div class="line">  </div><div class="line">  result := fib(n<span class="number">-1</span>) + fib(n<span class="number">-2</span>)</div><div class="line">  cache[n].o.Set(result)</div><div class="line">  <span class="keyword">return</span> result</div><div class="line">}</div></pre></td></tr></table></figure>



<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="header">=== RUN   TestThunkFib</span></div><div class="line"><span class="code">    thunk_test.go:59: 102334155</span></div><div class="line"><span class="bullet">--- </span>PASS: TestThunkFib (0.00s)</div></pre></td></tr></table></figure>

<p>è¦æ˜ç¡®çš„æ˜¯ï¼Œè¿™ä¸æ˜¯Goæ³›å‹çš„é”™ã€‚æˆ‘å‡ ä¹å¯ä»¥è‚¯å®šçš„æ˜¯ï¼Œæˆ‘ç³Ÿç³•çš„ä»£ç å¯¼è‡´äº†é€Ÿåº¦å¤§å¤§é™ä½ã€‚</p>
<blockquote>
<p>ç½‘å‹æŒ‡å‡ºæˆ‘çš„ä»£ç äº‹å®ä¸Šæ˜¯é”™è¯¯çš„ï¼Œæˆ‘çš„<code>fib</code>å®ç°åº”è¯¥å¦‚ä¸‹:</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">fib = <span class="keyword">func</span>(n <span class="typename">int</span>) <span class="typename">int</span> {</div><div class="line">  <span class="keyword">return</span> cache[n<span class="number">-1</span>].Force() + cache[n<span class="number">-2</span>].Force()</div><div class="line">}</div></pre></td></tr></table></figure>

<p>æˆ‘å¾ˆé«˜å…´Goè¯­è¨€æ·»åŠ äº†æ³›å‹ã€‚è¿™è‚¯å®šä¼šè®©å¾ˆå¤šäº‹æƒ…å˜å¾—æ›´å®¹æ˜“ï¼Œæ›´å¯Œæœ‰è¡¨ç°åŠ›ã€‚æˆ‘æ‹…å¿ƒåœ¨å­¦ä¹ Goæ³›å‹çš„è¿‡ç¨‹ä¼šç»™äººä»¬å¸¦æ¥å¾ˆå¤šéº»çƒ¦ï¼Œã€‚æ³›å‹åº”åœ¨ç‰¹å®šæƒ…å†µä¸‹ä½¿ç”¨ï¼Œè€Œä¸æ˜¯è¢«æ»¥ç”¨ã€‚</p>
<p>æˆ‘å¸Œæœ›è¿™æ˜¯ä¸€ä¸ªå…³äºå¦‚ä½•åœ¨Goä¸­ä½¿ç”¨æ³›å‹çš„æœ‰è¶£ç ”ç©¶ï¼Œä½†è¯·ä¸è¦åœ¨ç”Ÿäº§ä¸­ä½¿ç”¨è¿™äº›ç¤ºä¾‹ã€‚</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>Go 1.18å‘å¸ƒäº†ç¬¬ä¸€ç‰ˆçš„Goæ³›å‹ä¹‹åï¼Œå¤§å®¶å¼€å§‹å¯¹Goæ³›å‹è¿›è¡Œäº†æ·±å…¥çš„ç ”ç©¶ï¼Œä»Šå¤©ç¿»è¯‘çš„è¿™ä¸€ç¯‡ï¼Œæ˜¯åŠ æ‹¿å¤§çš„Xe Iasoåˆšå‡ºç‚‰çš„ä¸€ç¯‡æœ‰è¶£çš„<a href="https://christine.website/blog/gonads-2022-04-24" target="_blank" rel="external">æ–‡ç« </a>ï¼Œå¯¹Goæ³›å‹çš„åº”ç”¨åšäº†ä¸€äº›æ¢ç´¢ã€‚</p>
]]>
    
    </summary>
    
      <category term="go" scheme="https://colobu.com/categories/go/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Uberå·¥ç¨‹å¸ˆå¯¹çœŸå®ä¸–ç•Œå¹¶å‘é—®é¢˜çš„ç ”ç©¶]]></title>
    <link href="https://colobu.com/2022/04/07/A-Study-of-Real-World-Data-Races-in-Golang/"/>
    <id>https://colobu.com/2022/04/07/A-Study-of-Real-World-Data-Races-in-Golang/</id>
    <published>2022-04-07T00:16:19.000Z</published>
    <updated>2022-05-22T08:37:06.155Z</updated>
    <content type="html"><![CDATA[<p>ä»Šå¤©Uberå·¥ç¨‹å¸ˆæ”¾å‡ºä¸€ç¯‡è®ºæ–‡(<a href="https://arxiv.org/abs/2204.00764" target="_blank" rel="external">A Study of Real-World Data Races in Golang</a>)ï¼Œä½œè€…æ˜¯Uberçš„å·¥ç¨‹å¸ˆMilind Chabbiå’ŒMurali Krishna Ramanathanï¼Œä»–ä»¬è´Ÿè´£ä½¿ç”¨Goå†…å»ºçš„data race detectoråœ¨Uberå†…çš„è½åœ°ï¼Œç»è¿‡6ä¸ªå¤šæœˆçš„ç ”ç©¶åˆ†æï¼Œä»–ä»¬å°†data race detectoræˆåŠŸè½åœ°ï¼Œå¹¶åŸºäºå¯¹å¤šä¸ªé¡¹ç›®çš„åˆ†æï¼Œå¾—å‡ºäº†ä¸€äº›æœ‰è¶£çš„ç»“è®ºã€‚</p>
<a id="more"></a>
<p>æˆ‘ä»¬çŸ¥é“ï¼ŒGoæ˜¯Uberå…¬å¸çš„ä¸»æ‰“ç¼–ç¨‹è¯­è¨€ã€‚ä»–ä»¬å¯¹Uberçš„2100ä¸ªä¸åŒçš„å¾®æœåŠ¡ï¼Œ4600ä¸‡è¡ŒGoä»£ç çš„åˆ†æï¼Œå‘ç°äº†è¶…è¿‡2000ä¸ªçš„æœ‰æ•°æ®ç«äº‰çš„bug, ä¿®å¤äº†å…¶ä¸­çš„1000å¤šä¸ªï¼Œå‰©ä½™çš„æ­£åœ¨åˆ†æä¿®å¤ä¸­ã€‚</p>
<p>è°ˆèµ·çœŸå®ä¸–ç•Œä¸­çš„Goå¹¶å‘Bug,å…¶å®2019å¹´æˆ‘ä»¬åäººå­¦è€…çš„<a href="https://songlh.github.io/paper/go-study.pdf" target="_blank" rel="external">Understanding Real-World Concurrency Bugs in Go</a>è®ºæ–‡å¯ä»¥è¯´æ˜¯å¼€å±±ä¹‹ä½œï¼Œé¦–æ¬¡å…¨é¢ç³»ç»Ÿåœ°åˆ†æäº†å‡ ä¸ªæµè¡Œçš„å¤§å‹Goé¡¹ç›®çš„å¹¶å‘bugã€‚ä»Šå¤©è°ˆçš„è¿™ä¸€ç¯‡å‘¢ï¼Œæ˜¯Uberå·¥ç¨‹å¸ˆé’ˆå¯¹Uberçš„ä¼—å¤šçš„Goä»£ç åšçš„åˆ†æã€‚æˆ‘çŒœä»–ä»¬å¯èƒ½æ˜¯ç±»ä¼¼å›½å†…å·¥ç¨‹æ•ˆèƒ½éƒ¨çš„åŒå­¦ï¼Œæ‰€ä»¥è¿™ç¯‡è®ºæ–‡æœ‰ä¸€åŠçš„ç¯‡å¹…ä»‹ç»Go data race detectoræ˜¯æ€ä¹ˆè½åœ°çš„ï¼Œè¿™ä¸ªæˆ‘ä»¬å°±ä¸è¯¦ç»†è®²äº†ï¼Œè¿™ç¯‡è®ºæ–‡çš„å¦ä¸€åŠæ˜¯åŸºäºå¯¹data raceçš„åˆ†æï¼Œç½—åˆ—å‡ºäº†å¸¸è§çš„å‡ºç°data raceçš„åœºæ™¯ï¼Œå¯¹æˆ‘ä»¬GopheråŒå­¦æ¥è¯´ï¼Œå¾ˆæœ‰å­¦ä¹ çš„æ„ä¹‰ï¼Œæ‰€ä»¥æˆ‘æ™šä¸Šå¥½å¥½æ‹œè¯»äº†ä¸€ä¸‹è¿™ç¯‡è®ºæ–‡ï¼Œåšä¸€æ€»ç»“å’Œæ‘˜è¦ã€‚</p>
<p>ä½œä¸ºä¸€ä¸ªå¤§å‚ï¼Œè‚¯å®šä¸æ­¢ä¸€ç§å¼€å‘è¯­è¨€ï¼Œä½œè€…å¯¹Uberçº¿ä¸Šä¸ªç¼–ç¨‹è¯­è¨€(goã€javaã€nodejsã€python)è¿›è¡Œåˆ†æï¼Œå¯ä»¥çœ‹åˆ°ï¼š</p>
<ol>
<li>ç›¸æ¯”è¾ƒJavaï¼Œ åœ¨Goè¯­è¨€ä¸­ä¼šæ›´å¤šçš„ä½¿ç”¨å¹¶å‘å¤„ç†</li>
<li>åŒä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œnodejså¹³å‡ä¼šå¯åŠ¨16ä¸ªçº¿ç¨‹ï¼Œpythonä¼šå¯åŠ¨16-32ä¸ªçº¿ç¨‹ï¼Œjavaè¿›ç¨‹ä¸€èˆ¬å¯åŠ¨128-1024ä¸ªçº¿ç¨‹ï¼Œ10%çš„Javaç¨‹åºå¯åŠ¨4096ä¸ªçº¿ç¨‹ï¼Œ7%çš„javaç¨‹åºå¯åŠ¨8192ä¸ªçº¿ç¨‹ã€‚Goç¨‹åºä¸€èˆ¬å¯åŠ¨1024-4096ä¸ªgoroutine,6%çš„Goç¨‹åºå¯åŠ¨8192ä¸ªgoroutine(åŸæ–‡æ˜¯8102ï¼Œæˆ‘è®¤ä¸ºæ˜¯ä¸€ä¸ªç¬”è¯¯)ï¼Œæœ€å¤§13ä¸‡ä¸ªã€‚</li>
</ol>
<p>å¯ä»¥çœ‹åˆ°Goç¨‹åºä¼šæ¯”å…¶å®ƒè¯­è¨€æœ‰æ›´å¤šçš„å¹¶å‘å•å…ƒï¼Œæ›´å¤šçš„å¹¶å‘å•å…ƒæ„å‘³ç€å­˜åœ¨ç€æ›´å¤šçš„å¹¶å‘bugã€‚Uberä»£ç åº“ä¸­éƒ½æœ‰å“ªäº›ç±»çš„å¹¶å‘bugå‘¢ï¼Ÿ</p>
<p>ä¸‹é¢çš„ä»‹ç»ä¼šå¾ˆå¤šçš„ä½¿ç”¨æ•°æ®ç«äº‰æ¦‚å¿µ(data race)ï¼Œå®ƒæ˜¯å¹¶å‘ç¼–ç¨‹ä¸­å¸¸è§çš„æ¦‚å¿µï¼Œæœ‰æ•°æ®ç«äº‰ï¼Œæ„å‘³ç€æœ‰å¤šä¸ªå¹¶å‘å•å…ƒå¯¹åŒä¸€ä¸ªæ•°æ®èµ„æºæœ‰å¹¶å‘çš„è¯»å†™ï¼Œè‡³å°‘æœ‰ä¸€ä¸ªå†™ï¼Œæœ‰å¯èƒ½ä¼šå¯¼è‡´å¹¶å‘é—®é¢˜ã€‚</p>
<h2 id="é€æ˜åœ°å¼•ç”¨æ•è·_(Transparent_Capture-by-Reference)">é€æ˜åœ°å¼•ç”¨æ•è· (Transparent Capture-by-Reference)</h2>
<p>ç›´æ¥ç¿»è¯‘è¿‡æ¥ä½ å¯èƒ½è§‰å¾—ä¸çŸ¥æ‰€äº‘ã€‚Transparentæ˜¯æŒ‡æ²¡æœ‰æ˜¾ç¤ºçš„å£°æ˜æˆ–è€…å®šä¹‰ï¼Œå°±ç›´æ¥å¼•ç”¨æŸäº›å˜é‡ï¼Œå¾ˆå®¹æ˜“å¯¼è‡´æ•°æ®ç«äº‰ã€‚é€šè¿‡ä¾‹å­æ›´å®¹æ˜“ç†è§£ã€‚è¿™æ˜¯ä¸€å¤§ç±»ï¼Œæˆ‘ä»¬åˆ†æˆå°ç±»é€ä¸€ä»‹ç»ã€‚</p>
<h3 id="å¾ªç¯å˜é‡çš„æ•è·">å¾ªç¯å˜é‡çš„æ•è·</h3>
<p>ä¸å¾—ä¸è¯´ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘æœ€å¸¸çŠ¯çš„é”™è¯¯ã€‚è™½ç„¶æ˜æ˜çŸ¥é“ä¼šæœ‰è¿™æ ·çš„é—®é¢˜ï¼Œä½†æ˜¯åœ¨å¼€å‘çš„è¿‡ç¨‹ä¸­ï¼Œæ€»æ˜¯æ— æ„çš„çŠ¯è¿™æ ·çš„é”™è¯¯ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> _ , job := <span class="keyword">range</span> jobs {</div><div class="line"> <span class="keyword">go</span> <span class="keyword">func</span> () {</div><div class="line">   ProcessJob ( job )</div><div class="line"> }()</div><div class="line"> } <span class="comment">// end for</span></div></pre></td></tr></table></figure>

<p>æ¯”å¦‚è¿™ä¸ªç®€å•çš„ä¾‹å­,jobæ˜¯ç´¢å¼•å˜é‡ï¼Œå¾ªç¯ä¸­å¯åŠ¨äº†ä¸€ä¸ªgoroutineå¤„ç†è¿™ä¸ªjobã€‚jobå˜é‡å°±é€æ˜åœ°è¢«è¿™ä¸ªgoroutineå¼•ç”¨ã€‚</p>
<p>å¾ªç¯å˜é‡æ˜¯å”¯ä¸€çš„ï¼Œæ„å‘³ç€å¯åŠ¨çš„è¿™ä¸ªgoroutine,æœ‰å¯èƒ½å¤„ç†çš„éƒ½æ˜¯åŒä¸€ä¸ªjob,è€Œå¹¶ä¸æ˜¯æœŸæœ›çš„æ²¡æœ‰ä¸€ä¸ªjobã€‚</p>
<p>è¿™ä¸ªä¾‹å­è¿˜å¾ˆæ˜æ˜¾ï¼Œæœ‰æ—¶å€™å¾ªç¯ä½“å†…ç‰¹åˆ«å¤æ‚ï¼Œå¯èƒ½å¹¶ä¸åƒè¿™ä¸ªä¾‹å­é‚£ä¹ˆå®¹æ˜“å‘ç°ã€‚</p>
<h3 id="errå˜é‡è¢«æ•è·">errå˜é‡è¢«æ•è·</h3>
<p>ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼Œy,zçš„èµ‹å€¼æ—¶ï¼Œä¼šå¯¹åŒä¸€ä¸ªerrè¿›è¡Œå†™æ“ä½œï¼Œä¹Ÿå¯èƒ½ä¼šå¯¼è‡´æ•°æ®ç«äº‰ï¼Œäº§ç”Ÿå¹¶å‘é—®é¢˜ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">x , err := Foo ()</div><div class="line"><span class="keyword">if</span> err != <span class="constant">nil</span> {</div><div class="line">...</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">go</span> <span class="keyword">func</span> () {</div><div class="line"> <span class="keyword">var</span> y <span class="typename">int</span></div><div class="line"> y , err = Bar ()</div><div class="line">  <span class="keyword">if</span> err != <span class="constant">nil</span> {</div><div class="line">  ...</div><div class="line">  }</div><div class="line">}()</div><div class="line"></div><div class="line"><span class="keyword">var</span> z <span class="typename">string</span></div><div class="line">z , err = Baz ()</div><div class="line"><span class="keyword">if</span> err != <span class="constant">nil</span> {</div><div class="line">...</div><div class="line">}</div></pre></td></tr></table></figure>

<h3 id="æ•è·å‘½åçš„è¿”å›å€¼">æ•è·å‘½åçš„è¿”å›å€¼</h3>
<p>ä¸‹é¢è¿™ä¸ªä¾‹å­å®šä¹‰äº†ä¸€ä¸ªå‘½åçš„è¿”å›å€¼<code>result</code>ã€‚å¯ä»¥çœ‹åˆ° <code>... = result</code>ï¼ˆè¯»æ“ä½œï¼‰å’Œ<code>return 20</code> (å†™æ“ä½œ)æœ‰æ•°æ®ç«äº‰çš„é—®é¢˜ï¼Œè™½ç„¶<code>return 20</code>ä½ å¹¶æ²¡æœ‰çœ‹åˆ°å¯¹resultçš„èµ‹å€¼ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> NamedReturnCallee () ( result <span class="typename">int</span>) {</div><div class="line">  result =<span class="number"> 10</span></div><div class="line">  <span class="keyword">if</span> ... {</div><div class="line">    <span class="keyword">return</span> <span class="comment">// this has the effect of " return 10"</span></div><div class="line">  }</div><div class="line">  <span class="keyword">go</span> <span class="keyword">func</span> () {</div><div class="line">   ... = result <span class="comment">// read result</span></div><div class="line">  }()</div><div class="line">  <span class="keyword">return</span><span class="number"> 20</span> <span class="comment">// this is equivalent to result =20</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">func</span> Caller () {</div><div class="line"> retVal := NamedReturnCallee ()</div><div class="line">}</div></pre></td></tr></table></figure>

<p><code>defer</code>ä¹Ÿä¼šæœ‰ç±»ä¼¼çš„æ•ˆæœ,ä¸‹é¢è¿™æ®µä»£ç å¯¹erræœ‰æ•°æ®ç«äº‰é—®é¢˜ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">func</span> Redeem ( request Entity ) ( resp Response , err error )</div><div class="line">{</div><div class="line"> <span class="keyword">defer</span> <span class="keyword">func</span> () {</div><div class="line">  resp , err = c . Foo ( request , err )</div><div class="line"> }()</div><div class="line"> err = CheckRequest ( request )</div><div class="line"> ... <span class="comment">// err check but no return</span></div><div class="line"> <span class="keyword">go</span> <span class="keyword">func</span> () {</div><div class="line">  ProcessRequest ( request , err != <span class="constant">nil</span> )</div><div class="line"> }()</div><div class="line"> <span class="keyword">return</span> <span class="comment">// the defer function runs after here</span></div><div class="line"> }</div></pre></td></tr></table></figure>

<h2 id="Sliceç›¸å…³çš„æ•°æ®ç«äº‰">Sliceç›¸å…³çš„æ•°æ®ç«äº‰</h2>
<p>ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼Œ<code>safeAppend</code>ä½¿ç”¨é”å¯¹<code>myResults</code>è¿›è¡Œäº†ä¿æŠ¤ï¼Œä½†æ˜¯åœ¨æ¯æ¬¡å¾ªç¯è°ƒç”¨<code>(uuid, myResults)</code>å¹¶æ²¡æœ‰è¯»ä¿æŠ¤ï¼Œä¹Ÿä¼šæœ‰ç«äº‰é—®é¢˜ï¼Œè€Œä¸”ä¸å®¹æ˜“å‘ç°ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> ProcessAll ( uuids [] <span class="typename">string</span> ) {</div><div class="line"> <span class="keyword">var</span> myResults [] <span class="typename">string</span></div><div class="line"> <span class="keyword">var</span> mutex sync . Mutex</div><div class="line"> safeAppend := <span class="keyword">func</span> ( res <span class="typename">string</span> ) {</div><div class="line"> mutex.Lock ()</div><div class="line">  myResults = <span class="built_in">append</span> ( myResults , res )</div><div class="line"> mutex.Unlock ()</div><div class="line"> }</div><div class="line"></div><div class="line"> <span class="keyword">for</span> _ , uuid := <span class="keyword">range</span> uuids {</div><div class="line"> <span class="keyword">go</span> <span class="keyword">func</span> ( id <span class="typename">string</span> , results [] <span class="typename">string</span> ) {</div><div class="line"> res := Foo ( id )</div><div class="line"> safeAppend ( res )</div><div class="line">  }( uuid , myResults ) <span class="comment">// slice read without holding lock</span></div><div class="line"> }</div><div class="line"> ...</div><div class="line"> }</div></pre></td></tr></table></figure>

<h2 id="éçº¿ç¨‹å®‰å…¨çš„map">éçº¿ç¨‹å®‰å…¨çš„map</h2>
<p>è¿™ä¸ªå¾ˆå¸¸è§äº†ï¼Œå‡ ä¹æ¯ä¸ªGopheréƒ½æ›¾çŠ¯è¿‡ï¼ŒçŠ¯è¿‡æ‰æ„è¯†åˆ°Goå†…å»ºçš„mapå¯¹è±¡å¹¶ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œéœ€è¦åŠ é”æˆ–è€…ä½¿ç”¨sync.Mapç­‰å…¶å®ƒå¹¶å‘åŸè¯­ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> processOrders ( uuids [] <span class="typename">string</span> ) error {</div><div class="line"><span class="keyword">var</span> errMap = <span class="built_in">make</span> ( <span class="keyword">map</span> [ <span class="typename">string</span> ] error )</div><div class="line"><span class="keyword">for</span> _ , uuid := <span class="keyword">range</span> uuids {</div><div class="line"><span class="keyword">go</span> <span class="keyword">func</span> ( uuid <span class="typename">string</span> ) {</div><div class="line">orderHandle , err := GetOrder ( uuid )</div><div class="line"><span class="keyword">if</span> err != <span class="constant">nil</span> {</div><div class="line">â–¶ errMap [ uuid ] = err</div><div class="line"><span class="keyword">return</span></div><div class="line">}</div><div class="line">...</div><div class="line">}( uuid )</div><div class="line"><span class="keyword">return</span> combineErrors ( errMap )</div><div class="line">}</div></pre></td></tr></table></figure>

<h2 id="ä¼ å€¼å’Œä¼ å¼•ç”¨çš„è¯¯ç”¨">ä¼ å€¼å’Œä¼ å¼•ç”¨çš„è¯¯ç”¨</h2>
<p>Goæ ‡å‡†åº“å¸¸è§å¹¶å‘åŸè¯­ä¸å…è®¸åœ¨ä½¿ç”¨åCopy, go vetä¹Ÿèƒ½æ£€æŸ¥å‡ºæ¥ã€‚æ¯”å¦‚ä¸‹é¢çš„ä»£ç ï¼Œä¸¤ä¸ªgoroutineæƒ³å…±äº«mutex,éœ€è¦ä¼ é€’<code>&amp;mutex</code>,è€Œä¸æ˜¯<code>mutex</code>ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> a <span class="typename">int</span></div><div class="line"><span class="comment">// CriticalSection receives a copy of mutex .</span></div><div class="line"><span class="keyword">func</span> CriticalSection ( m sync . Mutex ) {</div><div class="line">m.Lock ()</div><div class="line"> a ++</div><div class="line">m.Unlock ()</div><div class="line">}</div><div class="line"><span class="keyword">func</span> main () {</div><div class="line">mutex := sync . Mutex {}</div><div class="line"><span class="comment">// passes a copy of m to A .</span></div><div class="line"><span class="keyword">go</span> CriticalSection ( mutex )</div><div class="line"><span class="keyword">go</span> CriticalSection ( mutex )</div><div class="line">}</div></pre></td></tr></table></figure>

<h2 id="æ··ç”¨æ¶ˆæ¯ä¼ é€’å’Œå…±äº«å†…å­˜ä¸¤ç§å¹¶å‘æ–¹å¼">æ··ç”¨æ¶ˆæ¯ä¼ é€’å’Œå…±äº«å†…å­˜ä¸¤ç§å¹¶å‘æ–¹å¼</h2>
<p>æ¶ˆæ¯ä¼ é€’å¸¸ç”¨channelã€‚ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œå¦‚æœcontextå› ä¸ºè¶…æ—¶æˆ–è€…ä¸»åŠ¨cancelè¢«å–æ¶ˆçš„è¯ï¼ŒStartä¸­çš„goroutineä¸­çš„<code>f.ch &lt;- 1</code>å¯èƒ½ä¼šè¢«æ°¸è¿œé˜»å¡ï¼Œå¯¼è‡´goroutineæ³„éœ²ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> ( f * Future ) Start () {</div><div class="line"><span class="keyword">go</span> <span class="keyword">func</span> () {</div><div class="line">resp , err := f.f () <span class="comment">// invoke a registered function</span></div><div class="line"> f.response = resp</div><div class="line"> f.err = err</div><div class="line"> f.ch &lt;-<span class="number"> 1</span> <span class="comment">// may block forever !</span></div><div class="line">}()</div><div class="line">}</div><div class="line"><span class="keyword">func</span> ( f * Future ) Wait ( ctx context . Context ) error {</div><div class="line"><span class="keyword">select</span> {</div><div class="line"><span class="keyword">case</span> &lt;-f.ch :</div><div class="line"><span class="keyword">return</span> <span class="constant">nil</span></div><div class="line"><span class="keyword">case</span> &lt;- ctx.Done () :</div><div class="line"> f.err = ErrCancelled</div><div class="line"><span class="keyword">return</span> ErrCancelled</div><div class="line">}</div></pre></td></tr></table></figure>

<h2 id="å¹¶å‘æµ‹è¯•">å¹¶å‘æµ‹è¯•</h2>
<p>Goçš„<code>testing.T.Parallel()</code>ä¸ºå•å…ƒæµ‹è¯•æä¾›äº†å¹¶å‘èƒ½åŠ›ï¼Œæˆ–è€…å¼€å‘è€…è‡ªå·±å†™ä¸€äº›å¹¶å‘çš„æµ‹è¯•ç¨‹åºæµ‹è¯•ä»£ç é€»è¾‘ï¼Œåœ¨è¿™äº›å¹¶å‘æµ‹è¯•ä¸­ï¼Œä¹Ÿæ˜¯æœ‰å¯èƒ½å¯¼è‡´æ•°æ®ç«äº‰çš„ã€‚ä¸è¦ä»¥ä¸ºæµ‹è¯•ä¸ä¼šæœ‰æ•°æ®ç«äº‰é—®é¢˜ã€‚</p>
<h2 id="ä¸æ­£ç¡®çš„é”è°ƒç”¨">ä¸æ­£ç¡®çš„é”è°ƒç”¨</h2>
<h3 id="ä¸ºå†™æ“ä½œç”³è¯·è¯»é”">ä¸ºå†™æ“ä½œç”³è¯·è¯»é”</h3>
<p>ä¸‹é¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>g.ready</code>æ˜¯å†™æ“ä½œï¼Œå¯æ˜¯è¿™ä¸ªå‡½æ•°è°ƒç”¨çš„æ˜¯è¯»é”ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> ( g * HealthGate ) updateGate () {</div><div class="line">g.mutex.RLock ()</div><div class="line"><span class="keyword">defer</span> g.mutex.RUnlock ()</div><div class="line"><span class="comment">// ... several read - only operations ...</span></div><div class="line"><span class="keyword">if</span> ... {</div><div class="line"> g.ready = <span class="constant">true</span> <span class="comment">// Concurrent writes .</span></div><div class="line"> g.gate.Accept () <span class="comment">// More than one Accept () .</span></div><div class="line">}</div></pre></td></tr></table></figure>

<h3 id="å…¶å®ƒé”çš„é—®é¢˜">å…¶å®ƒé”çš„é—®é¢˜</h3>
<p>ä½ ä¼šå‘ç°ï¼Œå¤§å®¶ç»å¸¸çŠ¯çš„ä¸€ä¸ªâ€œå¼±æ™ºâ€çš„é—®é¢˜ï¼Œå°±æ˜¯Mutexåªæœ‰Lockæˆ–è€…åªæœ‰Unlock,æˆ–è€…ä¸¤ä¸ªLock,è¿™ç±»é—®é¢˜æœ¬æ¥ä½ è®¤ä¸ºç»ä¸ä¼šå‡ºç°çš„ï¼Œåœ¨ç°å®ä¸­å´ç»å¸¸èƒ½çœ‹åˆ°ã€‚</p>
<p>è¿˜æœ‰ä½¿ç”¨<code>atomic</code>è¿›è¡ŒåŸå­å†™ï¼Œä½†æ˜¯å´æ²¡æœ‰åŸå­è¯»ã€‚</p>
<blockquote>
<p>æˆ‘è®¤ä¸ºè¿™é‡ŒUberå·¥ç¨‹å¸ˆå¹¶æ²¡æœ‰å…¨é¢è¯¦ç»†çš„ä»‹ç»ä½¿ç”¨é”å¸¸è§çš„ä¸€äº›é™·é˜±ï¼Œæ¨èä½ å­¦ä¹ æå®¢æ—¶é—´ä¸­çš„<a href="https://time.geekbang.org/column/intro/355" target="_blank" rel="external">Go å¹¶å‘ç¼–ç¨‹å®æˆ˜è¯¾</a>è¯¾ç¨‹ï¼Œæ­¤è¯¾ç¨‹è¯¦ç»†ä»‹ç»äº†æ¯ä¸ªå¹¶å‘åŸè¯­çš„é™·é˜±å’Œæ­»é”æƒ…å†µã€‚</p>
</blockquote>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>æ€»ç»“ä¸€ä¸‹ï¼Œä¸‹è¡¨åˆ—å‡ºäº†åŸºäºè¯­è¨€ç±»å‹ç»Ÿè®¡çš„æ•°æ®ç«äº‰bugæ•°ï¼š</p>
<p><img src="2.png" alt=""></p>
<p>æ•´ä½“æ¥çœ‹ï¼Œé”çš„è¯¯ç”¨æ˜¯æœ€å¤§çš„æ•°æ®ç«äº‰çš„åŸå› ã€‚å¹¶å‘è®¿é—®sliceå’Œmapä¹Ÿæ˜¯å¾ˆå¸¸è§çš„æ•°æ®ç«äº‰çš„åŸå› ã€‚<br><img src="3.png" alt=""></p>
]]></content>
    <summary type="html">
    <![CDATA[<p>ä»Šå¤©Uberå·¥ç¨‹å¸ˆæ”¾å‡ºä¸€ç¯‡è®ºæ–‡(<a href="https://arxiv.org/abs/2204.00764" target="_blank" rel="external">A Study of Real-World Data Races in Golang</a>)ï¼Œä½œè€…æ˜¯Uberçš„å·¥ç¨‹å¸ˆMilind Chabbiå’ŒMurali Krishna Ramanathanï¼Œä»–ä»¬è´Ÿè´£ä½¿ç”¨Goå†…å»ºçš„data race detectoråœ¨Uberå†…çš„è½åœ°ï¼Œç»è¿‡6ä¸ªå¤šæœˆçš„ç ”ç©¶åˆ†æï¼Œä»–ä»¬å°†data race detectoræˆåŠŸè½åœ°ï¼Œå¹¶åŸºäºå¯¹å¤šä¸ªé¡¹ç›®çš„åˆ†æï¼Œå¾—å‡ºäº†ä¸€äº›æœ‰è¶£çš„ç»“è®ºã€‚</p>
]]>
    
    </summary>
    
      <category term="Go" scheme="https://colobu.com/categories/Go/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[æœ€å¸¸ç”¨çš„æ¶æ„æ¨¡å¼]]></title>
    <link href="https://colobu.com/2022/03/06/most-useful-software-architecture-patterns/"/>
    <id>https://colobu.com/2022/03/06/most-useful-software-architecture-patterns/</id>
    <published>2022-03-06T08:48:44.000Z</published>
    <updated>2022-03-06T09:46:52.573Z</updated>
    <content type="html"><![CDATA[<blockquote>
<p>è§‚å…¶è®¾è®¡çŸ¥å…¶äºº</p>
<p>A MAN is KNOWN by the DESIGN he keeps</p>
</blockquote>
<p>åŸæ–‡:<a href="https://shadman-jamil.medium.com/most-useful-software-architecture-patterns-68e171405292" target="_blank" rel="external">Most Useful Software Architecture Patterns</a> by Shadman Jamil</p>
<a id="more"></a>
<p><img src="Software-Architecture.png" alt=""></p>
<h2 id="åˆ†å±‚æ¨¡å¼_(Layered_Pattern_(n-tier))">åˆ†å±‚æ¨¡å¼ (Layered Pattern (n-tier))</h2>
<p>åˆ†å±‚æ¶æ„æ¨¡å¼æ˜¯æœ€å¸¸è§çš„æ¨¡å¼ä¹‹ä¸€ã€‚åˆ†å±‚æ¨¡å¼èƒŒåçš„ç†å¿µæ˜¯ï¼Œå…·æœ‰ç›¸åŒåŠŸèƒ½çš„ç»„ä»¶å°†è¢«ç»„ç»‡æˆæ°´å¹³å±‚ã€‚å› æ­¤ï¼Œæ¯ä¸€å±‚åœ¨åº”ç”¨ç¨‹åºä¸­éƒ½æ‰®æ¼”ç€ç‰¹å®šçš„è§’è‰²ã€‚</p>
<p>åœ¨è¿™ç§æ¨¡å¼ä¸­ï¼Œæˆ‘ä»¬å¯¹åº”ç”¨ç¨‹åºå¯ä»¥æ‹¥æœ‰çš„å±‚æ•°æ²¡æœ‰é™åˆ¶ã€‚åœ¨è¿™æ–¹é¢ï¼Œæˆ‘ä»¬è¿˜æå€¡å…³æ³¨ç‚¹åˆ†ç¦»çš„æ¦‚å¿µã€‚åˆ†å±‚æ¨¡å¼é£æ ¼æŠ½è±¡äº†æ•´ä¸ªè½¯ä»¶çš„è§†å›¾ï¼›åŒæ—¶æä¾›è¶³å¤Ÿçš„ç»†èŠ‚ï¼Œä»¥äº†è§£å„ä¸ªå±‚çš„è§’è‰²å’ŒèŒè´£ä»¥åŠå®ƒä»¬ä¹‹é—´çš„å…³ç³»ã€‚åˆ†å±‚æ¨¡å¼çš„å…¸å‹å®ç°å¦‚ä¸‹ï¼š</p>
<ul>
<li>UIå±•ç¤ºå±‚(<strong>UI / Presentation Layer</strong>): æ¸²æŸ“å¹¶è¿è¡Œç”¨æˆ·ç•Œé¢ï¼Œå‘æœåŠ¡å™¨åº”ç”¨ç¨‹åºå‘é€è¯·æ±‚ã€‚</li>
<li>åº”ç”¨å±‚(<strong>Application Layer</strong>): åŒ…å«è¡¨ç¤ºå±‚ã€åº”ç”¨ç¨‹åºå±‚ã€åŸŸå¯¹è±¡å±‚å’ŒæŒä¹…åŒ–å±‚ã€‚</li>
<li>åŸŸå¯¹è±¡å±‚/ä¸šåŠ¡å±‚(<strong>Domain / Business Layer</strong>): è¯¥å±‚åŒ…å«æ‰€æœ‰ä¸šåŠ¡é€»è¾‘ã€å®ä½“ã€äº‹ä»¶å’Œå…¶ä»–åŒ…å«ä¸šåŠ¡é€»è¾‘çš„å¯¹è±¡ç±»å‹ã€‚</li>
<li>æ•°æ®åº“å±‚(<strong>Database Layer</strong>): è¿™æ˜¯æ•°æ®å±‚ï¼Œç”¨äºæŒä¹…åŒ–æ•°æ®ï¼Œåº”ç”¨æœåŠ¡å™¨å°†ä½¿ç”¨è¿™äº›æ•°æ®ã€‚</li>
</ul>
<p><img src="layers.png" alt=""></p>
<p><strong>ä¾‹å­</strong>: æ¡Œé¢åº”ç”¨ç¨‹åºã€ç”µå­å•†åŠ¡ã€webåº”ç”¨ç¨‹åºç­‰ã€‚</p>
<blockquote>
<p>å‚è€ƒä¾‹å­ï¼š <a href="https://github.com/bxcodec/go-clean-arch" target="_blank" rel="external">go-clean-arch</a></p>
</blockquote>
<h2 id="å®¢æˆ·ç«¯-æœåŠ¡å™¨æ¨¡å¼_(Client-Server_Pattern)">å®¢æˆ·ç«¯-æœåŠ¡å™¨æ¨¡å¼ (Client-Server Pattern)</h2>
<p>è¿™æ˜¯æœ€ç®€å•çš„æ¶æ„æ¨¡å¼ï¼Œç”±ä¸€å°æœåŠ¡å™¨å’Œå¤šä¸ªå®¢æˆ·ç«¯ç»„æˆã€‚è¿™ç§æ¨¡å¼æ˜¯ä¸€ç§åˆ†å¸ƒå¼æ¶æ„ï¼Œåœ¨èµ„æº/æœåŠ¡çš„æä¾›è€…ï¼ˆç§°ä¸ºæœåŠ¡å™¨ï¼‰å’ŒæœåŠ¡è¯·æ±‚è€…ï¼ˆç§°ä¸ºå®¢æˆ·ç«¯ï¼‰ä¹‹é—´åˆ’åˆ†ä»»åŠ¡/å·¥ä½œè´Ÿè½½ã€‚</p>
<p>åœ¨å®¢æˆ·ç«¯-æœåŠ¡å™¨æ¨¡å¼ä¸­ï¼Œå½“å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€æ•°æ®è¯·æ±‚æ—¶ï¼ŒæœåŠ¡å™¨æ¥å—è¯·æ±‚çš„è¿›ç¨‹ï¼Œå¹¶å‘å®¢æˆ·æœºå‘é€æ‰€éœ€çš„æ•°æ®ã€‚å®¢æˆ·ä¸å…±äº«ä»–ä»¬çš„ä»»ä½•èµ„æºã€‚</p>
<p><img src="client-server.png" alt=""></p>
<p><strong>ä¾‹å­</strong>: Emailã€æ–‡æ¡£å…±äº«ã€é“¶è¡Œç­‰</p>
<h2 id="äº‹ä»¶æ€»çº¿æ¨¡å¼_(Event-Bus_Pattern_(Event-Driven_Architecture))">äº‹ä»¶æ€»çº¿æ¨¡å¼ (Event-Bus Pattern (Event-Driven Architecture))</h2>
<p>è¯¥æ¨¡å¼æ˜¯ä¸€ç§åˆ†å¸ƒå¼å¼‚æ­¥ä½“ç³»æ¶æ„æ¨¡å¼ï¼Œç”¨äºåˆ›å»ºé«˜åº¦å¯æ‰©å±•çš„å“åº”å¼åº”ç”¨ç¨‹åºã€‚é€‚ç”¨äºä»å°å‹åˆ°å¤æ‚çš„å„çº§åº”ç”¨ç¨‹åºæŠ€æœ¯æ ˆã€‚æ­¤æ¨¡å¼çš„ä¸»è¦æ€æƒ³æ˜¯å¼‚æ­¥ä¼ é€’å’Œå¤„ç†äº‹ä»¶ã€‚</p>
<p>è¿™ä¸ªæ¨¡å¼åŒ…å«å››ä¸ªç»„ä»¶:</p>
<ol>
<li>äº‹ä»¶æº(Event Source)</li>
<li>äº‹ä»¶ç›‘å¬å™¨(Event Listener)</li>
<li>é€šé“(Channel)</li>
<li>äº‹ä»¶æ€»çº¿(Event Bus)</li>
</ol>
<p>æºå°†æ¶ˆæ¯å‘å¸ƒåˆ°äº‹ä»¶æ€»çº¿ä¸Šçš„ç‰¹å®šé€šé“ã€‚ç›‘å¬å™¨è®¢é˜…ç‰¹å®šçš„é¢‘é“ï¼Œç›‘å¬å™¨å¯ä»¥è·å–å‘å¸ƒåˆ°å…¶è®¢é˜…çš„é¢‘é“çš„æ¶ˆæ¯ã€‚</p>
<p><img src="event-source.png" alt=""></p>
<p><strong>ä¾‹å­</strong>: ç”µå­å•†åŠ¡ã€æ‰‹æœºåº”ç”¨ç¨‹åºã€é€šçŸ¥æœåŠ¡ç­‰</p>
<h2 id="ä»£ç†äººæ¨¡å¼(Broker_Pattern)">ä»£ç†äººæ¨¡å¼(Broker Pattern)</h2>
<p>æ­¤æ¨¡å¼å¯ç”¨äºæ„é€ å…·æœ‰é€šè¿‡è¿œç¨‹æœåŠ¡è°ƒç”¨è¿›è¡Œäº¤äº’çš„è§£è€¦ç»„ä»¶çš„åˆ†å¸ƒå¼ç³»ç»Ÿã€‚ä»£ç†ç»„ä»¶è´Ÿè´£åè°ƒç»„ä»¶ä¹‹é—´çš„é€šä¿¡ï¼›ä¾‹å¦‚è½¬å‘è¯·æ±‚ï¼Œä»¥åŠä¼ è¾“ç»“æœå’Œå¼‚å¸¸ã€‚</p>
<p><strong>æœåŠ¡å™¨</strong>å°†å…¶èƒ½åŠ›ï¼ˆæœåŠ¡å’Œç‰¹æ€§ï¼‰å‘å¸ƒç»™<strong>ä»£ç†</strong>(Broker)ã€‚<strong>å®¢æˆ·ç«¯</strong>å‘<strong>ä»£ç†</strong>è¯·æ±‚æœåŠ¡ï¼Œç„¶å<strong>ä»£ç†</strong>å°†<strong>å®¢æˆ·ç«¯</strong>çš„è¯·æ±‚é‡å®šå‘åˆ°åˆé€‚çš„æœåŠ¡ã€‚</p>
<p><img src="broker.png" alt=""></p>
<p><strong>ä¾‹å­</strong>: æ¶ˆæ¯Brokerç¨‹åºï¼Œå¦‚Apache ActiveMQã€Apache Kafkaã€RabbitMQã€JBOSS Messagingç­‰</p>
<h2 id="å¾®æœåŠ¡æ¨¡å¼_(Microservices_Pattern)">å¾®æœåŠ¡æ¨¡å¼ (Microservices Pattern)</h2>
<p>åœ¨è¿™ç§æ¨¡å¼ä¸­ï¼ŒæœåŠ¡é€šè¿‡ä½¿ç”¨HTTP/RESTç­‰åŒæ­¥åè®®æˆ–AMQPï¼ˆé«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®ï¼‰ç­‰å¼‚æ­¥åè®®è¿›è¡Œé€šä¿¡ã€‚æœåŠ¡å¯ä»¥ç‹¬ç«‹å¼€å‘å’Œéƒ¨ç½²ï¼Œæ¯ä¸ªæœåŠ¡éƒ½æœ‰è‡ªå·±çš„æ•°æ®åº“ã€‚æœåŠ¡ä¹‹é—´çš„æ•°æ®ä¸€è‡´æ€§æ˜¯é€šè¿‡ä½¿ç”¨Sagaæ¨¡å¼ï¼ˆä¸€ç³»åˆ—æœ¬åœ°äº‹åŠ¡ï¼‰æ¥ç»´æŠ¤çš„ã€‚</p>
<p><img src="microservices.png" alt=""></p>
<p><strong>ä¾‹å­</strong>: å¯ä»¥åœ¨è®¸å¤šç”¨ä¾‹ä¸Šå®ç°ï¼Œå°¤å…¶æ˜¯å¹¿æ³›çš„æ•°æ®ç®¡é“å¤„ç†ä¸Š</p>
<h2 id="ç‚¹å¯¹ç‚¹æ¨¡å¼_(Peer-to-Peer_Pattern)">ç‚¹å¯¹ç‚¹æ¨¡å¼ (Peer-to-Peer Pattern)</h2>
<p>åœ¨é€šç”¨å®¢æˆ·ç«¯-æœåŠ¡å™¨ä½“ç³»æ¶æ„ä¸­ï¼Œå¤šä¸ªå®¢æˆ·ç«¯ä¸ä¸­å¤®æœåŠ¡å™¨é€šä¿¡ã€‚ä½†P2Pæ¨¡å¼ç”±åˆ†æ•£çš„å¯¹ç­‰ç½‘ç»œç»„æˆã€‚</p>
<p>åœ¨è¿™ç§æ¨¡å¼ä¸­ï¼ŒèŠ‚ç‚¹çš„è¡Œä¸ºç±»ä¼¼äºå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ã€‚å¯¹ç­‰ç‚¹æ—¢å¯ä»¥ä½œä¸ºå®¢æˆ·ç«¯å‘å…¶ä»–å¯¹ç­‰ç‚¹è¯·æ±‚æœåŠ¡ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºæœåŠ¡å™¨å‘å…¶ä»–å¯¹ç­‰ç‚¹æä¾›æœåŠ¡ã€‚</p>
<p>P2Pç½‘ç»œåœ¨èŠ‚ç‚¹ä¹‹é—´åˆ†é…å·¥ä½œè´Ÿè½½ï¼Œæ‰€æœ‰èŠ‚ç‚¹è´¡çŒ®å¹¶æ¶ˆè€—ç½‘ç»œä¸­çš„èµ„æºï¼Œè€Œä¸éœ€è¦é›†ä¸­çš„æœåŠ¡å™¨ã€‚å¯¹ç­‰æ–¹å¯èƒ½ä¼šéšç€æ—¶é—´åŠ¨æ€åœ°æ”¹å˜å…¶è§’è‰²ã€‚</p>
<p><img src="peer-2-peer.png" alt=""></p>
<p><strong>ä¾‹å­</strong>: æ–‡ä»¶åˆ†äº«ç½‘ç»œã€å¤šåª’ä½“åè®®PDTP,P2PTVã€æ¯”ç‰¹å¸ã€åŒºå—é“¾ç­‰</p>
<h2 id="é»‘æ¿æ¨¡å¼(Blackboard_Pattern)">é»‘æ¿æ¨¡å¼(Blackboard Pattern)</h2>
<p>è¿™ç§æ¨¡å¼å¯¹äºä¸çŸ¥é“ç¡®å®šæ€§è§£å†³æ–¹æ¡ˆç­–ç•¥çš„é—®é¢˜å¾ˆæœ‰ç”¨ã€‚</p>
<p>æ‰€æœ‰éƒ¨ä»¶éƒ½å¯ä»¥æ¥è§¦åˆ°é»‘æ¿ã€‚ç»„ä»¶å¯èƒ½ä¼šäº§ç”Ÿæ–°çš„æ•°æ®å¯¹è±¡ï¼Œè¿™äº›å¯¹è±¡å°†è¢«æ·»åŠ åˆ°é»‘æ¿ä¸Šã€‚ç»„ä»¶åœ¨é»‘æ¿ä¸Šå¯»æ‰¾ç‰¹å®šç±»å‹çš„æ•°æ®ï¼Œå¹¶é€šè¿‡ä¸ç°æœ‰çŸ¥è¯†æºçš„æ¨¡å¼åŒ¹é…æ‰¾åˆ°è¿™äº›æ•°æ®ã€‚</p>
<p>è¿™ä¸ªæ¨¡å¼åŒ…å«ä¸‰ä¸ªç»„ä»¶ï¼š</p>
<ul>
<li>é»‘æ¿(blackboard): å«è§£å†³æ–¹æ¡ˆç©ºé—´ä¸­çš„å¯¹è±¡çš„ç»“æ„åŒ–å…¨å±€å†…å­˜</li>
<li>çŸ¥è¯†æº(knowledge source:):å…·æœ‰è‡ªå·±è¡¨ç¤ºå½¢å¼çš„ä¸“ç”¨æ¨¡å—</li>
<li>æ§åˆ¶ç»„ä»¶(control component):é€‰æ‹©ã€é…ç½®å’Œæ‰§è¡Œæ¨¡å—ã€‚</li>
</ul>
<p><img src="blackboard.png" alt=""></p>
<p><strong>ä¾‹å­</strong>: é€Ÿåº¦è¯†åˆ«ã€è›‹ç™½è´¨ç»“æ„è¯†åˆ«ã€å£°çº³ä¿¡å·è§£é‡Šã€æœºå™¨å­¦ä¹ ç¨‹åºç­‰ã€‚</p>
<h2 id="ç»„ä»¶æ¨¡å¼_(Component-based_Pattern)">ç»„ä»¶æ¨¡å¼ (Component-based Pattern)</h2>
<p>åŸºäºç»„ä»¶çš„è½¯ä»¶å·¥ç¨‹ï¼ˆComponent-based software engineeringï¼Œç®€ç§°CBSEï¼‰æˆ–åŸºäºç»„ä»¶çš„å¼€å‘ï¼ˆComponent-Based Developmentï¼Œç®€ç§°CBDï¼‰æ˜¯é’ˆå¯¹ç³»ç»Ÿçš„å¹¿æ³›åŠŸèƒ½ï¼Œè¿›è¡Œå…³æ³¨ç‚¹åˆ†ç¦»çš„è½¯ä»¶å·¥ç¨‹æ–¹å¼ã€‚æ­¤æ–¹å¼æ˜¯ä»¥å¤ç”¨ä¸ºåŸºç¡€çš„ä½œæ³•ï¼Œå®šä¹‰ã€å®ç°è®¸å¤šæ¾è€¦åˆçš„ç‹¬ç«‹ç»„ä»¶ï¼ˆComponentï¼‰ï¼Œå†å°†ç»„ä»¶ç»„åˆæˆä¸ºç³»ç»Ÿã€‚æ­¤ä½œæ³•çš„ç›®çš„æ˜¯å¸Œæœ›åœ¨è½¯ä»¶æœ¬èº«çš„çŸ­æœŸç›Šå¤„ä»¥åŠå¼€å‘è½¯ä»¶ç»„ç»‡çš„é•¿æœŸç›Šå¤„ä¹‹é—´è·å–å¹³è¡¡ã€‚</p>
<p>ä¸€æ—¦ç»„ä»¶è¿›è¡Œäº†åˆ’åˆ†ï¼Œå¯ä»¥å°†ç»„ä»¶åˆ†å¸ƒå¼çš„å¼€å‘éƒ¨ç½²ï¼Œå°±ä¼šæ¼”åŒ–æˆé¢å‘æœåŠ¡æˆ–è€…å¾®æœåŠ¡çš„æ¶æ„ã€‚</p>
<p><img src="component-based.png" alt=""></p>
<p><strong>ä¾‹å­</strong>: å¸¸è§å¤§å‹é¡¹ç›®ä¸­æˆ–è€…å•ä¸ªæœåŠ¡ä¸­ã€‚</p>
<h2 id="ç®¡é“æ¨¡å¼_(Pipes_å’Œ_filters)">ç®¡é“æ¨¡å¼ (Pipes å’Œ filters)</h2>
<p>ç®¡é“(pipeline)ç”±ä¸€ç³»åˆ—å¤„ç†å…ƒç´ ï¼ˆè¿›ç¨‹ã€çº¿ç¨‹ã€ååŒç¨‹åºã€å‡½æ•°ç­‰ï¼‰ç»„æˆï¼Œæ¯ä¸ªå…ƒç´ çš„è¾“å‡ºéƒ½æ˜¯ä¸‹ä¸€ä¸ªå…ƒç´ çš„è¾“å…¥ï¼›è¿™ä¸ªåå­—ç±»ä¼¼äºä¸€ä¸ªç‰©ç†ç®¡é“ã€‚é€šå¸¸åœ¨è¿ç»­å…ƒç´ ä¹‹é—´æä¾›ä¸€å®šé‡çš„ç¼“å†²ã€‚åœ¨è¿™äº›ç®¡é“ä¸­æµåŠ¨çš„ä¿¡æ¯é€šå¸¸æ˜¯è®°å½•æµã€å­—èŠ‚æµæˆ–æ¯”ç‰¹æµï¼Œç®¡é“ä¸­çš„å…ƒç´ å¯ä»¥ç§°ä¸ºè¿‡æ»¤å™¨(filter)ï¼›è¿™ä¹Ÿç§°ä¸ºç®¡é“å’Œè¿‡æ»¤å™¨è®¾è®¡æ¨¡å¼ã€‚å°†å…ƒç´ è¿æ¥åˆ°ç®¡é“ä¸­ç±»ä¼¼äºå‡½æ•°åˆæˆã€‚</p>
<p>ç®¡é“æ¨¡å¼å¯ä»¥å°†æ•°æ®çš„å¤„ç†è§£è€¦ï¼Œå¹¶ä¸”å¯ä»¥åŠ¨æ€çš„å¢åŠ æˆ–è€…åˆ é™¤ç‰¹å®šçš„å¤„ç†æµç¨‹ã€‚æ¯ä¸ªå¤„ç†å•å…ƒå¯ä»¥ç»“åˆä¸‹é¢æ’ä»¶æ¨¡å¼ï¼Œå®ç°å®šåˆ¶åŒ–ã€‚</p>
<p><img src="pipeline.png" alt=""></p>
<p><strong>ä¾‹å­</strong>: å¤šä»»åŠ¡æ“ä½œç³»ç»Ÿã€æ•°æ®å¤„ç†ç¨‹åºç­‰ã€‚</p>
<h2 id="æ’ä»¶æ¨¡å¼">æ’ä»¶æ¨¡å¼</h2>
<p>åœ¨è®¡ç®—æŠ€æœ¯ä¸­ï¼Œæ’ä»¶ï¼ˆæˆ–æ’ä»¶ã€å¤–æ¥ç¨‹åºã€å¤–æ¥ç¨‹åºã€å¤–æ¥ç¨‹åºæˆ–å¤–æ¥ç¨‹åºï¼‰æ˜¯ä¸€ç§è½¯ä»¶ç»„ä»¶ï¼Œç”¨äºå‘ç°æœ‰è®¡ç®—æœºç¨‹åºæ·»åŠ ç‰¹å®šåŠŸèƒ½ã€‚å½“ç¨‹åºæ”¯æŒæ’ä»¶æ—¶ï¼Œå®ƒä¼šå¯ç”¨è‡ªå®šä¹‰åŠŸèƒ½ã€‚</p>
<p>æ’ä»¶æ¨¡å¼å¯ä»¥æ–¹ä¾¿å¯¹ç¨‹åºè¿›è¡Œæ‰©å±•ï¼Œä»¥åŠåŠ¨æ€å®ç°åŠŸèƒ½çš„å¼€å¯å’Œç¦ç”¨ç­‰åŠŸèƒ½ï¼Œæ–¹ä¾¿è¿›è¡Œå®šåˆ¶åŒ–ã€‚</p>
<p><img src="plugin.png" alt=""></p>
<p><strong>ä¾‹å­</strong>: IDEç¨‹åºå¦‚Eclipseï¼ŒIDEA Intelljã€ç½‘ç»œåº”ç”¨ç¨‹åºå…¥nettyç­‰ã€‚</p>
]]></content>
    <summary type="html">
    <![CDATA[<blockquote>
<p>è§‚å…¶è®¾è®¡çŸ¥å…¶äºº</p>
<p>A MAN is KNOWN by the DESIGN he keeps</p>
</blockquote>
<p>åŸæ–‡:<a href="https://shadman-jamil.medium.com/most-useful-software-architecture-patterns-68e171405292" target="_blank" rel="external">Most Useful Software Architecture Patterns</a> by Shadman Jamil</p>
]]>
    
    </summary>
    
      <category term="æ¶æ„" scheme="https://colobu.com/categories/%E6%9E%B6%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[ç»å…¸å¹¶å‘é—®é¢˜: å¤§å‹ç†å‘åº—]]></title>
    <link href="https://colobu.com/2022/03/06/hilzers-barbershop-problem/"/>
    <id>https://colobu.com/2022/03/06/hilzers-barbershop-problem/</id>
    <published>2022-03-06T06:04:11.000Z</published>
    <updated>2022-03-06T08:19:05.176Z</updated>
    <content type="html"><![CDATA[<p>äºŒæœˆäºŒç†å‘åº—å¤ªç«äº†ï¼Œå®¶å®¶éƒ½çˆ†æ»¡ï¼Œè¿™æ¬¡æˆ‘ä»¬æ¥åˆ°Hilzerçš„ç†å‘åº—ï¼Œè¿™æ˜¯ä¸€å®¶æ¯”è¾ƒå¤§çš„ç†å‘åº—ã€‚</p>
<a id="more"></a>
<p>è¿™å®¶ç†å‘åº—æœ‰ä¸‰ä½æœ‰ç»éªŒçš„ç†å‘å¸ˆï¼Œæ¯ä¸ªç†å‘å¸ˆéƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„ç†å‘æ¤…ã€‚ç­‰å¾…åŒºæœ‰ä¸€ä¸ªå››åº§çš„æ²™å‘ï¼Œç­‰å¾…åŒºè¿˜æœ‰ç«™ä¸€äº›äººç­‰å¾…ã€‚è¿˜æœ‰ä¸€ä¸ªæ”¶é“¶å°ã€‚</p>
<ul>
<li>ä¾ç…§æ–°å† ç–«æƒ…é˜²æ§çš„è¦æ±‚ï¼Œæœ€å¤šå…è®¸20ä¸ªé¡¾å®¢è¿›å…¥ã€‚</li>
<li>å¦‚æœæœ‰é¡¾å®¢ï¼Œç†å‘å¸ˆä¼˜å…ˆä»æ²™å‘ä¸Šå«èµ·ç­‰å¾…æœ€ä¹…çš„é¡¾å®¢å¼€å§‹ç†å‘ï¼›å¦‚æœæ²¡æœ‰é¡¾å®¢ï¼Œç†å‘å¸ˆåˆ™åœ¨è‡ªå·±çš„ç†å‘æ¤…ä¸Šç¡è§‰</li>
<li>é¡¾å®¢æ¥åˆ°å<ul>
<li>å¦‚æœå·²ç»æœ‰20ä¸ªé¡¾å®¢ï¼Œåˆ™æ­¤é¡¾å®¢ç¦»å¼€å»å…¶å®ƒç†å‘åº—</li>
<li>å¦‚æœç†å‘å¸ˆåœ¨ç¡è§‰ï¼Œåˆ™å«èµ·ä¸€ä½ç†å‘å¸ˆå¼€å§‹ç†å‘</li>
<li>å¦‚æœæ²¡æœ‰ç©ºé—²çš„ç†å‘å¸ˆï¼Œåˆ™é€‰æ‹©æ²™å‘åä¸‹</li>
<li>å¦‚æœæ²™å‘å·²ç»åæ»¡ï¼Œåˆ™åœ¨ä¼‘æ¯å»ç«™ç€ç­‰å¾…</li>
</ul>
</li>
<li>ç†å®Œå‘åé¡¾å®¢å»æ”¶é“¶å°å»ç¼´è´¹ï¼Œäº¤å®Œè´¹åç†å‘å¸ˆæŠŠå‘ç¥¨äº¤ç»™é¡¾å®¢ã€‚é¡¾å®¢å°±ç¦»å¼€ï¼Œè€Œç†å‘å¸ˆåˆ™å‡†å¤‡æœåŠ¡ä¸‹ä¸€ä½é¡¾å®¢</li>
</ul>
<p>è¿™ä¸€æ¬¡ç†å‘åº—çš„é—®é¢˜æ¯”ä¸Šä¸€ä¸ª<a href="https://colobu.com/2022/02/27/barbershop-problem/" target="_blank" rel="external">ç†å‘åº—é—®é¢˜</a>è¦å¤æ‚å¾ˆå¤š:</p>
<ul>
<li>ç­‰å¾…åŒºåˆ†ä¸ºäº†ç«™ç«‹åŒºå’Œæ²™å‘åŒº</li>
<li>æ–°å¢åŠ äº†æ”¶é“¶å°ï¼Œç†å‘å¸ˆå’Œé¡¾å®¢éœ€è¦ä»˜æ¬¾å’Œå‘ç¥¨çš„ç›¸äº’ç­‰å¾…</li>
<li>ä¸‰ä½ç†å‘å¸ˆ</li>
</ul>
<p>è¿™ç±»é—®é¢˜ä½¿ç”¨ä¿¡å·é‡å¹¶å‘åŸè¯­æ¯”è¾ƒå¥½ï¼Œå› ä¸ºç†å‘å¸ˆã€æ²™å‘ç­‰éƒ½æ˜¯ä¸€å®šæ•°é‡çš„èµ„æºã€‚ç†å‘å¸ˆå’Œé¡¾å®¢ä¹‹é—´ç¼´è´¹å’Œå‘ç¥¨ä¹‹é—´çš„åŒæ­¥æŒ‰ç†è¯´ä½¿ç”¨channelæ¯”è¾ƒåˆé€‚ï¼Œä½†æ˜¯æ”¶é“¶å°åªæœ‰ä¸€ä½æ”¶é“¶å‘˜ï¼Œè¿˜éœ€è¦å¤„ç†ç†å‘å¸ˆã€é¡¾å®¢å’Œæ”¶é“¶å‘˜ä¹‹é—´çš„å¹¶å‘ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŠŠæ”¶é“¶ã€å¼€å‘ç¥¨çœ‹æˆè®¡æ•°å™¨æ˜¯1çš„èµ„æºã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬è¿˜æ˜¯å®šä¹‰ä¿¡å·é‡å’Œè¾…åŠ©æ–¹æ³•:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Semaphoreå®šä¹‰</span></div><div class="line"><span class="keyword">type</span> Semaphore <span class="keyword">chan</span> <span class="keyword">struct</span>{}</div><div class="line"></div><div class="line"><span class="keyword">func</span> (s Semaphore) Acquire() {</div><div class="line">	s &lt;- <span class="keyword">struct</span>{}{}</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">func</span> (s Semaphore) Release() {</div><div class="line">	&lt;-s</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">func</span> randomPause(max <span class="typename">int</span>) {</div><div class="line">	time.Sleep(time.Millisecond * time.Duration(rand.Intn(max)))</div><div class="line">}</div></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥æˆ‘ä»¬å®šä¹‰æ‰€éœ€çš„å¹¶å‘åŸè¯­ã€‚</p>
<p>æˆ‘ä»¬ä½¿ç”¨<code>customerMutex</code>è¿™ä¸ªæ’ä»–é”æ¥æ§åˆ¶ç†å‘åº—çš„é¡¾å®¢æ•°é‡ã€‚<br>ä½¿ç”¨<code>sofaSema</code>æ§åˆ¶ç«™ç«‹ç”¨æˆ·ååˆ°æ²™å‘ä¸Šä»¥åŠç†å‘å¸ˆå«èµ·ç­‰å¾…çš„é¡¾å®¢ã€‚</p>
<p><code>paySema</code>ç”¨æ¥è®©é¡¾å®¢å»ç¼´è´¹ï¼Œè€Œ<code>receiptSema</code>è®©ç†å‘å¸ˆæŠŠå‘ç¥¨é€ç»™é¡¾å®¢ï¼Œé¡¾å®¢ç¦»å¼€ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// é¡¾å®¢</span></div><div class="line"><span class="keyword">var</span> (</div><div class="line">	<span class="comment">// æ§åˆ¶é¡¾å®¢çš„æ€»æ•°</span></div><div class="line">	customerMutex    sync.Mutex</div><div class="line">	customerMaxCount =<span class="number"> 20</span></div><div class="line">	customerCount    =<span class="number"> 0</span></div><div class="line"></div><div class="line">	<span class="comment">// æ²™å‘çš„å®¹é‡</span></div><div class="line">	sofaSema Semaphore = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>{},<span class="number"> 4</span>)</div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment">// ç†å‘å¸ˆ</span></div><div class="line"><span class="keyword">var</span> (</div><div class="line">	<span class="comment">// ä¸‰ä½ç†å‘å¸ˆ</span></div><div class="line">	barberSema Semaphore = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>{},<span class="number"> 3</span>)</div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment">// æ”¶é“¶å°</span></div><div class="line"><span class="keyword">var</span> (</div><div class="line">	<span class="comment">// åŒæ—¶åªæœ‰ä¸€å¯¹ç†å‘å¸ˆå’Œé¡¾å®¢ç»“è´¦</span></div><div class="line">	paySema Semaphore = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>{},<span class="number"> 1</span>)</div><div class="line">	<span class="comment">// é¡¾å®¢æ‹¿åˆ°å‘ç¥¨æ‰ä¼šç¦»å¼€ï¼Œæ§åˆ¶å¼€ç¥¨</span></div><div class="line">	receiptSema Semaphore = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>{},<span class="number"> 1</span>)</div><div class="line">)</div></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥æˆ‘ä»¬å®ç°ç†å‘å¸ˆçš„é€»è¾‘:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ç†å‘å¸ˆå·¥ä½œ</span></div><div class="line"><span class="keyword">func</span> barber(name <span class="typename">string</span>) {</div><div class="line">	<span class="keyword">for</span> {</div><div class="line">		<span class="comment">// ç­‰å¾…ä¸€ä¸ªç”¨æˆ·</span></div><div class="line">		log.Println(name + <span class="string">"è€å¸ˆå°è¯•è¯·æ±‚ä¸€ä¸ªé¡¾å®¢"</span>)</div><div class="line">		sofaSema.Release() <span class="comment">// ç­‰å¾…æ²™å‘ä¸Šç­‰å¾…æœ€ä¹…çš„ä¸€ä½é¡¾å®¢</span></div><div class="line">		log.Println(name + <span class="string">"è€å¸ˆæ‰¾åˆ°ä¸€ä½é¡¾å®¢ï¼Œå¼€å§‹ç†å‘"</span>)</div><div class="line"></div><div class="line">		randomPause<span class="number">(2000</span>)</div><div class="line"></div><div class="line">		log.Println(name + <span class="string">"è€å¸ˆç†å®Œå‘ï¼Œç­‰å¾…é¡¾å®¢ä»˜æ¬¾"</span>)</div><div class="line">		paySema.Acquire() <span class="comment">// ç­‰å¾…ç”¨æˆ·ç¼´è´¹</span></div><div class="line">		log.Println(name + <span class="string">"è€å¸ˆç»™ä»˜å®Œæ¬¾çš„é¡¾å®¢å‘ç¥¨"</span>)</div><div class="line">		receiptSema.Release() <span class="comment">// é€šçŸ¥é¡¾å®¢å‘ç¥¨å¼€å¥½</span></div><div class="line">		log.Println(name + <span class="string">"è€å¸ˆæœåŠ¡å®Œä¸€ä½é¡¾å®¢"</span>)</div><div class="line"></div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥å®ç°é¡¾å®¢çš„é€»è¾‘, æ³¨æ„<code>customerCount</code>æ“ä½œéœ€è¦ä½¿ç”¨Mutexä¿æŠ¤:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// æ¨¡æ‹Ÿé¡¾å®¢é™†é™†ç»­ç»­çš„è¿‡æ¥</span></div><div class="line"><span class="keyword">func</span> customers() {</div><div class="line">	<span class="keyword">for</span> {</div><div class="line">		randomPause<span class="number">(500</span>)</div><div class="line"></div><div class="line">		<span class="keyword">go</span> customer()</div><div class="line">	}</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// é¡¾å®¢</span></div><div class="line"><span class="keyword">func</span> customer() {</div><div class="line">	customerMutex.Lock()</div><div class="line">	<span class="keyword">if</span> customerCount == customerMaxCount {</div><div class="line">		log.Println(<span class="string">"æ²¡æœ‰ç©ºé—²åº§ä½äº†ï¼Œä¸€ä½é¡¾å®¢ç¦»å¼€äº†"</span>)</div><div class="line">		customerMutex.Unlock()</div><div class="line">		<span class="keyword">return</span></div><div class="line">	}</div><div class="line">	customerCount++</div><div class="line">	customerMutex.Unlock()</div><div class="line"></div><div class="line">	log.Println(<span class="string">"ä¸€ä½é¡¾å®¢å¼€å§‹ç­‰æ²™å‘åä¸‹"</span>)</div><div class="line">	sofaSema.Acquire()</div><div class="line">	log.Println(<span class="string">"ä¸€ä½é¡¾å®¢æ‰¾åˆ°ç©ºé—²æ²™å‘åä¸‹,ç›´åˆ°è¢«ç†å‘å¸ˆå«èµ·ç†å‘"</span>)</div><div class="line"></div><div class="line">	paySema.Release()</div><div class="line">	log.Println(<span class="string">"ä¸€ä½é¡¾å®¢å·²ä»˜å®Œé’±"</span>)</div><div class="line">	receiptSema.Acquire()</div><div class="line">	log.Println(<span class="string">"ä¸€ä½é¡¾å®¢æ‹¿åˆ°å‘ç¥¨ï¼Œç¦»å¼€"</span>)</div><div class="line"></div><div class="line">	customerMutex.Lock()</div><div class="line">	customerCount--</div><div class="line">	customerMutex.Unlock()</div><div class="line">}</div></pre></td></tr></table></figure>

<p>æœ€åæŠŠæ‰€æœ‰çš„é€»è¾‘ä¸²èµ·æ¥ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">func</span> main() {</div><div class="line">	<span class="comment">// æ‰˜å°¼ã€å‡¯æ–‡ã€è‰¾ä¼¦ç†å‘å¸ˆä¸‰å·¨å¤´</span></div><div class="line">	<span class="keyword">go</span> barber(<span class="string">"Tony"</span>)</div><div class="line">	<span class="keyword">go</span> barber(<span class="string">"Kevin"</span>)</div><div class="line">	<span class="keyword">go</span> barber(<span class="string">"Allen"</span>)</div><div class="line"></div><div class="line">	<span class="keyword">go</span> customers()</div><div class="line"></div><div class="line">	sigs := <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal,<span class="number"> 1</span>)</div><div class="line">	signal.Notify(sigs, syscall.SIGINT, syscall.SIGTERM)</div><div class="line">	&lt;-sigs</div><div class="line">}</div></pre></td></tr></table></figure>

<p>è¿è¡Œè¿™ä¸ªç¨‹åºè§‚å¯Ÿå¹¶å‘çš„æ‰§è¡Œã€‚</p>
<p>é€šè¿‡è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥å¥½å¥½çš„ç»ƒä¹ Semaphoreçš„ä½¿ç”¨ï¼Œä»¥åŠä¸¤ä¸ªgoroutineä¹‹é—´ä¿¡å·çš„ä¼ é€’ï¼Œæ§åˆ¶å¹¶å‘ç¨‹åºçš„åä½œæ‰§è¡Œã€‚</p>
<p>ä¸‹ä¸€ç« ä½ æƒ³äº†è§£ä»€ä¹ˆæ ·çš„ç»å…¸å¹¶å‘é—®é¢˜å‘¢ï¼Ÿ</p>
<h2 id="å†å²å¹¶å‘é—®é¢˜">å†å²å¹¶å‘é—®é¢˜</h2>
<ul>
<li><a href="https://colobu.com/2022/02/13/dining-philosophers-problem/" target="_blank" rel="external">å“²å­¦å®¶å°±é¤é—®é¢˜</a></li>
<li><a href="https://colobu.com/2019/07/23/concurrent-problem-h2o-factory/" target="_blank" rel="external">åˆ¶é€ ä¸€æ°§åŒ–äºŒæ°¢</a></li>
<li><a href="https://colobu.com/2022/02/27/barbershop-problem/" target="_blank" rel="external">ç†å‘åº—çš„æ•…äº‹</a></li>
</ul>
]]></content>
    <summary type="html">
    <![CDATA[<p>äºŒæœˆäºŒç†å‘åº—å¤ªç«äº†ï¼Œå®¶å®¶éƒ½çˆ†æ»¡ï¼Œè¿™æ¬¡æˆ‘ä»¬æ¥åˆ°Hilzerçš„ç†å‘åº—ï¼Œè¿™æ˜¯ä¸€å®¶æ¯”è¾ƒå¤§çš„ç†å‘åº—ã€‚</p>
]]>
    
    </summary>
    
      <category term="Go" scheme="https://colobu.com/categories/Go/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[ç»å…¸å¹¶å‘é—®é¢˜ï¼š ç†å‘åº—çš„æ•…äº‹]]></title>
    <link href="https://colobu.com/2022/02/27/barbershop-problem/"/>
    <id>https://colobu.com/2022/02/27/barbershop-problem/</id>
    <published>2022-02-27T08:40:51.000Z</published>
    <updated>2022-02-27T10:12:01.956Z</updated>
    <content type="html"><![CDATA[<p>é©¬ä¸Šå°±äºŒæœˆäºŒäº†ï¼Œç†å‘åº—å°±è¦å¿™æ´»èµ·æ¥äº†ï¼Œæ‰˜å°¼ã€å‡¯æ–‡ã€è‰¾ä¼¦ç­‰è€å¸ˆçš„ç†å‘å‰ªç£¨åˆ€éœéœï¼ŒæŠŠæ¤…å­æ“¦äº®ï¼Œå‡†å¤‡å„ä½é¡¾å®¢çš„åˆ°æ¥ã€‚</p>
<p><a href="https://en.wikipedia.org/wiki/Sleeping_barber_problem" target="_blank" rel="external">Sleeping barber problem</a>æ˜¯ä¸€ä¸ªç»å…¸çš„goroutineäº¤äº’å’Œå¹¶å‘æ§åˆ¶çš„é—®é¢˜ï¼Œå¯ä»¥å¾ˆå¥½çš„ç”¨æ¥æ¼”ç¤ºå¤šå†™å¤šè¯»çš„å¹¶å‘é—®é¢˜(multiple writers multiple readers)ã€‚</p>
<a id="more"></a>
<p>ç†å‘åº—é—®é¢˜æœ€æ—©æ˜¯ç”±è®¡ç®—æœºç§‘å­¦å…ˆé©± Edsger Dijkstra åœ¨1965æŒ‡å‡ºçš„ï¼Œåœ¨ Silberschatz å’Œ Galvin çš„ Operating Systems Conceptsä¸€ä¹¦ä¸­æœ‰æ­¤é—®é¢˜çš„å˜ç§ã€‚</p>
<p>è¿™ä¸ªé—®é¢˜æ˜¯è¿™æ ·å­çš„ã€‚<br>æœ‰è¿™ä¹ˆä¸€ä¸ªç†å‘åº—ï¼Œæœ‰ä¸€ä½ç†å‘å¸ˆå’Œå‡ ä¸ªè®©é¡¾å®¢ç­‰å¾…çš„åº§ä½ï¼š</p>
<ul>
<li>å¦‚æœæ²¡æœ‰é¡¾å®¢ï¼Œè¿™ä½ç†å‘å¸ˆå°±èººåœ¨ç†å‘æ¤…ä¸Šç¡è§‰</li>
<li>é¡¾å®¢å¿…é¡»å”¤é†’ç†å‘å¸ˆè®©ä»–å¼€å§‹ç†å‘</li>
<li>å¦‚æœä¸€ä½é¡¾å®¢åˆ°æ¥ï¼Œç†å‘å¸ˆæ­£åœ¨ç†å‘<ul>
<li>å¦‚æœè¿˜æœ‰é¡¾å®¢ç”¨æ¥ç­‰å¾…çš„åº§ä½ï¼Œåˆ™æ­¤é¡¾å®¢åä¸‹</li>
<li>å¦‚æœåº§ä½éƒ½æ»¡äº†ï¼Œåˆ™æ­¤é¡¾å®¢ç¦»å¼€</li>
</ul>
</li>
<li>ç†å‘å¸ˆç†å®Œå¤´å‘åï¼Œéœ€è¦æ£€æŸ¥æ˜¯å¦è¿˜æœ‰ç­‰å¾…çš„é¡¾å®¢<ul>
<li>å¦‚æœæœ‰ï¼Œåˆ™è¯·ä¸€ä½é¡¾å®¢èµ·æ¥å¼€å§‹ç†å‘</li>
<li>å¦‚æœæ²¡æœ‰ï¼Œç†å‘å¸ˆåˆ™å»ç¡è§‰</li>
</ul>
</li>
</ul>
<p>è™½ç„¶æ¡ä»¶å¾ˆå¤šï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆä¸ºä¸€ä¸ªå¹¶å‘çš„queueã€‚åœ¨å½“å‰çš„é—®é¢˜ä¸‹ï¼Œæœ‰å¤šä¸ªå¹¶å‘å†™(multiple writer, é¡¾å®¢)ï¼Œä¸€ä¸ªå¹¶å‘è¯»(single reader),å¯¹å§ã€‚</p>
<h2 id="ä½¿ç”¨sync-Condå®ç°">ä½¿ç”¨sync.Condå®ç°</h2>
<p>ä¸€èˆ¬ï¼Œå…ˆå‰ï¼Œæˆ‘ä»¬å¤„ç†å¹¶å‘é˜Ÿåˆ—é€šè¿‡ä½¿ç”¨<a href="https://pkg.go.dev/sync#Cond" target="_blank" rel="external">sync.Cond</a>è¿™ä¸ªå¹¶å‘åŸè¯­(åœ¨javaè¯­è¨€ä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä½¿ç”¨wait/notify)ã€‚</p>
<p>å°±<code>sync.Cond</code>è¿™ä¸ªå¹¶å‘åŸè¯­è€Œè¨€ï¼Œå®ƒå¹¶ä¸æ˜¯ä¸€ä¸ªå¾ˆå®¹æ˜“ä½¿ç”¨çš„å¯¹è±¡ã€‚å› ä¸ºå®ƒè¿˜éœ€è¦ä¸€ä¸ªä¸€ä¸ª<code>sync.Locker</code>é…åˆä½¿ç”¨ï¼Œå¹¶ä¸”ç›¸å…³çš„æ–¹æ³•è¦ä¹ˆå¿…é¡»ä½¿ç”¨Lockerã€è¦ä¹ˆå¯ä»¥çœç•¥Lockerï¼Œå®¹æ˜“è®©äººè¿·æƒ‘ï¼Œç­‰å¾…çš„goroutineè¢«å”¤é†’æ—¶è¿˜éœ€è¦æ£€æŸ¥åˆ¤æ–­æ¡ä»¶ï¼Œæ‰€ä»¥ç”¨èµ·æ¥æ€»æ˜¯éœ€è¦å°å¿ƒç¿¼ç¿¼åœ°ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªLockerå’Œä¸€ä¸ªCond,å¹¶ä¸”å®šä¹‰é¡¾å®¢ç­‰å¾…çš„åº§ä½æ•°ã€‚<br>æ¥äº†ä¸€ä½é¡¾å®¢ï¼Œåº§ä½æ•°åŠ ä¸€ï¼ŒTonyè€å¸ˆå«èµ·ä¸€ä½ç­‰å¾…çš„é¡¾å®¢å¼€å§‹ç†å‘æ—¶ï¼Œåº§ä½æ•°å‡ä¸€ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> (</div><div class="line">	seatsLock sync.Mutex</div><div class="line">	seats     <span class="typename">int</span></div><div class="line">	cond = sync.NewCond(&seatsLock)</div><div class="line">)</div></pre></td></tr></table></figure>

<p>ç†å‘å¸ˆçš„å·¥ä½œå°±æ˜¯ä¸æ–­çš„æ£€æŸ¥æ˜¯å¦æœ‰é¡¾å®¢ç­‰å¾…ï¼Œå¦‚æœæœ‰ï¼Œå°±äº¤èµ·ä¸€ä½é¡¾å®¢å¼€å§‹ç†å‘ï¼Œç†å‘è€—æ—¶æ˜¯éšæœºçš„ï¼Œç†å®Œå†å»å«ä¸‹ä¸€ä½é¡¾å®¢ã€‚å¦‚æœæ²¡æœ‰é¡¾å®¢ï¼Œé‚£ä¹ˆç†å‘å¸ˆå°±ä¼šè¢«é˜»å¡(å¼€å§‹ç¡è§‰)ã€‚<br>é€ä¸€è¿™é‡ŒCondçš„ä½¿ç”¨æ–¹æ³•ï¼ŒWaitä¹‹åéœ€è¦forå¾ªç¯æ£€æŸ¥æ¡ä»¶æ˜¯å¦æ»¡è¶³ï¼Œå¹¶ä¸”Waitä¸Šä¸‹ä¼šæœ‰Lockerçš„ä½¿ç”¨ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ç†å‘å¸ˆ</span></div><div class="line"><span class="keyword">func</span> barber() {</div><div class="line">	<span class="keyword">for</span> {</div><div class="line">		<span class="comment">// ç­‰å¾…ä¸€ä¸ªç”¨æˆ·</span></div><div class="line">		log.Println(<span class="string">"Tonyè€å¸ˆå°è¯•è¯·æ±‚ä¸€ä¸ªé¡¾å®¢"</span>)</div><div class="line">		seatsLock.Lock()</div><div class="line">		<span class="keyword">for</span> seats ==<span class="number"> 0</span> {</div><div class="line">			cond.Wait()</div><div class="line">		}</div><div class="line">		seats--</div><div class="line">		seatsLock.Unlock()</div><div class="line">		log.Println(<span class="string">"Tonyè€å¸ˆæ‰¾åˆ°ä¸€ä½é¡¾å®¢ï¼Œå¼€å§‹ç†å‘"</span>)</div><div class="line"></div><div class="line">		randomPause<span class="number">(2000</span>)</div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure>

<p><code>customers</code>æ¨¡æ‹Ÿé™†é™†ç»­ç»­çš„é¡¾å®¢çš„åˆ°æ¥:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> customers() {</div><div class="line">	<span class="keyword">for</span> {</div><div class="line">		randomPause<span class="number">(1000</span>)</div><div class="line">		<span class="keyword">go</span> customer()</div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure>

<p>é¡¾å®¢åˆ°æ¥ä¹‹åï¼Œå…ˆè¯·æ±‚seatsLockï¼Œ é¿å…å¤šä¸ªé¡¾å®¢åŒæ—¶è¿›æ¥çš„å¹¶å‘ç«äº‰ã€‚ç„¶åä»–ä¼šæ£€æŸ¥æ˜¯å¦æœ‰ç©ºé—²çš„åº§ä½ï¼Œå¦‚æœæœ‰åˆ™åä¸‹å¹¶é€šçŸ¥ç†å‘å¸ˆã€‚æ­¤æ—¶ç†å‘å¸ˆå¦‚æœç¡çœ åˆ™ä¼šè¢«å”¤é†’ï¼Œå¦‚æœæ­£åœ¨ç†å‘ä¼šå¿½ç•¥ã€‚<br>å¦‚æœæ²¡æœ‰ç©ºé—²çš„åº§ä½åˆ™ç¦»å¼€ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> customer() {</div><div class="line">	seatsLock.Lock()</div><div class="line">	<span class="keyword">defer</span> seatsLock.Unlock()</div><div class="line"></div><div class="line">	<span class="keyword">if</span> seats ==<span class="number"> 3</span> {</div><div class="line">		log.Println(<span class="string">"æ²¡æœ‰ç©ºé—²åº§ä½äº†ï¼Œä¸€ä½é¡¾å®¢ç¦»å¼€äº†"</span>)</div><div class="line">		<span class="keyword">return</span></div><div class="line">	}</div><div class="line">	seats++</div><div class="line">	cond.Broadcast()</div><div class="line"></div><div class="line">	log.Println(<span class="string">"ä¸€ä½é¡¾å®¢å¼€å§‹åä¸‹æ’é˜Ÿç†å‘"</span>)</div><div class="line">}</div></pre></td></tr></table></figure>

<p>è¿™é‡Œç®€å•çš„æ˜¯ç”±æ•´æ•°seatsä»£è¡¨ç©ºé—²çš„åº§ä½ï¼Œå®é™…å¤„ç†è¿™æ ·çš„åœºæ™¯çš„æ—¶å€™ï¼Œä½ å¯èƒ½ä¼šä½¿ç”¨ä¸€ä¸ªsliceä½œä¸ºé˜Ÿåˆ—ã€‚</p>
<p>æœ¬èº«è¿™ä¸ªå®ç°è¿˜æ˜¯å¾ˆç®€å•çš„ï¼Œä½†æ˜¯Cond+Lockerçš„ä½¿ç”¨æ–¹å¼è¿˜æ˜¯æ„Ÿè§‰è®©äººæœ‰é‚£ä¹ˆä¸€ç‚¹ä¸æ”¾å¿ƒï¼Œäº‹å®ä¸Šï¼Œå¾ˆå¤šè¿™æ ·çš„åœºæ™¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨channelæ¥å®ç°ã€‚</p>
<h2 id="ä½¿ç”¨Channelå®ç°Semaphore">ä½¿ç”¨Channelå®ç°Semaphore</h2>
<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨Channelå®ç°ä¸€ä¸ªSemaphoreæ¥è§£å†³ç†å‘åº—é—®é¢˜ã€‚Semaphoreå®ç°å¦‚ä¸‹,å’Œæˆ‘ä»¬æ°´åˆ†å­ç”Ÿæˆçš„é—®é¢˜ä¸­çš„å®ç°æ˜¯ç±»ä¼¼çš„ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Semaphore <span class="keyword">chan</span> <span class="keyword">struct</span>{}</div><div class="line"></div><div class="line"><span class="keyword">func</span> (s Semaphore) Acquire() {</div><div class="line">	s &lt;- <span class="keyword">struct</span>{}{}</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">func</span> (s Semaphore) TryAcquire() <span class="typename">bool</span> {</div><div class="line">	<span class="keyword">select</span> {</div><div class="line">	<span class="keyword">case</span> s &lt;- <span class="keyword">struct</span>{}{}: <span class="comment">// è¿˜æœ‰ç©ºä½å­</span></div><div class="line">		<span class="keyword">return</span> <span class="constant">true</span></div><div class="line">	<span class="keyword">default</span>: <span class="comment">// æ²¡æœ‰ç©ºä½å­äº†,ç¦»å¼€</span></div><div class="line">		<span class="keyword">return</span> <span class="constant">false</span></div><div class="line">	}</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">func</span> (s Semaphore) Release() {</div><div class="line">	&lt;-s</div><div class="line">}</div></pre></td></tr></table></figure>

<p>æœ‰äº†è¿™ä¸ªå¹¶å‘åŸè¯­ï¼Œæˆ‘ä»¬å°±å®¹æ˜“è§£å†³ç†å‘åº—é—®é¢˜äº†ã€‚æ³¨æ„è¿™é‡Œæˆ‘ä»¬å®ç°äº†<code>TryAcquire</code>,å°±æ˜¯ä¸ºäº†é¡¾å®¢åˆ°æ¥çš„æ˜¯å¦æ£€æŸ¥æœ‰æ²¡æœ‰ç©ºé—²çš„åº§ä½ã€‚<br>è¿™é‡Œä¸ºä»€ä¹ˆä¸ä½¿ç”¨Goå®˜æ–¹æ‰©å±•çš„<code>semaphore.Weighted</code>å¹¶å‘åŸè¯­å‘¢ï¼Œæ˜¯å› ä¸º<code>semaphore.Weighted</code>æœ‰ä¸ªé—®é¢˜ï¼Œåœ¨<code>Accquire</code>ä¹‹å‰è°ƒç”¨<code>Release</code>æ–¹æ³•çš„è¯ä¼španicï¼Œæ‰€ä»¥æˆ‘ä»¬è‡ªå·±å®ç°äº†ä¸€ä¸ªã€‚</p>
<p>æˆ‘ä»¬å®šä¹‰äº†æœ‰ä¸‰ä¸ªç­‰å¾…åº§ä½çš„ä¿¡å·é‡ã€‚Tonyè€å¸ˆå…ˆè°ƒç”¨<code>Release</code>æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯æƒ³ä»åº§ä½ä¸Šè¯·ä¸€ä½é¡¾å®¢è¿‡æ¥ç†å‘ï¼Œä»¥ä¾¿ç©ºå‡ºä¸€ä¸ªç­‰å¾…åº§ä½ã€‚å¦‚æœæ²¡æœ‰é¡¾å®¢ï¼ŒTonyå°±ä¼šæ— å¥ˆçš„ç­‰å¾…å’Œç¡è§‰äº†ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> seats = <span class="built_in">make</span>(Semaphore,<span class="number"> 3</span>)</div><div class="line"></div><div class="line"><span class="comment">// ç†å‘å¸ˆ</span></div><div class="line"><span class="keyword">func</span> barber() {</div><div class="line">	<span class="keyword">for</span> {</div><div class="line">    		<span class="comment">// ç­‰å¾…ä¸€ä¸ªç”¨æˆ·</span></div><div class="line">		log.Println(<span class="string">"Tonyè€å¸ˆå°è¯•è¯·æ±‚ä¸€ä¸ªé¡¾å®¢"</span>)</div><div class="line">		seats.Release()</div><div class="line">		log.Println(<span class="string">"Tonyè€å¸ˆæ‰¾åˆ°ä¸€ä½é¡¾å®¢ï¼Œå¼€å§‹ç†å‘"</span>)</div><div class="line"></div><div class="line">		randomPause<span class="number">(2000</span>)</div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure>

<p>é¡¾å®¢çš„æ£€æŸ¥ä¹Ÿæ›´ç®€å•:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// æ¨¡æ‹Ÿé¡¾å®¢é™†é™†ç»­ç»­çš„è¿‡æ¥</span></div><div class="line"><span class="keyword">func</span> customers() {</div><div class="line">	<span class="keyword">for</span> {</div><div class="line">		randomPause<span class="number">(1000</span>)</div><div class="line"></div><div class="line">		<span class="keyword">go</span> customer()</div><div class="line">	}</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// é¡¾å®¢</span></div><div class="line"><span class="keyword">func</span> customer() {</div><div class="line">	<span class="keyword">if</span> ok := seats.TryAcquire(); ok {</div><div class="line">		log.Println(<span class="string">"ä¸€ä½é¡¾å®¢å¼€å§‹åä¸‹æ’é˜Ÿç†å‘"</span>)</div><div class="line">	} <span class="keyword">else</span> {</div><div class="line">		log.Println(<span class="string">"æ²¡æœ‰ç©ºé—²åº§ä½äº†ï¼Œä¸€ä½é¡¾å®¢ç¦»å¼€äº†"</span>)</div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨è‡ªå®šä¹‰çš„Semaphoreè¯ï¼Œä»£ç ä¼šå˜å¾—æ›´åŠ çš„ç®€å•ã€‚</p>
<p>é‚£ä¹ˆè¿™ç§channelå®ç°çš„Semaphoreæœ‰ä»€ä¹ˆç¼ºé™·å—ï¼Ÿé‚£å°±æ˜¯å¦‚æœé˜Ÿåˆ—çš„é•¿åº¦å¤ªå¤§çš„è¯ï¼Œchannelçš„å®¹é‡å°±ä¼šå¾ˆå¤§ã€‚ä¸è¿‡å¦‚æœç±»å‹è®¾ç½®ä¸ºstrcut{}ç±»å‹çš„è¯ï¼Œå°±ä¼šèŠ‚çœå¾ˆå¤šçš„å†…å­˜ï¼Œæ‰€ä»¥ä¸€èˆ¬ä¹Ÿä¸ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ï¼Œè™½ç„¶æ¯”å®˜æ–¹æ‰©å±•çš„è®¡æ•°å™¨æ–¹å¼çš„<code>semaphore.Weighted</code>å¤šå ç”¨ä¸€äº›ç©ºé—´ï¼Œä½†æ˜¯å ç”¨çš„ç©ºé—´è¿˜æ˜¯æœ‰é™çš„ã€‚</p>
<p>æ›´è¿›ä¸€æ­¥ï¼Œå°½ç„¶æˆ‘ä»¬è¦å®ç°ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå…¶å®å¯ä»¥é€šè¿‡è¿™ä¸ªchannelæ¥å®ç°ï¼ŒæŠŠé¡¾å®¢ç±»å‹æ›¿æ¢struct{}ç±»å‹ï¼Œè¿™æ ·å°±æ²¡æœ‰é¢å¤–å¤šä½™çš„å ç”¨äº†ã€‚</p>
<h2 id="å¤šç†å‘å¸ˆçš„æƒ…å†µ">å¤šç†å‘å¸ˆçš„æƒ…å†µ</h2>
<p>æ›´è¿›ä¸€æ­¥ï¼Œæˆ‘ä»¬è€ƒè™‘å¤šä¸ªç†å‘å¸ˆçš„æƒ…å†µã€‚</p>
<p>å¤šä¸ªç†å‘å¸ˆçš„é—®é¢˜å…¶å®å°±æ¼”å˜æˆäº†å¤šå†™(multiple writer)å¤šè¯»(multiple reader)çš„åœºæ™¯äº†ã€‚</p>
<p>æ‰˜å°¼ã€å‡¯æ–‡å’Œè‰¾ä¼¦æ˜¯ç†å‘ç•Œçš„ä¸‰å¤§å·¨å¤´ï¼Œæˆ‘ä»¬æ¼”ç¤ºä¸‰ä½ç†å‘å¸ˆå¹¶å‘ç†å‘çš„åœºæ™¯ï¼ŒåŒæ—¶ç†å‘åº—çš„è§„æ¨¡ä¹Ÿæ‰©å¤§äº†ï¼Œæœ‰10ä¸ªå¯ä»¥ç­‰å¾…çš„åº§ä½ã€‚</p>
<p>åŸºäºchannelå®ç°çš„Semaphoreçš„è§£å†³æ–¹æ¡ˆï¼Œå¤šä¸ªç†å‘å¸ˆçš„åœºæ™¯å’Œå•ä¸ªç†å‘å¸ˆçš„åœºæ™¯æ˜¯ä¸€æ ·çš„:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"log"</span></div><div class="line">	<span class="string">"math/rand"</span></div><div class="line">	<span class="string">"os"</span></div><div class="line">	<span class="string">"os/signal"</span></div><div class="line">	<span class="string">"syscall"</span></div><div class="line">	<span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">type</span> Semaphore <span class="keyword">chan</span> <span class="keyword">struct</span>{}</div><div class="line"></div><div class="line"><span class="keyword">func</span> (s Semaphore) Acquire() {</div><div class="line">	s &lt;- <span class="keyword">struct</span>{}{}</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">func</span> (s Semaphore) TryAcquire() <span class="typename">bool</span> {</div><div class="line">	<span class="keyword">select</span> {</div><div class="line">	<span class="keyword">case</span> s &lt;- <span class="keyword">struct</span>{}{}: <span class="comment">// è¿˜æœ‰ç©ºä½å­</span></div><div class="line">		<span class="keyword">return</span> <span class="constant">true</span></div><div class="line">	<span class="keyword">default</span>: <span class="comment">// æ²¡æœ‰ç©ºä½å­äº†,ç¦»å¼€</span></div><div class="line">		<span class="keyword">return</span> <span class="constant">false</span></div><div class="line">	}</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">func</span> (s Semaphore) Release() {</div><div class="line">	&lt;-s</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">var</span> seats = <span class="built_in">make</span>(Semaphore,<span class="number"> 10</span>)</div><div class="line"></div><div class="line"><span class="keyword">func</span> main() {</div><div class="line">	<span class="comment">// æ‰˜å°¼ã€å‡¯æ–‡ã€è‰¾ä¼¦ç†å‘å¸ˆä¸‰å·¨å¤´</span></div><div class="line">	<span class="keyword">go</span> barber(<span class="string">"Tony"</span>)</div><div class="line">	<span class="keyword">go</span> barber(<span class="string">"Kevin"</span>)</div><div class="line">	<span class="keyword">go</span> barber(<span class="string">"Allen"</span>)</div><div class="line"></div><div class="line">	<span class="keyword">go</span> customers()</div><div class="line"></div><div class="line">	sigs := <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal,<span class="number"> 1</span>)</div><div class="line">	signal.Notify(sigs, syscall.SIGINT, syscall.SIGTERM)</div><div class="line">	&lt;-sigs</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">func</span> randomPause(max <span class="typename">int</span>) {</div><div class="line">	time.Sleep(time.Millisecond * time.Duration(rand.Intn(max)))</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// ç†å‘å¸ˆ</span></div><div class="line"><span class="keyword">func</span> barber(name <span class="typename">string</span>) {</div><div class="line">	<span class="keyword">for</span> {</div><div class="line">		<span class="comment">// ç­‰å¾…ä¸€ä¸ªç”¨æˆ·</span></div><div class="line">		log.Println(name + <span class="string">"è€å¸ˆå°è¯•è¯·æ±‚ä¸€ä¸ªé¡¾å®¢"</span>)</div><div class="line">		seats.Release()</div><div class="line">		log.Println(name + <span class="string">"è€å¸ˆæ‰¾åˆ°ä¸€ä½é¡¾å®¢ï¼Œå¼€å§‹ç†å‘"</span>)</div><div class="line"></div><div class="line">		randomPause<span class="number">(2000</span>)</div><div class="line">	}</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// æ¨¡æ‹Ÿé¡¾å®¢é™†é™†ç»­ç»­çš„è¿‡æ¥</span></div><div class="line"><span class="keyword">func</span> customers() {</div><div class="line">	<span class="keyword">for</span> {</div><div class="line">		randomPause<span class="number">(1000</span>)</div><div class="line"></div><div class="line">		<span class="keyword">go</span> customer()</div><div class="line">	}</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// é¡¾å®¢</span></div><div class="line"><span class="keyword">func</span> customer() {</div><div class="line">	<span class="keyword">if</span> ok := seats.TryAcquire(); ok {</div><div class="line">		log.Println(<span class="string">"ä¸€ä½é¡¾å®¢å¼€å§‹åä¸‹æ’é˜Ÿç†å‘"</span>)</div><div class="line">	} <span class="keyword">else</span> {</div><div class="line">		log.Println(<span class="string">"æ²¡æœ‰ç©ºé—²åº§ä½äº†ï¼Œä¸€ä½é¡¾å®¢ç¦»å¼€äº†"</span>)</div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure>

<p>å…¨éƒ¨ç»å…¸å¹¶å‘é—®é¢˜çš„ä»£ç å¯ä»¥å‚è€ƒ<a href="https://github.com/smallnest/dive-to-gosync-workshop/tree/master/11.classical_problems" target="_blank" rel="external">smallnest/dive-to-gosync-workshop</a>ã€‚ä¸‹ä¸€æ¬¡æˆ‘ä»¬å†åˆ†æä¸€ä¸ªæ›´åŠ å¤æ‚çš„ç†å‘åº—é—®é¢˜ã€‚</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>é©¬ä¸Šå°±äºŒæœˆäºŒäº†ï¼Œç†å‘åº—å°±è¦å¿™æ´»èµ·æ¥äº†ï¼Œæ‰˜å°¼ã€å‡¯æ–‡ã€è‰¾ä¼¦ç­‰è€å¸ˆçš„ç†å‘å‰ªç£¨åˆ€éœéœï¼ŒæŠŠæ¤…å­æ“¦äº®ï¼Œå‡†å¤‡å„ä½é¡¾å®¢çš„åˆ°æ¥ã€‚</p>
<p><a href="https://en.wikipedia.org/wiki/Sleeping_barber_problem" target="_blank" rel="external">Sleeping barber problem</a>æ˜¯ä¸€ä¸ªç»å…¸çš„goroutineäº¤äº’å’Œå¹¶å‘æ§åˆ¶çš„é—®é¢˜ï¼Œå¯ä»¥å¾ˆå¥½çš„ç”¨æ¥æ¼”ç¤ºå¤šå†™å¤šè¯»çš„å¹¶å‘é—®é¢˜(multiple writers multiple readers)ã€‚</p>
]]>
    
    </summary>
    
      <category term="Go" scheme="https://colobu.com/categories/Go/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[ç»å…¸å¹¶å‘é—®é¢˜: å“²å­¦å®¶å°±é¤é—®é¢˜]]></title>
    <link href="https://colobu.com/2022/02/13/dining-philosophers-problem/"/>
    <id>https://colobu.com/2022/02/13/dining-philosophers-problem/</id>
    <published>2022-02-13T09:25:44.000Z</published>
    <updated>2022-02-24T09:36:34.503Z</updated>
    <content type="html"><![CDATA[<p>å“²å­¦å®¶å°±é¤é—®é¢˜æ˜¯ä¸€ä¸ªéå¸¸éå¸¸ç»å…¸çš„é—®é¢˜ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªéå¸¸é€šç”¨çš„ç ”ç©¶å¹¶å‘ç¼–ç¨‹ä¸­æ­»é”ç°è±¡çš„é—®é¢˜ã€‚</p>
<a id="more"></a>
<blockquote>
<p>ä¸ºä»€ä¹ˆæˆ‘ä»¬è¦ç ”ç©¶ç»å…¸çš„å¹¶å‘é—®é¢˜å‘¢ï¼Ÿè¿™äº›ç»å…¸é—®é¢˜æ˜¯å¯¹ç°å®ä¸­çš„è®¡ç®—æœºç¼–ç¨‹çš„æŠ½è±¡ï¼Œä»£è¡¨äº†éå¸¸é€šç”¨çš„è®¡ç®—æœºå¹¶å‘é—®é¢˜ï¼Œè®¡ç®—æœºç§‘å­¦å®¶å¯¹æ­¤è¿›è¡Œäº†æ·±å…¥çš„ç ”ç©¶ï¼Œä¹Ÿæ€»ç»“å‡ºå¾ˆå¤šè¡Œä¹‹æœ‰æ•ˆçš„è§£å†³åŠæ³•ã€‚æˆ‘ä»¬é€šè¿‡å­¦ä¹ è¿™äº›ç»å…¸é—®é¢˜ï¼Œå¯ä»¥å°†æˆ‘ä»¬é‡åˆ°çš„å¹¶å‘é—®é¢˜åšå¯¹æ¯”ï¼Œçœ‹ä¸çœ‹æ˜¯å¦æ˜¯ç±»ä¼¼çš„é—®é¢˜ï¼Œå¦‚ä½•æ˜¯ç›¸åŒçš„é—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨å‰äººæ€»ç»“çš„è§£å†³æ–¹æ¡ˆå»è§£å†³ã€‚åŒæ—¶ç»ƒä¹ è§£å†³è¿™äº›é—®é¢˜ï¼Œä¹Ÿå¯ä»¥ä½¿æˆ‘ä»¬å­¦ä¹ å’ŒæŒæ¡å¹¶å‘åŸè¯­å’Œè§£å†³é—®é¢˜çš„æŠ€å·§ï¼Œä¸¾ä¸€åä¸‰å»è§£å†³æ›´å¤šçš„å¹¶å‘é—®é¢˜ã€‚</p>
</blockquote>
<p>åœ¨1971å¹´ï¼Œè‘—åçš„è®¡ç®—æœºç§‘å­¦å®¶è‰¾å…¹æ ¼Â·è¿ªç§‘æ–¯å½»(Edsger Dijkstra)æå‡ºäº†ä¸€ä¸ªåŒæ­¥é—®é¢˜ï¼Œå³å‡è®¾æœ‰äº”å°è®¡ç®—æœºéƒ½è¯•å›¾è®¿é—®äº”ä»½å…±äº«çš„ç£å¸¦é©±åŠ¨å™¨ã€‚ç¨åï¼Œè¿™ä¸ªé—®é¢˜è¢«æ‰˜å°¼Â·éœå°”(Tony Hoare)é‡æ–°è¡¨è¿°ä¸ºå“²å­¦å®¶å°±é¤é—®é¢˜ã€‚è¿™ä¸ªé—®é¢˜å¯ä»¥ç”¨æ¥è§£é‡Šæ­»é”å’Œèµ„æºè€—å°½ã€‚</p>
<p>åˆ°äº†ä¸­å›½ï¼Œå“²å­¦å®¶å°±é¤é—®é¢˜å¯ä»¥è¿™æ ·è¡¨è¿°ï¼Œå‡è®¾å› ä¸ºæ–°å† çš„åŸå› ï¼Œäº”ä½å“²å­¦å®¶è¢«éš”ç¦»åœ¨ä¸€ä¸ªæˆ¿é—´é‡Œã€‚è¿™äº”ä½å“²å­¦å®¶åˆ†åˆ«æ˜¯å­”å­ã€åº„å­ã€å¢¨å­ã€å­™å­å’Œè€å­ï¼Œä»–ä»¬å›´ååœ¨ä¸€ä¸ªåœ†å½¢çš„é¤æ¡Œæ—ï¼Œé¤æ¡Œä¸Šæœ‰æ— å°½çš„å¯å£çš„é¥­èœï¼Œä¸å¹¸çš„æ˜¯ï¼Œå‡ºäºç¯ä¿çš„åŸå› ï¼Œåªæœ‰äº”æ ¹ç­·å­ï¼Œæ¯æ ¹ç­·å­éƒ½ä½äºä¸¤ä½å“²å­¦å®¶ä¹‹é—´ã€‚å“²å­¦å®¶åƒé¥­æ—¶ï¼Œå¿…é¡»æ‹¿èµ·è‡ªå·±å·¦å³ä¸¤è¾¹çš„ä¸¤æ ¹ç­·å­æ‰èƒ½åƒé¥­ï¼Œåƒå®Œé¥­åæ‰æ”¾å›ç­·å­ï¼Œè¿™æ ·å…¶å®ƒå“²å­¦å®¶å¯ä»¥å†æ‹¿èµ·ç­·å­ã€‚</p>
<p>è™½ç„¶éš”ç¦»çš„æ—¥å­æ¯”è¾ƒå¯‚å¯ï¼Œä½†æ˜¯è¿™äº›å“²å­¦å®¶è¿˜æ˜¯æœ‰äº‹æƒ…å¯åšï¼Œä»–ä»¬ä¸æ–­çš„å†¥æƒ³æˆ–è€…åƒé¥­ã€‚é¥¿äº†çš„æ—¶å€™å°±å¼€å§‹å°è¯•æ‹¿èµ·ç­·å­ï¼Œåƒéšæœºæ—¶é—´çš„é¥­èœï¼Œç„¶åæ”¾ä¸‹ç­·å­å¼€å§‹å†¥æƒ³ã€‚å†¥æƒ³ä¸€æ®µæ—¶é—´å°±é¥¿äº†ï¼Œåˆå¼€å§‹åƒé¥­ã€‚æ‰€ä»¥ä»–ä»¬æ€»æ˜¯å¤„äºå†¥æƒ³-é¥¿äº†-åƒé¥­-å†¥æƒ³è¿™æ ·çš„çŠ¶æ€ä¸­ã€‚</p>
<p><img src="1.png" alt=""></p>
<p>è¿™ä¸ªå“²å­¦å®¶å¾ˆå¥½çš„æ¨¡æ‹Ÿäº†è®¡ç®—æœºå¹¶å‘ç¼–ç¨‹ä¸­ä¸€å®šæ•°é‡çš„èµ„æºå’Œä¸€å®šæ•°é‡çš„æŒæœ‰è€…çš„å¹¶å‘é—®é¢˜ï¼Œè¿™ç±»é—®é¢˜å¾ˆå¤§çš„ä¸€ä¸ªé—®é¢˜å°±æ˜¯æ­»é”é—®é¢˜ã€‚</p>
<p>å¦‚æœäº”ä½å“²å­¦å®¶åŒæ—¶é¥¿äº†ï¼ŒåŒæ—¶æ‹¿èµ·å·¦æ‰‹è¾¹çš„é‚£æ ¹ç­·å­ï¼Œä½ å°±ä¼šå‘ç°ä»–ä»¬æƒ³å»æ‹¿å³è¾¹çš„ç­·å­çš„æ—¶å€™ï¼Œéƒ½æ²¡æœ‰åŠæ³•æ‹¿èµ·å³è¾¹çš„ç­·å­ï¼Œå› ä¸ºå³è¾¹é‚£æ ¹ç­·å­éƒ½è¢«æ—è¾¹çš„å“²å­¦å®¶æ‹¿èµ°äº†ï¼Œæ‰€æœ‰çš„å“²å­¦å®¶éƒ½å¤„äºç­‰å¾…çŠ¶æ€è€Œæ²¡æœ‰åŠæ³•ç»§ç»­ä¸‹å»ã€‚å¯¹äºç¨‹åºæ¥è¯´ï¼Œå°±æ˜¯ç¨‹åº hangæ­»äº†ï¼Œæ²¡æœ‰åŠæ³•ç»§ç»­å¤„ç†ã€‚</p>
<blockquote>
<p>å¦‚æœè¿™äº”ä½å“²å­¦å®¶åŒæ—¶å‘ç°æ²¡æœ‰å³è¾¹çš„ç­·å­å¯ç”¨ï¼Œä»–ä»¬åŒæ—¶æ”¾ä¸‹å·¦æ‰‹çš„ç­·å­ï¼Œå†¥æƒ³5åˆ†é’Ÿå†åŒæ—¶å°±é¤ï¼Œä½ ä¼šå‘ç°ç¨‹åºè²Œä¼¼è¿˜åœ¨è¿›è¡Œï¼Œä½†æ˜¯å“²å­¦å®¶ä¾ç„¶è¿˜æ˜¯æ²¡æœ‰åŠæ³•å°±é¤ï¼Œè¿™ç§ç°è±¡å«åšæ­»é”ã€‚åœ¨åˆ†å¸ƒå¼ä¸€è‡´æ€§ç®—æ³•ä¸­åœ¨é€‰ä¸»çš„æ—¶å€™ä¹Ÿä¼šæœ‰ç±»ä¼¼çš„ç°è±¡ï¼Œæœ‰äº›å®ç°æ˜¯é€šè¿‡éšæœºä¼‘çœ ä¸€å®šçš„æ—¶é—´ï¼Œé¿å…å„ä¸ªèŠ‚ç‚¹åŒæ—¶è¯·æ±‚é€‰ä¸»æ¥é¿å…ã€‚</p>
</blockquote>
<p>å¦‚æœç³»ç»Ÿä¸­åªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œå½“ç„¶ä¸ä¼šäº§ç”Ÿæ­»é”ã€‚å¦‚æœæ¯ä¸ªçº¿ç¨‹ä»…éœ€æ±‚ä¸€ç§å¹¶å‘èµ„æºï¼Œä¹Ÿä¸ä¼šäº§ç”Ÿæ­»é”ã€‚ä¸è¿‡è¿™åªæ˜¯ç†æƒ³çŠ¶æ€ï¼Œåœ¨ç°å®ä¸­æ˜¯å¯é‡ä¸å¯æ±‚çš„ã€‚å¦‚æœä½ æœç´¢Goå®˜æ–¹çš„é¡¹ç›®ä¸­çš„issue,å¯ä»¥çœ‹åˆ°å‡ ç™¾ä¸ªå…³äºæ­»é”çš„issue,è¶³å¯ä»¥è¡¨æ˜æ­»é”æ˜¯ä¸€ä¸ªå¸¸è§ä¸”å¹¶ä¸å®¹æ˜“å¤„ç†çš„bugã€‚</p>
<p><img src="2.png" alt=""></p>
<p>æ­»é”çš„å››ä¸ªæ¡ä»¶æ˜¯ï¼š</p>
<ul>
<li><p><strong>ç¦æ­¢æŠ¢å </strong>ï¼ˆno preemptionï¼‰ï¼šç³»ç»Ÿèµ„æºä¸èƒ½è¢«å¼ºåˆ¶ä»ä¸€ä¸ªçº¿ç¨‹ä¸­é€€å‡ºã€‚å¦‚æœå“²å­¦å®¶å¯ä»¥æŠ¢å¤ºï¼Œé‚£ä¹ˆå¤§å®¶éƒ½å»æŠ¢åˆ«äººçš„ç­·å­ï¼Œä¹Ÿä¼šæ‰“ç ´æ­»é”çš„å±€é¢ï¼Œä½†è¿™æ˜¯æœ‰é£é™©çš„ï¼Œå› ä¸ºå¯èƒ½å­”å­è¿˜æ²¡åƒé¥­å°±è¢«è€å­æŠ¢èµ°äº†ã€‚è®¡ç®—æœºèµ„æºå¦‚æœä¸æ˜¯ä¸»åŠ¨é‡Šæ”¾è€Œæ˜¯è¢«æŠ¢å¤ºæœ‰å¯èƒ½å‡ºç°æ„æƒ³ä¸åˆ°çš„ç°è±¡ã€‚</p>
</li>
<li><p><strong>æŒæœ‰å’Œç­‰å¾…</strong>ï¼ˆhold and waitï¼‰ï¼šä¸€ä¸ªçº¿ç¨‹åœ¨ç­‰å¾…æ—¶æŒæœ‰å¹¶å‘èµ„æºã€‚æŒæœ‰å¹¶å‘èµ„æºå¹¶è¿˜ç­‰å¾…å…¶å®ƒèµ„æºï¼Œä¹Ÿå°±æ˜¯åƒç€ç¢—é‡Œçš„æœ›ç€é”…é‡Œçš„ã€‚</p>
</li>
<li><p><strong>äº’æ–¥</strong>ï¼ˆmutual exclusionï¼‰ï¼šèµ„æºåªèƒ½åŒæ—¶åˆ†é…ç»™ä¸€ä¸ªçº¿ç¨‹ï¼Œæ— æ³•å¤šä¸ªçº¿ç¨‹å…±äº«ã€‚èµ„æºå…·æœ‰æ’ä»–æ€§ï¼Œå­”å­å’Œè€å­çš„å…³ç³»å†å¥½ï¼Œä¹Ÿä¸å…è®¸ä»–ä»¬ä¿©ä¸€èµ·æ‹¿ç€ä¸€æ ¹ç­·åŒæ—¶åƒã€‚</p>
</li>
<li><p><strong>å¾ªç¯ç­‰å¾…</strong>ï¼ˆcircular waitingï¼‰ï¼šä¸€ç³»åˆ—çº¿ç¨‹äº’ç›¸æŒæœ‰å…¶ä»–è¿›ç¨‹æ‰€éœ€è¦çš„èµ„æºã€‚å¿…é¡»æœ‰ä¸€ä¸ªå¾ªç¯ä¾èµ–çš„å…³ç³»ã€‚</p>
</li>
</ul>
<p>æ­»é”åªæœ‰åœ¨å››ä¸ªæ¡ä»¶åŒæ—¶æ»¡è¶³æ—¶å‘ç”Ÿï¼Œé¢„é˜²æ­»é”å¿…é¡»è‡³å°‘ç ´åå…¶ä¸­ä¸€é¡¹ã€‚</p>
<h2 id="æ¨¡æ‹Ÿå“²å­¦å®¶å°±é¤é—®é¢˜">æ¨¡æ‹Ÿå“²å­¦å®¶å°±é¤é—®é¢˜</h2>
<p>é¦–å…ˆæˆ‘ä»¬é€šè¿‡ç¨‹åºæ¨¡æ‹Ÿå“²å­¦å®¶å°±é¤é—®é¢˜ï¼Œçœ‹çœ‹ç¨‹åºåœ¨è¿è¡Œçš„æ˜¯ä¸æ˜¯ä¼šäº§ç”Ÿæ­»é”é—®é¢˜ã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬å®šä¹‰ç­·å­å¯¹è±¡å’Œå“²å­¦å®¶å¯¹è±¡ã€‚å…¶ä¸­ç­·å­æ˜¯å¹¶å‘èµ„æºï¼Œå…·æœ‰æ’ä»–æ€§ï¼Œæ‰€ä»¥å®ƒåŒ…å«ä¸€ä¸ªé”ï¼Œç”¨æ¥å®ç°äº’æ–¥ï¼Œå¹¶ä¸”ç¦æ­¢æŠ¢å (å…¶å®ƒéæŒæœ‰è¿™æ ¹ç­·å­çš„å“²å­¦å®¶ä¸èƒ½è°ƒç”¨Unlock,åªæœ‰æŒæœ‰è¿™æ ¹ç­·å­çš„å“²å­¦å®¶æ‰èƒ½è°ƒç”¨Unlock)ã€‚</p>
<p>æ¯ä¸ªå“²å­¦å®¶éœ€è¦å·¦æ‰‹çš„ç­·å­å’Œå³æ‰‹çš„ç­·å­ï¼Œstatusä»£è¡¨å“²å­¦å®¶çš„çŠ¶æ€(å†¥æƒ³ã€é¥¿äº†ã€å°±é¤ä¸­)ï¼Œä»–æœ‰ä¸€ç§çŠ¶æ€å°±æ˜¯æŒæœ‰ä¸€æ ¹ç­·å­å¹¶è¯·æ±‚å¦ä¸€æ ¹ç­·å­ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Chopstick ä»£è¡¨ç­·å­.</span></div><div class="line"><span class="keyword">type</span> Chopstick <span class="keyword">struct</span>{ sync.Mutex }</div><div class="line"></div><div class="line"><span class="comment">// Philosopher ä»£è¡¨å“²å­¦å®¶.</span></div><div class="line"><span class="keyword">type</span> Philosopher <span class="keyword">struct</span> {</div><div class="line">    <span class="comment">// å“²å­¦å®¶çš„åå­—</span></div><div class="line">    name <span class="typename">string</span></div><div class="line">    <span class="comment">// å·¦æ‰‹ä¸€åªå’Œå³æ‰‹ä¸€åªç­·å­</span></div><div class="line">    leftChopstick, rightChopstick *Chopstick</div><div class="line">    status                        <span class="typename">string</span></div><div class="line">}</div></pre></td></tr></table></figure>

<p>å“²å­¦å®¶åœ¨éš”ç¦»çš„æˆ¿é—´å°±æ˜¯ä¸æ–­çš„å†¥æƒ³ã€å°±é¤ã€å†¥æƒ³ã€å°±é¤...... æ°¸æ— ç»ˆæ—¥ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// æ— ä¼‘æ­¢çš„è¿›é¤å’Œå†¥æƒ³.</span></div><div class="line"><span class="comment">// åƒå®Œç¡(å†¥æƒ³ã€æ‰“å), ç¡å®Œåƒ.</span></div><div class="line"><span class="comment">// å¯ä»¥è°ƒæ•´åƒç¡çš„æ—¶é—´æ¥å¢åŠ æˆ–è€…å‡å°‘æŠ¢å¤ºå‰å­çš„æœºä¼š.</span></div><div class="line"><span class="keyword">func</span> (p *Philosopher) dine() {</div><div class="line">    <span class="keyword">for</span> {</div><div class="line">        mark(p, <span class="string">"å†¥æƒ³"</span>)</div><div class="line">        randomPause<span class="number">(10</span>)</div><div class="line"></div><div class="line">        mark(p, <span class="string">"é¥¿äº†"</span>)</div><div class="line">        p.leftChopstick.Lock() <span class="comment">// å…ˆå°è¯•æ‹¿èµ·å·¦æ‰‹è¾¹çš„ç­·å­</span></div><div class="line">        mark(p, <span class="string">"æ‹¿èµ·å·¦æ‰‹ç­·å­"</span>)</div><div class="line">        p.rightChopstick.Lock() <span class="comment">// å†å°è¯•æ‹¿èµ·å³æ‰‹è¾¹çš„ç­·å­</span></div><div class="line"></div><div class="line">        mark(p, <span class="string">"ç”¨è†³"</span>)</div><div class="line">        randomPause<span class="number">(10</span>)</div><div class="line"></div><div class="line">        p.rightChopstick.Unlock() <span class="comment">// å…ˆå°è¯•æ”¾ä¸‹å³æ‰‹è¾¹çš„ç­·å­</span></div><div class="line">        p.leftChopstick.Unlock()  <span class="comment">// å†å°è¯•æ‹¿èµ·å·¦æ‰‹è¾¹çš„ç­·å­</span></div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// éšæœºæš‚åœä¸€æ®µæ—¶</span></div><div class="line"><span class="keyword">func</span> randomPause(max <span class="typename">int</span>) {</div><div class="line">    time.Sleep(time.Millisecond * time.Duration(rand.Intn(max)))</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// æ˜¾ç¤ºæ­¤å“²å­¦å®¶çš„çŠ¶æ€</span></div><div class="line"><span class="keyword">func</span> mark(p *Philosopher, action <span class="typename">string</span>) {</div><div class="line">    fmt.Printf(<span class="string">"%så¼€å§‹%s\n"</span>, p.name, action)</div><div class="line">    p.status = fmt.Sprintf(<span class="string">"%så¼€å§‹%s\n"</span>, p.name, action)</div><div class="line">}</div></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„markç”¨æ¥åœ¨æ§åˆ¶å°è¾“å‡ºæ­¤å“²å­¦å®¶çš„çŠ¶æ€ï¼Œä¾¿äºæˆ‘ä»¬è§‚å¯Ÿã€‚</p>
<p>æœ€åä¸€æ­¥å°±æ˜¯å®ç°mainå‡½æ•°ï¼Œåˆ†é…5æ ¹ç­·å­å’Œäº”ä¸ªå“²å­¦å®¶ï¼Œè®©ç¨‹åºè¿è¡Œèµ·æ¥:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> main() {</div><div class="line">    <span class="keyword">go</span> http.ListenAndServe(<span class="string">"localhost:8972"</span>, <span class="constant">nil</span>)</div><div class="line"></div><div class="line">    <span class="comment">// å“²å­¦å®¶æ•°é‡</span></div><div class="line">    count :=<span class="number"> 5</span></div><div class="line"></div><div class="line">    <span class="comment">// åˆ›å»º5æ ¹ç­·å­</span></div><div class="line">    chopsticks := <span class="built_in">make</span>([]*Chopstick, count)</div><div class="line">    <span class="keyword">for</span> i :=<span class="number"> 0</span>; i &lt; count; i++ {</div><div class="line">        chopsticks[i] = <span class="built_in">new</span>(Chopstick)</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">//</span></div><div class="line">    names := []<span class="typename">string</span>{color.RedString(<span class="string">"å­”å­"</span>), color.MagentaString(<span class="string">"åº„å­"</span>), color.CyanString(<span class="string">"å¢¨å­"</span>), color.GreenString(<span class="string">"å­™å­"</span>), color.WhiteString(<span class="string">"è€å­"</span>)}</div><div class="line"></div><div class="line">    <span class="comment">// åˆ›å»ºå“²å­¦å®¶, åˆ†é…ç»™ä»–ä»¬å·¦å³æ‰‹è¾¹çš„å‰å­ï¼Œé¢†ä»–ä»¬åšåˆ°åœ†é¤æ¡Œä¸Š.</span></div><div class="line">    philosophers := <span class="built_in">make</span>([]*Philosopher, count)</div><div class="line">    <span class="keyword">for</span> i :=<span class="number"> 0</span>; i &lt; count; i++ {</div><div class="line">        philosophers[i] = &Philosopher{</div><div class="line">            name: names[i], leftChopstick: chopsticks[i], rightChopstick: chopsticks[(i<span class="number">+1</span>)%count],</div><div class="line">        }</div><div class="line">        <span class="keyword">go</span> philosophers[i].dine()</div><div class="line">    }</div><div class="line"></div><div class="line">    sigs := <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal,<span class="number"> 1</span>)</div><div class="line">    signal.Notify(sigs, syscall.SIGINT, syscall.SIGTERM)</div><div class="line">    &lt;-sigs</div><div class="line"></div><div class="line">    fmt.Println(<span class="string">"é€€å‡ºä¸­... æ¯ä¸ªå“²å­¦å®¶çš„çŠ¶æ€:"</span>)</div><div class="line">    <span class="keyword">for</span> _, p := <span class="keyword">range</span> philosophers {</div><div class="line">        fmt.Print(p.status)</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>è¿è¡Œè¿™ä¸ªç¨‹åºä½ ä¼šå¾ˆå¿«å°±å‘ç°è¿™ä¸ªç¨‹åºä¼šhangä½ï¼Œæ¯ä¸ªå“²å­¦å®¶éƒ½å¤„äºæ‹¿åˆ°å·¦æ‰‹ç­·å­ç­‰å¾…å³æ‰‹ç­·å­çš„çŠ¶æ€ã€‚</p>
<p>åœ¨æˆ‘ä»¬å®é™…çš„åº”ç”¨ä¸­ï¼Œæ­»é”é—®é¢˜å¹¶ä¸æ˜¯è¿™ä¹ˆå®¹æ˜“çš„è¢«å‘ç°çš„ï¼Œå¾ˆå¯èƒ½åœ¨ä¸€äº›éå¸¸ç‰¹å®šçš„åœºæ™¯(ä¹Ÿè¢«ç§°ä¹‹ä¸ºcorner case)æ‰ä¼šè¢«è§¦å‘å’Œå‘ç°ã€‚</p>
<h2 id="è§£æ³•ä¸€ï¼šé™åˆ¶å°±é¤äººæ•°">è§£æ³•ä¸€ï¼šé™åˆ¶å°±é¤äººæ•°</h2>
<p>æˆ‘ä»¬çŸ¥é“ï¼Œè§£å†³æ­»é”çš„é—®é¢˜å°±æ˜¯ç ´åæ­»é”å½¢æˆçš„å››ä¸ªæ¡ä»¶ä¹‹ä¸€å°±å¯ä»¥ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œç¦æ­¢æŠ¢å å’Œäº’æ–¥æ˜¯æˆ‘ä»¬å¿…é¡»çš„æ¡ä»¶ï¼Œæ‰€ä»¥å…¶å®ƒä¸¤ä¸ªæ¡ä»¶æ˜¯æˆ‘ä»¬é‡ç‚¹çªç ´çš„ç‚¹ã€‚</p>
<p>é’ˆå¯¹å“²å­¦å®¶å°±é¤é—®é¢˜ï¼Œå¦‚æœæˆ‘ä»¬é™åˆ¶æœ€å¤šå…è®¸å››ä½å“²å­¦å®¶åŒæ—¶å°±é¤ï¼Œå°±å¯ä»¥é¿å…å¾ªç¯ä¾èµ–çš„æ¡ä»¶ï¼Œå› ä¸ºä¾ç…§æŠ½å±‰åŸç†ï¼Œæ€»æ˜¯ä¼šæœ‰ä¸€ä½å“²å­¦å®¶å¯ä»¥æ‹¿åˆ°ä¸¤æ ¹ç­·å­ï¼Œæ‰€ä»¥ç¨‹åºå¯ä»¥è¿è¡Œä¸‹å»ã€‚</p>
<p>é’ˆå¯¹é™åˆ¶ç‰¹å®šæ•°é‡èµ„æºçš„æƒ…å†µï¼Œæœ€å¥½ç”¨çš„å¹¶å‘åŸè¯­å°±æ˜¯ä¿¡å·é‡(Semaphore)ã€‚Goå®˜æ–¹æä¾›äº†ä¸€ä¸ªæ‰©å±•åº“ï¼Œæä¾›äº†ä¸€ä¸ªSemaphoreçš„å®ç°ï¼š<a href="https://pkg.go.dev/golang.org/x/sync/semaphore" target="_blank" rel="external">semaphore/Weighted</a>ã€‚</p>
<p>æˆ‘ä»¬æŠŠè¿™ä¸ªä¿¡å·é‡åˆå§‹å€¼è®¾ç½®ä¸º4ï¼Œä»£è¡¨æœ€å¤šå…è®¸åŒæ—¶4ä½å“²å­¦å®¶å°±é¤ã€‚æŠŠè¿™ä¸ªä¿¡å·é‡ä¼ ç»™å“²å­¦å®¶å¯¹è±¡ï¼Œå“²å­¦å®¶æƒ³å°±é¤æ—¶å°±è¯·æ±‚è¿™ä¸ªä¿¡å·é‡ï¼Œå¦‚æœèƒ½å¾—åˆ°ä¸€ä¸ªè®¸å¯ï¼Œå°±å¯ä»¥å°±é¤ï¼Œåƒå®ŒæŠŠè®¸å¯é‡Šæ”¾å›ç»™ä¿¡å·é‡ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Philosopher <span class="keyword">struct</span> {</div><div class="line">    <span class="comment">// å“²å­¦å®¶çš„åå­—</span></div><div class="line">    name <span class="typename">string</span></div><div class="line">    <span class="comment">// å·¦æ‰‹ä¸€åªå’Œå³æ‰‹ä¸€åªç­·å­</span></div><div class="line">    leftChopstick, rightChopstick *Chopstick</div><div class="line">    status                        <span class="typename">string</span></div><div class="line">    <span class="comment">// ä¿¡å·é‡</span></div><div class="line">    sema *semaphore.Weighted</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// æ— ä¼‘æ­¢çš„è¿›é¤å’Œå†¥æƒ³.</span></div><div class="line"><span class="comment">// åƒå®Œç¡(å†¥æƒ³ã€æ‰“å), ç¡å®Œåƒ.</span></div><div class="line"><span class="comment">// å¯ä»¥è°ƒæ•´åƒç¡çš„æ—¶é—´æ¥å¢åŠ æˆ–è€…å‡å°‘æŠ¢å¤ºå‰å­çš„æœºä¼š.</span></div><div class="line"><span class="keyword">func</span> (p *Philosopher) dine() {</div><div class="line">    <span class="keyword">for</span> {</div><div class="line">        mark(p, <span class="string">"å†¥æƒ³"</span>)</div><div class="line">        randomPause<span class="number">(10</span>)</div><div class="line"></div><div class="line">        mark(p, <span class="string">"é¥¿äº†"</span>)</div><div class="line">        p.sema.Acquire(context.Background(),<span class="number"> 1</span>) <span class="comment">// è¯·æ±‚ä¸€ä¸ªè®¸å¯</span></div><div class="line">        p.leftChopstick.Lock() <span class="comment">// å…ˆå°è¯•æ‹¿èµ·å·¦æ‰‹è¾¹çš„ç­·å­</span></div><div class="line">        mark(p, <span class="string">"æ‹¿èµ·å·¦æ‰‹ç­·å­"</span>)</div><div class="line">        p.rightChopstick.Lock() <span class="comment">// å†å°è¯•æ‹¿èµ·å³æ‰‹è¾¹çš„ç­·å­</span></div><div class="line"></div><div class="line">        mark(p, <span class="string">"ç”¨è†³"</span>)</div><div class="line">        randomPause<span class="number">(10</span>)</div><div class="line"></div><div class="line">        p.rightChopstick.Unlock() <span class="comment">// å…ˆå°è¯•æ”¾ä¸‹å³æ‰‹è¾¹çš„ç­·å­</span></div><div class="line">        p.leftChopstick.Unlock()  <span class="comment">// å†å°è¯•æ‹¿èµ·å·¦æ‰‹è¾¹çš„ç­·å­</span></div><div class="line">        p.sema.Release<span class="number">(1</span>) <span class="comment">// é‡Šæ”¾è®¸å¯ç»™ä¿¡å·é‡</span></div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">func</span> main() {</div><div class="line">    ......</div><div class="line"></div><div class="line">    <span class="comment">// æœ€å¤šå…è®¸å››ä¸ªå“²å­¦å®¶å°±é¤</span></div><div class="line">    sema := semaphore.NewWeighted<span class="number">(4</span>)</div><div class="line">    <span class="comment">//</span></div><div class="line">    names := []<span class="typename">string</span>{color.RedString(<span class="string">"å­”å­"</span>), color.MagentaString(<span class="string">"åº„å­"</span>), color.CyanString(<span class="string">"å¢¨å­"</span>), color.GreenString(<span class="string">"å­™å­"</span>), color.WhiteString(<span class="string">"è€å­"</span>)}</div><div class="line"></div><div class="line">    <span class="comment">// åˆ›å»ºå“²å­¦å®¶, åˆ†é…ç»™ä»–ä»¬å·¦å³æ‰‹è¾¹çš„å‰å­ï¼Œé¢†ä»–ä»¬åšåˆ°åœ†é¤æ¡Œä¸Š.</span></div><div class="line">    philosophers := <span class="built_in">make</span>([]*Philosopher, count)</div><div class="line">    <span class="keyword">for</span> i :=<span class="number"> 0</span>; i &lt; count; i++ {</div><div class="line">        philosophers[i] = &Philosopher{</div><div class="line">            name: names[i], leftChopstick: chopsticks[i], rightChopstick: chopsticks[(i<span class="number">+1</span>)%count],</div><div class="line">            sema: sema,</div><div class="line">        }</div><div class="line">        <span class="keyword">go</span> philosophers[i].dine()</div><div class="line">    }</div><div class="line"></div><div class="line">    ......</div><div class="line">}</div></pre></td></tr></table></figure>

<p>ä½ å¯ä»¥è¿è¡Œè¿™ä¸ªç¨‹åºï¼Œçœ‹çœ‹æ˜¯å¦ç¨‹åºæ˜¯å¦è¿˜ä¼šè¢«hangä½ã€‚</p>
<h2 id="è§£æ³•äºŒï¼šå¥‡å¶èµ„æº">è§£æ³•äºŒï¼šå¥‡å¶èµ„æº</h2>
<p>æˆ‘ä»¬ç»™æ¯ä¸€ä½å“²å­¦å®¶ç¼–å·ï¼Œä»1åˆ°5, å¦‚æœæˆ‘ä»¬è§„å®šå¥‡æ•°å·çš„å“²å­¦å®¶é¦–å…ˆæ‹¿å·¦æ‰‹è¾¹çš„ç­·å­ï¼Œå†æ‹¿å³æ‰‹è¾¹çš„ç­·å­ï¼Œå¶æ•°å·çš„å“²å­¦å®¶å…ˆæ‹¿å³æ‰‹è¾¹çš„ç­·å­ï¼Œå†æ‹¿å·¦æ‰‹è¾¹çš„ç­·å­ï¼Œ é‡Šæ”¾ç­·å­çš„æ—¶å€™æŒ‰ç…§ç›¸åçš„é¡ºåºï¼Œè¿™æ ·ä¹Ÿå¯ä»¥é¿å…å‡ºç°å¾ªç¯ä¾èµ–çš„æƒ…å†µã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// æ— ä¼‘æ­¢çš„è¿›é¤å’Œå†¥æƒ³.</span></div><div class="line"><span class="comment">// åƒå®Œç¡(å†¥æƒ³ã€æ‰“å), ç¡å®Œåƒ.</span></div><div class="line"><span class="comment">// å¯ä»¥è°ƒæ•´åƒç¡çš„æ—¶é—´æ¥å¢åŠ æˆ–è€…å‡å°‘æŠ¢å¤ºå‰å­çš„æœºä¼š.</span></div><div class="line"><span class="keyword">func</span> (p *Philosopher) dine() {</div><div class="line">    <span class="keyword">for</span> {</div><div class="line">        mark(p, <span class="string">"å†¥æƒ³"</span>)</div><div class="line">        randomPause<span class="number">(10</span>)</div><div class="line"></div><div class="line">        mark(p, <span class="string">"é¥¿äº†"</span>)</div><div class="line">        <span class="keyword">if</span> p.ID<span class="number">%2</span> ==<span class="number"> 1</span> { <span class="comment">// å¥‡æ•°</span></div><div class="line">            p.leftChopstick.Lock() <span class="comment">// å…ˆå°è¯•æ‹¿èµ·å·¦æ‰‹è¾¹çš„ç­·å­</span></div><div class="line">            mark(p, <span class="string">"æ‹¿èµ·å·¦æ‰‹ç­·å­"</span>)</div><div class="line">            p.rightChopstick.Lock() <span class="comment">// å†å°è¯•æ‹¿èµ·å³æ‰‹è¾¹çš„ç­·å­</span></div><div class="line"></div><div class="line">            mark(p, <span class="string">"ç”¨è†³"</span>)</div><div class="line">            randomPause<span class="number">(10</span>)</div><div class="line"></div><div class="line">            p.rightChopstick.Unlock() <span class="comment">// å…ˆå°è¯•æ”¾ä¸‹å³æ‰‹è¾¹çš„ç­·å­</span></div><div class="line">            p.leftChopstick.Unlock()  <span class="comment">// å†å°è¯•æ”¾ä¸‹å·¦æ‰‹è¾¹çš„ç­·å­</span></div><div class="line">        } <span class="keyword">else</span> {</div><div class="line">            p.rightChopstick.Lock() <span class="comment">// å…ˆå°è¯•æ‹¿èµ·å³æ‰‹è¾¹çš„ç­·å­</span></div><div class="line">            mark(p, <span class="string">"æ‹¿èµ·å³æ‰‹ç­·å­"</span>)</div><div class="line">            p.leftChopstick.Lock() <span class="comment">// å†å°è¯•æ‹¿èµ·å·¦æ‰‹è¾¹çš„ç­·å­</span></div><div class="line"></div><div class="line">            mark(p, <span class="string">"ç”¨è†³"</span>)</div><div class="line">            randomPause<span class="number">(10</span>)</div><div class="line"></div><div class="line">            p.leftChopstick.Unlock()  <span class="comment">// å…ˆå°è¯•æ”¾ä¸‹å·¦æ‰‹è¾¹çš„ç­·å­</span></div><div class="line">            p.rightChopstick.Unlock() <span class="comment">// å†å°è¯•æ”¾ä¸‹å³æ‰‹è¾¹çš„ç­·å­</span></div><div class="line">        }</div><div class="line"></div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">func</span> main() {</div><div class="line">    ......</div><div class="line"></div><div class="line">    <span class="comment">// åˆ›å»ºå“²å­¦å®¶, åˆ†é…ç»™ä»–ä»¬å·¦å³æ‰‹è¾¹çš„å‰å­ï¼Œé¢†ä»–ä»¬åšåˆ°åœ†é¤æ¡Œä¸Š.</span></div><div class="line">    philosophers := <span class="built_in">make</span>([]*Philosopher, count)</div><div class="line">    <span class="keyword">for</span> i :=<span class="number"> 0</span>; i &lt; count; i++ {</div><div class="line">        philosophers[i] = &Philosopher{</div><div class="line">            ID:   i +<span class="number"> 1</span>,</div><div class="line">            name: names[i], leftChopstick: chopsticks[i], rightChopstick: chopsticks[(i<span class="number">+1</span>)%count],</div><div class="line">        }</div><div class="line">        <span class="keyword">go</span> philosophers[i].dine()</div><div class="line">    }</div><div class="line"></div><div class="line">    ......</div><div class="line">}</div></pre></td></tr></table></figure>

<p>è¿è¡Œè¿™ä¸ªç¨‹åºï¼Œä½ åŒæ ·ä¹Ÿä¼šå‘ç°ç¨‹åºå¯ä»¥é¡ºåˆ©æ‰§è¡Œä¸‹å»ï¼Œå¹¶ä¸ä¼šå‡ºç°æ­»é”çš„ç°è±¡ã€‚</p>
<h2 id="è§£æ³•ä¸‰ï¼šèµ„æºåˆ†çº§">è§£æ³•ä¸‰ï¼šèµ„æºåˆ†çº§</h2>
<p>å¦ä¸€ä¸ªç®€å•çš„è§£æ³•æ˜¯ä¸ºèµ„æºï¼ˆè¿™é‡Œæ˜¯ç­·å­ï¼‰åˆ†é…ä¸€ä¸ªååºæˆ–è€…åˆ†çº§çš„å…³ç³»ï¼Œå¹¶çº¦å®šæ‰€æœ‰èµ„æºéƒ½æŒ‰ç…§è¿™ç§é¡ºåºè·å–ï¼ŒæŒ‰ç›¸åé¡ºåºé‡Šæ”¾ï¼Œè€Œä¸”ä¿è¯ä¸ä¼šæœ‰ä¸¤ä¸ªæ— å…³èµ„æºåŒæ—¶è¢«åŒä¸€é¡¹å·¥ä½œæ‰€éœ€è¦ã€‚åœ¨å“²å­¦å®¶å°±é¤é—®é¢˜ä¸­ï¼Œç­·å­æŒ‰ç…§æŸç§è§„åˆ™ç¼–å·ä¸º1è‡³5ï¼Œæ¯ä¸€ä¸ªå·¥ä½œå•å…ƒï¼ˆå“²å­¦å®¶ï¼‰æ€»æ˜¯å…ˆæ‹¿èµ·å·¦å³ä¸¤è¾¹ç¼–å·è¾ƒä½çš„ç­·å­ï¼Œå†æ‹¿ç¼–å·è¾ƒé«˜çš„ã€‚ç”¨å®Œç­·å­åï¼Œä»–æ€»æ˜¯å…ˆæ”¾ä¸‹ç¼–å·è¾ƒé«˜çš„ç­·å­ï¼Œå†æ”¾ä¸‹ç¼–å·è¾ƒä½çš„ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå½“å››ä½å“²å­¦å®¶åŒæ—¶æ‹¿èµ·ä»–ä»¬æ‰‹è¾¹ç¼–å·è¾ƒä½çš„ç­·å­æ—¶ï¼Œåªæœ‰ç¼–å·æœ€é«˜çš„ç­·å­ç•™åœ¨æ¡Œä¸Šï¼Œä»è€Œç¬¬äº”ä½å“²å­¦å®¶å°±ä¸èƒ½ä½¿ç”¨ä»»ä½•ä¸€åªç­·å­äº†ã€‚è€Œä¸”ï¼Œåªæœ‰ä¸€ä½å“²å­¦å®¶èƒ½ä½¿ç”¨æœ€é«˜ç¼–å·çš„ç­·å­ï¼Œæ‰€ä»¥ä»–èƒ½ä½¿ç”¨ä¸¤åªç­·å­ç”¨é¤ã€‚å½“ä»–åƒå®Œåï¼Œä»–ä¼šå…ˆæ”¾ä¸‹ç¼–å·æœ€é«˜çš„ç­·å­ï¼Œå†æ”¾ä¸‹ç¼–å·è¾ƒä½çš„ç­·å­ï¼Œä»è€Œè®©å¦ä¸€ä½å“²å­¦å®¶æ‹¿èµ·åè¾¹çš„è¿™åªå¼€å§‹åƒä¸œè¥¿ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// æ— ä¼‘æ­¢çš„è¿›é¤å’Œå†¥æƒ³.</span></div><div class="line"><span class="comment">// åƒå®Œç¡(å†¥æƒ³ã€æ‰“å), ç¡å®Œåƒ.</span></div><div class="line"><span class="comment">// å¯ä»¥è°ƒæ•´åƒç¡çš„æ—¶é—´æ¥å¢åŠ æˆ–è€…å‡å°‘æŠ¢å¤ºå‰å­çš„æœºä¼š.</span></div><div class="line"><span class="keyword">func</span> (p *Philosopher) dine() {</div><div class="line">    <span class="keyword">for</span> {</div><div class="line">        mark(p, <span class="string">"å†¥æƒ³"</span>)</div><div class="line">        randomPause<span class="number">(10</span>)</div><div class="line"></div><div class="line">        mark(p, <span class="string">"é¥¿äº†"</span>)</div><div class="line">        <span class="keyword">if</span> p.ID ==<span class="number"> 5</span> { <span class="comment">//</span></div><div class="line">            p.rightChopstick.Lock() <span class="comment">// å…ˆå°è¯•æ‹¿èµ·ç¬¬1åªç­·å­</span></div><div class="line">            mark(p, <span class="string">"æ‹¿èµ·å·¦æ‰‹ç­·å­"</span>)</div><div class="line">            p.leftChopstick.Lock() <span class="comment">// å†å°è¯•æ‹¿èµ·ç¬¬5åªç­·å­</span></div><div class="line"></div><div class="line">            mark(p, <span class="string">"ç”¨è†³"</span>)</div><div class="line">            randomPause<span class="number">(10</span>)</div><div class="line"></div><div class="line">            p.leftChopstick.Unlock()  <span class="comment">// å…ˆå°è¯•æ”¾ä¸‹ç¬¬5åªçš„ç­·å­</span></div><div class="line">            p.rightChopstick.Unlock() <span class="comment">// å†å°è¯•æ”¾ä¸‹ç¬¬1åªçš„ç­·å­</span></div><div class="line">        } <span class="keyword">else</span> {</div><div class="line">            p.leftChopstick.Lock() <span class="comment">// å…ˆå°è¯•æ‹¿èµ·å·¦æ‰‹è¾¹çš„ç­·å­(ç¬¬nåª)</span></div><div class="line">            mark(p, <span class="string">"æ‹¿èµ·å³æ‰‹ç­·å­"</span>)</div><div class="line">            p.rightChopstick.Lock() <span class="comment">// å†å°è¯•æ‹¿èµ·å³æ‰‹è¾¹çš„ç­·å­(ç¬¬n+1åª)</span></div><div class="line"></div><div class="line">            mark(p, <span class="string">"ç”¨è†³"</span>)</div><div class="line">            randomPause<span class="number">(10</span>)</div><div class="line"></div><div class="line">            p.rightChopstick.Unlock() <span class="comment">// å…ˆå°è¯•æ”¾ä¸‹å³æ‰‹è¾¹çš„ç­·å­</span></div><div class="line">            p.leftChopstick.Unlock()  <span class="comment">// å†å°è¯•æ‹¿èµ·å·¦æ‰‹è¾¹çš„ç­·å­</span></div><div class="line">        }</div><div class="line"></div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<h2 id="è§£æ³•å››ï¼šå¼•å…¥æœåŠ¡ç”Ÿ">è§£æ³•å››ï¼šå¼•å…¥æœåŠ¡ç”Ÿ</h2>
<p>å¦‚æœæˆ‘ä»¬å¼•å…¥ä¸€ä¸ªæœåŠ¡ç”Ÿï¼Œæ¯”å¦‚éŸ©éå­ï¼Œç”±éŸ©éå­è´Ÿè´£åˆ†é…ç­·å­ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å°†æ‹¿å·¦æ‰‹ç­·å­å’Œå³æ‰‹ç­·å­çœ‹æˆä¸€ä¸ªåŸå­æ“ä½œï¼Œè¦ä¹ˆæ‹¿åˆ°ç­·å­ï¼Œè¦ä¹ˆç­‰å¾…ï¼Œå°±å¯ä»¥ç ´åæ­»é”çš„ç¬¬äºŒä¸ªæ¡ä»¶(æŒæœ‰å’Œç­‰å¾…)ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Philosopher <span class="keyword">struct</span> {</div><div class="line">    <span class="comment">// å“²å­¦å®¶çš„åå­—</span></div><div class="line">    name <span class="typename">string</span></div><div class="line">    <span class="comment">// å·¦æ‰‹ä¸€åªå’Œå³æ‰‹ä¸€åªç­·å­</span></div><div class="line">    leftChopstick, rightChopstick *Chopstick</div><div class="line">    status                        <span class="typename">string</span></div><div class="line"></div><div class="line">    mu *sync.Mutex</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// æ— ä¼‘æ­¢çš„è¿›é¤å’Œå†¥æƒ³.</span></div><div class="line"><span class="comment">// åƒå®Œç¡(å†¥æƒ³ã€æ‰“å), ç¡å®Œåƒ.</span></div><div class="line"><span class="comment">// å¯ä»¥è°ƒæ•´åƒç¡çš„æ—¶é—´æ¥å¢åŠ æˆ–è€…å‡å°‘æŠ¢å¤ºå‰å­çš„æœºä¼š.</span></div><div class="line"><span class="keyword">func</span> (p *Philosopher) dine() {</div><div class="line">    <span class="keyword">for</span> {</div><div class="line">        mark(p, <span class="string">"å†¥æƒ³"</span>)</div><div class="line">        randomPause<span class="number">(10</span>)</div><div class="line"></div><div class="line">        mark(p, <span class="string">"é¥¿äº†"</span>)</div><div class="line">        p.mu.Lock() <span class="comment">// æœåŠ¡ç”Ÿæ§åˆ¶</span></div><div class="line">        p.leftChopstick.Lock() <span class="comment">// å…ˆå°è¯•æ‹¿èµ·å·¦æ‰‹è¾¹çš„ç­·å­</span></div><div class="line">        mark(p, <span class="string">"æ‹¿èµ·å·¦æ‰‹ç­·å­"</span>)</div><div class="line">        p.rightChopstick.Lock() <span class="comment">// å†å°è¯•æ‹¿èµ·å³æ‰‹è¾¹çš„ç­·å­</span></div><div class="line">        p.mu.Unlock() </div><div class="line"></div><div class="line">        mark(p, <span class="string">"ç”¨è†³"</span>)</div><div class="line">        randomPause<span class="number">(10</span>)</div><div class="line"></div><div class="line">        p.rightChopstick.Unlock() <span class="comment">// å…ˆå°è¯•æ”¾ä¸‹å³æ‰‹è¾¹çš„ç­·å­</span></div><div class="line">        p.leftChopstick.Unlock()  <span class="comment">// å†å°è¯•æ‹¿èµ·å·¦æ‰‹è¾¹çš„ç­·å­</span></div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>å®Œæ•´ä»£ç å¯ä»¥å‚è€ƒ [dive-to-gosync-workshop(<a href="https://github.com/smallnest/dive-to-gosync-workshop/tree/master/11.classical_problems" target="_blank" rel="external">https://github.com/smallnest/dive-to-gosync-workshop/tree/master/11.classical_problems</a>)</p>
<p>ä¸‹ä¸€ç¯‡æˆ‘ä»¬è®²è§£å¦å¤–ä¸€ä¸ªç»å…¸å¹¶å‘é—®é¢˜ï¼šä¸€æ°§åŒ–äºŒæ°¢çš„ç”Ÿæˆã€‚</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>å“²å­¦å®¶å°±é¤é—®é¢˜æ˜¯ä¸€ä¸ªéå¸¸éå¸¸ç»å…¸çš„é—®é¢˜ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªéå¸¸é€šç”¨çš„ç ”ç©¶å¹¶å‘ç¼–ç¨‹ä¸­æ­»é”ç°è±¡çš„é—®é¢˜ã€‚</p>
]]>
    
    </summary>
    
      <category term="Go" scheme="https://colobu.com/categories/Go/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[pyroscope: ä¸€ä¸ªç®€å•æ˜“ç”¨çš„æŒç»­å‰–æå¹³å°]]></title>
    <link href="https://colobu.com/2022/01/27/pyroscope-a-continuous-profiling-platform/"/>
    <id>https://colobu.com/2022/01/27/pyroscope-a-continuous-profiling-platform/</id>
    <published>2022-01-27T10:56:27.000Z</published>
    <updated>2022-01-27T11:00:43.197Z</updated>
    <content type="html"><![CDATA[<p>å¼€å‘äººå‘˜å¸¸å¸¸éœ€è¦è·Ÿè¸ªç”Ÿäº§ç¯å¢ƒä¸­çš„åº”ç”¨ç¨‹åºçš„æ€§èƒ½ç“¶é¢ˆï¼Œå¹¶è¯•å›¾æ‰¾å‡ºé€ æˆç“¶é¢ˆçš„æ ¹æœ¬åŸå› ã€‚è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œä»–ä»¬é€šå¸¸ä¼šé€šè¿‡æ—¥å¿—æ¥æ”¶é›†è¿™äº›ä¿¡æ¯ã€‚ä¸å¹¸çš„æ˜¯ï¼Œè¿™ç§æ–¹æ³•å¯èƒ½ä¼šå¾ˆè€—æ—¶ï¼Œè€Œä¸”æ— æ³•æä¾›æœ‰å…³æ½œåœ¨é—®é¢˜çš„è¶³å¤Ÿè¯¦ç»†çš„ä¿¡æ¯ã€‚</p>
<p>ä¸€ç§ç°ä»£ä¸”æ›´å…ˆè¿›çš„æ–¹æ³•æ˜¯åº”ç”¨å’Œä½¿ç”¨profilingæŠ€æœ¯å’Œå·¥å…·ï¼Œçªå‡ºæ˜¾ç¤ºæœ€æ…¢çš„åº”ç”¨ç¨‹åºä»£ç å’Œæ¶ˆè€—å¤§éƒ¨åˆ†èµ„æºï¼ˆå¦‚CPUå’Œå†…å­˜ï¼‰çš„æ–¹æ³•ã€‚æŒç»­åˆ†æ(Continuous profiling)æ˜¯åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æŒç»­    æ”¶é›†åº”ç”¨ç¨‹åºæ€§èƒ½æ•°æ®ï¼Œå¹¶å°†è¿™äº›æ•°æ®æä¾›ç»™å¼€å‘äººå‘˜è¿›è¡Œæ·±å…¥åˆ†æçš„è¿‡ç¨‹ã€‚</p>
<p>é€šè¿‡ï¼Œæˆ‘ä»¬é€šè¿‡é‡‡é›†ç¨‹åºçš„æŒ‡æ ‡ï¼Œç”Ÿæˆä¸€ä¸ªæ¦‚è¦æ–‡ä»¶(Profile)è¿›è¡Œå•æ¬¡çš„åˆ†æã€‚Goè¯­è¨€æä¾›äº†pprofå·¥å…·ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„ç”Ÿæˆprofileæ–‡ä»¶ã€‚ä½ å¯ä»¥é€šè¿‡ç¨‹åºè°ƒç”¨<a href="https://pkg.go.dev/runtime/pprof" target="_blank" rel="external">runtime/pprof</a>ç”ŸæˆCPUã€Heapç­‰æ¦‚è¦æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨<a href="https://pkg.go.dev/net/http/pprof" target="_blank" rel="external">net/http/pprof</a>é›†æˆåˆ°webåº”ç”¨ç¨‹åºä¸­ï¼Œé€šè¿‡go tool pprofå·¥å…·åœ¨å‘½ä»¤è¡Œæˆ–è€…webé¡µé¢ä¸­è¿›è¡Œåˆ†æã€‚</p>
<p>æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬ä¸èƒ½åŠæ—¶çš„è¿›è¡Œpprofåˆ†æï¼Œæ•…éšœå¯èƒ½æ¶ˆå¤±äº†æˆ–è€…ç¨‹åºå·²ç»crashäº†ã€‚å¦å¤–æˆ‘ä»¬å¯èƒ½éœ€è¦ä¸åŒæ—¶æ®µçš„profileè¿›è¡Œå¯¹æ¯”ï¼Œè¿›è¡Œæ¯”è¾ƒæ‰èƒ½å‘ç°é—®é¢˜ï¼Œæ¯”å¦‚å†…å­˜æ³„éœ²çš„é—®é¢˜ã€‚è¿™ä¸ªæ—¶å€™æŒç»­åˆ†æ(continuous profiling)å°±å¾ˆé‡è¦äº†ã€‚å¾ˆå¤šäº‘æœåŠ¡å‚å•†éƒ½æä¾›æŒç»­åˆ†æçš„åŠŸèƒ½ï¼Œæ¯”å¦‚<a href="https://www.datadoghq.com/dg/apm/ts/profiler/go-continuous-profiler-ts/?utm_source=advertisement&amp;utm_medium=search&amp;utm_campaign=dg-google-profiler-emea-goprofiling-tshirt&amp;utm_keyword=%2Bgo %2Bprofiling&amp;utm_matchtype=b&amp;utm_campaignid=15426873343&amp;utm_adgroupid=128217964697&amp;gclid=Cj0KCQiA_8OPBhDtARIsAKQu0gYymyElbglw_I7uZJkZ7ynxfzn1nVojVZJ9rkm_6_hbchG09w4CCmEaAkWfEALw_wcB" target="_blank" rel="external">Go Continuous Profiler | Datadog</a>ã€<a href="https://cloud.google.com/profiler/docs" target="_blank" rel="external">Cloud Profiler | Google Cloud</a>ã€<a href="https://aws.amazon.com/cn/codeguru/features/" target="_blank" rel="external">Amazon CodeGuru Profiler</a>ç­‰ã€‚</p>
<a id="more"></a>
<h2 id="Pyroscopeç®€ä»‹">Pyroscopeç®€ä»‹</h2>
<p>å¦‚æœä½ æƒ³åœ¨è‡ªå·±çš„ç”Ÿäº§ç³»ç»Ÿä¸­ä½¿ç”¨æŒç»­åˆ†æï¼Œå¯ä»¥è€ƒè™‘<a href="https://pyroscope.io/" target="_blank" rel="external">Pyroscope</a>ã€‚</p>
<p>Pyroscopeæ˜¯ä¸€ä¸ªå¼€æºçš„æŒç»­åˆ†æç³»ç»Ÿï¼Œä½¿ç”¨Goè¯­è¨€å®ç°ã€‚æœåŠ¡ç«¯ä½¿ç”¨webé¡µé¢æŸ¥çœ‹ï¼Œæä¾›ä¸°å¯Œçš„åˆ†æçš„åŠŸèƒ½ï¼Œå®¢æˆ·ç«¯æä¾›Goã€Javaã€Pythonã€Rubyã€PHPã€.NETç­‰å¤šç§è¯­è¨€çš„æ”¯æŒï¼Œå¹¶ä¸”æ”¯æŒPUSHã€PULLä¸¤ç§é‡‡é›†æ–¹å¼ã€‚</p>
<p><img src="0.svg" alt="deployment diagram"></p>
<p>é¦–å…ˆï¼Œä½ éœ€è¦éƒ¨ç½²ä¸€ä¸ªPyroscope serverï¼Œå®ƒåº•å±‚é‡‡ç”¨BadgerDBä½œä¸ºå­˜å‚¨å¼•æ“ï¼Œå¯¹profileæ•°æ®è¿›è¡Œäº†ä¼˜åŒ–å¤„ç†ã€‚</p>
<p>Pyroscope serverè´Ÿè´£æ¥æ”¶(æˆ–è€…æ‹‰å–ï¼Œä¸‹é¢æˆ‘ä»¬ä¸»è¦æ¼”ç¤ºæ¨çš„æ–¹å¼)agentä¸Šä¼ çš„profileæ•°æ®ï¼Œå¹¶æä¾›æ—¶é—´çº¿ç•Œé¢ï¼Œå¯ä»¥æŸ¥çœ‹ä¸€æ®µæ—¶é—´ä»¥å†…çš„profileæ•°æ®ã€‚æ¯”å¦‚ä¸‹å›¾æ¼”ç¤ºäº†ä¸€ä¸ª<a href="https://rpcx.io" target="_blank" rel="external">rpcx</a>å¾®æœåŠ¡ç¨‹åº12ä¸ªå°æ—¶çš„profileæ•°æ®ã€‚</p>
<p><img src="1.png" alt="image-20220127133952215"></p>
<p>å®ƒæ—¢å¯ä»¥æ˜¾ç¤ºè¿™ä¸€æ®µæ—¶é—´å†…çš„ç«ç„°å›¾ï¼Œä¹Ÿå¯ä»¥æ˜¾ç¤ºæ’åºè¡¨æ ¼å±•ç¤ºï¼Œæˆ–è€…åŒæ—¶æ˜¾ç¤ºã€‚è¿™ä¸ªç«ç„°å›¾å¯ä»¥çœ‹å‡ºè€—æ—¶ä¸»è¦åœ¨å¾®æœåŠ¡çš„æ–¹æ³•è°ƒç”¨å’Œç¼–è§£ç ä¸Š(é™¤äº†Goè¿è¡Œæ—¶è°ƒåº¦)ã€‚</p>
<p>ä½ è¿˜å¯ä»¥é€‰å–ä¸åŒçš„æ—¶é—´æ®µè¿›è¡Œæ¯”è¾ƒ, å·¦å³çš„å›¾å½¢çš„æ—¶é—´åªéœ€åœ¨æ—¶é—´çº¿ä¸Šæ‹–æ‹½é€‰å–å³å¯ã€‚</p>
<p><img src="2.png" alt="image-20220127134555179"></p>
<p>è¿˜å¯ä»¥è¿›è¡ŒdiffæŸ¥çœ‹ï¼Œè¿™ä¸ªå¸¸å¸¸ç”¨åœ¨å†…å­˜æ³„éœ²çš„åˆ†æä¸Šã€‚</p>
<p><img src="3.png" alt="image-20220127135630155"></p>
<h2 id="Pyroscope_serverå®‰è£…">Pyroscope serverå®‰è£…</h2>
<p>Pyroscope serverç«¯å¯ä»¥é€šè¿‡dockerå®‰è£…:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run -it -p <span class="number">4040</span>:<span class="number">4040</span> pyroscope/pyroscope:latest server</div></pre></td></tr></table></figure>

<p>ä¹Ÿå¯ä»¥åœ¨å„ä¸­æ“ä½œç³»ç»Ÿä¸­ç›´æ¥å®‰è£…ã€‚</p>
<p>æ¯”å¦‚Mac:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">brew install pyroscope-io/brew/pyroscope</div><div class="line">brew services start pyroscope-server</div></pre></td></tr></table></figure>

<p>å„Liunxå‘è¡Œç‰ˆä¹Ÿæ–¹ä¾¿å®‰è£…ï¼Œæ¯”å¦‚Cebtos:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">wget https://dl.pyroscope.io/release/pyroscope-<span class="number">0.8</span>.<span class="number">0</span>-<span class="number">1</span>-x86_64.rpm</div><div class="line"><span class="built_in">sudo</span> yum localinstall pyroscope-<span class="number">0.8</span>.<span class="number">0</span>-<span class="number">1</span>-x86_64.rpm</div><div class="line"><span class="built_in">sudo</span> systemctl start pyroscope-server</div><div class="line"><span class="built_in">sudo</span> systemctl enable pyroscope-server</div></pre></td></tr></table></figure>

<p>æ¯”å¦‚ubuntu:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">wget https://dl.pyroscope.io/release/pyroscope_0.<span class="number">8.0</span>_amd64.deb</div><div class="line"><span class="built_in">sudo</span> apt-get install ./pyroscope_0.<span class="number">8.0</span>_amd64.deb</div></pre></td></tr></table></figure>

<p>å®‰è£…å®Œæˆåï¼Œå°±å¯ä»¥é€šè¿‡webç•Œé¢è®¿é—®äº†: <a href="http://localhost:4040" target="_blank" rel="external">http://localhost:4040</a>, ä½ å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶æ›´æ”¹ç›‘å¬ç«¯å£ä»¥åŠå…¶å®ƒä¸€äº›é…ç½®é¡¹ã€‚</p>
<h2 id="å®¢æˆ·ç«¯é›†æˆ">å®¢æˆ·ç«¯é›†æˆ</h2>
<p>ä¸Šé¢å·²ç»æåˆ°ï¼ŒPyroscopeæä¾›äº†å¥½å‡ ç§è¯­è¨€çš„agent sdk, æˆ‘ä»¬ä»¥Go  Pushæ–¹å¼ä¸ºä¾‹ã€‚åœ¨ä½ éœ€è¦æŒç»­åˆ†æçš„åº”ç”¨ç¨‹åºçš„å¼€å§‹åŠ å…¥agentçš„é…ç½®:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">pyroscope.Start(pyroscope.Config{</div><div class="line">    ApplicationName: <span class="string">"simple.golang.app"</span>,</div><div class="line"></div><div class="line">    <span class="comment">// replace this with the address of pyroscope server</span></div><div class="line">    ServerAddress:   <span class="string">"http://pyroscope-server:4040"</span>,</div><div class="line"></div><div class="line">    <span class="comment">// you can disable logging by setting this to nil</span></div><div class="line">    Logger:          pyroscope.StandardLogger,</div><div class="line"></div><div class="line">    <span class="comment">// by default all profilers are enabled,</span></div><div class="line">    <span class="comment">// but you can select the ones you want to use:</span></div><div class="line">    ProfileTypes: []pyroscope.ProfileType{</div><div class="line">      pyroscope.ProfileCPU,</div><div class="line">      pyroscope.ProfileAllocObjects,</div><div class="line">      pyroscope.ProfileAllocSpace,</div><div class="line">      pyroscope.ProfileInuseObjects,</div><div class="line">      pyroscope.ProfileInuseSpace,</div><div class="line">    },</div><div class="line">  })</div></pre></td></tr></table></figure>

<p>ä¸»è¦é…ç½®ApplicationNameçš„åç§°ï¼Œè¿™ä¸ªåç§°ä¼šæ˜¾ç¤ºåœ¨Pyroscopeçš„æœåŠ¡ç«¯ä¸‹æ‹‰æ¡†ä¸­ã€‚profileæ•°æ®è¦å‘é€åˆ°å“ªä¸€ä¸ªPyroscopeæœåŠ¡å™¨ä¸Šï¼Œä½ å¯ä»¥é…ç½®ServerAddress,ä»¥åŠé€šè¿‡ProfileTypesç›‘æ§è¦ç›‘æ§çš„Profileé¡¹ã€‚</p>
<p>åªéœ€åŠ ä¸Šè¿™å‡ è¡Œå¯åŠ¨ç¨‹åºåï¼Œä½ å°±å¯ä»¥åœ¨Pyroscope serverçš„webç•Œé¢ä¸ŠæŸ¥çœ‹æŒç»­åˆ†æçš„æ•°æ®äº†ã€‚</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>å¼€å‘äººå‘˜å¸¸å¸¸éœ€è¦è·Ÿè¸ªç”Ÿäº§ç¯å¢ƒä¸­çš„åº”ç”¨ç¨‹åºçš„æ€§èƒ½ç“¶é¢ˆï¼Œå¹¶è¯•å›¾æ‰¾å‡ºé€ æˆç“¶é¢ˆçš„æ ¹æœ¬åŸå› ã€‚è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œä»–ä»¬é€šå¸¸ä¼šé€šè¿‡æ—¥å¿—æ¥æ”¶é›†è¿™äº›ä¿¡æ¯ã€‚ä¸å¹¸çš„æ˜¯ï¼Œè¿™ç§æ–¹æ³•å¯èƒ½ä¼šå¾ˆè€—æ—¶ï¼Œè€Œä¸”æ— æ³•æä¾›æœ‰å…³æ½œåœ¨é—®é¢˜çš„è¶³å¤Ÿè¯¦ç»†çš„ä¿¡æ¯ã€‚</p>
<p>ä¸€ç§ç°ä»£ä¸”æ›´å…ˆè¿›çš„æ–¹æ³•æ˜¯åº”ç”¨å’Œä½¿ç”¨profilingæŠ€æœ¯å’Œå·¥å…·ï¼Œçªå‡ºæ˜¾ç¤ºæœ€æ…¢çš„åº”ç”¨ç¨‹åºä»£ç å’Œæ¶ˆè€—å¤§éƒ¨åˆ†èµ„æºï¼ˆå¦‚CPUå’Œå†…å­˜ï¼‰çš„æ–¹æ³•ã€‚æŒç»­åˆ†æ(Continuous profiling)æ˜¯åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æŒç»­    æ”¶é›†åº”ç”¨ç¨‹åºæ€§èƒ½æ•°æ®ï¼Œå¹¶å°†è¿™äº›æ•°æ®æä¾›ç»™å¼€å‘äººå‘˜è¿›è¡Œæ·±å…¥åˆ†æçš„è¿‡ç¨‹ã€‚</p>
<p>é€šè¿‡ï¼Œæˆ‘ä»¬é€šè¿‡é‡‡é›†ç¨‹åºçš„æŒ‡æ ‡ï¼Œç”Ÿæˆä¸€ä¸ªæ¦‚è¦æ–‡ä»¶(Profile)è¿›è¡Œå•æ¬¡çš„åˆ†æã€‚Goè¯­è¨€æä¾›äº†pprofå·¥å…·ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„ç”Ÿæˆprofileæ–‡ä»¶ã€‚ä½ å¯ä»¥é€šè¿‡ç¨‹åºè°ƒç”¨<a href="https://pkg.go.dev/runtime/pprof" target="_blank" rel="external">runtime/pprof</a>ç”ŸæˆCPUã€Heapç­‰æ¦‚è¦æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨<a href="https://pkg.go.dev/net/http/pprof" target="_blank" rel="external">net/http/pprof</a>é›†æˆåˆ°webåº”ç”¨ç¨‹åºä¸­ï¼Œé€šè¿‡go tool pprofå·¥å…·åœ¨å‘½ä»¤è¡Œæˆ–è€…webé¡µé¢ä¸­è¿›è¡Œåˆ†æã€‚</p>
<p>æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬ä¸èƒ½åŠæ—¶çš„è¿›è¡Œpprofåˆ†æï¼Œæ•…éšœå¯èƒ½æ¶ˆå¤±äº†æˆ–è€…ç¨‹åºå·²ç»crashäº†ã€‚å¦å¤–æˆ‘ä»¬å¯èƒ½éœ€è¦ä¸åŒæ—¶æ®µçš„profileè¿›è¡Œå¯¹æ¯”ï¼Œè¿›è¡Œæ¯”è¾ƒæ‰èƒ½å‘ç°é—®é¢˜ï¼Œæ¯”å¦‚å†…å­˜æ³„éœ²çš„é—®é¢˜ã€‚è¿™ä¸ªæ—¶å€™æŒç»­åˆ†æ(continuous profiling)å°±å¾ˆé‡è¦äº†ã€‚å¾ˆå¤šäº‘æœåŠ¡å‚å•†éƒ½æä¾›æŒç»­åˆ†æçš„åŠŸèƒ½ï¼Œæ¯”å¦‚<a href="https://www.datadoghq.com/dg/apm/ts/profiler/go-continuous-profiler-ts/?utm_source=advertisement&amp;utm_medium=search&amp;utm_campaign=dg-google-profiler-emea-goprofiling-tshirt&amp;utm_keyword=%2Bgo %2Bprofiling&amp;utm_matchtype=b&amp;utm_campaignid=15426873343&amp;utm_adgroupid=128217964697&amp;gclid=Cj0KCQiA_8OPBhDtARIsAKQu0gYymyElbglw_I7uZJkZ7ynxfzn1nVojVZJ9rkm_6_hbchG09w4CCmEaAkWfEALw_wcB" target="_blank" rel="external">Go Continuous Profiler | Datadog</a>ã€<a href="https://cloud.google.com/profiler/docs" target="_blank" rel="external">Cloud Profiler | Google Cloud</a>ã€<a href="https://aws.amazon.com/cn/codeguru/features/" target="_blank" rel="external">Amazon CodeGuru Profiler</a>ç­‰ã€‚</p>
]]>
    
    </summary>
    
      <category term="Go" scheme="https://colobu.com/categories/Go/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[é¢è¯•å®˜æé—®ä¸‰ä¸ªGoæ¥å£çš„æ¦‚å¿µï¼Œ 10å¹´gopherç«Ÿæ— è¨€ä»¥å¯¹]]></title>
    <link href="https://colobu.com/2022/01/16/three-new-concepts-of-go-interface-since-1-18/"/>
    <id>https://colobu.com/2022/01/16/three-new-concepts-of-go-interface-since-1-18/</id>
    <published>2022-01-16T11:44:58.000Z</published>
    <updated>2022-01-16T14:00:52.957Z</updated>
    <content type="html"><![CDATA[<p>è‡ª Go 1.18åï¼Œ Goçš„interfaceçš„å«ä¹‰æœ‰æ‰€<a href="https://colobu.com/2022/01/08/the-interface-is-not-that-interface-in-go-1-18/" target="_blank" rel="external">å˜åŒ–</a>, ä¸‰ä¸ªæ–°çš„å’ŒGoæ¥å£æœ‰å…³çš„æ¦‚å¿µå¾ˆå¤šäººè¿˜ä¸çŸ¥é“: <code>type set</code>(ç±»å‹é›†åˆ)ã€<code>specific type</code>(ç‰¹å®šç±»å‹)å’Œ<code>structural type</code>(ç»“æ„ç±»å‹)ã€‚</p>
<a id="more"></a>
<h2 id="type_set_(ç±»å‹é›†åˆ)">type set (ç±»å‹é›†åˆ)</h2>
<p>type setç§°ä¹‹ä¸ºç±»å‹é›†åˆï¼Œä¸€äº›å…³æ³¨Goæ³›å‹çš„æœ‹å‹å…¶å®ä¹Ÿå¯¹æ­¤æœ‰äº›äº†è§£ï¼Œå®ƒæ˜¯Go 1.18æ–°å¢åŠ çš„ä¸€ä¸ªæ¦‚å¿µã€‚</p>
<p>Go 1.18ä¹‹å‰ï¼ŒGoçš„æ¥å£ä»£è¡¨äº†ä¸€ç»„æ–¹æ³•çš„é›†åˆ(method set),å‡¡æ˜¯å®ç°äº†è¿™äº›æ–¹æ³•é›†åˆçš„ç±»å‹ï¼Œéƒ½è¢«ç§°ä¹‹ä¸ºå®ç°äº†è¿™ä¸ªæ¥å£ã€‚Goä¸åƒJavaè¯­è¨€ï¼Œéœ€è¦æ˜¾ç¤ºåœ°å®šä¹‰æŸä¸ªç±»å®ç°æŸä¸ªæ¥å£ï¼ŒGoä¸éœ€è¦è¿™æ ·ï¼Œåœ¨Goä¸­ï¼Œåªè¦ä¸€ä¸ªç±»å‹å®ç°äº†æŸä¸ªæ¥å£å®šä¹‰çš„æ‰€æœ‰æ–¹æ³•ï¼Œå®ƒå°±å®ç°äº†è¿™ä¸ªæ¥å£ï¼Œå¯ä»¥èµ‹å€¼ç»™è¿™ä¸ªæ¥å£ç±»å‹çš„å˜é‡ï¼Œæˆ–è€…ä½œä¸ºè¿™ä¸ªæ¥å£ç±»å‹çš„æ–¹æ³•çš„å®å‚æˆ–è€…è¿”å›å€¼ï¼Œè¿™ç§è®¾è®¡æœ‰æ—¶å€™ä¹Ÿè¢«å«åš<code>é¸­å­ç±»å‹</code>(duck typing)ã€‚åªè¦å®ƒèµ°èµ·æ¥åƒé¸­å­ï¼Œå«èµ·æ¥åƒé¸­å­ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯é¸­å­ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆç»å…¸çš„å¯¹é¸­å­ç±»å‹çš„æè¿°ã€‚</p>
<p>åœ¨Go 1.18ä¸­ï¼Œæ¥å£ä¸å†ä»£è¡¨æ–¹æ³•çš„é›†åˆäº†ï¼Œè€Œæ˜¯ä»£è¡¨ç±»å‹çš„é›†åˆ(type set)ã€‚åªè¦æŸç§ç±»å‹åœ¨è¿™ä¸ªæ¥å£çš„ç±»å‹é›†åˆä¸­ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è¯´è¿™ç§ç±»å‹å®ç°äº†è¿™ä¸ªæ¥å£ã€‚å¦‚æœè¿™ä¸ªæ¥å£è¢«ç”¨ä½œç±»å‹çº¦æŸï¼Œé‚£ä¹ˆåœ¨è¿™ä¸ªæ¥å£å®šä¹‰çš„ç±»å‹é›†åˆä¸­çš„ä»»æ„ä¸€ä¸ªå…ƒç´ ï¼Œéƒ½å¯ä»¥å®ä¾‹åŒ–è¿™ä¸ªç±»å‹å‚æ•°ã€‚</p>
<p>æ‰€ä»¥ï¼Œå®é™…ä¸Šï¼Œä¸ºäº†æ”¯æŒæ¥å£ä½œä¸ºç±»å‹çº¦æŸçš„æ‰©å±•ï¼ŒGoè¯­è¨€è§„èŒƒä¸å¾—ä¸é‡æ–°å®šä¹‰æ¥å£çš„å«ä¹‰äº†ï¼Œè¿™ä¹Ÿæ˜¯ç±»å‹é›†åˆå‡ºç°çš„åŸå› ã€‚</p>
<p>å…¶å®ï¼Œæ¥å£çš„æ–¹æ³•é›†çš„æ¦‚å¿µè¿˜åœ¨ ä¸€ä¸ªæ¥å£çš„æ–¹æ³•é›†æ˜¯è¿™ä¸ªæ¥å£çš„ç±»å‹é›†åˆä¸­æ‰€æœ‰å…ƒç´ çš„æ–¹æ³•é›†çš„<strong>äº¤é›†</strong>ã€‚</p>
<p>ræœ¬æ–‡å‡å®šä½ å¯¹Goæ³›å‹æœ‰äº†ä¸€å®šçš„äº†è§£ã€‚å‡å®šä½ è¿˜ä¸äº†è§£ï¼Œé‚£ä¹ˆä½ å¿…é¡»çŸ¥é“ï¼ŒGo 1.18ä¸­æ¥å£é™¤äº†åŸå…ˆçš„æ–¹æ³•å…ƒç´ è¿˜ï¼Œè¿˜æ”¯æŒåŒ…å«ç±»å‹å…ƒç´ ï¼Œç±»å‹å…ƒç´ å¯ä»¥æ˜¯æŸä¸ªç±»å‹<code>T</code>ã€æˆ–è€…æ˜¯è¿‘ä¼¼ç±»å‹<code>~T</code>,æˆ–è€…æ˜¯å®ƒä»¬çš„è”åˆ<code>int|int8|int16|int32|int64|~string</code>ã€‚</p>
<p>å¦‚æœä¸€ä¸ªæ¥å£<code>I</code>åµŒå…¥äº†å¦å¤–ä¸€ä¸ªæ¥å£<code>E</code>,é‚£ä¹ˆ<code>I</code>çš„ç±»å‹é›†æ˜¯å®ƒæ˜¾ç¤ºå®šä¹‰çš„ç±»å‹é›†åˆå’ŒåµŒå…¥çš„æ¥å£<code>E</code>çš„ç±»å‹é›†åˆçš„äº¤é›†ã€‚ç›¸å½“äº<code>E</code>æŠŠæ¥å£<code>I</code>çš„ç±»å‹é›†æ”¶çª„äº†ã€‚</p>
<p>å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªæ¥å£çš„ç±»å‹é›†å‘¢ï¼Ÿè¯·éµå¾ªä¸‹é¢çš„åŸåˆ™:</p>
<ul>
<li><p>ç©ºæ¥å£<code>any</code>ã€<code>interface{}</code>çš„ç±»å‹é›†æ˜¯æ‰€æœ‰ç±»å‹çš„é›†åˆ<br>æ‰€ä»¥åƒ<code>int</code>ã€<code>string</code>ã€<code>strcut{}</code>ã€<code>MyStruct</code>ã€<code>func foobar()</code>ã€<code>chan int</code>ã€<code>map[int]string</code>ã€<code>[]int</code>ç­‰ç­‰éƒ½åœ¨ç©ºæ¥å£çš„ç±»å‹é›†åˆä¸­</p>
</li>
<li><p>éç©ºæ¥å£çš„ç±»å‹é›†åˆæ˜¯æ¥å£å…ƒç´ çš„ç±»å‹é›†åˆçš„äº¤é›†<br>é‚£ä¹ˆä»€ä¹ˆæ˜¯æ¥å£å…ƒç´ çš„ç±»å‹é›†åˆå‘¢ï¼Ÿå‚ç…§ä¸‹é¢çš„å››æ¡ã€‚<br>å‰é¢æˆ‘ä»¬å·²ç»æåˆ°ï¼Œæ¥å£å…ƒç´ åŒ…å«ç±»å‹å…ƒç´ å’Œæ–¹æ³•å…ƒç´ ã€‚</p>
<ul>
<li><p>ä¸€ä¸ªæ–¹æ³•çš„ç±»å‹é›†åˆæ˜¯å®šä¹‰è¿™ä¸ªæ–¹æ³•çš„æ‰€æœ‰ç±»å‹ï¼Œä¹Ÿå°±æ˜¯åªè¦æŸä¸ªç±»å‹çš„æ–¹æ³•é›†åŒ…å«è¿™ä¸ªæ–¹æ³•ï¼Œé‚£ä¹ˆå®ƒå°±å±äºè¿™ä¸ªæ–¹æ³•çš„ç±»å‹é›†åˆ<br>æ¯”å¦‚æ¥å£ä¸­æœ‰<code>String() string</code>è¿™æ ·ä¸€ä¸ªæ–¹æ³•ï¼Œé‚£ä¹ˆæ‰€æœ‰å®ç°è¿™ä¸ªæ–¹æ³•çš„ç±»å‹éƒ½å±äº<code>String() string</code>å®šä¹‰çš„ç±»å‹é›†åˆï¼Œæ¯”å¦‚<code>net.IP</code>ã€‚</p>
</li>
<li><p>ä¸€ä¸ªéæ¥å£ç±»å‹çš„ç±»å‹é›†åˆå°±æ˜¯åªåŒ…å«è¿™ä¸ªç±»å‹çš„ç±»å‹é›†åˆ<br>æ¯”å¦‚<code>int</code>çš„ç±»å‹é›†åˆåªåŒ…å«<code>int</code>è¿™æ ·ä¸€ä¸ªå…ƒç´ ã€‚</p>
</li>
<li><p>è¿‘ä¼¼å…ƒç´ <code>~T</code>çš„ç±»å‹é›†åˆæ˜¯æ‰€æœ‰åº•å±‚ç±»å‹ä¸º<code>T</code>çš„æ‰€æœ‰ç±»å‹çš„é›†åˆ</p>
</li>
</ul>
<p>æ¯”å¦‚<code>type MyInt int</code>ä¸­çš„<code>MyInt</code>å°±å±äº<code>~int</code>çš„ç±»å‹é›†åˆ</p>
<ul>
<li>è”åˆå…ƒç´ <code>t1|t2|â€¦|tn</code>çš„ç±»å‹é›†åˆæ˜¯è¿™äº›è”åˆå…ƒç´ ç±»å‹é›†åˆçš„<strong>å¹¶é›†</strong></li>
</ul>
</li>
</ul>
<p>ä¸‹é¢çš„ä¾‹å­åˆ—ä¸¾äº†ä¸€äº›ç±»å‹çš„é›†åˆï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// è¿™ä¸ªé›†åˆçš„ç±»å‹é›†åˆåªæœ‰intè¿™ä¸€ç§ç±»å‹</span></div><div class="line"><span class="keyword">interface</span> {</div><div class="line">	<span class="typename">int</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// è¿™ä¸ªæ¥å£ä»£è¡¨æ‰€æœ‰åº•å±‚ä¸ºintç±»å‹çš„æ‰€æœ‰ç±»å‹</span></div><div class="line"><span class="keyword">interface</span> {</div><div class="line">	~<span class="typename">int</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// è¿™ä¸ªæ¥å£ä»£è¡¨åº•å±‚ä¸ºintï¼Œå¹¶ä¸”å®ç°äº†Stringæ–¹æ³•çš„æ‰€æœ‰ç±»å‹</span></div><div class="line"><span class="keyword">interface</span> {</div><div class="line">	~<span class="typename">int</span></div><div class="line">	String() <span class="typename">string</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// è¿™ä¸ªæ¥å£çš„ç±»å‹é›†åˆæ˜¯ç©ºé›†ï¼Œå› ä¸ºä¸å¯èƒ½ä¸€ä¸ªå…ƒç´ æ—¢æ˜¯intåˆæ˜¯stringç±»å‹</span></div><div class="line"><span class="keyword">interface</span> {</div><div class="line">	<span class="typename">int</span></div><div class="line">	<span class="typename">string</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// Floatsä»£è¡¨æ‰€æœ‰åº•å±‚æ˜¯æµ®ç‚¹æ•°çš„ç±»å‹ (åº•å±‚ä¸ºfloat32æˆ–è€…float64)</span></div><div class="line"><span class="keyword">type</span> Floats <span class="keyword">interface</span> {</div><div class="line">	~<span class="typename">float32</span> | ~<span class="typename">float64</span></div><div class="line">}</div></pre></td></tr></table></figure>

<h2 id="specific_type_(ç‰¹å®šç±»å‹)_å’Œ_specific_type_set">specific type (ç‰¹å®šç±»å‹) å’Œ specific type set</h2>
<p>æ¥å£å¦å¤–ä¸€ä¸ªå¾ˆé‡è¦çš„æ¦‚å¿µå°±æ˜¯<code>specific type</code> (ç‰¹å®šç±»å‹)ã€‚</p>
<p>åªæœ‰åŒ…å«ç±»å‹å…ƒç´ çš„æ¥å£æ‰å®šä¹‰äº†ç‰¹å®šç±»å‹(å¯èƒ½æ˜¯ç©ºçš„ç±»å‹)ã€‚</p>
<p>å¦‚æœä¸ä¸¥æ ¼çš„è®²ï¼Œç‰¹å®šç±»å‹æ˜¯å‡ºç°åœ¨ç±»å‹å…ƒç´ ä¸­å®šä¹‰çš„é‚£äº›ç±»å‹<code>T</code>ã€<code>~T</code>ã€<code>t1|t2|...|tn</code>ä¸­çš„<code>t1</code>ã€<code>t2</code>ã€<code>...</code>ã€<code>tn</code>ã€‚</p>
<p>æ›´å‡†ç¡®åœ°è¯´ï¼Œå¯¹äºç»™å®šçš„æ¥å£<code>I</code>ï¼Œç‰¹å®šç±»å‹çš„é›†åˆå¯¹åº”äºè¯¥æ¥å£ä»£è¡¨çš„ç±»å‹é›†åˆ<strong>ğ‘…</strong>ï¼Œè¿™é‡Œè¦æ±‚<strong>ğ‘…</strong>æ˜¯éç©ºä¸”æœ‰é™çš„ã€‚å¦åˆ™ï¼Œå¦‚æœ<strong>ğ‘…</strong>ä¸ºç©ºæˆ–æ— é™ï¼Œåˆ™æ¥å£æ²¡æœ‰ç‰¹å®šç±»å‹ã€‚</p>
<p>å¯¹äºä¸€ä¸ªç»™å®šçš„æ¥å£ã€ç±»å‹å…ƒç´ æˆ–è€…ç±»å‹ï¼Œå®ƒä»£è¡¨çš„ç±»å‹é›†åˆ<strong>ğ‘…</strong>å®šä¹‰å¦‚ä¸‹ï¼š</p>
<ul>
<li><p>å¯¹äºä¸€ä¸ªæ²¡æœ‰ä»»ä½•ç±»å‹å…ƒç´ çš„æ¥å£ï¼Œå®ƒçš„<strong>ğ‘…</strong>æ˜¯æ‰€æœ‰çš„å…ƒç´ (æ— é™)ã€‚<br>æ‰€ä»¥å®ƒæ²¡æœ‰ç‰¹å®šç±»å‹ã€‚</p>
</li>
<li><p>å¦‚æœä¸€ä¸ªæ¥å£æœ‰ç±»å‹å…ƒç´ ï¼Œå®ƒçš„<strong>ğ‘…</strong>æ˜¯å®ƒçš„å…ƒç´ ä»£è¡¨çš„ç±»å‹çš„äº¤é›†<br>è‡³äºæœ‰æ²¡æœ‰ç‰¹å®šç±»å‹è¦çœ‹<strong>ğ‘…</strong>æ˜¯å¦æ˜¯éç©ºä¸”æœ‰é™ã€‚</p>
</li>
<li><p>å¯¹äºä¸€ä¸ªéæ¥å£ç±»å‹<code>T</code>,æˆ–è€…<code>~T</code>, å®ƒçš„<strong>ğ‘…</strong>æ˜¯åŒ…å«ç±»å‹<code>T</code>çš„é›†åˆ</p>
</li>
<li><p>å¯¹äºè”åˆå…ƒç´ <code>t1|t2|â€¦|tn</code>, å®ƒçš„<strong>ğ‘…</strong>æ˜¯è¿™äº›é¡¹ä»£è¡¨ç±»å‹çš„<strong>å¹¶é›†</strong></p>
</li>
</ul>
<p>ä¸‹é¢æ˜¯ç‰¹å®šç±»å‹çš„ä¾‹å­:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Celsius <span class="typename">float32</span></div><div class="line"><span class="keyword">type</span> Kelvin  <span class="typename">float32</span></div><div class="line"></div><div class="line"><span class="keyword">interface</span>{}                    <span class="comment">// æ— é™ï¼Œæ‰€ä»¥æ²¡æœ‰ç‰¹å®šç±»å‹</span></div><div class="line"><span class="keyword">interface</span>{ <span class="typename">int</span> }               <span class="comment">// ç‰¹å®šç±»å‹æ˜¯int</span></div><div class="line"><span class="keyword">interface</span>{ ~<span class="typename">string</span> }           <span class="comment">// ç‰¹å®šç±»å‹æ˜¯string</span></div><div class="line"><span class="keyword">interface</span>{ <span class="typename">int</span>|~<span class="typename">string</span> }       <span class="comment">// ç‰¹å®šç±»å‹æ˜¯int, string</span></div><div class="line"><span class="keyword">interface</span>{ Celsius|Kelvin }    <span class="comment">// ç‰¹å®šç±»å‹æ˜¯Celsius, Kelvin</span></div><div class="line"><span class="keyword">interface</span>{ <span class="typename">float64</span>|any }       <span class="comment">// æ²¡æœ‰ç‰¹å®šç±»å‹ï¼Œå› ä¸ºè”åˆç±»å‹çš„ä»£è¡¨ç±»å‹æ˜¯æ— é™çš„</span></div><div class="line"><span class="keyword">interface</span>{ <span class="typename">int</span>; m() }          <span class="comment">// ç‰¹å®šç±»å‹æ˜¯int</span></div><div class="line"><span class="keyword">interface</span>{ ~<span class="typename">int</span>; m() }         <span class="comment">// ç‰¹å®šç±»å‹æ˜¯int</span></div><div class="line"><span class="keyword">interface</span>{ <span class="typename">int</span>; any }          <span class="comment">// ç‰¹å®šç±»å‹æ˜¯intï¼Œintå’Œanyçš„äº¤é›†</span></div><div class="line"><span class="keyword">interface</span>{ <span class="typename">int</span>; <span class="typename">string</span> }       <span class="comment">// æ²¡æœ‰ç‰¹å®šç±»å‹</span></div></pre></td></tr></table></figure>

<h2 id="type_set_vs_specific_type_set">type set vs specific type set</h2>
<p>ç±»å‹é›†åˆå’Œç‰¹å®šç±»å‹é›†åˆè¿˜æ˜¯æœ‰åŒºåˆ«çš„ï¼Œä»ä¸Šé¢å®ƒä»¬çš„å®šä¹‰å¯ä»¥çœ‹å‡ºæ¥ã€‚</p>
<p><strong>ä¸€ä¸ªæ¥å£å³ä½¿ç±»å‹ä¸ºç©ºï¼Œå®ƒçš„ç‰¹å®šç±»å‹é›†åˆå¯èƒ½ä¸ä¸ºç©ºã€‚</strong><br>æ¯”å¦‚<code>interface{ int; m() }</code>,å®ƒçš„ç±»å‹é›†åˆæ˜¯ç©ºçš„(intæ²¡æœ‰å®ç°mæ–¹æ³•)ï¼Œä½†æ˜¯å®ƒçš„ç‰¹å®šç±»å‹æ˜¯<code>int</code>ã€‚</p>
<p><strong>ä¸€ä¸ªæ¥å£å³ä½¿æœ‰æœ‰é™çš„ç‰¹å®šç±»å‹ï¼Œå®ƒçš„ç±»å‹é›†åˆä¹Ÿå¯èƒ½æ˜¯æ— é™çš„</strong><br>æ¯”å¦‚<code>interface{ ~int; m() }</code>,å®ƒçš„ç‰¹å®šç±»å‹æ˜¯intï¼Œä½†æ˜¯å®ƒçš„ç±»å‹é›†åˆç¡®æ˜¯æ— é™çš„(ä»»ä½•åº•å±‚ä¸ºintå¹¶ä¸”å®ç°äº†æ–¹æ³•mçš„ç±»å‹éƒ½å±äºå®ƒçš„ç±»å‹é›†åˆ)</p>
<p>é‚£ä¹ˆå®šä¹‰ç‰¹å®šç±»å‹æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿ</p>
<h2 id="ç‰¹å®šç±»å‹çš„åº”ç”¨">ç‰¹å®šç±»å‹çš„åº”ç”¨</h2>
<p>ç‰¹å®šç±»å‹ä¸»è¦ç”¨äºåˆ¤æ–­ç±»å‹å‚æ•°æ˜¯å¦æ”¯æŒç´¢å¼•, åƒ<code>a[x]</code>è¿™æ ·çš„ç±»å‹ã€‚</p>
<p>æ¯”å¦‚ä¸€ä¸ªè¡¨è¾¾å¼<code>a[x]</code>, <code>a</code>è¿™ä¸ªå®ä¾‹çš„ç±»å‹å¯èƒ½æ˜¯æ•°ç»„ã€æŒ‡å‘æ•°ç»„çš„æŒ‡é’ˆã€sliceã€å­—ç¬¦ä¸²ã€mapã€‚</p>
<p>å¦‚æœ<code>a</code>çš„ç±»å‹æ˜¯ç±»å‹å‚æ•°<code>P</code>çš„è¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„ä»£ç <code>a[x]</code>åœ¨ä»€ä¹ˆæ¡ä»¶ä¸‹æ‰ä¸ä¼šç¼–è¯‘å‡ºé”™ï¼Ÿ</p>
<p>è¦æ±‚çš„æ¡ä»¶å°±å’Œç‰¹å®šç±»å‹æœ‰å…³äº†ï¼š</p>
<ul>
<li>På¿…é¡»æœ‰ç‰¹å®šç±»å‹</li>
<li>å¯¹äºPçš„ç‰¹å®šç±»å‹çš„å€¼aï¼Œæ”¯æŒ<code>a[x]</code>è¿™ç§ç´¢å¼•å†™æ³•</li>
<li>Pçš„æ‰€æœ‰ç‰¹å®šç±»å‹å¿…é¡»ç›¸åŒã€‚åœ¨è¿™é‡Œï¼Œstringç±»å‹çš„å…ƒç´ ç±»å‹æ˜¯byte (<a href="https://github.com/golang/go/issues/49551" target="_blank" rel="external">https://github.com/golang/go/issues/49551</a>)</li>
<li>å¦‚æœPçš„ç‰¹å®šç±»å‹åŒ…å«mapç±»å‹çš„è¯ï¼Œé‚£ä¹ˆå®ƒçš„æ‰€æœ‰ç‰¹å®šç±»å‹å¿…é¡»æ˜¯map,è€Œä¸”æ‰€æœ‰çš„keyçš„ç±»å‹æ˜¯ç›¸åŒçš„<br>æ‰€ä»¥æœ‰æ—¶å€™ä½ å®šä¹‰äº†ä¸€ä¸ªåŒ…å«mapã€sliceã€stringçš„è”åˆå…ƒç´ æ¥å£çš„è¯ï¼Œè¿™ä¸ªæ¥å£çš„å®ä¾‹ä½ ä¸èƒ½ä½¿ç”¨<code>a[x]</code>ç´¢å¼•ç±»å‹ï¼Œå…ƒç´ çš„ç±»å‹éƒ½æ˜¯int</li>
<li><code>a[x]</code>æ˜¯æ•°ç»„ã€sliceã€stringçš„ç´¢å¼•ä¸ºxçš„å…ƒç´ ï¼Œæˆ–è€…æ˜¯mapç±»å‹keyä¸ºxçš„å…ƒç´ ï¼Œa[x]çš„ç±»å‹å¿…é¡»ç›¸åŒ</li>
<li>å¦‚æœPçš„ç‰¹å®šç±»å‹åŒ…å«stringç±»å‹ï¼Œé‚£ä¹ˆä¸èƒ½ç»™<code>a[x]</code>èµ‹å€¼(å­—ç¬¦ä¸²æ˜¯ä¸å¯å˜çš„)</li>
</ul>
<p>ç‰¹å®šç±»å‹è¿˜ç”¨ä½œç±»å‹è½¬åŒ–å®šä¹‰ä¸Šã€‚<br>å¯¹äºä¸€ä¸ªå˜é‡<code>x</code>,å¦‚æœå®ƒçš„ç±»å‹æ˜¯<code>V</code>, è¦è½¬æ¢æˆçš„ç±»å‹æ˜¯<code>T</code>, åªè¦æ»¡è¶³ä¸‹é¢ä¸€æ¡ï¼Œxå°±å¯ä»¥è½¬æ¢æˆ<code>T</code>ç±»å‹:</p>
<ul>
<li><code>V</code>çš„æ¯ä¸€ä¸ªç‰¹å®šç±»å‹çš„å€¼éƒ½å¯ä»¥è½¬æ¢æˆ<code>T</code>çš„æ¯ä¸€ä¸ªç‰¹å®šç±»å‹</li>
<li>åªæœ‰<code>V</code>æ˜¯ç±»å‹å‚æ•°ï¼Œ<code>T</code>ä¸æ˜¯ï¼Œé‚£ä¹ˆ<code>V</code>çš„æ¯ä¸€ä¸ªç‰¹å®šç±»å‹çš„å€¼éƒ½å¯ä»¥è½¬æ¢æˆ<code>T</code></li>
<li>åªæœ‰<code>T</code>æ˜¯ç±»å‹å‚æ•°ï¼Œ<code>x</code>å¯ä»¥è½¬æ¢æˆTçš„æ¯ä¸€ä¸ªç‰¹å®šç±»å‹</li>
</ul>
<p>ä¸€å¥è¯ï¼Œæ˜¯ç±»å‹å‚æ•°å°±æ»¡è¶³æ¯ä¸€ä¸ªç‰¹å®šç±»å‹ï¼Œä¸æ˜¯ç±»å‹å‚æ•°å°±æ»¡è¶³è¿™ä¸ªç±»å‹ã€‚</p>
<p>å¦å¤–ï¼Œå¯¹äºç±»å‹å‚æ•°ï¼Œè¦è°ƒç”¨å†…å»ºçš„å‡½æ•°<code>len</code>ã€<code>cap</code>ï¼Œå¿…é¡»è¦æ±‚å®ƒä»¬çš„ç‰¹å®šç±»å‹å…è®¸ä½¿ç”¨è¿™äº›å†…å»ºå‡½æ•°ã€‚</p>
<h2 id="structural_type_(ç»“æ„ç±»å‹)">structural type (ç»“æ„ç±»å‹)</h2>
<p>ä¸€ä¸ªæ¥å£<code>T</code>è¦è¢«æˆä¸ºç»“æ„åŒ–çš„(<code>structural</code>),éœ€è¦æ»¡è¶³ä¸‹é¢çš„æ¡ä»¶ä¹‹ä¸€:</p>
<ol>
<li>å­˜åœ¨ä¸€ä¸ªå•ä¸€çš„ç±»å‹<code>U</code>,å®ƒæ˜¯<code>T</code>çš„ç±»å‹é›†åˆä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ ç›¸åŒçš„åº•å±‚ç±»å‹</li>
<li><code>T</code>çš„ç±»å‹é›†åˆåªåŒ…å«chanç±»å‹ï¼Œå¹¶ä¸”å®ƒä»¬çš„å…ƒç´ ç±»å‹éƒ½æ˜¯<code>E</code>, æ‰€æœ‰çš„chançš„æ–¹å‘åŒ…å«ç›¸åŒçš„æ–¹å‘(ä¸ä¸€å®šè¦æ±‚å®Œå…¨ç›¸åŒ)</li>
</ol>
<p>ç»“æ„åŒ–ç±»å‹åŒ…å«ä¸€ä¸ªç»“æ„ç±»å‹ï¼Œæ ¹æ®ä¸Šé¢çš„æ¡ä»¶ä¸åŒï¼Œç»“æ„ç±»å‹å¯èƒ½æ˜¯:</p>
<ol>
<li>ç±»å‹<code>U</code>, æˆ–è€…</li>
<li>å¦‚æœ<code>T</code>åªåŒ…å«åŒå‘chançš„è¯ï¼Œç»“æ„ç±»å‹ä¸º<code>chan E</code>,å¦åˆ™å¯èƒ½æ˜¯<code>chan&lt;- E</code>æˆ–è€…<code>&lt;-chan E</code></li>
</ol>
<p>ä¸‹é¢æ˜¯åŒ…å«ç»“æ„ç±»å‹çš„ç»“æ„åŒ–æ¥å£:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">interface</span>{ <span class="typename">int</span> }                          <span class="comment">// ç»“æ„ç±»å‹ä¸º int</span></div><div class="line"><span class="keyword">interface</span>{ Celsius|Kelvin }               <span class="comment">// ç»“æ„ç±»å‹ä¸º float32</span></div><div class="line"><span class="keyword">interface</span>{ ~<span class="keyword">chan</span> <span class="typename">int</span> }                    <span class="comment">// ç»“æ„ç±»å‹ä¸º chan int</span></div><div class="line"><span class="keyword">interface</span>{ ~<span class="keyword">chan</span> <span class="typename">int</span>|~<span class="keyword">chan</span>&lt;- <span class="typename">int</span> }        <span class="comment">// ç»“æ„ç±»å‹ä¸º chan&lt;- int</span></div><div class="line"><span class="keyword">interface</span>{ ~[]*data; String() <span class="typename">string</span> }    <span class="comment">// ç»“æ„ç±»å‹ä¸º *data</span></div><div class="line"></div><div class="line"><span class="comment">// ä¸‹é¢çš„ä¾‹å­ä¸åŒ…å«ç»“æ„ç±»å‹ï¼Œæ‰€ä»¥æ˜¯éç»“æ„åŒ–æ¥å£</span></div><div class="line"><span class="keyword">interface</span>{}                               <span class="comment">// æ²¡æœ‰å›ºå®šå•ä¸€çš„åº•å±‚ç±»å‹</span></div><div class="line"><span class="keyword">interface</span>{ Celsius|<span class="typename">float64</span> }              <span class="comment">// åº•å±‚ç±»å‹ä¸ç›¸åŒ</span></div><div class="line"><span class="keyword">interface</span>{ <span class="keyword">chan</span> <span class="typename">int</span> | <span class="keyword">chan</span>&lt;- <span class="typename">string</span> }     <span class="comment">// channelçš„å…ƒç´ ç±»å‹ä¸ç›¸åŒ</span></div><div class="line"><span class="keyword">interface</span>{ &lt;-<span class="keyword">chan</span> <span class="typename">int</span> | <span class="keyword">chan</span>&lt;- <span class="typename">int</span> }      <span class="comment">// channelæ²¡æœ‰ç›¸åŒçš„æ–¹å‘</span></div></pre></td></tr></table></figure>

<p>åœ¨Goè¯­è¨€è§„èŒƒä¸­ï¼Œå¹¶æ²¡æœ‰å¯¹ç»“æ„åŒ–æ¥å£æœ‰æ›´å¤šçš„ä»‹ç»ï¼Œå¦‚ä½•ä½¿ç”¨ï¼Œæ›´å¤šæ˜¯æ˜¯å®ƒå†…éƒ¨è·å–åº•å±‚çš„ç»“æ„ç±»å‹ï¼Œä»¥åŠåšç±»å‹æ£€æŸ¥ï¼Œæ¯”å¦‚ä¸‹é¢çš„ä¾‹å­å°±ä¼šæŠ¥<code>no structural type</code>ç¼–è¯‘é”™è¯¯:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> myByte1 []<span class="typename">byte</span></div><div class="line"><span class="keyword">func</span> _[T <span class="keyword">interface</span>{ []<span class="typename">byte</span> | myByte1 | []<span class="typename">int</span> }] (x T, i, j, k <span class="typename">int</span>) { </div><div class="line">    <span class="keyword">var</span> _ T = x[i:j:k] <span class="comment">// åº•å±‚ç±»å‹ä¸ä¸€è‡´</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">func</span> _[T <span class="keyword">interface</span>{ []<span class="typename">byte</span> | myByte1 | []<span class="typename">int</span> | <span class="typename">string</span> }] (x T, i, j, k <span class="typename">int</span>) { </div><div class="line">    <span class="keyword">var</span> _ T = x[i:j] </div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// ä¸‹é¢è¿™ä¸ªå‡½æ•°æ²¡é—®é¢˜ï¼Œå› ä¸ºstringçš„åº•å±‚é¡µè¢«çœ‹åš[]byte</span></div><div class="line"><span class="keyword">func</span> _[T <span class="keyword">interface</span>{ []<span class="typename">byte</span> | myByte1 | myByte2 | <span class="typename">string</span> }] (x T, i, j, k <span class="typename">int</span>) { </div><div class="line">    <span class="keyword">var</span> _ T = x[i:j] </div><div class="line">}</div></pre></td></tr></table></figure>

<p>ä¸‹é¢çš„ä»£ç ä¹Ÿä¼šæŠ¥<code>M has no structural type</code>ç¼–è¯‘é”™è¯¯</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> multiMapOfInt <span class="keyword">interface</span> {</div><div class="line">	<span class="keyword">map</span>[<span class="typename">int</span>]<span class="typename">int</span> | <span class="keyword">map</span>[<span class="typename">float64</span>]<span class="typename">int</span> | <span class="keyword">map</span>[<span class="typename">string</span>]<span class="typename">int</span> | <span class="keyword">map</span>[<span class="typename">complex64</span>]<span class="typename">int</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">func</span> arraySummer[M multiMapOfInt](mp M) (sum <span class="typename">int</span>) {</div><div class="line">	<span class="keyword">for</span> _, v := <span class="keyword">range</span> mp {</div><div class="line">		sum += v</div><div class="line">	}</div><div class="line">	<span class="keyword">return</span></div><div class="line">}</div></pre></td></tr></table></figure>

<p>æ¯”å¦‚ä¸‹é¢å¤§å®¶ä½¿ç”¨Goæ³›å‹çš„æ—¶å€™å¸¸ä¼šçŠ¯çš„é”™è¯¯,è™½ç„¶<code>[]byte</code>ã€<code>map[int]byte</code>ã€<code>string</code>éƒ½èƒ½range,è€Œä¸”key(index)ã€valueç±»å‹éƒ½ä¸€æ ·ï¼Œä½†æ˜¯ä¹Ÿä¼šæŠ¥<code>R has no structural type</code>é”™è¯¯:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="keyword">type</span> rangeType <span class="keyword">interface</span> {</div><div class="line">	[]<span class="typename">byte</span> | <span class="keyword">map</span>[<span class="typename">int</span>]<span class="typename">byte</span> | <span class="typename">string</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">func</span> rangeIt[R rangeType](r R) {</div><div class="line">	<span class="keyword">for</span> i, v := <span class="keyword">range</span> r {</div><div class="line">		fmt.Println(i, v)</div><div class="line">	}</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">func</span> main() {</div><div class="line">	rangeIt(<span class="keyword">map</span>[<span class="typename">int</span>]<span class="typename">byte</span><span class="number">{1</span>:<span class="number"> 1</span>,<span class="number"> 2</span>:<span class="number"> 2</span>,<span class="number"> 3</span>:<span class="number"> 3</span>})</div><div class="line">}</div></pre></td></tr></table></figure>

]]></content>
    <summary type="html">
    <![CDATA[<p>è‡ª Go 1.18åï¼Œ Goçš„interfaceçš„å«ä¹‰æœ‰æ‰€<a href="https://colobu.com/2022/01/08/the-interface-is-not-that-interface-in-go-1-18/" target="_blank" rel="external">å˜åŒ–</a>, ä¸‰ä¸ªæ–°çš„å’ŒGoæ¥å£æœ‰å…³çš„æ¦‚å¿µå¾ˆå¤šäººè¿˜ä¸çŸ¥é“: <code>type set</code>(ç±»å‹é›†åˆ)ã€<code>specific type</code>(ç‰¹å®šç±»å‹)å’Œ<code>structural type</code>(ç»“æ„ç±»å‹)ã€‚</p>
]]>
    
    </summary>
    
      <category term="Go" scheme="https://colobu.com/categories/Go/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[ç¼–å†™å¯ç»´æŠ¤çš„Goä»£ç ]]></title>
    <link href="https://colobu.com/2022/01/15/Writing-maintainable-Go-code/"/>
    <id>https://colobu.com/2022/01/15/Writing-maintainable-Go-code/</id>
    <published>2022-01-15T04:54:58.000Z</published>
    <updated>2022-02-24T09:36:34.503Z</updated>
    <content type="html"><![CDATA[<p>ç¼–å†™å¯ç»´æŠ¤çš„ä»£ç æ˜¯æœ€åŸºæœ¬çš„è¦æ±‚ã€‚æ¸…æ™°åº¦ã€å¯è¯»æ€§å’Œç®€å•æ€§éƒ½æ˜¯ä¿æŒä»£ç å¯ç»´æŠ¤æ€§çš„å„ä¸ªæ–¹é¢ã€‚å®ƒåº”è¯¥ä½¿æŸäººåŠ å…¥æ‚¨çš„é¡¹ç›®æˆ–åœ¨æœ‰äººç¦»å¼€åç»´æŠ¤ä»£ç çš„è¿‡ç¨‹å˜å¾—å®¹æ˜“ã€‚å¯ç»´æŠ¤æ€§çš„è¡¡é‡æŒ‡æ ‡æ˜¯ä»£ç æ›´æ”¹çš„å®¹æ˜“ç¨‹åº¦ä»¥åŠä¸è¿™äº›æ›´æ”¹å¼•èµ·çš„é£é™©æ€§ã€‚ä¸ºäº†æœ‰æ•ˆåœ°ç¼–å†™Goç¨‹åºï¼Œäº†è§£Goè¯­è¨€çš„å±æ€§å’Œåœ°é“å†™æ³•ï¼Œå¹¶ä½¿ç”¨ä¸å‘½åã€ç¨‹åºæ„å»ºã€æ ¼å¼ç­‰ç›¸å…³æ—¢å®šçº¦å®šæ˜¯è‡³å…³é‡è¦ã€‚</p>
<p>ä»¥ä¸‹æ˜¯ä¸€äº›æœ‰åŠ©äºç¼–å†™å¯ç»´æŠ¤çš„Goä»£ç çš„è‰¯å¥½å®è·µã€‚</p>
<p>åŸæ–‡: <a href="https://jogendra.dev/writing-maintainable-go-code" target="_blank" rel="external">Writing maintainable Go code</a> by Jogendra.</p>
<a id="more"></a>
<p>ä¿æŒå°å·§çš„<code>main</code>å‡½æ•°</p>
<p>&quot;<a href="https://go.dev/tour/basics/1" target="_blank" rel="external">Goä¹‹æ—…</a>&quot;ä¸­è®²åˆ°ï¼š</p>
<blockquote>
<p>æ¯ä¸ª Go ç¨‹åºéƒ½ç”±åŒ…ç»„æˆã€‚ç¨‹åºåœ¨åŒ… <code>main</code> ä¸­å¼€ä¼šè¿è¡Œã€‚</p>
</blockquote>
<p>åŒ…<strong>main</strong>æ˜¯å”¯ä¸€çš„ï¼Œé‚£äº›å¯¼å‡ºåç§°(<code>exported name</code>)æ—¢ä¸ä¼šå¯¼å‡ºï¼Œç¼–è¯‘å™¨ä¹Ÿä¸ä¼šå°†å…¶è§†ä¸ºå¸¸è§„åŒ…; ç›¸åï¼Œå®ƒå°†å…¶ç¼–è¯‘ä¸ºå¯æ‰§è¡Œç¨‹åºã€‚åœ¨åŒ…<strong>main</strong>ä¸­ï¼Œ<strong>main</strong>å‡½æ•°å¿…é¡»å­˜åœ¨ï¼Œå®ƒæ˜¯ Go ç¨‹åºçš„å…¥å£ç‚¹ã€‚å¯¹è½¯ä»¶åŒ…<code>main</code>å’Œå‡½æ•°<code>main</code>çš„æœŸæœ›æ˜¯å®ƒä»¬å°½å¯èƒ½å°‘ã€‚</p>
<p><strong>main.main</strong>æ˜¯å•ä¾‹çš„ï¼Œä»…è¢«è°ƒç”¨ä¸€æ¬¡ã€‚ä½ ä¸ºå®ƒå†…éƒ¨çš„ä»£ç ç¼–å†™æµ‹è¯•ä¹Ÿå¾ˆå›°éš¾ï¼Œå› æ­¤ï¼Œå¼ºçƒˆå»ºè®®ä½¿ç”¨<em>main.main</em>ä»…ä»…å¯åŠ¨ç¨‹åºï¼Œä½†ä¸è¦åœ¨æ­¤åŒ…ä¸­ç¼–å†™ä¸šåŠ¡é€»è¾‘ã€‚å°†å¯åŠ¨ç¨‹åºå’Œä¸šåŠ¡é€»è¾‘åˆ†åˆ«å†™åœ¨å•ç‹¬çš„åŒ…ä¸­å¯æ”¹è¿›ç¨‹åºçš„ç»“æ„å’Œå¯ç»´æŠ¤æ€§ã€‚</p>
<h2 id="ä½¿ç”¨æœ‰æ„ä¹‰çš„åç§°">ä½¿ç”¨æœ‰æ„ä¹‰çš„åç§°</h2>
<p>åœ¨ Go ä¸­å‘½åä¸»è¦å¼ºè°ƒä¸€è‡´ã€ç®€çŸ­å’Œå‡†ç¡®çš„åç§°ï¼Œå› ä¸ºå®ƒä»¬å¾€å¾€ä¼šæé«˜ä»£ç çš„å¯è¯»æ€§ã€‚</p>
<p>Russ Coxçš„å‘½å<a href="https://research.swtch.com/names" target="_blank" rel="external">ç†å¿µ</a>ï¼š</p>
<blockquote>
<p>ä¸€ä¸ªåç§°çš„é•¿åº¦ä¸åº”è¶…è¿‡å®ƒçš„ä¿¡æ¯å†…å®¹ã€‚å¯¹äºä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œåç§°<code>i</code>å’Œ<code>index</code>æˆ–è€…<code>idx</code>æºå¸¦åŒæ ·çš„ä¿¡æ¯ï¼Œè€Œä¸”æ›´æ–¹ä¾¿å¿«é€Ÿé˜…è¯»ã€‚ç±»ä¼¼åœ°ï¼Œ<code>i</code>å’Œ<code>j</code>è¿™ä¸€å¯¹å‘½åæ¯”ç´¢å¼•å˜é‡<code>i1</code>å’Œ<code>i2</code>æ›´å¥½(æ›´å·®çš„æ˜¯<code>index1</code>å’Œ<code>index2</code>),åœ¨é˜…è¯»ä»£ç çš„æ—¶å€™å®ƒä»¬æ›´å®¹æ˜“åŒºåˆ†ã€‚å…¨å±€åç§°å¿…é¡»ä¼ è¾¾ç›¸å¯¹æ›´å¤šçš„ä¿¡æ¯ï¼Œå› ä¸ºå®ƒä»¬å‡ºç°åœ¨æ›´å¹¿æ³›çš„ä¸Šä¸‹æ–‡ä¸­ã€‚å³ä¾¿å¦‚æ­¤ï¼Œä¸€ä¸ªç®€çŸ­ã€å‡†ç¡®çš„åå­—æ¯”å†—é•¿çš„åå­—æ›´èƒ½è¯´æ˜é—®é¢˜ï¼šæ¯”è¾ƒ<a href="http://www.google.com/codesearch?q=acquire" target="_blank" rel="external"><code>acquire</code></a>å’Œ<a href="http://www.google.com/codesearch?q=take_?ownership" target="_blank" rel="external"><code>take_ownership</code></a>ã€‚è®©æ¯ä¸ªå‘½åéƒ½èƒ½<a href="http://www.bartleby.com/141/strunk5.html#13" target="_blank" rel="external">åŒºåˆ†</a>ã€‚</p>
</blockquote>
<p>Ken Thompsonï¼ŒRob Pikeï¼ŒRobert Griesemerï¼ŒRuss Coxï¼ŒIan Lance Taylorç­‰äººå¤šå¹´çš„ç¼–ç¨‹ç»éªŒå’Œå‘½åç†å¿µå¾ˆå¯èƒ½æ¿€å‘äº†Goä¸­çš„å‘½åçº¦å®šã€‚<a href="https://talks.golang.org/2014/names.slide" target="_blank" rel="external">è¿™æ˜¯</a>å®‰å¾·é²Â·æ ¼å…°å¾·ï¼ˆAndrew Gerrandï¼‰çš„ä¸€å¼ å¹»ç¯ç‰‡ï¼Œå…¶æ›´æ·±å…¥åœ°è®¨è®ºäº†Goä¸­çš„å‘½åã€‚</p>
<h2 id="ä»£ç åˆ†ç»„">ä»£ç åˆ†ç»„</h2>
<p>åœ¨å‡½æ•°ï¼ˆæˆ–æ–¹æ³•ï¼‰ä¸­ï¼ŒæŸäº›è¯­å¥å¯èƒ½æœ‰å…³è”ã€‚å› æ­¤ï¼Œå»ºè®®å°†è¿™äº›è¯­å¥ä¿ç•™åœ¨å•ç‹¬çš„ä»£ç å—ä¸­ï¼Œç”¨æ¢è¡Œç¬¦åˆ†éš”ã€‚åˆ†ç»„ä½¿ç¨‹åºæ„é€ æ›´å¥½ï¼Œå¹¶é€šè¿‡åˆ†éš”ç›¸å…³éƒ¨åˆ†æ¥æé«˜å¯è¯»æ€§</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Creating new HTTP request with request body</span></div><div class="line">req, err := http.NewRequest(<span class="string">"POST"</span>, <span class="string">"https://api.example.com/endpoint"</span>, body)</div><div class="line"><span class="keyword">if</span> err != <span class="constant">nil</span> {</div><div class="line">    <span class="comment">// handle err</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// Setting headers to HTTP request</span></div><div class="line">req.Header.Set(<span class="string">"Content-Type"</span>, <span class="string">"application/json"</span>)</div><div class="line">req.Header.Set(<span class="string">"Authorization"</span>, <span class="string">"Bearer b7d03a6947b217efb6f3ec3bd3504582"</span>)</div><div class="line"></div><div class="line"><span class="comment">// Executing the request</span></div><div class="line">resp, err := http.DefaultClient.Do(req)</div><div class="line"><span class="keyword">if</span> err != <span class="constant">nil</span> {</div><div class="line">    <span class="comment">// handle err</span></div><div class="line">}</div><div class="line"><span class="keyword">defer</span> resp.Body.Close()</div></pre></td></tr></table></figure>

<h2 id="æ’°å†™æœ‰æ„ä¹‰çš„æ³¨é‡Š">æ’°å†™æœ‰æ„ä¹‰çš„æ³¨é‡Š</h2>
<p>æ³¨é‡Šæ˜¯ç†è§£ç°æœ‰ä»£ç çš„ç»ä½³æ–¹å¼ï¼Œå®ƒå¯ä»¥å›ç­”è¿™æ®µä»£ç çš„ä½œç”¨ï¼Œä¸ºä»€ä¹ˆä¼šå­˜åœ¨æŸäº›ä»£ç æ®µä»¥åŠä¸ºä»€ä¹ˆå®ƒæ˜¯è¿™æ ·ç¼–å†™çš„ã€‚æœ€å¥½åœ¨ç¼–å†™ä»£ç æ—¶å°±ç¼–å†™æ³¨é‡Šï¼Œä½†æ›´é‡è¦çš„æ˜¯åœ¨æ›´æ–°ä»£ç æ—¶æ›´æ–°æ³¨é‡Šã€‚ä»£ç æ›´æ–°å¯èƒ½ä¼šæ”¹å˜ç‰¹å®šä»£ç çš„å®ç°ç›®çš„ï¼Œå› æ­¤æ›´æ–°æ³¨é‡Šä¹Ÿè‡³å…³é‡è¦çš„; å¦åˆ™ï¼Œå®ƒå°†é€ æˆå›°æƒ‘è€Œä¸æ˜¯åœ¨ä»¥åæœ‰æ‰€å¸®åŠ©ã€‚ä¸å…¶ç¼–å†™ä¸ä»£ç ç›¸çŸ›ç›¾çš„æ³¨é‡Šè¿˜ä¸å¦‚ä¸å†™ä»£ç æ³¨é‡Šã€‚æ‚¨å¯ä»¥åœ¨ Go ä¸­ç¼–å†™å—æ³¨é‡Šæˆ–å†…è”æ³¨é‡Šï¼Œä½ å¯ä»¥é€‰æ‹©ä»»ä½•æ›´é€‚åˆæ‚¨çš„ä»£ç çš„å†…å®¹ã€‚</p>
<p>æ‚¨ä½¿ç”¨è¯¥å·¥å…·åšæ£€æŸ¥åœ¨ Go ä¸­ä½ æ˜¯å¦æ­£ç¡®ç¼–å†™æ³¨é‡Šä»£ç ã€‚<a href="https://blog.golang.org/godoc" target="_blank" rel="external">godoc</a>å°†ä»æ‚¨çš„ä»£ç ä¸­æå–æ³¨é‡Šï¼Œå¹¶ä¸ºæ‚¨çš„ Go ç¨‹åºç”Ÿæˆæ–‡æ¡£ã€‚Go ä¸­çš„æ³¨é‡Šæœ‰å‡ ä¸ªä¸é”™çš„åŠŸèƒ½ï¼Œè¯·å‚é˜…<a href="https://blog.jbowen.dev/2019/09/the-magic-of-go-comments/" target="_blank" rel="external">Goä»£ç æ³¨é‡Šçš„é­”æ³•</a>ä»¥è¯¦ç»†äº†è§£ã€‚<code></code></p>
<p>çŸ¥é“ä¸å¿…å†™æ³¨é‡Šä¸çŸ¥é“åº”è¯¥å†™æ³¨é‡Šä¸€æ ·é‡è¦ã€‚æœ€å¥½é¿å…è¿‡åº¦æ³¨é‡Šä»£ç ï¼Œå¹¶å°†å…¶ç•™ç»™å…¶ä»–ç¨‹åºå‘˜æ¥ç†è§£Goã€‚æ‚¨åº”è¯¥é¿æ˜¾è€Œæ˜“è§çš„æ³¨é‡Šï¼Œå¦‚æœä»£ç çš„å¯è¯»æ€§è¶³å¤Ÿé«˜ï¼Œåˆ™ä¸éœ€è¦æ³¨é‡Šã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Get country code from customer address.</span></div><div class="line">    countryCode := getCountryCode(address)</div><div class="line"></div><div class="line">    <span class="comment">// If country code is "IN", assign "India" as</span></div><div class="line">    <span class="comment">// country.</span></div><div class="line">    <span class="keyword">if</span> countryCode == <span class="string">"IN"</span> {</div><div class="line">        country = <span class="string">"India"</span></div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>è¿™é‡Œå†™çš„æ³¨é‡Šæ²¡å•¥æ„ä¹‰ï¼Œä¸ä¼šå¢åŠ ä»»ä½•ä»·å€¼ã€‚</p>
<h2 id="ä¸è¦é‡å¤">ä¸è¦é‡å¤</h2>
<p>DRYï¼ˆä¸è¦é‡å¤è‡ªå·±ï¼‰æ˜¯è½¯ä»¶å¼€å‘çš„ä¸€ä¸ªåŸåˆ™ï¼Œæ—¨åœ¨å‡å°‘è½¯ä»¶æ¨¡å¼çš„é‡å¤ï¼Œç”¨æŠ½è±¡ä»£æ›¿å®ƒä»¥é¿å…å†—ä½™ã€‚</p>
<p>é‚£ä¹ˆï¼Œä»£ç é‡å¤åˆæœ‰ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿåœ¨æœ‰å˜æ›´ä¹‹å‰ï¼Œæ²¡æœ‰å¤ªå¤šé—®é¢˜ã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œåœ¨10ä¸ªåœ°æ–¹é‡å¤ç›¸åŒçš„ä»£ç ï¼Œæ¯å½“æœ‰å°çš„å˜åŒ–æ—¶éƒ½è¦åœ¨æ‰€æœ‰10ä¸ªåœ°æ–¹åšæ”¹å˜ã€‚å¦‚æœä»£ç ä»…å­˜åœ¨äºä¸€ä¸ªä½ç½®ï¼Œåˆ™æ›´å®¹æ˜“ç»´æŠ¤ä»£ç ï¼Œä»è€Œç¡®ä¿ä¸€è‡´æ€§ã€‚å¦‚æœä»£ç é‡å¤ï¼Œæ‚¨å¾ˆæœ‰å¯èƒ½å¿˜è®°æ›´æ–°å…¶ä¸­ä¸€ä¸ªå‰¯æœ¬ï¼Œè¿™æ„å‘³ç€æ‚¨åœ¨ä¸€ä¸ªå‰¯æœ¬ä¸­ä¿®å¤çš„é”™è¯¯ä»å°†å­˜åœ¨äºå¦ä¸€ä¸ªå‰¯æœ¬ä¸­ã€‚</p>
<p>å¦‚æœå¿…é¡»å†æ¬¡ç¼–å†™ç›¸åŒçš„ä»£ç ï¼Œå¯ä»¥å…¶ç§»åŠ¨åˆ°å¤§å¤šæ•°<code>helper</code>å‡½æ•°æ‰€åœ¨çš„å…±äº«packageä¸­ã€‚é€šè¿‡åˆ é™¤é‡å¤çš„ä»£ç ï¼Œæ‚¨å°†æ‹¥æœ‰æ›´å°‘çš„ä»£ç ï¼Œè¿™äº›ä»£ç å°†æ›´æ¸…æ™°ï¼Œæ›´æ˜“äºç»´æŠ¤ã€‚</p>
<p>ç¼ºå°‘æ³›å‹ï¼ˆGo 1.17ä»¥åŠå…ˆå‰ç‰ˆæœ¬ï¼‰å¯èƒ½ä¼šä½¿ Go ä»£ç åœ¨æŸäº›åœ°æ–¹çœ‹èµ·æ¥é‡å¤ã€‚ä½†æ˜¯ï¼Œéšç€Go 1.18æ­£å¼æ”¯æŒæ³›å‹ï¼Œå°†ä½¿ç¼–å†™é€šç”¨ä»£ç å˜å¾—æ›´åŠ ç®€å•ï¼Œå†—ä½™æ›´å°‘ï¼Œå¹¶ä¸”æ›´æ˜“äºç»´æŠ¤ã€‚</p>
<p>ä½†æ˜¯ï¼Œæœ‰æ—¶é‡å¤ä»£ç æ¯”è¯•å›¾å¼ºåˆ¶æŠ½è±¡ä»¥å…å†—ä½™ä¼šæ›´ç®€å•ï¼Œæ›´å®¹æ˜“ç†è§£ã€‚å› æ­¤ï¼Œæ›´é‡è¦çš„æ˜¯è¦çŸ¥é“åœ¨å“ªé‡Œåº”ç”¨ DRYï¼Œåœ¨å“ªé‡Œä¸åº”ç”¨ DRYï¼Œå› ä¸ºä»£ç çš„å¯è¯»æ€§å’Œæ˜“æ‡‚æ€§èƒœè¿‡å…¶ä»–é—®é¢˜ã€‚</p>
<h2 id="Lintingå’Œæ ·å¼æŒ‡å—">Lintingå’Œæ ·å¼æŒ‡å—</h2>
<p>éµå®ˆç¼–ç æ ‡å‡†ä½¿ä»£ç åº“ä¿æŒä¸€è‡´ï¼Œæ˜“äºä»£ç å®¡æŸ¥å’Œç»´æŠ¤ã€‚å®ƒä½¿ç¼–ç é£æ ¼ä¸€è‡´ã€‚é€šå¸¸ï¼Œé£æ ¼æŒ‡å—æ˜¯æœ‰äº‰è®®çš„ï¼Œä¸ºäº†è®©äººä»¬éµå®ˆç›¸åŒæŒ‡å—çš„æœ€ä½³æ–¹æ³•æ˜¯ä¸ºGoä»£ç åˆ›å»ºä¸€ä¸ªæ ‡å‡†çš„é£æ ¼æŒ‡å—ã€‚æ‹¥æœ‰é£æ ¼æŒ‡å—ä¸æ˜¯æœ€é‡è¦çš„ï¼Œæœ€é‡è¦çš„æ˜¯è®©ä½ çš„å›¢é˜ŸçœŸæ­£åœ°ä½¿ç”¨å®ƒã€‚å¸‚é¢ä¸Šæœ‰è®¸å¤šå¼€æºçš„ linting å·¥å…·å’Œæ ·å¼æŒ‡å—ï¼Œä½ å¯ä»¥ä»ä»¥æ­¤ä¸ºåŸºç¡€å¹¶å¯¹å…¶è¿›è¡Œä¿®æ”¹ï¼Œä½¿å…¶é€‚åˆä½ ã€‚</p>
<p>Goæœ‰ä¸€ä¸ªåœ¨ç¤¾åŒºä¸­æ™®éä½¿ç”¨å’Œæ¥å—çš„ä»£ç æ ¼å¼æ ‡å‡†ï¼Œå°½ç®¡å®ƒä¸éœ€è¦ç‰¹æ®Šçš„è§„åˆ™ã€‚Go æä¾›äº†è¿™ä¸ª<code>fmt</code>å·¥å…·ï¼Œé¼“åŠ±å’Œä¿æŠ¤ Go ä»£ç ä½¿ç”¨æ—¢å®šçº¦å®šè¿›è¡Œæ ¼å¼åŒ–ã€‚</p>
<p>è®¸å¤šç¼–è¾‘å™¨æ”¯æŒåœ¨ä¿å­˜æ–‡ä»¶æ—¶è°ƒç”¨æ–‡ä»¶æ ¼å¼åŒ–å·¥å…·ã€‚æˆ–è€…ï¼Œåƒ <a href="https://github.com/mvdan/gofumpt" target="_blank" rel="external">gofumpt</a>å·¥å…·ï¼Œæä¾›æ›´ä¸¥æ ¼çš„æ ¼å¼åŒ–ç‰ˆæœ¬ã€‚è¯¥å·¥å…·æ˜¯ <code>gofmt</code>çš„ä¿®æ”¹åˆ†æ”¯ï¼Œå¯ç”¨ä½œ<code>gofmt</code>åŸåœ°æ›¿æ¢ã€‚æ­¤å¤–ï¼Œè¿™äº›å·¥å…·è¿˜æ”¯æŒè‡ªå®šä¹‰æºä»£ç è½¬æ¢å’Œæ·»åŠ è‡ªå®šä¹‰çš„è§„åˆ™ã€‚</p>
<p>å¦‚æœæ‚¨æƒ³éµå¾ªGoçš„ç¤¾åŒºé£æ ¼æŒ‡å—ï¼Œå¯ä»¥ä½¿ç”¨<a href="https://github.com/golang/lint" target="_blank" rel="external">golint</a>ã€‚è¯¥å·¥å…·æä¾›äº†æœ‰å…³ä»£ç æ ·å¼çš„æœ‰ç”¨æç¤ºï¼Œè¿˜å¯ä»¥å¸®åŠ©æŸ¥çœ‹Goçš„å…¬è®¤çº¦å®šã€‚è¿™å°†æå¤§åœ°å¸®åŠ©åŠ å…¥é¡¹ç›®çš„æ¯ä¸ªæ–°å¼€å‘äººå‘˜ã€‚</p>
<h2 id="é¿å…æ·±åº¦åµŒå¥—">é¿å…æ·±åº¦åµŒå¥—</h2>
<p>è¿‡åº¦çš„åµŒå¥—å›°æ‰°ç€æ¯ä¸ªäººã€‚æ·±åº¦åµŒå¥—ä½¿å¾—ä»£ç å¾ˆéš¾éµå¾ªè®¾è®¡é€»è¾‘ã€‚å¦‚æœæ‚¨æ­£åœ¨æ‰§è¡Œä»£ç å®¡æŸ¥æˆ–é‡æ–°è®¿é—®æ—§ä»£ç ï¼Œå…·æœ‰å¤§é‡åµŒå¥—çš„è¶…å¤§å‡½æ•°ï¼ˆæˆ–æ–¹æ³•ï¼‰ä¼šé€ æˆé€»è¾‘çš„æ··ä¹±ã€‚æ­¤å¤–ï¼ŒåµŒå¥—ä»£ç éš¾ä»¥é˜…è¯»; åµŒå¥—è¶Šå°ï¼Œè¯»è€…çš„è®¤çŸ¥è´Ÿè·å°±è¶Šå°ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> condition1 {</div><div class="line">    <span class="keyword">if</span> condition2 {</div><div class="line">        <span class="keyword">if</span> condition3 {</div><div class="line">            <span class="comment">// ...</span></div><div class="line">        } <span class="keyword">else</span> {</div><div class="line">            <span class="comment">// ...</span></div><div class="line">        }</div><div class="line">    } <span class="keyword">else</span> {</div><div class="line">        <span class="keyword">if</span> condition5 {</div><div class="line">            <span class="comment">// ...</span></div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>å¼€å‘äººå‘˜å¯ä»¥é€šè¿‡å¤šç§æ–¹å¼é¿å…è¿™ç§æƒ…å†µã€‚<a href="https://en.wikibooks.org/wiki/Computer_Programming/Coding_Style/Minimize_nesting" target="_blank" rel="external">è¿™é‡Œæ˜¯</a>ä¸€ä¸ªå¾ˆå¥½çš„é˜…è¯»ææ–™ã€‚</p>
<h2 id="ç¼–å†™æ›´å¥½çš„å‡½æ•°">ç¼–å†™æ›´å¥½çš„å‡½æ•°</h2>
<p>é¿å…ç¼–å†™è¾ƒé•¿çš„å‡½æ•°;å‡½æ•°è¶Šå°è¶Šå¥½ã€‚è¾ƒé•¿çš„å‡½æ•°å¯èƒ½éš¾ä»¥è¯»å–ã€æµ‹è¯•å’Œç»´æŠ¤ã€‚è¾ƒé•¿çš„å‡½æ•°é€šå¸¸å…·æœ‰è¾ƒå¤§çš„èŒè´£ï¼Œå› æ­¤å»ºè®®å°†å®ƒä»¬åˆ†è§£ä¸ºè¾ƒå°çš„å‡½æ•°ã€‚é€šè¿‡åˆ†è§£è¾ƒé•¿çš„å‡½æ•°åˆ›å»ºçš„è¾ƒçŸ­çš„å‡½æ•°ï¼Œå¯ä»¥æœåŠ¡æ›´å¤šçš„è°ƒç”¨æ–¹ã€‚å› ä¸ºå®ƒä»¬å¯ä»¥æä¾›å¯ç®¡ç†çš„ç‹¬ç«‹ä»»åŠ¡ã€‚</p>
<p>Unixç®¡é“çš„å‘æ˜è€…ã€Unixçš„åˆ›å§‹äººä¹‹ä¸€é“æ ¼Â·éº¦å…‹ç½—ä¼Šï¼ˆDoug McIlroyï¼‰è¯´ï¼ˆUnix Philosophyï¼‰ï¼š</p>
<blockquote>
<p>è®©æ¯ä¸ªç¨‹åºéƒ½åšå¥½ä¸€ä»¶äº‹ã€‚è¦å®Œæˆä¸€é¡¹æ–°å·¥ä½œï¼Œè¯·é‡æ–°æ„å»ºï¼Œè€Œä¸æ˜¯é€šè¿‡æ·»åŠ æ–°åŠŸèƒ½ä½¿æ—§ç¨‹åºå¤æ‚åŒ–ã€‚</p>
</blockquote>
<p>å› æ­¤ï¼Œåˆ†è§£å‡½æ•°ä»¥åšå¥½ä¸€ä»¶äº‹ç¡®å®ä¸Unixå“²å­¦è‹±é›„ç›¸æƒœã€‚</p>
<p>å¦‚å‰æ‰€è¿°ï¼Œå‘½åå¯¹äºå¯è¯»æ€§è‡³å…³é‡è¦ã€‚å¥½çš„å‡½æ•°åç§°æ¯”æ³¨é‡Šæ›´å¥½ï¼Œå®ƒä»¬ä¸ç¼–å†™è‰¯å¥½çš„æ³¨é‡Šæˆ– API æ–‡æ¡£ä¸€æ ·æœ‰åŠ©äºç†è§£ä»£ç ã€‚å°½é‡ä¿ç•™è¾ƒå°‘çš„åŠŸèƒ½å‚æ•°ã€‚</p>
<h2 id="é¿å…åŒ…(package)çº§åˆ«çŠ¶æ€">é¿å…åŒ…(package)çº§åˆ«çŠ¶æ€</h2>
<p>åœ¨ Go ä¸­ï¼Œå¯¹äºä»»ä½•ç»™å®šçš„å¯¼å…¥è·¯å¾„ï¼ŒåŒ…çš„å®ä¾‹éƒ½æ˜¯å”¯ä¸€ä¸€ä¸ª(å•ä¾‹)ã€‚è¿™æ„å‘³ç€åœ¨åŒ…çº§åˆ«ä¸Šï¼Œä»»ä½•å˜é‡åªæœ‰ä¸€ä¸ªå®ä¾‹ã€‚åŒ…çº§åˆ«çš„å˜é‡åœ¨å…¨å±€çº§åˆ«å…±äº«ï¼Œè¿™æ„å‘³ç€æ‰€æœ‰è®¿é—®è€…å°†å…±äº«åŒä¸€ä¸ªå®ä¾‹ã€‚å‡½æ•°<code>X</code>å¯ä»¥ä¿®æ”¹å˜é‡ï¼Œå‡½æ•°<code>Y</code>å¯ä»¥è¯»å–ä¿®æ”¹åçš„å€¼ã€‚</p>
<p>ä½¿ç”¨åŒ…çº§åˆ«çš„å˜é‡å¯èƒ½ä¼šäº§ç”Ÿè®¸å¤šå½±å“ï¼š</p>
<ol>
<li>å¾ˆéš¾è·Ÿè¸ªå˜é‡çš„ä¿®æ”¹ä½ç½®ä»¥åŠè·Ÿè¸ªè®¿é—®å˜é‡çš„ä½ç½®ä»¥åšå‡ºä»»ä½•å†³å®šã€‚</li>
<li>åŒ…çº§å˜é‡å¯¼è‡´ç´§å¯†è€¦åˆ; ä¸€ä¸ªè§’è½çš„ä»£ç ä¿®æ”¹å¯èƒ½éœ€è¦ä¿®æ”¹ä»£ç çš„å¦ä¸€ä¸ªè§’è½ï¼Œè¿™ä½¿å¾—é˜…è¯»ã€ä¿®æ”¹å’Œå•å…ƒæµ‹è¯•ä»£ç å˜å¾—æ›´åŠ å›°éš¾ã€‚</li>
<li>å®ƒå¯èƒ½ä¼šå¯¼è‡´äº‰ç”¨æ¡ä»¶ç­‰é—®é¢˜ã€‚</li>
</ol>
<p>ä½†æ˜¯ï¼ŒåŒ…çº§åˆ«å¸¸é‡çš„ä½¿ç”¨éå¸¸æœ‰ç”¨ã€‚å› æ­¤ï¼Œå§‹ç»ˆå»ºè®®å°½å¯èƒ½é¿å…ä½¿ç”¨åŒ…çº§åˆ«çŠ¶æ€(è¯‘è€…æ³¨: å¯ä¿®æ”¹çš„å˜é‡)ã€‚è‹¥è¦å‡å°‘è€¦åˆï¼Œè¯·å°†ç›¸å…³å˜é‡ç§»åˆ°æ‰€éœ€çš„ç»“æ„ä½“çš„å­—æ®µä¸Šã€‚åœ¨ç»“æ„ä½“ä¸­å®šä¹‰ä¾èµ–é¡¹å’Œé…ç½®ä½¿å…¶å˜å¾—å®¹æ˜“ã€‚æ¥å£çš„ä½¿ç”¨ä¹Ÿéå¸¸æœ‰å¸®åŠ©ã€‚</p>
<h2 id="å°½æ—©è¿”å›å¹¶æ˜æ™ºåœ°ä½¿ç”¨æ¡ä»¶">å°½æ—©è¿”å›å¹¶æ˜æ™ºåœ°ä½¿ç”¨æ¡ä»¶</h2>
<p>æ¡ä»¶è¯­å¥æ˜¯æˆ‘ä»¬å¿…é¡»ç»å¸¸å†™çš„ä¸œè¥¿ã€‚å®ƒåœ¨ä»£ç æ˜¯å¹²å‡€è¿˜æ˜¯æ··ä¹±æ–¹é¢å‘æŒ¥ç€é‡è¦ä½œç”¨ã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> do(n <span class="typename">int</span>) <span class="typename">bool</span> {</div><div class="line">    <span class="keyword">if</span> n &gt;<span class="number"> 12</span> {</div><div class="line">        <span class="keyword">return</span> <span class="constant">false</span></div><div class="line">    } <span class="keyword">else</span> {</div><div class="line">        <span class="keyword">return</span> <span class="constant">true</span></div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>æ­¤ä»£ç çš„é—®é¢˜åœ¨äº<code>else</code>è¯­å¥åœ¨æ­¤å¤„æ²¡æœ‰å¸®åŠ©;ç›¸åï¼Œå®ƒä½¿ä»£ç å˜å¾—æ··ä¹±ä¸”å¯è¯»æ€§é™ä½ã€‚ç›¸åï¼ŒæŠŠå®ƒå†™æˆï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> do(n <span class="typename">int</span>) <span class="typename">bool</span> {</div><div class="line">    <span class="keyword">if</span> n &gt;<span class="number"> 12</span> {</div><div class="line">        <span class="keyword">return</span> <span class="constant">false</span></div><div class="line">    }</div><div class="line">    <span class="keyword">return</span> <span class="constant">true</span></div><div class="line">}</div></pre></td></tr></table></figure>

<p>è¯‘è€…æ³¨ï¼Œ æŠŠå®ƒå†™æˆä¸‹é¢çš„æ–¹å¼æ›´ç®€æ´ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> do(n <span class="typename">int</span>) <span class="typename">bool</span> {</div><div class="line">    <span class="keyword">return</span> n &lt;=<span class="number"> 12</span></div><div class="line">}</div></pre></td></tr></table></figure>

<p>ä½ ä¹Ÿç»å¸¸ä¼šçœ‹åˆ°æ•´ä¸ªå‡½æ•°ä½“éƒ½åŒ…åœ¨<code>if</code>è¯­å¥é‡Œé¢,è¿™ä¹Ÿæ˜¯ä¸å¥½çš„</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> do(n <span class="typename">int</span>) {</div><div class="line">    <span class="keyword">if</span> n &gt;<span class="number"> 12</span> {</div><div class="line">        sum()</div><div class="line">        subtract()</div><div class="line">        multiply()</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>å¯ä»¥ç¿»è½¬åˆ¤æ–­æ¡ä»¶ä½¿ä»£ç æ›´ç®€æ´å¯è¯»:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> do(n <span class="typename">int</span>) {</div><div class="line">    <span class="keyword">if</span> n &lt;=<span class="number"> 12</span> {</div><div class="line">        <span class="keyword">return</span></div><div class="line">    }</div><div class="line">    sum()</div><div class="line">    subtract()</div><div class="line">    multiply()</div><div class="line">}</div></pre></td></tr></table></figure>

<h2 id="æ›´ç»å¸¸çš„ä½¿ç”¨switch">æ›´ç»å¸¸çš„ä½¿ç”¨<code>switch</code></h2>
<p><strong>switch</strong>è¯­å¥æ˜¯ç¼©çŸ­ if-else è¯­å¥åºåˆ—çš„æœ€ä½³æ–¹å¼ï¼Œæœ‰ç›Šäºç¼–å†™å¹²å‡€çš„ç¨‹åºã€‚ç¨‹åºç»å¸¸éœ€è¦åšæ¯”è¾ƒåˆ¤æ–­ï¼Œå¦‚æœæˆ‘ä»¬çš„ç¨‹åºä½¿ç”¨äº†å¤ªå¤šçš„<code>if-else</code>ï¼Œä¼šä½¿ä»£ç å‡Œä¹±ä¸”å¯è¯»æ€§è¾ƒå·®ã€‚æ‰€ä»¥ä½¿ç”¨switchæœ‰å¾ˆå¤§å¸®åŠ©ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> transact(bank <span class="typename">string</span>) {</div><div class="line">    <span class="keyword">if</span> bank == <span class="string">"Citi"</span> {</div><div class="line">        fmt.Printf(<span class="string">"Tx #1: %s\n"</span>, bank)</div><div class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> bank == <span class="string">"StandardChartered"</span> {</div><div class="line">        fmt.Printf(<span class="string">"Tx #2: %s\n"</span>, bank)</div><div class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> bank == <span class="string">"HSBC"</span> || bank == <span class="string">"Deutsche"</span> || bank == <span class="string">"JPMorgan"</span> {</div><div class="line">        fmt.Printf(<span class="string">"Tx #3: %s\n"</span>, bank)</div><div class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> bank == <span class="string">"NatWest"</span> {</div><div class="line">        fmt.Printf(<span class="string">"Tx #4: %s\n"</span>, bank)</div><div class="line">    } <span class="keyword">else</span> {</div><div class="line">        fmt.Printf(<span class="string">"Tx #E: %s\n"</span>, bank)</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>è¿™çœ‹èµ·æ¥å¾ˆä¹±ï¼Œå¯¹å§ï¼Ÿç°åœ¨è®©æˆ‘ä»¬æ”¹ç”¨ä¸€ä¸ªswitchã€‚ä»¥ä¸‹ä»£ç å¦‚ä½•ä»¥æƒ¯ç”¨æ–¹å¼é‡å†™ç›¸åŒçš„ä»£ç ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> transact(bank <span class="typename">string</span>) {</div><div class="line">    <span class="keyword">switch</span> bank {</div><div class="line">    <span class="keyword">case</span> <span class="string">"Citi"</span>:</div><div class="line">        fmt.Printf(<span class="string">"Tx #1: %s\n"</span>, bank)</div><div class="line">    <span class="keyword">case</span> <span class="string">"StandardChartered"</span>:</div><div class="line">        fmt.Printf(<span class="string">"Tx #2: %s\n"</span>, bank)</div><div class="line">    <span class="keyword">case</span> <span class="string">"HSBC"</span>, <span class="string">"Deutsche"</span>, <span class="string">"JPMorgan"</span>:</div><div class="line">        fmt.Printf(<span class="string">"Tx #3: %s\n"</span>, bank)</div><div class="line">    <span class="keyword">case</span> <span class="string">"NatWest"</span>:</div><div class="line">        fmt.Printf(<span class="string">"Tx #4: %s\n"</span>, bank)</div><div class="line">    <span class="keyword">default</span>:</div><div class="line">        fmt.Printf(<span class="string">"Tx #E: %s\n"</span>, bank)</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>å°†æ¥ï¼Œå¦‚æœæ·»åŠ æ–°çš„é“¶è¡Œï¼Œä½¿ç”¨<code>switch-case</code>å°†æ›´å®¹æ˜“ï¼Œæ›´å¹²å‡€ã€‚</p>
<h2 id="æŒç»­çš„ä»£ç é‡æ„">æŒç»­çš„ä»£ç é‡æ„</h2>
<p>åœ¨å¤§å‹ä»£ç åº“ä¸­ï¼Œé‡æ„ä»£ç åº“ç»“æ„è‡³å…³é‡è¦ã€‚ä»£ç é‡æ„ä¸æ—¶åœ°æé«˜ä»£ç çš„å¯è¯»æ€§å’Œè´¨é‡ã€‚è¿™ä¸æ˜¯ä¸€æ¬¡æ€§çš„è¿‡ç¨‹ï¼›å›¢é˜Ÿåº”æŒç»­æ”¯ä»˜æŠ€æœ¯å€ºåŠ¡ï¼Œä»¥ä¿æŒä»£ç åº“æ­£å¸¸ã€‚æˆ‘æ›¾å­¦è¿‡â€œå°½æ—©é‡æ„ï¼Œç»å¸¸é‡æ„â€ï¼ˆ<code>refactor early, refactor often</code>ï¼‰ï¼Œè¿™å¯¹äºç¼–å†™å¯ç»´æŠ¤çš„Goä»£ç éå¸¸æœ‰æ„ä¹‰ã€‚éšç€æ—¶é—´çš„æ¨ç§»ï¼ŒåŒ…çš„ä»£ç æ•°é‡å’Œè´£ä»»ä¼šå˜å¾—è¶Šæ¥è¶Šé‡ï¼Œå› æ­¤æœ€å¥½å°†ä¸€äº›åŒ…åˆ†è§£æˆæ›´å°çš„åŒ…ï¼Œå› ä¸ºå®ƒä»¬æ˜“äºç»´æŠ¤ã€‚é‡æ„åŒ…çš„å¦ä¸€ä¸ªå¥½ç†ç”±æ˜¯æ”¹è¿›å‘½åã€‚åŒ…åªåŒ…å«ä¸å…¶åŠŸèƒ½ç›¸å…³çš„ä»£ç ä¹Ÿæ˜¯è‡³å…³é‡è¦çš„ã€‚ä¾‹å¦‚ï¼ŒGoæŠŠ<code>os.SEEK_SET</code>ã€<code>os.SEEK_CUR</code>å’Œ <code>os.SEEK_END</code>ç§»åŠ¨åˆ°<code>io.SeekStart</code>ã€<code>io.SeekCurrent</code>å’Œ <code>io.SeekEnd</code>ã€‚åŒ…<code>io</code>æ›´é€‚åˆäºç»„ç»‡æ¶‰åŠæ–‡ä»¶I/Oçš„ä»£ç ã€‚å°†åŒ…åˆ†è§£æˆå°çš„åŒ…ä¹Ÿä¼šä½¿ä¾èµ–å…³ç³»å˜å¾—è½»é‡çº§ã€‚</p>
<h2 id="ç»“è®º">ç»“è®º</h2>
<p>éšç€æ—¶é—´å’Œå…¶ä»–ç¨‹åºå‘˜åœ¨ä»£ç åº“ä¸Šå·¥ä½œï¼Œæˆ‘ä»¬æ›´å¥½åœ°ç†è§£å¯ç»´æŠ¤æ€§æ„å‘³ç€ä»€ä¹ˆã€‚ ç¼–å†™å¯ç»´æŠ¤çš„ä»£ç å¹¶ä¸å¤æ‚ï¼› å®ƒéœ€è¦æ¯ä¸ªè´¡çŒ®ä»£ç çš„äººçš„çŸ¥è¯†ã€ç»éªŒå’Œä»”ç»†æ€è€ƒã€‚ æˆ‘ä»¬è®¨è®ºçš„ä¸€ç»„è‰¯å¥½å®è·µåº”è¯¥å¯ä»¥å¸®åŠ©æ‚¨å’Œå›¢é˜Ÿæ›´å¥½åœ°ç»´æŠ¤æ‚¨çš„ Go ä»£ç ã€‚</p>
<blockquote>
<p>åŸæ–‡ <a href="https://deepsource.io/learn/software-engineering-guide/writing-maintainable-go-code/" target="_blank" rel="external">Writing maintainable Go code - DeepSource Learn</a> by Jogendra</p>
</blockquote>
]]></content>
    <summary type="html">
    <![CDATA[<p>ç¼–å†™å¯ç»´æŠ¤çš„ä»£ç æ˜¯æœ€åŸºæœ¬çš„è¦æ±‚ã€‚æ¸…æ™°åº¦ã€å¯è¯»æ€§å’Œç®€å•æ€§éƒ½æ˜¯ä¿æŒä»£ç å¯ç»´æŠ¤æ€§çš„å„ä¸ªæ–¹é¢ã€‚å®ƒåº”è¯¥ä½¿æŸäººåŠ å…¥æ‚¨çš„é¡¹ç›®æˆ–åœ¨æœ‰äººç¦»å¼€åç»´æŠ¤ä»£ç çš„è¿‡ç¨‹å˜å¾—å®¹æ˜“ã€‚å¯ç»´æŠ¤æ€§çš„è¡¡é‡æŒ‡æ ‡æ˜¯ä»£ç æ›´æ”¹çš„å®¹æ˜“ç¨‹åº¦ä»¥åŠä¸è¿™äº›æ›´æ”¹å¼•èµ·çš„é£é™©æ€§ã€‚ä¸ºäº†æœ‰æ•ˆåœ°ç¼–å†™Goç¨‹åºï¼Œäº†è§£Goè¯­è¨€çš„å±æ€§å’Œåœ°é“å†™æ³•ï¼Œå¹¶ä½¿ç”¨ä¸å‘½åã€ç¨‹åºæ„å»ºã€æ ¼å¼ç­‰ç›¸å…³æ—¢å®šçº¦å®šæ˜¯è‡³å…³é‡è¦ã€‚</p>
<p>ä»¥ä¸‹æ˜¯ä¸€äº›æœ‰åŠ©äºç¼–å†™å¯ç»´æŠ¤çš„Goä»£ç çš„è‰¯å¥½å®è·µã€‚</p>
<p>åŸæ–‡: <a href="https://jogendra.dev/writing-maintainable-go-code" target="_blank" rel="external">Writing maintainable Go code</a> by Jogendra.</p>
]]>
    
    </summary>
    
      <category term="Go" scheme="https://colobu.com/categories/Go/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Goæ³›å‹ç¼–ç¨‹: æ”¯æŒç‰¹ä¾‹åŒ–?]]></title>
    <link href="https://colobu.com/2022/01/11/go-generic-supports-specialization-no/"/>
    <id>https://colobu.com/2022/01/11/go-generic-supports-specialization-no/</id>
    <published>2022-01-11T00:14:53.000Z</published>
    <updated>2022-01-16T11:25:05.338Z</updated>
    <content type="html"><![CDATA[<p>ä¸€äº›ç¼–ç¨‹è¯­è¨€å¦‚C++ã€Rustéƒ½æ˜¯æ”¯æŒæ³›å‹ç‰¹ä¾‹åŒ–çš„ï¼ŒGoæ³›å‹æ”¯æŒå—ï¼Ÿ</p>
<a id="more"></a>
<p>æ‰€è°“ç‰¹ä¾‹åŒ–(specialization)å¯¹æ³›å‹åŠŸèƒ½ä»£ç çš„æ‰©å±•ã€‚æ¯”å¦‚å¯¹äºæ³›å‹çš„å‡½æ•°ï¼Œå®ƒçš„å®ç°å¯¹äºæ»¡è¶³æ³›å‹å‚æ•°çš„æ‰€æœ‰ç±»å‹(type set)éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå¦‚æœæˆ‘ä»¬æƒ³å¯¹è¿™äº›ç±»å‹é›†(type set)ä¸­çš„ä¸€ä¸ªï¼Œå®ƒçš„å‡½æ•°åšç‰¹æ®Šçš„å®ç°ï¼Œä¸€äº›æ”¯æŒæ³›å‹ç‰¹ä¾‹åŒ–çš„è¯­è¨€æ˜¯å¯ä»¥æ”¯æŒçš„ï¼Œæ¯”å¦‚C++ template:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</div><div class="line"><span class="keyword">void</span> fun(T a)</div><div class="line">{</div><div class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">"template fun(): "</span> &lt;&lt; a &lt;&lt; endl;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;&gt;   <span class="comment">// å¯¹intå‹ç‰¹ä¾‹åŒ–</span></div><div class="line"><span class="keyword">void</span> fun(<span class="keyword">int</span> a)</div><div class="line">{</div><div class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">"specialized template fun for int type: "</span> &lt;&lt; a &lt;&lt; endl;</div><div class="line">}</div></pre></td></tr></table></figure>

<p>è¿™é‡Œ<code>fun</code>æ˜¯ä¸€ä¸ªå‡½æ•°æ¨¡æ¿,ä½†æ˜¯é’ˆå¯¹<code>int</code>ç±»å‹ï¼Œæ­¤å‡½æ•°æœ‰ç‰¹æ®Šçš„å®ç°ã€‚</p>
<p>Rustä¹Ÿæœ‰ç±»ä¼¼çš„åŠŸèƒ½:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor">#![feature(min_specialization)]</span></div><div class="line"></div><div class="line"><span class="keyword">struct</span> Special</div><div class="line">{</div><div class="line">    x : usize,</div><div class="line">    y : usize</div><div class="line">}</div><div class="line"></div><div class="line">trait MyTrait</div><div class="line">{</div><div class="line">    fn myfunc(&self);</div><div class="line">}</div><div class="line"></div><div class="line">impl&lt;T&gt; MyTrait <span class="keyword">for</span> T</div><div class="line">{</div><div class="line">    <span class="keyword">default</span> fn myfunc(&self) { println!(<span class="string">"hi"</span>); }</div><div class="line">}</div><div class="line"></div><div class="line">impl MyTrait <span class="keyword">for</span> Special</div><div class="line">{</div><div class="line">    fn myfunc(&self) { println!(<span class="string">"I'm special"</span>); }</div><div class="line">}</div><div class="line"></div><div class="line">fn main() {</div><div class="line">    let spe = Special{</div><div class="line">        x: <span class="number">1</span>,</div><div class="line">        y: <span class="number">2</span>,</div><div class="line">    };</div><div class="line">    spe.myfunc();</div><div class="line">}</div></pre></td></tr></table></figure>

<p>è¿™é‡Œ<code>MyTrait</code>é’ˆå¯¹é€šç”¨ç±»å‹<code>T</code>æœ‰ä¸€ä¸ªé»˜è®¤å®ç°ï¼Œä½†æ˜¯é’ˆå¯¹ç‰¹å®šçš„ç±»å‹<code>Special</code>,æœ‰ä¸€ä¸ªç‰¹å®šçš„å®ç°ã€‚</p>
<p>å…¶å®ƒç¼–ç¨‹è¯­è¨€å½“å‰è¿˜ä¸æ”¯æŒç‰¹ä¾‹åŒ–ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡æ–¹æ³•é‡è½½å®ç°ç±»ä¼¼çš„åŠŸèƒ½ï¼Œå¦‚typescriptã€C#ç­‰ã€‚<br>å¦å¤–å¤æ‚çš„ç‰¹ä¾‹åŒ–è¿˜åŒ…æ‹¬éƒ¨åˆ†ç‰¹ä¾‹åŒ–çš„ç‰¹æ€§ã€‚</p>
<p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼ŒGoçš„æ³›å‹(ç±»å‹å‚æ•°)æ˜¯å¦æ”¯æŒç‰¹ä¾‹åŒ–å‘¢ï¼Ÿæˆ‘ä»¬å…ˆå†™ä¸ªä¾‹å­:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> List[T any] <span class="keyword">struct</span> {</div><div class="line">	next  *List[T]</div><div class="line">	value T</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">func</span> (l *List[T]) Len() <span class="typename">int</span> {</div><div class="line">	<span class="keyword">return</span><span class="number"> 0</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">func</span> (l *List[<span class="typename">string</span>]) Length() <span class="typename">int</span> {</div><div class="line">	<span class="keyword">return</span><span class="number"> 0</span></div><div class="line">}</div></pre></td></tr></table></figure>

<p>è¿™é‡Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªæ³›å‹ç±»å‹<code>List[T any]</code>, åŒ…æ‹¬å®ƒçš„ä¸€ä¸ªæ³›å‹æ–¹æ³•<code>Len() int</code>ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°è¯•å®šä¹‰ä¸€ä¸ªâ€œç‰¹ä¾‹åŒ–â€çš„æ–¹æ³•<code>Length() int</code>ã€‚</p>
<p>ç¼–è¯‘ä¸€ä¸‹ï¼Œæ²¡é—®é¢˜ï¼Œç¨‹åºå¯ä»¥æ­£å¸¸ç¼–è¯‘ï¼Œéš¾é“Goæ³›å‹çœŸçš„æ”¯æŒç‰¹ä¾‹åŒ–å—ï¼Ÿ</p>
<p>æˆ‘ä»¬å†å¢åŠ ä¸€ä¸ªç‰¹ä¾‹åŒ–æ³›å‹æ–¹æ³•è¯•è¯•:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> (l *List[<span class="typename">int</span>]) Size() <span class="typename">int</span> {</div><div class="line">	<span class="keyword">return</span><span class="number"> 0</span></div><div class="line">}</div></pre></td></tr></table></figure>

<p>è¿™ä¸ªæ—¶å€™å†ç¼–è¯‘è¯•è¯•,ç¼–è¯‘å‡ºé”™:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cannot <span class="operator"><span class="keyword">use</span> <span class="number">0</span> (untyped <span class="built_in">int</span> constant) <span class="keyword">as</span> <span class="built_in">int</span> <span class="keyword">value</span> <span class="keyword">in</span> <span class="keyword">return</span> statement</span></div></pre></td></tr></table></figure>

<p>å…¶å®è¿™ä¸ªé”™è¯¯ä¿¡æ¯å·²ç»å‘Šè¯‰æˆ‘ä»¬äº†ï¼Œè¿™é‡Œçš„<code>int</code>å¹¶ä¸æ˜¯å†…å»ºçš„æ•´æ•°ç±»å‹ï¼Œè€Œæ˜¯ä¸€ä¸ªç±»å‹å‚æ•°çš„åç§°ï¼Œç­‰ä»·äºæˆ‘ä»¬å¸¸ç”¨çš„<code>T</code>ã€<code>K</code>ã€<code>V</code>ã€‚è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨<code>int</code>ä½œä¸ºç±»å‹å‚æ•°çš„åç§°å¾ˆæœ‰è¿·æƒ‘æ€§ã€‚</p>
<p>æ‰€ä»¥ç­”æ¡ˆä¹Ÿæ˜¯å¾ˆæ˜ç¡®çš„ï¼Œå½“å‰Go 1.18å¹¶ä¸æ”¯æŒ<strong>æ³›å‹ç‰¹ä¾‹åŒ–</strong>, å°å¿ƒåˆ«æ‰åˆ°å‘é‡Œäº†ã€‚</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>ä¸€äº›ç¼–ç¨‹è¯­è¨€å¦‚C++ã€Rustéƒ½æ˜¯æ”¯æŒæ³›å‹ç‰¹ä¾‹åŒ–çš„ï¼ŒGoæ³›å‹æ”¯æŒå—ï¼Ÿ</p>
]]>
    
    </summary>
    
      <category term="Go" scheme="https://colobu.com/categories/Go/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Goæ³›å‹ç¼–ç¨‹: interface ä¸å†æ˜¯é‚£ä¸ªinterface]]></title>
    <link href="https://colobu.com/2022/01/08/the-interface-is-not-that-interface-in-go-1-18/"/>
    <id>https://colobu.com/2022/01/08/the-interface-is-not-that-interface-in-go-1-18/</id>
    <published>2022-01-08T13:48:20.000Z</published>
    <updated>2022-01-14T11:10:58.895Z</updated>
    <content type="html"><![CDATA[<p>è‡ª Go 1.18 æ”¯æŒæ³›å‹åï¼Œ Go interface çš„æ„ä¹‰å·²ç»å½»å½»åº•åº•çš„æ”¹å˜äº†ï¼Œé™¤äº†å…ˆå‰ä»£è¡¨çš„æ–¹æ³•é›†çš„æ„ä¹‰å¤–ï¼Œè¿˜è¢«ç”¨ä½œæ³›å‹çš„ç±»å‹çº¦æŸ(type constraint)çš„åŠŸèƒ½, interfaceå·²ç»ä¸å†æ˜¯ä»¥å‰é‚£ä¸ªå•çº¯çš„å°‘å¹´äº†ã€‚</p>
<a id="more"></a>
<p>åœ¨Go 1.17.xä»¥åŠä»¥å‰çš„ç‰ˆæœ¬ä¸­ï¼Œinterfaceæ˜¯è¿™æ ·å®šä¹‰çš„ï¼š</p>
<blockquote>
<p>An interface type specifies a <strong>method set</strong> called its interface. A variable of interface type can store a value of any type with a method set that is any superset of the interface. Such a type is said to implement the interface. The value of an uninitialized variable of interface type is nil.</p>
<p>æ¥å£ç±»å‹å®šä¹‰äº†ä¸€ä¸ªæ–¹æ³•é›†åˆï¼Œç§°ä¹‹ä¸ºæ¥å£(interface)ã€‚æ¥å£ç±»å‹çš„å˜é‡å¯ä»¥å­˜å‚¨ä»»æ„çš„å®ç°è¿™ä¸ªæ–¹æ³•é›†åˆçš„ç±»å‹ï¼Œè¿™ç§ç±»å‹æ˜¯æ­¤interfaceçš„è¶…é›†ã€‚è¿™ç§ç±»å‹è¢«ç§°ä¸ºå®ç°äº†æ¥å£ã€‚æ¥å£ç±»å‹çš„å˜é‡å¦‚æœæœªåˆå§‹åŒ–åˆ™å®ƒçš„å€¼ä¸ºnilã€‚</p>
</blockquote>
<p>åœ¨Go 1.18ä¸­ï¼Œinterfaceå®šä¹‰æ”¹å˜äº†ï¼š</p>
<blockquote>
<p>An interface type defines a <strong>type set</strong>. A variable of interface type can store a value of any type that is in the type set of the interface. Such a type is said to implement the interface. The value of an uninitialized variable of interface type is nil.</p>
<p>æ¥å£ç±»å‹å®šä¹‰äº†ä¸€ä¸ªç±»å‹é›†åˆã€‚æ¥å£ç±»å‹çš„å˜é‡å¯ä»¥å­˜å‚¨è¿™ä¸ªæ¥å£ç±»å‹é›†åˆçš„ä»»æ„ä¸€ç§ç±»å‹çš„å®ä¾‹å€¼ã€‚è¿™ç§ç±»å‹è¢«ç§°ä¹‹ä¸ºå®ç°äº†è¿™ä¸ªæ¥å£ã€‚æ¥å£ç±»å‹çš„å˜é‡å¦‚æœæœªåˆå§‹åŒ–åˆ™å®ƒçš„å€¼ä¸ºnilã€‚</p>
</blockquote>
<p>æ‰€ä»¥ä¸€å¥è¯ï¼Œå…ˆå‰æ¥å£å®šä¹‰äº†æ–¹æ³•é›†åˆï¼Œç°åœ¨æ¥å£å®šä¹‰äº†ç±»å‹é›†åˆã€‚æ¥å£çš„ç”¨é€”ä¹Ÿè¿›è¡Œäº†æ‰©å±•ã€‚</p>
<p>interfaceçš„å®šä¹‰ä¹Ÿæ‰©å±•äº†ã€‚å…ˆå‰ï¼Œæ¥å£å®šä¹‰åªèƒ½åŒ…å«æ–¹æ³•å…ƒç´ (method element):</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">interface</span> {</div><div class="line">	Read([]<span class="typename">byte</span>) (<span class="typename">int</span>, error)</div><div class="line">	Write([]<span class="typename">byte</span>) (<span class="typename">int</span>, error)</div><div class="line">	Close() error</div><div class="line">}</div></pre></td></tr></table></figure>

<p>ç°åœ¨æ¥å£å®šä¹‰é™¤äº†æ–¹æ³•å…ƒç´ å¤–ï¼Œè¿˜å¯ä»¥åŒ…å«ç±»å‹å…ƒç´ :</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">interface</span> {</div><div class="line">	<span class="typename">int</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// An interface representing all types with underlying type int.</span></div><div class="line"><span class="keyword">interface</span> {</div><div class="line">	~<span class="typename">int</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// An interface representing all types with underlying type int which implement the String method.</span></div><div class="line"><span class="keyword">interface</span> {</div><div class="line">	~<span class="typename">int</span></div><div class="line">	String() <span class="typename">string</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// An interface representing an empty type set: there is no type that is both an int and a string.</span></div><div class="line"><span class="keyword">interface</span> {</div><div class="line">	<span class="typename">int</span></div><div class="line">	<span class="typename">string</span></div><div class="line">}</div></pre></td></tr></table></figure>

<p>ç±»å‹å…ƒç´ åŒ…å«ç±»å‹(<code>T</code>)æˆ–è€…è¿‘ä¼¼ç±»å‹(<code>~T</code>)æˆ–è€…è”åˆ(union)å…ƒç´ (<code>A|B|C|~D</code>)ã€‚</p>
<p>ä½†æ˜¯ï¼Œå› ä¸ºæ¥å£çš„å®šä¹‰å’Œå«ä¹‰æ”¹å˜äº†ï¼Œæ‰€ä»¥æ¥å£åœ¨ä½¿ç”¨çš„æ—¶å€™ä¹Ÿæœ‰ä¸€äº›äº›ä¸åŒã€‚æœ¬æ–‡é€šè¿‡å®ä¾‹ä¸€ä¸€ä»‹ç»ã€‚</p>
<p>é¦–å…ˆè®°ä½ä¸€ç‚¹ï¼ŒGo 1.17.x åŠä»¥å‰çš„ç‰ˆæœ¬ä¸­æ¥å£çš„ä½¿ç”¨æ–¹æ³•åœ¨Go 1.18ä¸­ç…§æ ·ä½¿ç”¨ï¼Œä½¿ç”¨æ–¹æ³•ä¸å˜ã€‚å˜å¾—æ˜¯æ¥å£æœ‰ç±»å‹å…ƒç´ æˆ–è€…åšç±»å‹çº¦æŸæ—¶çš„ä¸€äº›é™åˆ¶ã€‚</p>
<h3 id="è¿‘ä¼¼å…ƒç´ çš„ç±»å‹Tå¿…é¡»æ˜¯åº•å±‚ç±»å‹(underlying_type)è‡ªå·±ï¼Œè€Œä¸”ä¸èƒ½æ˜¯æ¥å£ç±»å‹">è¿‘ä¼¼å…ƒç´ çš„ç±»å‹<code>T</code>å¿…é¡»æ˜¯åº•å±‚ç±»å‹(underlying type)è‡ªå·±ï¼Œè€Œä¸”ä¸èƒ½æ˜¯æ¥å£ç±»å‹</h3>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// é”™è¯¯çš„å®šä¹‰!</span></div><div class="line"><span class="keyword">type</span> MyInt <span class="typename">int</span></div><div class="line"></div><div class="line"><span class="keyword">type</span> I0 <span class="keyword">interface</span> {</div><div class="line">	~MyInt <span class="comment">// é”™è¯¯! MyIntä¸æ˜¯underlying type, intæ‰æ˜¯</span></div><div class="line">	~error <span class="comment">// é”™è¯¯! erroræ˜¯æ¥å£</span></div><div class="line">}</div></pre></td></tr></table></figure>

<h3 id="è”åˆ(union)ç±»å‹å…ƒç´ ä¸èƒ½æ˜¯ç±»å‹å‚æ•°(type_parameter)">è”åˆ(union)ç±»å‹å…ƒç´ ä¸èƒ½æ˜¯ç±»å‹å‚æ•°(type parameter)</h3>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// é”™è¯¯, interface{ K }ä¸­Kæ˜¯ç±»å‹å‚æ•°</span></div><div class="line"><span class="keyword">func</span> I1[K any, V <span class="keyword">interface</span>{ K }]() {</div><div class="line">}</div></pre></td></tr></table></figure>



<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// é”™è¯¯, interface{ nt | K }ä¸­K æ˜¯ç±»å‹å‚æ•°</span></div><div class="line"><span class="keyword">func</span> I2[K any, V <span class="keyword">interface</span>{ <span class="typename">int</span> | K }]() {</div><div class="line">}</div></pre></td></tr></table></figure>

<h3 id="è”åˆ(union)ç±»å‹å…ƒç´ çš„éæ¥å£å…ƒç´ å¿…é¡»æ˜¯ä¸¤ä¸¤ä¸ç›¸äº¤">è”åˆ(union)ç±»å‹å…ƒç´ çš„éæ¥å£å…ƒç´ å¿…é¡»æ˜¯ä¸¤ä¸¤ä¸ç›¸äº¤</h3>
<p>ä¸¤ä¸¤ä¸ç›¸äº¤æ„æ€æ˜¯ä¸¤ä¸¤çš„äº¤é›†æ˜¯ç©ºé›†ï¼Œæ¯”å¦‚ <code>int|string</code>çš„äº¤é›†æ˜¯ç©ºé›†ï¼Œè€Œ<code>int|~int</code>çš„äº¤é›†æ˜¯<code>int</code>ã€‚</p>
<p>è”åˆç±»å‹ä¸­çš„éæ¥å£å…ƒç´ å¿…é¡»æ˜¯ä¸¤ä¸¤ä¸ç›¸äº¤çš„ã€‚</p>
<p>ä¸‹é¢çš„å®šä¹‰æ²¡é—®é¢˜ï¼Œå› ä¸ºanyç­‰ä»·äº<code>interface{}</code>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> I3[K any, V <span class="keyword">interface</span>{ <span class="typename">int</span> | any }]() {</div><div class="line">}</div></pre></td></tr></table></figure>



<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// é”™è¯¯ï¼ intå’Œ!intç›¸äº¤</span></div><div class="line"><span class="keyword">func</span> I4[K any, V <span class="keyword">interface</span>{ <span class="typename">int</span> | ~<span class="typename">int</span> }]() {</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// ä¸‹é¢çš„å®šä¹‰æ²¡æœ‰é—®é¢˜ã€‚å› ä¸ºintå’ŒMyIntæ˜¯ä¸¤ä¸ªç±»å‹ï¼Œä¸ç›¸äº¤</span></div><div class="line"><span class="keyword">type</span> MyInt <span class="typename">int</span></div><div class="line"><span class="keyword">func</span> I5[K any, V <span class="keyword">interface</span>{ <span class="typename">int</span> | MyInt }]() {</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// é”™è¯¯! intå’Œ~MyIntç›¸äº¤ï¼Œäº¤é›†æ˜¯int</span></div><div class="line"><span class="keyword">func</span> I6[K any, V <span class="keyword">interface</span>{ <span class="typename">int</span> | ~MyInt }]() {</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// é”™è¯¯! intå’ŒMyInt2æ˜¯ç›¸åŒç±»å‹ï¼Œç›¸äº¤</span></div><div class="line"><span class="keyword">type</span> MyInt2 = <span class="typename">int</span></div><div class="line"><span class="keyword">func</span> I7[K any, V <span class="keyword">interface</span>{ <span class="typename">int</span> | MyInt2 }]() {</div><div class="line">}</div></pre></td></tr></table></figure>

<h3 id="è”åˆ(union)ç±»å‹å…ƒç´ å¦‚æœåŒ…å«å¤šäºä¸€ä¸ªå…ƒç´ ï¼Œä¸èƒ½åŒ…å«åŒ…å«éç©ºæ–¹æ³•çš„æ¥å£ç±»å‹ï¼Œä¹Ÿä¸èƒ½æ˜¯comparableæˆ–è€…åµŒå…¥comparable">è”åˆ(union)ç±»å‹å…ƒç´ å¦‚æœåŒ…å«å¤šäºä¸€ä¸ªå…ƒç´ ï¼Œä¸èƒ½åŒ…å«åŒ…å«éç©ºæ–¹æ³•çš„æ¥å£ç±»å‹ï¼Œä¹Ÿä¸èƒ½æ˜¯comparableæˆ–è€…åµŒå…¥comparable</h3>
<p>è¿™æ¡è§„åˆ™å®šä¹‰äº†æ¥å£ä½œä¸ºç±»å‹å…ƒç´ çš„ä¸€äº›é™åˆ¶.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ç¼–è¯‘æ²¡é—®é¢˜ï¼ŒåªåŒ…å«ä¸€ä¸ªå…ƒç´ </span></div><div class="line"><span class="keyword">func</span> I9[K <span class="keyword">interface</span>{ io.Reader }]() {</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// é”™è¯¯!ä¸èƒ½ç¼–è¯‘ã€‚å› ä¸ºåŒ…å«äº†ä¸¤ä¸ªå…ƒç´ ï¼Œè€Œä¸”æ— è®ºæ˜¯`io.Reader`è¿˜æ˜¯`io.Writer`éƒ½åŒ…å«æ–¹æ³•</span></div><div class="line"><span class="keyword">func</span> I10[K <span class="keyword">interface</span>{ io.Reader | io.Writer }]() {</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// ç¼–è¯‘æ­£å¸¸ï¼Œå› ä¸ºè¿™æ˜¯æ­£å¸¸çš„æ¥å£ï¼Œæ²¡æœ‰è”åˆå…ƒç´ </span></div><div class="line"><span class="keyword">func</span> I11[K <span class="keyword">interface</span> {</div><div class="line">	io.Reader</div><div class="line">	io.Writer</div><div class="line">}]() {</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// é”™è¯¯! è”åˆç±»å‹å¤šäºä¸€ä¸ªå…ƒç´ ï¼Œå¹¶ä¸”io.ReaderåŒ…å«æ–¹æ³•</span></div><div class="line"><span class="keyword">func</span> I12[K <span class="keyword">interface</span>{ io.Reader | <span class="typename">int</span> }]() {</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// é”™è¯¯! ä¸èƒ½ç¼–è¯‘.å› ä¸ºè”åˆå…ƒç´ å¤§äºä¸€ä¸ªï¼Œå¹¶ä¸”ä¸èƒ½æ˜¯comparable</span></div><div class="line"><span class="keyword">func</span> I13[K comparable | <span class="typename">int</span>]() {</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// é”™è¯¯! ä¸èƒ½ç¼–è¯‘.å› ä¸ºè”åˆå…ƒç´ å¤§äºä¸€ä¸ªï¼Œå¹¶ä¸”å…ƒç´ ä¸èƒ½åµŒå…¥comparable</span></div><div class="line"><span class="keyword">func</span> I14[K <span class="keyword">interface</span>{ comparable } | <span class="typename">int</span>]() {</div><div class="line">}</div></pre></td></tr></table></figure>

<h3 id="åŒ…å«éæ¥å£ç±»å‹å…ƒç´ ã€è¿‘ä¼¼å…ƒç´ å’Œè”åˆç±»å‹åªèƒ½ç”¨ä½œç±»å‹å‚æ•°ï¼Œæˆ–è€…å…¶å®ƒç”¨ä½œçº¦æŸæ¥å£çš„å…ƒç´ ">åŒ…å«éæ¥å£ç±»å‹å…ƒç´ ã€è¿‘ä¼¼å…ƒç´ å’Œè”åˆç±»å‹åªèƒ½ç”¨ä½œç±»å‹å‚æ•°ï¼Œæˆ–è€…å…¶å®ƒç”¨ä½œçº¦æŸæ¥å£çš„å…ƒç´ </h3>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> (</div><div class="line"></div><div class="line">    <span class="comment">// ä»¥ä¸‹ç¼–è¯‘æ²¡é—®é¢˜ </span></div><div class="line">	_ <span class="keyword">interface</span>{}</div><div class="line">	_ <span class="keyword">interface</span>{ m() }</div><div class="line">	_ <span class="keyword">interface</span>{ io.Reader }</div><div class="line">	_ <span class="keyword">interface</span> {</div><div class="line">		io.Reader</div><div class="line">		io.Writer</div><div class="line">	}</div><div class="line"></div><div class="line">    <span class="comment">// ä»¥ä¸‹ä¸èƒ½ç¼–è¯‘ï¼Œæ¥å£ä¸èƒ½ç”¨ä½œå˜é‡å®ä¾‹ç±»å‹</span></div><div class="line">	_ <span class="keyword">interface</span>{ <span class="typename">int</span> }</div><div class="line">	_ <span class="keyword">interface</span>{ ~<span class="typename">int</span> }</div><div class="line">	_ <span class="keyword">interface</span>{ MyInt }</div><div class="line">	A <span class="keyword">interface</span> {</div><div class="line">   	  <span class="typename">int</span></div><div class="line">	  m()</div><div class="line">	}</div><div class="line"></div><div class="line">    <span class="comment">// å¯ä»¥ç¼–è¯‘</span></div><div class="line">	_ <span class="keyword">struct</span>{ i <span class="typename">int</span> }</div><div class="line">    <span class="comment">// ä¸‹é¢ä¸€è¡Œä¸èƒ½ç¼–è¯‘,å› ä¸º~intä¸èƒ½ä½œä¸ºå­—æ®µçš„ç±»å‹</span></div><div class="line">	_ <span class="keyword">struct</span>{ i ~<span class="typename">int</span> }</div><div class="line">    <span class="comment">// ä¸‹é¢ä¸€è¡Œä¸èƒ½ç¼–è¯‘ï¼Œå› ä¸ºconstraints.Orderedåªèƒ½ç”¨ä½œç±»å‹çº¦æŸ</span></div><div class="line">	_ <span class="keyword">struct</span>{ i constraints.Ordered }</div><div class="line"></div><div class="line">    <span class="comment">// ä¸‹é¢ä¸¤è¡Œèƒ½å¤Ÿç¼–è¯‘ï¼Œå› ä¸ºå®ƒä»¬æ˜¯æ¥å£ç±»å‹ï¼Œå¹¶ä¸”ç±»å‹å…ƒç´ ä¹Ÿæ˜¯æ™®é€šæ¥å£</span></div><div class="line">    _ <span class="keyword">interface</span>{ any }</div><div class="line">	_ <span class="keyword">interface</span> {</div><div class="line">		<span class="keyword">interface</span> {</div><div class="line">			any</div><div class="line">			m()</div><div class="line">		}</div><div class="line">	}</div><div class="line">    <span class="comment">// ä¸èƒ½ç¼–è¯‘ï¼Œå› ä¸ºæ¥å£éƒ¨ç½²æ™®é€šæ¥å£ï¼Œè€Œæ˜¯ç±»å‹çº¦æŸ</span></div><div class="line">	_ <span class="keyword">interface</span> {</div><div class="line">		<span class="keyword">interface</span> {</div><div class="line">			<span class="typename">int</span>|~<span class="typename">int</span></div><div class="line">			m()</div><div class="line">		}</div><div class="line">	}</div><div class="line">)</div></pre></td></tr></table></figure>

<h3 id="æ¥å£ç±»å‹ä¸å®šé€’å½’åµŒå…¥">æ¥å£ç±»å‹ä¸å®šé€’å½’åµŒå…¥</h3>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// é”™è¯¯! ä¸èƒ½è‡ªå·±åµŒå…¥è‡ªå·±</span></div><div class="line"><span class="keyword">type</span> Node <span class="keyword">interface</span> {</div><div class="line">	Node</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// é”™è¯¯! Treeä¸èƒ½é€šè¿‡TreeNodeåµŒå…¥è‡ªå·±</span></div><div class="line"><span class="keyword">type</span> Tree <span class="keyword">interface</span> {</div><div class="line">	TreeNode</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">type</span> TreeNode <span class="keyword">interface</span> {</div><div class="line">	Tree</div><div class="line">}</div></pre></td></tr></table></figure>

]]></content>
    <summary type="html">
    <![CDATA[<p>è‡ª Go 1.18 æ”¯æŒæ³›å‹åï¼Œ Go interface çš„æ„ä¹‰å·²ç»å½»å½»åº•åº•çš„æ”¹å˜äº†ï¼Œé™¤äº†å…ˆå‰ä»£è¡¨çš„æ–¹æ³•é›†çš„æ„ä¹‰å¤–ï¼Œè¿˜è¢«ç”¨ä½œæ³›å‹çš„ç±»å‹çº¦æŸ(type constraint)çš„åŠŸèƒ½, interfaceå·²ç»ä¸å†æ˜¯ä»¥å‰é‚£ä¸ªå•çº¯çš„å°‘å¹´äº†ã€‚</p>
]]>
    
    </summary>
    
      <category term="Go" scheme="https://colobu.com/categories/Go/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[[è¯‘] go fuzzing]]></title>
    <link href="https://colobu.com/2022/01/03/go-fuzzing/"/>
    <id>https://colobu.com/2022/01/03/go-fuzzing/</id>
    <published>2022-01-03T13:40:09.000Z</published>
    <updated>2022-01-03T14:28:09.864Z</updated>
    <content type="html"><![CDATA[<p>Go fuzzing(æ¨¡ç³Šæµ‹è¯•)æ˜¯Go 1.18å‘å¸ƒçš„å¦ä¸€ä¸ªéå¸¸é‡è¦çš„ç‰¹æ€§ï¼Œå› ä¸ºGoæ³›å‹å·²ç»æŠŠå¤§å®¶çš„ç›®å…‰éƒ½å¸å¼•è¿‡å»äº†ï¼Œå¯¼è‡´go fuzzingè¿™ä¸ªç‰¹æ€§æœ‰äº›äººè¿˜ä¸æ˜¯å¤ªäº†è§£ã€‚Goå®˜æ–¹å‘å¸ƒäº†ä¸€ä¸ªæ–‡æ¡£ï¼Œä»‹ç»äº†Go FuzzingæŠ€æœ¯ã€‚<br><a href="https://tip.golang.org/doc/fuzz/" target="_blank" rel="external">Go Fuzzing</a></p>
<a id="more"></a>
<p>Go è‡ª 1.18å¼€å§‹åœ¨æ ‡å‡†å·¥å…·é“¾ä¸­å¼€å§‹æ”¯æŒæ¨¡ç³Šæµ‹è¯•(fuzzing)ã€‚</p>
<h2 id="æ¦‚è§ˆ">æ¦‚è§ˆ</h2>
<p>Fuzzing æ˜¯ä¸€ç§è‡ªåŠ¨åŒ–çš„æµ‹è¯•æŠ€æœ¯ï¼Œ å®ƒä¸æ–­çš„åˆ›å»ºè¾“å…¥ç”¨æ¥æµ‹è¯•ç¨‹åºçš„bugã€‚ Go fuzzingä½¿ç”¨è¦†ç›–ç‡æ™ºèƒ½æŒ‡å¯¼éå†è¢«æ¨¡ç³ŠåŒ–æµ‹è¯•çš„ä»£ç ï¼Œå‘ç°ç¼ºé™·å¹¶æŠ¥å‘Šç»™ç”¨æˆ·ã€‚ç”±äºæ¨¡ç³Šæµ‹è¯•å¯ä»¥è¾¾åˆ°äººç±»ç»å¸¸å¿½ç•¥çš„è¾¹ç¼˜åœºæ™¯ï¼Œå› æ­¤å®ƒå¯¹äºå‘ç°å®‰å…¨æ¼æ´å’Œç¼ºé™·ç‰¹åˆ«æœ‰ä»·å€¼ã€‚</p>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªæ¨¡ç³Šæµ‹è¯•çš„ç¤ºä¾‹ï¼Œçªå‡ºæ ‡è¯†äº†å®ƒçš„ä¸»è¦ç»„ä»¶ã€‚<br><img src="example.png" alt=""></p>
<h2 id="ç¼–å†™å¹¶è¿è¡Œæ¨¡ç³Šæµ‹è¯•">ç¼–å†™å¹¶è¿è¡Œæ¨¡ç³Šæµ‹è¯•</h2>
<h3 id="å¿…å¤‡æ¡ä»¶">å¿…å¤‡æ¡ä»¶</h3>
<p>Below are rules that fuzz tests must follow.</p>
<p>ä¸‹é¢æ˜¯æ¨¡ç³Šæµ‹è¯•å¿…é¡»éµå¾ªçš„è§„åˆ™ï¼š</p>
<ul>
<li>æ¨¡ç³Šæµ‹è¯•å¿…é¡»æ˜¯ä¸€ä¸ªåç§°ç±»ä¼¼<code>FuzzXxx</code>çš„å‡½æ•°ï¼Œä»…ä»…æ¥æ”¶ä¸€ä¸ª<code>*testing.F</code>ç±»å‹çš„å‚æ•°,æ²¡æœ‰è¿”å›å€¼</li>
<li>æ¨¡ç³Šæµ‹è¯•å¿…é¡»åœ¨<code>*_test.go</code>æ–‡ä»¶ä¸­æ‰èƒ½è¿è¡Œ</li>
<li>Fuzz target(æ¨¡ç³Šç›®æ ‡)å¿…é¡»æ˜¯å¯¹<code>(*testing.F).Fuzz</code>çš„æ–¹æ³•è°ƒç”¨ï¼Œå‚æ•°æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå¹¶ä¸”æ­¤å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯<code>*testing.T</code>,ç„¶åæ˜¯æ¨¡ç³Šå‚æ•°(<code>fuzzing argument</code>)ï¼Œæ²¡æœ‰è¿”å›å€¼</li>
<li>ä¸€ä¸ªæ¨¡ç³Šæµ‹è¯•ä¸­å¿…é¡»åªæœ‰ä¸€ä¸ªæ¨¡ç³Šç›®æ ‡</li>
<li>æ‰€æœ‰çš„ç§å­è¯­æ–™åº“(<code>seed corpus</code>)å¿…é¡»å…·æœ‰ä¸æ¨¡ç³Šå‚æ•°ç›¸åŒçš„ç±»å‹,é¡ºåºç›¸åŒã€‚å¯¹<code>(*testing.F).Add</code>çš„è°ƒç”¨ä¹Ÿæ˜¯å¦‚æ­¤, åŒæ ·ä¹Ÿé€‚ç”¨æ¨¡ç³Šæµ‹è¯•ä¸­çš„testdata/fuzzä¸­çš„è¯­æ–™æ–‡ä»¶</li>
<li>æ¨¡ç³Šå‚æ•°åªèƒ½æ˜¯ä¸‹é¢çš„ç±»å‹<ul>
<li>string, []byte</li>
<li>int, int8, int16, int32/rune, int64</li>
<li>uint, uint8/byte, uint16, uint32, uint64</li>
<li>float32, float64</li>
<li>bool</li>
</ul>
</li>
</ul>
<h3 id="å»ºè®®">å»ºè®®</h3>
<p>ä¸‹é¢çš„å»ºè®®å¯ä»¥å¸®åŠ©ä½ åº”ä»˜å¤§éƒ¨åˆ†çš„æ¨¡ç³Šæµ‹è¯•ï¼š</p>
<ul>
<li>Fuzzingåº”è¯¥åœ¨æ”¯æŒè¦†ç›–ç‡æ£€æµ‹çš„å¹³å°ä¸Šè¿è¡Œï¼ˆç›®å‰æ˜¯AMD64å’ŒARM64ï¼‰ï¼Œè¿™æ ·è¯­æ–™åº“å¯ä»¥åœ¨è¿è¡Œæ—¶æœ‰æ„ä¹‰åœ°å¢é•¿ï¼Œå¹¶ä¸”åœ¨è¿›è¡ŒFuzzingæ—¶å¯ä»¥è¦†ç›–æ›´å¤šçš„ä»£ç ã€‚</li>
<li>æ¨¡ç³Šç›®æ ‡åº”è¯¥æ˜¯å¿«é€Ÿçš„å’Œç¡®å®šæ€§çš„ï¼Œè¿™æ ·æ¨¡ç³Šå¼•æ“å¯ä»¥æœ‰æ•ˆåœ°å·¥ä½œï¼Œå¹¶ä¸”æ–°çš„æ•…éšœå’Œä»£ç è¦†ç›–ç‡å¯ä»¥å¾ˆå®¹æ˜“åœ°é‡ç°ã€‚</li>
<li>ç”±äºæ¨¡ç³Šç›®æ ‡æ˜¯åœ¨å¤šä¸ªå·¥ä½œè¿›ç¨‹ä¹‹é—´ä»¥ä¸ç¡®å®šçš„é¡ºåºå¹¶è¡Œè°ƒç”¨çš„ï¼Œå› æ­¤æ¨¡ç³Šç›®æ ‡çš„çŠ¶æ€ä¸åº”æŒç»­åˆ°æ¯æ¬¡è°ƒç”¨ç»“æŸåï¼Œå¹¶ä¸”æ¨¡ç³Šç›®æ ‡çš„è¡Œä¸ºä¸åº”ä¾èµ–äºå…¨å±€çŠ¶æ€ã€‚</li>
</ul>
<h3 id="å®šåˆ¶">å®šåˆ¶</h3>
<p>é»˜è®¤çš„goå‘½ä»¤æ»¡è¶³å¤§éƒ¨åˆ†æ¨¡ç³ŠåŒ–æµ‹è¯•åœºæ™¯ï¼Œæ‰€ä»¥å…¸å‹çš„ä¸€ä¸ªæ¨¡ç³ŠåŒ–è¿è¡Œå‘½ä»¤åº”è¯¥å¦‚ä¸‹:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ go test -fuzz={FuzzTestName}</div></pre></td></tr></table></figure>

<p>ä½†æ˜¯goå‘½ä»¤æä¾›ä¸€äº›å®šåˆ¶åŒ–çš„å‚æ•°æ¥è¿è¡Œæ¨¡ç³Šæµ‹è¯•ï¼Œå®ƒä»¬åœ¨<a href="https://pkg.go.dev/cmd/go" target="_blank" rel="external">cmd/go</a>æ–‡æ¡£ä¸­éƒ½æœ‰ä»‹ç»ã€‚</p>
<p>è¿™é‡Œé‡ç‚¹è¯´å‡ ä¸ª:</p>
<p>-fuzztime:  æ‰§è¡Œçš„æ¨¡ç³Šç›®æ ‡åœ¨é€€å‡ºçš„æ—¶å€™è¦æ‰§è¡Œçš„æ€»æ—¶é—´æˆ–è€…è¿­ä»£æ¬¡æ•°ï¼Œé»˜è®¤æ˜¯ç”¨ä¸ç»“æŸ<br>-fuzzminimizetime: æ¨¡ç³Šç›®æ ‡åœ¨æ¯æ¬¡æœ€å°‘å°è¯•æ—¶è¦æ‰§è¡Œçš„æ—¶é—´æˆ–è€…è¿­ä»£æ¬¡æ•°ï¼Œé»˜è®¤æ˜¯60ç§’ã€‚ä½ å¯ä»¥ç¦ç”¨æœ€å°åŒ–å°è¯•ï¼Œåªéœ€æŠŠè¿™ä¸ªå‚æ•°è®¾ç½®ä¸º0<br>-parallel: åŒæ—¶æ‰§è¡Œçš„æ¨¡ç³ŠåŒ–æ•°é‡ï¼Œé»˜è®¤æ˜¯<code>$GOMAXPROCS</code>ã€‚å½“å‰è¿›è¡Œæ¨¡ç³ŠåŒ–æµ‹è¯•æ—¶è®¾ç½®-cpuæ— æ•ˆæœ</p>
<h2 id="å…¶å®ƒèµ„æº">å…¶å®ƒèµ„æº</h2>
<ul>
<li><strong>æ•™ç¨‹</strong><ul>
<li>å¦‚æœæƒ³äº†è§£Goæ¨¡ç³ŠåŒ–ä»‹ç»æ€§çš„æ–‡ç« ï¼Œè¯·å‚è€ƒ<a href="https://go.dev/blog/fuzz-beta" target="_blank" rel="external">the blog post</a></li>
<li>æ›´å¤šæ•™ç¨‹æ­£åœ¨å‡†å¤‡ä¸­</li>
</ul>
</li>
<li><strong>æ–‡æ¡£</strong><ul>
<li><code>testing</code> åŒ…æè¿°äº†æ¨¡ç³Šæµ‹è¯•ä¸­ç”¨åˆ°çš„<code>testing.F</code>ç±»å‹</li>
<li><code>cmd/go</code> æè¿°äº†å’Œæ¨¡ç³Šæµ‹è¯•ç›¸å…³çš„å‚æ•°</li>
</ul>
</li>
<li><strong>æŠ€æœ¯ç»†èŠ‚</strong><ul>
<li><a href="https://golang.org/s/draft-fuzzing-design" target="_blank" rel="external">Design draft</a></li>
<li><a href="https://golang.org/issue/44551" target="_blank" rel="external">ææ¡ˆ</a></li>
</ul>
</li>
</ul>
<h2 id="æœ¯è¯­">æœ¯è¯­</h2>
<ul>
<li>corpus entry: è¯­æ–™åº“æ¡ç›®ï¼Œå¯ä»¥åœ¨æ¨¡ç³ŠåŒ–æµ‹è¯•æ—¶ä½¿ç”¨ã€‚å®ƒå¯ä»¥æ˜¯ä¸€ä¸ªç‰¹æ®Šæ ¼å¼çš„æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥æ˜¯<code>(*testing.F).Add</code>æ–¹æ³•çš„è°ƒç”¨</li>
<li>coverage guidance: ä¸€ç§æ¨¡ç³ŠåŒ–æ–¹æ³•ï¼Œå®ƒä½¿ç”¨ä»£ç è¦†ç›–èŒƒå›´çš„æ‰©å±•æ¥ç¡®å®šå“ªäº›è¯­æ–™åº“æ¡ç›®å€¼å¾—ä¿ç•™ä»¥å¤‡å°†æ¥ä½¿ç”¨ã€‚</li>
<li>fuzz target: æ¨¡ç³Šæµ‹è¯•çš„å‡½æ•°ï¼Œåœ¨æ¨¡ç³ŠåŒ–è¿‡ç¨‹ä¸­å¯¹è¯­æ–™åº“æ¡ç›®å’Œç”Ÿæˆçš„å€¼æ‰§è¡Œæ¨¡ç³Šæµ‹è¯•ã€‚é€šè¿‡å°†å‡½æ•°ä¼ é€’ç»™<code>(*testing.F).Fuzz</code>æ¥æä¾›æ¨¡ç³Šæµ‹è¯•</li>
<li>fuzz test: ä¸€ä¸ªtestæ–‡ä»¶ä¸­çš„å‡½æ•°ï¼Œæ ¼å¼ä¸º<code>FuzzXxx(*testing.F)</code>,ç”¨æ¥æ‰§è¡Œæ¨¡ç³Šæµ‹è¯•</li>
<li>fuzzing: ä¸€ç§è‡ªåŠ¨æµ‹è¯•ç±»å‹ï¼Œå®ƒä¸æ–­åœ°ä¿®æ”¹ç¨‹åºçš„è¾“å…¥ï¼Œä»¥å‘ç°ä»£ç å¯èƒ½æ˜“å—å½±å“çš„é—®é¢˜ï¼Œå¦‚bugæˆ–æ¼æ´ã€‚</li>
<li>fuzzing arguments: è¢«ä¼ é€’åˆ°æ¨¡ç³Šç›®æ ‡çš„ç±»å‹ï¼Œå¹¶ä¸”å¯ä»¥è¢«mutatorä¿®æ”¹å˜å¼‚</li>
<li>fuzzing engine: ä¸€ç§ç®¡ç†æ¨¡ç³ŠåŒ–çš„å·¥å…·ï¼ŒåŒ…æ‹¬ç»´æŠ¤è¯­æ–™åº“ã€è°ƒç”¨å˜ä½“ã€è¯†åˆ«æ–°è¦†ç›–èŒƒå›´å’ŒæŠ¥å‘Šå¤±è´¥ã€‚</li>
<li>generated corpus: è¯­æ–™åº“åœ¨æ¨¡ç³ŠåŒ–è¿‡ç¨‹ä¸­ç”±æ¨¡ç³Šå¼•æ“éšæ—¶é—´è¿›è¡Œç»´æŠ¤ï¼Œä»¥è·Ÿè¸ªè¿›åº¦ã€‚å®ƒå­˜å‚¨åœ¨<code>$GOCACHE/fuzz</code>ä¸­ã€‚</li>
<li>mutator: æ¨¡ç³Šå¤„ç†æ—¶ä½¿ç”¨çš„ä¸€ç§å·¥å…·ï¼Œå®ƒåœ¨å°†è¯­æ–™åº“æ¡ç›®ä¼ é€’ç»™æ¨¡ç³Šç›®æ ‡ä¹‹å‰å¯¹å…¶è¿›è¡Œéšæœºæ“ä½œã€‚</li>
<li>package: åŒä¸€ä¸ªæ–‡ä»¶å¤¹ä¸‹æºä»£ç çš„é›†åˆï¼Œä¼šè¢«ç¼–è¯‘åœ¨ä¸€èµ·ã€‚Goä»£ç ç»„ç»‡çš„<a href="https://tip.golang.org/ref/spec#Packages" target="_blank" rel="external">æ–¹å¼</a>ã€‚ation.</li>
<li>seed corpus: ç”¨æˆ·æä¾›çš„ç”¨äºæ¨¡ç³Šæµ‹è¯•çš„è¯­æ–™åº“ï¼Œå¯ç”¨äºæŒ‡å¯¼æ¨¡ç³Šå¼•æ“ã€‚å®ƒç”±æ¨¡ç³Šæµ‹è¯•ä¸­çš„<code>f.Add</code>è°ƒç”¨æä¾›çš„è¯­æ–™åº“æ¡ç›®å’ŒåŒ…ä¸­<code>testdata/fuzz/{FuzzTestName}</code>ç›®å½•ä¸­çš„æ–‡ä»¶ç»„æˆã€‚</li>
<li>test file: æ ¼å¼ä¸º<code>xxx_test.go</code>ç±»å‹çš„æ–‡ä»¶ï¼ŒåŒ…å«æµ‹è¯•ã€benchmarkå’Œæ¨¡ç³Šæµ‹è¯•ä»£ç </li>
<li>vulnerability: ä»£ç ä¸­çš„å®‰å…¨æ•æ„Ÿå¼±ç‚¹ï¼Œå¯è¢«æ”»å‡»è€…åˆ©ç”¨ã€‚</li>
</ul>
]]></content>
    <summary type="html">
    <![CDATA[<p>Go fuzzing(æ¨¡ç³Šæµ‹è¯•)æ˜¯Go 1.18å‘å¸ƒçš„å¦ä¸€ä¸ªéå¸¸é‡è¦çš„ç‰¹æ€§ï¼Œå› ä¸ºGoæ³›å‹å·²ç»æŠŠå¤§å®¶çš„ç›®å…‰éƒ½å¸å¼•è¿‡å»äº†ï¼Œå¯¼è‡´go fuzzingè¿™ä¸ªç‰¹æ€§æœ‰äº›äººè¿˜ä¸æ˜¯å¤ªäº†è§£ã€‚Goå®˜æ–¹å‘å¸ƒäº†ä¸€ä¸ªæ–‡æ¡£ï¼Œä»‹ç»äº†Go FuzzingæŠ€æœ¯ã€‚<br><a href="https://tip.golang.org/doc/fuzz/" target="_blank" rel="external">Go Fuzzing</a></p>
]]>
    
    </summary>
    
      <category term="Go" scheme="https://colobu.com/categories/Go/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Goæ³›å‹ä¸æ”¯æŒæ³›å‹æ–¹æ³•ï¼Œè¿™æ˜¯ä¸€ä¸ªæ‚²ä¼¤çš„æ•…äº‹]]></title>
    <link href="https://colobu.com/2021/12/22/no-parameterized-methods/"/>
    <id>https://colobu.com/2021/12/22/no-parameterized-methods/</id>
    <published>2021-12-22T00:25:06.000Z</published>
    <updated>2021-12-22T06:37:46.594Z</updated>
    <content type="html"><![CDATA[<p>æ ¹æ®Go æ³›å‹ææ¡ˆçš„æè¿°ï¼ŒGoä¸æ”¯æŒæ³›å‹æ–¹æ³•:<a href="https://github.com/golang/proposal/blob/master/design/43651-type-parameters.md#no-parameterized-methods" target="_blank" rel="external">No parameterized methods</a>ã€‚ä¸»è¦åŸå› Goæ³›å‹çš„å¤„ç†æ˜¯åœ¨ç¼–è¯‘çš„æ—¶å€™å®ç°çš„ï¼Œæ³›å‹æ–¹æ³•åœ¨ç¼–è¯‘çš„æ—¶å€™ï¼Œå¦‚æœæ²¡æœ‰ä¸Šä¸‹æ–‡çš„åˆ†ææ¨æ–­ï¼Œå¾ˆéš¾åˆ¤æ–­æ³›å‹æ–¹æ¡ˆè¯¥å¦‚ä½•å®ä¾‹åŒ–ï¼Œç”šè‡³åˆ¤æ–­ä¸äº†ï¼Œå¯¼è‡´ç›®å‰(Go 1.18)Goå®ç°ä¸­ä¸æ”¯æŒæ³›å‹æ–¹æ¡ˆã€‚</p>
<p>ä¸è¿‡ï¼Œæ³›å‹æ–¹æ³•çš„ç¼ºå¤±ï¼Œå¤šå¤šå°‘å°‘ç»™ç¨‹åºå‘˜å¸¦æ¥ä¸€ä¸ä¸çš„å¿§ä¼¤çš„æƒ…ç»ªï¼Œåœ¨ä¸€äº›åœºæ™¯ä¹‹ä¸‹ï¼Œä½¿ç”¨èµ·æ¥ç‰¹åˆ«ä¸æ–¹ä¾¿ã€‚æˆ‘æœ€è¿‘çœ‹åˆ°äº†å‡ ä¸ªå› ä¸ºç¼ºä¹æ³›å‹æ–¹æ³•å¯¼è‡´çš„é—®é¢˜ï¼Œåœ¨æœ¬æ–‡ä¸­æ€»ç»“ä¸€ä¸‹ï¼Œå’Œå¤§å®¶æ¢è®¨ã€‚</p>
<p>æœ‰ä¸€ç‚¹ç‚¹è®©äººæ¬£æ…°çš„æ˜¯ï¼ŒIan Lance Taylorå’ŒIan Lance Taylorå¹¶æ²¡æœ‰æŠŠè¯è¯´ç»ï¼Œè¯´ä¸å®šåœ¨æŸä¸ªç‰ˆæœ¬ä¸­ï¼Œæ³›å‹æ–¹æ³•åˆæ”¯æŒäº†:</p>
<blockquote>
<p>So while parameterized methods seem clearly useful at first glance, we would have to decide what they mean and how to implement that.</p>
</blockquote>
<a id="more"></a>
<h2 id="ä¸ºå•¥å½“å‰Goæ³›å‹ä¸å¥½å®ç°æ³›å‹æ–¹æ³•?">ä¸ºå•¥å½“å‰Goæ³›å‹ä¸å¥½å®ç°æ³›å‹æ–¹æ³•?</h2>
<p>è€ƒè™‘ä¸‹é¢ä¸€ä¸ªä¾‹å­ï¼Œä¸€å…±æœ‰å››ä¸ªpackage:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> p1</div><div class="line"></div><div class="line"><span class="comment">// S æ˜¯ä¸€ä¸ªæ™®é€šçš„struct,ä½†æ˜¯åŒ…å«ä¸€ä¸ªæ³›å‹æ–¹æ³•Identity.</span></div><div class="line"><span class="keyword">type</span> S <span class="keyword">struct</span>{}</div><div class="line"></div><div class="line"><span class="comment">// Identity ä¸€ä¸ªæ³›å‹æ–¹æ³•ï¼Œæ”¯æŒä»»æ„ç±»å‹.</span></div><div class="line"><span class="keyword">func</span> (S) Identity[T any](v T) T { <span class="keyword">return</span> v }</div></pre></td></tr></table></figure>



<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> p2</div><div class="line"></div><div class="line"><span class="comment">// HasIdentity å®šä¹‰äº†ä¸€ä¸ªæ¥å£ï¼Œæ”¯æŒä»»æ„å®ç°äº†æ³›å‹æ–¹æ³•Identityçš„ç±»å‹.</span></div><div class="line"><span class="keyword">type</span> HasIdentity <span class="keyword">interface</span> {</div><div class="line">	Identity[T any](T) T</div><div class="line">}</div></pre></td></tr></table></figure>



<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> p3</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"p2"</span></div><div class="line"></div><div class="line"><span class="comment">// CheckIdentity æ˜¯ä¸€ä¸ªæ™®é€šå‡½æ•°ï¼Œæ£€æŸ¥å®å‚æ˜¯ä¸æ˜¯å®ç°äº†HasIdentityæ¥å£ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è°ƒç”¨è¿™ä¸ªæ¥å£çš„æ³›å‹æ–¹æ³•Identity.</span></div><div class="line"><span class="keyword">func</span> CheckIdentity(v <span class="keyword">interface</span>{}) {</div><div class="line">	<span class="keyword">if</span> vi, ok := v.(p2.HasIdentity); ok {</div><div class="line">		<span class="keyword">if</span> got := vi.Identity[<span class="typename">int</span>]<span class="number">(0</span>); got !=<span class="number"> 0</span> {</div><div class="line">			<span class="built_in">panic</span>(got)</div><div class="line">		}</div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure>



<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> p4</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"p1"</span></div><div class="line">	<span class="string">"p3"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment">// CheckSIdentity ä¼ å‚Sç»™CheckIdentity.</span></div><div class="line"><span class="keyword">func</span> CheckSIdentity() {</div><div class="line">	p3.CheckIdentity(p1.S{})</div><div class="line">}</div></pre></td></tr></table></figure>

<p>ä¸€åˆ‡çœ‹èµ·æ¥éƒ½æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯é—®é¢˜æ˜¯<code>package p3</code>ä¸çŸ¥é“<code>p1.S</code>ç±»å‹ï¼Œæ•´ä¸ªç¨‹åºä¸­å¦‚æœä¹Ÿæ²¡æœ‰å…¶å®ƒåœ°æ–¹è°ƒç”¨<code>p1.S.Identity</code>,ä¾ç…§ç°åœ¨çš„Goç¼–è¯‘å™¨çš„å®ç°ï¼Œæ˜¯æ²¡æœ‰åŠæ³•ä¸º<code>p1.S.Identity[int]</code>ç”Ÿæˆå¯¹åº”çš„ä»£ç çš„ã€‚</p>
<p>æ˜¯çš„ï¼Œå¦‚æœgoç¼–è¯‘å™¨åšçš„æ¯”è¾ƒå¤æ‚ï¼Œåœ¨ç¼–è¯‘çš„æ—¶å€™è¿™ä¸ªåœºæ™¯æ˜¯å¯ä»¥è¯†åˆ«å‡ºæ¥çš„ï¼Œä½†æ˜¯å®ƒéœ€è¦éå†æ•´ä½“çš„ç¨‹åºè°ƒç”¨é“¾ä»¥ä¾¿ç”Ÿæˆå…¨éƒ¨å¯èƒ½çš„æ³›å‹æ–¹æ³•ï¼Œå¯¹ç¼–è¯‘æ—¶é—´å’Œç¼–è¯‘å™¨å¤æ‚æ€§å¸¦æ¥å¾ˆå¤§çš„è°ƒæ•´ã€‚å¦å¤–ä¸€ç‚¹ï¼Œå¦‚æœä»£ç ä¸­é€šè¿‡åå°„è°ƒç”¨çš„è¯ï¼Œç¼–è¯‘å™¨å¯èƒ½ä¼šé—æ¼ä¸€äº›æ³›å‹æ–¹æ³•çš„å®ç°ï¼Œè¿™å°±å¾ˆè¦å‘½äº†ã€‚</p>
<p>å¦‚æœåœ¨è¿è¡Œæ—¶å®ç°å‘¢ï¼Ÿå°±éœ€è¦JITæˆ–è€…åå°„ç­‰æŠ€æœ¯ï¼Œè¿™ä¼šé€ æˆè¿è¡Œæ—¶æ€§èƒ½çš„ä¸‹é™ã€‚</p>
<p>å¾ˆéš¾å®ç°å•Šï¼Ÿå¦‚æœè§„å®šæ³›å‹æ–¹æ³•ä¸èƒ½å®ç°æ¥å£å‘¢ï¼Ÿé‚£ä¹ˆè¿™ç±»çš„æ³›å‹æ–¹æ³•çš„å­˜åœ¨çš„æ„ä¹‰æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p>
<p>æ‰€ä»¥ç›®å‰æ²¡æœ‰å¤ªå¥½çš„æ‰‹æ®µå»å®ç°æ³›å‹æ–¹æ³•ï¼Œæš‚æ—¶æç½®äº†ã€‚</p>
<p>å¦‚æœçœŸçš„æœ‰å¿…è¦ï¼Œä½ å¯ä»¥é€šè¿‡å®ç°æ³›å‹å‡½æ•°æ¥å®ç°æ³›å‹æ–¹æ³•ï¼ŒæŠŠæ–¹æ³•çš„receiverå½“æˆç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’è¿‡å»ã€‚</p>
<p>è¿™å¯ä»¥è§£å†³ä¸€éƒ¨åˆ†é—®é¢˜ï¼Œä½†æ˜¯åœ¨ä½¿ç”¨çš„è¿‡ç¨‹ä¸­å¤šå¤šå°‘å°‘æœ‰äº›éº»çƒ¦ã€‚</p>
<p>å› ä¸ºæ³›å‹æ–¹æ³•çš„ç¼ºä¹ï¼Œå¤§å®¶åœ¨å¼€å§‹ä½¿ç”¨æ³›å‹çš„æ—¶å€™å°±é‡åˆ°äº†éº»çƒ¦ï¼Œæœ€è¿‘è¿ç»­çœ‹åˆ°å¤šç¯‡å…³äºè¿™æ–¹é¢çš„é—®é¢˜ï¼Œæ¯”å¦‚ä¸‹é¢å‡ ä¸ªã€‚</p>
<h2 id="Facilitatoræ¨¡å¼_by_rakyll">Facilitatoræ¨¡å¼ by rakyll</h2>
<p>æ˜¨å¤©rakyllå†™äº†ä¸€ç¯‡æ–‡ç« <a href="https://rakyll.org/generics-facilititators/" target="_blank" rel="external">https://rakyll.org/generics-facilititators/</a>,ä»‹ç»å¥¹é‡åˆ°çš„å›°éš¾ä»¥åŠè§£å†³æ–¹å¼ã€‚è¿™ä¹Ÿæ˜¯ä¿ƒè¿›æˆ‘æŠŠè¿™å‡ å¤©çœ‹åˆ°çš„caseæ€»ç»“çš„åŸå› ã€‚</p>
<p>å¦‚æœä½ ç†Ÿæ‚‰å…¶å®ƒç¼–ç¨‹è¯­è¨€ï¼Œåœ¨ä½¿ç”¨ormæ¡†æ¶çš„æ—¶å€™ï¼Œå¯èƒ½è§è¿‡ä¸‹é¢ç±»ä¼¼çš„ä»£ç ï¼Œå®ç°æ³›å‹æ–¹æ³•è¿›è¡ŒæŸç§å¯¹è±¡çš„æŸ¥è¯¢:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">db, err := database.Connect(<span class="string">"...."</span>)</div><div class="line"><span class="keyword">if</span> err != <span class="constant">nil</span> {</div><div class="line">    log.Fatal(err)</div><div class="line">}</div><div class="line"></div><div class="line">all, err := db.All[Person](ctx) <span class="comment">// Reads all person entities</span></div><div class="line"><span class="keyword">if</span> err != <span class="constant">nil</span> {</div><div class="line">    log.Fatal(err)</div><div class="line">}</div></pre></td></tr></table></figure>

<p>å› ä¸ºGoç¼ºä¹æ³›å‹æ–¹æ³•çš„å®ç°ï¼Œä½ ä¸èƒ½å®ç°æ³›å‹<code>All</code>æ–¹æ³•ï¼Œé‚£ä¹ˆæ€ä¹ˆå®ç°å‘¢ï¼Ÿä¸€ç§æ–¹å¼æ˜¯å®ç°<code>All</code>å‡½æ•°ï¼Œå¦ä¸€ç§å®ç°æ˜¯å®ç°rakyllç§°ä¹‹ä¸ºçš„<code>Facilitatoræ¨¡å¼</code>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> database</div><div class="line"></div><div class="line"><span class="keyword">type</span> Client <span class="keyword">struct</span>{ ... }</div><div class="line"></div><div class="line"><span class="keyword">type</span> Querier[T any] <span class="keyword">struct</span> {</div><div class="line">	client *Client</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">func</span> NewQuerier[T any](c *Client) *Querier[T] {</div><div class="line">	<span class="keyword">return</span> &Querier[T]{</div><div class="line">		client: c,</div><div class="line">	}</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">func</span> (q *Querier[T]) All(ctx context.Context) ([]T, error) {</div><div class="line">	<span class="comment">// implementation</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">func</span> (q *Querier[T]) Filter(ctx context.Context, filter ...Filter) ([]T, error) {</div><div class="line">	<span class="comment">// implementation</span></div><div class="line">}</div></pre></td></tr></table></figure>

<p>å‡½æ•°å®ç°è®©äººæ„Ÿè§‰åˆ°ä¸€ç§æ— åŠ›æ„Ÿï¼Œä¸€ç§ç¼ºä¹å½’å®¿æ„Ÿï¼Œä¸€ç§æ²¡æœ‰å¯¹è±¡çš„æ„Ÿè§‰ï¼Œè€Œè¿™ç§å®ç°å‘¢ï¼Œç”Ÿæˆäº†ç‰¹å®šç±»å‹çš„Querier[T],<code>All</code>æ–¹æ³•å°±æœ‰æ³›å‹çš„æ„Ÿè§‰äº†(è™½ç„¶å®é™…æ˜¯Receiveræ³›å‹)</p>
<h2 id="æ³›å‹signleflight">æ³›å‹signleflight</h2>
<p>æœ‰äº›åŒå­¦ç†Ÿæ‚‰Goå®˜æ–¹æ‰©å±•åº“<a href="golang.org/x/sync/singleflight">x/sync/singleflight</a>ï¼Œè¿™ä¸ªåº“å¾ˆå¥½çš„è§£å†³å¤§å¹¶å‘çš„æ—¶å€™å¹¶å‘è®¿é—®çš„é—®é¢˜ï¼Œå¸¸å¸¸ç”¨åœ¨cacheè®¿é—®å’Œå¾®æœåŠ¡è®¿é—®çš„å¤„ç†ä¹‹ä¸­ã€‚</p>
<p>ä¸ºäº†æ”¯æŒä»»æ„ç±»å‹ï¼Œå®ƒå†…éƒ¨çš„å®ç°æ˜¯ä½¿ç”¨<code>interface{}</code>(<code>any</code>)ç±»å‹æ¥è¡¨ç¤ºå’Œå¤„ç†çš„:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> g Group</div><div class="line">v, _, _ := g.Do(<span class="string">"key"</span>, <span class="keyword">func</span>() (<span class="keyword">interface</span>{}, error) {</div><div class="line">    <span class="keyword">return</span> <span class="string">"bar"</span>, <span class="constant">nil</span></div><div class="line">})</div><div class="line">useString(v.(<span class="typename">string</span>))</div></pre></td></tr></table></figure>

<p>äº”å¤©å‰ï¼Œæœ‰äººæŠŠå®ƒæ”¹é€ æˆæ³›å‹çš„æ–¹å¼:<a href="https://github.com/marwan-at-work/singleflight" target="_blank" rel="external">marwan-at-work/singleflight</a>ï¼Œä¸Šé¢çš„ä»£ç ä½¿ç”¨èµ·æ¥æ”¹å˜æˆå¦‚ä¸‹æ–¹å¼:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> g Group[<span class="typename">string</span>]</div><div class="line">v, _, _ := g.Do(<span class="string">"key"</span>, <span class="keyword">func</span>() (<span class="typename">string</span>, error) {</div><div class="line">    <span class="keyword">return</span> <span class="string">"bar"</span>, <span class="constant">nil</span></div><div class="line">})</div><div class="line">useString(v)</div></pre></td></tr></table></figure>

<p>ç›¸å½“äºæŠŠGroupæ”¹é€ æˆæ³›å‹ç±»å‹ï¼Œè€Œä¸æ˜¯å®ç°æ³›å‹æ–¹æ³•<code>Do</code>(å½“ç„¶ç›®å‰Goæ³›å‹ä¹Ÿå®ç°ä¸äº†)ã€‚</p>
<p>è¿™ä¸ªå¤„ç†å’Œä¸Šé¢rakyllå¤„ç†æ–¹å¼ç±»å‹ï¼Œéƒ½æ˜¯ç”Ÿæˆæ³›å‹ç±»å‹ï¼Œé€šè¿‡Receiverå®ç°æ³›å‹çš„æ–¹æ³•çš„å¤„ç†ã€‚</p>
<p>ä¸è¿‡å¯¹äºè¿™ç§æ–¹å¼ï¼Œæœ‰ä¸€ç‚¹ä¸å¥½çš„åœ°æ–¹å°±æ˜¯æ¯ç§ç±»å‹ä½ éƒ½å¾—ç”Ÿæˆä¸€ä¸ªç‰¹åˆ«çš„å¯¹è±¡ï¼Œç•¥æ˜¾éº»çƒ¦ã€‚</p>
<h2 id="map_reduce">map reduce</h2>
<p>æ›´æ—©æ—¶å€™å…³äºæ³›å‹çš„è®¨è®ºï¼Œæœ‰äººæå‡ºæ³›å‹æ–¹æ³•çš„ç¼ºä¹å¯¼è‡´Goå®ç°map reduceç±»ä¼¼çš„åº“çš„å›°éš¾ï¼Œå…·ä½“åœ¨å“ªé‡Œæåˆ°çš„æˆ‘å·²ç»å¿˜è®°äº†ã€‚</p>
<p>æ¯”å¦‚ä¸‹é¢çš„å®ç°ä¸€ä¸ªiterçš„map reduce:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> (i *iter[T any]) <span class="keyword">map</span>[K ~<span class="typename">string</span>](mapFn <span class="keyword">func</span>(t T) K) *iter[K]</div></pre></td></tr></table></figure>

<p>è¿™ç§æƒ…å†µä¸‹ç”¨æˆ·æƒ³ä¼ å…¥ä»»æ„çš„<code>K</code>,æŠŠåŸå…ˆ<code>T</code>ç±»å‹çš„iterè½¬æ¢æˆ<code>K</code>ç±»å‹çš„iter,è¿™ç§å°±ä¸æƒ³å…¶å®ƒæ”¯æŒæ³›å‹è¯­è¨€é‚£ä¹ˆå¥½å®ç°äº†ã€‚</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>æ ¹æ®Go æ³›å‹ææ¡ˆçš„æè¿°ï¼ŒGoä¸æ”¯æŒæ³›å‹æ–¹æ³•:<a href="https://github.com/golang/proposal/blob/master/design/43651-type-parameters.md#no-parameterized-methods" target="_blank" rel="external">No parameterized methods</a>ã€‚ä¸»è¦åŸå› Goæ³›å‹çš„å¤„ç†æ˜¯åœ¨ç¼–è¯‘çš„æ—¶å€™å®ç°çš„ï¼Œæ³›å‹æ–¹æ³•åœ¨ç¼–è¯‘çš„æ—¶å€™ï¼Œå¦‚æœæ²¡æœ‰ä¸Šä¸‹æ–‡çš„åˆ†ææ¨æ–­ï¼Œå¾ˆéš¾åˆ¤æ–­æ³›å‹æ–¹æ¡ˆè¯¥å¦‚ä½•å®ä¾‹åŒ–ï¼Œç”šè‡³åˆ¤æ–­ä¸äº†ï¼Œå¯¼è‡´ç›®å‰(Go 1.18)Goå®ç°ä¸­ä¸æ”¯æŒæ³›å‹æ–¹æ¡ˆã€‚</p>
<p>ä¸è¿‡ï¼Œæ³›å‹æ–¹æ³•çš„ç¼ºå¤±ï¼Œå¤šå¤šå°‘å°‘ç»™ç¨‹åºå‘˜å¸¦æ¥ä¸€ä¸ä¸çš„å¿§ä¼¤çš„æƒ…ç»ªï¼Œåœ¨ä¸€äº›åœºæ™¯ä¹‹ä¸‹ï¼Œä½¿ç”¨èµ·æ¥ç‰¹åˆ«ä¸æ–¹ä¾¿ã€‚æˆ‘æœ€è¿‘çœ‹åˆ°äº†å‡ ä¸ªå› ä¸ºç¼ºä¹æ³›å‹æ–¹æ³•å¯¼è‡´çš„é—®é¢˜ï¼Œåœ¨æœ¬æ–‡ä¸­æ€»ç»“ä¸€ä¸‹ï¼Œå’Œå¤§å®¶æ¢è®¨ã€‚</p>
<p>æœ‰ä¸€ç‚¹ç‚¹è®©äººæ¬£æ…°çš„æ˜¯ï¼ŒIan Lance Taylorå’ŒIan Lance Taylorå¹¶æ²¡æœ‰æŠŠè¯è¯´ç»ï¼Œè¯´ä¸å®šåœ¨æŸä¸ªç‰ˆæœ¬ä¸­ï¼Œæ³›å‹æ–¹æ³•åˆæ”¯æŒäº†:</p>
<blockquote>
<p>So while parameterized methods seem clearly useful at first glance, we would have to decide what they mean and how to implement that.</p>
</blockquote>
]]>
    
    </summary>
    
      <category term="Go" scheme="https://colobu.com/categories/Go/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Goå¹¶å‘ç¼–ç¨‹ä¸€å¹´å›é¡¾(2021)]]></title>
    <link href="https://colobu.com/2021/11/09/the-state-of-go-sync-2021/"/>
    <id>https://colobu.com/2021/11/09/the-state-of-go-sync-2021/</id>
    <published>2021-11-09T06:37:32.000Z</published>
    <updated>2021-11-10T00:35:33.185Z</updated>
    <content type="html"><![CDATA[<p>å»å¹´çš„æ—¶å€™æˆ‘å†™äº†ä¸€ç¯‡<a href="https://colobu.com/2020/07/05/the-state-of-go-sync-2020/" target="_blank" rel="external">Goå¹¶å‘ç¼–ç¨‹ä¸€å¹´å›é¡¾</a>,å¦‚ä»Š2021å¹´ä¹Ÿå¿«ç»“æŸäº†ï¼ŒGo 1.18çš„ç‰¹æ€§å·²ç»å†»ç»“ï¼Œç¾å›½é¡µå¾ˆå¿«è¿›å…¥äº†å‡æœŸæ¨¡å¼ï¼Œè¶è¿™ä¸ªèŠ‚ç‚¹ï¼Œæˆ‘ä»¬å›é¡¾ä¸€ä¸‹è¿‘ä¸€å¹´Goå¹¶å‘ç¼–ç¨‹çš„è¿›å±•ã€‚</p>
<a id="more"></a>
<h2 id="TryLockç»ˆäºè¦å‘å¸ƒ">TryLockç»ˆäºè¦å‘å¸ƒ</h2>
<p>å¾ˆä¹…ä»¥æ¥(å¯ä»¥è¿½æº¯åˆ°2013å¹´<a href="https://github.com/golang/go/issues/6123" target="_blank" rel="external">#6123</a>),å°±æœ‰äººæè®®ç»™Mutexå¢åŠ TryLockçš„æ–¹æ³•ï¼Œè¢«å¤§ä½¬ä»¬æ— æƒ…çš„æ‹’ç»äº†ï¼Œæ–­æ–­ç»­ç»­ï¼Œæ–­æ–­ç»­ç»­çš„ä¸€ç›´æœ‰äººæè®®éœ€è¦è¿™ä¸ªæ–¹æ³•ï¼Œå¦‚ä»Šåˆ°äº†2021å¹´ï¼ŒGo teamå¤§ä½¬ä»¬ç»ˆäºæ¾å£äº†ï¼Œå¢åŠ äº†ç›¸åº”çš„æ–¹æ³•(<a href="https://github.com/golang/go/issues/45435" target="_blank" rel="external">#45435</a>)ã€‚</p>
<p>ä¸€å¥è¯æ¥è¯´ï¼ŒMutexå¢åŠ äº†TryLockï¼Œ å°è¯•è·å–é”, RWMutex å¢åŠ äº† TryLockå’ŒTryRLockæ–¹æ³•ï¼Œå°è¯•è·å–å†™é”å’Œè¯»é”ã€‚å®ƒä»¬éƒ½è¿”å›boolç±»å‹ã€‚å¦‚æœè¿”å›true,ä»£è¡¨å·²ç»è·å–åˆ°äº†ç›¸åº”çš„é”ï¼Œå¦‚æœè¿”å›false,åˆ™è¡¨ç¤ºæ²¡æœ‰è·å–åˆ°ç›¸åº”çš„é”ã€‚</p>
<p>æœ¬è´¨ä¸Šï¼Œè¦å®ç°è¿™äº›æ–¹æ³•å¹¶ä¸éº»çƒ¦ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ç›¸åº”çš„å®ç°(å»é™¤äº†raceä»£ç )ã€‚</p>
<p>é¦–å…ˆæ˜¯Mutex.TryLock:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> (m *Mutex) TryLock() <span class="typename">bool</span> {</div><div class="line">	<span class="keyword">if</span> atomic.CompareAndSwapInt32(&m.state,<span class="number"> 0</span>, mutexLocked) {</div><div class="line">		<span class="keyword">return</span> <span class="constant">true</span></div><div class="line">	}</div><div class="line">	<span class="keyword">return</span> <span class="constant">false</span></div><div class="line">}</div></pre></td></tr></table></figure>

<p>ä¹Ÿå°±æ˜¯åˆ©ç”¨aromic.CASæ“ä½œstateå­—æ®µï¼Œå¦‚æœå½“å‰æ²¡æœ‰è¢«é”æˆ–è€…æ²¡æœ‰ç­‰å¾…é”çš„æƒ…å†µï¼Œå°±å¯ä»¥æˆåŠŸè·å–åˆ°é”ã€‚ä¸ä¼šå°è¯•spinå’Œä¸ç­‰å¾…è€…ç«äº‰ã€‚</p>
<p>ä¸è¦åæ§½ä¸Šé¢çš„ä»£ç é£æ ¼ï¼Œå¯èƒ½ä½ è§‰å¾—ä¸åº”è¯¥å†™æˆä¸‹é¢çš„æ–¹å¼å—ï¼ŸåŸå› åœ¨äºæˆ‘åˆ é™¤äº†raceä»£ç ï¼Œé‚£äº›ä»£ç å—ä¸­åŒ…å«raceä»£ç ï¼Œæ‰€ä»¥ä¸èƒ½åƒä¸‹é¢ä¸€æ ·ç®€å†™ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> (m *Mutex) TryLock() <span class="typename">bool</span> {</div><div class="line">	<span class="keyword">return</span> atomic.CompareAndSwapInt32(&m.state,<span class="number"> 0</span>, mutexLocked)</div><div class="line">}</div></pre></td></tr></table></figure>

<p>è¯»å†™é”æœ‰äº›éº»çƒ¦ï¼Œå› ä¸ºå®ƒæœ‰è¯»é”å’Œå†™é”ä¸¤ç§æƒ…å†µã€‚</p>
<p>é¦–å…ˆçœ‹RWMutex.TryLock(å»é™¤äº†raceä»£ç ):</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> (rw *RWMutex) TryLock() <span class="typename">bool</span> {</div><div class="line">	<span class="keyword">if</span> !rw.w.TryLock() {</div><div class="line">		<span class="keyword">return</span> <span class="constant">false</span></div><div class="line">	}</div><div class="line">	<span class="keyword">if</span> !atomic.CompareAndSwapInt32(&rw.readerCount,<span class="number"> 0</span>, -rwmutexMaxReaders) {</div><div class="line">        rw.w.Unlock()</div><div class="line">		<span class="keyword">return</span> <span class="constant">false</span></div><div class="line">	}</div><div class="line">	<span class="keyword">return</span> <span class="constant">true</span></div><div class="line">}</div></pre></td></tr></table></figure>

<p>é¦–å…ˆåº•å±‚çš„Mutex.TryLock,å°è¯•è·å–wå­—æ®µçš„é”,å¦‚æœæˆåŠŸï¼Œéœ€è¦æ£€æŸ¥å½“å‰çš„Reader, å¦‚æœæ²¡æœ‰reader,åˆ™æˆåŠŸ, å¦‚æœæ­¤æ—¶ä¸å¹¸è¿˜æœ‰readeræ²¡æœ‰é‡Šæ”¾è¯»é”ï¼Œé‚£ä¹ˆå°è¯•Lockä¹Ÿæ˜¯ä¸æˆåŠŸçš„,è¿”å›falseã€‚æ³¨æ„è¿”å›ä¹‹å‰ä¸€å®šè¦æŠŠrw.wçš„é”é‡Šæ”¾æ‰ã€‚</p>
<p>æ¥ä¸‹æ¥çœ‹RWMutex.TryRLock(å»é™¤äº†raceä»£ç ):</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> (rw *RWMutex) TryRLock() <span class="typename">bool</span> {</div><div class="line">	<span class="keyword">for</span> {</div><div class="line">		c := atomic.LoadInt32(&rw.readerCount)</div><div class="line">		<span class="keyword">if</span> c &lt;<span class="number"> 0</span> {</div><div class="line">			<span class="keyword">return</span> <span class="constant">false</span></div><div class="line">		}</div><div class="line">		<span class="keyword">if</span> atomic.CompareAndSwapInt32(&rw.readerCount, c, c<span class="number">+1</span>) {</div><div class="line">			<span class="keyword">return</span> <span class="constant">true</span></div><div class="line">		}</div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure>

<p>è¿™æ®µä»£ç é¦–å…ˆæ£€æŸ¥readerCount,å¦‚æœä¸ºè´Ÿå€¼ï¼Œè¯´æ˜æœ‰writerï¼Œæ­¤æ—¶ç›´æ¥è¿”å›falseã€‚</p>
<p>å¦‚æœæ²¡æœ‰writer, åˆ™ä½¿ç”¨atomic.CASæŠŠreaderåŠ 1, å¦‚æœæˆåŠŸï¼Œè¿”å›ã€‚å¦‚æœä¸æˆåŠŸï¼Œé‚£ä¹ˆæ­¤æ—¶å¯èƒ½æœ‰å…¶å®ƒreaderåŠ å…¥ï¼Œæˆ–è€…ä¹Ÿå¯èƒ½æœ‰writeråŠ å…¥ï¼Œå› ä¸ºä¸èƒ½åˆ¤æ–­æ˜¯readerè¿˜æ˜¯writeråŠ å…¥ï¼Œé‚£ä¹ˆå°±ç”¨ä¸€ä¸ªforå¾ªç¯å†é‡è¯•ã€‚</p>
<p>å¦‚æœæ˜¯writeråŠ å…¥ï¼Œé‚£ä¹ˆä¸‹ä¸€æ¬¡å¾ªç¯cå¯èƒ½å°±æ˜¯è´Ÿæ•°ï¼Œç›´æ¥è¿”å›false,å¦‚æœåˆšæ‰æ˜¯æœ‰readeråŠ å…¥ï¼Œé‚£ä¹ˆå®ƒå†å°è¯•åŠ 1å°±å¥½äº†ã€‚</p>
<p>ä»¥ä¸Šå°±æ˜¯æ–°å¢çš„ä»£ç ï¼Œä¸æ˜¯ç‰¹åˆ«å¤æ‚ã€‚Go teamä¸æƒ…æ„¿çš„æŠŠè¿™å‡ ä¸ªæ–¹æ³•åŠ ä¸Šäº†, åŒæ—¶æœ‰å¾ˆè´´å¿ƒçš„æç¤º(æå“):</p>
<blockquote>
<p>Note that while correct uses of TryLock do exist, they are rare,<br>and use of TryLock is often a sign of a deeper problem<br> in a particular use of mutexes. </p>
</blockquote>
<h2 id="WaitGroupçš„å­—æ®µå˜åŒ–">WaitGroupçš„å­—æ®µå˜åŒ–</h2>
<p>å…ˆå‰ï¼ŒWaitGroupç±»å‹ä½¿ç”¨<code>[3]uint32</code>ä½œä¸º<code>state1</code>å­—æ®µçš„ç±»å‹ï¼Œåœ¨64ä½å’Œ32ä½ç¼–è¯‘å™¨æƒ…å†µä¸‹ï¼Œè¿™ä¸ªå­—æ®µçš„byteçš„æ„ä¹‰æ˜¯ä¸åŒçš„ï¼Œä¸»è¦æ˜¯ä¸ºäº†å¯¹é½ã€‚è™½ç„¶ä½¿ç”¨ä¸€ä¸ªå­—æ®µå¾ˆ&quot;ç¿æ™º&quot;,ä½†æ˜¯é˜…è¯»èµ·æ¥å´å¾ˆè´¹åŠ²ï¼Œç°åœ¨ï¼ŒGo teamæŠŠå®ƒæ”¹æˆäº†ä¸¤ä¸ªå­—æ®µï¼Œæ ¹æ®å¯¹é½è§„åˆ™ï¼Œ64ä½ç¼–è¯‘å™¨ä¼šå¯¹é½ç›¸åº”å­—æ®µï¼Œè®²çœŸçš„ï¼Œæˆ‘ä»¬ä¸å·®é‚£4ä¸ªå­—èŠ‚ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> WaitGroup <span class="keyword">struct</span> {</div><div class="line">	noCopy noCopy</div><div class="line"></div><div class="line">	<span class="comment">// 64-bit value: high 32 bits are counter, low 32 bits are waiter count.</span></div><div class="line">	<span class="comment">// 64-bit atomic operations require 64-bit alignment, but 32-bit</span></div><div class="line">	<span class="comment">// compilers only guarantee that 64-bit fields are 32-bit aligned.</span></div><div class="line">	<span class="comment">// For this reason on 32 bit architectures we need to check in state()</span></div><div class="line">	<span class="comment">// if state1 is aligned or not, and dynamically "swap" the field order if</span></div><div class="line">	<span class="comment">// needed.</span></div><div class="line">	state1 <span class="typename">uint64</span></div><div class="line">	state2 <span class="typename">uint32</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// state returns pointers to the state and sema fields stored within wg.state*.</span></div><div class="line"><span class="keyword">func</span> (wg *WaitGroup) state() (statep *<span class="typename">uint64</span>, semap *<span class="typename">uint32</span>) {</div><div class="line">	<span class="keyword">if</span> unsafe.Alignof(wg.state1) ==<span class="number"> 8</span> || <span class="typename">uintptr</span>(unsafe.Pointer(&wg.state1))<span class="number">%8</span> ==<span class="number"> 0</span> {</div><div class="line">		<span class="comment">// state1 is 64-bit aligned: nothing to do.</span></div><div class="line">		<span class="keyword">return</span> &wg.state1, &wg.state2</div><div class="line">	} <span class="keyword">else</span> {</div><div class="line">		<span class="comment">// state1 is 32-bit aligned but not 64-bit aligned: this means that</span></div><div class="line">		<span class="comment">// (&state1)+4 is 64-bit aligned.</span></div><div class="line">		state := (*<span class="number">[3</span>]<span class="typename">uint32</span>)(unsafe.Pointer(&wg.state1))</div><div class="line">		<span class="keyword">return</span> (*<span class="typename">uint64</span>)(unsafe.Pointer(&state<span class="number">[1</span>])), &state<span class="number">[0</span>]</div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure>

<p>64ä½å¯¹é½æƒ…å†µä¸‹state1å’Œstate2æ„ä¹‰å¾ˆæ˜ç¡®ï¼Œå¦‚æœä¸æ˜¯64ä½å¯¹é½ï¼Œè¿˜å¾—å·§å¦™çš„è½¬æ¢ä¸€ä¸‹ã€‚</p>
<h2 id="Poolä¸­ä½¿ç”¨fastrandnæ›¿æ¢fastrand">Poolä¸­ä½¿ç”¨fastrandnæ›¿æ¢fastrand</h2>
<p>Goè¿è¡Œæ—¶ä¸­æä¾›äº†<code>fastrandn</code>æ–¹æ³•ï¼Œè¦æ¯”<code>fastrand() % n</code>å¿«å¾ˆå¤šï¼Œç›¸å…³çš„æ–‡ç« å¯ä»¥çœ‹ä¸‹é¢ä¸­çš„æ³¨é‡Šä¸­çš„åœ°å€ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//go:nosplit</span></div><div class="line"><span class="keyword">func</span> fastrand() <span class="typename">uint32</span> {</div><div class="line">	mp := getg().m</div><div class="line">	<span class="comment">// Implement wyrand: https://github.com/wangyi-fudan/wyhash</span></div><div class="line">	<span class="keyword">if</span> goarch.IsAmd64|goarch.IsArm64|goarch.IsPpc64|</div><div class="line">		goarch.IsPpc64le|goarch.IsMips64|goarch.IsMips64le|</div><div class="line">		goarch.IsS390x|goarch.IsRiscv64 ==<span class="number"> 1</span> {</div><div class="line">		mp.fastrand +=<span class="number"> 0</span>xa0761d6478bd642f</div><div class="line">		hi, lo := math.Mul64(mp.fastrand, mp.fastrand<span class="number">^0</span>xe7037ed1a0b428db)</div><div class="line">		<span class="keyword">return</span> <span class="typename">uint32</span>(hi ^ lo)</div><div class="line">	}</div><div class="line"></div><div class="line">	<span class="comment">// Implement xorshift64+</span></div><div class="line">	t := (*<span class="number">[2</span>]<span class="typename">uint32</span>)(unsafe.Pointer(&mp.fastrand))</div><div class="line">	s1, s0 := t<span class="number">[0</span>], t<span class="number">[1</span>]</div><div class="line">	s1 ^= s1 &lt;&lt;<span class="number"> 17</span></div><div class="line">	s1 = s1 ^ s0 ^ s1&gt;<span class="number">&gt;7</span> ^ s0&gt;<span class="number">&gt;16</span></div><div class="line">	t<span class="number">[0</span>], t<span class="number">[1</span>] = s0, s1</div><div class="line">	<span class="keyword">return</span> s0 + s1</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">//go:nosplit</span></div><div class="line"><span class="keyword">func</span> fastrandn(n <span class="typename">uint32</span>) <span class="typename">uint32</span> {</div><div class="line">	<span class="comment">// This is similar to fastrand() % n, but faster.</span></div><div class="line">	<span class="comment">// See https://lemire.me/blog/2016/06/27/a-fast-alternative-to-the-modulo-reduction/</span></div><div class="line">	<span class="keyword">return</span> <span class="typename">uint32</span>(<span class="typename">uint64</span>(fastrand()) * <span class="typename">uint64</span>(n) &gt;&gt;<span class="number"> 32</span>)</div><div class="line">}</div></pre></td></tr></table></figure>

<p>æ‰€ä»¥sync.Poolä¸­ä½¿ç”¨<code>fastrandn</code>åšäº†ä¸€ç‚¹ç‚¹ä¿®æ”¹ï¼Œç”¨æ¥æé«˜æ€§èƒ½ã€‚å¥½å·å•Šï¼Œè¿™ä¸€ç‚¹ç‚¹æ€§èƒ½éƒ½æ¥å‹æ¦¨,å…³é”®ï¼Œè¿™è¿˜æ˜¯å¼€å¯raceæ‰ä¼šæ‰§è¡Œçš„ä»£ç ã€‚</p>
<h2 id="sync-Valueå¢åŠ äº†Swapå’ŒCompareAndSwapä¸¤ä¸ªä¾¿åˆ©æ–¹æ³•">sync.Valueå¢åŠ äº†Swapå’ŒCompareAndSwapä¸¤ä¸ªä¾¿åˆ©æ–¹æ³•</h2>
<p>å¦‚æœä½¿ç”¨sync.Value,è¿™ä¸¤ä¸ªæ–¹æ³•çš„é€»è¾‘ç»å¸¸ä¼šç”¨åˆ°ï¼Œç°åœ¨è¿™ä¸¤ä¸ªæ–¹æ³•å·²ç»æ·»åŠ åˆ°æ ‡å‡†åº“ä¸­äº†ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> (v *Value) Swap(<span class="built_in">new</span> <span class="keyword">interface</span>{}) (old <span class="keyword">interface</span>{}) </div><div class="line"><span class="keyword">func</span> (v *Value) CompareAndSwap(old, <span class="built_in">new</span> <span class="keyword">interface</span>{}) (swapped <span class="typename">bool</span>)</div></pre></td></tr></table></figure>

<p>Go 1.18ä¸­è™½ç„¶å®ç°äº†æ³›å‹ï¼Œä½†æ˜¯ä¸€äº›åº“çš„ä¿®æ”¹æœ‰å¯èƒ½åœ¨å°†æ¥çš„ç‰ˆæœ¬ä¸­å®ç°äº†ã€‚åœ¨æ³›å‹æ¨å‡ºæ¥ä¹‹åï¼Œatomicå¯¹ç±»å‹çš„æ”¯æŒä¼šæœ‰å¤§å¤§çš„åŠ å¼ºï¼Œæ‰€ä»¥å°†æ¥Valueè¿™ä¸ªç±»å‹æœ‰å¯èƒ½é€€å‡ºå†å²èˆå°ï¼Œå¾ˆå°‘è¢«ä½¿ç”¨äº†ã€‚(å‚è€ƒRuss Coxçš„æ–‡ç« <a href="https://research.swtch.com/gomm" target="_blank" rel="external">Updating the Go Memory Model</a>)</p>
<p>æ•´ä½“æ¥è¯´ï¼ŒGoçš„å¹¶å‘ç›¸å…³çš„åº“æ¯”è¾ƒç¨³å®šï¼Œå¹¶æ²¡æœ‰å¤§çš„å˜åŒ–ã€‚</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>å»å¹´çš„æ—¶å€™æˆ‘å†™äº†ä¸€ç¯‡<a href="https://colobu.com/2020/07/05/the-state-of-go-sync-2020/" target="_blank" rel="external">Goå¹¶å‘ç¼–ç¨‹ä¸€å¹´å›é¡¾</a>,å¦‚ä»Š2021å¹´ä¹Ÿå¿«ç»“æŸäº†ï¼ŒGo 1.18çš„ç‰¹æ€§å·²ç»å†»ç»“ï¼Œç¾å›½é¡µå¾ˆå¿«è¿›å…¥äº†å‡æœŸæ¨¡å¼ï¼Œè¶è¿™ä¸ªèŠ‚ç‚¹ï¼Œæˆ‘ä»¬å›é¡¾ä¸€ä¸‹è¿‘ä¸€å¹´Goå¹¶å‘ç¼–ç¨‹çš„è¿›å±•ã€‚</p>
]]>
    
    </summary>
    
      <category term="Go" scheme="https://colobu.com/categories/Go/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Goæ³›å‹ç³»åˆ—ï¼šå†ç®€åŒ–ï¼Œçœç•¥æ¥å£]]></title>
    <link href="https://colobu.com/2021/10/24/go-generic-eliding-interface/"/>
    <id>https://colobu.com/2021/10/24/go-generic-eliding-interface/</id>
    <published>2021-10-24T09:27:08.000Z</published>
    <updated>2021-10-28T04:19:25.403Z</updated>
    <content type="html"><![CDATA[<p>è¿™æ˜¯Goæ³›å‹ç³»åˆ—æ–‡ç« ã€‚</p>
<p>å…¶å®ƒGoæ³›å‹æ–‡ç« ï¼š</p>
<ul>
<li><a href="https://colobu.com/2021/08/30/how-is-go-generic-implemented/" target="_blank" rel="external">Goæ³›å‹æ˜¯æ€ä¹ˆå®ç°çš„?</a></li>
<li><a href="https://colobu.com/2021/03/22/try-go-generic/" target="_blank" rel="external">Go æ³›å‹å°é²œ</a></li>
</ul>
<a id="more"></a>
<p>å¦‚æœä½ ä¸€ç›´å…³æ³¨Goæ³›å‹çš„è®¾è®¡å’Œå®ç°ï¼Œä¸€å®šçŸ¥é“Goæ³›å‹ä»£ç å®ç°æ˜¯é€šè¿‡ç±»å‹å‚æ•°(type parameter)å®ç°çš„ï¼Œå½“è¿è¡Œæ³›å‹ä»£ç æ—¶ï¼Œç±»å‹å‚æ•°(type parameter)ç”±ç±»å‹å‚æ•°ï¼ˆtype argumentï¼‰æ›¿ä»£ã€‚(å¾ˆé—æ†¾parameterå’Œargumentéƒ½è¢«ç¿»è¯‘æˆäº†ä¸­æ–‡å‚æ•°)</p>
<p>ç±»å‹å‚æ•°(type parameter)ä¹Ÿæœ‰ç±»å‹ï¼Œä¹Ÿå°±æ˜¯æè¿°è¿™ä¸ªå‚æ•°ç±»å‹è¡Œä¸ºçš„å…ƒæ•°æ®ï¼Œè¢«æˆä¸ºçº¦æŸ(constraint)ã€‚æœ€é€šç”¨çš„çº¦æŸå°±æ˜¯å†…å»ºçš„<code>any</code>ç±»å‹ï¼Œå®ƒä»£è¡¨ä»»æ„çš„ç±»å‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> Print[T any](s []T) {</div><div class="line">	<span class="keyword">for</span> _, v := <span class="keyword">range</span> s {</div><div class="line">		fmt.Println(v)</div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure>

<p>åœ¨Goæ³›å‹è®¾è®¡ä¸­ï¼Œ çº¦æŸæ˜¯é€šè¿‡æ¥å£ç±»å‹æ¥å®ç°çš„(<code>interface</code>)ã€‚å› ä¸ºæ¥å£ç±»å‹å’Œçº¦æŸçš„åŠŸèƒ½é»‘ç±»ä¼¼ï¼Œå°±æ˜¯é™å®štype argumentå¿…é¡»å®ç°type parameterçš„çº¦æŸ(æ–¹æ³•é›†)ã€‚å½“ç„¶ï¼Œä¸ºäº†å®ç°æ³›å‹çš„åŠŸèƒ½ï¼Œé™¤äº†æ–¹æ³•é›†ä¹‹å¤–ï¼ŒGoè¿˜å¯¹ç”¨æ¥å½“åšçº¦æŸçš„æ¥å£åšäº†æ‰©å±•ï¼Œå®šä¹‰äº†ç±»å‹é›†(<code>type set</code>)çš„æ¦‚å¿µ,æ¯”å¦‚ä¸‹é¢æ˜¯çº¦æŸä»£è¡¨ä¸€ä¸ªtype argumentå¯ä»¥æ˜¯intã€int8ã€int16ã€int32æˆ–int64çš„ç±»å‹ï¼Œæ˜¯å¹¶(<code>union</code>)çš„å…³ç³»ï¼Œæ‰€ä»¥ä½¿ç”¨<code>|</code>ç¬¦å·ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Signed <span class="keyword">interface</span> {</div><div class="line">	<span class="typename">int</span> | <span class="typename">int8</span> | <span class="typename">int16</span> | <span class="typename">int32</span> | <span class="typename">int64</span></div><div class="line">}</div></pre></td></tr></table></figure>

<p>æ›´è¿›ä¸€æ­¥ï¼ŒGoè¿˜å®šä¹‰äº†<code>~</code>çš„ç¬¦å·ï¼Œä»£è¡¨åªè¦åº•å±‚ç±»å‹éƒ½æ˜¯æŸä¸ªç‰¹å®šç±»å‹å°±å¯ä»¥ï¼Œæ‰€ä»¥ä¸Šé¢çš„ä¾‹å­å¯ä»¥å†™çš„æ›´é€šç”¨ä¸€äº›:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Signed <span class="keyword">interface</span> {</div><div class="line">	~<span class="typename">int</span> | ~<span class="typename">int8</span> | ~<span class="typename">int16</span> | ~<span class="typename">int32</span> | ~<span class="typename">int64</span></div><div class="line">}</div></pre></td></tr></table></figure>

<p>è¿™æ ·<code>type MyInt int</code>å®šä¹‰çš„<code>MyInt</code>ç±»å‹çš„å®ä¾‹ä¹Ÿæ»¡è¶³è¿™ä¸ªçº¦æŸã€‚</p>
<h2 id="constraints_åŒ…">constraints åŒ…</h2>
<p>Goç›®å‰çš„å®ç°æ–°å¢åŠ ä¸€ä¸ªpackage,å«åš<code>constraints</code>,ç”¨æ¥å®šä¹‰å†…å»ºçš„çº¦æŸ,æ¯”å¦‚å¸¸è§çš„:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Signed <span class="keyword">interface</span> {</div><div class="line">	~<span class="typename">int</span> | ~<span class="typename">int8</span> | ~<span class="typename">int16</span> | ~<span class="typename">int32</span> | ~<span class="typename">int64</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">type</span> Unsigned <span class="keyword">interface</span> {</div><div class="line">	~<span class="typename">uint</span> | ~<span class="typename">uint8</span> | ~<span class="typename">uint16</span> | ~<span class="typename">uint32</span> | ~<span class="typename">uint64</span> | ~<span class="typename">uintptr</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">type</span> Integer <span class="keyword">interface</span> {</div><div class="line">	Signed | Unsigned</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">type</span> Float <span class="keyword">interface</span> {</div><div class="line">	~<span class="typename">float32</span> | ~<span class="typename">float64</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">type</span> Complex <span class="keyword">interface</span> {</div><div class="line">	~<span class="typename">complex64</span> | ~<span class="typename">complex128</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">type</span> Ordered <span class="keyword">interface</span> {</div><div class="line">	Integer | Float | ~<span class="typename">string</span></div><div class="line">}</div></pre></td></tr></table></figure>

<p>ç”šè‡³ Russ Coxã€Ian Lance Taylorä»–ä»¬ æè®®å’Œè®¨è®ºä¸º sliceã€mapã€chanå¢åŠ å¿…è¦çš„çº¦æŸï¼Œå› ä¸ºå®ƒä»¬å¤ªå¸¸ç”¨äº†ï¼Œæ ‡å‡†åº“ä¸­éƒ½å¯ä»¥ç”¨åˆ°ã€‚(<a href="https://github.com/golang/go/discussions/47203" target="_blank" rel="external">#47203</a>ã€<a href="https://github.com/golang/go/discussions/47319" target="_blank" rel="external">#47319</a>ã€<a href="https://github.com/golang/go/discussions/47330" target="_blank" rel="external">47330#</a>)ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Slice[Elem any] <span class="keyword">interface</span> {</div><div class="line">	~[]Elem</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">type</span> Map[Key comparable, Val any] <span class="keyword">interface</span> {</div><div class="line">	~<span class="keyword">map</span>[Key]Val</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">type</span> Chan[Elem any] <span class="keyword">interface</span> {</div><div class="line">	~<span class="keyword">chan</span> Elem</div><div class="line">}</div></pre></td></tr></table></figure>

<blockquote>
<p>Rob Pike æœ€è¿‘æ–°æäº¤äº†ä¸€ä¸ªissue,å»ºè®®åœ¨Go 1.18ä¸­ä¸è¦å¯¹æ ‡å‡†åº“å¢åŠ æ³›å‹çš„æ”¯æŒ<a href="https://github.com/golang/go/issues/48918" target="_blank" rel="external">#48918</a>ã€‚ç¦»Go 1.18å‘å¸ƒå°±å››ä¸ªæœˆäº†ï¼Œå¾ˆå¤šå®ç°è¿˜åœ¨æ‘¸ç´¢ä¹‹ä¸­ï¼Œè¿™æ˜¯å¤§å¸ˆç»™å‡ºçš„ä¸€ä¸ªå¾ˆä¸­è‚¯çš„å»ºè®®ï¼Œå»ºè®®ç›¸å…³çš„å“­çš„æ”¹åŠ¨å…ˆå¢åŠ åˆ°æ‰©å±•åº“ä¸­(<code>x/exp</code>),æˆç†Ÿåå†åŠ åˆ°æ ‡å‡†åº“ä¸­ï¼Œå¾—åˆ°äº†å¾ˆå¤šGopherçš„èµåŒã€‚è¿™æ˜¯å¦å¤–ä¸€ä¸ªè¯é¢˜äº†ã€‚</p>
</blockquote>
<p>åŒ…<code>constraints</code>å®šä¹‰å¸¸ç”¨çš„çº¦æŸå¯ä»¥å¾ˆå¥½çš„å¸®åŠ©æˆ‘ä»¬å¼€å‘ï¼Œä½†æ˜¯ä½ æœ‰æ²¡æœ‰æ„Ÿè§‰æœ‰ç‚¹å¼‚å¸¸ï¼Ÿ</p>
<h2 id="çœç•¥æ¥å£">çœç•¥æ¥å£</h2>
<p>æ˜¯çš„ï¼Œä¾ç…§Goæ³›å‹è§„èŒƒï¼Œæˆ‘ä»¬å¿…é¡»å®šä¹‰ä¸€ä¸ªçº¦æŸï¼Œç„¶åæ‰èƒ½åœ¨æ³›å‹ç±»å‹å’Œæ³›å‹æ–¹æ³•ä¸­ä½¿ç”¨ï¼Œå’Œå…¶å®ƒè¯­è¨€çš„æ³›å‹å®šä¹‰ç›¸æ¯”ï¼Œä½ æœ‰æ²¡æœ‰è§‰å¾—è¿™ä¸€ç‚¹æœ‰è„±è£¤å­æ”¾å±å¤šæ­¤ä¸€ä¸¾çš„å‘³é“ï¼Ÿ</p>
<p>ä½ çœ‹ä¸Šé¢çš„Sliceã€Mapã€Chançš„å®šä¹‰ï¼Œæ˜¯ä¸æ˜¯å¾ˆå†—ä½™ï¼Ÿä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸èƒ½ç›´æ¥åœ¨æ³›å‹ç±»å‹å’Œæ–¹æ³•çš„å®šä¹‰ä¸­ç›´æ¥ä½¿ç”¨<code>~[]Elem</code>ã€<code>~map[Key]Val</code>ã€<code>~chan Elem</code>å‘¢ï¼Ÿ</p>
<p>å› æ­¤fzippæè®®ï¼Œå¯¹äºä¸€ä¸ªéæ¥å£çš„ç±»å‹ï¼Œé»˜è®¤ç­‰ä»·ä¸ºä¸€ä¸ªçº¦æŸ<a href="https://github.com/golang/go/issues/48424" target="_blank" rel="external">#48424</a>ï¼Œä¸‹é¢çš„å…¬å¼å¾ˆå¥½çš„æè¿°äº†è¿™ä¸ªåŠŸèƒ½ï¼š</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[T nonInterfaceType] â‰¡ [T <span class="class"><span class="keyword">interface</span></span>{~nonInterfaceType}]</div></pre></td></tr></table></figure>

<p>åœ¨æ³›å‹çš„å®šä¹‰ä¸­ï¼Œéæ¥å£ç±»å‹<code>nonInterfaceType</code>ç­‰ä»·äºçº¦æŸ<code>interface{~nonInterfaceType}</code>, æ¯”å¦‚<code>~int</code>ç­‰ä»·äº<code>interface{~int}</code>ã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥çœç•¥<code>constraints</code>åŒ…äº†ã€‚ è¿™ä¸ªæè®®åŒ—æ¥æ”¶äº†ï¼Œè€Œä¸”ç›¸å…³åŠŸèƒ½ä¹ŸåŠ å…¥åˆ°äº†go masteråˆ†æ”¯ä¸­ã€‚</p>
<p>mattnçš„Goæ³›å‹ä¾‹å­ä¸­ï¼Œå°†ä¸€ä¸ªæ•´å½¢æ•°ç»„è½¬æ¢æˆä¸€ä¸ªchançš„<a href="https://github.com/mattn/go-generics-example/blob/main/constraints-chan/main.go" target="_blank" rel="external">ä¾‹å­</a>(æˆ‘ç¨å¾®æ”¹åŠ¨æˆæ›´åœ°é“çš„Goçš„å†™æ³•):</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"constraints"</span></div><div class="line">	<span class="string">"context"</span></div><div class="line">	<span class="string">"fmt"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">func</span> makeChan[T constraints.Chan[E], E any](ctx context.Context, arr []E) T {</div><div class="line">	ch := <span class="built_in">make</span>(T)</div><div class="line">	<span class="keyword">go</span> <span class="keyword">func</span>() {</div><div class="line">		<span class="keyword">defer</span> <span class="built_in">close</span>(ch)</div><div class="line">		<span class="keyword">for</span> _, v := <span class="keyword">range</span> arr {</div><div class="line">			<span class="keyword">select</span> {</div><div class="line">			<span class="keyword">case</span> &lt;-ctx.Done():</div><div class="line">				<span class="keyword">return</span></div><div class="line">			<span class="keyword">case</span> ch &lt;- v:</div><div class="line">			}</div><div class="line">			</div><div class="line">		}</div><div class="line">	}()</div><div class="line">	<span class="keyword">return</span> ch</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">func</span> main() {</div><div class="line">	<span class="keyword">for</span> v := <span class="keyword">range</span> makeChan(context.Background(), []<span class="typename">int</span><span class="number">{1</span>,<span class="number"> 2</span>,<span class="number"> 3</span>}) {</div><div class="line">		fmt.Println(v)</div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure>

<p>è¿™é‡Œä½¿ç”¨çš„æ˜¯<code>constraints.Chan[E]</code>ä»£è¡¨ä¸€ä¸ªæ³›å‹çš„channelï¼Œç°åœ¨å¯ä»¥ç”¨æ›´ç®€ä¾¿çš„æ–¹æ³•äº†:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"context"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">func</span> makeChan[T <span class="keyword">chan</span> E, E any](ctx context.Context, arr []E) T {</div><div class="line">	ch := <span class="built_in">make</span>(T)</div><div class="line">	<span class="keyword">go</span> <span class="keyword">func</span>() {</div><div class="line">		<span class="keyword">defer</span> <span class="built_in">close</span>(ch)</div><div class="line">		<span class="keyword">for</span> _, v := <span class="keyword">range</span> arr {</div><div class="line">			<span class="keyword">select</span> {</div><div class="line">			<span class="keyword">case</span> &lt;-ctx.Done():</div><div class="line">				<span class="keyword">return</span></div><div class="line">			<span class="keyword">case</span> ch &lt;- v:</div><div class="line">			}</div><div class="line">			</div><div class="line">		}</div><div class="line">	}()</div><div class="line">	<span class="keyword">return</span> ch</div><div class="line">}</div></pre></td></tr></table></figure>

<p>ç›´æ¥ä½¿ç”¨<code>chan E</code>å°±å¯ä»¥äº†ï¼Œæ–¹ä¸æ–¹ä¾¿ï¼Ÿ</p>
<p><code>chan E</code> éšå¼åœ°ä»£è¡¨<code>interface {chan E}</code>,ä½¿ç”¨èµ·æ¥æ›´ç®€æ·ï¼Œä¸éœ€è¦é¢å¤–çš„æ¥å£(çº¦æŸ)å®šä¹‰ã€‚</p>
<p>è™½ç„¶Go 1.18çš„ä¸´è¿‘ï¼Œæ„Ÿè§‰Goæ³›å‹çš„å¼€å‘å·¥ä½œè¶Šæ¥è¶Šé‡ï¼Œç”šè‡³æœ‰ä¸€äº›è¿˜ä¸æ˜ç¡®çš„åœ°æ–¹ï¼Œç¥ç¦ä¸€ä¸‹å§ï¼Œå¸Œæœ›å®ƒé¡ºé¡ºåˆ©åˆ©çš„æ¨å‡ºã€‚</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>è¿™æ˜¯Goæ³›å‹ç³»åˆ—æ–‡ç« ã€‚</p>
<p>å…¶å®ƒGoæ³›å‹æ–‡ç« ï¼š</p>
<ul>
<li><a href="https://colobu.com/2021/08/30/how-is-go-generic-implemented/" target="_blank" rel="external">Goæ³›å‹æ˜¯æ€ä¹ˆå®ç°çš„?</a></li>
<li><a href="https://colobu.com/2021/03/22/try-go-generic/" target="_blank" rel="external">Go æ³›å‹å°é²œ</a></li>
</ul>
]]>
    
    </summary>
    
      <category term="Go" scheme="https://colobu.com/categories/Go/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[[è¯‘]æ›´å¿«çš„æ—¶é—´è§£æ]]></title>
    <link href="https://colobu.com/2021/10/10/faster-time-parsing/"/>
    <id>https://colobu.com/2021/10/10/faster-time-parsing/</id>
    <published>2021-10-10T08:17:51.000Z</published>
    <updated>2021-10-24T09:19:04.610Z</updated>
    <content type="html"><![CDATA[<p>åŸæ–‡: <a href="https://philpearl.github.io/post/perf_time/" target="_blank" rel="external">Faster time parsing</a>ï¼Œ å¯ä»¥å­¦ä¹ ä¸€ä¸‹ä½œè€…ä¼˜åŒ–ç¨‹åºçš„æ–¹æ³•ã€‚</p>
<a id="more"></a>
<p><img src="time.jpg" alt=""></p>
<p>åœ¨<a href="https://www.ravelin.com/careers" target="_blank" rel="external">Ravelin</a>ï¼Œæˆ‘ä»¬å¤§é‡çš„æ•°æ®éƒ½æºå¸¦æ—¶é—´æˆ³(timestamp)ã€‚å¤§éƒ¨åˆ†æ—¶é—´æˆ³éƒ½ä»¥å­—ç¬¦ä¸²å½¢å¼å­˜å‚¨åœ¨BigQueryä¸­ï¼Œè€Œæˆ‘ä»¬çš„å¤§å¤šæ•°Goç»“æ„éƒ½ä½¿ç”¨Go time.Timeç±»å‹è¡¨ç¤ºæ—¶é—´ã€‚</p>
<p>å¾ˆé—æ†¾è¿™å°±æ˜¯æˆ‘ä»¬çš„ç°å®æƒ…å†µã€‚æˆ‘ä»¬çœŸçš„æœ‰å¾ˆå¤šå¾ˆå¤šæ•°æ®ï¼Œæ‰€ä»¥æˆ‘ä»¬çœŸçš„æœ‰å¾ˆå¤šå¾ˆå¤šæ—¶é—´æˆ³ã€‚ä¸€æ®µæ—¶é—´ä»¥æ¥ï¼Œæˆ‘æ€»ç»“å‡ºä¸€ä¸ªç»“è®ºï¼Œéšç€æ—¶é—´çš„æ¨ç§»ï¼Œæˆ‘ç¡®ä¿¡è¿™ä¸ªç»“è®ºæ˜¯æ­£ç¡®çš„ï¼š</p>
<blockquote>
<p><strong>Friends donâ€™t let friends represent time in databases as strings.</strong><br><strong>çœŸå¿ƒæ˜¯å“¥ä»¬çš„è¯å°±ä¸è¦åœ¨æ•°æ®åº“æŠŠæ—¶é—´è¡¨ç¤ºæˆå­—ç¬¦ä¸²ç±»å‹</strong></p>
</blockquote>
<p>ä¸ç®¡å’‹åœ°ï¼Œè‡ªå·±çš„è‹¦è¿˜å¾—è‡ªå·±å’½ä¸‹å»ï¼Œæ—¢ç„¶æˆ‘ä»¬å·²ç»è¿™ä¹ˆè®¾è®¡äº†ï¼Œæˆ‘ä»¬è¿˜å¾—åšæŒä¸‹å»ï¼Œä½†è¿™ä¸æ„å‘³ç€æˆ‘ä»¬ç ´ç½å­ç ´æ‘”äº†ï¼Œæˆ‘ä»¬å¯ä»¥å°½åŠ›è€Œä¸ºã€‚å¯¹äºæˆ‘æ¥è¯´ï¼Œç°åœ¨åšå¾—æœ€å¥½çš„æ–¹æ¡ˆå°±æ˜¯æ‰¾åˆ°ä¸€ç§æ¯”<a href="https://pkg.go.dev/time#Parse" target="_blank" rel="external">time.Parse</a>æ›´å¿«çš„æ–¹æ³•è§£æ <strong>RFC3339</strong> æ ¼å¼çš„æ—¶é—´æˆ³ã€‚<br> If we write a dedicated parsing routine that just parses RFC3339 it should be faster than that.</p>
<p>äº‹å®è¯æ˜è¿™å¾ˆå®¹æ˜“ã€‚<strong>time.Parse</strong>æœ‰ä¸¤ä¸ªå‚æ•°ï¼šä¸€ä¸ªæè¿°è¦è§£æçš„æ•°æ®æ ¼å¼(ç‰¹æ®Šå­—ç¬¦ä¸²)ï¼Œå¦ä¸€ä¸ªæ˜¯éœ€è¦è§£æçš„æ•°æ®å­—ç¬¦ä¸²ã€‚formatå‚æ•°ä¸åªæ˜¯é€‰æ‹©åˆé€‚çš„æ ¼å¼ã€‚formatå‚æ•°æè¿°åº”å¦‚ä½•è§£ææ•°æ®ã€‚<strong>time.Parse</strong>ä¸ä»…è§£ææ—¶é—´ï¼Œè¿˜å¿…é¡»è§£æã€ç†è§£å’Œå®ç°ä¸€ç§è§£ææ—¶é—´çš„æè¿°ã€‚å¦‚æœæˆ‘ä»¬ç¼–å†™ä¸€ä¸ªåªæ˜¯è§£æRFC3339çš„ä¸“ç”¨è§£æå‡½æ•°ï¼Œå®ƒåº”è¯¥ä¼šæ¯”<strong>time.Parse</strong>æ›´å¿«ã€‚</p>
<p>ä½†æ˜¯åœ¨åŠ¨æ‰‹ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆå†™ä¸€ä¸ªå¿«é€Ÿçš„åŸºå‡†æµ‹è¯•ï¼Œçœ‹çœ‹<strong>time.Parse</strong>æœ‰å¤šå¿«:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> BenchmarkParseRFC3339(b *testing.B) {</div><div class="line">	now := time.Now().UTC().Format(time.RFC3339Nano)</div><div class="line"></div><div class="line">	<span class="keyword">for</span> i :=<span class="number"> 0</span>; i &lt; b.N; i++ {</div><div class="line">		<span class="keyword">if</span> _, err := time.Parse(time.RFC3339, now); err != <span class="constant">nil</span> {</div><div class="line">			b.Fatal(err)</div><div class="line">		}</div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure>

<p>ä¸‹é¢æ•°æ®æ˜¯æµ‹è¯•çš„ç»“æœ:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="property">name</span>             <span class="property">time</span>/op</div><div class="line">ParseRFC3339-<span class="number">16</span>  <span class="number">150</span>ns Â± <span class="number">1</span>%</div></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥æˆ‘ä»¬å¼€å§‹å†™è‡ªå·±ä¸“ç”¨çš„ RFC3339 è§£æå‡½æ•°ã€‚å®ƒç´¢ç„¶æ— å‘³ï¼Œè€Œä¸”ä¹Ÿä¸æ¼‚äº®ï¼Œä½†æ˜¯è‡³å°‘å®ƒå¯ä»¥å·¥ä½œã€‚</p>
<p>(å®ƒçœŸçš„å¾ˆé•¿ä¸”ä¸æ¼‚äº®ï¼Œæ‰€ä»¥ä¸å…¶æŠŠå®ƒåŒ…å«åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œè®©å¤§å®¶æ»šåŠ¨è¿‡å»ï¼Œä¸å¦‚è¿™é‡Œæœ‰ä¸€ä¸ª<a href="https://github.com/philpearl/avro/blob/master/time/parse.go" target="_blank" rel="external">é“¾æ¥</a>ï¼ŒæŒ‡å‘æœ€ç»ˆç‰ˆæœ¬ï¼Œå¹¶åº”ç”¨ä¸‹é¢è®¨è®ºçš„æ‰€æœ‰ä¼˜åŒ–ã€‚å¦‚æœä½ æƒ³è±¡ä¸€ä¸ªå¾ˆé•¿çš„å‡½æ•°ï¼Œè°ƒç”¨<a href="https://pkg.go.dev/strconv#Atoi" target="_blank" rel="external">strconv.Atoi</a>çš„æ¬¡æ•°å¾ˆå¤šï¼Œä½ å°±ä¼šæ˜ç™½è¿™ä¸€ç‚¹)</p>
<p>æˆ‘ä»¬ä½¿ç”¨åŸºç¡€æµ‹è¯•ä»£ç æµ‹è¯•æ–°çš„è§£æå‡½æ•°ï¼Œæˆ‘ä»¬å¾—åˆ°ä¸‹é¢çš„ç»“æœï¼š</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">name             old <span class="built_in">time</span>/op  <span class="built_in">new</span> <span class="built_in">time</span>/op  delta</div><div class="line">ParseRFC3339-<span class="number">16</span>   <span class="number">150</span>ns Â± <span class="number">1</span>%    <span class="number">45</span>ns Â± <span class="number">4</span>%  -<span class="number">70.15</span>%  (p=<span class="number">0.000</span> n=<span class="number">7</span>+<span class="number">8</span>)</div></pre></td></tr></table></figure>

<p>ç›¸æ¯”è¾ƒè€Œè¨€ï¼Œæ–°çš„å‡½æ•°çœŸçš„å¾ˆå¿«ã€‚å®Œç¾ï¼Œç»“æŸã€‚</p>
<h2 id="ç­‰ç­‰ï¼Œ_è¿˜æœªç»“æŸ">ç­‰ç­‰ï¼Œ è¿˜æœªç»“æŸ</h2>
<p>å¦‚æœæˆ‘ä»¬é‡‡æ · <a href="https://hackernoon.com/go-the-complete-guide-to-profiling-your-code-h51r3waz" target="_blank" rel="external">CPU profile</a>,æˆ‘ä»¬è§‚å¯Ÿåˆ°å¾ˆå¤šæ—¶é—´éƒ½èŠ±è´¹åœ¨è°ƒç”¨<strong>strconv.Atoi</strong>ä¸Šã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&gt; go test -run ^$ -bench BenchmarkParseRFC3339 -cpuprofile cpu.prof </div><div class="line">&gt; go tool pprof cpu.prof</div><div class="line"><span class="keyword">Type</span>: cpu</div><div class="line"><span class="typename">Time</span>: Oct <span class="number">1</span>, <span class="number">2021</span> at <span class="number">7</span>:<span class="number">19</span>pm (BST)</div><div class="line">Duration: <span class="number">1.22</span>s, Total samples = <span class="number">960</span>ms (<span class="number">78.50</span>%)</div><div class="line">Entering interactive mode (<span class="keyword">type</span> <span class="string">"help"</span> <span class="keyword">for</span> commands, <span class="string">"o"</span> <span class="keyword">for</span> options)</div><div class="line">(pprof) top</div><div class="line">Showing nodes accounting <span class="keyword">for</span> <span class="number">950</span>ms, <span class="number">98.96</span>% <span class="keyword">of</span> <span class="number">960</span>ms total</div><div class="line">Showing top <span class="number">10</span> nodes <span class="keyword">out</span> <span class="keyword">of</span> <span class="number">24</span></div><div class="line">      flat  flat%   sum%        cum   cum%</div><div class="line">     <span class="number">380</span>ms <span class="number">39.58</span>% <span class="number">39.58</span>%      <span class="number">380</span>ms <span class="number">39.58</span>%  strconv.Atoi</div><div class="line">     <span class="number">370</span>ms <span class="number">38.54</span>% <span class="number">78.12</span>%      <span class="number">920</span>ms <span class="number">95.83</span>%  github.com/philpearl/blog/content/post.parseTime</div><div class="line">      <span class="number">60</span>ms  <span class="number">6.25</span>% <span class="number">84.38</span>%      <span class="number">170</span>ms <span class="number">17.71</span>%  <span class="typename">time</span>.Date</div></pre></td></tr></table></figure>

<p><strong>strconv.Atoi</strong>è½¬æ¢ASCIIå­—ç¬¦åˆ°æ•´æ•°ç±»å‹ã€‚è¿™æ˜¯Goæ ‡å‡†åº“çš„åŸºç¡€å®ç°ï¼Œæ‰€ä»¥å®ƒä¸€å®šæ˜¯ç»è¿‡äº†å¾ˆå¥½çš„ç¼–ç å’Œä¼˜åŒ–ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½ä¼˜åŒ–å®ƒå—ï¼Ÿ</p>
<p>æœªå¿…ï¼Œæˆ‘ä»¬çš„å¤§éƒ¨åˆ†æ•°å­—æ­£å¥½æœ‰2ä¸ªå­—èŠ‚é•¿ï¼Œæˆ–è€…æ­£å¥½æœ‰4ä¸ªå­—èŠ‚é•¿ã€‚æˆ‘ä»¬å¯ä»¥ç¼–å†™æ•°å­—è§£æå‡½æ•°ï¼Œé’ˆå¯¹æˆ‘ä»¬çš„ç‰¹æ®Šæƒ…å†µåšä¼˜åŒ–ï¼Œä¸éœ€è¦ä»»ä½•ä»¤äººè®¨åŒçš„æ…¢å¾ªç¯:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> atoi2(in <span class="typename">string</span>) (<span class="typename">int</span>, error) {</div><div class="line">	a, b := <span class="typename">int</span>(in<span class="number">[0</span>]-<span class="string">'0'</span>), <span class="typename">int</span>(in<span class="number">[1</span>]-<span class="string">'0'</span>)</div><div class="line">	<span class="keyword">if</span> a &lt;<span class="number"> 0</span> || a &gt;<span class="number"> 9</span> || b &lt;<span class="number"> 0</span> || b &gt;<span class="number"> 9</span> {</div><div class="line">		<span class="keyword">return</span><span class="number"> 0</span>, fmt.Errorf(<span class="string">"can't parse number %q"</span>, in)</div><div class="line">	}</div><div class="line">	<span class="keyword">return</span> a<span class="number">*10</span> + b, <span class="constant">nil</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">func</span> atoi4(in <span class="typename">string</span>) (<span class="typename">int</span>, error) {</div><div class="line">	a, b, c, d := <span class="typename">int</span>(in<span class="number">[0</span>]-<span class="string">'0'</span>), <span class="typename">int</span>(in<span class="number">[1</span>]-<span class="string">'0'</span>), <span class="typename">int</span>(in<span class="number">[2</span>]-<span class="string">'0'</span>), <span class="typename">int</span>(in<span class="number">[3</span>]-<span class="string">'0'</span>)</div><div class="line">	<span class="keyword">if</span> a &lt;<span class="number"> 0</span> || a &gt;<span class="number"> 9</span> || b &lt;<span class="number"> 0</span> || b &gt;<span class="number"> 9</span> || c &lt;<span class="number"> 0</span> || c &gt;<span class="number"> 9</span> || d &lt;<span class="number"> 0</span> || d &gt;<span class="number"> 9</span> {</div><div class="line">		<span class="keyword">return</span><span class="number"> 0</span>, fmt.Errorf(<span class="string">"can't parse number %q"</span>, in)</div><div class="line">	}</div><div class="line">	<span class="keyword">return</span> a<span class="number">*1000</span> + b<span class="number">*100</span> + c<span class="number">*10</span> + d, <span class="constant">nil</span></div><div class="line">}</div></pre></td></tr></table></figure>

<p>å¦‚æœå†è¿è¡Œæˆ‘ä»¬çš„åŸºå‡†æµ‹è¯•ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬åˆåšäº†ä¸€æ¬¡æ›´æ·±å…¥çš„æ€§èƒ½æå‡ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">name             old <span class="built_in">time</span>/op  <span class="built_in">new</span> <span class="built_in">time</span>/op  delta</div><div class="line">ParseRFC3339-<span class="number">16</span>  <span class="number">44.9</span>ns Â± <span class="number">4</span>%  <span class="number">39.7</span>ns Â± <span class="number">3</span>%  -<span class="number">11.51</span>%  (p=<span class="number">0.000</span> n=<span class="number">8</span>+<span class="number">8</span>)</div></pre></td></tr></table></figure>

<p>å¥½äº†ï¼Œæˆ‘ä»¬ç°åœ¨ä¸ä»…å†™äº†ä¸€ä¸ªå®šåˆ¶çš„æ—¶é—´è§£æå™¨ï¼Œè€Œä¸”è¿˜å®ç°äº†å®šåˆ¶çš„æ•°å­—è§£æå™¨ã€‚éå¸¸å®Œç¾ï¼Œç»“æŸã€‚</p>
<h2 id="ç­‰ç­‰ï¼Œ_å½“ç„¶è¿˜æœªç»“æŸ">ç­‰ç­‰ï¼Œ å½“ç„¶è¿˜æœªç»“æŸ</h2>
<p>å•Šå“ˆï¼Œè®©æˆ‘ä»¬åœ¨çœ‹ä¸€çœ¼ç°åœ¨çš„CPU profile, å¹¶ä¸”çœ‹ä¸€äº›æ±‡ç¼–ä»£ç ã€‚åœ¨<strong>atoi2</strong>ä¸­æœ‰ä¸¤ä¸ªsliceé•¿åº¦æ£€æŸ¥(ä¸‹é¢ç»¿è‰²çš„æ±‡ç¼–ä»£ç ,è°ƒç”¨panicIndexä¹‹å‰)ï¼Œä¸æ˜¯æœ‰ä¸€ä¸ª<a href="https://go101.org/article/bounds-check-elimination.html" target="_blank" rel="external">è¾¹ç•Œæ£€æŸ¥çš„æŠ€å·§</a>å—ï¼Ÿ</p>
<p><img src="lencheck.png" alt=""></p>
<p>ä»¥ä¸‹æ˜¯æ ¹æ®æ­¤æŠ€å·§è¿›è¡Œä¿®æ­£åçš„ä»£ç ã€‚å‡½æ•°å¼€å§‹å¤„çš„<strong>_ = in[1]</strong>ç»™äº†ç¼–è¯‘å™¨å……è¶³çš„æç¤ºï¼Œè¿™æ ·æˆ‘ä»¬åœ¨è°ƒç”¨å®ƒçš„æ—¶å€™ä¸ç”¨æ¯æ¬¡éƒ½æ£€æŸ¥æ˜¯å¦æº¢å‡ºäº†:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">func</span> atoi2(in <span class="typename">string</span>) (<span class="typename">int</span>, error) {</div><div class="line">	_ = in<span class="number">[1</span>] <span class="comment">// This helps the compiler reduce the number of times it checks `in` is long enough</span></div><div class="line">	a, b := <span class="typename">int</span>(in<span class="number">[0</span>]-<span class="string">'0'</span>), <span class="typename">int</span>(in<span class="number">[1</span>]-<span class="string">'0'</span>)</div><div class="line">	<span class="keyword">if</span> a &lt;<span class="number"> 0</span> || a &gt;<span class="number"> 9</span> || b &lt;<span class="number"> 0</span> || b &gt;<span class="number"> 9</span> {</div><div class="line">		<span class="keyword">return</span><span class="number"> 0</span>, fmt.Errorf(<span class="string">"can't parse number %q"</span>, in)</div><div class="line">	}</div><div class="line">	<span class="keyword">return</span> a<span class="number">*10</span> + b, <span class="constant">nil</span></div><div class="line">}</div></pre></td></tr></table></figure>

<p>è™½ç„¶æ˜¯ä¸€ç‚¹å°å°çš„æ”¹å˜ï¼Œä½†ä¹Ÿå¸¦æ¥æ˜æ˜¾çš„æ”¹å˜:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">name             old <span class="built_in">time</span>/op  <span class="built_in">new</span> <span class="built_in">time</span>/op  delta</div><div class="line">ParseRFC3339-<span class="number">16</span>  <span class="number">39.7</span>ns Â± <span class="number">3</span>%  <span class="number">38.4</span>ns Â± <span class="number">2</span>%  -<span class="number">3.26</span>%  (p=<span class="number">0.001</span> n=<span class="number">8</span>+<span class="number">7</span>)</div></pre></td></tr></table></figure>

<p><strong>atoi2</strong>éå¸¸çŸ­ã€‚ä¸ºä»€ä¹ˆå®ƒä¸è¢«å†…è”çš„ï¼Ÿå¦‚æœæˆ‘ä»¬ç®€åŒ–é”™è¯¯å¤„ç†ï¼Œæ˜¯ä¸æ˜¯æœ‰æ•ˆæœï¼Ÿå¦‚æœæˆ‘ä»¬åˆ é™¤å¯¹<strong>fmt.Errorf</strong>çš„è°ƒç”¨ï¼Œå¹¶å°†å…¶æ›¿æ¢ä¸ºä¸€ä¸ªç®€å•çš„é”™è¯¯ç±»å‹ï¼Œè¿™å°†é™ä½<strong>atoi2</strong>å‡½æ•°çš„å¤æ‚æ€§ã€‚è¿™å¯èƒ½è¶³ä»¥è®©Goç¼–è¯‘å™¨å†³å®šä¸ä½œä¸ºå•ç‹¬çš„ä»£ç å—è€Œæ˜¯ç›´æ¥åœ¨è°ƒç”¨å‡½æ•°ä¸­å†…è”è¿™ä¸ªå‡½æ•°ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> errNotNumber = errors.New(<span class="string">"not a valid number"</span>)</div><div class="line"></div><div class="line"><span class="keyword">func</span> atoi2(in <span class="typename">string</span>) (<span class="typename">int</span>, error) {</div><div class="line">	_ = in<span class="number">[1</span>]</div><div class="line">	a, b := <span class="typename">int</span>(in<span class="number">[0</span>]-<span class="string">'0'</span>), <span class="typename">int</span>(in<span class="number">[1</span>]-<span class="string">'0'</span>)</div><div class="line">	<span class="keyword">if</span> a &lt;<span class="number"> 0</span> || a &gt;<span class="number"> 9</span> || b &lt;<span class="number"> 0</span> || b &gt;<span class="number"> 9</span> {</div><div class="line">		<span class="keyword">return</span><span class="number"> 0</span>, errNotNumber</div><div class="line">	}</div><div class="line">	<span class="keyword">return</span> a<span class="number">*10</span> + b, <span class="constant">nil</span></div><div class="line">}</div></pre></td></tr></table></figure>

<p>è¿™æ˜¯æœ€ç»ˆçš„å½¢æ€ï¼ŒåŸºå‡†æµ‹è¯•ç»“æœæœ‰äº†æ˜¾è‘—çš„æå‡ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">name             old <span class="built_in">time</span>/op  <span class="built_in">new</span> <span class="built_in">time</span>/op  delta</div><div class="line">ParseRFC3339-<span class="number">16</span>  <span class="number">38.4</span>ns Â± <span class="number">2</span>%  <span class="number">32.9</span>ns Â± <span class="number">5</span>%  -<span class="number">14.39</span>%  (p=<span class="number">0.000</span> n=<span class="number">7</span>+<span class="number">8</span>)</div></pre></td></tr></table></figure>

<p>æˆ‘ä»¬çš„ä¼˜åŒ–æ•…äº‹çœŸçš„å°±æ­¤ç»“æŸäº†ã€‚ä¸ºäº†ä¼˜åŒ–120çº³ç§’çš„æ—¶é—´æˆ‘ä»¬åšäº†å¤§é‡çš„å·¥ä½œã€‚å¿…çœ‹120çº³ç§’å¾ˆå°ï¼ŒåŠ èµ·æ¥å´å¯¹ç¨‹åºæå‡ä¸å°‘ï¼Œè¿™äº›ä¼˜åŒ–å°†Ravelinçš„ä¸€äº›æœºå™¨å­¦ä¹ ç‰¹å¾æå–ç®¡é“ç»„ä»¶çš„è¿è¡Œæ—¶é—´å‡å°‘äº†ä¸€ä¸ªå°æ—¶ç”šè‡³æ›´å¤šã€‚å¦‚æˆ‘å‰é¢æ‰€è¯´ï¼Œæˆ‘ä»¬çœŸçš„æœ‰å¾ˆå¤šå¾ˆå¤šçš„æ•°æ®å’Œæ—¶é—´æˆ³ã€‚</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>åŸæ–‡: <a href="https://philpearl.github.io/post/perf_time/" target="_blank" rel="external">Faster time parsing</a>ï¼Œ å¯ä»¥å­¦ä¹ ä¸€ä¸‹ä½œè€…ä¼˜åŒ–ç¨‹åºçš„æ–¹æ³•ã€‚</p>
]]>
    
    </summary>
    
      <category term="Go" scheme="https://colobu.com/categories/Go/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[å¼ºåˆ¶æ›´æ”¹Goæ ‡å‡†åº“çš„å®ç°]]></title>
    <link href="https://colobu.com/2021/10/06/replace-implementations-in-go-std-libs-at-runtime/"/>
    <id>https://colobu.com/2021/10/06/replace-implementations-in-go-std-libs-at-runtime/</id>
    <published>2021-10-06T03:51:16.000Z</published>
    <updated>2021-10-06T05:16:58.923Z</updated>
    <content type="html"><![CDATA[<p>Goæ ‡å‡†åº“ä¸­æœ‰ä¸€äº›å•ä¾‹çš„å®ç°ï¼Œæ¯”å¦‚<code>log</code>åŒ…ä¸­é»˜è®¤çš„<code>Logger</code>ã€<code>net.DefaultResolver</code>, è¿™äº›å¯¹è±¡æä¾›äº†ä¾¿åˆ©çš„æ–¹æ³•ï¼Œä½†æ˜¯æœ‰çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦åšä¸€äº›å®šåˆ¶è¯çš„åŠŸèƒ½ï¼Œéœ€è¦æ›´æ”¹è¿™äº›å¯¹è±¡ï¼Œ<br>ç”šè‡³æœ‰çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦æ›´æ”¹æ ‡å‡†åº“çš„ç‰¹å®šæ–¹æ³•ï¼Œå¸¸è§„æ‰‹æ®µæ˜¯ä¸èµ·ä½œç”¨çš„, å¿…é¡»ä½¿ç”¨ä¸€äº›&quot;éª‡å®¢&quot;çš„æ–¹å¼ã€‚</p>
<p>å›½åº†åŒ—äº¬è¿ç»µç§‹é›¨ï¼Œæ•´å¥½æˆ‘çªåœ¨å®¶é‡Œï¼Œå®ç°äº†ä¸€ä¸ªåŸæœ¬æƒ³12æœˆä»½å®ç°çš„äº§å“ï¼Œåœ¨å¼€å‘é¡¹ç›®çš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿé‡åˆ°äº†ä¸€äº›éœ€è¦æ›´æ”¹æ ‡å‡†åº“é»˜è®¤è¡Œä¸ºçš„éœ€æ±‚ï¼Œæ‰€ä»¥åœ¨è¿™æ–¹é¢åšäº†ä¸€äº›æ¢ç´¢ï¼Œæ•´ç†å‡ºè¿™ç¯‡æ–‡ç« ï¼Œä»¥é£¨è¯»è€…ã€‚<br><a id="more"></a></p>
<p>å¦‚æœä½ æƒ³å®ç°è‡ªå·±çš„ä¸€ä¸ªæ—¥å¿—åº“(äº‹å®ä¸ŠGoç”Ÿæ€åœˆå·²ç»æœ‰å¾ˆå¤šå¾ˆå¤šçš„æ—¥å¿—åº“äº†)ï¼Œä½ å¯èƒ½æƒ³&quot;æ‹¦æˆª&quot;æ ‡å‡†åº“çš„é»˜è®¤çš„Log,è¿™æ ·ä½ çš„ä»£ç ï¼Œæˆ–è€…ç¬¬ä¸‰æ–¹ä»£ç ä¸­é€šè¿‡æ ‡å‡†åº“<code>log</code>è¾“å‡ºçš„æ—¥å¿—éƒ½èƒ½é€šè¿‡ä½ è‡ªå·±çš„æ—¥å¿—åº“è¾“å…¥å‡ºæ¥ã€‚</p>
<p>å…¶å®æ ‡å‡†åº“<code>log</code>é»˜è®¤çš„Loggeræ˜¯è¿™æ ·å®šä¹‰çš„: <code>var std = New(os.Stderr, &quot;&quot;, LstdFlags)</code>, stdå®ç°äº†ä¸€ä¸ªè¾“å‡ºåˆ°<code>os.Stderr</code>çš„<code>Logger</code>ã€‚Goæ ‡å‡†åº“ä¸­çš„Loggerä¸æ˜¯ä¸€ä¸ªæ¥å£ï¼Œæ‰€ä»¥æœ¬èº«ä½ å¯èƒ½è¿˜ä¸èƒ½åšå¤ªå¤šçš„å®šåˆ¶åŒ–çš„æ”¹é€ ï¼Œä½†æ˜¯è‡³å°‘ï¼Œä½ å¯ä»¥æ”¹å˜æ—¥å¿—è¾“å‡ºçš„ç›®çš„åœ°ï¼Œæ¯”å¦‚ä»æ ‡å‡†errè¾“å‡ºæ”¹åˆ°æ—¥å¿—æ–‡ä»¶ä¸­ã€‚è¿™é‡Œ<code>std</code>æ˜¯æœªè¾“å‡ºçš„å˜é‡ï¼Œä½†æ˜¯æ ‡å‡†åº“æä¾›äº†<code>func SetOutput(w io.Writer)</code>æ–¹æ³•ï¼Œç”¨æ¥æ›´æ”¹è¾“å‡ºç›®çš„åœ°ã€‚</p>
<p>è¿™æ ·çœ‹æ¥ï¼Œæ—¥å¿—åº“è¿˜å¥½ï¼Œè‡³å°‘è¿˜æš´éœ²äº†ä¸€ä¸ªæ›´æ”¹å®šåˆ¶åŒ–çš„æ–¹æ³•ï¼Œä½†æ˜¯æœ‰å¾ˆå¤šæƒ…å†µä¸‹ï¼Œæ ‡å‡†åº“å¹¶æ²¡æœ‰æä¾›å®šåˆ¶çš„æ–¹æ³•ï¼Œæˆ–è€…è¯´ä¸æ–¹ä¾¿å®šåˆ¶çš„æ–¹æ³•ã€‚</p>
<p>è¿™å‡ å¤©æˆ‘åœ¨å®ç°é¡¹ç›®çš„æ—¶å€™ï¼Œé‡åˆ°äº†ä¸€å°æœºå™¨æœ‰å¤šä¸ªIPçš„æƒ…å†µã€‚</p>
<p>ä¸€å°æœºå™¨é…ç½®äº†å¤šä¸ªIPå¹¶ä¸ç½•è§ï¼Œå½“ä½ åœ¨è¿™å°æœºå™¨è¿æ¥å…¶å®ƒçš„TCPæœåŠ¡å™¨æ—¶ï¼Œ æœ¬åœ°åˆ°åº•ä½¿ç”¨çš„æ˜¯å“ªä¸€ä¸ªIPåœ°å€å‘¢ï¼Ÿå¦‚<a href="https://serverfault.com/questions/12285/when-ip-aliasing-how-does-the-os-determine-which-ip-address-will-be-used-as-sour" target="_blank" rel="external">serverfault</a>æœ‰äººæå‡ºçš„é—®é¢˜ï¼Œåœ¨é»˜è®¤çš„æƒ…å†µä¸‹ï¼ŒLinuxä¼šä¾ç…§å­ç½‘çš„åˆ†ç±»ï¼Œé€‰æ‹©å’ŒæœåŠ¡å™¨åœ¨ç›¸åŒçš„å­ç½‘çš„æœ¬åœ°åœ°å€ï¼Œä½†æ˜¯å¦‚æœåŒä¸€ä¸ªå­ç½‘ä¸­é…ç½®äº†å¤šä¸ªIPåœ°å€ï¼Œé‚£ä¹ˆLinuxä¼šé€‰æ‹©æ­¤å­ç½‘çš„&quot;ä¸»&quot;IPåœ°å€ä½œä¸ºæœ¬åœ°Ipåœ°å€è¿æ¥æœåŠ¡å™¨ã€‚</p>
<p>åœ¨æˆ‘è¿™ä¸ªé¡¹ç›®ä¸­ï¼Œä¼šæœ‰å¾ˆå¤šçš„ç½‘ç»œè¿æ¥ï¼Œæ¯”å¦‚è¿æ¥mysqlï¼Œè¿æ¥clickhouse,è¿æ¥ç¬¬ä¸‰æ–¹çš„HTTP APIæœåŠ¡ï¼Œè¿æ¥Kafkaã€è¿æ¥ Redisç­‰ã€‚ä¸å¹¸çš„äº‹ï¼Œå½“ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“æ¯”å¦‚go-sql-driver/mysqlã€go-redisæ—¶ï¼ŒLinuxæ‰€é€‰æ‹©çš„æœ¬åœ°IPåœ°å€å¹¶ä¸æ˜¯æˆ‘æœŸæœ›çš„æœ¬åœ°IPåœ°å€ï¼Œå¯¼è‡´æƒé™éªŒè¯å¤±è´¥æ— æ³•è¿æ¥ã€‚</p>
<p>æœ¬è´¨ä¸Šï¼Œæ— è®ºæ˜¯<code>go-sql-driver/mysql</code>æˆ–è€…<code>go-redis</code>,éƒ½æ˜¯åŸºäº<code>net.Dial</code>æˆ–è€…<code>net.DialContext</code>å»ºç«‹çš„TCPè¿æ¥ã€‚<code>go-sql-driver/mysql</code> æä¾›äº† <code>RegisterDialContext</code>ç”¨äºå®šåˆ¶åŒ–<code>Dial</code>,<code>go-redis</code>æä¾›äº†<code>Dialer</code>å­—æ®µç”¨æ¥å®šåˆ¶ï¼Œä½ å¦‚æœæƒ³æŒ‡å®šæœ¬åœ°çš„IPåœ°å€ï¼Œå¯ä»¥é€šè¿‡å®šåˆ¶çš„<code>net.Dialer</code>æ¥å®ç°ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">   localAddrDialier := &net.Dialer{</div><div class="line">	LocalAddr: localAddr,</div><div class="line">}</div></pre></td></tr></table></figure>

<p>è¿™æ˜¯ä¸€ä¸ªä¸é”™çš„ã€ä¼ ç»Ÿçš„æ–¹æ³•ï¼Œå”¯ä¸€ä¸çˆ½çš„æ˜¯ï¼Œæ¯ç§ç±»å‹æˆ‘éƒ½éœ€è¦è¿›è¡Œåœ°å€ï¼Œè®¿é—®mysqlã€è®¿é—®redisã€è®¿é—®kafkaã€è®¿é—®ç¬¬ä¸‰æ–¹åº“ã€è®¿é—®æœåŠ¡å™¨......, æœ‰æ²¡æœ‰ä¸€åŠ³æ°¸é€¸çš„æ–¹æ³•å‘¢ï¼Ÿ</p>
<p>æœ‰!</p>
<p><a href="https://github.com/bouk/monkey" target="_blank" rel="external">bouk/monkey</a>æ˜¯ä¸€ä¸ªç›¸å½“ç›¸å½“&quot;éª‡å®¢&quot;çš„æŠ€æœ¯ï¼Œå½“è¿‡è¿è¡Œæ—¶åŠ¨æ€å°†æ–¹æ³•çš„å®ç°æ›¿æ¢æˆ<code>JMP æ–°çš„å‡½æ•°</code>, æ¥å®ç°åœ¨è¿è¡Œæ—¶æ›¿æ¢æ–¹æ³•ã€‚ç»å¸¸æˆ‘ä»¬ä¼šåœ¨å•å…ƒæµ‹è¯•çš„æ—¶å€™ç”¨æ¥&quot;Mock&quot;ä¸€äº›æ–¹æ³•ï¼Œéå¸¸çš„æœ‰æ•ˆï¼Œè¿™ä¸€æ¬¡ï¼Œæˆ‘è¦å°è¯•ä½¿ç”¨å®ƒæ›¿æ¢æ‰€æœ‰çš„<code>net.Dialer.Dial</code>æˆ–è€…<code>net.Dialer.DialContext</code>æ–¹æ³•ï¼Œæ¥å®ç°å¼ºåˆ¶æŒ‡å®šæœ¬åœ°åœ°å€ã€‚</p>
<p>å½“ç„¶ï¼ŒagiledragonåŸºäºå®ƒçš„åŸç†å®ç°äº†<a href="https://github.com/agiledragon/gomonkey" target="_blank" rel="external">agiledragon/gomonkey</a>ä»¥æ–¹ä¾¿è°ƒç”¨ï¼Œä¸è¿‡ç›®å‰ä¸æ”¯æŒä¸´æ—¶æ¢å¤åŸå‡½æ•°ã€‚æ›¹æ˜¥æ™–åŸºäºå®ƒå®ç°äº†<a href="https://github.com/cch123/supermonkey" target="_blank" rel="external">cch123/supermonkey</a>,é€šè¿‡è§£æç¬¦å·è¡¨å¾—åˆ°å‡½æ•°æŒ‡é’ˆï¼Œå¯ä»¥æ›¿æ¢æœªè¾“å‡ºçš„å‡½æ•°ï¼Œå¯ä»¥è¯´åŠŸèƒ½æ›´å¼ºå¤§äº†ã€‚æœ¬æ–‡ä¸­è¿˜æ˜¯ä½¿ç”¨åŸå§‹çš„bouk/monkey,å› ä¸ºå¯¹äºæˆ‘æ¥è¯´ï¼ŒåŠŸèƒ½è¶³å¤Ÿäº†ã€‚</p>
<blockquote>
<p>ä¸è¦ä½¿ç”¨<a href="https://github.com/bouk/monkey" target="_blank" rel="external">bouk/monkey</a>åšæ¶ã€‚</p>
</blockquote>
<p>å¯ä»¥ä½¿ç”¨<a href="https://github.com/bouk/monkey" target="_blank" rel="external">bouk/monkey</a>æ›¿æ¢æ ‡å‡†åº“çš„<code>net.Dialer.Dial</code>æˆ–è€…<code>net.Dialer.DialContext</code>å‡½æ•°ï¼Œåœ¨å»ºç«‹TCPè¿æ¥çš„æ—¶å€™ï¼Œä½¿ç”¨æœ¬åœ°IPåœ°å€ã€‚è¿™æ ·ï¼Œæ— è®ºæ˜¯mysqlçš„åº“ã€è¿˜æ˜¯redisçš„åº“ï¼Œæˆ–è€…å…¶å®ƒçš„ç¬¬ä¸‰æ–¹åº“ï¼Œåªè¦åŸºäº<code>net.Dialer.Dial</code>æˆ–è€…<code>net.Dialer.DialContext</code>å‡½æ•°ï¼Œå°±ä¼šä½¿ç”¨æˆ‘ä»¬æ›¿æ¢çš„æ–¹æ³•ã€‚</p>
<p>ç›¸å…³ä»£ç ä¹Ÿéå¸¸ç®€å•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œæ³¨é‡Šå·²ç»åŠ åˆ°ä»£ç ä¸­:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">   <span class="comment">// æŒ‡å®šè¦ä½¿ç”¨çš„æœ¬åœ°åœ°å€. // by https://colobu.com</span></div><div class="line">   localAddr := &net.TCPAddr{</div><div class="line">	IP:   net.ParseIP(localIP),</div><div class="line">	Port:<span class="number"> 0</span>,</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">var</span> d *net.Dialer</div><div class="line"></div><div class="line">   <span class="comment">// æ›¿æ¢Dialer.DialContextæ–¹æ³•</span></div><div class="line">dialContextGuard = monkey.PatchInstanceMethod(reflect.TypeOf(d), <span class="string">"DialContext"</span>, <span class="keyword">func</span>(d *net.Dialer, ctx context.Context, network, address <span class="typename">string</span>) (net.Conn, error) {</div><div class="line">       <span class="comment">// ä¸´æ—¶æ¢å¤</span></div><div class="line">	dialContextGuard.Unpatch()</div><div class="line">	<span class="keyword">defer</span> dialContextGuard.Restore()</div><div class="line"></div><div class="line">	<span class="keyword">if</span> network == <span class="string">"tcp"</span> || network == <span class="string">"tcp4"</span> || network == <span class="string">"tcp6"</span> {</div><div class="line">		localAddrDialier := &net.Dialer{</div><div class="line">			LocalAddr: localAddr,</div><div class="line">		}</div><div class="line"></div><div class="line">           <span class="comment">// ä½¿ç”¨æŒ‡å®šæœ¬åœ°åœ°å€çš„dialer</span></div><div class="line">		<span class="keyword">return</span> localAddrDialier.DialContext(ctx, network, address)</div><div class="line">	}</div><div class="line"></div><div class="line">       <span class="comment">// å…¶å®ƒæƒ…å†µï¼Œæ¯”å¦‚UDPã€UnixDomainç­‰ï¼Œä½¿ç”¨æ ‡å‡†åº“çš„æ–¹æ³•</span></div><div class="line">	<span class="keyword">return</span> d.DialContext(ctx, network, address)</div><div class="line">})</div><div class="line"></div><div class="line">   <span class="comment">// æ›¿æ¢Dailæ–¹æ³•</span></div><div class="line">dialGuard = monkey.PatchInstanceMethod(reflect.TypeOf(d), <span class="string">"Dial"</span>, <span class="keyword">func</span>(d *net.Dialer, network, address <span class="typename">string</span>) (net.Conn, error) {</div><div class="line">       <span class="comment">// ä¸´æ—¶æ¢å¤</span></div><div class="line">	dialGuard.Unpatch()</div><div class="line">	<span class="keyword">defer</span> dialGuard.Restore()</div><div class="line"></div><div class="line">	<span class="keyword">if</span> network == <span class="string">"tcp"</span> || network == <span class="string">"tcp4"</span> || network == <span class="string">"tcp6"</span> {</div><div class="line">		localAddrDialier := &net.Dialer{</div><div class="line">			LocalAddr: localAddr,</div><div class="line">		}</div><div class="line"></div><div class="line">           <span class="comment">// ä½¿ç”¨æŒ‡å®šæœ¬åœ°åœ°å€çš„dialer</span></div><div class="line">		<span class="keyword">return</span> localAddrDialier.Dial(network, address)</div><div class="line">	}</div><div class="line"></div><div class="line">       <span class="comment">// å…¶å®ƒæƒ…å†µï¼Œæ¯”å¦‚UDPã€UnixDomainç­‰ï¼Œä½¿ç”¨æ ‡å‡†åº“çš„æ–¹æ³•</span></div><div class="line">	<span class="keyword">return</span> d.Dial(network, address)</div><div class="line">})</div></pre></td></tr></table></figure>

<p>æ›¿æ¢äº†è¿™ä¸¤ä¸ªæ–¹æ³•åï¼Œä¹‹åå³ä½¿æ–°å»ºç«‹<code>net.Dailer</code>å¯¹è±¡ï¼Œä¹Ÿæ˜¯ä½¿ç”¨æ›¿æ¢åçš„æ–¹æ³•æ‰§è¡Œã€‚</p>
<blockquote>
<p>è¿™é‡Œå¹¶æ²¡æœ‰è€ƒè™‘å¹¶å‘å®šä½æƒ…å†µï¼Œå¦‚æœä½ çš„ç¨‹åºæœ‰å¹¶å‘çš„è°ƒç”¨Dialæˆ–è€…DialContext,ä½ éœ€è¦åŠ é”ã€‚</p>
</blockquote>
<p>è¿™æ ·ï¼Œæˆ‘ä»¬å°±ä¸€åŠ³æ°¸é€¸çš„è§£å†³äº†æŒ‡å®šæœ¬åœ°IPåœ°å€åˆ›å»ºTCPè¿æ¥çš„é—®é¢˜ï¼Œæ— éœ€æ”¹åŠ¨æ ‡å‡†åº“çš„ä»£ç ï¼Œæ— éœ€é€ä¸ªå®šåˆ¶Dialæ–¹æ³•ã€‚</p>
<p>åŒæ ·çš„ï¼Œä½ å¯ä»¥æ›´æ”¹æ ‡å‡†åº“çš„<code>net.DefaultResolver</code>, è¿™æ˜¯æ ‡å‡†åº“ç”¨æ¥è¿›è¡ŒåŸŸåè§£æçš„å®ç°ï¼Œæ”¯æŒGoè‡ªå·±çš„è§£æå®ç°å’ŒCGOæ–¹å¼æŸ¥è¯¢ã€‚æœ¬èº«å®ƒæ˜¯ä¸€ä¸ªstruct,è€Œä¸æ˜¯ä¸€ä¸ªæ¥å£ï¼Œæ‰€ä»¥è™½ç„¶å®ƒæ˜¯ä¸€ä¸ªå•ä¾‹çš„å¯¹è±¡ï¼Œä½†æ˜¯é€šå¸¸æƒ…å†µä¸‹ä½ ä¹Ÿæ²¡æœ‰å¤šå°‘å®šåˆ¶åŒ–çš„å¯èƒ½ã€‚æ¯”å¦‚åœ¨è°ƒç”¨<code>LookupIP</code>æ–¹æ³•æ—¶,ä½ æƒ³ä½¿ç”¨è‡ªå·±çš„ä¸€ä¸ªåè®®è¿”å›IPåˆ—è¡¨ï¼Œè€Œä¸æ˜¯æŸ¥è¯¢æœ¬åœ°æ–‡ä»¶æˆ–è€…DNSæœåŠ¡å™¨ï¼Œä½ åŸºæœ¬æ˜¯æ²¡æœ‰åŠæ³•çš„ã€‚ä½†æ˜¯é€šè¿‡bouk/monkeyï¼Œä½ å¯ä»¥æ›´æ”¹<code>LookupIP</code>æ–¹æ³•ï¼Œè¿™æ ·ä½ å°±å¯ä»¥å®šåˆ¶äº†ã€‚</p>
<p>æ‰€ä»¥ï¼Œbouk/monkeyä¸ä»…ä»…å¯ä»¥ç”¨æ¥åœ¨å•å…ƒæµ‹è¯•ä¸­mockå¯¹è±¡å’Œæ–¹æ³•ï¼Œè¿˜å¯ä»¥åœ¨åº”ç”¨è¿è¡Œä¸­æ›¿æ¢ä¸€äº›å¸¸è§„æ²¡æœ‰åŠæ³•æ›´æ”¹çš„å‡½æ•°ã€‚</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>Goæ ‡å‡†åº“ä¸­æœ‰ä¸€äº›å•ä¾‹çš„å®ç°ï¼Œæ¯”å¦‚<code>log</code>åŒ…ä¸­é»˜è®¤çš„<code>Logger</code>ã€<code>net.DefaultResolver</code>, è¿™äº›å¯¹è±¡æä¾›äº†ä¾¿åˆ©çš„æ–¹æ³•ï¼Œä½†æ˜¯æœ‰çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦åšä¸€äº›å®šåˆ¶è¯çš„åŠŸèƒ½ï¼Œéœ€è¦æ›´æ”¹è¿™äº›å¯¹è±¡ï¼Œ<br>ç”šè‡³æœ‰çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦æ›´æ”¹æ ‡å‡†åº“çš„ç‰¹å®šæ–¹æ³•ï¼Œå¸¸è§„æ‰‹æ®µæ˜¯ä¸èµ·ä½œç”¨çš„, å¿…é¡»ä½¿ç”¨ä¸€äº›&quot;éª‡å®¢&quot;çš„æ–¹å¼ã€‚</p>
<p>å›½åº†åŒ—äº¬è¿ç»µç§‹é›¨ï¼Œæ•´å¥½æˆ‘çªåœ¨å®¶é‡Œï¼Œå®ç°äº†ä¸€ä¸ªåŸæœ¬æƒ³12æœˆä»½å®ç°çš„äº§å“ï¼Œåœ¨å¼€å‘é¡¹ç›®çš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿé‡åˆ°äº†ä¸€äº›éœ€è¦æ›´æ”¹æ ‡å‡†åº“é»˜è®¤è¡Œä¸ºçš„éœ€æ±‚ï¼Œæ‰€ä»¥åœ¨è¿™æ–¹é¢åšäº†ä¸€äº›æ¢ç´¢ï¼Œæ•´ç†å‡ºè¿™ç¯‡æ–‡ç« ï¼Œä»¥é£¨è¯»è€…ã€‚<br>]]>
    
    </summary>
    
      <category term="Go" scheme="https://colobu.com/tags/Go/"/>
    
      <category term="Go" scheme="https://colobu.com/categories/Go/"/>
    
  </entry>
  
</feed>
