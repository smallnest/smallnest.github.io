<!DOCTYPE html><html><head><meta charset="utf-8"><title>ZooKeeper程序员指南</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="翻译于最新的ZooKeeper 3.4 文档。
前言
本文档是为那些希望利用ZooKeeper的协调服务建立分布式应用程序的开发人员而写的指南。它包含了Zookeeper的概念和实践内容。指南的前四节介绍了ZooKeeper各种概念的高层次的讨论。 对于理解ZooKeeper如何工作和如何使用它这些概念都是必须了解的。尽管不包含代码，但还是假定你熟悉分布式计算相关的问题。第一组的章节包括：

Zo"><meta property="og:type" content="article"><meta property="og:title" content="ZooKeeper程序员指南"><meta property="og:url" content="https://colobu.com/2014/09/28/ZooKeeper-Programmers-Guide/"><meta property="og:site_name" content="鸟窝"><meta property="og:description" content="翻译于最新的ZooKeeper 3.4 文档。
前言
本文档是为那些希望利用ZooKeeper的协调服务建立分布式应用程序的开发人员而写的指南。它包含了Zookeeper的概念和实践内容。指南的前四节介绍了ZooKeeper各种概念的高层次的讨论。 对于理解ZooKeeper如何工作和如何使用它这些概念都是必须了解的。尽管不包含代码，但还是假定你熟悉分布式计算相关的问题。第一组的章节包括：

Zo"><meta property="og:image" content="http://zookeeper.apache.org/doc/trunk/images/state_dia.jpg"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="ZooKeeper程序员指南"><meta name="twitter:description" content="翻译于最新的ZooKeeper 3.4 文档。
前言
本文档是为那些希望利用ZooKeeper的协调服务建立分布式应用程序的开发人员而写的指南。它包含了Zookeeper的概念和实践内容。指南的前四节介绍了ZooKeeper各种概念的高层次的讨论。 对于理解ZooKeeper如何工作和如何使用它这些概念都是必须了解的。尽管不包含代码，但还是假定你熟悉分布式计算相关的问题。第一组的章节包括：

Zo"><link rel="alternative" href="/atom.xml" title="鸟窝" type="application/atom+xml"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/style.css" type="text/css"><link href="//cdn.staticfile.org/font-awesome/4.2.0/css/font-awesome.css" rel="stylesheet"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.7/css/jquery.fancybox.min.css" media="screen" type="text/css"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" media="screen" type="text/css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/tonsky/FiraCode@1.207/distr/fira_code.css"></head><body><div id="container"><div id="wrap"><header id="header"><div id="banner"></div><div id="header-outer" class="outer"><div id="header-title" class="inner"><h1 id="logo-wrap" class="animated bounceInLeft"><a href="/" id="logo">鸟窝</a></h1><h2 id="subtitle-wrap" class="animated bounceInLeft"><a href="/" id="subtitle">大道至简 Simplicity is the ultimate form of sophistication</a></h2></div><div id="header-inner" class="inner"><nav id="main-nav"><a id="main-nav-toggle" class="nav-icon"></a> <a class="main-nav-link" href="/"><i class="fa fa-home">&nbsp;</i>首页</a> <a class="main-nav-link" href="/archives"><i class="fa fa-folder-o">&nbsp;</i>归档</a> <a class="main-nav-link" href="https://github.com/smallnest"><i class="fa fa-github">&nbsp;</i>github</a><div class="dropdown main-nav-link"><a class="main-nav-link" href="#"><i class="fa fa-bars">&nbsp;</i>网站群</a><div class="dropdown-content"><a href="/goasm"><i class="fa fa-language"></i>&nbsp;Go汇编示例</a> <a href="https://gowebexamples.com"><i class="fa fa-external-link"></i>&nbsp;Go Web开发示例</a> <a href="http://go-database-sql.org"><i class="fa fa-external-link"></i>&nbsp;Go 数据库开发教程</a><hr><a href="http://rpcx.io"><i class="fa undefined"></i>&nbsp;RPCX官网</a> <a href="http://cn.doc.rpcx.io"><i class="fa undefined"></i>&nbsp;RPC开发指南</a></div></div><a class="main-nav-link" href="/ScalaCollectionsCookbook"><i class="fa fa-book">&nbsp;</i>Scala集合技术手册</a> <a class="main-nav-link" href="/about"><i class="fa fa-lemon-o">&nbsp;</i>关于</a></nav><nav id="sub-nav"><a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a> <a id="nav-search-btn" class="nav-icon" title="Search"></a></nav><div id="search-form-wrap"><form action="http://www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form"><input type="search" name="word" maxlength="20" class="search-form-input" placeholder="Search"> <input type="submit" class="search-form-submit"> <input name="tn" type="hidden" value="bds"> <input name="cl" type="hidden" value="3"> <input name="ct" type="hidden" value="2097152"> <input type="hidden" name="si" value="colobu.com"></form></div></div></div></header><div class="outer"><section id="main"><article id="post-ZooKeeper-Programmers-Guide" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-meta"><a href="/2014/09/28/ZooKeeper-Programmers-Guide/" class="article-date"><time datetime="2014-09-28T02:06:08.000Z" itemprop="datePublished">2014年09月28日</time></a><div class="article-category"><a class="article-category-link" href="/categories/大数据/">大数据</a></div><div class="article-author">by smallnest</div></div><div class="article-inner"><header class="article-header"><h1 class="article-title" itemprop="name">ZooKeeper程序员指南</h1></header><div class="article-entry" itemprop="articleBody"><h1 id="expanderHead" style="cursor:pointer">目录 <span id="expanderSign">[−]</span></h1><div id="article-entry-toc" data-role="collapsible" class="article-entry-toc"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#前言"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ZooKeeper数据模型：_The_ZooKeeper_Data_Model"><span class="toc-text">ZooKeeper数据模型： The ZooKeeper Data Model</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ZNode节点"><span class="toc-text">ZNode节点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#监视Watches"><span class="toc-text">监视Watches</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#数据访问Data_Access"><span class="toc-text">数据访问Data Access</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#临时节点Ephemeral_Nodes"><span class="toc-text">临时节点Ephemeral Nodes</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#顺序节点Sequence_Nodes_-_Unique_Naming"><span class="toc-text">顺序节点Sequence Nodes -- Unique Naming</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ZooKeeper中的时间"><span class="toc-text">ZooKeeper中的时间</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ZooKeeper_Stat数据结构"><span class="toc-text">ZooKeeper Stat数据结构</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ZooKeeper会话"><span class="toc-text">ZooKeeper会话</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ZooKeeper_Watches"><span class="toc-text">ZooKeeper Watches</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Remove_Watches"><span class="toc-text">Remove Watches</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#What_ZooKeeper_Guarantees_about_Watches"><span class="toc-text">What ZooKeeper Guarantees about Watches</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Things_to_Remember_about_Watches"><span class="toc-text">Things to Remember about Watches</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ZooKeeper_access_control_using_ACLs"><span class="toc-text">ZooKeeper access control using ACLs</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ACL_Permissions"><span class="toc-text">ACL Permissions</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Builtin_ACL_Schemes"><span class="toc-text">Builtin ACL Schemes</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ZooKeeper_C_client_API"><span class="toc-text">ZooKeeper C client API</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#可插拔的ZooKeeper身份验证"><span class="toc-text">可插拔的ZooKeeper身份验证</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#一致性保证_Consistency_Guarantees"><span class="toc-text">一致性保证 Consistency Guarantees</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#绑定Binding"><span class="toc-text">绑定Binding</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Java_Binding"><span class="toc-text">Java Binding</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#C_Binding"><span class="toc-text">C Binding</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Installation"><span class="toc-text">Installation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Using_the_C_Client"><span class="toc-text">Using the C Client</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Building_Blocks:_A_Guide_to_ZooKeeper_Operations"><span class="toc-text">Building Blocks: A Guide to ZooKeeper Operations</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Handling_Errors"><span class="toc-text">Handling Errors</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Read_Operations"><span class="toc-text">Read Operations</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Write_Operations"><span class="toc-text">Write Operations</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Handling_Watches"><span class="toc-text">Handling Watches</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Miscelleaneous_ZooKeeper_Operations"><span class="toc-text">Miscelleaneous ZooKeeper Operations</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Program_Structure,_with_Simple_Example"><span class="toc-text">Program Structure, with Simple Example</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Gotchas:_Common_Problems_and_Troubleshooting"><span class="toc-text">Gotchas: Common Problems and Troubleshooting</span></a></li></ol></div><script>function show_answer(e,l){"显示答案"===e.value?e.value="隐藏答案":e.value="显示答案";var n=document.getElementById(l);"none"===n.style.display?n.style.display="block":n.style.display="none"}</script><p>翻译于最新的<a href="http://zookeeper.apache.org/doc/trunk/zookeeperProgrammers.html" target="_blank" rel="external">ZooKeeper 3.4 文档</a>。</p><h1 id="前言">前言</h1><p>本文档是为那些希望利用ZooKeeper的协调服务建立分布式应用程序的开发人员而写的指南。它包含了Zookeeper的概念和实践内容。<br>指南的前四节介绍了ZooKeeper各种概念的高层次的讨论。 对于理解ZooKeeper如何工作和如何使用它这些概念都是必须了解的。尽管不包含代码，但还是假定你熟悉分布式计算相关的问题。<br>第一组的章节包括：</p><ul><li>ZooKeeper数据模型： The ZooKeeper Data Model</li><li>ZooKeeper的会话： ZooKeeper Sessions</li><li>ZooKeeper的监视： ZooKeeper Watches</li><li>一致性保证：Consistency Guarantees<br><em>(下面的翻译中概念尽量不翻译成中文，因为英文更能直观的反映其概念)</em></li></ul><p>接下来的四个章节提供了编程实践信息，它们是:</p><ul><li>Building Blocks: A Guide to ZooKeeper Operations</li><li>Bindings</li><li>Program Structure, with Simple Example [tbd]</li><li>Gotchas: Common Problems and Troubleshooting</li></ul><p>附录中的链接是其它的有用的,和ZooKeeper相关的信息.<br>书中的章节都可以独立阅读，然而在开发你的第一个ZooKeeper程序之前， 你最好先阅读一下ZooKeeper数据模型和ZooKeeper基本操作。Simple Programmming Example对于理解ZooKeeper客户端程序的基本结构也很有帮助.<br><a id="more"></a></p><h1 id="ZooKeeper数据模型：_The_ZooKeeper_Data_Model">ZooKeeper数据模型： The ZooKeeper Data Model</h1><p>ZooKeeper包含一个分层次的命名空间，很像分布式的文件系统. 唯一的不同是除了包含子节点外命名空间的每个节点还可以关联数据. 就像一个扩展的文件系统一样， 文件也可以是目录. 节点的路径(path)总是规范的斜线分隔的绝对路径;绝没有相对路径. 任意的unicode字符都可以做路径名， 除了以下的限制：:</p><ul><li>空字符(\u0000)不能做路径名的一部分. (主要考虑C语言)</li><li>以下字符不能使用。 因为它们不能显示或不易显示: \u0001 - \u001F and \u007F - \u009F.</li><li>以下字符也不可以: \ud800 - uF8FF, \uFFF0 - uFFFF.</li><li>&quot;.&quot; 字符可以作为路径名的一部分，但是 &quot;.&quot; 和 &quot;..&quot; 不能单独做路径名， 因为ZooKeeper不使用相对路径。 后面这几个路径都是非法的: &quot;/a/b/./c&quot; or &quot;/a/b/../c&quot;.</li><li>&quot;zookeeper&quot; 是保留关键字.</li></ul><h2 id="ZNode节点">ZNode节点</h2><p>ZooKeeper树中的每一个节点都被成<code>znode</code>. Znode维护一个stat数据结构， 包含数据变动的版本值， acl变动等(version numbers for data changes, acl changes)。 stat数据结构还包含时间戳(timestamp)。 版本和时间戳可以允许ZooKeeper校验缓存和协同更新。每次znode的数据改变，版本号都会增加。例如，无论何时一个节点获取数据时， 它都会得到数据的版本。 当节点执行更新或者删除操作时， 它必须提供它要改变的znode数据的版本。假如它提供的版本和数据的实际版本不一致，更新失败。 (这个行为可以被覆盖overriden,更多的信息请参考 [tbd...])</p><blockquote><p><strong>Note</strong>: 在分布式应用工程学上，单词<code>node</code> 可以指一个通用的主机，服务器， 集群中的一员， 一个客户端进程等。 而在ZooKeeper文档中，<code>znode</code>指数据节点，<code>Server</code>指提供ZooKeeper服务器的机器; <code>quorum peers</code> 指ZooKeeper集群中的服务器; <code>client</code> 指任何使用ZooKeeper的主机或者进程.</p></blockquote><p>Znode是程序访问的主要对象. 它们有以下几个特征值得一说.</p><h3 id="监视Watches">监视Watches</h3><p>Clients can set watches on znodes. Changes to that znode trigger the watch and then clear the<br>watch. When a watch triggers, ZooKeeper sends the client a notification. More information<br>about watches can be found in the section ZooKeeper Watches.</p><h3 id="数据访问Data_Access">数据访问Data Access</h3><p>The data stored at each znode in a namespace is read and written atomically. Reads get all the<br>data bytes associated with a znode and a write replaces all the data. Each node has an Access<br>Control List (ACL) that restricts who can do what.<br>ZooKeeper was not designed to be a general database or large object store. Instead,<br>it manages coordination data. This data can come in the form of configuration, status<br>information, rendezvous, etc. A common property of the various forms of coordination data<br>is that they are relatively small: measured in kilobytes. The ZooKeeper client and the server<br>implementations have sanity checks to ensure that znodes have less than 1M of data, but the<br>data should be much less than that on average. Operating on relatively large data sizes will<br>cause some operations to take much more time than others and will affect the latencies of<br>some operations because of the extra time needed to move more data over the network and<br>onto storage media. If large data storage is needed, the usually pattern of dealing with such<br>data is to store it on a bulk storage system, such as NFS or HDFS, and store pointers to the<br>storage locations in ZooKeeper.</p><h3 id="临时节点Ephemeral_Nodes">临时节点Ephemeral Nodes</h3><p>ZooKeeper also has the notion of ephemeral nodes. These znodes exists as long as the<br>session that created the znode is active. When the session ends the znode is deleted. Because<br>of this behavior ephemeral znodes are not allowed to have children.</p><h3 id="顺序节点Sequence_Nodes_-_Unique_Naming">顺序节点Sequence Nodes -- Unique Naming</h3><p>When creating a znode you can also request that ZooKeeper append a monotonically<br>increasing counter to the end of path. This counter is unique to the parent znode. The counter<br>has a format of %010d -- that is 10 digits with 0 (zero) padding (the counter is formatted in<br>this way to simplify sorting), i.e. &quot;<path>0000000001&quot;. See Queue Recipefor an example<br>use of this feature. Note: the counter used to store the next sequence number is a signed int<br>(4bytes) maintained by the parent node, the counter will overflow when incremented beyond<br>2147483647 (resulting in a name &quot;<path>-2147483647&quot;).</path></path></p><h2 id="ZooKeeper中的时间">ZooKeeper中的时间</h2><p>ZooKeeper tracks time multiple ways:</p><ul><li><strong>Zxid</strong><br>Every change to the ZooKeeper state receives a stamp in the form of a zxid(ZooKeeper<br>Transaction Id). This exposes the total ordering of all changes to ZooKeeper. Each<br>change will have a unique zxid and if zxid1 is smaller than zxid2 then zxid1 happened<br>before zxid2.</li><li><strong>Version numbers</strong><br>Every change to a node will cause an increase to one of the version numbers of that<br>node. The three version numbers are version (number of changes to the data of a znode),<br>cversion (number of changes to the children of a znode), and aversion (number of<br>changes to the ACL of a znode).</li><li><strong>Ticks</strong><br>When using multi-server ZooKeeper, servers use ticks to define timing of events such as<br>status uploads, session timeouts, connection timeouts between peers, etc. The tick time is<br>only indirectly exposed through the minimum session timeout (2 times the tick time); if a client requests a session timeout less than the minimum session timeout, the server will<br>tell the client that the session timeout is actually the minimum session timeout.</li><li><strong>Real time</strong><br>ZooKeeper doesn&#39;t use real time, or clock time, at all except to put timestamps into the<br>stat structure on znode creation and znode modification.</li></ul><h2 id="ZooKeeper_Stat数据结构">ZooKeeper Stat数据结构</h2><p>The Stat structure for each znode in ZooKeeper is made up of the following fields:</p><ul><li><strong>czxid</strong><br>The zxid of the change that caused this znode to be created.</li><li><strong>mzxid</strong><br>The zxid of the change that last modified this znode.</li><li><strong>ctime</strong><br>The time in milliseconds from epoch when this znode was created.</li><li><strong>mtime</strong><br>The time in milliseconds from epoch when this znode was last modified.</li><li><strong>version</strong><br>The number of changes to the data of this znode.</li><li><strong>cversion</strong><br>The number of changes to the children of this znode.</li><li><strong>aversion</strong><br>The number of changes to the ACL of this znode.</li><li><strong>ephemeralOwner</strong><br>The session id of the owner of this znode if the znode is an ephemeral node. If it is not an<br>ephemeral node, it will be zero.</li><li><strong>dataLength</strong><br>The length of the data field of this znode.</li><li><strong>numChildren</strong><br>The number of children of this znode.</li></ul><h1 id="ZooKeeper会话">ZooKeeper会话</h1><p>A ZooKeeper client establishes a session with the ZooKeeper service by creating a<br>handle to the service using a language binding. Once created, the handle starts of in the<br>CONNECTING state and the client library tries to connect to one of the servers that make<br>up the ZooKeeper service at which point it switches to the CONNECTED state. During normal operation will be in one of these two states. If an unrecoverable error occurs, such as<br>session expiration or authentication failure, or if the application explicitly closes the handle,<br>the handle will move to the CLOSED state. The following figure shows the possible state<br>transitions of a ZooKeeper client:<br><img src="http://zookeeper.apache.org/doc/trunk/images/state_dia.jpg" alt=""></p><p>To create a client session the application code must provide a connection string containing<br>a comma separated list of host:port pairs, each corresponding to a ZooKeeper server (e.g.<br>&quot;127.0.0.1:4545&quot; or &quot;127.0.0.1:3000,127.0.0.1:3001,127.0.0.1:3002&quot;). The ZooKeeper client<br>library will pick an arbitrary server and try to connect to it. If this connection fails, or if the<br>client becomes disconnected from the server for any reason, the client will automatically try<br>the next server in the list, until a connection is (re-)established.<br>Added in 3.2.0: An optional &quot;chroot&quot; suffix may also be appended to the connection string.<br>This will run the client commands while interpreting all paths relative to this root (similar to<br>the unix chroot command). If used the example would look like: &quot;127.0.0.1:4545/app/a&quot; or<br>&quot;127.0.0.1:3000,127.0.0.1:3001,127.0.0.1:3002/app/a&quot; where the client would be rooted at &quot;/<br>app/a&quot; and all paths would be relative to this root - ie getting/setting/etc... &quot;/foo/bar&quot; would<br>result in operations being run on &quot;/app/a/foo/bar&quot; (from the server perspective). This feature<br>is particularly useful in multi-tenant environments where each user of a particular ZooKeeper<br>service could be rooted differently. This makes re-use much simpler as each user can code<br>his/her application as if it were rooted at &quot;/&quot;, while actual location (say /app/a) could be<br>determined at deployment time.<br>When a client gets a handle to the ZooKeeper service, ZooKeeper creates a ZooKeeper session, represented as a 64-bit number, that it assigns to the client. If the client connects to a different ZooKeeper server, it will send the session id as a part of the connection handshake. As a security measure, the server creates a password for the session id that any ZooKeeper server can validate.The password is sent to the client with the session id when the client establishes the session. The client sends this password with the session id whenever it reestablishes the session with a new server.</p><p>One of the parameters to the ZooKeeper client library call to create a ZooKeeper session is the session timeout in milliseconds. The client sends a requested timeout, the server responds with the timeout that it can give the client. The current implementation requires that the timeout be a minimum of 2 times the tickTime (as set in the server configuration) and a maximum of 20 times the tickTime. The ZooKeeper client API allows access to the negotiated timeout.</p><p>When a client (session) becomes partitioned from the ZK serving cluster it will begin searching the list of servers that were specified during session creation. Eventually, when connectivity between the client and at least one of the servers is re-established, the session will either again transition to the &quot;connected&quot; state (if reconnected within the session timeout value) or it will transition to the &quot;expired&quot; state (if reconnected after the session timeout). It is not advisable to create a new session object (a new ZooKeeper.class or zookeeper handle in the c binding) for disconnection. The ZK client library will handle reconnect for you. In particular we have heuristics built into the client library to handle things like &quot;herd effect&quot;, etc... Only create a new session when you are notified of session expiration (mandatory).</p><p>Session expiration is managed by the ZooKeeper cluster itself, not by the client. When the ZK client establishes a session with the cluster it provides a &quot;timeout&quot; value detailed above. This value is used by the cluster to determine when the client&#39;s session expires. Expirations happens when the cluster does not hear from the client within the specified session timeout period (i.e. no heartbeat). At session expiration the cluster will delete any/all ephemeral nodes owned by that session and immediately notify any/all connected clients of the change (anyone watching those znodes). At this point the client of the expired session is still disconnected from the cluster, it will not be notified of the session expiration until/unless it is able to re-establish a connection to the cluster. The client will stay in disconnected state until the TCP connection is re-established with the cluster, at which point the watcher of the expired session will receive the &quot;session expired&quot; notification.</p><p>Example state transitions for an expired session as seen by the expired session&#39;s watcher:</p><ol><li>&#39;connected&#39; : session is established and client is communicating with cluster (client/server communication is operating properly)</li><li>.... client is partitioned from the cluster</li><li>&#39;disconnected&#39; : client has lost connectivity with the cluster</li><li>.... time elapses, after &#39;timeout&#39; period the cluster expires the session, nothing is seen by client as it is disconnected from cluster</li><li>.... time elapses, the client regains network level connectivity with the cluster</li><li>&#39;expired&#39; : eventually the client reconnects to the cluster, it is then notified of the expiration</li></ol><p>Another parameter to the ZooKeeper session establishment call is the default watcher. Watchers are notified when any state change occurs in the client. For example if the client loses connectivity to the server the client will be notified, or if the client&#39;s session expires, etc... This watcher should consider the initial state to be disconnected (i.e. before any state changes events are sent to the watcher by the client lib). In the case of a new connection, the first event sent to the watcher is typically the session connection event.</p><p>The session is kept alive by requests sent by the client. If the session is idle for a period of time that would timeout the session, the client will send a PING request to keep the session alive. This PING request not only allows the ZooKeeper server to know that the client is still active, but it also allows the client to verify that its connection to the ZooKeeper server is still active. The timing of the PING is conservative enough to ensure reasonable time to detect a dead connection and reconnect to a new server.</p><p>Once a connection to the server is successfully established (connected) there are basically two cases where the client lib generates connectionloss (the result code in c binding, exception in Java -- see the API documentation for binding specific details) when either a synchronous or asynchronous operation is performed and one of the following holds:</p><ol><li>The application calls an operation on a session that is no longer alive/valid</li><li>The ZooKeeper client disconnects from a server when there are pending operations to that server, i.e., there is a pending asynchronous call.</li></ol><p><strong>Added in 3.2.0 -- SessionMovedException.</strong> There is an internal exception that is generally not seen by clients called the SessionMovedException. This exception occurs because a request was received on a connection for a session which has been reestablished on a different server. The normal cause of this error is a client that sends a request to a server, but the network packet gets delayed, so the client times out and connects to a new server. When the delayed packet arrives at the first server, the old server detects that the session has moved, and closes the client connection. Clients normally do not see this error since they do not read from those old connections. (Old connections are usually closed.) One situation in which this condition can be seen is when two clients try to reestablish the same connection using a saved session id and password. One of the clients will reestablish the connection and the second client will be disconnected (causing the pair to attempt to re-establish its connection/session indefinitely).</p><p><strong>Updating the list of servers.</strong> We allow a client to update the connection string by providing a new comma separated list of host:port pairs, each corresponding to a ZooKeeper server. The function invokes a probabilistic load-balancing algorithm which may cause the client to disconnect from its current host with the goal to achieve expected uniform number of connections per server in the new list. In case the current host to which the client is connected is not in the new list this call will always cause the connection to be dropped. Otherwise, the decision is based on whether the number of servers has increased or decreased and by how much.</p><p>For example, if the previous connection string contained 3 hosts and now the list contains these 3 hosts and 2 more hosts, 40% of clients connected to each of the 3 hosts will move to one of the new hosts in order to balance the load. The algorithm will cause the client to drop its connection to the current host to which it is connected with probability 0.4 and in this case cause the client to connect to one of the 2 new hosts, chosen at random.</p><p>Another example -- suppose we have 5 hosts and now update the list to remove 2 of the hosts, the clients connected to the 3 remaining hosts will stay connected, whereas all clients connected to the 2 removed hosts will need to move to one of the 3 hosts, chosen at random. If the connection is dropped, the client moves to a special mode where he chooses a new server to connect to using the probabilistic algorithm, and not just round robin.</p><p>In the first example, each client decides to disconnect with probability 0.4 but once the decision is made, it will try to connect to a random new server and only if it cannot connect to any of the new servers will it try to connect to the old ones. After finding a server, or trying all servers in the new list and failing to connect, the client moves back to the normal mode of operation where it picks an arbitrary server from the connectString and attempt to connect to it. If that fails, is will continue trying different random servers in round robin. (see above the algorithm used to initially choose a server)</p><h1 id="ZooKeeper_Watches">ZooKeeper Watches</h1><p>All of the read operations in ZooKeeper - getData(), getChildren(), and exists() - have the option of setting a watch as a side effect. Here is ZooKeeper&#39;s definition of a watch: a watch event is one-time trigger, sent to the client that set the watch, which occurs when the data for which the watch was set changes. There are three key points to consider in this definition of a watch:</p><ul><li><strong>One-time trigger</strong><br>One watch event will be sent to the client when the data has changed. For example, if a client does a getData(&quot;/znode1&quot;, true) and later the data for /znode1 is changed or deleted, the client will get a watch event for /znode1. If /znode1 changes again, no watch event will be sent unless the client has done another read that sets a new watch.</li><li><strong>Sent to the client</strong><br>This implies that an event is on the way to the client, but may not reach the client before the successful return code to the change operation reaches the client that initiated the change. Watches are sent asynchronously to watchers. ZooKeeper provides an ordering guarantee: a client will never see a change for which it has set a watch until it first sees the watch event. Network delays or other factors may cause different clients to see watches and return codes from updates at different times. The key point is that everything seen by the different clients will have a consistent order.</li><li><strong>The data for which the watch was set</strong><br>This refers to the different ways a node can change. It helps to think of ZooKeeper as maintaining two lists of watches: data watches and child watches. getData() and exists() set data watches. getChildren() sets child watches. Alternatively, it may help to think of watches being set according to the kind of data returned. getData() and exists() return information about the data of the node, whereas getChildren() returns a list of children. Thus, setData() will trigger data watches for the znode being set (assuming the set is successful). A successful create() will trigger a data watch for the znode being created and a child watch for the parent znode. A successful delete() will trigger both a data watch and a child watch (since there can be no more children) for a znode being deleted as well as a child watch for the parent znode.</li></ul><p>Watches are maintained locally at the ZooKeeper server to which the client is connected. This allows watches to be lightweight to set, maintain, and dispatch. When a client connects to a new server, the watch will be triggered for any session events. Watches will not be received while disconnected from a server. When a client reconnects, any previously registered watches will be reregistered and triggered if needed. In general this all occurs transparently. There is one case where a watch may be missed: a watch for the existence of a znode not yet created will be missed if the znode is created and deleted while disconnected.</p><p>##Semantics of Watches<br>We can set watches with the three calls that read the state of ZooKeeper: exists, getData, and getChildren. The following list details the events that a watch can trigger and the calls that enable them:</p><ul><li><strong>Created event</strong>:<br>Enabled with a call to exists.</li><li><strong>Deleted event</strong>:<br>Enabled with a call to exists, getData, and getChildren.</li><li><strong>Changed event</strong>:<br>Enabled with a call to exists and getData.</li><li><strong>Child event</strong>:<br>Enabled with a call to getChildren.</li></ul><h2 id="Remove_Watches">Remove Watches</h2><p>We can remove the watches registered on a znode with a call to removeWatches. Also, a ZooKeeper client can remove watches locally even if there is no server connection by setting the local flag to true. The following list details the events which will be triggered after the successful watch removal.</p><ul><li><strong>Child Remove event</strong>:<br>Watcher which was added with a call to getChildren.<br><strong>Data Remove event</strong>:<br>Watcher which was added with a call to exists or getData.</li></ul><h2 id="What_ZooKeeper_Guarantees_about_Watches">What ZooKeeper Guarantees about Watches</h2><p>With regard to watches, ZooKeeper maintains these guarantees:</p><ul><li>Watches are ordered with respect to other events, other watches, and asynchronous replies. The ZooKeeper client libraries ensures that everything is dispatched in order.</li><li>A client will see a watch event for a znode it is watching before seeing the new data that corresponds to that znode.</li><li>The order of watch events from ZooKeeper corresponds to the order of the updates as seen by the ZooKeeper service.</li></ul><h2 id="Things_to_Remember_about_Watches">Things to Remember about Watches</h2><ul><li>Watches are one time triggers; if you get a watch event and you want to get notified of future changes, you must set another watch.</li><li>Because watches are one time triggers and there is latency between getting the event and sending a new request to get a watch you cannot reliably see every change that happens to a node in ZooKeeper. Be prepared to handle the case where the znode changes multiple times between getting the event and setting the watch again. (You may not care, but at least realize it may happen.)</li><li>A watch object, or function/context pair, will only be triggered once for a given notification. For example, if the same watch object is registered for an exists and a getData call for the same file and that file is then deleted, the watch object would only be invoked once with the deletion notification for the file.</li><li>When you disconnect from a server (for example, when the server fails), you will not get any watches until the connection is reestablished. For this reason session events are sent to all outstanding watch handlers. Use session events to go into a safe mode: you will not be receiving events while disconnected, so your process should act conservatively in that mode.</li></ul><h1 id="ZooKeeper_access_control_using_ACLs">ZooKeeper access control using ACLs</h1><p>ZooKeeper uses ACLs to control access to its znodes (the data nodes of a ZooKeeper data tree). The ACL implementation is quite similar to UNIX file access permissions: it employs permission bits to allow/disallow various operations against a node and the scope to which the bits apply. Unlike standard UNIX permissions, a ZooKeeper node is not limited by the three standard scopes for user (owner of the file), group, and world (other). ZooKeeper does not have a notion of an owner of a znode. Instead, an ACL specifies sets of ids and permissions that are associated with those ids.</p><p>Note also that an ACL pertains only to a specific znode. In particular it does not apply to children. For example, if /app is only readable by ip:172.16.16.1 and /app/status is world readable, anyone will be able to read /app/status; ACLs are not recursive.</p><p>ZooKeeper supports pluggable authentication schemes. Ids are specified using the form scheme:id, where scheme is a the authentication scheme that the id corresponds to. For example, ip:172.16.16.1 is an id for a host with the address 172.16.16.1.</p><p>When a client connects to ZooKeeper and authenticates itself, ZooKeeper associates all the ids that correspond to a client with the clients connection. These ids are checked against the ACLs of znodes when a clients tries to access a node. ACLs are made up of pairs of (scheme:expression, perms). The format of the expression is specific to the scheme. For example, the pair (ip:19.22.0.0/16, READ) gives the READ permission to any clients with an IP address that starts with 19.22.</p><h2 id="ACL_Permissions">ACL Permissions</h2><p>ZooKeeper supports the following permissions:</p><ul><li><strong>CREATE</strong>: you can create a child node</li><li><strong>READ</strong>: you can get data from a node and list its children.</li><li><strong>WRITE</strong>: you can set data for a node</li><li><strong>DELETE</strong>: you can delete a child node</li><li><strong>ADMIN</strong>: you can set permissions</li></ul><p>The CREATE and DELETE permissions have been broken out of the WRITE permission for finer grained access controls. The cases for CREATE and DELETE are the following:</p><p>You want A to be able to do a set on a ZooKeeper node, but not be able to CREATE or DELETE children.</p><p>CREATE without DELETE: clients create requests by creating ZooKeeper nodes in a parent directory. You want all clients to be able to add, but only request processor can delete. (This is kind of like the APPEND permission for files.)</p><p>Also, the ADMIN permission is there since ZooKeeper doesn’t have a notion of file owner. In some sense the ADMIN permission designates the entity as the owner. ZooKeeper doesn’t support the LOOKUP permission (execute permission bit on directories to allow you to LOOKUP even though you can&#39;t list the directory). Everyone implicitly has LOOKUP permission. This allows you to stat a node, but nothing more. (The problem is, if you want to call zoo_exists() on a node that doesn&#39;t exist, there is no permission to check.)</p><h3 id="Builtin_ACL_Schemes">Builtin ACL Schemes</h3><p>ZooKeeeper has the following built in schemes:</p><ul><li><strong>world</strong> has a single id, anyone, that represents anyone.</li><li><strong>auth</strong> doesn&#39;t use any id, represents any authenticated user.</li><li><strong>digest</strong> uses a username:password string to generate MD5 hash which is then used as an ACL ID identity. Authentication is done by sending the username:password in clear text. When used in the ACL the expression will be the username:base64 encoded SHA1 password digest.</li><li><strong>ip</strong> uses the client host IP as an ACL ID identity. The ACL expression is of the form addr/bits where the most significant bits of addr are matched against the most significant bits of the client host IP.</li></ul><h3 id="ZooKeeper_C_client_API">ZooKeeper C client API</h3><p>The following constants are provided by the ZooKeeper C library:</p><ul><li>const int ZOO_PERM_READ; //can read node’s value and list its children</li><li>const int ZOO_PERM_WRITE;// can set the node’s value</li><li>const int ZOO_PERM_CREATE; //can create children</li><li>const int ZOO_PERM_DELETE;// can delete children</li><li>const int ZOO_PERM_ADMIN; //can execute set_acl()</li><li>const int ZOO_PERM_ALL;// all of the above flags OR’d together</li></ul><p>The following are the standard ACL IDs:</p><ul><li>struct Id ZOO_ANYONE_ID_UNSAFE; //(‘world’,’anyone’)</li><li>struct Id ZOO_AUTH_IDS;// (‘auth’,’’)</li></ul><p>ZOO_AUTH_IDS empty identity string should be interpreted as “the identity of the creator”.</p><p>ZooKeeper client comes with three standard ACLs:</p><ul><li>struct ACL_vector ZOO_OPEN_ACL_UNSAFE; //(ZOO_PERM_ALL,ZOO_ANYONE_ID_UNSAFE)</li><li>struct ACL_vector ZOO_READ_ACL_UNSAFE;// (ZOO_PERM_READ, ZOO_ANYONE_ID_UNSAFE)</li><li>struct ACL_vector ZOO_CREATOR_ALL_ACL; //(ZOO_PERM_ALL,ZOO_AUTH_IDS)</li></ul><p>The ZOO_OPEN_ACL_UNSAFE is completely open free for all ACL: any application can execute any operation on the node and can create, list and delete its children. The ZOO_READ_ACL_UNSAFE is read-only access for any application. CREATE_ALL_ACL grants all permissions to the creator of the node. The creator must have been authenticated by the server (for example, using “digest” scheme) before it can create nodes with this ACL.</p><p>The following ZooKeeper operations deal with ACLs:</p><ul><li>int zoo_add_auth (zhandle_t <em>zh,const char</em> scheme,const char<em>cert, int certLen, void_completion_t completion, const void</em>data);</li></ul><p>The application uses the zoo_add_auth function to authenticate itself to the server. The function can be called multiple times if the application wants to authenticate using different schemes and/or identities.</p><ul><li>int zoo_create (zhandle_t <em>zh, const char</em>path, const char <em>value,int valuelen, const struct ACL_vector</em>acl, int flags,char *realpath, int max_realpath_len);</li></ul><p>zoo_create(...) operation creates a new node. The acl parameter is a list of ACLs associated with the node. The parent node must have the CREATE permission bit set.</p><ul><li>int zoo_get_acl (zhandle_t <em>zh, const char</em>path,struct ACL_vector <em>acl, struct Stat</em>stat);</li></ul><p>This operation returns a node’s ACL info.</p><ul><li>int zoo_set_acl (zhandle_t <em>zh, const char</em>path, int version,const struct ACL_vector *acl);</li></ul><p>This function replaces node’s ACL list with a new one. The node must have the ADMIN permission set.</p><p>Here is a sample code that makes use of the above APIs to authenticate itself using the “foo” scheme and create an ephemeral node “/xyz” with create-only permissions.</p><blockquote><p><strong>Note:</strong> This is a very simple example which is intended to show how to interact with ZooKeeper ACLs specifically. See .../trunk/src/c/src/cli.c for an example of a proper C client implementation</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;string.h&gt;</span></div><div class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;errno.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#<span class="keyword">include</span> "zookeeper.h"</span></div><div class="line"></div><div class="line"><span class="keyword">static</span> zhandle_t *zh;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * In this example this method gets the cert for your</div><div class="line"> *   environment -- you must provide</div><div class="line"> */</div><div class="line"><span class="keyword">char</span> *foo_get_cert_once(<span class="keyword">char</span>* id) { <span class="keyword">return</span> <span class="number">0</span>; }</div><div class="line"></div><div class="line"><span class="comment">/** Watcher function -- empty for this example, not something you should</span></div><div class="line"> * do in real code */</div><div class="line"><span class="keyword">void</span> watcher(zhandle_t *zzh, <span class="keyword">int</span> type, <span class="keyword">int</span> state, <span class="keyword">const</span> <span class="keyword">char</span> *path,</div><div class="line">             <span class="keyword">void</span> *watcherCtx) {}</div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> argv) {</div><div class="line">  <span class="keyword">char</span> buffer[<span class="number">512</span>];</div><div class="line">  <span class="keyword">char</span> p[<span class="number">2048</span>];</div><div class="line">  <span class="keyword">char</span> *cert=<span class="number">0</span>;</div><div class="line">  <span class="keyword">char</span> appId[<span class="number">64</span>];</div><div class="line"></div><div class="line">  <span class="built_in">strcpy</span>(appId, <span class="string">"example.foo_test"</span>);</div><div class="line">  cert = foo_get_cert_once(appId);</div><div class="line">  <span class="keyword">if</span>(cert!=<span class="number">0</span>) {</div><div class="line">    <span class="built_in">fprintf</span>(stderr,</div><div class="line">            <span class="string">"Certificate for appid [%s] is [%s]\n"</span>,appId,cert);</div><div class="line">    <span class="built_in">strncpy</span>(p,cert, <span class="keyword">sizeof</span>(p)-<span class="number">1</span>);</div><div class="line">    <span class="built_in">free</span>(cert);</div><div class="line">  } <span class="keyword">else</span> {</div><div class="line">    <span class="built_in">fprintf</span>(stderr, <span class="string">"Certificate for appid [%s] not found\n"</span>,appId);</div><div class="line">    <span class="built_in">strcpy</span>(p, <span class="string">"dummy"</span>);</div><div class="line">  }</div><div class="line"></div><div class="line">  zoo_set_debug_level(ZOO_LOG_LEVEL_DEBUG);</div><div class="line"></div><div class="line">  zh = zookeeper_init(<span class="string">"localhost:3181"</span>, watcher, <span class="number">10000</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">  <span class="keyword">if</span> (!zh) {</div><div class="line">    <span class="keyword">return</span> errno;</div><div class="line">  }</div><div class="line">  <span class="keyword">if</span>(zoo_add_auth(zh,<span class="string">"foo"</span>,p,<span class="built_in">strlen</span>(p),<span class="number">0</span>,<span class="number">0</span>)!=ZOK)</div><div class="line">    <span class="keyword">return</span> <span class="number">2</span>;</div><div class="line"></div><div class="line">  <span class="keyword">struct</span> ACL CREATE_ONLY_ACL[] = {{ZOO_PERM_CREATE, ZOO_AUTH_IDS}};</div><div class="line">  <span class="keyword">struct</span> ACL_vector CREATE_ONLY = {<span class="number">1</span>, CREATE_ONLY_ACL};</div><div class="line">  <span class="keyword">int</span> rc = zoo_create(zh,<span class="string">"/xyz"</span>,<span class="string">"value"</span>, <span class="number">5</span>, &CREATE_ONLY, ZOO_EPHEMERAL,</div><div class="line">                      buffer, <span class="keyword">sizeof</span>(buffer)-<span class="number">1</span>);</div><div class="line"></div><div class="line">  <span class="comment">/** this operation will fail with a ZNOAUTH error */</span></div><div class="line">  <span class="keyword">int</span> buflen= <span class="keyword">sizeof</span>(buffer);</div><div class="line">  <span class="keyword">struct</span> Stat stat;</div><div class="line">  rc = zoo_get(zh, <span class="string">"/xyz"</span>, <span class="number">0</span>, buffer, &buflen, &stat);</div><div class="line">  <span class="keyword">if</span> (rc) {</div><div class="line">    <span class="built_in">fprintf</span>(stderr, <span class="string">"Error %d for %s\n"</span>, rc, __LINE__);</div><div class="line">  }</div><div class="line"></div><div class="line">  zookeeper_close(zh);</div><div class="line">  <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div></pre></td></tr></table></figure><h1 id="可插拔的ZooKeeper身份验证">可插拔的ZooKeeper身份验证</h1><p>ZooKeeper runs in a variety of different environments with various different authentication schemes, so it has a completely pluggable authentication framework. Even the builtin authentication schemes use the pluggable authentication framework.</p><p>To understand how the authentication framework works, first you must understand the two main authentication operations. The framework first must authenticate the client. This is usually done as soon as the client connects to a server and consists of validating information sent from or gathered about a client and associating it with the connection. The second operation handled by the framework is finding the entries in an ACL that correspond to client. ACL entries are &lt;idspec, permissions&gt; pairs. The idspec may be a simple string match against the authentication information associated with the connection or it may be a expression that is evaluated against that information. It is up to the implementation of the authentication plugin to do the match. Here is the interface that an authentication plugin must implement:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AuthenticationProvider</span> </span>{</div><div class="line">    String getScheme();</div><div class="line">    KeeperException.Code handleAuthentication(ServerCnxn cnxn, <span class="keyword">byte</span> authData[]);</div><div class="line">    <span class="keyword">boolean</span> isValid(String id);</div><div class="line">    <span class="keyword">boolean</span> matches(String id, String aclExpr);</div><div class="line">    <span class="keyword">boolean</span> isAuthenticated();</div><div class="line">}</div></pre></td></tr></table></figure><p>The first method getScheme returns the string that identifies the plugin. Because we support multiple methods of authentication, an authentication credential or an idspec will always be prefixed with scheme:. The ZooKeeper server uses the scheme returned by the authentication plugin to determine which ids the scheme applies to.</p><p>handleAuthentication is called when a client sends authentication information to be associated with a connection. The client specifies the scheme to which the information corresponds. The ZooKeeper server passes the information to the authentication plugin whose getScheme matches the scheme passed by the client. The implementor of handleAuthentication will usually return an error if it determines that the information is bad, or it will associate information with the connection using cnxn.getAuthInfo().add(new Id(getScheme(), data)).</p><p>The authentication plugin is involved in both setting and using ACLs. When an ACL is set for a znode, the ZooKeeper server will pass the id part of the entry to the isValid(String id) method. It is up to the plugin to verify that the id has a correct form. For example, ip:172.16.0.0/16 is a valid id, but ip:host.com is not. If the new ACL includes an &quot;auth&quot; entry, isAuthenticated is used to see if the authentication information for this scheme that is assocatied with the connection should be added to the ACL. Some schemes should not be included in auth. For example, the IP address of the client is not considered as an id that should be added to the ACL if auth is specified.</p><p>ZooKeeper invokes matches(String id, String aclExpr) when checking an ACL. It needs to match authentication information of the client against the relevant ACL entries. To find the entries which apply to the client, the ZooKeeper server will find the scheme of each entry and if there is authentication information from that client for that scheme, matches(String id, String aclExpr) will be called with id set to the authentication information that was previously added to the connection by handleAuthentication and aclExpr set to the id of the ACL entry. The authentication plugin uses its own logic and matching scheme to determine if id is included in aclExpr.</p><p>There are two built in authentication plugins: ip and digest. Additional plugins can adding using system properties. At startup the ZooKeeper server will look for system properties that start with &quot;zookeeper.authProvider.&quot; and interpret the value of those properties as the class name of an authentication plugin. These properties can be set using the -Dzookeeeper.authProvider.X=com.f.MyAuth or adding entries such as the following in the server configuration file:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">authProvider<span class="number">.1</span>=com.f.MyAuth</div><div class="line">authProvider<span class="number">.2</span>=com.f.MyAuth2</div></pre></td></tr></table></figure><p>Care should be taking to ensure that the suffix on the property is unique. If there are duplicates such as <code>-Dzookeeeper.authProvider.X=com.f.MyAuth -Dzookeeper.authProvider.X=com.f.MyAuth2</code>, only one will be used. Also all servers must have the same plugins defined, otherwise clients using the authentication schemes provided by the plugins will have problems connecting to some servers.</p><h1 id="一致性保证_Consistency_Guarantees">一致性保证 Consistency Guarantees</h1><p>ZooKeeper is a high performance, scalable service. Both reads and write operations are designed to be fast, though reads are faster than writes. The reason for this is that in the case of reads, ZooKeeper can serve older data, which in turn is due to ZooKeeper&#39;s consistency guarantees:</p><p><strong>Sequential Consistency</strong><br>Updates from a client will be applied in the order that they were sent.</p><p><strong>Atomicity</strong><br>Updates either succeed or fail -- there are no partial results.</p><p><strong>Single System Image</strong><br>A client will see the same view of the service regardless of the server that it connects to.</p><p><strong>Reliability</strong><br>Once an update has been applied, it will persist from that time forward until a client overwrites the update. This guarantee has two corollaries:</p><ol><li>If a client gets a successful return code, the update will have been applied. On some failures (communication errors, timeouts, etc) the client will not know if the update has applied or not. We take steps to minimize the failures, but the guarantee is only present with successful return codes. (This is called the monotonicity condition in Paxos.)</li><li>Any updates that are seen by the client, through a read request or successful update, will never be rolled back when recovering from server failures.</li></ol><p><strong>Timeliness</strong><br>The clients view of the system is guaranteed to be up-to-date within a certain time bound (on the order of tens of seconds). Either system changes will be seen by a client within this bound, or the client will detect a service outage.</p><p>Using these consistency guarantees it is easy to build higher level functions such as leader election, barriers, queues, and read/write revocable locks solely at the ZooKeeper client (no additions needed to ZooKeeper). See Recipes and Solutions for more details.</p><blockquote><p><strong>Note:</strong> Sometimes developers mistakenly assume one other guarantee that ZooKeeper does not in fact make. This is:<br>Simultaneously Consistent Cross-Client Views<br>ZooKeeper does not guarantee that at every instance in time, two different clients will have identical views of ZooKeeper data. Due to factors like network delays, one client may perform an update before another client gets notified of the change. Consider the scenario of two clients, A and B. If client A sets the value of a znode /a from 0 to 1, then tells client B to read /a, client B may read the old value of 0, depending on which server it is connected to. If it is important that Client A and Client B read the same value, Client B should should call the sync() method from the ZooKeeper API method before it performs its read.<br>So, ZooKeeper by itself doesn&#39;t guarantee that changes occur synchronously across all servers, but ZooKeeper primitives can be used to construct higher level functions that provide useful client synchronization. (For more information, see the ZooKeeper Recipes. [tbd:..]).</p></blockquote><h1 id="绑定Binding">绑定Binding</h1><p>The ZooKeeper client libraries come in two languages: Java and C. The following sections describe these.</p><h2 id="Java_Binding">Java Binding</h2><p>here are two packages that make up the ZooKeeper Java binding: <strong>org.apache.zookeeper and org.apache.zookeeper.data</strong>. The rest of the packages that make up ZooKeeper are used internally or are part of the server implementation. The <strong>org.apache.zookeeper.data</strong> package is made up of generated classes that are used simply as containers.</p><p>The main class used by a ZooKeeper Java client is the ZooKeeper class. Its two constructors differ only by an optional session id and password. ZooKeeper supports session recovery accross instances of a process. A Java program may save its session id and password to stable storage, restart, and recover the session that was used by the earlier instance of the program.</p><p>When a ZooKeeper object is created, two threads are created as well: an IO thread and an event thread. All IO happens on the IO thread (using Java NIO). All event callbacks happen on the event thread. Session maintenance such as reconnecting to ZooKeeper servers and maintaining heartbeat is done on the IO thread. Responses for synchronous methods are also processed in the IO thread. All responses to asynchronous methods and watch events are processed on the event thread. There are a few things to notice that result from this design:</p><ul><li>All completions for asynchronous calls and watcher callbacks will be made in order, one at a time. The caller can do any processing they wish, but no other callbacks will be processed during that time.</li><li>Callbacks do not block the processing of the IO thread or the processing of the synchronous calls.</li><li>Synchronous calls may not return in the correct order. For example, assume a client does the following processing: issues an asynchronous read of node /a with watch set to true, and then in the completion callback of the read it does a synchronous read of /a. (Maybe not good practice, but not illegal either, and it makes for a simple example.)<br>Note that if there is a change to /a between the asynchronous read and the synchronous read, the client library will receive the watch event saying /a changed before the response for the synchronous read, but because the completion callback is blocking the event queue, the synchronous read will return with the new value of /a before the watch event is processed.</li></ul><p>Finally, the rules associated with shutdown are straightforward: once a ZooKeeper object is closed or receives a fatal event (SESSION_EXPIRED and AUTH_FAILED), the ZooKeeper object becomes invalid. On a close, the two threads shut down and any further access on zookeeper handle is undefined behavior and should be avoided.</p><h2 id="C_Binding">C Binding</h2><p>The C binding has a single-threaded and multi-threaded library. The multi-threaded library is easiest to use and is most similar to the Java API. This library will create an IO thread and an event dispatch thread for handling connection maintenance and callbacks. The single-threaded library allows ZooKeeper to be used in event driven applications by exposing the event loop used in the multi-threaded library.</p><p>The package includes two shared libraries: zookeeper_st and zookeeper_mt. The former only provides the asynchronous APIs and callbacks for integrating into the application&#39;s event loop. The only reason this library exists is to support the platforms were a pthread library is not available or is unstable (i.e. FreeBSD 4.x). In all other cases, application developers should link with zookeeper_mt, as it includes support for both Sync and Async API.</p><h3 id="Installation">Installation</h3><p>If you&#39;re building the client from a check-out from the Apache repository, follow the steps outlined below. If you&#39;re building from a project source package downloaded from apache, skip to step <strong>3</strong>.</p><ol><li>Run ant compile_jute from the ZooKeeper top level directory (.../trunk). This will create a directory named &quot;generated&quot; under .../trunk/src/c.</li><li>Change directory to the.../trunk/src/c and run <code>autoreconf</code> -if to bootstrap <code>autoconf</code>, <code>automake</code> and <code>libtool</code>. Make sure you have autoconf version 2.59 or greater installed. Skip to step <strong>4</strong>.</li><li>If you are building from a project source package, unzip/untar the source tarball and cd to the zookeeper-x.x.x/src/c directory.</li><li>Run ./configure<your-options>to generate the makefile. Here are some of options the configure utility supports that can be useful in this step:<ul><li>--enable-debug<br>Enables optimization and enables debug info compiler options. (Disabled by default.)</li><li>--without-syncapi<br>Disables Sync API support; zookeeper_mt library won&#39;t be built. (Enabled by default.)</li><li>--disable-static<br>Do not build static libraries. (Enabled by default.)</li><li>--disable-shared<br>Do not build shared libraries. (Enabled by default.)<blockquote><p><strong>Note:</strong> See INSTALL for general information about running configure.</p></blockquote></li></ul></your-options></li><li>Run make or make install to build the libraries and install them.</li><li>To generate doxygen documentation for the ZooKeeper API, run make doxygen-doc. All documentation will be placed in a new subfolder named docs. By default, this command only generates HTML. For information on other document formats, run ./configure --help</li></ol><h3 id="Using_the_C_Client">Using the C Client</h3><p>You can test your client by running a ZooKeeper server (see instructions on the project wiki page on how to run it) and connecting to it using one of the cli applications that were built as part of the installation procedure. cli_mt (multithreaded, built against zookeeper_mt library) is shown in this example, but you could also use cli_st (singlethreaded, built against zookeeper_st library):</p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ cli_mt zookeeper_hos<span class="variable">t:9876</span></div></pre></td></tr></table></figure><p>This is a client application that gives you a shell for executing simple ZooKeeper commands. Once successfully started and connected to the server it displays a shell prompt. You can now enter ZooKeeper commands. For example, to create a node:</p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="blockquote">&gt; create /my_new_node</span></div></pre></td></tr></table></figure><p>To verify that the node&#39;s been created:</p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&gt; <span class="keyword">ls</span> /</div></pre></td></tr></table></figure><p>You should see a list of node who are children of the root node &quot;/&quot;.</p><p>In order to be able to use the ZooKeeper API in your application you have to remember to</p><ol><li>Include ZooKeeper header: #include &lt;zookeeper/zookeeper.h&gt;</li><li>If you are building a multithreaded client, compile with -DTHREADED compiler flag to enable the multi-threaded version of the library, and then link against against the zookeeper_mt library. If you are building a single-threaded client, do not compile with -DTHREADED, and be sure to link against the zookeeper_st library.</li></ol><p>Refer to Program Structure, with Simple Example for examples of usage in Java and C. [tbd]</p><h1 id="Building_Blocks:_A_Guide_to_ZooKeeper_Operations">Building Blocks: A Guide to ZooKeeper Operations</h1><p>This section surveys all the operations a developer can perform against a ZooKeeper server. It is lower level information than the earlier concepts chapters in this manual, but higher level than the ZooKeeper API Reference. It covers these topics:</p><ul><li><a href="http://zookeeper.apache.org/doc/trunk/zookeeperProgrammers.html#sc_connectingToZk" target="_blank" rel="external">Connecting to ZooKeeper</a></li></ul><h2 id="Handling_Errors">Handling Errors</h2><p>Both the Java and C client bindings may report errors. The Java client binding does so by throwing KeeperException, calling code() on the exception will return the specific error code. The C client binding returns an error code as defined in the enum ZOO_ERRORS. API callbacks indicate result code for both language bindings. See the API documentation (javadoc for Java, doxygen for C) for full details on the possible errors and their meaning.</p><p>##Connecting to ZooKeeper</p><h2 id="Read_Operations">Read Operations</h2><h2 id="Write_Operations">Write Operations</h2><h2 id="Handling_Watches">Handling Watches</h2><h2 id="Miscelleaneous_ZooKeeper_Operations">Miscelleaneous ZooKeeper Operations</h2><h1 id="Program_Structure,_with_Simple_Example">Program Structure, with Simple Example</h1><h1 id="Gotchas:_Common_Problems_and_Troubleshooting">Gotchas: Common Problems and Troubleshooting</h1><p>So now you know ZooKeeper. It&#39;s fast, simple, your application works, but wait ... something&#39;s wrong. Here are some pitfalls that ZooKeeper users fall into:</p><ol><li>If you are using watches, you must look for the connected watch event. When a ZooKeeper client disconnects from a server, you will not receive notification of changes until reconnected. If you are watching for a znode to come into existance, you will miss the event if the znode is created and deleted while you are disconnected.</li><li>You must test ZooKeeper server failures. The ZooKeeper service can survive failures as long as a majority of servers are active. The question to ask is: can your application handle it? In the real world a client&#39;s connection to ZooKeeper can break. (ZooKeeper server failures and network partitions are common reasons for connection loss.) The ZooKeeper client library takes care of recovering your connection and letting you know what happened, but you must make sure that you recover your state and any outstanding requests that failed. Find out if you got it right in the test lab, not in production - test with a ZooKeeper service made up of a several of servers and subject them to reboots.</li><li>The list of ZooKeeper servers used by the client must match the list of ZooKeeper servers that each ZooKeeper server has. Things can work, although not optimally, if the client list is a subset of the real list of ZooKeeper servers, but not if the client lists ZooKeeper servers not in the ZooKeeper cluster.</li><li>Be careful where you put that transaction log. The most performance-critical part of ZooKeeper is the transaction log. ZooKeeper must sync transactions to media before it returns a response. A dedicated transaction log device is key to consistent good performance. Putting the log on a busy device will adversely effect performance. If you only have one storage device, put trace files on NFS and increase the snapshotCount; it doesn&#39;t eliminate the problem, but it can mitigate it.</li><li>Set your Java max heap size correctly. It is very important to avoid swapping. Going to disk unnecessarily will almost certainly degrade your performance unacceptably. Remember, in ZooKeeper, everything is ordered, so if one request hits the disk, all other queued requests hit the disk.</li><li>To avoid swapping, try to set the heapsize to the amount of physical memory you have, minus the amount needed by the OS and cache. The best way to determine an optimal heap size for your configurations is to run load tests. If for some reason you can&#39;t, be conservative in your estimates and choose a number well below the limit that would cause your machine to swap. For example, on a 4G machine, a 3G heap is a conservative estimate to start with.</li></ol><p>Outside the formal documentation, there&#39;re several other sources of information for ZooKeeper developers.<br>[tbd]</p><p><strong>ZooKeeper Whitepaper [tbd: find url]</strong><br>The definitive discussion of ZooKeeper design and performance, by Yahoo! Research<br><strong>API Reference [tbd: find url]</strong><br>The complete reference to the ZooKeeper API<br><strong>ZooKeeper Talk at the Hadoup Summit 2008</strong><br>A video introduction to ZooKeeper, by Benjamin Reed of Yahoo! Research<br><strong>Barrier and Queue Tutorial</strong><br>The excellent Java tutorial by Flavio Junqueira, implementing simple barriers and producer-consumer queues using ZooKeeper.<br>ZooKeeper - A Reliable, Scalable Distributed Coordination System<br><strong>An article by Todd Hoff (07/15/2008)</strong><br><strong>ZooKeeper Recipes</strong><br>Pseudo-level discussion of the implementation of various synchronization solutions with ZooKeeper: Event Handles, Queues, Locks, and Two-phase Commits.<br><strong>[tbd]</strong><br>Any other good sources anyone can think of...</p></div><footer class="article-footer"><ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ZooKeeper/">ZooKeeper</a></li></ul><section id="comments"><script src="https://utteranc.es/client.js" repo="smallnest/gitalk" issue-term="title" theme="github-light" crossorigin="anonymous" async></script><noscript>为正常使用评论功能请激活JavaScript</noscript></section></footer></div><nav id="article-nav"><a href="/2014/09/30/deploy-a-project-to-maven-central/" id="article-nav-newer" class="article-nav-link-wrap"><strong class="article-nav-caption">Newer</strong><div class="article-nav-title">发布开源项目到Maven Central</div></a> <a href="/2014/09/26/hadoop-ecosystem-at-a-glance/" id="article-nav-older" class="article-nav-link-wrap"><strong class="article-nav-caption">Older</strong><div class="article-nav-title">Hadoop生态圈一览</div></a></nav></article></section><aside id="sidebar"><div class="widget-wrap"><h3 class="widget-title">微信公众号</h3><div class="widget"><img width="100%" src="/images/widgets/gopatterns.jpg"></div></div><div class="widget-wrap"><h3 class="widget-title">极客时间专栏</h3><div class="widget"><a href="https://time.geekbang.org/column/intro/100061801"><img width="100%" src="/images/widgets/geekbang.png"></a></div></div><div class="widget-wrap"><h3 class="widget-title">原创图书</h3><div class="widget"><a href="/ScalaCollectionsCookbook/"><img width="100%" src="/ScalaCollectionsCookbook/scala_collections_cookbook.jpg"> <img width="100%" src="/ScalaCollectionsCookbook/scala_collections_cookbook_tw.png"></a></div></div><div class="widget-wrap"><h3 class="widget-title">分类</h3><div class="widget"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/C/">C++</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/DOTNET/">DOTNET</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Go/">Go</a><span class="category-list-count">191</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">64</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Rust/">Rust</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Scala/">Scala</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/go/">go</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/分享/">分享</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端开发/">前端开发</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/区块链/">区块链</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/大数据/">大数据</a><span class="category-list-count">60</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工具/">工具</a><span class="category-list-count">28</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/">数据库</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/架构/">架构</a><span class="category-list-count">27</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/管理/">管理</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络编程/">网络编程</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/读书笔记/">读书笔记</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/运维/">运维</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/高并发编程/">高并发编程</a><span class="category-list-count">20</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">标签云</h3><div class="widget tagcloud"><a href="/tags/Android/" style="font-size: 15.71px">Android</a><a href="/tags/ApacheBench/" style="font-size: 11.43px">ApacheBench</a><a href="/tags/Bower/" style="font-size: 10.00px">Bower</a><a href="/tags/C/" style="font-size: 10.00px">C#</a><a href="/tags/CDN/" style="font-size: 10.00px">CDN</a><a href="/tags/CQRS/" style="font-size: 10.00px">CQRS</a><a href="/tags/CRC/" style="font-size: 10.00px">CRC</a><a href="/tags/CSS/" style="font-size: 11.43px">CSS</a><a href="/tags/CompletableFuture/" style="font-size: 10.00px">CompletableFuture</a><a href="/tags/Comsat/" style="font-size: 10.00px">Comsat</a><a href="/tags/Curator/" style="font-size: 18.57px">Curator</a><a href="/tags/DSL/" style="font-size: 10.00px">DSL</a><a href="/tags/Disruptor/" style="font-size: 10.00px">Disruptor</a><a href="/tags/Docker/" style="font-size: 11.43px">Docker</a><a href="/tags/Ember/" style="font-size: 11.43px">Ember</a><a href="/tags/FastJson/" style="font-size: 10.00px">FastJson</a><a href="/tags/Fiber/" style="font-size: 10.00px">Fiber</a><a href="/tags/GAE/" style="font-size: 10.00px">GAE</a><a href="/tags/GC/" style="font-size: 12.86px">GC</a><a href="/tags/Gnuplot/" style="font-size: 10.00px">Gnuplot</a><a href="/tags/Go/" style="font-size: 14.29px">Go</a><a href="/tags/Gradle/" style="font-size: 10.00px">Gradle</a><a href="/tags/Grunt/" style="font-size: 10.00px">Grunt</a><a href="/tags/Gulp/" style="font-size: 10.00px">Gulp</a><a href="/tags/Hadoop/" style="font-size: 10.00px">Hadoop</a><a href="/tags/Hazelcast/" style="font-size: 10.00px">Hazelcast</a><a href="/tags/IPFS/" style="font-size: 10.00px">IPFS</a><a href="/tags/Ignite/" style="font-size: 10.00px">Ignite</a><a href="/tags/JVM/" style="font-size: 10.00px">JVM</a><a href="/tags/Java/" style="font-size: 17.14px">Java</a><a href="/tags/Kafka/" style="font-size: 20.00px">Kafka</a><a href="/tags/Lambda/" style="font-size: 14.29px">Lambda</a><a href="/tags/Linux/" style="font-size: 12.86px">Linux</a><a href="/tags/LongAdder/" style="font-size: 10.00px">LongAdder</a><a href="/tags/MathJax/" style="font-size: 10.00px">MathJax</a><a href="/tags/Maven/" style="font-size: 11.43px">Maven</a><a href="/tags/Memcached/" style="font-size: 10.00px">Memcached</a><a href="/tags/Metrics/" style="font-size: 10.00px">Metrics</a><a href="/tags/Mongo/" style="font-size: 12.86px">Mongo</a><a href="/tags/Netty/" style="font-size: 15.71px">Netty</a></div></div><div class="widget-wrap"><h3 class="widget-title">归档</h3><div class="widget"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">May 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">April 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">March 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">February 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">November 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">August 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">July 2021</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">June 2021</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">July 2015</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">June 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">May 2015</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">April 2015</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">March 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/02/">February 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">January 2015</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">December 2014</a><span class="archive-list-count">28</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/11/">November 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/10/">October 2014</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">September 2014</a><span class="archive-list-count">28</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">August 2014</a><span class="archive-list-count">19</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/07/">July 2014</a><span class="archive-list-count">1</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">近期文章</h3><div class="widget"><ul><li><a href="/2022/05/22/use-ebpf-to-trace-rpcx-microservices/">使用ebpf跟踪rpcx微服务</a></li><li><a href="/2022/05/06/changes-in-atomic-package/">atomic包的新变化</a></li><li><a href="/2022/04/26/Crimes-with-Go-Generics/">Go泛型的坏例子</a></li><li><a href="/2022/04/07/A-Study-of-Real-World-Data-Races-in-Golang/">Uber工程师对真实世界并发问题的研究</a></li><li><a href="/2022/03/06/most-useful-software-architecture-patterns/">最常用的架构模式</a></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">友情链接</h3><div class="widget"><ul><li><a href="http://stackshare.io" target="_blank">技术栈</a></li><li>&nbsp;</li><li><a href="https://toutiao.io/" target="_blank">开发者头条</a></li><li><a href="http://weekly.manong.io/issues/" target="_blank">码农周刊</a></li><li><a href="http://www.tuicool.com/mags" target="_blank">编程狂人周刊</a></li><li><a href="http://www.importnew.com/" target="_blank">importnew</a></li><li><a href="http://ifeve.com/" target="_blank">并发编程网</a></li><li>&nbsp;</li><li><a href="http://github.com" target="_blank">github</a></li><li><a href="http://stackoverflow.com/" target="_blank">stackoverflow</a></li><li><a href="http://www.javacodegeeks.com/" target="_blank">javacodegeeks</a></li><li><a href="http://www.infoq.com/" target="_blank">infoq</a></li><li><a href="http://www.dzone.com/links/index.html" target="_blank">dzone</a></li><li><a href="https://oj.leetcode.com/problems/" target="_blank">leetcode</a></li><li><a href="http://tutorials.jenkov.com" target="_blank">jenkov</a></li><li><a href="https://howtodoinjava.com" target="_blank">HowToDoInJava</a></li><li><a href="https://java-design-patterns.com/patterns/" target="_blank">java design patterns</a></li><li>&nbsp;</li><li><a href="https://medium.com/netflix-techblog" target="_blank">Netflix技术博客</a></li><li><a href="https://www.techiedelight.com" target="_blank">Techie Delight</a></li><li><a href="https://engineering.linkedin.com/blog" target="_blank">Linkedin技术博客</a></li><li><a href="https://blogs.dropbox.com/tech/" target="_blank">Dropbox技术博客</a></li><li><a href="https://code.fb.com" target="_blank">Facebook技术博客</a></li><li><a href="http://jm.taobao.org" target="_blank">淘宝中间件团队</a></li><li><a href="https://tech.meituan.com" target="_blank">美团技术博客</a></li><li><a href="http://blogs.360.cn" target="_blank">360技术博客</a></li><li><a href="https://xiaomi-info.github.io" target="_blank">小米信息部技术团队</a></li></ul></div></div></aside></div><footer id="footer"><div class="outer"><div id="footer-info" class="inner">&copy; 2022 smallnest<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></div></div></footer></div><nav id="mobile-nav"><a href="/" class="mobile-nav-link"><i class="fa fa-home">&nbsp;</i>首页</a> <a href="/archives" class="mobile-nav-link"><i class="fa fa-folder-o">&nbsp;</i>归档</a> <a href="https://github.com/smallnest" class="mobile-nav-link"><i class="fa fa-github">&nbsp;</i>github</a> <a class="mobile-nav-link" href="#"><i class="fa fa-bars">&nbsp;</i>网站群</a> <a class="mobile-nav-link" href="/goasm">&nbsp;&nbsp;<i class="fa fa-language">&nbsp;</i>Go汇编示例</a> <a class="mobile-nav-link" href="https://gowebexamples.com">&nbsp;&nbsp;<i class="fa fa-external-link">&nbsp;</i>Go Web开发示例</a> <a class="mobile-nav-link" href="http://go-database-sql.org">&nbsp;&nbsp;<i class="fa fa-external-link">&nbsp;</i>Go 数据库开发教程</a> <a class="mobile-nav-link" href="http://rpcx.io">&nbsp;&nbsp;<i class="fa undefined">&nbsp;</i>RPCX官网</a> <a class="mobile-nav-link" href="http://cn.doc.rpcx.io">&nbsp;&nbsp;<i class="fa undefined">&nbsp;</i>RPC开发指南</a> <a href="/ScalaCollectionsCookbook" class="mobile-nav-link"><i class="fa fa-book">&nbsp;</i>Scala集合技术手册</a> <a href="/about" class="mobile-nav-link"><i class="fa fa-lemon-o">&nbsp;</i>关于</a></nav><script src="//cdn.staticfile.org/jquery/1.11.1/jquery.min.js"></script><script src="//cdn.bootcss.com/jquery.lazyload/1.9.1/jquery.lazyload.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js"></script><script src="/js/script.js" type="text/javascript"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax:{inlineMath:[["$","$"],["\\(","\\)"]],processEscapes:!0,skipTags:["script","noscript","style","textarea","pre","code"]}}),MathJax.Hub.Queue(function(){var a,e=MathJax.Hub.getAllJax();for(a=0;a<e.length;a+=1)e[a].SourceElement().parentNode.className+=" has-jax"});</script><script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.6.0-beta.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><div id="totop" style="position:fixed;bottom:150px;right:10px;cursor: pointer;z-index: 2000"><a title="返回顶部"><img src="/images/scrollup.png"></a></div><script src="/js/totop.js" type="text/javascript"></script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?e085d87993250aab11f3e0c15f1c2785";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}();</script></div></body></html>