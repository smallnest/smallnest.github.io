<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Spark Standalone Mode | 鸟窝</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="除了在Mesos或YARN集群管理器运行，Spark还提供了一个简单的独立部署模式。你可以手动启动一个独立的集群，通过手动启动master和worker，或使用我们提供的启动脚本。也可以在一台机器上运行这些守护进程进行测试，。">
<meta property="og:type" content="article">
<meta property="og:title" content="Spark Standalone Mode">
<meta property="og:url" content="http://colobu.com/2014/12/09/spark-standalone-mode/">
<meta property="og:site_name" content="鸟窝">
<meta property="og:description" content="除了在Mesos或YARN集群管理器运行，Spark还提供了一个简单的独立部署模式。你可以手动启动一个独立的集群，通过手动启动master和worker，或使用我们提供的启动脚本。也可以在一台机器上运行这些守护进程进行测试，。">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Spark Standalone Mode">
<meta name="twitter:description" content="除了在Mesos或YARN集群管理器运行，Spark还提供了一个简单的独立部署模式。你可以手动启动一个独立的集群，通过手动启动master和worker，或使用我们提供的启动脚本。也可以在一台机器上运行这些守护进程进行测试，。">

  
    <link rel="alternative" href="/atom.xml" title="鸟窝" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">

  <link href="//cdn.staticfile.org/font-awesome/4.2.0/css/font-awesome.css" rel="stylesheet">
  
  <link rel="stylesheet" href="//libs.cncdn.cn/fancybox/2.1.5/jquery.fancybox.css" media="screen" type="text/css">
  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//cdn.staticfile.org/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->

  <script type="text/javascript">
	//visit my previous blog: http://old.colobu.com just like this http://colobu.com/?=123456
    var blog_url = location.href.toString();
	if (blog_url.indexOf("http://colobu.com/?p=") >= 0) {
		blog_url = blog_url.replace("colobu.com", "old.colobu.com");
		window.location.assign(blog_url);
	} else if (blog_url.indexOf("http://smallnest.gitcafe.com") >= 0) {
		blog_url = blog_url.replace("smallnest.gitcafe.com", "colobu.com");
		window.location.assign(blog_url);
	}  else if (blog_url.indexOf("http://smallnest.gitcafe.io") >= 0) {
		blog_url = blog_url.replace("smallnest.gitcafe.io", "colobu.com");
		window.location.assign(blog_url);
	}
</script>
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap" class="animated bounceInLeft">
        <a href="/" id="logo">鸟窝</a>
      </h1>
      
        <h2 id="subtitle-wrap" class="animated bounceInLeft">
          <a href="/" id="subtitle">大道至简 Simplicity is the ultimate form of sophistication</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/"><i class="fa fa-home">&nbsp;</i>首页</a>
        
          <a class="main-nav-link" href="/archives"><i class="fa fa-folder-o">&nbsp;</i>归档</a>
        
          <a class="main-nav-link" href="https://github.com/smallnest"><i class="fa fa-github">&nbsp;</i>github</a>
        
          <a class="main-nav-link" href="http://tr.colobu.com"><i class="fa fa-spinner fa-pulse">&nbsp;</i>技术流</a>
        
          <a class="main-nav-link" href="/ScalaCollectionsCookbook"><i class="fa fa-book">&nbsp;</i>Scala集合技术手册</a>
        
          <a class="main-nav-link" href="/techreview"><i class="fa fa-newspaper-o">&nbsp;</i>技术快报</a>
        
          <a class="main-nav-link" href="/about"><i class="fa fa-lemon-o">&nbsp;</i>关于</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="http://www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
          <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="Search">
          <input type="submit" value="" class="search-form-submit">
          <input name=tn type=hidden value="bds">
          <input name=cl type=hidden value="3">
          <input name=ct type=hidden value="2097152">
          <input type="hidden" name="si" value="colobu.com">
        </form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-spark-standalone-mode" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/12/09/spark-standalone-mode/" class="article-date">
  <time datetime="2014-12-09T08:05:20.000Z" itemprop="datePublished">2014年12月09日</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/大数据/">大数据</a>
  </div>

	
  <div class="article-author"> by smallnest</div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Spark Standalone Mode
	  
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
	  
	    <h1 id="expanderHead" style="cursor:pointer;">
		目录 <span id="expanderSign">[−]</span>
		</h1>
	    <div id="article-entry-toc" data-role="collapsible" class="article-entry-toc">
		  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#在集群上安装Spark_Standalone"><span class="toc-text">在集群上安装Spark Standalone</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#手工启动集群"><span class="toc-text">手工启动集群</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#集群启动脚本"><span class="toc-text">集群启动脚本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#连接应用到集群"><span class="toc-text">连接应用到集群</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#启动编译的Spark应用"><span class="toc-text">启动编译的Spark应用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#资源调度"><span class="toc-text">资源调度</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#监控和日志"><span class="toc-text">监控和日志</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#和Hadoop集成"><span class="toc-text">和Hadoop集成</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#为网络安全配置端口"><span class="toc-text">为网络安全配置端口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#高可用"><span class="toc-text">高可用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用ZooKeeper建立master备用机"><span class="toc-text">使用ZooKeeper建立master备用机</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#简介"><span class="toc-text">简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#配置"><span class="toc-text">配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#细节"><span class="toc-text">细节</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用本地文件实现单节点恢复"><span class="toc-text">使用本地文件实现单节点恢复</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#简介-1"><span class="toc-text">简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#配置-1"><span class="toc-text">配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#细节-1"><span class="toc-text">细节</span></a></li></ol></li></ol></li></ol>
	    </div>
	  
	  
      
        <p>除了在Mesos或YARN集群管理器运行，Spark还提供了一个简单的独立部署模式。你可以手动启动一个独立的集群，通过手动启动master和worker，或使用我们提供的<a href="https://spark.apache.org/docs/latest/spark-standalone.html#cluster-launch-scripts" target="_blank" rel="external">启动脚本</a>。也可以在一台机器上运行这些守护进程进行测试，。</p>
<a id="more"></a>
<h2 id="在集群上安装Spark_Standalone">在集群上安装Spark Standalone</h2>
<p>要安装Spark独立模式，您只需将Spark的编译版本放到集群中的每个节点上。您可以获取Spark的每个编译版本或建立<a href="https://spark.apache.org/docs/latest/index.html#building" target="_blank" rel="external">自己编译</a>。</p>
<h2 id="手工启动集群">手工启动集群</h2>
<p>你可以通过下面的命令启动standalone master:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./sbin/start-master.sh</div></pre></td></tr></table></figure>

<p>一旦启动， master会打印出它的URL spark://HOST:PORT, worker可以用它连接master, 或者作为“master” 参数传给SparkContext. 你也可以在master的WEB UI上找到这个URL, WEB UI缺省地址是 <a href="http://localhost:8080" target="_blank" rel="external">http://localhost:8080</a> .</p>
<p>类似地, 你可以启动一个或多个worker,并连接到master:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./bin/spark-class org.apache.spark.deploy.worker.Worker spark://IP:PORT</div></pre></td></tr></table></figure>

<p>一旦你启动了worker, 你可以查看 master的 web UI (缺省是<a href="http://localhost:8080" target="_blank" rel="external">http://localhost:8080</a> )查看worker情况. 你会看到一个新的节点被列出来, 包括CPU核数和内存(减去为OS预留的1G).</p>
<p>(你可以访问worker的web UI了解它的执行情况， URL地址默认为http://<worker-hostname>:8081)</worker-hostname></p>
<p>下面的配置参数可以传给master和worker。</p>
<table>
<thead>
<tr>
<th><strong>参数</strong></th>
<th><strong>意义</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>-i IP, --ip IP</td>
<td>IP address or DNS name to listen on</td>
</tr>
<tr>
<td>-p PORT, --port PORT</td>
<td>Port for service to listen on (default: 7077 for master, random for worker)</td>
</tr>
<tr>
<td>--webui-port PORT</td>
<td>Port for web UI (default: 8080 for master, 8081 for worker)</td>
</tr>
<tr>
<td>-c CORES, --cores CORES</td>
<td>Total CPU cores to allow Spark applications to use on the machine (default: all available); only on worker</td>
</tr>
<tr>
<td>-m MEM, --memory MEM</td>
<td>Total amount of memory to allow Spark applications to use on the machine, in a format like 1000M or 2G (default: your machine&#39;s total RAM minus 1 GB); only on worker</td>
</tr>
<tr>
<td>-d DIR, --work-dir DIR</td>
<td>Directory to use for scratch space and job output logs (default: SPARK_HOME/work); only on worker</td>
</tr>
</tbody>
</table>
<h2 id="集群启动脚本">集群启动脚本</h2>
<p>要用启动脚本启动一个Spark standalone集群，你需要在Spark目录下创建一个名为conf/slaves，其中应该包含所有机器的主机名(hostname)，每行一个机器主机名。master必须能够通过无密码ssh访问每个从机（使用私钥）。为了进行测试，你可以把localhost加到这个文件中。</p>
<p>一旦创建好文件， 你就可以使用下面的shell脚本启动或者停止你的集群了。 这些脚本基于Hadoop的发布脚本， 可以在SPARK_HOME/bin找到:</p>
<ul>
<li><code>sbin/start-master.sh</code> - 在脚本执行的机器上启动master.</li>
<li><code>sbin/start-slaves.sh</code> - 启动conf/slaves 文件中配置的所有的slave.</li>
<li><code>sbin/start-all.sh</code> - 启动上面描述的master和salve.</li>
<li><code>sbin/stop-master.sh</code> - 停止bin/start-master.sh 脚本启动的master.</li>
<li><code>sbin/stop-slaves.sh</code> - 停止conf/slaves 文件中配置的slave.</li>
<li><code>sbin/stop-all.sh</code> - 停止上面描述的master和slave.</li>
</ul>
<p>注意这些脚本必须在你想运行的master机器上执行，而不是你的本地机。</p>
<p>你还可以通过在conf/spark-env.sh文件中设置环境变量来配置集群. 可以参考conf/spark-env.sh.template模版, 把它复制到你所有的worker机器上才起作用. 下面的设置项可用:</p>
<table>
<thead>
<tr>
<th><strong>环境变量</strong></th>
<th><strong>意义</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>SPARK_MASTER_IP</td>
<td>Bind the master to a specific IP address, for example a public one.</td>
</tr>
<tr>
<td>SPARK_MASTER_PORT</td>
<td>Start the master on a different port (default: 7077).</td>
</tr>
<tr>
<td>SPARK_MASTER_WEBUI_PORT</td>
<td>Port for the master web UI (default: 8080).</td>
</tr>
<tr>
<td>SPARK_MASTER_OPTS</td>
<td>Configuration properties that apply only to the master in the form &quot;-Dx=y&quot; (default: none). See below for a list of possible options.</td>
</tr>
<tr>
<td>SPARK_LOCAL_DIRS</td>
<td>Directory to use for &quot;scratch&quot; space in Spark, including map output files and RDDs that get stored on disk. This should be on a fast, local disk in your system. It can also be a comma-separated list of multiple directories on different disks.</td>
</tr>
<tr>
<td>SPARK_WORKER_CORES</td>
<td>Total number of cores to allow Spark applications to use on the machine (default: all available cores).</td>
</tr>
<tr>
<td>SPARK_WORKER_MEMORY</td>
<td>Total amount of memory to allow Spark applications to use on the machine, e.g. 1000m, 2g (default: total memory minus 1 GB); note that each application&#39;s individual memory is configured using its spark.executor.memory property.</td>
</tr>
<tr>
<td>SPARK_WORKER_PORT</td>
<td>Start the Spark worker on a specific port (default: random).</td>
</tr>
<tr>
<td>SPARK_WORKER_WEBUI_PORT</td>
<td>Port for the worker web UI (default: 8081).</td>
</tr>
<tr>
<td>SPARK_WORKER_INSTANCES</td>
<td>Number of worker instances to run on each machine (default: 1). You can make this more than 1 if you have have very large machines and would like multiple Spark worker processes. If you do set this, make sure to also set SPARK_WORKER_CORES explicitly to limit the cores per worker, or else each worker will try to use all the cores.</td>
</tr>
<tr>
<td>SPARK_WORKER_DIR</td>
<td>Directory to run applications in, which will include both logs and scratch space (default: SPARK_HOME/work).</td>
</tr>
<tr>
<td>SPARK_WORKER_OPTS</td>
<td>Configuration properties that apply only to the worker in the form &quot;-Dx=y&quot; (default: none). See below for a list of possible options.</td>
</tr>
<tr>
<td>SPARK_DAEMON_MEMORY</td>
<td>Memory to allocate to the Spark master and worker daemons themselves (default: 512m).</td>
</tr>
<tr>
<td>SPARK_DAEMON_JAVA_OPTS</td>
<td>JVM options for the Spark master and worker daemons themselves in the form &quot;-Dx=y&quot; (default: none).</td>
</tr>
<tr>
<td>SPARK_PUBLIC_DNS</td>
<td>The public DNS name of the Spark master and workers (default: none).</td>
</tr>
</tbody>
</table>
<p><strong>注意</strong>: 当前的启动脚本不支持Windows. 如果想在Windows运行 Spark集群,你需要手工启动master 和 worker.</p>
<p>SPARK_MASTER_OPTS 支持下面的系统属性:</p>
<table>
<thead>
<tr>
<th><strong>属性名</strong></th>
<th><strong>默认值</strong></th>
<th><strong>意义</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>spark.deploy.retainedApplications</td>
<td>200</td>
<td>The maximum number of completed applications to display. Older applications will be dropped from the UI to maintain this limit.</td>
</tr>
<tr>
<td>spark.deploy.retainedDrivers</td>
<td>200</td>
<td>The maximum number of completed drivers to display. Older drivers will be dropped from the UI to maintain this limit.</td>
</tr>
<tr>
<td>spark.deploy.spreadOut</td>
<td>true</td>
<td>Whether the standalone cluster manager should spread applications out across nodes or try to consolidate them onto as few nodes as possible. Spreading out is usually better for data locality in HDFS, but consolidating is more efficient for compute-intensive workloads.</td>
</tr>
<tr>
<td>spark.deploy.defaultCores</td>
<td>(infinite)</td>
<td>Default number of cores to give to applications in Spark&#39;s standalone mode if they don&#39;t set</td>
<td>spark.cores.max. If not set, applications always get all available cores unless they configure spark.cores.max themselves. Set this lower on a shared cluster to prevent users from grabbing the whole cluster by default.</td>
</tr>
<tr>
<td>spark.worker.timeout</td>
<td>60</td>
<td>Number of seconds after which the standalone deploy master considers a worker lost if it receives no heartbeats.</td>
</tr>
</tbody>
</table>
<p>SPARK_WORKER_OPTS 支持下面的系统属性:</p>
<table>
<thead>
<tr>
<th><strong>属性名</strong></th>
<th><strong>默认值</strong></th>
<th><strong>意义</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>spark.worker.cleanup.enabled</td>
<td>false</td>
<td>Enable periodic cleanup of worker / application directories. Note that this only affects standalone mode, as YARN works differently. Applications directories are cleaned up regardless of whether the application is still running.</td>
</tr>
<tr>
<td>spark.worker.cleanup.interval</td>
<td>1800 (30 minutes)</td>
<td>Controls the interval, in seconds, at which the worker cleans up old application work dirs on the local machine.</td>
</tr>
<tr>
<td>spark.worker.cleanup.appDataTtl</td>
<td>7 <em> 24 </em> 3600 (7 days)</td>
<td>The number of seconds to retain application work directories on each worker. This is a Time To Live and should depend on the amount of available disk space you have. Application logs and jars are downloaded to each application work dir. Over time, the work dirs can quickly fill up disk space, especially if you run jobs very frequently.</td>
</tr>
</tbody>
</table>
<h2 id="连接应用到集群">连接应用到集群</h2>
<p>为了在集群中运行应用, 只需简单传master的 spark://IP:PORT 给SparkContext的构造函数.</p>
<p>为了在集群中运行交互式的Spark shell, 运行下面的命令:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./bin/spark-shell --master spark://IP:PORT</div></pre></td></tr></table></figure>

<p>你也可以传参数<em>--total-executor-cores <numcores></numcores></em>来控制spark-shell使用的集群的核数.</p>
<h2 id="启动编译的Spark应用">启动编译的Spark应用</h2>
<p>spark-submit脚本提供了最直接的方式来提交一个编译的应用到集群中。 对于standalone集群， Spark目前支持两种部署模式。在client模式中，该驱动程序在提交应用的客户端同一进程中启动。然而在集群模式下，驱动是从集群中的的一个worker进程中的启动，客户端只要它完成提交申请就退出， 无需等待应用程序完成。</p>
<p>如果你的应用程序是通过Spark submit启动，那么应用程序的jar会自动分发到所有工作节点。对于任何你的应用依赖的其它的jar，你应该使用逗号作为分隔符通过--jars标志指定它们（如--jars jar1，jar2）。为了控制应用程序的配置或者执行环境，请参照<a href="https://spark.apache.org/docs/latest/configuration.html" target="_blank" rel="external">Spark配置</a>。</p>
<h2 id="资源调度">资源调度</h2>
<p>独立集群模式目前只支持跨应用程序的简单FIFO调度。然而，为了允许多个并发用户，你可以控制每个应用使用的资源的最大数。默认情况下，它会请求使用集群的全部的核。 如果你同时只运行一个应用程序这才有意义。可以在SparkConf中设置spark.cores.max核心数。例如：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">val</span> conf = <span class="keyword">new</span> SparkConf()</div><div class="line">             .setMaster(...)</div><div class="line">             .setAppName(...)</div><div class="line">             .set(<span class="string">"spark.cores.max"</span>, <span class="string">"10"</span>)</div><div class="line"><span class="keyword">val</span> sc = <span class="keyword">new</span> SparkContext(conf)</div></pre></td></tr></table></figure>

<p>另外， 你可以在集群的master进程中配置spark.deploy.defaultCores, 这会改变没有设置spark.cores.max应用程序使用的缺省值。 在conf/spark-env.sh增加:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> SPARK_MASTER_OPTS=<span class="string">"-Dspark.deploy.defaultCores=&lt;value&gt;"</span></div></pre></td></tr></table></figure>

<p>在共享集群的环境下当用户没有独自配置最大核数时这个参数很有用.</p>
<h2 id="监控和日志">监控和日志</h2>
<p>Spark standalone模式提供了一个web 接口，可以监控集群。 master和worker都有它们自己的web UI用来显示culster统计信息和job统计信息。 默认情况下master WEB UI使用8080端口， 这个端口可以在配置文件中修改，或者在命令行中传入.</p>
<p>另外， 每个job的详细日志也会写入到每个slave节点的work文件夹 (缺省为SPARK_HOME/work). 你会看到每个job有两个文件， stdout 和 stderr。 所有的输出写入到它们的控制台.</p>
<h2 id="和Hadoop集成">和Hadoop集成</h2>
<p>你可以将Spark运行在Hadoop集群上， 只需在相同的机器上把它启动为一个服务。 如果想访问Hadoop的数据， 只需使用hdfs:// URL (典型地 hdfs://<namenode>:9000/path, 你可以在你的Hadoop Namenode服务器的web UI上找到正确的地址). 或者， 你可以为Spark设置一个独立的集群， 仍然通过网络访问HDFS; 这会比本地磁盘访问要慢， 但是如果集群仍然在同一个局域网中这可能不会是一个问题 (比如你将Spark机器放在Haddop的机架上).</namenode></p>
<h2 id="为网络安全配置端口">为网络安全配置端口</h2>
<p>Spark非常引来网络， 有严格的防火墙设置需求。 它的网络端口列表可以参考 <a href="https://spark.apache.org/docs/latest/security.html#configuring-ports-for-network-security" target="_blank" rel="external">security page.</a>.</p>
<h2 id="高可用">高可用</h2>
<p>缺省情况下， standalone scheduling cluster容忍worker失败 （在这种情况下它可以将失败的任务转移给其它的worker）。 但是， 调度器使用master来做调度决定， 这会产生一个单点失败： 如果master崩溃，新的应用不会被创建。为了解决这个问题， 我们有两种高可用的解决方案，细节如下：</p>
<h3 id="使用ZooKeeper建立master备用机">使用ZooKeeper建立master备用机</h3>
<h4 id="简介">简介</h4>
<p>ZooKeeper提供了leader选举和状态存储, 所以你可以在集群中启动多个Master，并连接到同一个ZooKeeper实例。 总有一个会被选为“leader” ，其它的作为standby. 如果当前的leader死了， 另一个master会被选举出来， 恢复老的master的状态， 继续调度. 整个恢复过程(从第一个leader宕机开始) 应该只花费一两分钟。 注意这只会延迟新的应用。 已经运行的应用不受影响.</p>
<p>可以查看 <a href="http://zookeeper.apache.org/doc/trunk/zookeeperStarted.html" target="_blank" rel="external">ZooKeeper</a>文档.</p>
<h4 id="配置">配置</h4>
<p>为了使用这种模式, 需要社会资 spark-env中的SPARK_DAEMON_JAVA_OPTS 参数， 参数值可以为以下的选项:</p>
<table>
<thead>
<tr>
<th><strong>系统属性</strong></th>
<th><strong>意义</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>spark.deploy.recoveryMode</td>
<td>Set to ZOOKEEPER to enable standby Master recovery mode (default: NONE).</td>
</tr>
<tr>
<td>spark.deploy.zookeeper.url</td>
<td>The ZooKeeper cluster url (e.g., 192.168.1.100:2181,192.168.1.101:2181).</td>
</tr>
<tr>
<td>spark.deploy.zookeeper.dir</td>
<td>The directory in ZooKeeper to store recovery state (default: /spark).</td>
</tr>
</tbody>
</table>
<p>或许你已经知道: 如果你的集群有多个matser，但是未能正确master使用Zookeeper， master不能相互知道对方，所以它们认为自己都是leader。 这不会导致很严重的集群问题， 所有的master都独立调度。</p>
<h4 id="细节">细节</h4>
<p>当你搭建好Zookeeper集群后， 使用高可用性非常简单。 简单的在不同的节点启动master进程，并使用Zookeeper配置 (ZooKeeper URL和目录)。 master可以随时增加或者移除。</p>
<p>为了调度一个新的应用或者增加新的worker到集群中，需要知道当前的leader的IP地址。 可以将master列表传入，就像以前只传一个master的信息。 例如， 你可以启动一个SparkContext，让它连接 spark://host1:port1,host2:port2. 这到让你的SparkContext尝试在这两个master上注册。 如果host1宕机，我们可以找到新的leader: host2.</p>
<p>&quot;在一个master上注册&quot;和正常操作有一个很重要的区别. 当启动时， 应用或者worker要能够发现lead master和在它上面注册。 纵然这是“in the system” (例如,存储在ZooKeeper). 当 failover发生时, 新的leader会联系先前注册的应用和worker，通知它们leader已改变,所以启动时它们甚至不需要知道新的master.</p>
<p>由于这个属性， 新的master可以随时加入。 你唯一需要担心的是新的应用和worker在新的master变成leader后能够发现它并在它上面注册。 一旦注册成功，就无需操劳了。</p>
<h3 id="使用本地文件实现单节点恢复">使用本地文件实现单节点恢复</h3>
<h4 id="简介-1">简介</h4>
<p>ZooKeeper 是最好的产品级的高可用方案, 但是如果你想在master宕机后重启它，  可以使用<strong>FILESYSTEM</strong>模式. 当应用和Worker注册时，它们将状态写入到提供的文件夹中。 当master进程重启时，可以根据这些状态恢复.</p>
<h4 id="配置-1">配置</h4>
<p>为了使用这种恢复模式， 设置spark-env的SPARK_DAEMON_JAVA_OPTS 参数:</p>
<table>
<thead>
<tr>
<th><strong>系统属性</strong></th>
<th><strong>意义</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>spark.deploy.recoveryMode</td>
<td>Set to FILESYSTEM to enable single-node recovery mode (default: NONE).</td>
</tr>
<tr>
<td>spark.deploy.recoveryDirectory</td>
<td>The directory in which Spark will store recovery state, accessible from the Master&#39;s perspective.</td>
</tr>
</tbody>
</table>
<h4 id="细节-1">细节</h4>
<ul>
<li>这个解决方案可以和进程监控/管理器合作， 比如<a href="http://mmonit.com/monit/" target="_blank" rel="external">monit</a>, 或者通过重启手工恢复.</li>
<li><p>尽管filesystem恢复模式看起来比直截了当没有做任何恢复要好，这种模式对某些开发或i这实现目的来讲可能不是最优的。特别是，通过stop-master.sh停止master不会清理其恢复状态，所以当你启动一个新的master，它会进入恢复模式。这可能会增加启动时间长达1分钟，如果它需要等待所有以前注册的worker/client超时的话。</p>
</li>
<li><p>虽然NFS目录不是正式支持的特性，你可以挂载NFS目录作为恢复目录。如果原始的master完全死掉， 你可以启动一个不同的节点作为master，这将正确地恢复所有以前注册的worker/应用程序（相当于Zookeeper恢复）。后续的应用程序为了注册， 将不得不找到新的master。</p>
</li>
</ul>
<p>翻译自 <a href="https://spark.apache.org/docs/latest/spark-standalone.html" target="_blank" rel="external">Spark Standalone Mode</a></p>

      
    </div>
    <footer class="article-footer">
	
<div class="bdsharebuttonbox"><a title="分享到新浪微博" class="bds_tsina" href="#" data-cmd="tsina"></a><a title="分享到微信" class="bds_weixin" href="#" data-cmd="weixin"></a><a title="分享到QQ空间" class="bds_qzone" href="#" data-cmd="qzone"></a><a title="分享到印象笔记" class="bds_evernotecn" href="#" data-cmd="evernotecn"></a><a title="分享到有道云笔记" class="bds_youdao" href="#" data-cmd="youdao"></a><a title="分享到百度云收藏" class="bds_bdysc" href="#" data-cmd="bdysc"></a><a class="bds_more" href="#" data-cmd="more"></a></div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>
      

	  
        <a href="http://colobu.com/2014/12/09/spark-standalone-mode/#comments" class="article-comment-link">评论</a>
      

      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spark/">Spark</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2014/12/10/spark-configuration/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Spark 配置指南
        
      </div>
    </a>
  
  
    <a href="/2014/12/09/spark-submitting-applications/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Spark 应用提交指南</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div class="ds-thread" data-thread-key="2014/12/09/spark-standalone-mode/" data-title="Spark Standalone Mode" data-url="http://colobu.com/2014/12/09/spark-standalone-mode/"></div>

</section>

</section>
        
          <aside id="sidebar">
  
      <div class="widget-wrap">
    <h3 class="widget-title">原创图书</h3>
    <div class="widget">
      <a href="/ScalaCollectionsCookbook/">
        <img width="100%" src="/ScalaCollectionsCookbook/scala_collections_cookbook.jpg">
        <img width="100%" src="/ScalaCollectionsCookbook/scala_collections_cookbook_tw.png">
      </a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/DOTNET/">DOTNET</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Go/">Go</a><span class="category-list-count">57</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">58</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Scala/">Scala</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端开发/">前端开发</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/大数据/">大数据</a><span class="category-list-count">55</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工具/">工具</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/架构/">架构</a><span class="category-list-count">21</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/管理/">管理</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络编程/">网络编程</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/读书笔记/">读书笔记</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/运维/">运维</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/高并发编程/">高并发编程</a><span class="category-list-count">20</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/Android/" style="font-size: 15.71px;">Android</a><a href="/tags/ApacheBench/" style="font-size: 11.43px;">ApacheBench</a><a href="/tags/Bower/" style="font-size: 10.00px;">Bower</a><a href="/tags/C/" style="font-size: 10.00px;">C#</a><a href="/tags/CDN/" style="font-size: 10.00px;">CDN</a><a href="/tags/CQRS/" style="font-size: 10.00px;">CQRS</a><a href="/tags/CRC/" style="font-size: 10.00px;">CRC</a><a href="/tags/CSS/" style="font-size: 11.43px;">CSS</a><a href="/tags/CompletableFuture/" style="font-size: 10.00px;">CompletableFuture</a><a href="/tags/Comsat/" style="font-size: 10.00px;">Comsat</a><a href="/tags/Curator/" style="font-size: 20.00px;">Curator</a><a href="/tags/DSL/" style="font-size: 10.00px;">DSL</a><a href="/tags/Disruptor/" style="font-size: 10.00px;">Disruptor</a><a href="/tags/Docker/" style="font-size: 11.43px;">Docker</a><a href="/tags/Ember/" style="font-size: 11.43px;">Ember</a><a href="/tags/FastJson/" style="font-size: 10.00px;">FastJson</a><a href="/tags/Fiber/" style="font-size: 10.00px;">Fiber</a><a href="/tags/GAE/" style="font-size: 10.00px;">GAE</a><a href="/tags/GC/" style="font-size: 12.86px;">GC</a><a href="/tags/Gnuplot/" style="font-size: 10.00px;">Gnuplot</a><a href="/tags/Go/" style="font-size: 11.43px;">Go</a><a href="/tags/Gradle/" style="font-size: 10.00px;">Gradle</a><a href="/tags/Grunt/" style="font-size: 10.00px;">Grunt</a><a href="/tags/Gulp/" style="font-size: 10.00px;">Gulp</a><a href="/tags/Hadoop/" style="font-size: 10.00px;">Hadoop</a><a href="/tags/Hazelcast/" style="font-size: 10.00px;">Hazelcast</a><a href="/tags/Ignite/" style="font-size: 10.00px;">Ignite</a><a href="/tags/JVM/" style="font-size: 10.00px;">JVM</a><a href="/tags/Java/" style="font-size: 17.14px;">Java</a><a href="/tags/Kafka/" style="font-size: 18.57px;">Kafka</a><a href="/tags/Lambda/" style="font-size: 14.29px;">Lambda</a><a href="/tags/Linux/" style="font-size: 12.86px;">Linux</a><a href="/tags/LongAdder/" style="font-size: 10.00px;">LongAdder</a><a href="/tags/MathJax/" style="font-size: 10.00px;">MathJax</a><a href="/tags/Maven/" style="font-size: 11.43px;">Maven</a><a href="/tags/Memcached/" style="font-size: 10.00px;">Memcached</a><a href="/tags/Metrics/" style="font-size: 10.00px;">Metrics</a><a href="/tags/Mongo/" style="font-size: 12.86px;">Mongo</a><a href="/tags/Netty/" style="font-size: 15.71px;">Netty</a><a href="/tags/Node/" style="font-size: 10.00px;">Node</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">July 2015</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">June 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">May 2015</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">April 2015</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">March 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/02/">February 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">January 2015</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">December 2014</a><span class="archive-list-count">28</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/11/">November 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/10/">October 2014</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">September 2014</a><span class="archive-list-count">28</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">August 2014</a><span class="archive-list-count">19</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/07/">July 2014</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">近期文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/02/22/HTTP-Response-Snippets-for-Go/">[译]Go HTTTP Response代码片段</a>
          </li>
        
          <li>
            <a href="/2017/02/07/write-idiomatic-golang-codes/">编写地道的Go代码</a>
          </li>
        
          <li>
            <a href="/2017/02/01/golang-summaries/">Golang 知识点总结</a>
          </li>
        
          <li>
            <a href="/2017/01/26/A-Guide-To-The-Kafka-Protocol/">Kafka通讯协议指南</a>
          </li>
        
          <li>
            <a href="/2017/01/26/how-to-go-get-behind-GFW/">如何在长城后面go get一些库</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">友情链接</h3>
    <div class="widget">
      <ul>
        
          <li>
			 
            <a href="http://old.colobu.com" target="_blank">旧的博客</a>
			
          </li>
        
          <li>
			 
			&nbsp;
			
          </li>
        
          <li>
			 
            <a href="http://stackshare.io" target="_blank">技术栈</a>
			
          </li>
        
          <li>
			 
			&nbsp;
			
          </li>
        
          <li>
			 
            <a href="http://weekly.manong.io/issues/" target="_blank">码农周刊</a>
			
          </li>
        
          <li>
			 
            <a href="http://www.tuicool.com/mags" target="_blank">编程狂人周刊</a>
			
          </li>
        
          <li>
			 
            <a href="http://www.importnew.com/" target="_blank">importnew</a>
			
          </li>
        
          <li>
			 
            <a href="http://ifeve.com/" target="_blank">并发编程网</a>
			
          </li>
        
          <li>
			 
			&nbsp;
			
          </li>
        
          <li>
			 
            <a href="http://github.com" target="_blank">github</a>
			
          </li>
        
          <li>
			 
            <a href="http://stackoverflow.com/" target="_blank">stackoverflow</a>
			
          </li>
        
          <li>
			 
            <a href="http://www.javacodegeeks.com/" target="_blank">javacodegeeks</a>
			
          </li>
        
          <li>
			 
            <a href="http://www.infoq.com/" target="_blank">infoq</a>
			
          </li>
        
          <li>
			 
            <a href="http://www.dzone.com/links/index.html" target="_blank">dzone</a>
			
          </li>
        
          <li>
			 
            <a href="https://oj.leetcode.com/problems/" target="_blank">leetcode</a>
			
          </li>
        
          <li>
			 
			&nbsp;
			
          </li>
        
          <li>
			 
            <a href="http://www.503error.com/" target="_blank">503error</a>
			
          </li>
        
      </ul>
    </div>
  </div>

  
      <div class="widget-wrap">
    <h3 class="widget-title">热评文章</h3>
    <div class="widget">
		<div class="ds-top-threads" data-range="monthly" data-num-items="5"></div>
    </div>
  </div>

  
      <div class="widget-wrap">
    <h3 class="widget-title">最新评论</h3>
    <div class="widget">
		<ul class="ds-recent-comments" data-num-items="10" data-show-avatars="1" data-show-time="1" data-show-admin="1" data-excerpt-length="70"></ul>
		<script type="text/javascript">
		var duoshuoQuery = {short_name:"colobu"};
		(function() {
			var ds = document.createElement('script');
			ds.type = 'text/javascript';ds.async = true;
			ds.src = 'http://static.duoshuo.com/embed.js';
			ds.charset = 'UTF-8';
			(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
		})();
		</script>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 smallnest<br>
	  Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
    <a href="https://github.com/smallnest" class="mobile-nav-link">github</a>
  
    <a href="http://tr.colobu.com" class="mobile-nav-link">技术流</a>
  
    <a href="/ScalaCollectionsCookbook" class="mobile-nav-link">Scala集合技术手册</a>
  
    <a href="/techreview" class="mobile-nav-link">技术快报</a>
  
    <a href="/about" class="mobile-nav-link">关于</a>
  
</nav>
    
<script src="//cdn.staticfile.org/jquery/1.11.1/jquery.min.js"></script>
<script src="//cdn.bootcss.com/jquery.lazyload/1.9.1/jquery.lazyload.min.js"></script>

<script src="//libs.cncdn.cn/fancybox/2.1.5/jquery.fancybox.pack.js"></script>


<script src="/js/script.js" type="text/javascript"></script>

<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
  });
  MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>
<script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.6.0-beta.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

<div id="totop" style="position:fixed;bottom:150px;right:10px;cursor: pointer;z-index: 2000;">
	<a title="返回顶部"><img src="/images/scrollup.png"/></a>
</div>
<script src="/js/totop.js" type="text/javascript"></script>



<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-142561-4']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>


<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e085d87993250aab11f3e0c15f1c2785";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


  </div>
</body>
</html>