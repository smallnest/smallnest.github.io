<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Java 8 Lambda 揭秘 | 鸟窝</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="再了解了Java 8 Lambda的一些基本概念和应用后， 我们会有这样的一个问题: Lambda表达式被编译成了什么？。 这是一个有趣的问题，涉及到JDK的具体的实现。 本文将介绍OpenJDK对Lambda表达式的转换细节， 读者可以了解Java 8 Lambda表达式背景知识。">
<meta property="og:type" content="article">
<meta property="og:title" content="Java 8 Lambda 揭秘">
<meta property="og:url" content="http://colobu.com/2014/11/06/secrets-of-java-8-lambda/">
<meta property="og:site_name" content="鸟窝">
<meta property="og:description" content="再了解了Java 8 Lambda的一些基本概念和应用后， 我们会有这样的一个问题: Lambda表达式被编译成了什么？。 这是一个有趣的问题，涉及到JDK的具体的实现。 本文将介绍OpenJDK对Lambda表达式的转换细节， 读者可以了解Java 8 Lambda表达式背景知识。">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Java 8 Lambda 揭秘">
<meta name="twitter:description" content="再了解了Java 8 Lambda的一些基本概念和应用后， 我们会有这样的一个问题: Lambda表达式被编译成了什么？。 这是一个有趣的问题，涉及到JDK的具体的实现。 本文将介绍OpenJDK对Lambda表达式的转换细节， 读者可以了解Java 8 Lambda表达式背景知识。">

  
    <link rel="alternative" href="/atom.xml" title="鸟窝" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">

  <link href="//cdn.staticfile.org/font-awesome/4.2.0/css/font-awesome.css" rel="stylesheet">
  
  <link rel="stylesheet" href="//libs.cncdn.cn/fancybox/2.1.5/jquery.fancybox.css" media="screen" type="text/css">
  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//cdn.staticfile.org/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->

  <script type="text/javascript">
	//visit my previous blog: http://old.colobu.com just like this http://colobu.com/?=123456
    var blog_url = location.href.toString();
	if (blog_url.indexOf("http://colobu.com/?p=") >= 0) {
		blog_url = blog_url.replace("colobu.com", "old.colobu.com");
		window.location.assign(blog_url);
	} else if (blog_url.indexOf("http://smallnest.gitcafe.com") >= 0) {
		blog_url = blog_url.replace("smallnest.gitcafe.com", "colobu.com");
		window.location.assign(blog_url);
	}  else if (blog_url.indexOf("http://smallnest.gitcafe.io") >= 0) {
		blog_url = blog_url.replace("smallnest.gitcafe.io", "colobu.com");
		window.location.assign(blog_url);
	}
</script>
  <style type="text/css">
    .news-essay
    {
      display: inline !important;
    }
    .hot-news
    {
      text-align: left !important;
    }
  </style>
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap" class="animated bounceInLeft">
        <a href="/" id="logo">鸟窝</a>
      </h1>
      
        <h2 id="subtitle-wrap" class="animated bounceInLeft">
          <a href="/" id="subtitle">大道至简 Simplicity is the ultimate form of sophistication</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/"><i class="fa fa-home">&nbsp;</i>首页</a>
        
          <a class="main-nav-link" href="/archives"><i class="fa fa-folder-o">&nbsp;</i>归档</a>
        
          <a class="main-nav-link" href="https://github.com/smallnest"><i class="fa fa-github">&nbsp;</i>github</a>
        
          <a class="main-nav-link" href="http://tr.colobu.com"><i class="fa fa-spinner fa-pulse">&nbsp;</i>技术流</a>
        
          <a class="main-nav-link" href="/ScalaCollectionsCookbook"><i class="fa fa-book">&nbsp;</i>Scala集合技术手册</a>
        
          <a class="main-nav-link" href="/techreview"><i class="fa fa-newspaper-o">&nbsp;</i>技术快报</a>
        
          <a class="main-nav-link" href="/about"><i class="fa fa-lemon-o">&nbsp;</i>关于</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="http://www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
          <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="Search">
          <input type="submit" value="" class="search-form-submit">
          <input name=tn type=hidden value="bds">
          <input name=cl type=hidden value="3">
          <input name=ct type=hidden value="2097152">
          <input type="hidden" name="si" value="colobu.com">
        </form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-secrets-of-java-8-lambda" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/11/06/secrets-of-java-8-lambda/" class="article-date">
  <time datetime="2014-11-06T02:48:39.000Z" itemprop="datePublished">2014年11月06日</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Java/">Java</a>
  </div>

	
  <div class="article-author"> by smallnest</div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Java 8 Lambda 揭秘
	  
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
	  
	    <h1 id="expanderHead" style="cursor:pointer;">
		目录 <span id="expanderSign">[−]</span>
		</h1>
	    <div id="article-entry-toc" data-role="collapsible" class="article-entry-toc">
		  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Lambda表达式的转换策略"><span class="toc-text">Lambda表达式的转换策略</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#转换举例"><span class="toc-text">转换举例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LambdaMetafactory-metafactory"><span class="toc-text">LambdaMetafactory.metafactory</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#重复的lambda表达式"><span class="toc-text">重复的lambda表达式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#生成的类名"><span class="toc-text">生成的类名</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#直接调用生成的方法"><span class="toc-text">直接调用生成的方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#捕获的变量等价于'final'"><span class="toc-text">捕获的变量等价于'final'</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#方法引用"><span class="toc-text">方法引用</span></a></li></ol>
	    </div>
	  
	  
      
        <p>再了解了Java 8 Lambda的一些基本概念和应用后， 我们会有这样的一个问题: <em>Lambda表达式被编译成了什么？</em>。 这是一个有趣的问题，涉及到JDK的具体的实现。 本文将介绍OpenJDK对Lambda表达式的转换细节， 读者可以了解Java 8 Lambda表达式背景知识。<br><a id="more"></a></p>
<h2 id="Lambda表达式的转换策略">Lambda表达式的转换策略</h2>
<p><a href="https://www.google.com.hk/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=1&amp;cad=rja&amp;uact=8&amp;ved=0CB0QFjAA&amp;url=%68%74%74%70%73%3a%2f%2f%74%77%69%74%74%65%72%2e%63%6f%6d%2f%42%72%69%61%6e%47%6f%65%74%7a&amp;ei=9v9aVJCEGcn28QXsrIHwBQ&amp;usg=AFQjCNHu9y69SvQVsjuMqyBv3PMELARZ5Q&amp;bvm=bv.78677474,d.dGc" target="_blank" rel="external">Brian Goetz</a>是Oracle的Java语言架构师， JSR 335(Lambda Expression)规范的lead, 写了几篇Lambda设计方面的文章， 其中之一就是<a href="http://cr.openjdk.java.net/~briangoetz/lambda/lambda-translation.html" target="_blank" rel="external">Translation of Lambda Expressions</a>。 这篇文章介绍了Java 8 Lambda设计时的考虑以及实现方法。</p>
<p>他提到， Lambda表达式可以通过内部类， method handle, dynamic proxy等方式实现， 但是这些方法各有优劣。 真正要实现Lambda表达式， 必须兼顾两个目标： 一是不引入特定策略，以期为将来的优化提供最大的灵活性， 二是保持类文件格式的稳定。 通过Java 7中引入的<strong>invokedynamic</strong> （<a href="https://jcp.org/en/jsr/detail?id=292" target="_blank" rel="external">JSR 292</a>）, 可以很好的兼顾这两个目标。</p>
<p><strong>invokedynamic</strong> 在缺乏静态类型信息的情况下可以支持有效的灵活的方法调用。主要是为了日益增长的运行在JVM上的动态类型语言， 如Groovy, JRuby。<br><strong>invokedynamic</strong>将Lambda表达式的转换策略推迟到运行时， 这也意味着我们现在编译的代码在将来的转换策略改变的情况下也能正常运行。<br>编译器在编译的时候， 会将Lambda表达式的表达式体 (lambda body)脱糖(desugar) 成一个方法，此方法的参数列表和返回类型和lambda表达式一致， 如果有捕获参数， 脱糖的方法的参数可能会更多一些， 并会产生一个<strong>invokedynamic</strong>调用， 调用一个call site。 这个call site被调用时会返回lambda表达式的目标类型(functional interface)的一个实现类。 这个call site称为这个lambda表达式的<em>lambda factory</em>。 <em>lambda factory</em>的bootstrap方法是一个标准方法， 叫做<em>lambda metafactory</em>。</p>
<p>编译器在转换lambda表达式时， 可以推断出表达式的参数类型，返回类型以及异常， 称之为<code>natural signature</code>， 我们将目标类型的方法签名称之为<code>lambda descriptor</code>, lambda factory的返回对象实现了函数式接口， 并且关联的表达式的代码逻辑， 称之为<code>lambda object</code>。</p>
<h2 id="转换举例">转换举例</h2>
<p>以上的解释有点晦涩， 简单来说</p>
<ul>
<li>编译时<ul>
<li>Lambda 表达式会生成一个方法， 方法实现了表达式的代码逻辑</li>
<li>生成invokedynamic指令， 调用bootstrap方法， 由java.lang.invoke.LambdaMetafactory.metafactory方法实现</li>
</ul>
</li>
<li>运行时<ul>
<li>invokedynamic指令调用metafactory方法。 它会返回一个CallSite, 此CallSite返回目标类型的一个匿名实现类， 此类关联编译时产生的方法</li>
<li>lambda表达式调用时会调用匿名实现类关联的方法。</li>
</ul>
</li>
</ul>
<p>最简单的一个lambda表达式的例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Lambda1</span> </span>{</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span>(String[] args) {</div><div class="line">		Consumer&lt;String&gt; c = s -&gt; System.out.println(s);</div><div class="line">		c.accept(<span class="string">"hello lambda"</span>);</div><div class="line">	}</div><div class="line"></div><div class="line">}</div></pre></td></tr></table></figure>

<p>使用javap查看生成的字节码 <code>javap -c -p -v com/colobu/lambda/chapter5/Lambda1.class</code>:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor">[</span>root@colobu bin<span class="preprocessor">]</span><span class="markup"># javap -c -p -v com/colobu/lambda/chapter5/Lambda1.class </span></div><div class="line">Classfile /mnt/eclipse/Lambda/bin/com/colobu/lambda/chapter5/Lambda1.class</div><div class="line">  Last modified Nov 6, 2014; size 1401 bytes</div><div class="line">  MD5 checksum fe2b2d3f039a9ba4209c488a8c4b4ea8</div><div class="line">  Compiled from "Lambda1.java"</div><div class="line">public class com.colobu.lambda.chapter5.Lambda1</div><div class="line">  SourceFile: "Lambda1.java"</div><div class="line">  BootstrapMethods:</div><div class="line">    0: #57 invokestatic java/lang/invoke/LambdaMetafactory.metafactory:(Ljava/lang/invoke/MethodHandles$Lookup;Ljava/lang/String;Ljava/lang/invoke/MethodType;Ljava/lang/invoke/MethodType;Ljava/lang/invoke/MethodHandle;Ljava/lang/invoke/MethodType;)Ljava/lang/invoke/CallSite;</div><div class="line">      Method arguments:</div><div class="line">        #58 (Ljava/lang/Object;)V</div><div class="line">        #61 invokestatic com/colobu/lambda/chapter5/Lambda1.lambda$0:(Ljava/lang/String;)V</div><div class="line">        #62 (Ljava/lang/String;)V</div><div class="line">  InnerClasses:</div><div class="line">       public static final #68= #64 of #66; //Lookup=class java/lang/invoke/MethodHandles$Lookup of class java/lang/invoke/MethodHandles</div><div class="line">  minor version: 0</div><div class="line">  major version: 52</div><div class="line">  flags: ACC_PUBLIC, ACC_SUPER</div><div class="line">Constant pool:</div><div class="line">   #1 = Class              #2             //  com/colobu/lambda/chapter5/Lambda1</div><div class="line">   #2 = Utf8               com/colobu/lambda/chapter5/Lambda1</div><div class="line">   #3 = Class              #4             //  java/lang/Object</div><div class="line">   #4 = Utf8               java/lang/Object</div><div class="line">   #5 = Utf8               &lt;init&gt;</div><div class="line">   #6 = Utf8               ()V</div><div class="line">   #7 = Utf8               Code</div><div class="line">   #8 = Methodref          #3.#9          //  java/lang/Object."&lt;init&gt;":()V</div><div class="line">   #9 = NameAndType        #5:#6          //  "&lt;init&gt;":()V</div><div class="line">  #10 = Utf8               LineNumberTable</div><div class="line">  #11 = Utf8               LocalVariableTable</div><div class="line">  #12 = Utf8               this</div><div class="line">  #13 = Utf8               Lcom/colobu/lambda/chapter5/Lambda1;</div><div class="line">  #14 = Utf8               main</div><div class="line">  #15 = Utf8               (<span class="preprocessor">[</span>Ljava/lang/<span class="built_in">String</span>;)V</div><div class="line">  <span class="variable">#16</span> <span class="subst">=</span> NameAndType        <span class="variable">#17</span>:<span class="variable">#18</span>        <span class="comment">//  accept:()Ljava/util/function/Consumer;</span></div><div class="line">  <span class="variable">#17</span> <span class="subst">=</span> Utf8               accept</div><div class="line">  <span class="variable">#18</span> <span class="subst">=</span> Utf8               ()Ljava/util/function/Consumer;</div><div class="line">  <span class="variable">#19</span> <span class="subst">=</span> InvokeDynamic      <span class="variable">#0</span>:<span class="variable">#16</span>         <span class="comment">//  #0:accept:()Ljava/util/function/Consumer;</span></div><div class="line">  <span class="variable">#20</span> <span class="subst">=</span> <span class="built_in">String</span>             <span class="variable">#21</span>            <span class="comment">//  hello lambda</span></div><div class="line">  <span class="variable">#21</span> <span class="subst">=</span> Utf8               hello lambda</div><div class="line">  <span class="variable">#22</span> <span class="subst">=</span> InterfaceMethodref <span class="variable">#23</span><span class="built_in">.</span><span class="variable">#25</span>        <span class="comment">//  java/util/function/Consumer.accept:(Ljava/lang/Object;)V</span></div><div class="line">  <span class="variable">#23</span> <span class="subst">=</span> Class              <span class="variable">#24</span>            <span class="comment">//  java/util/function/Consumer</span></div><div class="line">  <span class="variable">#24</span> <span class="subst">=</span> Utf8               java/util/function/Consumer</div><div class="line">  <span class="variable">#25</span> <span class="subst">=</span> NameAndType        <span class="variable">#17</span>:<span class="variable">#26</span>        <span class="comment">//  accept:(Ljava/lang/Object;)V</span></div><div class="line">  <span class="variable">#26</span> <span class="subst">=</span> Utf8               (Ljava/lang/Object;)V</div><div class="line">  <span class="variable">#27</span> <span class="subst">=</span> Utf8               args</div><div class="line">  <span class="variable">#28</span> <span class="subst">=</span> Utf8               <span class="preprocessor">[</span>Ljava/lang/<span class="built_in">String</span>;</div><div class="line">  <span class="variable">#29</span> <span class="subst">=</span> Utf8               c</div><div class="line">  <span class="variable">#30</span> <span class="subst">=</span> Utf8               Ljava/util/function/Consumer;</div><div class="line">  <span class="variable">#31</span> <span class="subst">=</span> Utf8               LocalVariableTypeTable</div><div class="line">  <span class="variable">#32</span> <span class="subst">=</span> Utf8               Ljava/util/function/Consumer<span class="subst">&lt;</span>Ljava/lang/<span class="built_in">String</span>;<span class="subst">&gt;</span>;</div><div class="line">  <span class="variable">#33</span> <span class="subst">=</span> Utf8               lambda$<span class="number">0</span></div><div class="line">  <span class="variable">#34</span> <span class="subst">=</span> Utf8               (Ljava/lang/<span class="built_in">String</span>;)V</div><div class="line">  <span class="variable">#35</span> <span class="subst">=</span> Fieldref           <span class="variable">#36</span><span class="built_in">.</span><span class="variable">#38</span>        <span class="comment">//  java/lang/System.out:Ljava/io/PrintStream;</span></div><div class="line">  <span class="variable">#36</span> <span class="subst">=</span> Class              <span class="variable">#37</span>            <span class="comment">//  java/lang/System</span></div><div class="line">  <span class="variable">#37</span> <span class="subst">=</span> Utf8               java/lang/System</div><div class="line">  <span class="variable">#38</span> <span class="subst">=</span> NameAndType        <span class="variable">#39</span>:<span class="variable">#40</span>        <span class="comment">//  out:Ljava/io/PrintStream;</span></div><div class="line">  <span class="variable">#39</span> <span class="subst">=</span> Utf8               out</div><div class="line">  <span class="variable">#40</span> <span class="subst">=</span> Utf8               Ljava/io/PrintStream;</div><div class="line">  <span class="variable">#41</span> <span class="subst">=</span> Methodref          <span class="variable">#42</span><span class="built_in">.</span><span class="variable">#44</span>        <span class="comment">//  java/io/PrintStream.println:(Ljava/lang/String;)V</span></div><div class="line">  <span class="variable">#42</span> <span class="subst">=</span> Class              <span class="variable">#43</span>            <span class="comment">//  java/io/PrintStream</span></div><div class="line">  <span class="variable">#43</span> <span class="subst">=</span> Utf8               java/io/PrintStream</div><div class="line">  <span class="variable">#44</span> <span class="subst">=</span> NameAndType        <span class="variable">#45</span>:<span class="variable">#34</span>        <span class="comment">//  println:(Ljava/lang/String;)V</span></div><div class="line">  <span class="variable">#45</span> <span class="subst">=</span> Utf8               println</div><div class="line">  <span class="variable">#46</span> <span class="subst">=</span> Utf8               s</div><div class="line">  <span class="variable">#47</span> <span class="subst">=</span> Utf8               Ljava/lang/<span class="built_in">String</span>;</div><div class="line">  <span class="variable">#48</span> <span class="subst">=</span> Utf8               SourceFile</div><div class="line">  <span class="variable">#49</span> <span class="subst">=</span> Utf8               Lambda1<span class="built_in">.</span>java</div><div class="line">  <span class="variable">#50</span> <span class="subst">=</span> Utf8               BootstrapMethods</div><div class="line">  <span class="variable">#51</span> <span class="subst">=</span> Methodref          <span class="variable">#52</span><span class="built_in">.</span><span class="variable">#54</span>        <span class="comment">//  java/lang/invoke/LambdaMetafactory.metafactory:(Ljava/lang/invoke/MethodHandles$Lookup;Ljava/lang/String;Ljava/lang/invoke/MethodType;Ljava/lang/invoke/MethodType;Ljava/lang/invoke/MethodHandle;Ljava/lang/invoke/MethodType;)Ljava/lang/invoke/CallSite;</span></div><div class="line">  <span class="variable">#52</span> <span class="subst">=</span> Class              <span class="variable">#53</span>            <span class="comment">//  java/lang/invoke/LambdaMetafactory</span></div><div class="line">  <span class="variable">#53</span> <span class="subst">=</span> Utf8               java/lang/invoke/LambdaMetafactory</div><div class="line">  <span class="variable">#54</span> <span class="subst">=</span> NameAndType        <span class="variable">#55</span>:<span class="variable">#56</span>        <span class="comment">//  metafactory:(Ljava/lang/invoke/MethodHandles$Lookup;Ljava/lang/String;Ljava/lang/invoke/MethodType;Ljava/lang/invoke/MethodType;Ljava/lang/invoke/MethodHandle;Ljava/lang/invoke/MethodType;)Ljava/lang/invoke/CallSite;</span></div><div class="line">  <span class="variable">#55</span> <span class="subst">=</span> Utf8               metafactory</div><div class="line">  <span class="variable">#56</span> <span class="subst">=</span> Utf8               (Ljava/lang/invoke/MethodHandles<span class="variable">$Lookup</span>;Ljava/lang/<span class="built_in">String</span>;Ljava/lang/invoke/MethodType;Ljava/lang/invoke/MethodType;Ljava/lang/invoke/MethodHandle;Ljava/lang/invoke/MethodType;)Ljava/lang/invoke/CallSite;</div><div class="line">  <span class="variable">#57</span> <span class="subst">=</span> MethodHandle       <span class="variable">#6</span>:<span class="variable">#51</span>         <span class="comment">//  invokestatic java/lang/invoke/LambdaMetafactory.metafactory:(Ljava/lang/invoke/MethodHandles$Lookup;Ljava/lang/String;Ljava/lang/invoke/MethodType;Ljava/lang/invoke/MethodType;Ljava/lang/invoke/MethodHandle;Ljava/lang/invoke/MethodType;)Ljava/lang/invoke/CallSite;</span></div><div class="line">  <span class="variable">#58</span> <span class="subst">=</span> MethodType         <span class="variable">#26</span>            <span class="comment">//  (Ljava/lang/Object;)V</span></div><div class="line">  <span class="variable">#59</span> <span class="subst">=</span> Methodref          <span class="variable">#1</span><span class="built_in">.</span><span class="variable">#60</span>         <span class="comment">//  com/colobu/lambda/chapter5/Lambda1.lambda$0:(Ljava/lang/String;)V</span></div><div class="line">  <span class="variable">#60</span> <span class="subst">=</span> NameAndType        <span class="variable">#33</span>:<span class="variable">#34</span>        <span class="comment">//  lambda$0:(Ljava/lang/String;)V</span></div><div class="line">  <span class="variable">#61</span> <span class="subst">=</span> MethodHandle       <span class="variable">#6</span>:<span class="variable">#59</span>         <span class="comment">//  invokestatic com/colobu/lambda/chapter5/Lambda1.lambda$0:(Ljava/lang/String;)V</span></div><div class="line">  <span class="variable">#62</span> <span class="subst">=</span> MethodType         <span class="variable">#34</span>            <span class="comment">//  (Ljava/lang/String;)V</span></div><div class="line">  <span class="variable">#63</span> <span class="subst">=</span> Utf8               InnerClasses</div><div class="line">  <span class="variable">#64</span> <span class="subst">=</span> Class              <span class="variable">#65</span>            <span class="comment">//  java/lang/invoke/MethodHandles$Lookup</span></div><div class="line">  <span class="variable">#65</span> <span class="subst">=</span> Utf8               java/lang/invoke/MethodHandles<span class="variable">$Lookup</span></div><div class="line">  <span class="variable">#66</span> <span class="subst">=</span> Class              <span class="variable">#67</span>            <span class="comment">//  java/lang/invoke/MethodHandles</span></div><div class="line">  <span class="variable">#67</span> <span class="subst">=</span> Utf8               java/lang/invoke/MethodHandles</div><div class="line">  <span class="variable">#68</span> <span class="subst">=</span> Utf8               Lookup</div><div class="line">{</div><div class="line">  <span class="keyword">public</span> com<span class="built_in">.</span>colobu<span class="built_in">.</span>lambda<span class="built_in">.</span>chapter5<span class="built_in">.</span>Lambda1();</div><div class="line">    flags: ACC_PUBLIC</div><div class="line">    Code:</div><div class="line">      <span class="built_in">stack</span><span class="subst">=</span><span class="number">1</span>, locals<span class="subst">=</span><span class="number">1</span>, args_size<span class="subst">=</span><span class="number">1</span></div><div class="line">         <span class="number">0</span>: aload_0       </div><div class="line">         <span class="number">1</span>: invokespecial <span class="variable">#8</span>                  <span class="comment">// Method java/lang/Object."&lt;init&gt;":()V</span></div><div class="line">         <span class="number">4</span>: <span class="keyword">return</span>        </div><div class="line">      LineNumberTable:</div><div class="line">        line <span class="number">7</span>: <span class="number">0</span></div><div class="line">      LocalVariableTable:</div><div class="line">        Start  Length  Slot  Name   Signature</div><div class="line">               <span class="number">0</span>       <span class="number">5</span>     <span class="number">0</span>  this   Lcom/colobu/lambda/chapter5/Lambda1;</div><div class="line"></div><div class="line">  <span class="keyword">public</span> static <span class="literal">void</span> main(java<span class="built_in">.</span>lang<span class="built_in">.</span><span class="built_in">String</span><span class="preprocessor">[</span><span class="preprocessor">]</span><span class="markup">);</span></div><div class="line">    flags: ACC_PUBLIC, ACC_STATIC</div><div class="line">    Code:</div><div class="line">      stack=2, locals=2, args_size=1</div><div class="line">         0: invokedynamic #19,  0             // InvokeDynamic #0:accept:()Ljava/util/function/Consumer;</div><div class="line">         5: astore_1      </div><div class="line">         6: aload_1       </div><div class="line">         7: ldc           #20                 // String hello lambda</div><div class="line">         9: invokeinterface #22,  2           // InterfaceMethod java/util/function/Consumer.accept:(Ljava/lang/Object;)V</div><div class="line">        14: return        </div><div class="line">      LineNumberTable:</div><div class="line">        line 10: 0</div><div class="line">        line 11: 6</div><div class="line">        line 12: 14</div><div class="line">      LocalVariableTable:</div><div class="line">        Start  Length  Slot  Name   Signature</div><div class="line">               0      15     0  args   <span class="preprocessor">[</span>Ljava/lang/<span class="built_in">String</span>;</div><div class="line">               <span class="number">6</span>       <span class="number">9</span>     <span class="number">1</span>     c   Ljava/util/function/Consumer;</div><div class="line">      LocalVariableTypeTable:</div><div class="line">        Start  Length  Slot  Name   Signature</div><div class="line">            <span class="number">6</span>       <span class="number">9</span>     <span class="number">1</span>     c   Ljava/util/function/Consumer<span class="subst">&lt;</span>Ljava/lang/<span class="built_in">String</span>;<span class="subst">&gt;</span>;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> static <span class="literal">void</span> lambda$<span class="number">0</span>(java<span class="built_in">.</span>lang<span class="built_in">.</span><span class="built_in">String</span>);</div><div class="line">    flags: ACC_PRIVATE, ACC_STATIC, ACC_SYNTHETIC</div><div class="line">    Code:</div><div class="line">      <span class="built_in">stack</span><span class="subst">=</span><span class="number">2</span>, locals<span class="subst">=</span><span class="number">1</span>, args_size<span class="subst">=</span><span class="number">1</span></div><div class="line">         <span class="number">0</span>: getstatic     <span class="variable">#35</span>                 <span class="comment">// Field java/lang/System.out:Ljava/io/PrintStream;</span></div><div class="line">         <span class="number">3</span>: aload_0       </div><div class="line">         <span class="number">4</span>: invokevirtual <span class="variable">#41</span>                 <span class="comment">// Method java/io/PrintStream.println:(Ljava/lang/String;)V</span></div><div class="line">         <span class="number">7</span>: <span class="keyword">return</span>        </div><div class="line">      LineNumberTable:</div><div class="line">        line <span class="number">10</span>: <span class="number">0</span></div><div class="line">      LocalVariableTable:</div><div class="line">        Start  Length  Slot  Name   Signature</div><div class="line">               <span class="number">0</span>       <span class="number">8</span>     <span class="number">0</span>     s   Ljava/lang/<span class="built_in">String</span>;</div><div class="line">}</div></pre></td></tr></table></figure>

<p>可以看到， Lambda表达式体被生成一个称之为<code>lambda$0</code>的方法。 看字节码知道它调用System.out.println输出传入的参数。<br>原lambda表达式处产生了一条<code>invokedynamic #19,  0</code>。它会调用<code>bootstrap</code>方法。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="number">0</span>: <span class="variable">#57</span> invokestatic java/lang/invoke/LambdaMetafactory<span class="built_in">.</span>metafactory:(Ljava/lang/invoke/MethodHandles<span class="variable">$Lookup</span>;Ljava/lang/<span class="built_in">String</span>;Ljava/lang/invoke/MethodType;Ljava/lang/invoke/MethodType;Ljava/lang/invoke/MethodHandle;Ljava/lang/invoke/MethodType;)Ljava/lang/invoke/CallSite;</div><div class="line">      Method arguments:</div><div class="line">        <span class="variable">#58</span> (Ljava/lang/Object;)V</div><div class="line">        <span class="variable">#61</span> invokestatic com/colobu/lambda/chapter5/Lambda1<span class="built_in">.</span>lambda$<span class="number">0</span>:(Ljava/lang/<span class="built_in">String</span>;)V</div><div class="line">        <span class="variable">#62</span> (Ljava/lang/<span class="built_in">String</span>;)V</div></pre></td></tr></table></figure>

<p>如果Lambda表达式写成<code>Consumer&lt;String&gt; c = (Consumer&lt;String&gt; &amp; Serializable)s -&gt; System.out.println(s);</code>, 则BootstrapMethods的字节码为</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">BootstrapMethods:</div><div class="line">    <span class="number">0</span>: #<span class="number">108</span> invokestatic java/lang/invoke/LambdaMetafactory.altMetafactory:(Ljava/lang/invoke/MethodHandles$Lookup;Ljava/lang/String;Ljava/lang/invoke/MethodType;[Ljava/lang/Object;)Ljava/lang/invoke/CallSite;</div><div class="line">      Method arguments:</div><div class="line">        #<span class="number">109</span> (Ljava/lang/Object;)V</div><div class="line">        #<span class="number">112</span> invokestatic com/colobu/lambda/chapter5/Lambda1.lambda$<span class="number">0</span>:(Ljava/lang/String;)V</div><div class="line">        #<span class="number">113</span> (Ljava/lang/String;)V</div><div class="line">        #<span class="number">114</span> <span class="number">1</span></div></pre></td></tr></table></figure>

<p>它调用的是<code>LambdaMetafactory.altMetafactory</code>,和上面的调用的方法不同。<br><code>#114 1</code>意味着要实现<code>Serializable</code>接口。</p>
<p>如果Lambda表达式写成``,则BootstrapMethods的字节码为</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">BootstrapMethods:</div><div class="line">  <span class="number">0</span>: #<span class="number">57</span> invokestatic java/lang/invoke/LambdaMetafactory.altMetafactory:(Ljava/lang/invoke/MethodHandles$Lookup;Ljava/lang/String;Ljava/lang/invoke/MethodType;[Ljava/lang/Object;)Ljava/lang/invoke/CallSite;</div><div class="line">    Method arguments:</div><div class="line">      #<span class="number">58</span> (Ljava/lang/Object;)V</div><div class="line">      #<span class="number">61</span> invokestatic com/colobu/lambda/chapter5/Lambda1.lambda$<span class="number">0</span>:(Ljava/lang/String;)V</div><div class="line">      #<span class="number">62</span> (Ljava/lang/String;)V</div><div class="line">      #<span class="number">63</span> <span class="number">2</span></div><div class="line">      #<span class="number">64</span> <span class="number">1</span></div><div class="line">      #<span class="number">65</span> com/colobu/lambda/chapter5/ABC</div></pre></td></tr></table></figure>

<p><code>#63 2</code>意味着要实现额外的接口。<code>#64 1</code>意味着要实现额外的接口的数量为1。</p>
<p>字节码的指令含义可以参考这篇文章：<a href="http://en.wikipedia.org/wiki/Java_bytecode_instruction_listings" target="_blank" rel="external">Java bytecode instruction listings</a>。</p>
<p>可以看到， Lambda表达式具体的转换是通过java.lang.invoke.LambdaMetafactory.metafactory实现的， 静态参数依照lambda表达式和目标类型不同而不同。</p>
<h2 id="LambdaMetafactory-metafactory">LambdaMetafactory.metafactory</h2>
<p>现在我们可以重点关注以下 <code>LambdaMetafactory.metafactory</code>的实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> CallSite <span class="title">metafactory</span>(MethodHandles.Lookup caller,</div><div class="line">                                       String invokedName,</div><div class="line">                                       MethodType invokedType,</div><div class="line">                                       MethodType samMethodType,</div><div class="line">                                       MethodHandle implMethod,</div><div class="line">                                       MethodType instantiatedMethodType)</div><div class="line">            <span class="keyword">throws</span> LambdaConversionException {返回值类型</div><div class="line">        AbstractValidatingLambdaMetafactory mf;</div><div class="line">        mf = <span class="keyword">new</span> InnerClassLambdaMetafactory(caller, invokedType,</div><div class="line">                                             invokedName, samMethodType,</div><div class="line">                                             implMethod, instantiatedMethodType,</div><div class="line">                                             <span class="keyword">false</span>, EMPTY_CLASS_ARRAY, EMPTY_MT_ARRAY);</div><div class="line">        mf.validateMetafactoryArgs();</div><div class="line">        <span class="keyword">return</span> mf.buildCallSite();</div><div class="line">    }</div></pre></td></tr></table></figure>

<p>实际是由<code>InnerClassLambdaMetafactory</code>的<code>buildCallSite</code>来生成。 生成之前会调用<code>validateMetafactoryArgs</code>方法校验目标类型(SAM)方法的参数/和产生的方法的参数/返回值类型是否一致。</p>
<p><code>metaFactory</code>方法的参数：</p>
<ul>
<li>caller: 由JVM提供的lookup context</li>
<li>invokedName: JVM提供的NameAndType</li>
<li>invokedType: JVM提供的期望的CallSite类型</li>
<li>samMethodType: 函数式接口定义的方法的签名</li>
<li>implMethod: 编译时产生的那个实现方法</li>
<li>instantiatedMethodType: 强制的方法签名和返回类型， 一般和samMethodType相同或者是它的一个特例</li>
</ul>
<p>上面的代码基本上是<code>InnerClassLambdaMetafactory.buildCallSite</code>的包装，下面看看这个方法的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">CallSite buildCallSite() <span class="keyword">throws</span> LambdaConversionException {</div><div class="line">       <span class="keyword">final</span> Class&lt;?&gt; innerClass = spinInnerClass();</div><div class="line">       <span class="keyword">if</span> (invokedType.parameterCount() == <span class="number">0</span>) {</div><div class="line">		..... <span class="comment">//调用构造函数初始化一个SAM的实例</span></div><div class="line">           <span class="keyword">return</span> <span class="keyword">new</span> ConstantCallSite(MethodHandles.constant(samBase, inst));</div><div class="line">       } <span class="keyword">else</span> {</div><div class="line">           UNSAFE.ensureClassInitialized(innerClass);</div><div class="line">               <span class="keyword">return</span> <span class="keyword">new</span> ConstantCallSite(</div><div class="line">                       MethodHandles.Lookup.IMPL_LOOKUP</div><div class="line">                            .findStatic(innerClass, NAME_FACTORY, invokedType));</div><div class="line">       }</div><div class="line">   }</div></pre></td></tr></table></figure>

<p>其中<code>spinInnerClass</code>调用<code>asm</code>框架动态的产生SAM的实现类， 这个实现类的的方法将会调用编译时产生的那个实现方法。<br>你可以在编译的时候加上参数<code>-Djdk.internal.lambda.dumpProxyClasses</code>, 这样编译的时候会自动产生运行时<code>spinInnerClass</code>产生的类。<br>你可以访问OpenJDK的bug系统了解这个功能。 <a href="https://bugs.openjdk.java.net/browse/JDK-8023524" target="_blank" rel="external">JDK-8023524</a> </p>
<h2 id="重复的lambda表达式">重复的lambda表达式</h2>
<p>下面的代码中，在一个循环中重复生成调用lambda表达式，只会生成同一个lambda对象， 因为只有同一个<code>invokedynamic</code>指令。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i&lt;<span class="number">100</span>; i++){</div><div class="line">	Consumer&lt;String&gt; c = s -&gt; System.out.println(s);</div><div class="line">	System.out.println(c.hashCode());</div><div class="line">}</div></pre></td></tr></table></figure>

<p>但是下面的代码会生成两个lambda对象, 因为它会生成两个<code>invokedynamic</code>指令。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Consumer&lt;String&gt; c = s -&gt; System.out.println(s);</div><div class="line">System.out.println(c.hashCode());</div><div class="line">Consumer&lt;String&gt; c2 = s -&gt; System.out.println(s);</div><div class="line">System.out.println(c2.hashCode());</div></pre></td></tr></table></figure>

<h2 id="生成的类名">生成的类名</h2>
<p>既然LambdaMetafactory会使用<code>asm</code>框架生成一个匿名类， 那么这个类的类名有什么规律的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Consumer&lt;String&gt; c = s -&gt; System.out.println(s);</div><div class="line">System.out.println(c.getClass().getName());</div><div class="line">System.out.println(c.getClass().getSimpleName());</div><div class="line">System.out.println(c.getClass().getCanonicalName());</div></pre></td></tr></table></figure>

<p>输出结果如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">com.colobu.lambda.chapter5.Lambda3$<span class="variable">$Lambda</span><span class="variable">$1</span>/<span class="number">640070680</span></div><div class="line">Lambda3$<span class="variable">$Lambda</span><span class="variable">$1</span>/<span class="number">640070680</span></div><div class="line">com.colobu.lambda.chapter5.Lambda3$<span class="variable">$Lambda</span><span class="variable">$1</span>/<span class="number">640070680</span></div></pre></td></tr></table></figure>

<p>类名格式如 &lt;包名&gt;.&lt;类名&gt;$$Lambda$<number>/<nn>.<br>number是由一个计数器生成counter.incrementAndGet()。<br>后缀<code>/&lt;NN&gt;</code>中的数字是一个hash值, 那就是类对象的hash值<code>c.getClass().hashCode()</code>。<br>在<code>Klass::external_name()</code>中生成。</nn></number></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">sprintf</span>(hash_buf, <span class="string">"/"</span> UINTX_FORMAT, (uintx)hash);</div></pre></td></tr></table></figure>

<h2 id="直接调用生成的方法">直接调用生成的方法</h2>
<p>上面提到， Lambda表达式体会由编译器生成一个方法，名字格式如<code>Lambda$XXX</code>。<br>既然是类中的实实在在的方法，我们就可以直接调用。当然， 你在代码中直接写<code>lambda$0()</code>编译通不过， 因为Lambda表达式体还没有被抽取成方法。<br>但是在运行中我们可以通过反射的方式调用。 下面的例子使用发射和MethodHandle两种方式调用这个方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span>(String[] args) <span class="keyword">throws</span> Throwable {</div><div class="line">	Consumer&lt;String&gt; c = s -&gt; System.out.println(s);</div><div class="line"></div><div class="line">	Method m = Lambda4.class.getDeclaredMethod(<span class="string">"lambda$0"</span>, String.class);</div><div class="line">	m.invoke(<span class="keyword">null</span>, <span class="string">"hello reflect"</span>);</div><div class="line"></div><div class="line">	MethodHandle mh = MethodHandles.lookup().findStatic(Lambda4.class, <span class="string">"lambda$0"</span>, MethodType.methodType(<span class="keyword">void</span>.class, String.class));</div><div class="line">	mh.invoke(<span class="string">"hello MethodHandle"</span>);</div><div class="line">}</div></pre></td></tr></table></figure>

<h2 id="捕获的变量等价于&#39;final&#39;">捕获的变量等价于&#39;final&#39;</h2>
<p>我们知道，在匿名类中调用外部的参数时，参数必须声明为<code>final</code>。<br>Lambda体内也可以引用上下文中的变量，变量可以不声明成<code>final</code>的，但是必须等价于<code>final</code>。<br>下面的例子中变量capturedV等价与<code>final</code>， 并没有在上下文中重新赋值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Lambda5</span> </span>{</div><div class="line">	String greeting = <span class="string">"hello"</span>;</div><div class="line">	</div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span>(String[] args) <span class="keyword">throws</span> Throwable {</div><div class="line">		</div><div class="line">		Lambda5 capturedV = <span class="keyword">new</span> Lambda5();</div><div class="line">		Consumer&lt;String&gt; c = s -&gt; System.out.println(capturedV.greeting + <span class="string">" "</span> + s);</div><div class="line"></div><div class="line">		c.accept(<span class="string">"captured variable"</span>);</div><div class="line">		<span class="comment">//capturedV = null; //Local variable capturedV defined in an enclosing scope must be final or effectively final</span></div><div class="line">		<span class="comment">//capturedV.greeting = "hi";</span></div><div class="line">	}</div><div class="line"></div><div class="line">}</div></pre></td></tr></table></figure>

<p>如果反注释<code>capturedV = null;</code>编译出错，因为capturedV在上下文中被改变。<br>但是如果反注释<code>capturedV.greeting = &quot;hi&quot;;</code> 则没问题， 因为capturedV没有被重新赋值， 只是它指向的对象的属性有所变化。</p>
<h2 id="方法引用">方法引用</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span>(String[] args) <span class="keyword">throws</span> Throwable {</div><div class="line">	</div><div class="line">	Consumer&lt;String&gt; c  = System.out::println;</div><div class="line">	c.accept(<span class="string">"hello"</span>);</div><div class="line">}</div></pre></td></tr></table></figure>

<p>这段代码不会产生一个类似&quot;Lambda$0&quot;新方法。 因为LambdaMetafactory会直接使用这个引用的方法。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">BootstrapMethods:</div><div class="line">  <span class="number">0</span>: <span class="variable">#51</span> invokestatic java/lang/invoke/LambdaMetafactory<span class="built_in">.</span>metafactory:(Ljava/lang/invoke/MethodHandles<span class="variable">$Lookup</span>;Ljava/lang/<span class="built_in">String</span>;Ljava/lang/invoke/MethodType;Ljava/lang/invoke/MethodType;Ljava/lang/invoke/MethodHandle;Ljava/lang/invoke/MethodType;)Ljava/lang/invoke/CallSite;</div><div class="line">    Method arguments:</div><div class="line">      <span class="variable">#52</span> (Ljava/lang/Object;)V</div><div class="line">      <span class="variable">#59</span> invokevirtual java/io/PrintStream<span class="built_in">.</span>println:(Ljava/lang/<span class="built_in">String</span>;)V</div><div class="line">      <span class="variable">#60</span> (Ljava/lang/<span class="built_in">String</span>;)V</div></pre></td></tr></table></figure>

<p><code>#59</code>指示实现方法为System.out::println</p>

      
    </div>
    <footer class="article-footer">
	
<div class="bdsharebuttonbox"><a title="分享到新浪微博" class="bds_tsina" href="#" data-cmd="tsina"></a><a title="分享到微信" class="bds_weixin" href="#" data-cmd="weixin"></a><a title="分享到QQ空间" class="bds_qzone" href="#" data-cmd="qzone"></a><a title="分享到印象笔记" class="bds_evernotecn" href="#" data-cmd="evernotecn"></a><a title="分享到有道云笔记" class="bds_youdao" href="#" data-cmd="youdao"></a><a title="分享到百度云收藏" class="bds_bdysc" href="#" data-cmd="bdysc"></a><a class="bds_more" href="#" data-cmd="more"></a></div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>
      

	  
        <a href="http://colobu.com/2014/11/06/secrets-of-java-8-lambda/#comments" class="article-comment-link">评论</a>
      

      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Lambda/">Lambda</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2014/11/07/linux-muticast-setting-with-netty/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Linux组播设置以及netty设置
        
      </div>
    </a>
  
  
    <a href="/2014/11/05/kernel-101-lets-write-a-kernel/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">kernel 101 - 动手写内核</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
<div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div>
</section>
<script>
  var cloudTieConfig = {
    url: document.location.href, 
    sourceId: "2014/11/06/secrets-of-java-8-lambda/",
    productKey: "bb59dc3c143c4469940a0163afdb38d8",
    target: "cloud-tie-wrapper"
  };
</script>
<script src="https://img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"></script>

</section>
        
          <aside id="sidebar">
  
      <div class="widget-wrap">
    <h3 class="widget-title">原创图书</h3>
    <div class="widget">
      <a href="/ScalaCollectionsCookbook/">
        <img width="100%" src="/ScalaCollectionsCookbook/scala_collections_cookbook.jpg">
        <img width="100%" src="/ScalaCollectionsCookbook/scala_collections_cookbook_tw.png">
      </a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/DOTNET/">DOTNET</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Go/">Go</a><span class="category-list-count">69</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">59</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Scala/">Scala</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端开发/">前端开发</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/大数据/">大数据</a><span class="category-list-count">55</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工具/">工具</a><span class="category-list-count">19</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/架构/">架构</a><span class="category-list-count">21</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/管理/">管理</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络编程/">网络编程</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/读书笔记/">读书笔记</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/运维/">运维</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/高并发编程/">高并发编程</a><span class="category-list-count">20</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/Android/" style="font-size: 15.71px;">Android</a><a href="/tags/ApacheBench/" style="font-size: 11.43px;">ApacheBench</a><a href="/tags/Bower/" style="font-size: 10.00px;">Bower</a><a href="/tags/C/" style="font-size: 10.00px;">C#</a><a href="/tags/CDN/" style="font-size: 10.00px;">CDN</a><a href="/tags/CQRS/" style="font-size: 10.00px;">CQRS</a><a href="/tags/CRC/" style="font-size: 10.00px;">CRC</a><a href="/tags/CSS/" style="font-size: 11.43px;">CSS</a><a href="/tags/CompletableFuture/" style="font-size: 10.00px;">CompletableFuture</a><a href="/tags/Comsat/" style="font-size: 10.00px;">Comsat</a><a href="/tags/Curator/" style="font-size: 20.00px;">Curator</a><a href="/tags/DSL/" style="font-size: 10.00px;">DSL</a><a href="/tags/Disruptor/" style="font-size: 10.00px;">Disruptor</a><a href="/tags/Docker/" style="font-size: 11.43px;">Docker</a><a href="/tags/Ember/" style="font-size: 11.43px;">Ember</a><a href="/tags/FastJson/" style="font-size: 10.00px;">FastJson</a><a href="/tags/Fiber/" style="font-size: 10.00px;">Fiber</a><a href="/tags/GAE/" style="font-size: 10.00px;">GAE</a><a href="/tags/GC/" style="font-size: 12.86px;">GC</a><a href="/tags/Gnuplot/" style="font-size: 10.00px;">Gnuplot</a><a href="/tags/Go/" style="font-size: 11.43px;">Go</a><a href="/tags/Gradle/" style="font-size: 10.00px;">Gradle</a><a href="/tags/Grunt/" style="font-size: 10.00px;">Grunt</a><a href="/tags/Gulp/" style="font-size: 10.00px;">Gulp</a><a href="/tags/Hadoop/" style="font-size: 10.00px;">Hadoop</a><a href="/tags/Hazelcast/" style="font-size: 10.00px;">Hazelcast</a><a href="/tags/Ignite/" style="font-size: 10.00px;">Ignite</a><a href="/tags/JVM/" style="font-size: 10.00px;">JVM</a><a href="/tags/Java/" style="font-size: 17.14px;">Java</a><a href="/tags/Kafka/" style="font-size: 18.57px;">Kafka</a><a href="/tags/Lambda/" style="font-size: 14.29px;">Lambda</a><a href="/tags/Linux/" style="font-size: 12.86px;">Linux</a><a href="/tags/LongAdder/" style="font-size: 10.00px;">LongAdder</a><a href="/tags/MathJax/" style="font-size: 10.00px;">MathJax</a><a href="/tags/Maven/" style="font-size: 11.43px;">Maven</a><a href="/tags/Memcached/" style="font-size: 10.00px;">Memcached</a><a href="/tags/Metrics/" style="font-size: 10.00px;">Metrics</a><a href="/tags/Mongo/" style="font-size: 12.86px;">Mongo</a><a href="/tags/Netty/" style="font-size: 15.71px;">Netty</a><a href="/tags/Node/" style="font-size: 10.00px;">Node</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">July 2015</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">June 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">May 2015</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">April 2015</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">March 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/02/">February 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">January 2015</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">December 2014</a><span class="archive-list-count">28</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/11/">November 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/10/">October 2014</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">September 2014</a><span class="archive-list-count">28</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">August 2014</a><span class="archive-list-count">19</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/07/">July 2014</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">近期文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/05/12/call-private-functions-in-other-packages/">突破限制,访问其它Go package中的私有函数</a>
          </li>
        
          <li>
            <a href="/2017/05/08/raft-and-network-partitions/">[转]通过 raft 的 leader lease 来解决集群脑裂时的 stale read 问题</a>
          </li>
        
          <li>
            <a href="/2017/05/04/golang-runtime-scheduler/">[转]Golang调度器源码分析</a>
          </li>
        
          <li>
            <a href="/2017/05/04/go-scheduler/">[译]Go 调度器: M, P 和 G</a>
          </li>
        
          <li>
            <a href="/2017/04/28/oauth2-rfc6749/">OAuth2 RFC6749中文翻译</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">友情链接</h3>
    <div class="widget">
      <ul>
        
          <li>
			 
            <a href="http://old.colobu.com" target="_blank">以前的博客</a>
			
          </li>
        
          <li>
			 
			&nbsp;
			
          </li>
        
          <li>
			 
            <a href="http://stackshare.io" target="_blank">技术栈</a>
			
          </li>
        
          <li>
			 
			&nbsp;
			
          </li>
        
          <li>
			 
            <a href="http://weekly.manong.io/issues/" target="_blank">码农周刊</a>
			
          </li>
        
          <li>
			 
            <a href="http://www.tuicool.com/mags" target="_blank">编程狂人周刊</a>
			
          </li>
        
          <li>
			 
            <a href="http://www.importnew.com/" target="_blank">importnew</a>
			
          </li>
        
          <li>
			 
            <a href="http://ifeve.com/" target="_blank">并发编程网</a>
			
          </li>
        
          <li>
			 
			&nbsp;
			
          </li>
        
          <li>
			 
            <a href="http://github.com" target="_blank">github</a>
			
          </li>
        
          <li>
			 
            <a href="http://stackoverflow.com/" target="_blank">stackoverflow</a>
			
          </li>
        
          <li>
			 
            <a href="http://www.javacodegeeks.com/" target="_blank">javacodegeeks</a>
			
          </li>
        
          <li>
			 
            <a href="http://www.infoq.com/" target="_blank">infoq</a>
			
          </li>
        
          <li>
			 
            <a href="http://www.dzone.com/links/index.html" target="_blank">dzone</a>
			
          </li>
        
          <li>
			 
            <a href="https://oj.leetcode.com/problems/" target="_blank">leetcode</a>
			
          </li>
        
      </ul>
    </div>
  </div>

  
      <div class="widget-wrap">
<div id="hot-news-wrap" class="widget"></div>
<script>var yunModuleEnv = true;</script>
<script src="https://img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"></script>
<script>
  var yunTieProductKey = "bb59dc3c143c4469940a0163afdb38d8";  
  var yunHotNewsWrap = "hot-news-wrap"; 
  Tie.loader("aHR0cHM6Ly9hcGkuZ2VudGllLjE2My5jb20vZXh0ZW5kL2hvdF9uZXdzX3NjcmlwdC5odG1s", true);
</script>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 smallnest<br>
	  Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
    <a href="https://github.com/smallnest" class="mobile-nav-link">github</a>
  
    <a href="http://tr.colobu.com" class="mobile-nav-link">技术流</a>
  
    <a href="/ScalaCollectionsCookbook" class="mobile-nav-link">Scala集合技术手册</a>
  
    <a href="/techreview" class="mobile-nav-link">技术快报</a>
  
    <a href="/about" class="mobile-nav-link">关于</a>
  
</nav>
    
<script src="//cdn.staticfile.org/jquery/1.11.1/jquery.min.js"></script>
<script src="//cdn.bootcss.com/jquery.lazyload/1.9.1/jquery.lazyload.min.js"></script>

<script src="//libs.cncdn.cn/fancybox/2.1.5/jquery.fancybox.pack.js"></script>


<script src="/js/script.js" type="text/javascript"></script>

<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
  });
  MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>
<script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.6.0-beta.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

<div id="totop" style="position:fixed;bottom:150px;right:10px;cursor: pointer;z-index: 2000;">
	<a title="返回顶部"><img src="/images/scrollup.png"/></a>
</div>
<script src="/js/totop.js" type="text/javascript"></script>



<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-142561-4']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>


<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e085d87993250aab11f3e0c15f1c2785";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


  </div>
</body>
</html>